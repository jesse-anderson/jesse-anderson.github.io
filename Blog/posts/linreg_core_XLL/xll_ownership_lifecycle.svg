<svg xmlns="http://www.w3.org/2000/svg" width="1100" height="700" viewBox="0 0 1100 700">
  <defs>
    <marker id="arrow" markerWidth="10" markerHeight="8" refX="9" refY="4" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L10,4 L0,8 Z" fill="#333" />
    </marker>
  </defs>
  <style>
    .box { fill: #f7f7f7; stroke: #333; stroke-width: 2; rx: 8; }
    .note { fill: #fff8e1; stroke: #c9a53f; stroke-width: 2; rx: 8; }
    .text { font: 14px 'Segoe UI', Arial, sans-serif; fill: #111; }
    .small { font: 12px 'Segoe UI', Arial, sans-serif; fill: #111; }
    .title { font: 600 16px 'Segoe UI', Arial, sans-serif; fill: #111; }
    .line { stroke: #999; stroke-width: 2; stroke-dasharray: 6 6; }
    .arrow { stroke: #333; stroke-width: 2; fill: none; marker-end: url(#arrow); }
    .section { font: 600 14px 'Segoe UI', Arial, sans-serif; fill: #222; }
    .step { fill: #e3f2fd; stroke: #1565c0; stroke-width: 2; }
    .step-text { font: 700 12px 'Segoe UI', Arial, sans-serif; fill: #0d47a1; }
  </style>

  <!-- Participants -->
  <rect class="box" x="160" y="30" width="180" height="40" />
  <text class="title" x="250" y="56" text-anchor="middle">XLL</text>

  <rect class="box" x="760" y="30" width="180" height="40" />
  <text class="title" x="850" y="56" text-anchor="middle">Excel</text>

  <!-- Lifelines -->
  <line class="line" x1="250" y1="80" x2="250" y2="690" />
  <line class="line" x1="850" y1="80" x2="850" y2="690" />

  <!-- Section label -->
  <text class="section" x="550" y="100" text-anchor="middle">UDF return (DLL-owned XLOPER12)</text>

  <!-- Build return value -->
  <rect class="box" x="60" y="120" width="380" height="150" />
  <circle class="step" cx="78" cy="136" r="12" />
  <text class="step-text" x="78" y="140" text-anchor="middle">1</text>
  <text class="text" x="250" y="145" text-anchor="middle">build return XLOPER12</text>
  <text class="small" x="80" y="165">STR: alloc UTF-16 buffer, then `forget`</text>
  <text class="small" x="80" y="185">MULTI: alloc cells Vec, then `forget`</text>
  <text class="small" x="80" y="205">string cells: allocate UTF-16 buffers</text>
  <text class="small" x="80" y="225">set `xltype | XLBIT_DLL_FREE`</text>
  <text class="small" x="80" y="245">Box::new + Box::into_raw for XLOPER12</text>

  <!-- Return pointer -->
  <line class="arrow" x1="250" y1="290" x2="850" y2="290" />
  <circle class="step" cx="560" cy="248" r="12" />
  <text class="step-text" x="560" y="252" text-anchor="middle">2</text>
  <text class="text" x="550" y="278" text-anchor="middle">return *mut XLOPER12</text>

  <!-- Excel copies result -->
  <rect class="box" x="710" y="310" width="280" height="50" />
  <circle class="step" cx="724" cy="325" r="12" />
  <text class="step-text" x="724" y="329" text-anchor="middle">3</text>
  <text class="text" x="850" y="340" text-anchor="middle">copy result into sheet</text>

  <!-- Decision: xlbitDLLFree set? -->
  <polygon class="box" points="850,370 900,400 850,430 800,400" />
  <circle class="step" cx="795" cy="384" r="12" />
  <text class="step-text" x="795" y="388" text-anchor="middle">4</text>
  <text class="small" x="850" y="398" text-anchor="middle">xlbitDLLFree</text>
  <text class="small" x="850" y="414" text-anchor="middle">set?</text>

  <!-- No callback note -->
  <line class="arrow" x1="900" y1="400" x2="940" y2="400" />
  <rect class="note" x="940" y="380" width="140" height="40" />
  <text class="small" x="1010" y="404" text-anchor="middle">no: no callback</text>

  <!-- Callback to xlAutoFree12 -->
  <line class="arrow" x1="800" y1="415" x2="460" y2="470" />
  <circle class="step" cx="610" cy="388" r="12" />
  <text class="step-text" x="610" y="392" text-anchor="middle">5</text>
  <text class="small" x="610" y="422" text-anchor="middle">yes: xlAutoFree12(ptr)</text>

  <rect class="box" x="40" y="430" width="420" height="170" />
  <circle class="step" cx="58" cy="446" r="12" />
  <text class="step-text" x="58" y="450" text-anchor="middle">6</text>
  <text class="text" x="250" y="455" text-anchor="middle">xlAutoFree12(ptr)</text>
  <text class="small" x="60" y="475">base = xltype &amp; 0x0FFF</text>
  <text class="small" x="60" y="495">STR: Vec::from_raw_parts(str, len + 1)</text>
  <text class="small" x="60" y="515">MULTI: free string buffers in elements</text>
  <text class="small" x="60" y="535">MULTI: Vec::from_raw_parts(lparray)</text>
  <text class="small" x="60" y="555">finally: Box::from_raw(p)</text>

  <!-- Section separator -->
  <line class="line" x1="60" y1="610" x2="1040" y2="610" />
  <text class="section" x="550" y="630" text-anchor="middle">Excel12v return (Excel-owned XLOPER12)</text>

  <!-- Excel12v flow -->
  <line class="arrow" x1="850" y1="650" x2="250" y2="650" />
  <text class="small" x="550" y="640" text-anchor="middle">excel12 returns XLOPER12 (e.g., xlGetName)</text>

  <line class="arrow" x1="250" y1="670" x2="850" y2="670" />
  <text class="small" x="550" y="692" text-anchor="middle">XLL calls xlFree (excel_free) to release Excel-owned memory</text>
</svg>
