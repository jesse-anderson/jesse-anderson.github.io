<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Jesse Anderson">
<meta name="dcterms.date" content="2024-05-26">

<title>Jesse Anderson’s Blog - Efficient Data Logging with ESP32</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/cookie-consent/cookie-consent.js"></script>
<link href="../../site_libs/cookie-consent/cookie-consent.css" rel="stylesheet">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="../../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-5CSPYCMY55"></script>

<script type="text/plain" cookie-consent="tracking">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-5CSPYCMY55', { 'anonymize_ip': true});
</script>

<script type="text/javascript" charset="UTF-8">
document.addEventListener('DOMContentLoaded', function () {
cookieconsent.run({
  "notice_banner_type":"simple",
  "consent_type":"implied",
  "palette":"light",
  "language":"en",
  "page_load_consent_levels":["strictly-necessary","functionality","tracking","targeting"],
  "notice_banner_reject_button_hide":false,
  "preferences_center_close_button_hide":false,
  "website_name":""
  ,
"language":"en"
  });
});
</script> 
  


<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="Jesse Anderson’s Blog - Efficient Data Logging with ESP32">
<meta property="og:description" content="A Guide to Using Google Sheets/MongoDB/PostgreSQL/ThingSpeak for IoT">
<meta property="og:image" content="images/Real_Life_ESP32_Setup.jpg">
<meta property="og:site_name" content="Jesse Anderson's Blog">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Jesse Anderson’s Blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../archive.html"> 
<span class="menu-text">Archive</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://jesse-anderson.github.io"> <i class="bi bi-Folder symlink fill" role="img">
</i> 
<span class="menu-text">Portfolio</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/jesse-anderson/"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/jesse-anderson-a7c5/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Efficient Data Logging with ESP32</h1>
            <p class="subtitle lead">A Guide to Using Google Sheets/MongoDB/PostgreSQL/ThingSpeak for IoT</p>
                                <div class="quarto-categories">
                <div class="quarto-category">ESP32</div>
                <div class="quarto-category">IoT</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Jesse Anderson </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">May 26, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<p>To begin with, we are using an <a href="https://www.microcenter.com/product/613822/inland-esp32-wroom-32d-module">ESP32-Wroom-32 Expressif board purchased from Microcenter for $10.</a> These boards can be found for as low as $4-$5 on Amazon, and more capable boards are available in the $10-$20 range. This makes the ESP32 a cost-effective alternative to the Raspberry Pi, especially when the task is primarily logging sensor data. Additionally, the ESP32 outperforms the Raspberry Pi Pico significantly; it is approximately five times faster with integer arithmetic and 60-70 times faster with floating-point calculations, as demonstrated in this youtube video: <a href="https://www.youtube.com/watch?v=zGog29YNLmk&amp;ab_channel=Tomsvideos" class="uri">https://www.youtube.com/watch?v=zGog29YNLmk&amp;ab_channel=Tomsvideos</a></p>
<p>The code for this project is written in MicroPython. Although rewriting it in C/C++ could potentially yield a 10x performance improvement, the time and effort required to handle compilation issues are not justifiable for this use case. If this were a production environment, opting for C/C++ would be an obvious choice.</p>
<section id="what-is-an-esp32-wroom-32-expressif-board" class="level2">
<h2 class="anchored" data-anchor-id="what-is-an-esp32-wroom-32-expressif-board">What is an ESP32-WROOM-32 Expressif Board?</h2>
<p>The ESP32-WROOM-32 is a powerful, low-cost Wi-Fi and Bluetooth microcontroller module developed by Espressif Systems. It is designed for a wide range of applications, from simple IoT projects to complex systems requiring wireless connectivity and advanced processing capabilities. Here are some key features and specifications of the ESP32-WROOM-32 board:</p>
<ol type="1">
<li><p><strong>Dual-Core Processor</strong>: The ESP32-WROOM-32 features a dual-core Tensilica Xtensa LX6 microprocessor, with clock speeds up to 240 MHz. This provides ample processing power for a variety of tasks, including real-time data processing and multitasking.</p></li>
<li><p><strong>Wireless Connectivity</strong>:</p>
<ul>
<li><p><strong>Wi-Fi</strong>: The board supports 802.11 b/g/n Wi-Fi, making it ideal for IoT applications that require internet connectivity. It can operate in both Station and Access Point modes, allowing it to connect to existing networks or create its own.</p></li>
<li><p><strong>Bluetooth</strong>: It includes Bluetooth 4.2 (BLE and Classic), enabling communication with other Bluetooth devices, such as sensors, smartphones, and peripherals.</p></li>
</ul></li>
<li><p><strong>Memory</strong>:</p>
<ul>
<li><p><strong>Flash Memory</strong>: The module typically comes with 4 MB of flash memory, used for storing the firmware and other data.</p></li>
<li><p><strong>SRAM</strong>: It has 520 KB of on-chip SRAM, providing sufficient space for running programs and handling data.</p></li>
</ul></li>
<li><p><strong>GPIO and Peripherals</strong>:</p>
<ul>
<li><p>The board features numerous General Purpose Input/Output (GPIO) pins, which can be used for interfacing with various sensors, actuators, and other peripherals.</p></li>
<li><p>It includes a variety of built-in peripherals, such as UART, SPI, I2C, PWM, ADC, and DAC, making it highly versatile for different types of projects.</p></li>
</ul></li>
<li><p><strong>Power Management</strong>:</p>
<ul>
<li>The ESP32-WROOM-32 is designed with power efficiency in mind, offering multiple power-saving modes, such as deep sleep and light sleep. This makes it suitable for battery-powered applications where low power consumption is crucial.</li>
</ul></li>
<li><p><strong>Development Environment</strong>:</p>
<ul>
<li>The board is compatible with popular development environments like Arduino IDE, PlatformIO, and Espressif’s own ESP-IDF (Espressif IoT Development Framework). This flexibility allows developers to choose their preferred tools and programming languages.</li>
</ul></li>
</ol>
<p>The ESP32-WROOM-32 board is widely used in various applications, including Internet of Things (IoT), industrial automation, home automation, robotics, health monitoring, and educational projects. It enables the creation of smart home devices, environmental monitoring systems, wearable health trackers, and remote industrial monitoring solutions. Additionally, it is suitable for controlling autonomous robots and drones, developing smart appliances, and building voice assistants. Its versatility makes it an excellent choice for learning and prototyping in STEM education, providing a hands-on experience with microcontrollers, IoT, and embedded systems.</p>
<p>However, the ESP32-WROOM-32 has some limitations that need to be considered. Its processing power and memory are limited compared to more powerful systems, which can be a constraint for complex applications. While it offers various power-saving modes, its power consumption is higher than simpler microcontrollers, making it less ideal for ultra-low-power applications. The board’s real-time performance may not meet the needs of highly time-sensitive tasks, and its limited GPIO pins might require additional hardware for larger projects. Additionally, it may not be suitable for extreme environmental conditions without protective measures, and its complexity can present a steep learning curve for beginners.</p>
<p>The datasheet for the ESP32 can be found <a href="esp32-wroom-32_datasheet_en.pdf">here</a>.</p>
<section id="cpu-and-internal-memory" class="level3">
<h3 class="anchored" data-anchor-id="cpu-and-internal-memory">CPU and Internal Memory</h3>
<p>ESP32-D0WDQ6 contains two low-power Xtensa® 32-bit LX6 microprocessors. The internal memory includes:</p>
<ul>
<li><p>448 KB of ROM for booting and core functions.</p></li>
<li><p>520 KB of on-chip SRAM for data and instructions.</p></li>
<li><p>8 KB of SRAM in RTC, which is called RTC FAST Memory and can be used for data storage; it is accessed by the main CPU during RTC Boot from the Deep-sleep mode.</p></li>
<li><p>8 KB of SRAM in RTC, which is called RTC SLOW Memory and can be accessed by the co-processor during the Deep-sleep mode.</p></li>
<li><p>1 Kbit of eFuse: 256 bits are used for the system (MAC address and chip configuration) and the remaining 768 bits are reserved for customer applications, including flash-encryption and chip-ID.</p></li>
</ul>
<p>Get the esptool via pip:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1"></a><span class="ex">pip</span> install esptool</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>See usage:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1"></a><span class="ex">esptool</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Next find your port after plugging in your ESP32 device via USB:</p>
<p>In Windows at least its <strong><code>Device Manager -&gt; Ports(Com &amp; LPT)</code></strong> and look for a device named USB-Serial CH340 or Silicon Labs CP210x USB to UART Bridge or similar. I had two devices in my ports so I noted the ports in use, unplugged the board, then plugged it back in to get the port. This of course didn’t work and I had to add the COM port manually…</p>
<p><strong>Adding COM ports manually.</strong></p>
<ol type="1">
<li><p>Open Device Manager on your computer.</p></li>
<li><p>Click on the <strong>Action</strong> option from menu bar.</p></li>
<li><p>Choose <strong>Add legacy hardware</strong> from the menu to open the Add Hardware window.</p></li>
<li><p>Click on the <strong>Next</strong> button to move on.</p></li>
<li><p>Check <strong>Install the hardware that I manually select from a list (Advanced)</strong> and press <strong>Next</strong>.</p></li>
<li><p>Select <strong>Ports (COM &amp; LPT)</strong> from the given list and press the <strong>Next</strong>&nbsp;button.</p></li>
<li><p>Choose <strong>Standard port types</strong> option or the manufacturer for the ports; then, click <strong>Next</strong>.</p></li>
<li><p>Click on the <strong>Finish</strong> button to complete.</p></li>
</ol>
<p>You’ll note a new COM port, in my case COM4 and that’s what you’ll need for the next step.</p>
<p>Follow this guide if you’re not seeing things or some other nonsense: <a href="https://docs.espressif.com/projects/esp-idf/en/stable/esp32/get-started/establish-serial-connection.html" class="uri">https://docs.espressif.com/projects/esp-idf/en/stable/esp32/get-started/establish-serial-connection.html</a></p>
<p>If you’re experiencing driver issues, this resource might help:</p>
<p><a href="https://www.silabs.com/developers/usb-to-uart-bridge-vcp-drivers?tab=overview" class="uri">https://www.silabs.com/developers/usb-to-uart-bridge-vcp-drivers?tab=overview</a></p>
<p>I used the “with serial enumeration” file, and it worked well for me. The device was recognized and assigned to COM4, which I then used for my setup.</p>
<p>After installing PuTTY, everything worked smoothly. Using both the drivers and PuTTY resolved my issues, reminding me to be more patient and consult the documentation before rushing. If you’ve already flashed something, follow the steps to reset while monitoring COM# on PuTTY. You should see the download mode activate. Reset the device by holding the Boot button and pressing the reset button, then holding Boot while flashing.</p>
</section>
</section>
<section id="getting-started-with-micropython" class="level2">
<h2 class="anchored" data-anchor-id="getting-started-with-micropython"><strong>Getting Started with MicroPython</strong></h2>
<p>For the most part refer to the instructions at: <a href="https://docs.micropython.org/en/latest/esp32/tutorial/intro.html" class="uri">https://docs.micropython.org/en/latest/esp32/tutorial/intro.html</a></p>
<p>Download firmware for your ESP32 board:</p>
<p><a href="https://micropython.org/download/#esp32" class="uri">https://micropython.org/download/#esp32</a></p>
<p>Specifically the Microcenter Inland WROOM Board:</p>
<p><a href="https://micropython.org/download/ESP32_GENERIC/" class="uri">https://micropython.org/download/ESP32_GENERIC/</a></p>
<p>Ensure your device is erased with:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1"></a><span class="ex">esptool</span> <span class="at">-</span> p COM4 erase_flash</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Take care to replace the ‘COM4’ with your port.</p>
<p>Next flash MicroPython to the board:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1"></a><span class="ex">esptool.py</span> <span class="at">--chip</span> esp32 <span class="at">--port</span> COM4 <span class="at">--baud</span> 460800 write_flash <span class="at">-z</span> 0x1000 esp32-20190125-v1.10.bin</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong><em>Make sure you replace the .bin file with the file you downloaded and ensure you’re in the correct directory.</em></strong></p>
<p>Next I got up and running with Thonny(<a href="https://thonny.org/" class="uri">https://thonny.org/</a>). Its a very lightweight Python IDE that’s ESP32 friendly. Make sure you select your device in the lower right corner and you’ll be up and running.</p>
<p><a href="images/paste-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="images/paste-1.png" class="img-fluid"></a></p>
<p>You can run a simple print(“Hello World”) to ensure you’re communicating with the device in the shell.</p>
<p>Here’s a schematic of my board setup, with swappable GPIO pins and an optional LED. I included an LED to provide a quick visual indicator that my board is running the code correctly during stress tests.</p>
<p><a href="images/CircuitSetup_bb_edit.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="images/CircuitSetup_bb_edit.png" class="img-fluid"></a></p>
<p>And the Real Life Version:</p>
<p><a href="images/Real_Life_ESP32_Setup.jpg" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="images/Real_Life_ESP32_Setup.jpg" class="img-fluid"></a></p>
<p>Pinouts courteousy of <a href="https://github.com/natedogg2020/Inland_ESP32-Supplements" class="uri">https://github.com/natedogg2020/Inland_ESP32-Supplements</a></p>
<p>Top:</p>
<p><a href="images/Inland_ESP32_Top.jpg" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="images/Inland_ESP32_Top.jpg" class="img-fluid"></a></p>
<p>Bottom:</p>
<p><a href="images/Inland_ESP32_Bottom.jpg" class="lightbox" data-gallery="quarto-lightbox-gallery-5"><img src="images/Inland_ESP32_Bottom.jpg" class="img-fluid"></a></p>
<p>All pin references are looking from the top and will be either referenced Top Left or Top Right.</p>
<section id="dht11" class="level3">
<h3 class="anchored" data-anchor-id="dht11"><strong>DHT11</strong></h3>
<p>Ground to Ground Line to Ground at Pin 19(Top Left)</p>
<p>GPIO15 Power from Pin 4(Top Left)</p>
<p>GPIO13 Signal from Pin 5(Top Left)</p>
<p>GPIO Power from Pin 5(Top Right)(I know I should’ve kept it split, but I had to do some nonsense with the power after the wifi cut out due to the power demand)</p>
</section>
<section id="led" class="level3">
<h3 class="anchored" data-anchor-id="led"><strong>LED</strong></h3>
<p>Resistor: 22ohm(Also used 10, but 22 works better to not blind me)</p>
<p>LED Anode to Ground to Ground Line to Ground at Pin 6(Top Right)</p>
<p>LED Cathode to Resistor(22 ohm) to GPIO2 Power from Pin 5(Again, I know I should’ve kept it separate. I’m not an EE.)</p>
<p>Next, you’ll want to test that your device can connect to the internet, read the sensor, and blink the LED. For now, we’ll skip the Google App Script/Vercel PostgreSQL/MongoDB/ThingSpeak integration, and you will encounter errors when transmitting data.</p>
<p>I’ll provide the code below with explanations of the different parts. To save memory, especially with the Google Apps Script request, I used a lower-level form of POST than standard. This approach is necessary because the Google Response was overloading the memory. Adjust the timeouts according to your needs. Initially, disable the sensors and LED to ensure sufficient power for the wireless connection, then enable the sensors and allow a few seconds for them to register readings.</p>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb5"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1"></a><span class="im">import</span> network</span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="im">import</span> urequests <span class="im">as</span> requests</span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="im">import</span> time <span class="im">as</span> time_module</span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="im">from</span> machine <span class="im">import</span> Pin</span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="im">import</span> dht</span>
<span id="cb5-6"><a href="#cb5-6"></a><span class="im">import</span> ntptime</span>
<span id="cb5-7"><a href="#cb5-7"></a><span class="im">import</span> utime</span>
<span id="cb5-8"><a href="#cb5-8"></a><span class="im">import</span> ujson <span class="im">as</span> json</span>
<span id="cb5-9"><a href="#cb5-9"></a><span class="im">import</span> gc</span>
<span id="cb5-10"><a href="#cb5-10"></a><span class="im">from</span> machine <span class="im">import</span> freq</span>
<span id="cb5-11"><a href="#cb5-11"></a></span>
<span id="cb5-12"><a href="#cb5-12"></a><span class="co"># Wi-Fi credentials</span></span>
<span id="cb5-13"><a href="#cb5-13"></a>SSID <span class="op">=</span> <span class="st">'YOUR-WIFI-NAME'</span></span>
<span id="cb5-14"><a href="#cb5-14"></a>PASSWORD <span class="op">=</span> <span class="st">'YOUR-WIFI-PASSWORD'</span></span>
<span id="cb5-15"><a href="#cb5-15"></a></span>
<span id="cb5-16"><a href="#cb5-16"></a><span class="co"># Google Sheets settings</span></span>
<span id="cb5-17"><a href="#cb5-17"></a>SPREADSHEET_ID <span class="op">=</span> <span class="st">'YOUR-SPREADSHEET-ID'</span></span>
<span id="cb5-18"><a href="#cb5-18"></a>RANGE_NAME <span class="op">=</span> <span class="st">'Sheet1!A1:E1'</span> <span class="co">#NOTE THAT THIS IS FOR DATE TIME HUMIDITY TEMP_F TEMP_C. WILL CHANGE COLUMN DESIGNATION IF YOU ADD/REMOVE DATA.</span></span>
<span id="cb5-19"><a href="#cb5-19"></a>SHEET_NAME <span class="op">=</span> <span class="st">'Sheet1'</span></span>
<span id="cb5-20"><a href="#cb5-20"></a>GOOGLE_URL <span class="op">=</span> <span class="st">'YOUR-GOOGLE-APP-SCRIPT'</span></span>
<span id="cb5-21"><a href="#cb5-21"></a></span>
<span id="cb5-22"><a href="#cb5-22"></a><span class="co"># ThingSpeak settings</span></span>
<span id="cb5-23"><a href="#cb5-23"></a>THINGSPEAK_API_KEY <span class="op">=</span> <span class="st">'THINGSPEAK-API-KEY'</span></span>
<span id="cb5-24"><a href="#cb5-24"></a>THINGSPEAK_URL <span class="op">=</span> <span class="st">'https://api.thingspeak.com/update'</span></span>
<span id="cb5-25"><a href="#cb5-25"></a>THINGSPEAK_CHANNEL_ID <span class="op">=</span> <span class="dv">0000000</span> <span class="co"># Replace with your ThingSpeak channel ID</span></span>
<span id="cb5-26"><a href="#cb5-26"></a>THINGSPEAK_BULK_UPDATE_URL <span class="op">=</span> <span class="st">'https://api.thingspeak.com/channels/'</span><span class="op">+</span><span class="bu">str</span>(THINGSPEAK_CHANNEL_ID)<span class="op">+</span><span class="st">'/bulk_update.json'</span></span>
<span id="cb5-27"><a href="#cb5-27"></a></span>
<span id="cb5-28"><a href="#cb5-28"></a><span class="co"># MongoDB settings</span></span>
<span id="cb5-29"><a href="#cb5-29"></a>MONGODB_API_URL <span class="op">=</span> <span class="st">'YOUR_MONGO_DB_URL'</span></span>
<span id="cb5-30"><a href="#cb5-30"></a><span class="co">#MONGODB_API_KEY = 'your_mongodb_api_key' #WE ARE NOT USING PYMONGO, DO NOT NEED.</span></span>
<span id="cb5-31"><a href="#cb5-31"></a>MONGODB__VERCEL_API_URL <span class="op">=</span> <span class="st">'YOUR-VERCEL-URL/api/sensorMongoDB'</span></span>
<span id="cb5-32"><a href="#cb5-32"></a><span class="co"># Vercel settings</span></span>
<span id="cb5-33"><a href="#cb5-33"></a>VERCEL_API_URL <span class="op">=</span> <span class="st">'YOUR-VERCEL-URL/api/sensor'</span></span>
<span id="cb5-34"><a href="#cb5-34"></a>VERCEL_API_KEY <span class="op">=</span> <span class="st">'YOUR-VERCEL-API-KEY'</span></span>
<span id="cb5-35"><a href="#cb5-35"></a></span>
<span id="cb5-36"><a href="#cb5-36"></a><span class="co"># DHT11 sensor setup</span></span>
<span id="cb5-37"><a href="#cb5-37"></a>SENSOR_POWER_PIN <span class="op">=</span> <span class="dv">13</span>  <span class="co"># Change this to the pin connected to the power control of the sensor</span></span>
<span id="cb5-38"><a href="#cb5-38"></a>SENSOR_DATA_PIN <span class="op">=</span> <span class="dv">15</span>  <span class="co"># Change this to the pin connected to the data pin of the sensor</span></span>
<span id="cb5-39"><a href="#cb5-39"></a>LED_PIN <span class="op">=</span> <span class="dv">2</span>  <span class="co"># GPIO pin for the LED</span></span>
<span id="cb5-40"><a href="#cb5-40"></a></span>
<span id="cb5-41"><a href="#cb5-41"></a><span class="co"># Initialize the sensor power pin and LED pin</span></span>
<span id="cb5-42"><a href="#cb5-42"></a>sensor_power_pin <span class="op">=</span> Pin(SENSOR_POWER_PIN, Pin.OUT)</span>
<span id="cb5-43"><a href="#cb5-43"></a>sensor_data_pin <span class="op">=</span> Pin(SENSOR_DATA_PIN)</span>
<span id="cb5-44"><a href="#cb5-44"></a>led <span class="op">=</span> Pin(LED_PIN, Pin.OUT)</span>
<span id="cb5-45"><a href="#cb5-45"></a></span>
<span id="cb5-46"><a href="#cb5-46"></a><span class="co"># Buffers to store data</span></span>
<span id="cb5-47"><a href="#cb5-47"></a>data_buffer_vercel <span class="op">=</span> []</span>
<span id="cb5-48"><a href="#cb5-48"></a>data_buffer_mongodb <span class="op">=</span> []</span>
<span id="cb5-49"><a href="#cb5-49"></a>thingspeak_buffer <span class="op">=</span> []  <span class="co"># Buffer for ThingSpeak data</span></span>
<span id="cb5-50"><a href="#cb5-50"></a></span>
<span id="cb5-51"><a href="#cb5-51"></a><span class="co"># Control flags</span></span>
<span id="cb5-52"><a href="#cb5-52"></a>SEND_TO_VERCEL <span class="op">=</span> <span class="va">True</span></span>
<span id="cb5-53"><a href="#cb5-53"></a>SEND_TO_GOOGLE_SHEETS <span class="op">=</span> <span class="va">True</span></span>
<span id="cb5-54"><a href="#cb5-54"></a>SEND_TO_THINGSPEAK <span class="op">=</span> <span class="va">True</span></span>
<span id="cb5-55"><a href="#cb5-55"></a>SEND_TO_MONGODB <span class="op">=</span> <span class="va">True</span></span>
<span id="cb5-56"><a href="#cb5-56"></a></span>
<span id="cb5-57"><a href="#cb5-57"></a><span class="kw">def</span> connect_wifi(ssid, password):</span>
<span id="cb5-58"><a href="#cb5-58"></a>    wlan <span class="op">=</span> network.WLAN(network.STA_IF)</span>
<span id="cb5-59"><a href="#cb5-59"></a>    wlan.active(<span class="va">True</span>)</span>
<span id="cb5-60"><a href="#cb5-60"></a>    wlan.<span class="ex">connect</span>(ssid, password)</span>
<span id="cb5-61"><a href="#cb5-61"></a>    <span class="cf">while</span> <span class="kw">not</span> wlan.isconnected():</span>
<span id="cb5-62"><a href="#cb5-62"></a>        time_module.sleep(<span class="dv">1</span>)</span>
<span id="cb5-63"><a href="#cb5-63"></a>        <span class="bu">print</span>(<span class="st">"Connecting to WiFi..."</span>)</span>
<span id="cb5-64"><a href="#cb5-64"></a>    <span class="bu">print</span>(<span class="st">"Connected to WiFi"</span>)</span>
<span id="cb5-65"><a href="#cb5-65"></a>    <span class="bu">print</span>(wlan.ifconfig())</span>
<span id="cb5-66"><a href="#cb5-66"></a></span>
<span id="cb5-67"><a href="#cb5-67"></a><span class="co"># Function to disable sensors</span></span>
<span id="cb5-68"><a href="#cb5-68"></a><span class="kw">def</span> disable_sensors():</span>
<span id="cb5-69"><a href="#cb5-69"></a>    sensor_power_pin.value(<span class="dv">0</span>)  <span class="co"># Turn off sensor by setting the power pin low</span></span>
<span id="cb5-70"><a href="#cb5-70"></a></span>
<span id="cb5-71"><a href="#cb5-71"></a><span class="co"># Function to enable sensors</span></span>
<span id="cb5-72"><a href="#cb5-72"></a><span class="kw">def</span> enable_sensors():</span>
<span id="cb5-73"><a href="#cb5-73"></a>    sensor_power_pin.value(<span class="dv">1</span>)  <span class="co"># Turn on sensor by setting the power pin high</span></span>
<span id="cb5-74"><a href="#cb5-74"></a>    time_module.sleep(<span class="dv">2</span>)  <span class="co"># Wait for the sensor to stabilize    </span></span>
<span id="cb5-75"><a href="#cb5-75"></a><span class="co"># Function to get system status</span></span>
<span id="cb5-76"><a href="#cb5-76"></a><span class="kw">def</span> get_system_status(firstRun):</span>
<span id="cb5-77"><a href="#cb5-77"></a>    free_heap <span class="op">=</span> gc.mem_free()</span>
<span id="cb5-78"><a href="#cb5-78"></a>    total_heap <span class="op">=</span> gc.mem_alloc() <span class="op">+</span> free_heap</span>
<span id="cb5-79"><a href="#cb5-79"></a>    free_heap_percent <span class="op">=</span> (free_heap <span class="op">/</span> total_heap) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb5-80"><a href="#cb5-80"></a>    <span class="cf">if</span> firstRun <span class="op">==</span> <span class="va">True</span>:</span>
<span id="cb5-81"><a href="#cb5-81"></a>        <span class="bu">print</span>(<span class="ss">f"Total heap memory: </span><span class="sc">{</span>total_heap<span class="sc">}</span><span class="ss"> bytes"</span>)</span>
<span id="cb5-82"><a href="#cb5-82"></a>        <span class="co"># Additional information about the system</span></span>
<span id="cb5-83"><a href="#cb5-83"></a>        <span class="bu">print</span>(<span class="ss">f"Frequency: </span><span class="sc">{</span>freq()<span class="sc">}</span><span class="ss"> Hz"</span>)</span>
<span id="cb5-84"><a href="#cb5-84"></a>    <span class="bu">print</span>(<span class="ss">f"Free heap memory: </span><span class="sc">{</span>free_heap<span class="sc">}</span><span class="ss"> bytes (</span><span class="sc">{</span>free_heap_percent<span class="sc">:.2f}</span><span class="ss">%)"</span>)</span>
<span id="cb5-85"><a href="#cb5-85"></a>    </span>
<span id="cb5-86"><a href="#cb5-86"></a><span class="kw">def</span> get_time_chicago():</span>
<span id="cb5-87"><a href="#cb5-87"></a>    max_retries <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb5-88"><a href="#cb5-88"></a>    <span class="cf">for</span> attempt <span class="kw">in</span> <span class="bu">range</span>(max_retries):</span>
<span id="cb5-89"><a href="#cb5-89"></a>        <span class="cf">try</span>:</span>
<span id="cb5-90"><a href="#cb5-90"></a>            ntptime.settime()</span>
<span id="cb5-91"><a href="#cb5-91"></a>            current_time <span class="op">=</span> utime.localtime()</span>
<span id="cb5-92"><a href="#cb5-92"></a>            <span class="cf">break</span></span>
<span id="cb5-93"><a href="#cb5-93"></a>        <span class="cf">except</span> <span class="pp">OSError</span> <span class="im">as</span> e:</span>
<span id="cb5-94"><a href="#cb5-94"></a>            <span class="bu">print</span>(<span class="ss">f"Failed to get NTP time, attempt </span><span class="sc">{</span>attempt <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="ss"> of </span><span class="sc">{</span>max_retries<span class="sc">}</span><span class="ss">. Error: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb5-95"><a href="#cb5-95"></a>            time_module.sleep(<span class="dv">1</span>)</span>
<span id="cb5-96"><a href="#cb5-96"></a>    <span class="cf">else</span>:</span>
<span id="cb5-97"><a href="#cb5-97"></a>        <span class="bu">print</span>(<span class="st">"Could not get NTP time, proceeding without time synchronization."</span>)</span>
<span id="cb5-98"><a href="#cb5-98"></a>        <span class="cf">return</span> utime.localtime()</span>
<span id="cb5-99"><a href="#cb5-99"></a></span>
<span id="cb5-100"><a href="#cb5-100"></a>    <span class="co"># Determine if it is daylight saving time (DST)</span></span>
<span id="cb5-101"><a href="#cb5-101"></a>    month <span class="op">=</span> current_time[<span class="dv">1</span>]</span>
<span id="cb5-102"><a href="#cb5-102"></a>    day <span class="op">=</span> current_time[<span class="dv">2</span>]</span>
<span id="cb5-103"><a href="#cb5-103"></a>    hour <span class="op">=</span> current_time[<span class="dv">3</span>]</span>
<span id="cb5-104"><a href="#cb5-104"></a>    <span class="cf">if</span> (month <span class="op">&gt;</span> <span class="dv">3</span> <span class="kw">and</span> month <span class="op">&lt;</span> <span class="dv">11</span>) <span class="kw">or</span> (month <span class="op">==</span> <span class="dv">3</span> <span class="kw">and</span> day <span class="op">&gt;=</span> <span class="dv">8</span> <span class="kw">and</span> hour <span class="op">&gt;=</span> <span class="dv">2</span>) <span class="kw">or</span> (month <span class="op">==</span> <span class="dv">11</span> <span class="kw">and</span> day <span class="op">&lt;</span> <span class="dv">1</span> <span class="kw">and</span> hour <span class="op">&lt;</span> <span class="dv">2</span>):</span>
<span id="cb5-105"><a href="#cb5-105"></a>        is_dst <span class="op">=</span> <span class="va">True</span></span>
<span id="cb5-106"><a href="#cb5-106"></a>    <span class="cf">else</span>:</span>
<span id="cb5-107"><a href="#cb5-107"></a>        is_dst <span class="op">=</span> <span class="va">False</span></span>
<span id="cb5-108"><a href="#cb5-108"></a>    </span>
<span id="cb5-109"><a href="#cb5-109"></a>    offset <span class="op">=</span> <span class="op">-</span><span class="dv">6</span> <span class="op">*</span> <span class="dv">3600</span> <span class="cf">if</span> <span class="kw">not</span> is_dst <span class="cf">else</span> <span class="op">-</span><span class="dv">5</span> <span class="op">*</span> <span class="dv">3600</span></span>
<span id="cb5-110"><a href="#cb5-110"></a>    local_time <span class="op">=</span> utime.mktime(current_time) <span class="op">+</span> offset</span>
<span id="cb5-111"><a href="#cb5-111"></a>    <span class="cf">return</span> utime.localtime(local_time)</span>
<span id="cb5-112"><a href="#cb5-112"></a></span>
<span id="cb5-113"><a href="#cb5-113"></a><span class="kw">def</span> read_sensor():</span>
<span id="cb5-114"><a href="#cb5-114"></a>    <span class="cf">try</span>:</span>
<span id="cb5-115"><a href="#cb5-115"></a>        led.off()</span>
<span id="cb5-116"><a href="#cb5-116"></a>        sensor <span class="op">=</span> dht.DHT11(sensor_data_pin)</span>
<span id="cb5-117"><a href="#cb5-117"></a>        time_module.sleep(<span class="dv">1</span>) <span class="co">#the DHT11 sensor takes 1 second</span></span>
<span id="cb5-118"><a href="#cb5-118"></a>        sensor.measure()</span>
<span id="cb5-119"><a href="#cb5-119"></a>        led.on()</span>
<span id="cb5-120"><a href="#cb5-120"></a>        temp <span class="op">=</span> sensor.temperature()</span>
<span id="cb5-121"><a href="#cb5-121"></a>        hum <span class="op">=</span> sensor.humidity()</span>
<span id="cb5-122"><a href="#cb5-122"></a>        <span class="cf">return</span> temp, hum</span>
<span id="cb5-123"><a href="#cb5-123"></a>    <span class="cf">except</span> <span class="pp">OSError</span> <span class="im">as</span> e:</span>
<span id="cb5-124"><a href="#cb5-124"></a>        <span class="bu">print</span>(<span class="st">"Failed to read sensor. Exception: "</span>, e)</span>
<span id="cb5-125"><a href="#cb5-125"></a>        <span class="cf">return</span> <span class="va">None</span>, <span class="va">None</span></span>
<span id="cb5-126"><a href="#cb5-126"></a><span class="co"># Read the access token from the file uploaded earlier</span></span>
<span id="cb5-127"><a href="#cb5-127"></a><span class="kw">def</span> read_access_token():</span>
<span id="cb5-128"><a href="#cb5-128"></a>    <span class="cf">with</span> <span class="bu">open</span>(<span class="st">'access_token.txt'</span>, <span class="st">'r'</span>) <span class="im">as</span> token_file:</span>
<span id="cb5-129"><a href="#cb5-129"></a>        <span class="cf">return</span> token_file.read().strip()</span>
<span id="cb5-130"><a href="#cb5-130"></a></span>
<span id="cb5-131"><a href="#cb5-131"></a><span class="co"># ACCESS_TOKEN = read_access_token()</span></span>
<span id="cb5-132"><a href="#cb5-132"></a><span class="co"># print(ACCESS_TOKEN)</span></span>
<span id="cb5-133"><a href="#cb5-133"></a></span>
<span id="cb5-134"><a href="#cb5-134"></a><span class="im">import</span> usocket <span class="im">as</span> socket</span>
<span id="cb5-135"><a href="#cb5-135"></a><span class="im">import</span> ssl</span>
<span id="cb5-136"><a href="#cb5-136"></a><span class="kw">def</span> send_data_to_google_sheets(temp_c, temp_f, humidity, time_str, date_str):</span>
<span id="cb5-137"><a href="#cb5-137"></a><span class="co">#     print(time_module.time())</span></span>
<span id="cb5-138"><a href="#cb5-138"></a>    url <span class="op">=</span> GOOGLE_URL  <span class="co"># Define your Google URL here</span></span>
<span id="cb5-139"><a href="#cb5-139"></a>    headers <span class="op">=</span> {</span>
<span id="cb5-140"><a href="#cb5-140"></a>        <span class="st">'Content-Type'</span>: <span class="st">'application/x-www-form-urlencoded'</span></span>
<span id="cb5-141"><a href="#cb5-141"></a>    }</span>
<span id="cb5-142"><a href="#cb5-142"></a>    data <span class="op">=</span> {</span>
<span id="cb5-143"><a href="#cb5-143"></a>        <span class="st">'Date'</span>: date_str,</span>
<span id="cb5-144"><a href="#cb5-144"></a>        <span class="st">'Time'</span>: time_str,</span>
<span id="cb5-145"><a href="#cb5-145"></a>        <span class="st">'Humidity %'</span>: humidity,</span>
<span id="cb5-146"><a href="#cb5-146"></a>        <span class="st">'Temp F'</span>: temp_f,</span>
<span id="cb5-147"><a href="#cb5-147"></a>        <span class="st">'Temp C'</span>: temp_c</span>
<span id="cb5-148"><a href="#cb5-148"></a>    }</span>
<span id="cb5-149"><a href="#cb5-149"></a><span class="co">#     print(time_module.time())</span></span>
<span id="cb5-150"><a href="#cb5-150"></a>    <span class="co"># Construct the URL-encoded string manually</span></span>
<span id="cb5-151"><a href="#cb5-151"></a>    encoded_data <span class="op">=</span> (</span>
<span id="cb5-152"><a href="#cb5-152"></a>        <span class="st">"Date="</span> <span class="op">+</span> date_str <span class="op">+</span></span>
<span id="cb5-153"><a href="#cb5-153"></a>        <span class="st">"&amp;Time="</span> <span class="op">+</span> time_str <span class="op">+</span></span>
<span id="cb5-154"><a href="#cb5-154"></a>        <span class="st">"&amp;Humidity %="</span> <span class="op">+</span> <span class="bu">str</span>(humidity) <span class="op">+</span></span>
<span id="cb5-155"><a href="#cb5-155"></a>        <span class="st">"&amp;Temp F="</span> <span class="op">+</span> <span class="bu">str</span>(temp_f) <span class="op">+</span></span>
<span id="cb5-156"><a href="#cb5-156"></a>        <span class="st">"&amp;Temp C="</span> <span class="op">+</span> <span class="bu">str</span>(temp_c)</span>
<span id="cb5-157"><a href="#cb5-157"></a>     ) </span>
<span id="cb5-158"><a href="#cb5-158"></a>    <span class="cf">try</span>:</span>
<span id="cb5-159"><a href="#cb5-159"></a>        <span class="co"># Extract host and path from URL</span></span>
<span id="cb5-160"><a href="#cb5-160"></a>        _, _, host, path <span class="op">=</span> url.split(<span class="st">'/'</span>, <span class="dv">3</span>)</span>
<span id="cb5-161"><a href="#cb5-161"></a>        </span>
<span id="cb5-162"><a href="#cb5-162"></a>        <span class="co"># Set up a socket connection</span></span>
<span id="cb5-163"><a href="#cb5-163"></a>        addr <span class="op">=</span> socket.getaddrinfo(host, <span class="dv">443</span>)[<span class="dv">0</span>][<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb5-164"><a href="#cb5-164"></a>        s <span class="op">=</span> socket.socket()</span>
<span id="cb5-165"><a href="#cb5-165"></a>        s.<span class="ex">connect</span>(addr)</span>
<span id="cb5-166"><a href="#cb5-166"></a>        s <span class="op">=</span> ssl.wrap_socket(s)</span>
<span id="cb5-167"><a href="#cb5-167"></a>        </span>
<span id="cb5-168"><a href="#cb5-168"></a>        <span class="co"># Create the HTTP request manually</span></span>
<span id="cb5-169"><a href="#cb5-169"></a>        request <span class="op">=</span> <span class="ss">f"POST /</span><span class="sc">{</span>path<span class="sc">}</span><span class="ss"> HTTP/1.1</span><span class="ch">\r\n</span><span class="ss">Host: </span><span class="sc">{</span>host<span class="sc">}</span><span class="ch">\r\n</span><span class="ss">"</span></span>
<span id="cb5-170"><a href="#cb5-170"></a>        request <span class="op">+=</span> <span class="st">"Content-Type: application/x-www-form-urlencoded</span><span class="ch">\r\n</span><span class="st">"</span></span>
<span id="cb5-171"><a href="#cb5-171"></a>        request <span class="op">+=</span> <span class="ss">f"Content-Length: </span><span class="sc">{</span><span class="bu">len</span>(encoded_data)<span class="sc">}</span><span class="ch">\r\n\r\n</span><span class="ss">"</span></span>
<span id="cb5-172"><a href="#cb5-172"></a>        request <span class="op">+=</span> encoded_data</span>
<span id="cb5-173"><a href="#cb5-173"></a></span>
<span id="cb5-174"><a href="#cb5-174"></a>        <span class="co"># Send the request</span></span>
<span id="cb5-175"><a href="#cb5-175"></a>        s.write(request)</span>
<span id="cb5-176"><a href="#cb5-176"></a>        </span>
<span id="cb5-177"><a href="#cb5-177"></a><span class="co">#         # Read the response</span></span>
<span id="cb5-178"><a href="#cb5-178"></a><span class="co">#         response = s.read(1024)  # Read up to 2048 bytes from the response, THIS TAKES A WHILE, SET TO WHATEVER. 128-1024</span></span>
<span id="cb5-179"><a href="#cb5-179"></a><span class="co">#         print('Data sent to Google Sheets:', response)  </span></span>
<span id="cb5-180"><a href="#cb5-180"></a>        <span class="co"># Close the socket</span></span>
<span id="cb5-181"><a href="#cb5-181"></a>        s.close()</span>
<span id="cb5-182"><a href="#cb5-182"></a>        <span class="bu">print</span>(<span class="st">'Data sent to Google Sheets!'</span>)</span>
<span id="cb5-183"><a href="#cb5-183"></a><span class="co">#         print(time_module.time())</span></span>
<span id="cb5-184"><a href="#cb5-184"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb5-185"><a href="#cb5-185"></a>        <span class="bu">print</span>(<span class="st">'Failed to send data to Google Sheets:'</span>, e)</span>
<span id="cb5-186"><a href="#cb5-186"></a></span>
<span id="cb5-187"><a href="#cb5-187"></a><span class="co"># # Function to send data to Google Sheets</span></span>
<span id="cb5-188"><a href="#cb5-188"></a><span class="co"># def send_data_to_google_sheets(temp_c, temp_f, humidity,time_str,date_str):</span></span>
<span id="cb5-189"><a href="#cb5-189"></a><span class="co">#     print(time_module.time())</span></span>
<span id="cb5-190"><a href="#cb5-190"></a><span class="co">#     url = GOOGLE_URL</span></span>
<span id="cb5-191"><a href="#cb5-191"></a><span class="co">#     headers = {</span></span>
<span id="cb5-192"><a href="#cb5-192"></a><span class="co">#         'Content-Type': 'application/x-www-form-urlencoded'</span></span>
<span id="cb5-193"><a href="#cb5-193"></a><span class="co">#     }</span></span>
<span id="cb5-194"><a href="#cb5-194"></a><span class="co">#     # Construct the URL-encoded string manually</span></span>
<span id="cb5-195"><a href="#cb5-195"></a><span class="co">#     print(time_module.time())</span></span>
<span id="cb5-196"><a href="#cb5-196"></a><span class="co">#     encoded_data = (</span></span>
<span id="cb5-197"><a href="#cb5-197"></a><span class="co">#         "Date=" + date_str +</span></span>
<span id="cb5-198"><a href="#cb5-198"></a><span class="co">#         "&amp;Time=" + time_str +</span></span>
<span id="cb5-199"><a href="#cb5-199"></a><span class="co">#         "&amp;Humidity %=" + str(humidity) +</span></span>
<span id="cb5-200"><a href="#cb5-200"></a><span class="co">#         "&amp;Temp F=" + str(temp_f) +</span></span>
<span id="cb5-201"><a href="#cb5-201"></a><span class="co">#         "&amp;Temp C=" + str(temp_c)</span></span>
<span id="cb5-202"><a href="#cb5-202"></a><span class="co">#     )</span></span>
<span id="cb5-203"><a href="#cb5-203"></a><span class="co">#     print(encoded_data)</span></span>
<span id="cb5-204"><a href="#cb5-204"></a><span class="co">#     print(time_module.time())</span></span>
<span id="cb5-205"><a href="#cb5-205"></a><span class="co">#     print("request")</span></span>
<span id="cb5-206"><a href="#cb5-206"></a><span class="co">#     try:</span></span>
<span id="cb5-207"><a href="#cb5-207"></a><span class="co">#         # Get initial free memory</span></span>
<span id="cb5-208"><a href="#cb5-208"></a><span class="co">#         # Run garbage collection to get a clean slate</span></span>
<span id="cb5-209"><a href="#cb5-209"></a><span class="co">#         gc.collect()</span></span>
<span id="cb5-210"><a href="#cb5-210"></a><span class="co">#         initial_free = gc.mem_free()</span></span>
<span id="cb5-211"><a href="#cb5-211"></a><span class="co">#         response = requests.post(url, data=encoded_data, headers=headers) #DRAGS... Also</span></span>
<span id="cb5-212"><a href="#cb5-212"></a><span class="co">#         # Run garbage collection again</span></span>
<span id="cb5-213"><a href="#cb5-213"></a><span class="co">#         gc.collect()</span></span>
<span id="cb5-214"><a href="#cb5-214"></a><span class="co">#         # Get final free memory</span></span>
<span id="cb5-215"><a href="#cb5-215"></a><span class="co">#         final_free = gc.mem_free()</span></span>
<span id="cb5-216"><a href="#cb5-216"></a><span class="co"># </span></span>
<span id="cb5-217"><a href="#cb5-217"></a><span class="co">#         # Calculate memory used by the variable</span></span>
<span id="cb5-218"><a href="#cb5-218"></a><span class="co">#         memory_used = initial_free - final_free</span></span>
<span id="cb5-219"><a href="#cb5-219"></a><span class="co">#         print('Data sent to Google Sheets:')</span></span>
<span id="cb5-220"><a href="#cb5-220"></a><span class="co">#         print(time_module.time())</span></span>
<span id="cb5-221"><a href="#cb5-221"></a><span class="co">#         print('Size of response: ', memory_used, 'bytes') # Size of response:  46352 bytes. Crazy.... That's like ~4635 date strings.</span></span>
<span id="cb5-222"><a href="#cb5-222"></a><span class="co">#     except Exception as e:</span></span>
<span id="cb5-223"><a href="#cb5-223"></a><span class="co">#         print('Failed to send data to Google Sheets:', e)</span></span>
<span id="cb5-224"><a href="#cb5-224"></a></span>
<span id="cb5-225"><a href="#cb5-225"></a><span class="kw">def</span> send_data_to_thingspeak():</span>
<span id="cb5-226"><a href="#cb5-226"></a>    <span class="co">"""Send data to ThingSpeak."""</span></span>
<span id="cb5-227"><a href="#cb5-227"></a>    <span class="cf">if</span> SEND_TO_THINGSPEAK <span class="kw">and</span> thingspeak_buffer:</span>
<span id="cb5-228"><a href="#cb5-228"></a>        <span class="cf">if</span> <span class="bu">len</span>(thingspeak_buffer) <span class="op">&gt;</span> <span class="dv">1</span>:</span>
<span id="cb5-229"><a href="#cb5-229"></a>            <span class="co"># Bulk update</span></span>
<span id="cb5-230"><a href="#cb5-230"></a>            payload <span class="op">=</span> {</span>
<span id="cb5-231"><a href="#cb5-231"></a>                    <span class="st">'write_api_key'</span>: THINGSPEAK_API_KEY,</span>
<span id="cb5-232"><a href="#cb5-232"></a>                    <span class="st">'updates'</span>: []</span>
<span id="cb5-233"><a href="#cb5-233"></a>                }</span>
<span id="cb5-234"><a href="#cb5-234"></a>            <span class="cf">for</span> data <span class="kw">in</span> thingspeak_buffer:</span>
<span id="cb5-235"><a href="#cb5-235"></a>                update <span class="op">=</span> {</span>
<span id="cb5-236"><a href="#cb5-236"></a>                    <span class="st">'created_at'</span>: <span class="ss">f"</span><span class="sc">{</span>data[<span class="st">'date'</span>]<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>data[<span class="st">'time'</span>]<span class="sc">}</span><span class="ss"> -0500"</span>,</span>
<span id="cb5-237"><a href="#cb5-237"></a>                    <span class="st">'field1'</span>: data[<span class="st">'temperature_C'</span>],</span>
<span id="cb5-238"><a href="#cb5-238"></a>                    <span class="st">'field2'</span>: data[<span class="st">'temperature_F'</span>],</span>
<span id="cb5-239"><a href="#cb5-239"></a>                    <span class="st">'field3'</span>: data[<span class="st">'humidityPercent'</span>],</span>
<span id="cb5-240"><a href="#cb5-240"></a>                    <span class="st">'field4'</span>: data[<span class="st">'time'</span>],</span>
<span id="cb5-241"><a href="#cb5-241"></a>                    <span class="st">'field5'</span>: data[<span class="st">'date'</span>]</span>
<span id="cb5-242"><a href="#cb5-242"></a>                }</span>
<span id="cb5-243"><a href="#cb5-243"></a>                payload[<span class="st">'updates'</span>].append(update)</span>
<span id="cb5-244"><a href="#cb5-244"></a></span>
<span id="cb5-245"><a href="#cb5-245"></a>            <span class="cf">try</span>:</span>
<span id="cb5-246"><a href="#cb5-246"></a>                <span class="co"># Send the bulk update request to ThingSpeak</span></span>
<span id="cb5-247"><a href="#cb5-247"></a>                headers <span class="op">=</span> {<span class="st">'Content-Type'</span>: <span class="st">'application/json'</span>}</span>
<span id="cb5-248"><a href="#cb5-248"></a>                <span class="co">#print(len(thingspeak_buffer))</span></span>
<span id="cb5-249"><a href="#cb5-249"></a>                <span class="co">#print(headers)</span></span>
<span id="cb5-250"><a href="#cb5-250"></a>                <span class="co">#print(json.dumps(payload))</span></span>
<span id="cb5-251"><a href="#cb5-251"></a>                <span class="co"># Convert the data payload to JSON format</span></span>
<span id="cb5-252"><a href="#cb5-252"></a>                json_data <span class="op">=</span> json.dumps(payload)</span>
<span id="cb5-253"><a href="#cb5-253"></a>                response <span class="op">=</span> requests.post(THINGSPEAK_BULK_UPDATE_URL,headers<span class="op">=</span>headers,data<span class="op">=</span>json_data)</span>
<span id="cb5-254"><a href="#cb5-254"></a>                <span class="cf">if</span> response.status_code <span class="op">==</span> <span class="dv">202</span>:</span>
<span id="cb5-255"><a href="#cb5-255"></a>                    <span class="bu">print</span>(<span class="st">'Data posted to ThingSpeak (bulk update):'</span>, response.text)</span>
<span id="cb5-256"><a href="#cb5-256"></a>                    thingspeak_buffer.clear()  <span class="co"># Clear the buffer after successful update</span></span>
<span id="cb5-257"><a href="#cb5-257"></a>                <span class="cf">else</span>:</span>
<span id="cb5-258"><a href="#cb5-258"></a>                    <span class="bu">print</span>(<span class="ss">f'Failed to send data to ThingSpeak (bulk update): </span><span class="sc">{</span>response<span class="sc">.</span>status_code<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>response<span class="sc">.</span>text<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb5-259"><a href="#cb5-259"></a>            <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb5-260"><a href="#cb5-260"></a>                <span class="bu">print</span>(<span class="st">'Failed to send data to ThingSpeak (bulk update):'</span>, e)</span>
<span id="cb5-261"><a href="#cb5-261"></a>        <span class="cf">else</span>:</span>
<span id="cb5-262"><a href="#cb5-262"></a>            data <span class="op">=</span> thingspeak_buffer.pop(<span class="dv">0</span>)  <span class="co"># Get the first item in the buffer</span></span>
<span id="cb5-263"><a href="#cb5-263"></a>            <span class="bu">print</span>(data)</span>
<span id="cb5-264"><a href="#cb5-264"></a>            payload <span class="op">=</span> {</span>
<span id="cb5-265"><a href="#cb5-265"></a>            <span class="st">'api_key'</span>: THINGSPEAK_API_KEY,</span>
<span id="cb5-266"><a href="#cb5-266"></a>            <span class="st">'field1'</span>: data[<span class="st">'temperature_C'</span>],</span>
<span id="cb5-267"><a href="#cb5-267"></a>            <span class="st">'field2'</span>: data[<span class="st">'temperature_F'</span>],</span>
<span id="cb5-268"><a href="#cb5-268"></a>            <span class="st">'field3'</span>: data[<span class="st">'humidityPercent'</span>],</span>
<span id="cb5-269"><a href="#cb5-269"></a>            <span class="st">'field4'</span>: data[<span class="st">'time'</span>],</span>
<span id="cb5-270"><a href="#cb5-270"></a>            <span class="st">'field5'</span>: data[<span class="st">'date'</span>]</span>
<span id="cb5-271"><a href="#cb5-271"></a>        }</span>
<span id="cb5-272"><a href="#cb5-272"></a>            <span class="cf">try</span>:</span>
<span id="cb5-273"><a href="#cb5-273"></a>                response <span class="op">=</span> requests.post(THINGSPEAK_URL, json<span class="op">=</span>payload)</span>
<span id="cb5-274"><a href="#cb5-274"></a>                <span class="bu">print</span>(<span class="st">'Data posted to ThingSpeak'</span>, response.text)</span>
<span id="cb5-275"><a href="#cb5-275"></a>                <span class="bu">print</span>(payload)</span>
<span id="cb5-276"><a href="#cb5-276"></a>                thingspeak_buffer.clear()  <span class="co"># Clear the buffer after successful update</span></span>
<span id="cb5-277"><a href="#cb5-277"></a>            <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb5-278"><a href="#cb5-278"></a>                <span class="bu">print</span>(<span class="st">'Failed to send data to ThingSpeak:'</span>, e)</span>
<span id="cb5-279"><a href="#cb5-279"></a>                thingspeak_buffer.clear()</span>
<span id="cb5-280"><a href="#cb5-280"></a><span class="kw">def</span> send_data_to_mongodb():</span>
<span id="cb5-281"><a href="#cb5-281"></a>    url <span class="op">=</span> MONGODB__VERCEL_API_URL</span>
<span id="cb5-282"><a href="#cb5-282"></a>    headers <span class="op">=</span> {</span>
<span id="cb5-283"><a href="#cb5-283"></a>        <span class="st">'x-api-key'</span>: VERCEL_API_KEY,</span>
<span id="cb5-284"><a href="#cb5-284"></a>        <span class="st">'Content-Type'</span>: <span class="st">'application/json'</span></span>
<span id="cb5-285"><a href="#cb5-285"></a>    }</span>
<span id="cb5-286"><a href="#cb5-286"></a></span>
<span id="cb5-287"><a href="#cb5-287"></a>    <span class="cf">try</span>:</span>
<span id="cb5-288"><a href="#cb5-288"></a>        <span class="co"># Convert the data dictionary to a JSON string</span></span>
<span id="cb5-289"><a href="#cb5-289"></a>        json_data <span class="op">=</span> json.dumps(data_buffer_mongodb)</span>
<span id="cb5-290"><a href="#cb5-290"></a>        </span>
<span id="cb5-291"><a href="#cb5-291"></a>        <span class="co"># Print the request details for debugging</span></span>
<span id="cb5-292"><a href="#cb5-292"></a><span class="co">#         print("Sending data to:", url)</span></span>
<span id="cb5-293"><a href="#cb5-293"></a><span class="co">#         print("Headers:", headers)</span></span>
<span id="cb5-294"><a href="#cb5-294"></a><span class="co">#         print("Payload:", json_data)</span></span>
<span id="cb5-295"><a href="#cb5-295"></a>        </span>
<span id="cb5-296"><a href="#cb5-296"></a>        response <span class="op">=</span> requests.post(url, data<span class="op">=</span>json_data, headers<span class="op">=</span>headers)</span>
<span id="cb5-297"><a href="#cb5-297"></a>        </span>
<span id="cb5-298"><a href="#cb5-298"></a>        <span class="co"># Print the response details for debugging</span></span>
<span id="cb5-299"><a href="#cb5-299"></a>        <span class="bu">print</span>(<span class="st">"Status Code:"</span>, response.status_code)</span>
<span id="cb5-300"><a href="#cb5-300"></a>        <span class="bu">print</span>(<span class="st">"Response Text:"</span>, response.text)</span>
<span id="cb5-301"><a href="#cb5-301"></a>        data_buffer_mongodb.clear()</span>
<span id="cb5-302"><a href="#cb5-302"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb5-303"><a href="#cb5-303"></a>        <span class="bu">print</span>(<span class="st">"Failed to send data to Vercel MongoDB API:"</span>, e)</span>
<span id="cb5-304"><a href="#cb5-304"></a>        data_buffer_mongodb.clear()</span>
<span id="cb5-305"><a href="#cb5-305"></a><span class="kw">def</span> send_data_to_vercel():</span>
<span id="cb5-306"><a href="#cb5-306"></a>    url <span class="op">=</span> VERCEL_API_URL</span>
<span id="cb5-307"><a href="#cb5-307"></a>    headers <span class="op">=</span> {</span>
<span id="cb5-308"><a href="#cb5-308"></a>        <span class="st">'x-api-key'</span>: VERCEL_API_KEY,</span>
<span id="cb5-309"><a href="#cb5-309"></a>        <span class="st">'Content-Type'</span>: <span class="st">'application/json'</span></span>
<span id="cb5-310"><a href="#cb5-310"></a>    }</span>
<span id="cb5-311"><a href="#cb5-311"></a></span>
<span id="cb5-312"><a href="#cb5-312"></a>    <span class="cf">try</span>:</span>
<span id="cb5-313"><a href="#cb5-313"></a>        <span class="co"># Convert the data dictionary to a JSON string</span></span>
<span id="cb5-314"><a href="#cb5-314"></a>        json_data <span class="op">=</span> json.dumps(data_buffer_vercel)</span>
<span id="cb5-315"><a href="#cb5-315"></a>        </span>
<span id="cb5-316"><a href="#cb5-316"></a>        <span class="co"># Print the request details for debugging</span></span>
<span id="cb5-317"><a href="#cb5-317"></a><span class="co">#         print("Sending data to:", url)</span></span>
<span id="cb5-318"><a href="#cb5-318"></a><span class="co">#         print("Headers:", headers)</span></span>
<span id="cb5-319"><a href="#cb5-319"></a><span class="co">#         print("Payload:", json_data)</span></span>
<span id="cb5-320"><a href="#cb5-320"></a>        </span>
<span id="cb5-321"><a href="#cb5-321"></a>        response <span class="op">=</span> requests.post(url, data<span class="op">=</span>json_data, headers<span class="op">=</span>headers)</span>
<span id="cb5-322"><a href="#cb5-322"></a>        </span>
<span id="cb5-323"><a href="#cb5-323"></a>        <span class="co"># Print the response details for debugging</span></span>
<span id="cb5-324"><a href="#cb5-324"></a>        <span class="bu">print</span>(<span class="st">"Status Code:"</span>, response.status_code)</span>
<span id="cb5-325"><a href="#cb5-325"></a>        <span class="bu">print</span>(<span class="st">"Response Text:"</span>, response.text)</span>
<span id="cb5-326"><a href="#cb5-326"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb5-327"><a href="#cb5-327"></a>        <span class="bu">print</span>(<span class="st">"Failed to send data to Vercel:"</span>, e)</span>
<span id="cb5-328"><a href="#cb5-328"></a></span>
<span id="cb5-329"><a href="#cb5-329"></a><span class="kw">def</span> main():</span>
<span id="cb5-330"><a href="#cb5-330"></a>    firstRun <span class="op">=</span> <span class="va">True</span></span>
<span id="cb5-331"><a href="#cb5-331"></a>    enable_sensors()</span>
<span id="cb5-332"><a href="#cb5-332"></a>    temp,hum<span class="op">=</span>read_sensor()</span>
<span id="cb5-333"><a href="#cb5-333"></a>    <span class="bu">print</span>(temp,hum)</span>
<span id="cb5-334"><a href="#cb5-334"></a>    led.off()</span>
<span id="cb5-335"><a href="#cb5-335"></a>    disable_sensors()</span>
<span id="cb5-336"><a href="#cb5-336"></a>    connect_wifi(SSID, PASSWORD)</span>
<span id="cb5-337"><a href="#cb5-337"></a>    enable_sensors()</span>
<span id="cb5-338"><a href="#cb5-338"></a>    last_google_sheets_update <span class="op">=</span> time_module.time()</span>
<span id="cb5-339"><a href="#cb5-339"></a>    last_thingspeak_update <span class="op">=</span> time_module.time()</span>
<span id="cb5-340"><a href="#cb5-340"></a>    last_vercel_update <span class="op">=</span> time_module.time()</span>
<span id="cb5-341"><a href="#cb5-341"></a>    last_mongodb_update <span class="op">=</span> time_module.time()</span>
<span id="cb5-342"><a href="#cb5-342"></a>    <span class="bu">iter</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb5-343"><a href="#cb5-343"></a>    <span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb5-344"><a href="#cb5-344"></a>        <span class="cf">try</span>:</span>
<span id="cb5-345"><a href="#cb5-345"></a>            led.on()</span>
<span id="cb5-346"><a href="#cb5-346"></a>            enable_sensors() <span class="co">#enable the sensors via GPIO</span></span>
<span id="cb5-347"><a href="#cb5-347"></a>            temp_c, humidity <span class="op">=</span> read_sensor() <span class="co">#log readings</span></span>
<span id="cb5-348"><a href="#cb5-348"></a>            led.off()</span>
<span id="cb5-349"><a href="#cb5-349"></a>            disable_sensors()<span class="co"># disable the sensors so wifi transmission doesn't run into power issues.</span></span>
<span id="cb5-350"><a href="#cb5-350"></a>            <span class="cf">if</span> temp_c <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> humidity <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb5-351"><a href="#cb5-351"></a>                temp_f <span class="op">=</span> temp_c <span class="op">*</span> <span class="dv">9</span> <span class="op">/</span> <span class="dv">5</span> <span class="op">+</span> <span class="dv">32</span></span>
<span id="cb5-352"><a href="#cb5-352"></a>                local_time <span class="op">=</span> get_time_chicago()</span>
<span id="cb5-353"><a href="#cb5-353"></a>                date_str <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>local_time[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>local_time[<span class="dv">1</span>]<span class="sc">:02d}</span><span class="ss">-</span><span class="sc">{</span>local_time[<span class="dv">2</span>]<span class="sc">:02d}</span><span class="ss">"</span></span>
<span id="cb5-354"><a href="#cb5-354"></a>                time_str <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>local_time[<span class="dv">3</span>]<span class="sc">:02d}</span><span class="ss">:</span><span class="sc">{</span>local_time[<span class="dv">4</span>]<span class="sc">:02d}</span><span class="ss">:</span><span class="sc">{</span>local_time[<span class="dv">5</span>]<span class="sc">:02d}</span><span class="ss">"</span></span>
<span id="cb5-355"><a href="#cb5-355"></a>                <span class="bu">print</span>(<span class="ss">f'[</span><span class="sc">{</span><span class="bu">iter</span><span class="sc">}</span><span class="ss">]Date: </span><span class="sc">{</span>date_str<span class="sc">}</span><span class="ss">, Time: </span><span class="sc">{</span>time_str<span class="sc">}</span><span class="ss">, Temperature: </span><span class="sc">{</span>temp_c<span class="sc">}</span><span class="ss">°C, Humidity: </span><span class="sc">{</span>hum<span class="sc">}</span><span class="ss">%, Temperature: </span><span class="sc">{</span>temp_f<span class="sc">}</span><span class="ss">°F '</span>)</span>
<span id="cb5-356"><a href="#cb5-356"></a>    <span class="co">#             print(date_str)</span></span>
<span id="cb5-357"><a href="#cb5-357"></a>    <span class="co">#             print(time_str)</span></span>
<span id="cb5-358"><a href="#cb5-358"></a>                <span class="co"># Add data to buffers</span></span>
<span id="cb5-359"><a href="#cb5-359"></a>                data <span class="op">=</span> {</span>
<span id="cb5-360"><a href="#cb5-360"></a>                        <span class="st">'date'</span>: date_str,</span>
<span id="cb5-361"><a href="#cb5-361"></a>                        <span class="st">'time'</span>: time_str,</span>
<span id="cb5-362"><a href="#cb5-362"></a>                        <span class="st">'humidityPercent'</span>: humidity,</span>
<span id="cb5-363"><a href="#cb5-363"></a>                        <span class="st">'temperatureFahrenheit'</span>: temp_f,</span>
<span id="cb5-364"><a href="#cb5-364"></a>                        <span class="st">'temperatureCelsius'</span>: temp_c</span>
<span id="cb5-365"><a href="#cb5-365"></a>                    }</span>
<span id="cb5-366"><a href="#cb5-366"></a>                data_buffer_vercel<span class="op">=</span>{</span>
<span id="cb5-367"><a href="#cb5-367"></a>                    <span class="st">'date'</span>: date_str,</span>
<span id="cb5-368"><a href="#cb5-368"></a>                    <span class="st">'time'</span>: time_str,</span>
<span id="cb5-369"><a href="#cb5-369"></a>                    <span class="st">'humidityPercent'</span>: humidity,</span>
<span id="cb5-370"><a href="#cb5-370"></a>                    <span class="st">'temperatureFahrenheit'</span>: temp_f,</span>
<span id="cb5-371"><a href="#cb5-371"></a>                    <span class="st">'temperatureCelsius'</span>: temp_c</span>
<span id="cb5-372"><a href="#cb5-372"></a>                }</span>
<span id="cb5-373"><a href="#cb5-373"></a>                thingspeak_buffer.append({</span>
<span id="cb5-374"><a href="#cb5-374"></a>                    <span class="st">'temperature_C'</span>: temp_c,</span>
<span id="cb5-375"><a href="#cb5-375"></a>                    <span class="st">'temperature_F'</span>: temp_f,</span>
<span id="cb5-376"><a href="#cb5-376"></a>                    <span class="st">'humidityPercent'</span>: humidity,</span>
<span id="cb5-377"><a href="#cb5-377"></a>                    <span class="st">'time'</span>: time_str,</span>
<span id="cb5-378"><a href="#cb5-378"></a>                    <span class="st">'date'</span>: date_str</span>
<span id="cb5-379"><a href="#cb5-379"></a>                })</span>
<span id="cb5-380"><a href="#cb5-380"></a>                data_buffer_mongodb.append({</span>
<span id="cb5-381"><a href="#cb5-381"></a>                    <span class="st">'date'</span>: date_str,</span>
<span id="cb5-382"><a href="#cb5-382"></a>                    <span class="st">'time'</span>: time_str,</span>
<span id="cb5-383"><a href="#cb5-383"></a>                    <span class="st">'humidityPercent'</span>: humidity,</span>
<span id="cb5-384"><a href="#cb5-384"></a>                    <span class="st">'temperatureFahrenheit'</span>: temp_f,</span>
<span id="cb5-385"><a href="#cb5-385"></a>                    <span class="st">'temperatureCelsius'</span>: temp,</span>
<span id="cb5-386"><a href="#cb5-386"></a>                })</span>
<span id="cb5-387"><a href="#cb5-387"></a>                <span class="bu">print</span>(<span class="st">"ThingSpeak Buffer:"</span>,<span class="bu">len</span>(thingspeak_buffer),<span class="st">"|Vercel Buffer:"</span>,<span class="bu">len</span>(data_buffer_vercel),<span class="st">"|MongoDB Buffer:"</span>,<span class="bu">len</span>(data_buffer_mongodb))</span>
<span id="cb5-388"><a href="#cb5-388"></a>                 <span class="co"># Check if it's time to send data to Google Sheets </span></span>
<span id="cb5-389"><a href="#cb5-389"></a>                <span class="cf">if</span> time_module.time() <span class="op">-</span> last_google_sheets_update <span class="op">&gt;=</span> <span class="dv">5</span>:</span>
<span id="cb5-390"><a href="#cb5-390"></a>                    </span>
<span id="cb5-391"><a href="#cb5-391"></a>                    send_data_to_google_sheets(temp_c, temp_f, humidity, time_str, date_str)</span>
<span id="cb5-392"><a href="#cb5-392"></a>                    last_google_sheets_update <span class="op">=</span> time_module.time()</span>
<span id="cb5-393"><a href="#cb5-393"></a></span>
<span id="cb5-394"><a href="#cb5-394"></a>                <span class="co"># Check if it's time to send data to ThingSpeak</span></span>
<span id="cb5-395"><a href="#cb5-395"></a>                <span class="cf">if</span> time_module.time() <span class="op">-</span> last_thingspeak_update <span class="op">&gt;=</span> <span class="dv">15</span>:</span>
<span id="cb5-396"><a href="#cb5-396"></a>                    send_data_to_thingspeak()</span>
<span id="cb5-397"><a href="#cb5-397"></a>                    last_thingspeak_update <span class="op">=</span> time_module.time()</span>
<span id="cb5-398"><a href="#cb5-398"></a></span>
<span id="cb5-399"><a href="#cb5-399"></a>    <span class="co">#             # Check if it's time to send data to Vercel</span></span>
<span id="cb5-400"><a href="#cb5-400"></a>    <span class="co">#Vercel DB no good for this low level stuff. Overflow error and out of memory.</span></span>
<span id="cb5-401"><a href="#cb5-401"></a>    <span class="co">#No append operation as a result.</span></span>
<span id="cb5-402"><a href="#cb5-402"></a>                <span class="cf">if</span> time_module.time() <span class="op">-</span> last_vercel_update <span class="op">&gt;=</span> <span class="dv">3600</span>:</span>
<span id="cb5-403"><a href="#cb5-403"></a>                    send_data_to_vercel()</span>
<span id="cb5-404"><a href="#cb5-404"></a>                    last_vercel_update <span class="op">=</span> time_module.time()</span>
<span id="cb5-405"><a href="#cb5-405"></a></span>
<span id="cb5-406"><a href="#cb5-406"></a>                <span class="co"># Check if it's time to send data to MongoDB</span></span>
<span id="cb5-407"><a href="#cb5-407"></a>                <span class="cf">if</span> time_module.time() <span class="op">-</span> last_mongodb_update <span class="op">&gt;=</span> <span class="dv">15</span>:</span>
<span id="cb5-408"><a href="#cb5-408"></a>                    send_data_to_mongodb()</span>
<span id="cb5-409"><a href="#cb5-409"></a>                    last_mongodb_update <span class="op">=</span> time_module.time()</span>
<span id="cb5-410"><a href="#cb5-410"></a>                led.on()    </span>
<span id="cb5-411"><a href="#cb5-411"></a><span class="co">#                 time_module.sleep(1)  # Wait for 1 seconds before logging the next reading. Note sensor sampling times!</span></span>
<span id="cb5-412"><a href="#cb5-412"></a>                led.off()</span>
<span id="cb5-413"><a href="#cb5-413"></a>                get_system_status(firstRun)</span>
<span id="cb5-414"><a href="#cb5-414"></a>                <span class="bu">print</span>(<span class="st">" "</span>)</span>
<span id="cb5-415"><a href="#cb5-415"></a>                firstRun <span class="op">=</span> <span class="va">False</span></span>
<span id="cb5-416"><a href="#cb5-416"></a>                <span class="bu">iter</span> <span class="op">=</span> <span class="bu">iter</span><span class="op">+</span><span class="dv">1</span></span>
<span id="cb5-417"><a href="#cb5-417"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb5-418"><a href="#cb5-418"></a>            <span class="bu">print</span>(<span class="ss">f"Error in main loop: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>) <span class="co"># usually some one off memory error. It'll reset while still connected to wifi and everyone will be happy.</span></span>
<span id="cb5-419"><a href="#cb5-419"></a>            </span>
<span id="cb5-420"><a href="#cb5-420"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">'__main__'</span>:</span>
<span id="cb5-421"><a href="#cb5-421"></a>    main()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p>And a breakdown:</p>
<details>
<summary>
Code breakdown
</summary>
<section id="import-necessary-libraries" class="level4">
<h4 class="anchored" data-anchor-id="import-necessary-libraries"><strong>Import Necessary Libraries</strong></h4>
<p>First, we import the necessary libraries required for the project:</p>
<ul>
<li><p><strong><code>network</code></strong> for managing Wi-Fi connectivity.</p></li>
<li><p><strong><code>urequests</code></strong> for making HTTP requests to various APIs.</p></li>
<li><p><strong><code>time</code></strong> and <strong><code>utime</code></strong> for handling time-related functions.</p></li>
<li><p><strong><code>dht</code></strong> for interacting with the DHT11 sensor.</p></li>
<li><p><strong><code>ntptime</code></strong> for synchronizing time with an NTP server.</p></li>
<li><p><strong><code>ujson</code></strong> for handling JSON data.</p></li>
<li><p><strong><code>gc</code></strong> for garbage collection to manage memory.</p></li>
<li><p><strong><code>machine</code></strong> for controlling hardware components like GPIO pins.</p></li>
</ul>
</section>
<section id="wi-fi-and-api-credentials" class="level4">
<h4 class="anchored" data-anchor-id="wi-fi-and-api-credentials"><strong>Wi-Fi and API Credentials</strong></h4>
<p>We define constants to store Wi-Fi credentials and API details:</p>
<ul>
<li><p><strong><code>SSID</code></strong> and <strong><code>PASSWORD</code></strong> for Wi-Fi network credentials.</p></li>
<li><p><strong><code>SPREADSHEET_ID</code></strong>, <strong><code>RANGE_NAME</code></strong>, <strong><code>SHEET_NAME</code></strong>, and <strong><code>GOOGLE_URL</code></strong> for Google Sheets integration.</p></li>
<li><p><strong><code>THINGSPEAK_API_KEY</code></strong>, <strong><code>THINGSPEAK_URL</code></strong>, <strong><code>THINGSPEAK_CHANNEL_ID</code></strong>, and <strong><code>THINGSPEAK_BULK_UPDATE_URL</code></strong> for ThingSpeak integration.</p></li>
<li><p><strong><code>MONGODB_API_URL</code></strong>, <strong><code>MONGODB_VERCEL_API_URL</code></strong> for MongoDB integration.</p></li>
<li><p><strong><code>VERCEL_API_URL</code></strong> and <strong><code>VERCEL_API_KEY</code></strong> for Vercel integration.</p></li>
</ul>
</section>
<section id="setting-up-gpio-pins" class="level4">
<h4 class="anchored" data-anchor-id="setting-up-gpio-pins"><strong>Setting Up GPIO Pins</strong></h4>
<p>We configure the GPIO pins on the ESP32:</p>
<ul>
<li><p><strong><code>SENSOR_POWER_PIN</code></strong> to control the power to the DHT11 sensor.</p></li>
<li><p><strong><code>SENSOR_DATA_PIN</code></strong> to read data from the DHT11 sensor.</p></li>
<li><p><strong><code>LED_PIN</code></strong> to control an LED used for indicating status.</p></li>
</ul>
</section>
<section id="data-buffers-and-control-flags" class="level4">
<h4 class="anchored" data-anchor-id="data-buffers-and-control-flags"><strong>Data Buffers and Control Flags</strong></h4>
<p>Buffers are initialized to temporarily store data before sending it to the respective services:</p>
<ul>
<li><strong><code>data_buffer_vercel</code></strong>, <strong><code>data_buffer_mongodb</code></strong>, and <strong><code>thingspeak_buffer</code></strong> store data for Vercel, MongoDB, and ThingSpeak, respectively.</li>
</ul>
<p>Control flags (<strong><code>SEND_TO_VERCEL</code></strong>, <strong><code>SEND_TO_GOOGLE_SHEETS</code></strong>, <strong><code>SEND_TO_THINGSPEAK</code></strong>, <strong><code>SEND_TO_MONGODB</code></strong>) determine whether data should be sent to each service.</p>
</section>
<section id="connecting-to-wi-fi" class="level4">
<h4 class="anchored" data-anchor-id="connecting-to-wi-fi"><strong>Connecting to Wi-Fi</strong></h4>
<p>The <strong><code>connect_wifi</code></strong> function manages the connection to the Wi-Fi network:</p>
<ul>
<li><p>Activates the WLAN interface.</p></li>
<li><p>Connects to the specified Wi-Fi network using the provided SSID and password.</p></li>
<li><p>Continuously checks the connection status and prints the IP configuration once connected.</p></li>
</ul>
</section>
<section id="sensor-control-functions" class="level4">
<h4 class="anchored" data-anchor-id="sensor-control-functions"><strong>Sensor Control Functions</strong></h4>
<p>Two functions manage the power state of the DHT11 sensor:</p>
<ul>
<li><p><strong><code>disable_sensors</code></strong> sets the power pin low to turn off the sensor.</p></li>
<li><p><strong><code>enable_sensors</code></strong> sets the power pin high and waits for the sensor to stabilize.</p></li>
</ul>
</section>
<section id="system-status-function" class="level4">
<h4 class="anchored" data-anchor-id="system-status-function"><strong>System Status Function</strong></h4>
<p>The <strong><code>get_system_status</code></strong> function provides insights into the system’s memory usage and CPU frequency:</p>
<ul>
<li><p>Calculates the total and free heap memory.</p></li>
<li><p>Prints the memory statistics and CPU frequency.</p></li>
</ul>
</section>
<section id="time-synchronization" class="level4">
<h4 class="anchored" data-anchor-id="time-synchronization"><strong>Time Synchronization</strong></h4>
<p>The <strong><code>get_time_chicago</code></strong> function synchronizes the ESP32’s clock with an NTP server:</p>
<ul>
<li><p>Attempts to set the time using NTP up to a maximum number of retries.</p></li>
<li><p>Adjusts the time based on whether daylight saving time (DST) is in effect for the Chicago timezone.</p></li>
</ul>
</section>
<section id="reading-sensor-data" class="level4">
<h4 class="anchored" data-anchor-id="reading-sensor-data"><strong>Reading Sensor Data</strong></h4>
<p>The <strong><code>read_sensor</code></strong> function reads temperature and humidity data from the DHT11 sensor:</p>
<ul>
<li><p>Measures the temperature and humidity.</p></li>
<li><p>Returns the values or <strong><code>None</code></strong> if the reading fails.</p></li>
</ul>
</section>
<section id="sending-data-to-google-sheets" class="level4">
<h4 class="anchored" data-anchor-id="sending-data-to-google-sheets"><strong>Sending Data to Google Sheets</strong></h4>
<p>The <strong><code>send_data_to_google_sheets</code></strong> function sends sensor data to Google Sheets:</p>
<ul>
<li><p>Constructs the data payload and URL-encodes it.</p></li>
<li><p>Sends the data using an HTTP POST request.</p></li>
<li><p>Handles errors during the data sending process.</p></li>
</ul>
</section>
<section id="sending-data-to-thingspeak" class="level4">
<h4 class="anchored" data-anchor-id="sending-data-to-thingspeak"><strong>Sending Data to ThingSpeak</strong></h4>
<p>The <strong><code>send_data_to_thingspeak</code></strong> function sends data to ThingSpeak:</p>
<ul>
<li><p>Supports both single data point updates and bulk updates.</p></li>
<li><p>Constructs the payload and sends it using an HTTP POST request.</p></li>
<li><p>Handles errors and clears the buffer after successful updates.</p></li>
</ul>
</section>
<section id="sending-data-to-mongodb-via-vercel-api" class="level4">
<h4 class="anchored" data-anchor-id="sending-data-to-mongodb-via-vercel-api"><strong>Sending Data to MongoDB via Vercel API</strong></h4>
<p>The <strong><code>send_data_to_mongodb</code></strong> function sends data to a MongoDB instance via a Vercel API:</p>
<ul>
<li><p>Converts the data buffer to JSON.</p></li>
<li><p>Sends the data using an HTTP POST request.</p></li>
<li><p>Handles errors and clears the buffer after successful updates.</p></li>
</ul>
</section>
<section id="sending-data-to-vercel-api" class="level4">
<h4 class="anchored" data-anchor-id="sending-data-to-vercel-api"><strong>Sending Data to Vercel API</strong></h4>
<p>The <strong><code>send_data_to_vercel</code></strong> function sends data to a Vercel API endpoint:</p>
<ul>
<li><p>Converts the data buffer to JSON.</p></li>
<li><p>Sends the data using an HTTP POST request.</p></li>
<li><p>Handles errors during the data sending process(NO BUFFER DUE TO MEMORY LIMITATIONS AND VERCEL LIMITS).</p></li>
</ul>
</section>
<section id="main-function" class="level4">
<h4 class="anchored" data-anchor-id="main-function"><strong>Main Function</strong></h4>
<p>The <strong><code>main</code></strong> function orchestrates the entire process:</p>
<ul>
<li><p>Initializes the sensor and connects to Wi-Fi.</p></li>
<li><p>Enters an infinite loop where it periodically reads sensor data, stores it in buffers, and sends it to the configured services.</p></li>
<li><p>Controls the LED to indicate the status of operations.</p></li>
<li><p>Manages the timing of data sending to ensure that each service receives data at the specified intervals.</p></li>
<li><p>Logs system status and handles errors in the main loop.</p></li>
<li><p>Upon encountering an error, most likely memory related, begins the loop again.</p></li>
</ul>
</section></details>
<p>Test the code and verify that your circuit is functioning correctly. After that, configure Vercel or another API endpoint and Google App Script. Configuration details for Vercel can be found at: <a href="https://jesse-anderson.github.io/Blog/_site/posts/Pi-Sensor-Proj-May-2024/" class="uri">https://jesse-anderson.github.io/Blog/_site/posts/Pi-Sensor-Proj-May-2024/</a>, so I’ll skip that part. Create the JavaScript file(<code>sensorMongoDB.js</code>) below and place it in your /api folder. Ensure all changes are pushed to GitHub.</p>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb6"><pre class="sourceCode numberSource javascript number-lines code-with-copy"><code class="sourceCode javascript"><span id="cb6-1"><a href="#cb6-1"></a><span class="kw">const</span> { MongoClient } <span class="op">=</span> <span class="pp">require</span>(<span class="st">'mongodb'</span>)<span class="op">;</span></span>
<span id="cb6-2"><a href="#cb6-2"></a></span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="kw">const</span> API_KEY <span class="op">=</span> <span class="bu">process</span><span class="op">.</span><span class="at">env</span><span class="op">.</span><span class="at">API_KEY</span><span class="op">;</span> <span class="co">// Retrieve the API key from environment variables</span></span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="kw">const</span> MONGO_URI <span class="op">=</span> <span class="bu">process</span><span class="op">.</span><span class="at">env</span><span class="op">.</span><span class="at">MONGODB_URI</span><span class="op">;</span> <span class="co">// MongoDB connection string from environment variables</span></span>
<span id="cb6-5"><a href="#cb6-5"></a></span>
<span id="cb6-6"><a href="#cb6-6"></a><span class="kw">const</span> MONGODB_DB_NAME <span class="op">=</span> <span class="st">'Raspberry_Pi'</span><span class="op">;</span> <span class="co">// Database name</span></span>
<span id="cb6-7"><a href="#cb6-7"></a><span class="kw">const</span> MONGODB_COLLECTION_NAME <span class="op">=</span> <span class="st">'Readings'</span><span class="op">;</span> <span class="co">// Collection name</span></span>
<span id="cb6-8"><a href="#cb6-8"></a></span>
<span id="cb6-9"><a href="#cb6-9"></a><span class="kw">let</span> client<span class="op">;</span></span>
<span id="cb6-10"><a href="#cb6-10"></a></span>
<span id="cb6-11"><a href="#cb6-11"></a><span class="kw">const</span> connectToMongo <span class="op">=</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb6-12"><a href="#cb6-12"></a>    <span class="cf">if</span> (<span class="op">!</span>client) {</span>
<span id="cb6-13"><a href="#cb6-13"></a>        client <span class="op">=</span> <span class="kw">new</span> <span class="fu">MongoClient</span>(MONGO_URI<span class="op">,</span> {</span>
<span id="cb6-14"><a href="#cb6-14"></a>            <span class="dt">useNewUrlParser</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb6-15"><a href="#cb6-15"></a>            <span class="dt">useUnifiedTopology</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb6-16"><a href="#cb6-16"></a>        })<span class="op">;</span></span>
<span id="cb6-17"><a href="#cb6-17"></a>        <span class="cf">await</span> client<span class="op">.</span><span class="fu">connect</span>()<span class="op">;</span></span>
<span id="cb6-18"><a href="#cb6-18"></a>    }</span>
<span id="cb6-19"><a href="#cb6-19"></a>    <span class="cf">return</span> client<span class="op">.</span><span class="fu">db</span>(MONGODB_DB_NAME)<span class="op">;</span></span>
<span id="cb6-20"><a href="#cb6-20"></a>}<span class="op">;</span></span>
<span id="cb6-21"><a href="#cb6-21"></a></span>
<span id="cb6-22"><a href="#cb6-22"></a><span class="kw">const</span> handleSensorData <span class="op">=</span> <span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> {</span>
<span id="cb6-23"><a href="#cb6-23"></a>    <span class="cf">if</span> (req<span class="op">.</span><span class="at">method</span> <span class="op">!==</span> <span class="st">'POST'</span>) {</span>
<span id="cb6-24"><a href="#cb6-24"></a>        <span class="cf">return</span> res<span class="op">.</span><span class="fu">status</span>(<span class="dv">405</span>)<span class="op">.</span><span class="fu">json</span>({ <span class="dt">error</span><span class="op">:</span> <span class="st">'Method not allowed'</span> })<span class="op">;</span></span>
<span id="cb6-25"><a href="#cb6-25"></a>    }</span>
<span id="cb6-26"><a href="#cb6-26"></a></span>
<span id="cb6-27"><a href="#cb6-27"></a>    <span class="cf">try</span> {</span>
<span id="cb6-28"><a href="#cb6-28"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">'Request received'</span>)<span class="op">;</span>  <span class="co">// For debugging purposes</span></span>
<span id="cb6-29"><a href="#cb6-29"></a></span>
<span id="cb6-30"><a href="#cb6-30"></a>        <span class="co">// Extract API key from request headers</span></span>
<span id="cb6-31"><a href="#cb6-31"></a>        <span class="kw">const</span> providedApiKey <span class="op">=</span> req<span class="op">.</span><span class="at">headers</span>[<span class="st">'x-api-key'</span>]<span class="op">;</span></span>
<span id="cb6-32"><a href="#cb6-32"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">'Provided API Key:'</span><span class="op">,</span> providedApiKey)<span class="op">;</span>  <span class="co">// For debugging purposes</span></span>
<span id="cb6-33"><a href="#cb6-33"></a></span>
<span id="cb6-34"><a href="#cb6-34"></a>        <span class="co">// Check if API key is provided and matches the expected API key</span></span>
<span id="cb6-35"><a href="#cb6-35"></a>        <span class="cf">if</span> (<span class="op">!</span>providedApiKey <span class="op">||</span> providedApiKey <span class="op">!==</span> API_KEY) {</span>
<span id="cb6-36"><a href="#cb6-36"></a>            <span class="cf">return</span> res<span class="op">.</span><span class="fu">status</span>(<span class="dv">401</span>)<span class="op">.</span><span class="fu">json</span>({ <span class="dt">error</span><span class="op">:</span> <span class="st">'Unauthorized'</span> })<span class="op">;</span></span>
<span id="cb6-37"><a href="#cb6-37"></a>        }</span>
<span id="cb6-38"><a href="#cb6-38"></a></span>
<span id="cb6-39"><a href="#cb6-39"></a>        <span class="co">// Extract data from request body</span></span>
<span id="cb6-40"><a href="#cb6-40"></a>        <span class="kw">const</span> data <span class="op">=</span> req<span class="op">.</span><span class="at">body</span><span class="op">;</span></span>
<span id="cb6-41"><a href="#cb6-41"></a></span>
<span id="cb6-42"><a href="#cb6-42"></a>        <span class="co">// Log the data received to console for verification</span></span>
<span id="cb6-43"><a href="#cb6-43"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">'Received data:'</span><span class="op">,</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(data<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></span>
<span id="cb6-44"><a href="#cb6-44"></a></span>
<span id="cb6-45"><a href="#cb6-45"></a>        <span class="kw">const</span> db <span class="op">=</span> <span class="cf">await</span> <span class="fu">connectToMongo</span>()<span class="op">;</span></span>
<span id="cb6-46"><a href="#cb6-46"></a>        <span class="kw">const</span> collection <span class="op">=</span> db<span class="op">.</span><span class="fu">collection</span>(MONGODB_COLLECTION_NAME)<span class="op">;</span></span>
<span id="cb6-47"><a href="#cb6-47"></a></span>
<span id="cb6-48"><a href="#cb6-48"></a>        <span class="kw">let</span> result<span class="op">;</span></span>
<span id="cb6-49"><a href="#cb6-49"></a></span>
<span id="cb6-50"><a href="#cb6-50"></a>        <span class="cf">if</span> (<span class="bu">Array</span><span class="op">.</span><span class="fu">isArray</span>(data)) {</span>
<span id="cb6-51"><a href="#cb6-51"></a>            <span class="co">// Insert multiple readings</span></span>
<span id="cb6-52"><a href="#cb6-52"></a>            result <span class="op">=</span> <span class="cf">await</span> collection<span class="op">.</span><span class="fu">insertMany</span>(data<span class="op">.</span><span class="fu">map</span>(entry <span class="kw">=&gt;</span> ({</span>
<span id="cb6-53"><a href="#cb6-53"></a>                <span class="op">...</span>entry<span class="op">,</span></span>
<span id="cb6-54"><a href="#cb6-54"></a>                <span class="dt">temperatureCelsius</span><span class="op">:</span> entry<span class="op">.</span><span class="at">temperatureCelsius</span> <span class="op">!==</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> entry<span class="op">.</span><span class="at">temperatureCelsius</span> <span class="op">!==</span> <span class="kw">undefined</span> <span class="op">?</span> entry<span class="op">.</span><span class="at">temperatureCelsius</span> <span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb6-55"><a href="#cb6-55"></a>                <span class="dt">temperatureFahrenheit</span><span class="op">:</span> entry<span class="op">.</span><span class="at">temperatureFahrenheit</span> <span class="op">!==</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> entry<span class="op">.</span><span class="at">temperatureFahrenheit</span> <span class="op">!==</span> <span class="kw">undefined</span> <span class="op">?</span> entry<span class="op">.</span><span class="at">temperatureFahrenheit</span> <span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb6-56"><a href="#cb6-56"></a>                <span class="dt">humidityPercent</span><span class="op">:</span> entry<span class="op">.</span><span class="at">humidityPercent</span> <span class="op">!==</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> entry<span class="op">.</span><span class="at">humidityPercent</span> <span class="op">!==</span> <span class="kw">undefined</span> <span class="op">?</span> entry<span class="op">.</span><span class="at">humidityPercent</span> <span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb6-57"><a href="#cb6-57"></a>                <span class="dt">date</span><span class="op">:</span> entry<span class="op">.</span><span class="at">date</span> <span class="op">!==</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> entry<span class="op">.</span><span class="at">date</span> <span class="op">!==</span> <span class="kw">undefined</span> <span class="op">?</span> entry<span class="op">.</span><span class="at">date</span> <span class="op">:</span> <span class="kw">new</span> <span class="bu">Date</span>()<span class="op">.</span><span class="fu">toISOString</span>()<span class="op">.</span><span class="fu">split</span>(<span class="st">'T'</span>)[<span class="dv">0</span>]<span class="op">,</span></span>
<span id="cb6-58"><a href="#cb6-58"></a>                <span class="dt">time</span><span class="op">:</span> entry<span class="op">.</span><span class="at">time</span> <span class="op">!==</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> entry<span class="op">.</span><span class="at">time</span> <span class="op">!==</span> <span class="kw">undefined</span> <span class="op">?</span> entry<span class="op">.</span><span class="at">time</span> <span class="op">:</span> <span class="kw">new</span> <span class="bu">Date</span>()<span class="op">.</span><span class="fu">toISOString</span>()<span class="op">.</span><span class="fu">split</span>(<span class="st">'T'</span>)[<span class="dv">1</span>]<span class="op">.</span><span class="fu">split</span>(<span class="st">'.'</span>)[<span class="dv">0</span>]</span>
<span id="cb6-59"><a href="#cb6-59"></a>            })))<span class="op">;</span></span>
<span id="cb6-60"><a href="#cb6-60"></a>        } <span class="cf">else</span> {</span>
<span id="cb6-61"><a href="#cb6-61"></a>            <span class="co">// Insert a single reading</span></span>
<span id="cb6-62"><a href="#cb6-62"></a>            result <span class="op">=</span> <span class="cf">await</span> collection<span class="op">.</span><span class="fu">insertOne</span>({</span>
<span id="cb6-63"><a href="#cb6-63"></a>                <span class="dt">temperatureCelsius</span><span class="op">:</span> data<span class="op">.</span><span class="at">temperatureCelsius</span> <span class="op">!==</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> data<span class="op">.</span><span class="at">temperatureCelsius</span> <span class="op">!==</span> <span class="kw">undefined</span> <span class="op">?</span> data<span class="op">.</span><span class="at">temperatureCelsius</span> <span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb6-64"><a href="#cb6-64"></a>                <span class="dt">temperatureFahrenheit</span><span class="op">:</span> data<span class="op">.</span><span class="at">temperatureFahrenheit</span> <span class="op">!==</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> data<span class="op">.</span><span class="at">temperatureFahrenheit</span> <span class="op">!==</span> <span class="kw">undefined</span> <span class="op">?</span> data<span class="op">.</span><span class="at">temperatureFahrenheit</span> <span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb6-65"><a href="#cb6-65"></a>                <span class="dt">humidityPercent</span><span class="op">:</span> data<span class="op">.</span><span class="at">humidityPercent</span> <span class="op">!==</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> data<span class="op">.</span><span class="at">humidityPercent</span> <span class="op">!==</span> <span class="kw">undefined</span> <span class="op">?</span> data<span class="op">.</span><span class="at">humidityPercent</span> <span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb6-66"><a href="#cb6-66"></a>                <span class="dt">date</span><span class="op">:</span> data<span class="op">.</span><span class="at">date</span> <span class="op">!==</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> data<span class="op">.</span><span class="at">date</span> <span class="op">!==</span> <span class="kw">undefined</span> <span class="op">?</span> data<span class="op">.</span><span class="at">date</span> <span class="op">:</span> <span class="kw">new</span> <span class="bu">Date</span>()<span class="op">.</span><span class="fu">toISOString</span>()<span class="op">.</span><span class="fu">split</span>(<span class="st">'T'</span>)[<span class="dv">0</span>]<span class="op">,</span></span>
<span id="cb6-67"><a href="#cb6-67"></a>                <span class="dt">time</span><span class="op">:</span> data<span class="op">.</span><span class="at">time</span> <span class="op">!==</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> data<span class="op">.</span><span class="at">time</span> <span class="op">!==</span> <span class="kw">undefined</span> <span class="op">?</span> data<span class="op">.</span><span class="at">time</span> <span class="op">:</span> <span class="kw">new</span> <span class="bu">Date</span>()<span class="op">.</span><span class="fu">toISOString</span>()<span class="op">.</span><span class="fu">split</span>(<span class="st">'T'</span>)[<span class="dv">1</span>]<span class="op">.</span><span class="fu">split</span>(<span class="st">'.'</span>)[<span class="dv">0</span>]</span>
<span id="cb6-68"><a href="#cb6-68"></a>            })<span class="op">;</span></span>
<span id="cb6-69"><a href="#cb6-69"></a>        }</span>
<span id="cb6-70"><a href="#cb6-70"></a></span>
<span id="cb6-71"><a href="#cb6-71"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">'Data stored in MongoDB:'</span><span class="op">,</span> result)<span class="op">;</span></span>
<span id="cb6-72"><a href="#cb6-72"></a></span>
<span id="cb6-73"><a href="#cb6-73"></a>        <span class="co">// Send a successful response back to the client</span></span>
<span id="cb6-74"><a href="#cb6-74"></a>        res<span class="op">.</span><span class="fu">status</span>(<span class="dv">200</span>)<span class="op">.</span><span class="fu">json</span>({ <span class="dt">message</span><span class="op">:</span> <span class="st">'Data received and stored successfully!'</span><span class="op">,</span> <span class="dt">data</span><span class="op">:</span> result })<span class="op">;</span></span>
<span id="cb6-75"><a href="#cb6-75"></a>    } <span class="cf">catch</span> (e) {</span>
<span id="cb6-76"><a href="#cb6-76"></a>        <span class="co">// Handle errors and send an error response</span></span>
<span id="cb6-77"><a href="#cb6-77"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">"Error connecting to MongoDB or inserting data:"</span><span class="op">,</span> e)<span class="op">;</span></span>
<span id="cb6-78"><a href="#cb6-78"></a>        res<span class="op">.</span><span class="fu">status</span>(<span class="dv">500</span>)<span class="op">.</span><span class="fu">json</span>({ <span class="dt">error</span><span class="op">:</span> <span class="st">'Failed to connect to database or insert data'</span><span class="op">,</span> <span class="dt">details</span><span class="op">:</span> e<span class="op">.</span><span class="at">message</span> })<span class="op">;</span></span>
<span id="cb6-79"><a href="#cb6-79"></a>    }</span>
<span id="cb6-80"><a href="#cb6-80"></a>}<span class="op">;</span></span>
<span id="cb6-81"><a href="#cb6-81"></a></span>
<span id="cb6-82"><a href="#cb6-82"></a><span class="co">// Export the function for Vercel</span></span>
<span id="cb6-83"><a href="#cb6-83"></a>module<span class="op">.</span><span class="at">exports</span> <span class="op">=</span> handleSensorData<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p>I’ll omit breaking down the code as it is similar enough to the code described in the earlier post.</p>
</section>
</section>
<section id="setting-up-google-apps-script" class="level3">
<h3 class="anchored" data-anchor-id="setting-up-google-apps-script">Setting up Google Apps Script</h3>
<p>To set up Google Apps Script, create a new project in Google App Script. Generate a new Google Sheet named ‘ESP32’ or a name of your choice. Populate the first row with “Date | Time | Humidity % | Temp F | Temp C.” Then, go to Extensions -&gt; Apps Script and create a new script. Enter the code below and run the setup function by selecting it and clicking the play button.</p>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb7"><pre class="sourceCode numberSource javascript number-lines code-with-copy"><code class="sourceCode javascript"><span id="cb7-1"><a href="#cb7-1"></a><span class="co">// 1. Enter sheet name where data is to be written below</span></span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="kw">var</span> SHEET_NAME <span class="op">=</span> <span class="st">"Sheet1"</span><span class="op">;</span></span>
<span id="cb7-3"><a href="#cb7-3"></a></span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="kw">var</span> SCRIPT_PROP <span class="op">=</span> PropertiesService<span class="op">.</span><span class="fu">getScriptProperties</span>()<span class="op">;</span> <span class="co">// new property service</span></span>
<span id="cb7-5"><a href="#cb7-5"></a></span>
<span id="cb7-6"><a href="#cb7-6"></a><span class="kw">function</span> <span class="fu">doGet</span>(e) {</span>
<span id="cb7-7"><a href="#cb7-7"></a>  <span class="cf">return</span> <span class="fu">handleResponse</span>(e)<span class="op">;</span></span>
<span id="cb7-8"><a href="#cb7-8"></a>}</span>
<span id="cb7-9"><a href="#cb7-9"></a></span>
<span id="cb7-10"><a href="#cb7-10"></a><span class="kw">function</span> <span class="fu">doPost</span>(e) {</span>
<span id="cb7-11"><a href="#cb7-11"></a>  <span class="cf">return</span> <span class="fu">handleResponse</span>(e)<span class="op">;</span></span>
<span id="cb7-12"><a href="#cb7-12"></a>}</span>
<span id="cb7-13"><a href="#cb7-13"></a></span>
<span id="cb7-14"><a href="#cb7-14"></a><span class="kw">function</span> <span class="fu">handleResponse</span>(e) {</span>
<span id="cb7-15"><a href="#cb7-15"></a>  Logger<span class="op">.</span><span class="fu">log</span>(<span class="st">"Request received: "</span> <span class="op">+</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(e<span class="op">.</span><span class="at">parameter</span>))<span class="op">;</span></span>
<span id="cb7-16"><a href="#cb7-16"></a>  </span>
<span id="cb7-17"><a href="#cb7-17"></a>  <span class="kw">var</span> lock <span class="op">=</span> LockService<span class="op">.</span><span class="fu">getPublicLock</span>()<span class="op">;</span></span>
<span id="cb7-18"><a href="#cb7-18"></a>  lock<span class="op">.</span><span class="fu">waitLock</span>(<span class="dv">500</span>)<span class="op">;</span>  <span class="co">// wait 0.5 seconds before conceding defeat. Try 30 with more complicated </span></span>
<span id="cb7-19"><a href="#cb7-19"></a>  <span class="co">//We are essentially trying to prevent a race condition in which we have concurrent writes to the same spreadsheet. For this simple 1 python post to 1 spreadsheet this is essentially a non issue. Set to higher values if developing more complex nonsense.</span></span>
<span id="cb7-20"><a href="#cb7-20"></a>  <span class="cf">try</span> {</span>
<span id="cb7-21"><a href="#cb7-21"></a>    <span class="kw">var</span> docId <span class="op">=</span> SCRIPT_PROP<span class="op">.</span><span class="fu">getProperty</span>(<span class="st">"key"</span>)<span class="op">;</span></span>
<span id="cb7-22"><a href="#cb7-22"></a>    Logger<span class="op">.</span><span class="fu">log</span>(<span class="st">"Using document ID: "</span> <span class="op">+</span> docId)<span class="op">;</span></span>
<span id="cb7-23"><a href="#cb7-23"></a>    <span class="kw">var</span> doc <span class="op">=</span> SpreadsheetApp<span class="op">.</span><span class="fu">openById</span>(docId)<span class="op">;</span></span>
<span id="cb7-24"><a href="#cb7-24"></a>    <span class="kw">var</span> sheet <span class="op">=</span> doc<span class="op">.</span><span class="fu">getSheetByName</span>(SHEET_NAME)<span class="op">;</span></span>
<span id="cb7-25"><a href="#cb7-25"></a></span>
<span id="cb7-26"><a href="#cb7-26"></a>    <span class="kw">var</span> headRow <span class="op">=</span> e<span class="op">.</span><span class="at">parameter</span><span class="op">.</span><span class="at">header_row</span> <span class="op">||</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb7-27"><a href="#cb7-27"></a>    <span class="kw">var</span> headers <span class="op">=</span> sheet<span class="op">.</span><span class="fu">getRange</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> sheet<span class="op">.</span><span class="fu">getLastColumn</span>())<span class="op">.</span><span class="fu">getValues</span>()[<span class="dv">0</span>]<span class="op">;</span></span>
<span id="cb7-28"><a href="#cb7-28"></a>    <span class="kw">var</span> nextRow <span class="op">=</span> sheet<span class="op">.</span><span class="fu">getLastRow</span>() <span class="op">+</span> <span class="dv">1</span><span class="op">;</span> <span class="co">// get next row</span></span>
<span id="cb7-29"><a href="#cb7-29"></a>    <span class="kw">var</span> row <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb7-30"><a href="#cb7-30"></a>    </span>
<span id="cb7-31"><a href="#cb7-31"></a>    <span class="cf">for</span> (<span class="kw">var</span> i <span class="kw">in</span> headers) {</span>
<span id="cb7-32"><a href="#cb7-32"></a>      <span class="cf">if</span> (headers[i] <span class="op">==</span> <span class="st">"Timestamp"</span>) {</span>
<span id="cb7-33"><a href="#cb7-33"></a>        row<span class="op">.</span><span class="fu">push</span>(<span class="kw">new</span> <span class="bu">Date</span>())<span class="op">;</span></span>
<span id="cb7-34"><a href="#cb7-34"></a>      } <span class="cf">else</span> {</span>
<span id="cb7-35"><a href="#cb7-35"></a>        row<span class="op">.</span><span class="fu">push</span>(e<span class="op">.</span><span class="at">parameter</span>[headers[i]])<span class="op">;</span></span>
<span id="cb7-36"><a href="#cb7-36"></a>      }</span>
<span id="cb7-37"><a href="#cb7-37"></a>    }</span>
<span id="cb7-38"><a href="#cb7-38"></a>    </span>
<span id="cb7-39"><a href="#cb7-39"></a>    sheet<span class="op">.</span><span class="fu">getRange</span>(nextRow<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> row<span class="op">.</span><span class="at">length</span>)<span class="op">.</span><span class="fu">setValues</span>([row])<span class="op">;</span></span>
<span id="cb7-40"><a href="#cb7-40"></a>    </span>
<span id="cb7-41"><a href="#cb7-41"></a>    <span class="kw">var</span> output <span class="op">=</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({<span class="st">"result"</span><span class="op">:</span> <span class="st">"success"</span><span class="op">,</span> <span class="st">"row"</span><span class="op">:</span> nextRow})<span class="op">;</span></span>
<span id="cb7-42"><a href="#cb7-42"></a>    Logger<span class="op">.</span><span class="fu">log</span>(<span class="st">"Data written to row: "</span> <span class="op">+</span> nextRow)<span class="op">;</span></span>
<span id="cb7-43"><a href="#cb7-43"></a>    </span>
<span id="cb7-44"><a href="#cb7-44"></a>    <span class="cf">if</span> (e<span class="op">.</span><span class="at">parameter</span><span class="op">.</span><span class="at">callback</span>) {</span>
<span id="cb7-45"><a href="#cb7-45"></a>      <span class="cf">return</span> ContentService<span class="op">.</span><span class="fu">createTextOutput</span>(e<span class="op">.</span><span class="at">parameter</span><span class="op">.</span><span class="at">callback</span> <span class="op">+</span> <span class="st">"("</span> <span class="op">+</span> output <span class="op">+</span> <span class="st">");"</span>)</span>
<span id="cb7-46"><a href="#cb7-46"></a>                           <span class="op">.</span><span class="fu">setMimeType</span>(ContentService<span class="op">.</span><span class="at">MimeType</span><span class="op">.</span><span class="at">JAVASCRIPT</span>)<span class="op">;</span></span>
<span id="cb7-47"><a href="#cb7-47"></a>    } <span class="cf">else</span> {</span>
<span id="cb7-48"><a href="#cb7-48"></a>      <span class="cf">return</span> ContentService<span class="op">.</span><span class="fu">createTextOutput</span>(output)</span>
<span id="cb7-49"><a href="#cb7-49"></a>                           <span class="op">.</span><span class="fu">setMimeType</span>(ContentService<span class="op">.</span><span class="at">MimeType</span><span class="op">.</span><span class="at">JSON</span>)<span class="op">;</span></span>
<span id="cb7-50"><a href="#cb7-50"></a>    }</span>
<span id="cb7-51"><a href="#cb7-51"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb7-52"><a href="#cb7-52"></a>    Logger<span class="op">.</span><span class="fu">log</span>(<span class="st">"Error: "</span> <span class="op">+</span> error<span class="op">.</span><span class="fu">toString</span>())<span class="op">;</span></span>
<span id="cb7-53"><a href="#cb7-53"></a>    <span class="kw">var</span> output <span class="op">=</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({<span class="st">"result"</span><span class="op">:</span> <span class="st">"error"</span><span class="op">,</span> <span class="st">"error"</span><span class="op">:</span> error<span class="op">.</span><span class="fu">toString</span>()})<span class="op">;</span></span>
<span id="cb7-54"><a href="#cb7-54"></a>    <span class="cf">if</span> (e<span class="op">.</span><span class="at">parameter</span><span class="op">.</span><span class="at">callback</span>) {</span>
<span id="cb7-55"><a href="#cb7-55"></a>      <span class="cf">return</span> ContentService<span class="op">.</span><span class="fu">createTextOutput</span>(e<span class="op">.</span><span class="at">parameter</span><span class="op">.</span><span class="at">callback</span> <span class="op">+</span> <span class="st">"("</span> <span class="op">+</span> output <span class="op">+</span> <span class="st">");"</span>)</span>
<span id="cb7-56"><a href="#cb7-56"></a>                           <span class="op">.</span><span class="fu">setMimeType</span>(ContentService<span class="op">.</span><span class="at">MimeType</span><span class="op">.</span><span class="at">JAVASCRIPT</span>)<span class="op">;</span></span>
<span id="cb7-57"><a href="#cb7-57"></a>    } <span class="cf">else</span> {</span>
<span id="cb7-58"><a href="#cb7-58"></a>      <span class="cf">return</span> ContentService<span class="op">.</span><span class="fu">createTextOutput</span>(output)</span>
<span id="cb7-59"><a href="#cb7-59"></a>                           <span class="op">.</span><span class="fu">setMimeType</span>(ContentService<span class="op">.</span><span class="at">MimeType</span><span class="op">.</span><span class="at">JSON</span>)<span class="op">;</span></span>
<span id="cb7-60"><a href="#cb7-60"></a>    }</span>
<span id="cb7-61"><a href="#cb7-61"></a>  } <span class="cf">finally</span> {</span>
<span id="cb7-62"><a href="#cb7-62"></a>    lock<span class="op">.</span><span class="fu">releaseLock</span>()<span class="op">;</span></span>
<span id="cb7-63"><a href="#cb7-63"></a>  }</span>
<span id="cb7-64"><a href="#cb7-64"></a>}</span>
<span id="cb7-65"><a href="#cb7-65"></a></span>
<span id="cb7-66"><a href="#cb7-66"></a><span class="kw">function</span> <span class="fu">setup</span>() {</span>
<span id="cb7-67"><a href="#cb7-67"></a>  <span class="kw">var</span> doc <span class="op">=</span> SpreadsheetApp<span class="op">.</span><span class="fu">getActiveSpreadsheet</span>()<span class="op">;</span></span>
<span id="cb7-68"><a href="#cb7-68"></a>  SCRIPT_PROP<span class="op">.</span><span class="fu">setProperty</span>(<span class="st">"key"</span><span class="op">,</span> doc<span class="op">.</span><span class="fu">getId</span>())<span class="op">;</span></span>
<span id="cb7-69"><a href="#cb7-69"></a>  Logger<span class="op">.</span><span class="fu">log</span>(<span class="st">"Script property 'key' set to: "</span> <span class="op">+</span> doc<span class="op">.</span><span class="fu">getId</span>())<span class="op">;</span></span>
<span id="cb7-70"><a href="#cb7-70"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<details>
<summary>
Code Summary
</summary>
<section id="setting-up-sheet-name-and-script-properties" class="level4">
<h4 class="anchored" data-anchor-id="setting-up-sheet-name-and-script-properties"><strong>1. Setting Up Sheet Name and Script Properties</strong></h4>
<p>First, the script defines the name of the sheet where data will be written. It also initializes a property service to store script properties, which can be useful for managing script configurations and data across different executions.</p>
</section>
<section id="handling-http-requests" class="level4">
<h4 class="anchored" data-anchor-id="handling-http-requests"><strong>2. Handling HTTP Requests</strong></h4>
<p>The script includes functions to handle GET and POST requests. These functions delegate the request handling to a common function called <strong><code>handleResponse</code></strong>, which simplifies the code by centralizing the request processing logic.</p>
</section>
<section id="processing-incoming-requests" class="level4">
<h4 class="anchored" data-anchor-id="processing-incoming-requests"><strong>3. Processing Incoming Requests</strong></h4>
<p>The core of the script is the <strong><code>handleResponse</code></strong> function, which processes incoming HTTP requests. This function:</p>
<ul>
<li><p><strong>Logs the Request</strong>: It logs the received parameters for debugging purposes, providing visibility into the incoming data.</p></li>
<li><p><strong>Locks the Sheet</strong>: Uses a public lock to prevent race conditions, ensuring that only one instance of the script writes to the sheet at a time. This is crucial for avoiding data corruption when multiple requests are processed simultaneously.</p></li>
<li><p><strong>Accesses the Spreadsheet</strong>: Retrieves the Google Sheet document ID from script properties, opens the sheet, and selects the specified sheet by name.</p></li>
<li><p><strong>Prepares the Data Row</strong>: Reads the headers from the first row of the sheet and constructs a new row of data based on the incoming request parameters. If a header is “Timestamp”, it adds the current date and time.</p></li>
<li><p><strong>Writes Data to the Sheet</strong>: Writes the constructed row to the next available row in the sheet and logs the row number where data was written.</p></li>
<li><p><strong>Generates the Response</strong>: Constructs a JSON response indicating success and the row number. If a JSONP callback is specified, it formats the response accordingly.</p></li>
<li><p><strong>Handles Errors</strong>: Catches any errors that occur during the process, logs the error, and returns a JSON response indicating failure.</p></li>
<li><p><strong>Releases the Lock</strong>: Ensures that the lock is released at the end of the function, whether it completes successfully or encounters an error.</p></li>
</ul>
</section>
<section id="setting-up-the-script" class="level4">
<h4 class="anchored" data-anchor-id="setting-up-the-script"><strong>4. Setting Up the Script</strong></h4>
<p>A setup function is included to configure the script properties. It retrieves the active spreadsheet’s ID and stores it in the script properties, allowing the <strong><code>handleResponse</code></strong> function to access the correct document.</p>
</section></details>
<p>After running setup you will get a key in the Execution log:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode numberSource plaintext number-lines code-with-copy"><code class="sourceCode"><span id="cb8-1"><a href="#cb8-1"></a>Info</span>
<span id="cb8-2"><a href="#cb8-2"></a>Script property 'key' set to: 130pgZ23ixGPtasNlpytXfubkbNfdskflsdfgbsjkdbfgsj</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Make sure to check that this key matches your google sheet spreadsheet ID:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode numberSource plaintext number-lines code-with-copy"><code class="sourceCode"><span id="cb9-1"><a href="#cb9-1"></a>https://docs.google.com/spreadsheets/d/&lt;Your Spreadsheet ID&gt;/edit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Next, go to the top right corner of the screen, select New deployment, populate the description, choose “Execute As” “Me,” and set “Anyone” under “Who has access.” Deploy the project, and you will receive a Deployment ID and Web App URL. Copy the Web App URL, which you will use for sending data.</p>
<p>The web app URL should be of the following form:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode numberSource plaintext number-lines code-with-copy"><code class="sourceCode"><span id="cb10-1"><a href="#cb10-1"></a>https://script.google.com/macros/s/AKfycbzNi7_SbooXqXYjEfJdP233EaJ4EfsdgnjsdgdfskjgDF9/exec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>

<section id="running-the-program-with-data-logging" class="level3">
<h3 class="anchored" data-anchor-id="running-the-program-with-data-logging">Running the Program with Data Logging</h3>
<p>At this point, everything should be set up and ready for data logging. Run the program, and it should connect to Wi-Fi, enable the sensors, and start posting to your databases. Be aware that buffer sizes can cause errors, so I kept them small. One can increase the buffer size up to the point where you begin to get memory errors(the program will throw an exception and retry the data upload loop). Using an SD card for local logging is an option, but I haven’t tried it yet. It could involve logging locally, then using a local web server to push data as needed.</p>
</section>
<section id="flashing-the-program" class="level3">
<h3 class="anchored">Flashing the Program</h3>
<p>Next we put the ESP32 into download mode by holding boot and pressing reset and then saving the Thonny file to the ESP32 as main.py. After this test that your program is running by unplugging and plugging the ESP32 back in and listening to the COM4 port on Putty or observing the LED. Once you’ve verified this go back into Thonny and select File-&gt;Open-&gt;MicroPython device-&gt;boot.py. Simply type import main as a new line and the program should boot every time you are connected to power. Note that this is a nuclear option and generally main.py should run on power up. From here you should be able to move the board wherever you want within your home or even hand solder the connection points with something like this:</p>
<p><a href="https://www.amazon.com/Adafruit-Accessories-Perma-Proto-Full-Breadboard/dp/B00SK8KAMM" class="uri">https://www.amazon.com/Adafruit-Accessories-Perma-Proto-Full-Breadboard/dp/B00SK8KAMM</a></p>
<p>Use good wire and solder!</p>
<p>A general diagram of the flow for the ESP32 is below:</p>
<p><a href="images/ESP32 Sensor Flow.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6"><img src="images/ESP32 Sensor Flow.png" class="img-fluid"></a></p>
<p>We will make a few changes to the Google Apps Script so we can access the Sheet concurrently with the data logging:</p>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb11"><pre class="sourceCode numberSource javascript number-lines code-with-copy"><code class="sourceCode javascript"><span id="cb11-1"><a href="#cb11-1"></a><span class="co">// 1. Enter sheet name where data is to be written below</span></span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="kw">var</span> SHEET_NAME <span class="op">=</span> <span class="st">"Sheet1"</span><span class="op">;</span></span>
<span id="cb11-3"><a href="#cb11-3"></a></span>
<span id="cb11-4"><a href="#cb11-4"></a><span class="kw">var</span> SCRIPT_PROP <span class="op">=</span> PropertiesService<span class="op">.</span><span class="fu">getScriptProperties</span>()<span class="op">;</span> <span class="co">// new property service</span></span>
<span id="cb11-5"><a href="#cb11-5"></a></span>
<span id="cb11-6"><a href="#cb11-6"></a><span class="kw">function</span> <span class="fu">doGet</span>(e) {</span>
<span id="cb11-7"><a href="#cb11-7"></a>  Logger<span class="op">.</span><span class="fu">log</span>(<span class="st">"doGet called with parameters: "</span> <span class="op">+</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(e<span class="op">.</span><span class="at">parameter</span>))<span class="op">;</span></span>
<span id="cb11-8"><a href="#cb11-8"></a>  <span class="cf">if</span> (e<span class="op">.</span><span class="at">parameter</span><span class="op">.</span><span class="at">action</span> <span class="op">&amp;&amp;</span> e<span class="op">.</span><span class="at">parameter</span><span class="op">.</span><span class="at">action</span> <span class="op">===</span> <span class="st">'getLastRow'</span>) {</span>
<span id="cb11-9"><a href="#cb11-9"></a>    Logger<span class="op">.</span><span class="fu">log</span>(<span class="st">"Calling getLastRowData function"</span>)<span class="op">;</span></span>
<span id="cb11-10"><a href="#cb11-10"></a>    <span class="cf">return</span> <span class="fu">getLastRowData</span>()<span class="op">;</span></span>
<span id="cb11-11"><a href="#cb11-11"></a>  } <span class="cf">else</span> <span class="cf">if</span> (e<span class="op">.</span><span class="at">parameter</span><span class="op">.</span><span class="at">action</span> <span class="op">&amp;&amp;</span> e<span class="op">.</span><span class="at">parameter</span><span class="op">.</span><span class="at">action</span> <span class="op">===</span> <span class="st">'getLast6000Rows'</span>) {</span>
<span id="cb11-12"><a href="#cb11-12"></a>    Logger<span class="op">.</span><span class="fu">log</span>(<span class="st">"Calling getLast6000Rows function"</span>)<span class="op">;</span></span>
<span id="cb11-13"><a href="#cb11-13"></a>    <span class="cf">return</span> <span class="fu">getLast6000Rows</span>()<span class="op">;</span></span>
<span id="cb11-14"><a href="#cb11-14"></a>  } <span class="cf">else</span> {</span>
<span id="cb11-15"><a href="#cb11-15"></a>    Logger<span class="op">.</span><span class="fu">log</span>(<span class="st">"Invalid action or no action specified"</span>)<span class="op">;</span></span>
<span id="cb11-16"><a href="#cb11-16"></a>    <span class="cf">return</span> ContentService<span class="op">.</span><span class="fu">createTextOutput</span>(<span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({ <span class="dt">error</span><span class="op">:</span> <span class="st">"Invalid action or no action specified"</span> }))<span class="op">.</span><span class="fu">setMimeType</span>(ContentService<span class="op">.</span><span class="at">MimeType</span><span class="op">.</span><span class="at">JSON</span>)<span class="op">;</span></span>
<span id="cb11-17"><a href="#cb11-17"></a>  }</span>
<span id="cb11-18"><a href="#cb11-18"></a>}</span>
<span id="cb11-19"><a href="#cb11-19"></a></span>
<span id="cb11-20"><a href="#cb11-20"></a></span>
<span id="cb11-21"><a href="#cb11-21"></a><span class="kw">function</span> <span class="fu">doPost</span>(e) {</span>
<span id="cb11-22"><a href="#cb11-22"></a>  Logger<span class="op">.</span><span class="fu">log</span>(<span class="st">"doPost called with parameters: "</span> <span class="op">+</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(e<span class="op">.</span><span class="at">parameter</span>))<span class="op">;</span></span>
<span id="cb11-23"><a href="#cb11-23"></a>  <span class="cf">return</span> <span class="fu">handleResponse</span>(e)<span class="op">;</span></span>
<span id="cb11-24"><a href="#cb11-24"></a>}</span>
<span id="cb11-25"><a href="#cb11-25"></a></span>
<span id="cb11-26"><a href="#cb11-26"></a><span class="kw">function</span> <span class="fu">handleResponse</span>(e) {</span>
<span id="cb11-27"><a href="#cb11-27"></a>    <span class="kw">var</span> action <span class="op">=</span> e<span class="op">.</span><span class="at">parameter</span><span class="op">.</span><span class="at">action</span><span class="op">;</span></span>
<span id="cb11-28"><a href="#cb11-28"></a>    Logger<span class="op">.</span><span class="fu">log</span>(<span class="st">"handleResponse called with action: "</span> <span class="op">+</span> e<span class="op">.</span><span class="at">parameter</span>)<span class="op">;</span></span>
<span id="cb11-29"><a href="#cb11-29"></a></span>
<span id="cb11-30"><a href="#cb11-30"></a>    <span class="cf">if</span> (action <span class="op">===</span> <span class="st">'getLastRow'</span>) {</span>
<span id="cb11-31"><a href="#cb11-31"></a>        Logger<span class="op">.</span><span class="fu">log</span>(<span class="st">"Calling getLastRowData function"</span>)<span class="op">;</span></span>
<span id="cb11-32"><a href="#cb11-32"></a>        <span class="cf">return</span> <span class="fu">getLastRowData</span>()<span class="op">;</span></span>
<span id="cb11-33"><a href="#cb11-33"></a>    } <span class="cf">else</span> <span class="cf">if</span> (action <span class="op">===</span> <span class="st">'getLast6000Rows'</span>) {</span>
<span id="cb11-34"><a href="#cb11-34"></a>        Logger<span class="op">.</span><span class="fu">log</span>(<span class="st">"Calling getLast6000Rows function"</span>)<span class="op">;</span></span>
<span id="cb11-35"><a href="#cb11-35"></a>        <span class="cf">return</span> <span class="fu">getLast6000Rows</span>()<span class="op">;</span></span>
<span id="cb11-36"><a href="#cb11-36"></a>    } <span class="cf">else</span> {</span>
<span id="cb11-37"><a href="#cb11-37"></a>        <span class="cf">try</span> {</span>
<span id="cb11-38"><a href="#cb11-38"></a>            <span class="cf">return</span> <span class="fu">handleDataSubmission</span>(e)<span class="op">;</span></span>
<span id="cb11-39"><a href="#cb11-39"></a>        } <span class="cf">catch</span> (error) {</span>
<span id="cb11-40"><a href="#cb11-40"></a>            Logger<span class="op">.</span><span class="fu">log</span>(<span class="st">"Error in handleDataSubmission: "</span> <span class="op">+</span> error<span class="op">.</span><span class="at">message</span>)<span class="op">;</span></span>
<span id="cb11-41"><a href="#cb11-41"></a>            <span class="cf">return</span> ContentService<span class="op">.</span><span class="fu">createTextOutput</span>(<span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({ <span class="dt">error</span><span class="op">:</span> <span class="st">"Invalid action or no action specified"</span> }))<span class="op">.</span><span class="fu">setMimeType</span>(ContentService<span class="op">.</span><span class="at">MimeType</span><span class="op">.</span><span class="at">JSON</span>)<span class="op">;</span></span>
<span id="cb11-42"><a href="#cb11-42"></a>        }</span>
<span id="cb11-43"><a href="#cb11-43"></a>    }</span>
<span id="cb11-44"><a href="#cb11-44"></a>}</span>
<span id="cb11-45"><a href="#cb11-45"></a></span>
<span id="cb11-46"><a href="#cb11-46"></a><span class="kw">function</span> <span class="fu">handleDataSubmission</span>(e) {</span>
<span id="cb11-47"><a href="#cb11-47"></a>  Logger<span class="op">.</span><span class="fu">log</span>(<span class="st">"handleDataSubmission called with parameters: "</span> <span class="op">+</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(e<span class="op">.</span><span class="at">parameter</span>))<span class="op">;</span></span>
<span id="cb11-48"><a href="#cb11-48"></a>  </span>
<span id="cb11-49"><a href="#cb11-49"></a>  <span class="kw">var</span> lock <span class="op">=</span> LockService<span class="op">.</span><span class="fu">getPublicLock</span>()<span class="op">;</span></span>
<span id="cb11-50"><a href="#cb11-50"></a>  lock<span class="op">.</span><span class="fu">waitLock</span>(<span class="dv">500</span>)<span class="op">;</span>  <span class="co">// wait 0.5 seconds before conceding defeat. Try 30 with more complicated </span></span>
<span id="cb11-51"><a href="#cb11-51"></a>  <span class="co">//We are essentially trying to prevent a race condition in which we have concurrent writes to the same spreadsheet. For this simple 1 python post to 1 spreadsheet this is essentially a non issue. Set to higher values if developing more complex nonsense.</span></span>
<span id="cb11-52"><a href="#cb11-52"></a>  <span class="cf">try</span> {</span>
<span id="cb11-53"><a href="#cb11-53"></a>    <span class="kw">var</span> docId <span class="op">=</span> SCRIPT_PROP<span class="op">.</span><span class="fu">getProperty</span>(<span class="st">"key"</span>)<span class="op">;</span></span>
<span id="cb11-54"><a href="#cb11-54"></a>    Logger<span class="op">.</span><span class="fu">log</span>(<span class="st">"Using document ID: "</span> <span class="op">+</span> docId)<span class="op">;</span></span>
<span id="cb11-55"><a href="#cb11-55"></a>    <span class="kw">var</span> doc <span class="op">=</span> SpreadsheetApp<span class="op">.</span><span class="fu">openById</span>(docId)<span class="op">;</span></span>
<span id="cb11-56"><a href="#cb11-56"></a>    <span class="kw">var</span> sheet <span class="op">=</span> doc<span class="op">.</span><span class="fu">getSheetByName</span>(SHEET_NAME)<span class="op">;</span></span>
<span id="cb11-57"><a href="#cb11-57"></a></span>
<span id="cb11-58"><a href="#cb11-58"></a>    <span class="kw">var</span> headRow <span class="op">=</span> e<span class="op">.</span><span class="at">parameter</span><span class="op">.</span><span class="at">header_row</span> <span class="op">||</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb11-59"><a href="#cb11-59"></a>    <span class="kw">var</span> headers <span class="op">=</span> sheet<span class="op">.</span><span class="fu">getRange</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> sheet<span class="op">.</span><span class="fu">getLastColumn</span>())<span class="op">.</span><span class="fu">getValues</span>()[<span class="dv">0</span>]<span class="op">;</span></span>
<span id="cb11-60"><a href="#cb11-60"></a>    <span class="kw">var</span> nextRow <span class="op">=</span> sheet<span class="op">.</span><span class="fu">getLastRow</span>() <span class="op">+</span> <span class="dv">1</span><span class="op">;</span> <span class="co">// get next row</span></span>
<span id="cb11-61"><a href="#cb11-61"></a>    <span class="kw">var</span> row <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb11-62"><a href="#cb11-62"></a>    </span>
<span id="cb11-63"><a href="#cb11-63"></a>    <span class="cf">for</span> (<span class="kw">var</span> i <span class="kw">in</span> headers) {</span>
<span id="cb11-64"><a href="#cb11-64"></a>      <span class="cf">if</span> (headers[i] <span class="op">==</span> <span class="st">"Timestamp"</span>) {</span>
<span id="cb11-65"><a href="#cb11-65"></a>        row<span class="op">.</span><span class="fu">push</span>(<span class="kw">new</span> <span class="bu">Date</span>())<span class="op">;</span></span>
<span id="cb11-66"><a href="#cb11-66"></a>      } <span class="cf">else</span> {</span>
<span id="cb11-67"><a href="#cb11-67"></a>        row<span class="op">.</span><span class="fu">push</span>(e<span class="op">.</span><span class="at">parameter</span>[headers[i]])<span class="op">;</span></span>
<span id="cb11-68"><a href="#cb11-68"></a>      }</span>
<span id="cb11-69"><a href="#cb11-69"></a>    }</span>
<span id="cb11-70"><a href="#cb11-70"></a>    </span>
<span id="cb11-71"><a href="#cb11-71"></a>    sheet<span class="op">.</span><span class="fu">getRange</span>(nextRow<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> row<span class="op">.</span><span class="at">length</span>)<span class="op">.</span><span class="fu">setValues</span>([row])<span class="op">;</span></span>
<span id="cb11-72"><a href="#cb11-72"></a>    </span>
<span id="cb11-73"><a href="#cb11-73"></a>    <span class="kw">var</span> output <span class="op">=</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({<span class="st">"result"</span><span class="op">:</span> <span class="st">"success"</span><span class="op">,</span> <span class="st">"row"</span><span class="op">:</span> nextRow})<span class="op">;</span></span>
<span id="cb11-74"><a href="#cb11-74"></a>    Logger<span class="op">.</span><span class="fu">log</span>(<span class="st">"Data written to row: "</span> <span class="op">+</span> nextRow)<span class="op">;</span></span>
<span id="cb11-75"><a href="#cb11-75"></a>    </span>
<span id="cb11-76"><a href="#cb11-76"></a>    <span class="cf">if</span> (e<span class="op">.</span><span class="at">parameter</span><span class="op">.</span><span class="at">callback</span>) {</span>
<span id="cb11-77"><a href="#cb11-77"></a>      <span class="cf">return</span> ContentService<span class="op">.</span><span class="fu">createTextOutput</span>(e<span class="op">.</span><span class="at">parameter</span><span class="op">.</span><span class="at">callback</span> <span class="op">+</span> <span class="st">"("</span> <span class="op">+</span> output <span class="op">+</span> <span class="st">");"</span>)</span>
<span id="cb11-78"><a href="#cb11-78"></a>                           <span class="op">.</span><span class="fu">setMimeType</span>(ContentService<span class="op">.</span><span class="at">MimeType</span><span class="op">.</span><span class="at">JAVASCRIPT</span>)<span class="op">;</span></span>
<span id="cb11-79"><a href="#cb11-79"></a>    } <span class="cf">else</span> {</span>
<span id="cb11-80"><a href="#cb11-80"></a>      <span class="cf">return</span> ContentService<span class="op">.</span><span class="fu">createTextOutput</span>(output)</span>
<span id="cb11-81"><a href="#cb11-81"></a>                           <span class="op">.</span><span class="fu">setMimeType</span>(ContentService<span class="op">.</span><span class="at">MimeType</span><span class="op">.</span><span class="at">JSON</span>)<span class="op">;</span></span>
<span id="cb11-82"><a href="#cb11-82"></a>    }</span>
<span id="cb11-83"><a href="#cb11-83"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb11-84"><a href="#cb11-84"></a>    Logger<span class="op">.</span><span class="fu">log</span>(<span class="st">"Error: "</span> <span class="op">+</span> error<span class="op">.</span><span class="fu">toString</span>())<span class="op">;</span></span>
<span id="cb11-85"><a href="#cb11-85"></a>    <span class="kw">var</span> output <span class="op">=</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({<span class="st">"result"</span><span class="op">:</span> <span class="st">"error"</span><span class="op">,</span> <span class="st">"error"</span><span class="op">:</span> error<span class="op">.</span><span class="fu">toString</span>()})<span class="op">;</span></span>
<span id="cb11-86"><a href="#cb11-86"></a>    <span class="cf">if</span> (e<span class="op">.</span><span class="at">parameter</span><span class="op">.</span><span class="at">callback</span>) {</span>
<span id="cb11-87"><a href="#cb11-87"></a>      <span class="cf">return</span> ContentService<span class="op">.</span><span class="fu">createTextOutput</span>(e<span class="op">.</span><span class="at">parameter</span><span class="op">.</span><span class="at">callback</span> <span class="op">+</span> <span class="st">"("</span> <span class="op">+</span> output <span class="op">+</span> <span class="st">");"</span>)</span>
<span id="cb11-88"><a href="#cb11-88"></a>                           <span class="op">.</span><span class="fu">setMimeType</span>(ContentService<span class="op">.</span><span class="at">MimeType</span><span class="op">.</span><span class="at">JAVASCRIPT</span>)<span class="op">;</span></span>
<span id="cb11-89"><a href="#cb11-89"></a>    } <span class="cf">else</span> {</span>
<span id="cb11-90"><a href="#cb11-90"></a>      <span class="cf">return</span> ContentService<span class="op">.</span><span class="fu">createTextOutput</span>(output)</span>
<span id="cb11-91"><a href="#cb11-91"></a>                           <span class="op">.</span><span class="fu">setMimeType</span>(ContentService<span class="op">.</span><span class="at">MimeType</span><span class="op">.</span><span class="at">JSON</span>)<span class="op">;</span></span>
<span id="cb11-92"><a href="#cb11-92"></a>    }</span>
<span id="cb11-93"><a href="#cb11-93"></a>  } <span class="cf">finally</span> {</span>
<span id="cb11-94"><a href="#cb11-94"></a>    lock<span class="op">.</span><span class="fu">releaseLock</span>()<span class="op">;</span></span>
<span id="cb11-95"><a href="#cb11-95"></a>  }</span>
<span id="cb11-96"><a href="#cb11-96"></a>}</span>
<span id="cb11-97"><a href="#cb11-97"></a></span>
<span id="cb11-98"><a href="#cb11-98"></a><span class="kw">function</span> <span class="fu">setup</span>() {</span>
<span id="cb11-99"><a href="#cb11-99"></a>  <span class="kw">var</span> doc <span class="op">=</span> SpreadsheetApp<span class="op">.</span><span class="fu">getActiveSpreadsheet</span>()<span class="op">;</span></span>
<span id="cb11-100"><a href="#cb11-100"></a>  SCRIPT_PROP<span class="op">.</span><span class="fu">setProperty</span>(<span class="st">"key"</span><span class="op">,</span> doc<span class="op">.</span><span class="fu">getId</span>())<span class="op">;</span></span>
<span id="cb11-101"><a href="#cb11-101"></a>  Logger<span class="op">.</span><span class="fu">log</span>(<span class="st">"Script property 'key' set to: "</span> <span class="op">+</span> doc<span class="op">.</span><span class="fu">getId</span>())<span class="op">;</span></span>
<span id="cb11-102"><a href="#cb11-102"></a>}</span>
<span id="cb11-103"><a href="#cb11-103"></a></span>
<span id="cb11-104"><a href="#cb11-104"></a><span class="kw">function</span> <span class="fu">getLastRowData</span>() {</span>
<span id="cb11-105"><a href="#cb11-105"></a>  <span class="cf">try</span> {</span>
<span id="cb11-106"><a href="#cb11-106"></a>    Logger<span class="op">.</span><span class="fu">log</span>(<span class="st">"getLastRowData function called"</span>)<span class="op">;</span></span>
<span id="cb11-107"><a href="#cb11-107"></a>    <span class="co">// Open the spreadsheet by ID and get the specified sheet</span></span>
<span id="cb11-108"><a href="#cb11-108"></a>    <span class="kw">var</span> sheet <span class="op">=</span> SpreadsheetApp<span class="op">.</span><span class="fu">openById</span>(SCRIPT_PROP<span class="op">.</span><span class="fu">getProperty</span>(<span class="st">"key"</span>))<span class="op">.</span><span class="fu">getSheetByName</span>(SHEET_NAME)<span class="op">;</span></span>
<span id="cb11-109"><a href="#cb11-109"></a>    Logger<span class="op">.</span><span class="fu">log</span>(<span class="st">'Sheet accessed successfully'</span>)<span class="op">;</span></span>
<span id="cb11-110"><a href="#cb11-110"></a>    </span>
<span id="cb11-111"><a href="#cb11-111"></a>    <span class="co">// Get the last row number</span></span>
<span id="cb11-112"><a href="#cb11-112"></a>    <span class="kw">var</span> lastRow <span class="op">=</span> sheet<span class="op">.</span><span class="fu">getLastRow</span>()<span class="op">;</span></span>
<span id="cb11-113"><a href="#cb11-113"></a>    Logger<span class="op">.</span><span class="fu">log</span>(<span class="st">'Last row number: '</span> <span class="op">+</span> lastRow)<span class="op">;</span></span>
<span id="cb11-114"><a href="#cb11-114"></a>    </span>
<span id="cb11-115"><a href="#cb11-115"></a>    <span class="co">// Get the values of the last row</span></span>
<span id="cb11-116"><a href="#cb11-116"></a>    <span class="kw">var</span> lastRowData <span class="op">=</span> sheet<span class="op">.</span><span class="fu">getRange</span>(lastRow<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> sheet<span class="op">.</span><span class="fu">getLastColumn</span>())<span class="op">.</span><span class="fu">getValues</span>()[<span class="dv">0</span>]<span class="op">;</span></span>
<span id="cb11-117"><a href="#cb11-117"></a>    Logger<span class="op">.</span><span class="fu">log</span>(<span class="st">'Last row data: '</span> <span class="op">+</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(lastRowData))<span class="op">;</span></span>
<span id="cb11-118"><a href="#cb11-118"></a>    </span>
<span id="cb11-119"><a href="#cb11-119"></a>    <span class="co">// Get the headers from the first row</span></span>
<span id="cb11-120"><a href="#cb11-120"></a>    <span class="kw">var</span> headers <span class="op">=</span> sheet<span class="op">.</span><span class="fu">getRange</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> sheet<span class="op">.</span><span class="fu">getLastColumn</span>())<span class="op">.</span><span class="fu">getValues</span>()[<span class="dv">0</span>]<span class="op">;</span></span>
<span id="cb11-121"><a href="#cb11-121"></a>    Logger<span class="op">.</span><span class="fu">log</span>(<span class="st">'Headers: '</span> <span class="op">+</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(headers))<span class="op">;</span></span>
<span id="cb11-122"><a href="#cb11-122"></a>    </span>
<span id="cb11-123"><a href="#cb11-123"></a>    <span class="co">// Create an object to store the last row data</span></span>
<span id="cb11-124"><a href="#cb11-124"></a>    <span class="kw">var</span> result <span class="op">=</span> {}<span class="op">;</span></span>
<span id="cb11-125"><a href="#cb11-125"></a>    </span>
<span id="cb11-126"><a href="#cb11-126"></a>    <span class="co">// Populate the result object with the headers as keys and last row data as values</span></span>
<span id="cb11-127"><a href="#cb11-127"></a>    headers<span class="op">.</span><span class="fu">forEach</span>(<span class="kw">function</span>(header<span class="op">,</span> index) {</span>
<span id="cb11-128"><a href="#cb11-128"></a>      <span class="cf">if</span> (header <span class="op">===</span> <span class="st">'Date'</span>) {</span>
<span id="cb11-129"><a href="#cb11-129"></a>        result[header] <span class="op">=</span> <span class="fu">formatDate</span>(lastRowData[index]<span class="op">,</span> <span class="st">"America/Chicago"</span>)<span class="op">;</span></span>
<span id="cb11-130"><a href="#cb11-130"></a>      } <span class="cf">else</span> <span class="cf">if</span> (header <span class="op">===</span> <span class="st">'Time'</span>) {</span>
<span id="cb11-131"><a href="#cb11-131"></a>        result[header] <span class="op">=</span> <span class="fu">formatTime</span>(lastRowData[index]<span class="op">,</span> <span class="st">"America/Chicago"</span>)<span class="op">;</span></span>
<span id="cb11-132"><a href="#cb11-132"></a>      } <span class="cf">else</span> {</span>
<span id="cb11-133"><a href="#cb11-133"></a>        result[header] <span class="op">=</span> lastRowData[index]<span class="op">;</span></span>
<span id="cb11-134"><a href="#cb11-134"></a>      }</span>
<span id="cb11-135"><a href="#cb11-135"></a>    })<span class="op">;</span></span>
<span id="cb11-136"><a href="#cb11-136"></a>    Logger<span class="op">.</span><span class="fu">log</span>(<span class="st">'Result object: '</span> <span class="op">+</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(result))<span class="op">;</span></span>
<span id="cb11-137"><a href="#cb11-137"></a>    </span>
<span id="cb11-138"><a href="#cb11-138"></a>    <span class="co">// Convert the result object to JSON</span></span>
<span id="cb11-139"><a href="#cb11-139"></a>    <span class="kw">var</span> json <span class="op">=</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(result)<span class="op">;</span></span>
<span id="cb11-140"><a href="#cb11-140"></a>    Logger<span class="op">.</span><span class="fu">log</span>(<span class="st">'JSON output: '</span> <span class="op">+</span> json)<span class="op">;</span></span>
<span id="cb11-141"><a href="#cb11-141"></a>    </span>
<span id="cb11-142"><a href="#cb11-142"></a>    <span class="co">// Ensure ContentService is defined and working</span></span>
<span id="cb11-143"><a href="#cb11-143"></a>    <span class="cf">if</span> (<span class="kw">typeof</span> ContentService <span class="op">===</span> <span class="st">'undefined'</span>) {</span>
<span id="cb11-144"><a href="#cb11-144"></a>      <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">'ContentService is not defined.'</span>)<span class="op">;</span></span>
<span id="cb11-145"><a href="#cb11-145"></a>    }</span>
<span id="cb11-146"><a href="#cb11-146"></a></span>
<span id="cb11-147"><a href="#cb11-147"></a>    <span class="co">// Return the JSON output</span></span>
<span id="cb11-148"><a href="#cb11-148"></a>    <span class="kw">var</span> output <span class="op">=</span> ContentService<span class="op">.</span><span class="fu">createTextOutput</span>(json)<span class="op">.</span><span class="fu">setMimeType</span>(ContentService<span class="op">.</span><span class="at">MimeType</span><span class="op">.</span><span class="at">JSON</span>)<span class="op">;</span></span>
<span id="cb11-149"><a href="#cb11-149"></a>    Logger<span class="op">.</span><span class="fu">log</span>(<span class="st">'Output object created successfully.'</span>)<span class="op">;</span></span>
<span id="cb11-150"><a href="#cb11-150"></a>    Logger<span class="op">.</span><span class="fu">log</span>(<span class="st">'Output object: '</span> <span class="op">+</span> output<span class="op">.</span><span class="fu">getContent</span>())<span class="op">;</span></span>
<span id="cb11-151"><a href="#cb11-151"></a>    <span class="cf">return</span> output<span class="op">;</span></span>
<span id="cb11-152"><a href="#cb11-152"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb11-153"><a href="#cb11-153"></a>    Logger<span class="op">.</span><span class="fu">log</span>(<span class="st">'Error: '</span> <span class="op">+</span> error<span class="op">.</span><span class="at">message</span>)<span class="op">;</span></span>
<span id="cb11-154"><a href="#cb11-154"></a>    <span class="cf">return</span> ContentService<span class="op">.</span><span class="fu">createTextOutput</span>(<span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({ <span class="dt">error</span><span class="op">:</span> error<span class="op">.</span><span class="at">message</span> }))<span class="op">.</span><span class="fu">setMimeType</span>(ContentService<span class="op">.</span><span class="at">MimeType</span><span class="op">.</span><span class="at">JSON</span>)<span class="op">;</span></span>
<span id="cb11-155"><a href="#cb11-155"></a>  }</span>
<span id="cb11-156"><a href="#cb11-156"></a>}</span>
<span id="cb11-157"><a href="#cb11-157"></a></span>
<span id="cb11-158"><a href="#cb11-158"></a><span class="kw">function</span> <span class="fu">formatDate</span>(dateString<span class="op">,</span> timeZone) {</span>
<span id="cb11-159"><a href="#cb11-159"></a>  <span class="kw">var</span> date <span class="op">=</span> <span class="kw">new</span> <span class="bu">Date</span>(dateString)<span class="op">;</span></span>
<span id="cb11-160"><a href="#cb11-160"></a>  <span class="cf">return</span> Utilities<span class="op">.</span><span class="fu">formatDate</span>(date<span class="op">,</span> timeZone<span class="op">,</span> <span class="st">"yyyy-MM-dd"</span>)<span class="op">;</span></span>
<span id="cb11-161"><a href="#cb11-161"></a>}</span>
<span id="cb11-162"><a href="#cb11-162"></a></span>
<span id="cb11-163"><a href="#cb11-163"></a><span class="kw">function</span> <span class="fu">formatTime</span>(timeString<span class="op">,</span> timeZone) {</span>
<span id="cb11-164"><a href="#cb11-164"></a>  <span class="kw">var</span> date <span class="op">=</span> <span class="kw">new</span> <span class="bu">Date</span>(timeString)<span class="op">;</span></span>
<span id="cb11-165"><a href="#cb11-165"></a>  <span class="cf">return</span> Utilities<span class="op">.</span><span class="fu">formatDate</span>(date<span class="op">,</span> timeZone<span class="op">,</span> <span class="st">"hh:mm:ss a"</span>)<span class="op">;</span></span>
<span id="cb11-166"><a href="#cb11-166"></a>}</span>
<span id="cb11-167"><a href="#cb11-167"></a></span>
<span id="cb11-168"><a href="#cb11-168"></a><span class="kw">function</span> <span class="fu">getLast6000Rows</span>() {</span>
<span id="cb11-169"><a href="#cb11-169"></a>  <span class="cf">try</span> {</span>
<span id="cb11-170"><a href="#cb11-170"></a>    Logger<span class="op">.</span><span class="fu">log</span>(<span class="st">"getLast6000Rows function called"</span>)<span class="op">;</span></span>
<span id="cb11-171"><a href="#cb11-171"></a>    <span class="kw">var</span> sheet <span class="op">=</span> SpreadsheetApp<span class="op">.</span><span class="fu">openById</span>(SCRIPT_PROP<span class="op">.</span><span class="fu">getProperty</span>(<span class="st">"key"</span>))<span class="op">.</span><span class="fu">getSheetByName</span>(SHEET_NAME)<span class="op">;</span></span>
<span id="cb11-172"><a href="#cb11-172"></a>    Logger<span class="op">.</span><span class="fu">log</span>(<span class="st">'Sheet accessed successfully'</span>)<span class="op">;</span></span>
<span id="cb11-173"><a href="#cb11-173"></a>    </span>
<span id="cb11-174"><a href="#cb11-174"></a>    <span class="kw">var</span> lastRow <span class="op">=</span> sheet<span class="op">.</span><span class="fu">getLastRow</span>()<span class="op">;</span></span>
<span id="cb11-175"><a href="#cb11-175"></a>    Logger<span class="op">.</span><span class="fu">log</span>(<span class="st">'Last row number: '</span> <span class="op">+</span> lastRow)<span class="op">;</span></span>
<span id="cb11-176"><a href="#cb11-176"></a></span>
<span id="cb11-177"><a href="#cb11-177"></a>    <span class="kw">var</span> startRow <span class="op">=</span> lastRow <span class="op">&gt;</span> <span class="dv">6000</span> <span class="op">?</span> lastRow <span class="op">-</span> <span class="dv">5999</span> <span class="op">:</span> <span class="dv">1</span><span class="op">;</span> <span class="co">// Adjust the start row if there are fewer than 6000 rows</span></span>
<span id="cb11-178"><a href="#cb11-178"></a>    Logger<span class="op">.</span><span class="fu">log</span>(<span class="st">'Start row number: '</span> <span class="op">+</span> startRow)<span class="op">;</span></span>
<span id="cb11-179"><a href="#cb11-179"></a>    </span>
<span id="cb11-180"><a href="#cb11-180"></a>    <span class="kw">var</span> numRows <span class="op">=</span> lastRow <span class="op">-</span> startRow <span class="op">+</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb11-181"><a href="#cb11-181"></a>    Logger<span class="op">.</span><span class="fu">log</span>(<span class="st">'Number of rows to fetch: '</span> <span class="op">+</span> numRows)<span class="op">;</span></span>
<span id="cb11-182"><a href="#cb11-182"></a></span>
<span id="cb11-183"><a href="#cb11-183"></a>    <span class="kw">var</span> dataRange <span class="op">=</span> sheet<span class="op">.</span><span class="fu">getRange</span>(startRow<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> numRows<span class="op">,</span> sheet<span class="op">.</span><span class="fu">getLastColumn</span>())<span class="op">;</span></span>
<span id="cb11-184"><a href="#cb11-184"></a>    <span class="kw">var</span> data <span class="op">=</span> dataRange<span class="op">.</span><span class="fu">getValues</span>()<span class="op">;</span></span>
<span id="cb11-185"><a href="#cb11-185"></a>    Logger<span class="op">.</span><span class="fu">log</span>(<span class="st">'Fetched data: '</span> <span class="op">+</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(data))<span class="op">;</span></span>
<span id="cb11-186"><a href="#cb11-186"></a></span>
<span id="cb11-187"><a href="#cb11-187"></a>    <span class="kw">var</span> headers <span class="op">=</span> sheet<span class="op">.</span><span class="fu">getRange</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> sheet<span class="op">.</span><span class="fu">getLastColumn</span>())<span class="op">.</span><span class="fu">getValues</span>()[<span class="dv">0</span>]<span class="op">;</span></span>
<span id="cb11-188"><a href="#cb11-188"></a>    Logger<span class="op">.</span><span class="fu">log</span>(<span class="st">'Headers: '</span> <span class="op">+</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(headers))<span class="op">;</span></span>
<span id="cb11-189"><a href="#cb11-189"></a></span>
<span id="cb11-190"><a href="#cb11-190"></a>    <span class="kw">var</span> result <span class="op">=</span> data<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(row) {</span>
<span id="cb11-191"><a href="#cb11-191"></a>      <span class="kw">var</span> rowObject <span class="op">=</span> {}<span class="op">;</span></span>
<span id="cb11-192"><a href="#cb11-192"></a>      headers<span class="op">.</span><span class="fu">forEach</span>(<span class="kw">function</span>(header<span class="op">,</span> index) {</span>
<span id="cb11-193"><a href="#cb11-193"></a>        <span class="cf">if</span> (header <span class="op">===</span> <span class="st">'Date'</span>) {</span>
<span id="cb11-194"><a href="#cb11-194"></a>          rowObject[header] <span class="op">=</span> <span class="fu">formatDate</span>(row[index]<span class="op">,</span> <span class="st">"America/Chicago"</span>)<span class="op">;</span></span>
<span id="cb11-195"><a href="#cb11-195"></a>        } <span class="cf">else</span> <span class="cf">if</span> (header <span class="op">===</span> <span class="st">'Time'</span>) {</span>
<span id="cb11-196"><a href="#cb11-196"></a>          rowObject[header] <span class="op">=</span> <span class="fu">formatTime</span>(row[index]<span class="op">,</span> <span class="st">"America/Chicago"</span>)<span class="op">;</span></span>
<span id="cb11-197"><a href="#cb11-197"></a>        } <span class="cf">else</span> {</span>
<span id="cb11-198"><a href="#cb11-198"></a>          rowObject[header] <span class="op">=</span> row[index]<span class="op">;</span></span>
<span id="cb11-199"><a href="#cb11-199"></a>        }</span>
<span id="cb11-200"><a href="#cb11-200"></a>      })<span class="op">;</span></span>
<span id="cb11-201"><a href="#cb11-201"></a>      <span class="cf">return</span> rowObject<span class="op">;</span></span>
<span id="cb11-202"><a href="#cb11-202"></a>    })<span class="op">;</span></span>
<span id="cb11-203"><a href="#cb11-203"></a>    Logger<span class="op">.</span><span class="fu">log</span>(<span class="st">'Result object: '</span> <span class="op">+</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(result))<span class="op">;</span></span>
<span id="cb11-204"><a href="#cb11-204"></a>    </span>
<span id="cb11-205"><a href="#cb11-205"></a>    <span class="kw">var</span> json <span class="op">=</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(result)<span class="op">;</span></span>
<span id="cb11-206"><a href="#cb11-206"></a>    Logger<span class="op">.</span><span class="fu">log</span>(<span class="st">'JSON output: '</span> <span class="op">+</span> json)<span class="op">;</span></span>
<span id="cb11-207"><a href="#cb11-207"></a></span>
<span id="cb11-208"><a href="#cb11-208"></a>    <span class="kw">var</span> output <span class="op">=</span> ContentService<span class="op">.</span><span class="fu">createTextOutput</span>(json)<span class="op">.</span><span class="fu">setMimeType</span>(ContentService<span class="op">.</span><span class="at">MimeType</span><span class="op">.</span><span class="at">JSON</span>)<span class="op">;</span></span>
<span id="cb11-209"><a href="#cb11-209"></a>    Logger<span class="op">.</span><span class="fu">log</span>(<span class="st">'Output object created successfully.'</span>)<span class="op">;</span></span>
<span id="cb11-210"><a href="#cb11-210"></a>    Logger<span class="op">.</span><span class="fu">log</span>(<span class="st">'Output object: '</span> <span class="op">+</span> output<span class="op">.</span><span class="fu">getContent</span>())<span class="op">;</span></span>
<span id="cb11-211"><a href="#cb11-211"></a>    <span class="cf">return</span> output<span class="op">;</span></span>
<span id="cb11-212"><a href="#cb11-212"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb11-213"><a href="#cb11-213"></a>    Logger<span class="op">.</span><span class="fu">log</span>(<span class="st">'Error: '</span> <span class="op">+</span> error<span class="op">.</span><span class="at">message</span>)<span class="op">;</span></span>
<span id="cb11-214"><a href="#cb11-214"></a>    <span class="cf">return</span> ContentService<span class="op">.</span><span class="fu">createTextOutput</span>(<span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({ <span class="dt">error</span><span class="op">:</span> error<span class="op">.</span><span class="at">message</span> }))<span class="op">.</span><span class="fu">setMimeType</span>(ContentService<span class="op">.</span><span class="at">MimeType</span><span class="op">.</span><span class="at">JSON</span>)<span class="op">;</span></span>
<span id="cb11-215"><a href="#cb11-215"></a>  }</span>
<span id="cb11-216"><a href="#cb11-216"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p>And here’s a visual of what’s going on:</p>
<p><a href="images/Google Apps Script GetPost.png" class="lightbox" data-gallery="quarto-lightbox-gallery-7"><img src="images/Google Apps Script GetPost.png" class="img-fluid"></a></p>
<p>And here’s the requests form to see the data:</p>
<p>Latest sensor reading Google Sheets(button loads latest data):</p>
<div>
<!-- Google Sheets Data Display -->
<section>
    <h2 class="anchored" data-anchor-id="flashing-the-program">Google Sheets Data Display</h2>
    <button class="load-button" onclick="loadLastRowGoogle()">Load Google Sheets Data</button>
    
<table id="google-data-table" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th">Time</th>
<th data-quarto-table-cell-role="th">Humidity %</th>
<th data-quarto-table-cell-role="th">Temp F</th>
<th data-quarto-table-cell-role="th">Temp C</th>
</tr>
</thead>
<tbody>
</tbody>
</table>

</section>
<script>
    async function loadLastRowGoogle() {
        const url = 'https://script.google.com/macros/s/AKfycbzNi7_SbooXqXYjEfJdP233EaJ4EVswgHxm6nWxMG6G5nfmmXfJsV3q5CzEigp_6D-8/exec?action=getLastRow';

         try {
            console.log('Fetching data from URL:', url);
            const response = await fetch(url);
            console.log('Response status:', response.status);
            
            if (!response.ok) {
                throw new Error('Network response was not ok ' + response.statusText);
            }

            const json = await response.json();
            console.log('Fetched data:', json);
            
            if (json) {
                displayTableGoogle(json);
            } else {
                console.log('No data found.');
            }
        } catch (error) {
            console.error("Error fetching data from Google Sheets:", error);
        }
    }


    function displayTableGoogle(row) {
        console.log('Displaying data in Google Sheets table:', row);
        const table = document.getElementById('google-data-table');
        const tbody = table.querySelector('tbody');
        //tbody.innerHTML = ''; // Clear any existing rows

        const newRow = tbody.insertRow();
        newRow.id = 'google-data-table-row';

        const fields = ['Date', 'Time', 'Humidity %', 'Temp F', 'Temp C'];

        const formattedRow = {
            'Date': row['Date'],
            'Time': row['Time'],
            'Humidity %': row['Humidity %'],
            'Temp F': row['Temp F'],
            'Temp C': row['Temp C']
        };

        fields.forEach((field, index) => {
            const newCell = newRow.insertCell();
            newCell.id = `google-data-table-cell-${index + 1}`;
            const text = document.createTextNode(formattedRow[field] || '');
            newCell.appendChild(text);
        });
    }
</script>
<style>
    #google-data-table {
        width: 50%;
        border-collapse: collapse;
        margin: 50px auto;
    }
    #google-data-table th, #google-data-table td {
        padding: 10px;
        border: 1px solid #ddd;
        text-align: center;
    }
    #google-data-table th {
        background-color: #f2f2f2;
    }
    .load-button {
        display: block;
        margin: 20px auto;
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
    }
</style>
</div>
<p>Latest Sensor Reading ThingSpeak(press button):</p>
<div>
<!-- ThingSpeak Data Display -->
<section>
    <h2 class="anchored">ThingSpeak Data Display</h2>
    <button class="load-button" onclick="loadThingSpeakData()">Load ThingSpeak Data</button>
    
<table id="thingspeak-data-table" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th">Time</th>
<th data-quarto-table-cell-role="th">Humidity %</th>
<th data-quarto-table-cell-role="th">Temp F</th>
<th data-quarto-table-cell-role="th">Temp C</th>
</tr>
</thead>
<tbody>
</tbody>
</table>

</section>

<script>
    async function loadThingSpeakData() {
        const url = 'https://api.thingspeak.com/channels/2545447/feeds.json?results=1';

        try {
            const response = await fetch(url);
            const json = await response.json();
            if (json.feeds && json.feeds.length) {
                const lastFeed = json.feeds[json.feeds.length - 1];
                displayTableThingSpeak(lastFeed);
            } else {
                console.log('No data found.');
            }
        } catch (error) {
            console.error("Error fetching data from ThingSpeak:", error);
        }
    }

    function displayTableThingSpeak(feed) {
        const table = document.getElementById('thingspeak-data-table');
        const tbody = table.querySelector('tbody');
        const newRow = tbody.insertRow();
        newRow.id = 'thingspeak-data-table-row';

        const fields = ['field5', 'field4', 'field3', 'field2', 'field1'];
        fields.forEach((field) => {
            const newCell = newRow.insertCell();
            newCell.id = `thingspeak-data-table-cell-${field}`;
            const text = document.createTextNode(feed[field] || '');
            newCell.appendChild(text);
        });
    }
</script>

<style>
    #thingspeak-data-table {
        width: 50%;
        border-collapse: collapse;
        margin: 50px auto;
    }
    #thingspeak-data-table th, #thingspeak-data-table td {
        padding: 10px;
        border: 1px solid #ddd;
        text-align: center;
    }
    #thingspeak-data-table th {
        background-color: #f2f2f2;
    }
    .load-button {
        display: block;
        margin: 20px auto;
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
    }
</style>
</div>
<p>Latest Sensor Reading MongoDB(Read-Only User):</p>
<div>
<!-- MongoDB Data Display -->
<section>
    <h2 class="anchored">MongoDB Data Display</h2>
    <button class="load-button" onclick="loadMongoDBData()">Load MongoDB Data</button>
    
<table id="mongodb-data-table" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th">Time</th>
<th data-quarto-table-cell-role="th">Humidity %</th>
<th data-quarto-table-cell-role="th">Temp F</th>
<th data-quarto-table-cell-role="th">Temp C</th>
</tr>
</thead>
<tbody>
</tbody>
</table>

</section>
<script>
    async function loadMongoDBData() {
        const url = 'https://vercel-raspberry-pi-server.vercel.app/api/displayLastRowSQLMongoDB';

        try {
            const response = await fetch(url);
            const json = await response.json();
            if (json) {
                setTimeout(() => displayTableMongo(json), 3000); // Wait for 3 seconds before populating the table
            } else {
                console.log('No data found.');
            }
        } catch (error) {
            console.error("Error fetching data:", error);
        }
    }

    function displayTableMongo(data) {
        const table = document.getElementById('mongodb-data-table');
        const tbody = table.querySelector('tbody');
        const newRow = tbody.insertRow();

        const fields = ['date', 'time', 'humidityPercent', 'temperatureFahrenheit', 'temperatureCelsius'];
        fields.forEach((field) => {
            const newCell = newRow.insertCell();
            newCell.id = `mongodb-data-table-cell-${field}`;
            const text = document.createTextNode(data[field] || '');
            newCell.appendChild(text);
        });
    }
</script>
<style>
    #mongodb-data-table {
        width: 50%;
        border-collapse: collapse;
        margin: 50px auto;
    }
    #mongodb-data-table th, #mongodb-data-table td {
        padding: 10px;
        border: 1px solid #ddd;
        text-align: center;
    }
    #mongodb-data-table th {
        background-color: #f2f2f2;
    }
    .load-button {
        display: block;
        margin: 20px auto;
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
    }
</style>
</div>
<p>Latest Sensor Reading Vercel PostgreSQL(Read-Only User):</p>
<div>
<!-- Vercel Data Display -->
<section>
    <h2 class="anchored">Vercel Data Display</h2>
    <button class="load-button" onclick="loadVercelData()">Load Vercel Data</button>
    
<table id="vercel-data-table" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th">Time</th>
<th data-quarto-table-cell-role="th">Humidity %</th>
<th data-quarto-table-cell-role="th">Temp F</th>
<th data-quarto-table-cell-role="th">Temp C</th>
</tr>
</thead>
<tbody>
</tbody>
</table>

</section>
<script>
    async function loadVercelData() {
        const url = 'https://vercel-raspberry-pi-server.vercel.app/api/displayLastRowSQL';

        try {
            const response = await fetch(url);
            const json = await response.json();
            if (json) {
                setTimeout(() => displayTableVercel(json), 3000); // Wait for 3 seconds before populating the table
            } else {
                console.log('No data found.');
            }
        } catch (error) {
            console.error("Error fetching data:", error);
        }
    }

    function displayTableVercel(data) {
        const table = document.getElementById('vercel-data-table');
        const tbody = table.querySelector('tbody');
        const newRow = tbody.insertRow();

        const fields = ['date', 'time', 'humiditypercent', 'temperaturefahrenheit', 'temperaturecelsius'];
        fields.forEach((field) => {
            const newCell = newRow.insertCell();
            newCell.id = `vercel-data-table-cell-${field}`;
            const text = document.createTextNode(data[field] || '');
            newCell.appendChild(text);
        });
    }
</script>
<style>
    #vercel-data-table {
        width: 50%;
        border-collapse: collapse;
        margin: 50px auto;
    }
    #vercel-data-table th, #vercel-data-table td {
        padding: 10px;
        border: 1px solid #ddd;
        text-align: center;
    }
    #vercel-data-table th {
        background-color: #f2f2f2;
    }
    .load-button {
        display: block;
        margin: 20px auto;
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
    }
</style>
</div>
<p>Finally, as before in this post: <a href="https://jesse-anderson.github.io/Blog/_site/posts/Pi-Sensor-Part-2/" class="uri">https://jesse-anderson.github.io/Blog/_site/posts/Pi-Sensor-Part-2/</a> We have a plot of the last 6000 or so values from Google this time. Note the changes in Google Apps Script above to make this possible…</p>
<div>



    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Plot</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
        }
        .loading-message {
            text-align: center;
            font-size: 1.2em;
            margin-top: 20px;
            display: none; /* Hide by default */
        }
    </style>


    <h2 class="anchored">Pi Environment Test Data</h2>
    <p><button onclick="loadCharts()">Load Charts</button></p>
    <p></p>
    <p><button onclick="refreshData()">Refresh</button></p>
    <div id="loadingMessage" class="loading-message">Loading, please wait...</div>
    <canvas id="tempChart" width="400" height="200"></canvas>
    <canvas id="humidityChart" width="400" height="200"></canvas>
    <div id="latestValues"></div>
    <script>
        async function fetchData() {
            try {
                const response = await fetch('https://script.google.com/macros/s/AKfycbzNi7_SbooXqXYjEfJdP233EaJ4EVswgHxm6nWxMG6G5nfmmXfJsV3q5CzEigp_6D-8/exec?action=getLast6000Rows');
                const data = await response.json();
                console.log('Fetched data:', data);
                if (data && Array.isArray(data)) {
                    return data;
                } else if (data && Array.isArray(data.rows)) {
                    return data.rows;
                } else {
                    console.error('Unexpected data structure:', data);
                    document.getElementById('latestValues').innerHTML = `<p>Unexpected data structure. Check console for details.</p>`;
                    return [];
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('latestValues').innerHTML = `<p>Error fetching data. Check console for details.</p>`;
                return [];
            }
        }

        function processData(feeds) {
            console.log('Processing data:', feeds);
            if (!Array.isArray(feeds)) {
                console.error('Data is not an array. Type:', typeof feeds);
                console.log('Data value:', feeds);
                document.getElementById('latestValues').innerHTML = `<p>Data is not an array. Type: ${typeof feeds}</p>`;
                return { labels: [], tempF: [], humidity: [] };
            }

            const labels = feeds.map(feed => new Date(`${feed.Date} ${feed.Time}`));
            const tempF = feeds.map(feed => parseFloat(feed['Temp F']));
            const humidity = feeds.map(feed => parseFloat(feed['Humidity %']));
            return { labels, tempF, humidity };
        }

        function displayLatestValues(labels, tempF, humidity) {
            const latestTime = labels[labels.length - 1];
            const latestTempF = tempF[tempF.length - 1];
            const latestHumidity = humidity[humidity.length - 1];

            const tableHTML = `
                
<table data-quarto-postprocess="true">
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">Time</td>
<td data-quarto-table-cell-role="th">Temp F</td>
<td data-quarto-table-cell-role="th">Humidity</td>
</tr>
<tr class="even">
<td>${latestTime.toLocaleDateString('en-US')} ${latestTime.toLocaleTimeString('en-US')}</td>
<td>${latestTempF.toFixed(2)}</td>
<td>${latestHumidity.toFixed(2)}</td>
</tr>
</tbody>
</table>

            `;

            document.getElementById('latestValues').innerHTML = tableHTML;
        }

        async function createCharts() {
            document.getElementById('loadingMessage').style.display = 'block';

            const feeds = await fetchData();
            const { labels, tempF, humidity } = processData(feeds);

            const tempCtx = document.getElementById('tempChart').getContext('2d');
            const humidityCtx = document.getElementById('humidityChart').getContext('2d');

            const tempChart = new Chart(tempCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Temperature F',
                            data: tempF,
                            borderColor: 'rgba(255, 165, 0, 1)',
                            backgroundColor: 'rgba(255, 165, 0, 0.2)',
                            borderWidth: 1,
                            fill: true
                        }
                    ]
                },
                options: {
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'hour'
                            }
                        },
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            const humidityChart = new Chart(humidityCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Humidity',
                            data: humidity,
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderWidth: 1,
                            fill: true
                        }
                    ]
                },
                options: {
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'hour'
                            }
                        },
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            displayLatestValues(labels, tempF, humidity);

            document.getElementById('loadingMessage').style.display = 'none';

            return { tempChart, humidityChart };
        }

        let chartInstances = {};

        async function refreshData() {
            document.getElementById('loadingMessage').style.display = 'block';

            const feeds = await fetchData();
            const { labels, tempF, humidity } = processData(feeds);

            // Clear existing data
            chartInstances.tempChart.data.labels = [];
            chartInstances.tempChart.data.datasets[0].data = [];

            chartInstances.humidityChart.data.labels = [];
            chartInstances.humidityChart.data.datasets[0].data = [];

            // Update with new data
            chartInstances.tempChart.data.labels = labels;
            chartInstances.tempChart.data.datasets[0].data = tempF;

            chartInstances.humidityChart.data.labels = labels;
            chartInstances.humidityChart.data.datasets[0].data = humidity;

            // Update charts
            chartInstances.tempChart.update();
            chartInstances.humidityChart.update();

            displayLatestValues(labels, tempF, humidity);

            document.getElementById('loadingMessage').style.display = 'none';
        }

        async function loadCharts() {
            document.getElementById('loadingMessage').style.display = 'block';

            if (!chartInstances.tempChart && !chartInstances.humidityChart) {
                chartInstances = await createCharts();
            }

            document.getElementById('loadingMessage').style.display = 'none';
        }
    </script>


</div>
<p>Moving forward I’ll likely add an LCD display, enclosure and more sensors, but the main point of this exercise was to become more familiar with the simpler, cost effective IoT devices. Additionally extending Google Apps script’s functionality to include pulling data for plotting is tremendously useful for anyone who doesn’t want to pay for ThingSpeak.</p>
<p>Other thoughts:</p>
<ul>
<li><p>Getting the sensor to reliably take readings was a pain. Slightly moving the sensor caused readings to fail and no data to be transmitted.</p>
<ul>
<li>Moving beyond a simple breadboard and hand soldering connections makes sense, but only for production. If that were the case, the odd 4-8 hours of getting a C/C++ version of this code up and running would make sense.</li>
</ul></li>
<li><p>Google Apps Script is awesome and its usually on me if something breaks. The fact that I can log about four-ish years worth of data at 1 log/min</p>
<ul>
<li><p>2 million rows at 5 entries per row / 60 entries per hour / 24 hours per year / 365.25 days per year = 3.8 years</p></li>
<li><p>At 2 logs/min or 30 seconds per log: 1.9 years.</p></li>
</ul></li>
<li><p>The amount of processing power/memory and power(wattage) delivered to an ESP32 forced me to re evaluate the order of operations at several steps. Notably I spent some time debugging the wifi until I tried selectively powering things on or off. I also found that the program would randomly crash during POSTs and it would be the size of the response received that would cause a memory error.</p></li>
<li><p>With the previous post most of the leg work in setting up the web interfaces was already taken care of so all I had to do was the wiring, some rewriting of Python code(notably Google Sheets sending), and overhauling the Google Apps script. Luckily I finally moved away from ThingSpeak for plotting/data acquistion for plotting and now I grab directly from Google. Its a little bit longer now and I could halve the time by grabbing less data. 6,000 data points is a lot and eventually, at a 30 second sampling time, that’s nearly 50 hours of data with each plot.</p></li>
<li><p>A breakout board would have sped up figuring out the circuit before placing everything down. I picked one up for a Pi Pico I’m tinkering with for a plant project and an Adafruit Pi Cobbler(basically a breakout board) for a raspberry pi and I notice the faster reference time is nice. It would likely be best to have a high quality breakout board alongside a final proto board to make sure the design sticks and loose connections don’t hurt me.</p></li>
</ul>


</section>


</main> <!-- /main -->






    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Support Page</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>

        .centered-text {

            text-align: center; /* Centers text for elements with this class */

        }

        .centered-content {

            display: flex; /* Uses Flexbox for layout */

            justify-content: center; /* Horizontally centers the content within the container */

            align-items: center; /* Vertically centers the content within the container */

        }

        .email-share-button {

            background: #007BFF; /* Example: a distinct blue color for the email button */

            color: white; /* Ensure text and icon are white for visibility */

        }

        #share-buttons {

            display: flex;

            align-items: center;

            justify-content: center;

            gap: 5px;

        }

        .share-button {

            display: inline-flex;

            padding: 2px 4px;

            font-size: 14px;

            cursor: pointer;

            text-align: center;

            color: white;

            border-radius: 0px;

        }

    </style>





    <footer class="centered-text">

        <p>Copyright © <span id="copyright-year"></span> Jesse Anderson</p>

        <!-- Other footer details -->

    </footer>

    <div>

        <hr>

        <h3 class="centered-text">Support my work with a Coffee/Monster</h3>

        <div class="centered-content">

            <script type="text/javascript" src="https://cdnjs.buymeacoffee.com/1.0.0/button.prod.min.js" data-name="bmc-button" data-slug="jesseanderson" data-color="#06436e" data-emoji="☕" data-font="Lato" data-text="Support me" data-outline-color="#ffffff" data-font-color="#ffffff" data-coffee-color="#FFDD00" data-height="40px"></script>

        </div>

        <!-- Footer content -->

        <h3 class="centered-text">Share</h3>

        <!-- Share Buttons -->

        <div id="share-buttons" class="centered-content">

            <!-- Twitter Share Button, dynamically setting the URL -->

            <a href="#" class="share-button twitter-share-button" data-size="large" data-hashtags="computerscience" data-via="JesseA7C5" data-show-count="false">Tweet</a>

            <script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

            <!-- Facebook SDK with Dynamic Nonce -->

            <div id="fb-root"></div>

            <script id="facebook-jssdk" async="" defer="" crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js#xfbml=1&amp;version=v10.0"></script>

            <div class="fb-share-button share-button" data-href="" data-layout="button_count">

            </div>

            <!-- LinkedIn Share Button -->

            <script src="https://platform.linkedin.com/in.js" type="text/javascript">lang: en_US</script>

            <script type="IN/Share" data-url=""></script>

            <!-- Email Share Button -->

            <a href="#" class="share-button email-share-button"><i class="fas fa-envelope"></i></a>

        </div>

    </div>

    <script>

        // Function to generate a random nonce

        function generateNonce(length = 16) {

            const possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";

            let text = "";

            for (let i = 0; i < length; i++) {

                text += possible.charAt(Math.floor(Math.random() * possible.length));

            }

            return text;

        }

        // Set the nonce attribute for the Facebook SDK script and dynamically set URLs

        document.addEventListener('DOMContentLoaded', function() {

            const nonce = generateNonce();

            const facebookSDKScript = document.getElementById('facebook-jssdk');

            facebookSDKScript.setAttribute('nonce', nonce);

            var elems = document.querySelectorAll('script[type="IN/Share"]');

            for (var i = 0; i < elems.length; i++) {

                elems[i].setAttribute('data-url', window.location.href);

            }

            // Set dynamic URLs for social sharing

            const currentUrl = window.location.href;

            const currentTitle = document.title; // Use the current document title as the email subject

            // Facebook

            document.querySelector('.fb-share-button').setAttribute('data-href', currentUrl);

            // LinkedIn

            document.querySelectorAll('script[type="IN/Share"]')[0].setAttribute('data-url', currentUrl);

            // Twitter

            document.querySelector('.twitter-share-button').setAttribute('href', 'https://twitter.com/share?url=' + encodeURIComponent(currentUrl) + '&hashtags=rstats');

            // Email

            document.querySelector('.email-share-button').setAttribute('href', `mailto:?subject=${encodeURIComponent(currentTitle)}&body=Check out this link: ${encodeURIComponent(currentUrl)}`);

            // Dynamically set the current year in the copyright footer

            document.getElementById('copyright-year').textContent = new Date().getFullYear();

        });

        // This script below to put a latest posts list after the comment system was such a pain in the ass.

        document.addEventListener('DOMContentLoaded', function() {

            // console.log("Latest Posts Populating...");

            // Create the latest posts container

            const latestPostsContainer = document.createElement('div');

            latestPostsContainer.className = 'latest-posts';

            latestPostsContainer.innerHTML = `

                <h3>Latest Posts</h3>

                <ul id="latest-posts-list">

                    <!-- Latest posts will be inserted here -->

                </ul>

            `;

            // Find the footer element

            const footer = document.querySelector('footer.footer');

            // Insert the latest posts container before footer, easier than after utterances.

            footer.parentNode.insertBefore(latestPostsContainer, footer);

            // Fetch latest posts from the archive page

            fetch('https://jesse-anderson.github.io/Blog/_site/archive.html')

                .then(response => response.text())

                .then(data => {

                    const parser = new DOMParser();

                    const doc = parser.parseFromString(data, 'text/html');

                    const posts = doc.querySelectorAll('.quarto-listing-container-table tbody tr');

                    // console.log("Posts: ", posts);

                    const latestPostsList = document.getElementById('latest-posts-list');

                    let count = 0;

                    posts.forEach(post => {

                        if (count < 4) {

                            // console.log("Title populating...");

                            const titleElement = post.querySelector('.listing-title'); // Correctly select the <a> tag with the title class

                            // console.log(titleElement)

                              const imageElement = post.querySelector('.listing-image img');

                              // console.log(imageElement)

                            if (titleElement) {

                                const title = titleElement.textContent.trim();

                                // console.log('Title: ', title);

                                let url = titleElement.getAttribute('href');

                                // console.log('URL: ', url);

                                if (url && !url.startsWith('http')) {

                                    url = 'https://jesse-anderson.github.io/Blog/_site/' + url.replace(/^\.\//, '');

                                }

                                // console.log('Formatted URL: ', url);

                                const imageUrl = imageElement ? imageElement.getAttribute('src').replace(/^\.\//, 'https://jesse-anderson.github.io/Blog/_site/') : 'default-image.jpg'; // Fallback image

                                // console.log('Image URL: ', imageUrl);

                                const listItem = document.createElement('li');

                                listItem.innerHTML = `<a href="${url}"><img src="${imageUrl}" alt="Post Image" style="height: 20px;"> ${title}</a>`;

                                latestPostsList.appendChild(listItem);

                                // console.log('ListItem: ', listItem);

                                count++;

                            } else {

                                console.warn('Missing elements for post:', post);

                            }

                        }

                    });

                });

        });

    </script>





<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="jesse-anderson/blogComments" issue-term="title" theme="github-dark" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">

<div class="cookie-consent-footer"><a href="#" id="open_preferences_center">Cookie Preferences</a></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>
<script>var lightboxQuarto = GLightbox({"loop":false,"openEffect":"zoom","descPosition":"bottom","selector":".lightbox","closeEffect":"zoom"});
window.onload = () => {
  lightboxQuarto.on('slide_before_load', (data) => {
    const { slideIndex, slideNode, slideConfig, player, trigger } = data;
    const href = trigger.getAttribute('href');
    if (href !== null) {
      const imgEl = window.document.querySelector(`a[href="${href}"] img`);
      if (imgEl !== null) {
        const srcAttr = imgEl.getAttribute("src");
        if (srcAttr && srcAttr.startsWith("data:")) {
          slideConfig.href = srcAttr;
        }
      }
    } 
  });

  lightboxQuarto.on('slide_after_load', (data) => {
    const { slideIndex, slideNode, slideConfig, player, trigger } = data;
    if (window.Quarto?.typesetMath) {
      window.Quarto.typesetMath(slideNode);
    }
  });

};
          </script>




</body></html>