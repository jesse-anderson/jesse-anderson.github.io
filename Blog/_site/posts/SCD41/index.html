<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Jesse Anderson">
<meta name="dcterms.date" content="2024-09-02">

<title>Jesse Anderson’s Blog - SCD41: On Demand CO2 Sensor</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/cookie-consent/cookie-consent.js"></script>
<link href="../../site_libs/cookie-consent/cookie-consent.css" rel="stylesheet">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="../../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-5CSPYCMY55"></script>

<script type="text/plain" cookie-consent="tracking">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-5CSPYCMY55', { 'anonymize_ip': true});
</script>

<script type="text/javascript" charset="UTF-8">
document.addEventListener('DOMContentLoaded', function () {
cookieconsent.run({
  "notice_banner_type":"simple",
  "consent_type":"implied",
  "palette":"light",
  "language":"en",
  "page_load_consent_levels":["strictly-necessary","functionality","tracking","targeting"],
  "notice_banner_reject_button_hide":false,
  "preferences_center_close_button_hide":false,
  "website_name":""
  ,
"language":"en"
  });
});
</script> 
  


<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="Jesse Anderson’s Blog - SCD41: On Demand CO2 Sensor">
<meta property="og:description" content="">
<meta property="og:image" content="Mid-infrared_absorption_spectra_of_Gases.png">
<meta property="og:site_name" content="Jesse Anderson's Blog">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Jesse Anderson’s Blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../archive.html"> 
<span class="menu-text">Archive</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://jesse-anderson.github.io"> <i class="bi bi-Folder symlink fill" role="img">
</i> 
<span class="menu-text">Portfolio</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/jesse-anderson/"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/jesse-anderson-a7c5/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">SCD41: On Demand CO2 Sensor</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">ESP32</div>
                <div class="quarto-category">IoT</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Jesse Anderson </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">September 2, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<p>Original Post: 06/01/2024</p>
<p>Update: I updated this post as of 09/02/24 to reflect the changes made to the CO2 sensor, namely using 5V for stability, an OLED screen for display, switches for wifi and calibration, and finally an obnoxious buzzer to let me know I should open my windows/door(&gt;1500ppm).</p>
<p><em>Disclaimer: Please note that the information presented in this article is for informational purposes only. It is not intended to serve as health advice, engineering advice, or any form of professional guidance. Readers should consult with qualified professionals for specific health or engineering concerns and should not rely solely on the content of this article for making decisions. The authors and publishers of this article are not responsible for any actions taken based on the information provided herein.</em></p>
<p>In this post I intend to cover the basics of SCD41 sensors, their technical performance, some MicroPython code to use with an ESP32 microcontroller(yes I know there are other ones out there), and some of the limitations/precautions one should take with this particular sensor.</p>
<section id="what-is-an-scd41-sensor" class="level3">
<h3 class="anchored" data-anchor-id="what-is-an-scd41-sensor">What is an SCD41 Sensor?</h3>
<p>An SCD41 sensor is Sensirion’s miniature CO2 sensor. It uses a photoacoustic NDIR sensing principle along with Sensirion’s patented technology to offer high accuracy at a competitive price. I personally picked up this sensor for $28.99, and it could likely be found at a lower price directly from the manufacturer or via platforms like AliExpress. The sensor also includes on-chip signal compensation with a built-in SHT4x humidity and temperature sensor to account for fluctuations in environmental conditions, ensuring accurate CO2 readings.</p>
</section>
<section id="technical-performance" class="level3">
<h3 class="anchored" data-anchor-id="technical-performance">Technical Performance</h3>
<section id="generalized-co2-accuracy-specification" class="level4">
<h4 class="anchored" data-anchor-id="generalized-co2-accuracy-specification"><strong>Generalized CO2 Accuracy Specification:</strong></h4>
<ul>
<li><p><strong>400-1,000 ppm:</strong> ±(50 ppm + 2.5% of reading)</p></li>
<li><p><strong>1,001-2,000 ppm:</strong> ±(50 ppm + 3% of reading)</p></li>
<li><p><strong>2,001-5,000 ppm:</strong> ±(40 ppm + 5% of reading)</p></li>
</ul>
</section>
<section id="temperature-and-humidity-specifications" class="level4">
<h4 class="anchored" data-anchor-id="temperature-and-humidity-specifications">Temperature and Humidity Specifications:</h4>
<ul>
<li><p><strong>Temperature Accuracy</strong>: -10°C to 60°C range with an accuracy of ±0.8°C</p></li>
<li><p><strong>Humidity Accuracy</strong>: 0-95% RH range with an accuracy of ±6% RH</p></li>
</ul>
<details>
<summary>
More Detailed Specifications…
</summary>
<pre><code>SCD41 Sensor Series Specifications</code></pre>
<table class="table">
<colgroup>
<col style="width: 35%">
<col style="width: 31%">
<col style="width: 31%">
</colgroup>
<thead>
<tr class="header">
<th><pre><code>Specification</code></pre></th>
<th><pre><code>Value</code></pre></th>
<th><pre><code>Unit</code></pre></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><pre><code>CO₂ Measurement Range</code></pre></td>
<td><pre><code>0 - 40,000</code></pre></td>
<td><pre><code>ppm</code></pre></td>
</tr>
<tr class="even">
<td><pre><code>CO₂ Measurement Accuracy (SCD41)</code></pre></td>
<td><pre><code>400 - 1,000</code></pre></td>
<td><pre><code>±(50 ppm + 2.5% of reading) ppm</code></pre></td>
</tr>
<tr class="odd">
<td><pre><code></code></pre></td>
<td><pre><code>1,001 - 2,000</code></pre></td>
<td><pre><code>±(50 ppm + 3% of reading) ppm</code></pre></td>
</tr>
<tr class="even">
<td><pre><code></code></pre></td>
<td><pre><code>2,001 - 5,000</code></pre></td>
<td><pre><code>±(40 ppm + 5% of reading) ppm</code></pre></td>
</tr>
<tr class="odd">
<td><pre><code>CO₂ Repeatability</code></pre></td>
<td><pre><code>Typical</code></pre></td>
<td><pre><code>±10 ppm</code></pre></td>
</tr>
<tr class="even">
<td><pre><code>CO₂ Response Time (τ63%)</code></pre></td>
<td><pre><code>Typical</code></pre></td>
<td><pre><code>60 s</code></pre></td>
</tr>
<tr class="odd">
<td><pre><code>Additional Accuracy Drift (5 years)</code></pre></td>
<td><pre><code>400 - 2,000, with ASC enabled</code></pre></td>
<td><pre><code>±(5 ppm + 0.5% of reading) ppm</code></pre></td>
</tr>
<tr class="even">
<td><pre><code>Humidity Measurement Range</code></pre></td>
<td><pre><code>0 - 100</code></pre></td>
<td><pre><code>%RH</code></pre></td>
</tr>
<tr class="odd">
<td><pre><code>Humidity Accuracy (typical)</code></pre></td>
<td><pre><code>15 °C – 35 °C, 20 %RH – 65 %RH</code></pre></td>
<td><pre><code>±6 %RH</code></pre></td>
</tr>
<tr class="even">
<td><pre><code></code></pre></td>
<td><pre><code>-10 °C – 60 °C, 0 %RH – 100 %RH</code></pre></td>
<td><pre><code>±9 %RH</code></pre></td>
</tr>
<tr class="odd">
<td><pre><code>Humidity Repeatability</code></pre></td>
<td><pre><code>Typical</code></pre></td>
<td><pre><code>±0.4 %RH</code></pre></td>
</tr>
<tr class="even">
<td><pre><code>Humidity Response Time (τ63%)</code></pre></td>
<td><pre><code>Typical</code></pre></td>
<td><pre><code>90 s</code></pre></td>
</tr>
<tr class="odd">
<td><pre><code>Humidity Accuracy Drift</code></pre></td>
<td><pre><code>Yearly</code></pre></td>
<td><pre><code>&lt;0.25 %RH</code></pre></td>
</tr>
<tr class="even">
<td><pre><code>Temperature Measurement Range</code></pre></td>
<td><pre><code>-10 - 60</code></pre></td>
<td><pre><code>°C</code></pre></td>
</tr>
<tr class="odd">
<td><pre><code>Temperature Accuracy (typical)</code></pre></td>
<td><pre><code>15 °C – 35 °C</code></pre></td>
<td><pre><code>±0.8 °C</code></pre></td>
</tr>
<tr class="even">
<td><pre><code></code></pre></td>
<td><pre><code>-10 °C – 60 °C</code></pre></td>
<td><pre><code>±1.5 °C</code></pre></td>
</tr>
<tr class="odd">
<td><pre><code>Temperature Repeatability</code></pre></td>
<td><pre><code>-</code></pre></td>
<td><pre><code>±0.1 °C</code></pre></td>
</tr>
<tr class="even">
<td><pre><code>Temperature Response Time (τ63%)</code></pre></td>
<td><pre><code>Typical</code></pre></td>
<td><pre><code>120 s</code></pre></td>
</tr>
<tr class="odd">
<td><pre><code>Temperature Accuracy Drift</code></pre></td>
<td><pre><code>Yearly</code></pre></td>
<td><pre><code>&lt;0.03 °C</code></pre></td>
</tr>
<tr class="even">
<td><pre><code>Supply Voltage</code></pre></td>
<td><pre><code>2.4 - 5.5</code></pre></td>
<td><pre><code>V</code></pre></td>
</tr>
<tr class="odd">
<td><pre><code>Average Supply Current</code></pre></td>
<td><pre><code>Typical</code></pre></td>
<td><pre><code>15 mA</code></pre></td>
</tr>
<tr class="even">
<td><pre><code>Max. Supply Current</code></pre></td>
<td><pre><code>-</code></pre></td>
<td><pre><code>205 mA</code></pre></td>
</tr>
</tbody>
</table>
</details>
<p>The response time is roughly every 2 minutes for temperature and every 90 seconds for humidity. Using the longest response time as a basis for our sampling, we get a sampling rate of once every 2 minutes. The sensor’s extensive command set, clearly detailed in the datasheet, simplifies programming but requires familiarity with numerous commands.</p>
<p>Before diving into the fundamentals let’s visit why we even care about CO2 to begin with.</p>
</section>
</section>
<section id="co2-levels-in-an-enclosed-space" class="level3">
<h3 class="anchored">CO2 Levels in an Enclosed Space</h3>
<p>CO2 levels increase in an enclosed room predictably with time as it is an enclosed system with n number of producers(people). We can actually do a mass balance around the system if we really wanted to to evaluate the amount of CO2 if we had values per person. A mass balance for CO2 in an enclosed room involves calculating how the amount of CO2 changes over time. Since the room is sealed, we start with an initial amount of CO2 and add the CO2 produced by people inside the room. By knowing how much CO2 each person produces per minute, we can estimate the total CO2 in the room after a certain period. This helps us predict how CO2 levels will rise as people continue to breathe, ensuring the air quality is monitored and maintained.</p>
<p>As CO2 levels increase a number of health complaints can arise and these health complaints are CO2 concentration dependent. The Wisconsin Department of Health Services outline a ppm to health complaint table:</p>
<ul>
<li><p><strong>400 ppm:</strong> average outdoor air level.</p></li>
<li><p><strong>400–1,000 ppm:</strong> typical level found in occupied spaces with good air exchange.</p></li>
<li><p><strong>1,000–2,000 ppm:</strong> level associated with complaints of drowsiness and poor air.</p></li>
<li><p><strong>2,000–5,000 ppm:</strong> level associated with headaches, sleepiness, and stagnant, stale, stuffy air. Poor concentration, loss of attention, increased heart rate and slight nausea may also be present.</p></li>
<li><p><strong>5,000 ppm:</strong> this indicates unusual air conditions where high levels of other gases could also be present. Toxicity or oxygen deprivation could occur. This is the permissible exposure limit for daily workplace exposures.</p></li>
<li><p><strong>40,000 ppm:</strong> this level is immediately harmful due to oxygen deprivation.</p></li>
</ul>
<p>We also see plenty of examples of CO2 levels reaching dangerous levels in enclosed spaces and I am including images along with associated posts:</p>
<p>From <a href="https://vair-monitor.com/" class="uri">https://vair-monitor.com/</a>:</p>
<p><a href="V_Air_Monitor.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="V_Air_Monitor.png" class="img-fluid"></a></p>
<p>From <a href="https://cambridgecarbonfootprint.org/what-we-do/carbon-dioxide-monitoring/">https://cambridgecarbonfootprint.org/</a>:</p>
<p><a href="Cambridge_CO2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="Cambridge_CO2.png" class="img-fluid"></a></p>
<p>Now if we move to a more engineering based analysis we go to <a href="https://www.engineeringtoolbox.com/pollution-concentration-rooms-d_692.html" class="uri">https://www.engineeringtoolbox.com/pollution-concentration-rooms-d_692.html</a> and find that the carbon dioxide concentration in a room is a function of:</p>
<h1>CO2 Concentration Calculation</h1>
    <p>The carbon dioxide concentration in a room filled with persons after a time \( t \) can be calculated as:</p>
    <pre>c = (q / (n V)) [1 - (1 / e<sup>n t</sup>)] + (c<sub>0</sub> - c<sub>i</sub>) (1 / e<sup>n t</sup>) + c<sub>i</sub>                              
    </pre>
    <p>where:</p>
    <ul>
        <li><b>c</b> = carbon dioxide concentration in the room (m<sup>3</sup>/m<sup>3</sup>)</li>
        <li><b>q</b> = carbon dioxide supplied to the room (m<sup>3</sup>/h)</li>
        <li><b>V</b> = volume of the room (m<sup>3</sup>)</li>
        <li><b>e</b> = the constant 2.718...</li>
        <li><b>n</b> = number of air shifts per hour (1/h)</li>
        <li><b>t</b> = time (hour, h)</li>
        <li><b>c<sub>i</sub></b> = carbon dioxide concentration in the inlet ventilation air (m<sup>3</sup>/m<sup>3</sup>)</li>
        <li><b>c<sub>0</sub></b> = carbon dioxide concentration in the room at start, \( t=0 \) (m<sup>3</sup>/m<sup>3</sup>)</li>
    </ul>
<p>Calculator(the same formula as Engineering Toolbox): Defaults: 2 people, 10ft by 10ft room with 10ft feet ceilings, 1 air change per hour, and the makeup air is the standard 400ppm CO2. This is of course assuming absolutely no gaps and you’re truly enclosed. Worst case scenario and as this is not cited anywhere take with a grain of salt!</p>



    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CO2 Concentration Calculator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        form {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-top: 10px;
        }
        input {
            margin-top: 5px;
        }
        button {
            margin-top: 20px;
        }
    </style>


    <h1>CO2 Concentration Calculator</h1>
    <form id="co2-form">
        <label for="q">q - Carbon dioxide supplied to the room per person (m<sup>3</sup>/h person):</label>
        <input type="number" id="q" name="q" value="0.05" step="0.01" required=""><br><br>

        <label for="persons">Number of persons in the room:</label>
        <input type="number" id="persons" name="persons" value="2" required=""><br><br>

        <label for="V">V - Volume of the room (m<sup>3</sup>):</label>
        <input type="number" id="V" name="V" value="28.3168" required=""><br><br>

        <label for="n">n - Number of air shifts per hour (1/h):</label>
        <input type="number" id="n" name="n" value="0.125" step="0.01" required=""><br><br>

        <label for="t">t - Time (hour, h):</label>
        <input type="number" id="t" name="t" value="8" step="0.1" required=""><br><br>

        <label for="ci">ci - Carbon dioxide concentration in the make up air (m<sup>3</sup>/m<sup>3</sup>):</label>
        <input type="number" id="ci" name="ci" value="0.0004" step="0.0001" required=""><br><br>

        <label for="c0">c0 - Carbon dioxide concentration in the room at start, t=0 (m<sup>3</sup>/m<sup>3</sup>):</label>
        <input type="number" id="c0" name="c0" value="0.000" step="0.0001" required=""><br><br>

        <button type="button" onclick="calculateCO2()">Calculate</button>
    </form>

    <h2 class="anchored" data-anchor-id="co2-levels-in-an-enclosed-space">CO2 concentration: <span id="result">0.00657 m<sup>3</sup>/m<sup>3</sup> (6574 ppm)</span></h2>

    <script>
        function calculateCO2() {
            const q = parseFloat(document.getElementById('q').value);
            const persons = parseFloat(document.getElementById('persons').value);
            const V = parseFloat(document.getElementById('V').value);
            const n = parseFloat(document.getElementById('n').value);
            const t = parseFloat(document.getElementById('t').value);
            const ci = parseFloat(document.getElementById('ci').value);
            const c0 = parseFloat(document.getElementById('c0').value);
            const e = Math.E;

            const q_total = q * persons;
            const part1 = (q_total / (n * V)) * (1 - (1 / Math.pow(e, n * t)));
            const part2 = (c0 - ci) * (1 / Math.pow(e, n * t));
            const c = part1 + part2 + ci;

            const result = document.getElementById('result');
            result.innerHTML = `${c.toFixed(5)} m<sup>3</sup>/m<sup>3</sup> (${(c * 1000000).toFixed(0)} ppm)`;
        }
    </script>


<p>We also have a similar calculator here: <a href="https://www.soletairpower.fi/co2-calculator/" class="uri">https://www.soletairpower.fi/co2-calculator/</a></p>
<p>For a more scientifically based study one can navigate to the following: <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7411428/" class="uri">https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7411428/</a></p>
<p>The study gives a CO2 based occupancy estimation by correlating the levels of CO2 with the number of occupants in a room with the ultimate goal of reducing energy use by dynamically adjusting HVAC systems in real time. This means you don’t ventilate rooms that are unoccupied or ventilate less if they are under-occupied. Its probably possible to tease out a solid mathematical formula that could be put into a calculator, but that is time away from the goal of this article SCD41 and CO2 measurement.</p>
</section>
<section id="characteristics-of-ndir-sensors" class="level3">
<h3 class="anchored" data-anchor-id="characteristics-of-ndir-sensors">Characteristics of NDIR Sensors</h3>
<p>NDIR sensors measure CO2 by exploiting its property to absorb IR light at around 4.2 µm. They use a non-dispersive band-pass filter to allow only the relevant IR wavelengths to pass, hence the name Non-Dispersive Infrared. An image from <a href="https://en.wikipedia.org/wiki/Nondispersive_infrared_sensor">Wikipedia</a> below outlines various gases and their Mid-infrared absorption spectra:</p>
<p><a href="Mid-infrared_absorption_spectra_of_Gases.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="Mid-infrared_absorption_spectra_of_Gases.png" class="img-fluid"></a></p>
</section>
<section id="how-does-photoacoustic-ndir-work" class="level3">
<h3 class="anchored" data-anchor-id="how-does-photoacoustic-ndir-work">How does Photoacoustic NDIR Work?</h3>
<p>Photoacoustic Non-Dispersive Infrared (NDIR) technology is an advanced method used in sensors like the SCD41 to measure gas concentrations, such as CO2, using light and sound. Here’s a brief explanation of how it works:</p>
</section>
<section id="key-steps-in-photoacoustic-ndir" class="level3">
<h3 class="anchored" data-anchor-id="key-steps-in-photoacoustic-ndir">Key Steps in Photoacoustic NDIR</h3>
<ol type="1">
<li><p><strong>Infrared Light Source</strong>: An infrared (IR) light source emits light at wavelengths absorbed by CO2.</p></li>
<li><p><strong>Gas Absorption</strong>: CO2 molecules absorb this light, causing them to heat up and vibrate.</p></li>
<li><p><strong>Pressure Waves</strong>: The vibrations create tiny sound waves.</p></li>
<li><p><strong>Microphone Detection</strong>: A microphone detects these pressure waves.</p></li>
<li><p><strong>Signal Processing</strong>: The sensor converts these waves into electrical signals to determine CO2 concentration.</p></li>
<li><p><strong>Output</strong>: The final CO2 concentration is displayed for monitoring or further processing.</p></li>
</ol>
<p>This method offers high sensitivity and accuracy, making it suitable for real-time CO2 monitoring in various applications, including indoor air quality and industrial processes. The SCD41 sensor is compact, low-power, and cost-effective, ideal for integration into diverse systems.</p>
</section>
<section id="transmissive-ndir" class="level3">
<h3 class="anchored" data-anchor-id="transmissive-ndir">Transmissive NDIR</h3>
<p>These sensors feature an IR emitter and an optical detector at opposite ends of an optical cavity. Here’s a quick rundown of how they work:</p>
<ol type="1">
<li><p><strong>IR Emitter</strong>: Emits light through the gas sample.</p></li>
<li><p><strong>Absorption by CO2</strong>: CO2 absorbs specific wavelengths of the IR light.</p></li>
<li><p><strong>Detection</strong>: The detector measures the transmitted IR light.</p></li>
<li><p><strong>Calculation</strong>: CO2 concentration is calculated based on the difference in emitted and transmitted light.</p></li>
</ol>
<p>Transmissive NDIR sensors require precise positioning and minimal optical path length to ensure accurate readings.</p>
</section>
<section id="tvoc-sensors-and-eco2-readings" class="level3">
<h3 class="anchored" data-anchor-id="tvoc-sensors-and-eco2-readings">TVOC Sensors and eCO2 Readings</h3>
<p>Using Total Volatile Organic Compounds (TVOC) sensors, such as the Sensirion SGP30, to estimate CO2 levels is generally unreliable. TVOC sensors measure the concentration of various organic compounds in the air, which can include emissions from household products, cooking, cleaning agents, and even human breath. While these sensors are adept at detecting a wide range of VOCs, they are not designed to specifically measure CO2.</p>
<section id="why-tvoc-sensors-fall-short-for-co2-estimation" class="level4">
<h4 class="anchored" data-anchor-id="why-tvoc-sensors-fall-short-for-co2-estimation">Why TVOC Sensors Fall Short for CO2 Estimation</h4>
<ul>
<li><p><strong>Broad Detection Spectrum</strong>: TVOC sensors detect a broad range of organic compounds, not just CO2. This means they can be influenced by numerous sources of VOCs that are unrelated to CO2 levels, such as air fresheners, deodorizers, and various chemical products used indoors.</p></li>
<li><p><strong>Lack of Specificity</strong>: TVOC sensors lack the specificity required to accurately distinguish between CO2 and other VOCs. The presence of other VOCs can cause the sensor to give false indications of high CO2 levels.</p></li>
<li><p><strong>Environmental Factors</strong>: Various environmental factors such as temperature, humidity, and the presence of other gases can affect the readings of TVOC sensors, further complicating their accuracy when estimating CO2 levels.</p></li>
</ul>
<p>Despite these limitations, some vendors and manufacturers still promote TVOC sensors for CO2 estimation. This can be misleading for consumers who may believe they are getting accurate CO2 measurements. It is important for users to understand these limitations and consider more reliable methods, such as NDIR or photoacoustic sensors, for precise CO2 monitoring.</p>
</section>
<section id="recommended-use-of-tvoc-sensors" class="level4">
<h4 class="anchored" data-anchor-id="recommended-use-of-tvoc-sensors">Recommended Use of TVOC Sensors</h4>
<p>While TVOC sensors are not suitable for accurate CO2 measurement, they are valuable tools for:</p>
<ul>
<li><p><strong>Indoor Air Quality Monitoring</strong>: Detecting the presence of harmful VOCs and identifying sources of indoor air pollution.</p></li>
<li><p><strong>Health and Safety</strong>: Ensuring that indoor environments are free from harmful concentrations of volatile organic compounds.</p></li>
<li><p><strong>Industrial Applications</strong>: Monitoring air quality in industrial settings to ensure compliance with safety regulations.</p></li>
</ul>
</section>
</section>
<section id="comparing-low-cost-co2-sensors" class="level3">
<h3 class="anchored" data-anchor-id="comparing-low-cost-co2-sensors">Comparing Low-Cost CO2 Sensors</h3>
<section id="ndir-sensors" class="level4">
<h4 class="anchored" data-anchor-id="ndir-sensors">NDIR Sensors</h4>
<p>NDIR sensors measure CO2 based on gas absorption of IR light. They typically feature an IR emitter, dual channels for reference and measurement, and calculate CO2 concentration by comparing light absorption in these channels.</p>
</section>
<section id="photo-acoustic-sensors" class="level4">
<h4 class="anchored" data-anchor-id="photo-acoustic-sensors">Photo-Acoustic Sensors</h4>
<p>Photo-acoustic sensors also measure absorption but use a microphone to detect the resulting pressure waves. They are smaller and do not rely on line-of-sight, making them suitable for compact applications.</p>
<p>In the image below we can see a comparison of the photoacoustic and transmissive NDIR sensors:</p>
<p><a href="NDIR_Comparison.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="NDIR_Comparison.png" class="img-fluid"></a></p>
<p>Working Principle References:</p>
<p><a href="https://www.airgradient.com/blog/co2-sensors-photo-acoustic-vs-ndir/" class="uri">https://www.airgradient.com/blog/co2-sensors-photo-acoustic-vs-ndir/</a></p>
<p><a href="https://www.sensirion.com/resource/application_note/ndir-sensors-types" class="uri">https://www.sensirion.com/resource/application_note/ndir-sensors-types</a></p>
<p><a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7248969/" class="uri">https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7248969/</a></p>
</section>
</section>
<section id="setting-up-the-circuit" class="level3">
<h3 class="anchored" data-anchor-id="setting-up-the-circuit">Setting up the Circuit</h3>
<p>The circuit used here is fairly simple as the SCD41 has 4 inputs.</p>
<ul>
<li><p>GROUND = GND</p></li>
<li><p>Voltage_in = VDD</p></li>
<li><p>SCL = Serial Clock Line</p></li>
<li><p>SDA = Serial Data Line</p></li>
</ul>
<p>We also use an LCD to monitor the output and one switch to control calibration on startup(two switches for toggling wifi). For the sake of being able to recreate this fast with the same board here are the associated pin numbers and side.</p>
<p>SCD41</p>
<ul>
<li><p>SDA: 14-Left</p></li>
<li><p>SCL: 17-Left</p></li>
<li><p>VDD: 1-Right</p></li>
<li><p>GND: 19-Left</p></li>
</ul>
<p>Switch Calibration(Left Switch)</p>
<ul>
<li><p>Top(ON): 12-Right</p></li>
<li><p>GND: Ground Bar-Right</p></li>
<li><p>Bottom: N/A</p></li>
</ul>
<p>Switch Wifi(Right Switch)</p>
<ul>
<li><p>Top(ON): 13-Right</p></li>
<li><p>GND:Ground Bar - Right</p></li>
<li><p>Bottom: N/A</p></li>
</ul>
<p>LCD</p>
<ul>
<li><p>SDA:10-Left</p></li>
<li><p>SCL:7-Left</p></li>
<li><p>VCC: 12-Right</p></li>
<li><p>GND: Ground Bar-Right</p></li>
</ul>
<p>Buzzer</p>
<ul>
<li><p>15-Right</p></li>
<li><p>Ground Bar - Right</p></li>
</ul>
<p>Note that with some changes to the code one can omit the LCD and the switches, but being able to calibrate on the fly with fresh air is nice as is having an offline version of the sensor. Also note that at 3.3V the peak supply current is typical 175mA with a max of 205mA and at 5.0V typical is 115mA with a max of 137mA. I personally experienced many issues using the 3.3V and switched to 5V and experienced absolutely no issues.</p>
<p><a href="CircuitSetup_bb.jpg" class="lightbox" data-gallery="quarto-lightbox-gallery-5"><img src="CircuitSetup_bb.jpg" class="img-fluid"></a></p>
<p>The MicroPython library used is below. Simply open up the file in Thonny and save it to the device as SCD41.py so it can be imported in the main.py script. Note that the comments can be removed to cut down on space on your device. Implementing the Google Drive database and the ThingSpeak database are separate posts. See Raspberry Pi Sensor Server Project for more details on setting that up.</p>
<details>
<summary>
Library Code
</summary>
<div class="sourceCode" id="cb71"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1"></a><span class="co"># SCD41.py</span></span>
<span id="cb71-2"><a href="#cb71-2"></a><span class="co">#This code is pretty heavily based off of the Sensirion type code at: https://github.com/octaprog7/SCD4x</span></span>
<span id="cb71-3"><a href="#cb71-3"></a><span class="co"># And this library written by Sensirion: https://github.com/Sensirion/python-i2c-scd</span></span>
<span id="cb71-4"><a href="#cb71-4"></a><span class="co"># This file should be saved as SCD41.py and called as import SCD41. See main.py in this folder for an example usage.</span></span>
<span id="cb71-5"><a href="#cb71-5"></a><span class="im">import</span> time</span>
<span id="cb71-6"><a href="#cb71-6"></a><span class="im">import</span> math</span>
<span id="cb71-7"><a href="#cb71-7"></a><span class="im">from</span> machine <span class="im">import</span> SoftI2C, Pin, SPI</span>
<span id="cb71-8"><a href="#cb71-8"></a><span class="im">import</span> micropython</span>
<span id="cb71-9"><a href="#cb71-9"></a><span class="im">import</span> ustruct</span>
<span id="cb71-10"><a href="#cb71-10"></a></span>
<span id="cb71-11"><a href="#cb71-11"></a><span class="at">@micropython.native</span></span>
<span id="cb71-12"><a href="#cb71-12"></a><span class="kw">def</span> _calc_crc(sequence) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="cb71-13"><a href="#cb71-13"></a>    <span class="co">"""</span></span>
<span id="cb71-14"><a href="#cb71-14"></a><span class="co">    Calculate CRC-8 checksum for the given sequence.</span></span>
<span id="cb71-15"><a href="#cb71-15"></a><span class="co">    """</span></span>
<span id="cb71-16"><a href="#cb71-16"></a>    <span class="cf">return</span> crc8(sequence, polynomial<span class="op">=</span><span class="bn">0x31</span>, init_value<span class="op">=</span><span class="bn">0xFF</span>)</span>
<span id="cb71-17"><a href="#cb71-17"></a></span>
<span id="cb71-18"><a href="#cb71-18"></a><span class="at">@micropython.native</span></span>
<span id="cb71-19"><a href="#cb71-19"></a><span class="kw">def</span> check_value(value: <span class="bu">int</span>, valid_range, error_msg: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="cb71-20"><a href="#cb71-20"></a>    <span class="co">"""</span></span>
<span id="cb71-21"><a href="#cb71-21"></a><span class="co">    Check if the value is within the valid range. Raise ValueError if not.</span></span>
<span id="cb71-22"><a href="#cb71-22"></a><span class="co">    """</span></span>
<span id="cb71-23"><a href="#cb71-23"></a>    <span class="cf">if</span> value <span class="kw">not</span> <span class="kw">in</span> valid_range:</span>
<span id="cb71-24"><a href="#cb71-24"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(error_msg)</span>
<span id="cb71-25"><a href="#cb71-25"></a>    <span class="cf">return</span> value</span>
<span id="cb71-26"><a href="#cb71-26"></a></span>
<span id="cb71-27"><a href="#cb71-27"></a><span class="kw">class</span> Device:</span>
<span id="cb71-28"><a href="#cb71-28"></a>    <span class="co">"""Base class for devices."""</span></span>
<span id="cb71-29"><a href="#cb71-29"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, adapter, address: [<span class="bu">int</span>, SPI], big_byte_order: <span class="bu">bool</span>):</span>
<span id="cb71-30"><a href="#cb71-30"></a>        <span class="co">"""</span></span>
<span id="cb71-31"><a href="#cb71-31"></a><span class="co">        Initialize the device with adapter, address, and byte order.</span></span>
<span id="cb71-32"><a href="#cb71-32"></a><span class="co">        """</span></span>
<span id="cb71-33"><a href="#cb71-33"></a>        <span class="va">self</span>.adapter <span class="op">=</span> adapter</span>
<span id="cb71-34"><a href="#cb71-34"></a>        <span class="va">self</span>.address <span class="op">=</span> address</span>
<span id="cb71-35"><a href="#cb71-35"></a>        <span class="va">self</span>.big_byte_order <span class="op">=</span> big_byte_order</span>
<span id="cb71-36"><a href="#cb71-36"></a>        <span class="va">self</span>.msb_first <span class="op">=</span> <span class="va">True</span></span>
<span id="cb71-37"><a href="#cb71-37"></a></span>
<span id="cb71-38"><a href="#cb71-38"></a>    <span class="kw">def</span> _get_byteorder_as_str(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">tuple</span>:</span>
<span id="cb71-39"><a href="#cb71-39"></a>        <span class="co">"""</span></span>
<span id="cb71-40"><a href="#cb71-40"></a><span class="co">        Return the byte order as a string ('big' or 'little') and format character ('&gt;' or '&lt;').</span></span>
<span id="cb71-41"><a href="#cb71-41"></a><span class="co">        """</span></span>
<span id="cb71-42"><a href="#cb71-42"></a>        <span class="cf">if</span> <span class="va">self</span>.is_big_byteorder():</span>
<span id="cb71-43"><a href="#cb71-43"></a>            <span class="cf">return</span> <span class="st">'big'</span>, <span class="st">'&gt;'</span></span>
<span id="cb71-44"><a href="#cb71-44"></a>        <span class="cf">else</span>:</span>
<span id="cb71-45"><a href="#cb71-45"></a>            <span class="cf">return</span> <span class="st">'little'</span>, <span class="st">'&lt;'</span></span>
<span id="cb71-46"><a href="#cb71-46"></a></span>
<span id="cb71-47"><a href="#cb71-47"></a>    <span class="kw">def</span> unpack(<span class="va">self</span>, fmt_char: <span class="bu">str</span>, source: <span class="bu">bytes</span>, redefine_byte_order: <span class="bu">str</span> <span class="op">=</span> <span class="va">None</span>) <span class="op">-&gt;</span> <span class="bu">tuple</span>:</span>
<span id="cb71-48"><a href="#cb71-48"></a>        <span class="co">"""</span></span>
<span id="cb71-49"><a href="#cb71-49"></a><span class="co">        Unpack the given source bytes according to the format character and byte order.</span></span>
<span id="cb71-50"><a href="#cb71-50"></a><span class="co">        """</span></span>
<span id="cb71-51"><a href="#cb71-51"></a>        <span class="cf">if</span> <span class="kw">not</span> fmt_char:</span>
<span id="cb71-52"><a href="#cb71-52"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Invalid length fmt_char parameter: </span><span class="sc">{</span><span class="bu">len</span>(fmt_char)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb71-53"><a href="#cb71-53"></a>        bo <span class="op">=</span> <span class="va">self</span>._get_byteorder_as_str()[<span class="dv">1</span>]</span>
<span id="cb71-54"><a href="#cb71-54"></a>        <span class="cf">if</span> redefine_byte_order <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb71-55"><a href="#cb71-55"></a>            bo <span class="op">=</span> redefine_byte_order[<span class="dv">0</span>]</span>
<span id="cb71-56"><a href="#cb71-56"></a>        <span class="cf">return</span> ustruct.unpack(bo <span class="op">+</span> fmt_char, source)</span>
<span id="cb71-57"><a href="#cb71-57"></a></span>
<span id="cb71-58"><a href="#cb71-58"></a>    <span class="at">@micropython.native</span></span>
<span id="cb71-59"><a href="#cb71-59"></a>    <span class="kw">def</span> is_big_byteorder(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">bool</span>:</span>
<span id="cb71-60"><a href="#cb71-60"></a>        <span class="co">"""</span></span>
<span id="cb71-61"><a href="#cb71-61"></a><span class="co">        Check if the device uses big byte order.</span></span>
<span id="cb71-62"><a href="#cb71-62"></a><span class="co">        """</span></span>
<span id="cb71-63"><a href="#cb71-63"></a>        <span class="cf">return</span> <span class="va">self</span>.big_byte_order</span>
<span id="cb71-64"><a href="#cb71-64"></a></span>
<span id="cb71-65"><a href="#cb71-65"></a><span class="kw">class</span> BaseSensor(Device):</span>
<span id="cb71-66"><a href="#cb71-66"></a>    <span class="co">"""Base class for sensors."""</span></span>
<span id="cb71-67"><a href="#cb71-67"></a>    <span class="kw">def</span> get_id(<span class="va">self</span>):</span>
<span id="cb71-68"><a href="#cb71-68"></a>        <span class="cf">raise</span> <span class="pp">NotImplementedError</span></span>
<span id="cb71-69"><a href="#cb71-69"></a></span>
<span id="cb71-70"><a href="#cb71-70"></a>    <span class="kw">def</span> soft_reset(<span class="va">self</span>):</span>
<span id="cb71-71"><a href="#cb71-71"></a>        <span class="cf">raise</span> <span class="pp">NotImplementedError</span></span>
<span id="cb71-72"><a href="#cb71-72"></a></span>
<span id="cb71-73"><a href="#cb71-73"></a><span class="kw">class</span> Iterator:</span>
<span id="cb71-74"><a href="#cb71-74"></a>    <span class="co">"""Iterator class for sensors."""</span></span>
<span id="cb71-75"><a href="#cb71-75"></a>    <span class="kw">def</span> <span class="fu">__iter__</span>(<span class="va">self</span>):</span>
<span id="cb71-76"><a href="#cb71-76"></a>        <span class="cf">return</span> <span class="va">self</span></span>
<span id="cb71-77"><a href="#cb71-77"></a></span>
<span id="cb71-78"><a href="#cb71-78"></a>    <span class="kw">def</span> <span class="fu">__next__</span>(<span class="va">self</span>):</span>
<span id="cb71-79"><a href="#cb71-79"></a>        <span class="cf">raise</span> <span class="pp">NotImplementedError</span></span>
<span id="cb71-80"><a href="#cb71-80"></a></span>
<span id="cb71-81"><a href="#cb71-81"></a><span class="kw">class</span> BitField:</span>
<span id="cb71-82"><a href="#cb71-82"></a>    <span class="co">"""Class for working with bit fields."""</span></span>
<span id="cb71-83"><a href="#cb71-83"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, start: <span class="bu">int</span>, stop: <span class="bu">int</span>, alias: [<span class="bu">str</span>, <span class="va">None</span>]):</span>
<span id="cb71-84"><a href="#cb71-84"></a>        <span class="co">"""</span></span>
<span id="cb71-85"><a href="#cb71-85"></a><span class="co">        Initialize the bit field with start, stop, and alias.</span></span>
<span id="cb71-86"><a href="#cb71-86"></a><span class="co">        """</span></span>
<span id="cb71-87"><a href="#cb71-87"></a>        check(start, stop)</span>
<span id="cb71-88"><a href="#cb71-88"></a>        <span class="va">self</span>.alias <span class="op">=</span> alias</span>
<span id="cb71-89"><a href="#cb71-89"></a>        <span class="va">self</span>.start <span class="op">=</span> start</span>
<span id="cb71-90"><a href="#cb71-90"></a>        <span class="va">self</span>.stop <span class="op">=</span> stop</span>
<span id="cb71-91"><a href="#cb71-91"></a>        <span class="va">self</span>.bitmask <span class="op">=</span> _bitmask(start, stop)</span>
<span id="cb71-92"><a href="#cb71-92"></a></span>
<span id="cb71-93"><a href="#cb71-93"></a>    <span class="kw">def</span> put(<span class="va">self</span>, source: <span class="bu">int</span>, value: <span class="bu">int</span>) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="cb71-94"><a href="#cb71-94"></a>        <span class="co">"""</span></span>
<span id="cb71-95"><a href="#cb71-95"></a><span class="co">        Write the value to the specified bit range in the source.</span></span>
<span id="cb71-96"><a href="#cb71-96"></a><span class="co">        """</span></span>
<span id="cb71-97"><a href="#cb71-97"></a>        src <span class="op">=</span> source <span class="op">&amp;</span> <span class="op">~</span><span class="va">self</span>.bitmask</span>
<span id="cb71-98"><a href="#cb71-98"></a>        src <span class="op">|=</span> (value <span class="op">&lt;&lt;</span> <span class="va">self</span>.start) <span class="op">&amp;</span> <span class="va">self</span>.bitmask</span>
<span id="cb71-99"><a href="#cb71-99"></a>        <span class="cf">return</span> src</span>
<span id="cb71-100"><a href="#cb71-100"></a></span>
<span id="cb71-101"><a href="#cb71-101"></a>    <span class="kw">def</span> get(<span class="va">self</span>, source: <span class="bu">int</span>) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="cb71-102"><a href="#cb71-102"></a>        <span class="co">"""</span></span>
<span id="cb71-103"><a href="#cb71-103"></a><span class="co">        Get the value from the specified bit range in the source.</span></span>
<span id="cb71-104"><a href="#cb71-104"></a><span class="co">        """</span></span>
<span id="cb71-105"><a href="#cb71-105"></a>        <span class="cf">return</span> (source <span class="op">&amp;</span> <span class="va">self</span>.bitmask) <span class="op">&gt;&gt;</span> <span class="va">self</span>.start</span>
<span id="cb71-106"><a href="#cb71-106"></a></span>
<span id="cb71-107"><a href="#cb71-107"></a><span class="at">@micropython.native</span></span>
<span id="cb71-108"><a href="#cb71-108"></a><span class="kw">def</span> put(start: <span class="bu">int</span>, stop: <span class="bu">int</span>, source: <span class="bu">int</span>, value: <span class="bu">int</span>) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="cb71-109"><a href="#cb71-109"></a>    <span class="co">"""</span></span>
<span id="cb71-110"><a href="#cb71-110"></a><span class="co">    Write the value to the specified bit range in the source.</span></span>
<span id="cb71-111"><a href="#cb71-111"></a><span class="co">    """</span></span>
<span id="cb71-112"><a href="#cb71-112"></a>    check(start, stop)</span>
<span id="cb71-113"><a href="#cb71-113"></a>    bitmask <span class="op">=</span> _bitmask(start, stop)</span>
<span id="cb71-114"><a href="#cb71-114"></a>    src <span class="op">=</span> source <span class="op">&amp;</span> bitmask</span>
<span id="cb71-115"><a href="#cb71-115"></a>    src <span class="op">|=</span> (value <span class="op">&lt;&lt;</span> start) <span class="op">&amp;</span> bitmask</span>
<span id="cb71-116"><a href="#cb71-116"></a>    <span class="cf">return</span> src</span>
<span id="cb71-117"><a href="#cb71-117"></a></span>
<span id="cb71-118"><a href="#cb71-118"></a><span class="at">@micropython.native</span></span>
<span id="cb71-119"><a href="#cb71-119"></a><span class="kw">def</span> _bitmask(start: <span class="bu">int</span>, stop: <span class="bu">int</span>) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="cb71-120"><a href="#cb71-120"></a>    <span class="co">"""</span></span>
<span id="cb71-121"><a href="#cb71-121"></a><span class="co">    Generate a bitmask from start to stop bits.</span></span>
<span id="cb71-122"><a href="#cb71-122"></a><span class="co">    """</span></span>
<span id="cb71-123"><a href="#cb71-123"></a>    res <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb71-124"><a href="#cb71-124"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(start, <span class="dv">1</span> <span class="op">+</span> stop):</span>
<span id="cb71-125"><a href="#cb71-125"></a>        res <span class="op">|=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> i</span>
<span id="cb71-126"><a href="#cb71-126"></a>    <span class="cf">return</span> res</span>
<span id="cb71-127"><a href="#cb71-127"></a></span>
<span id="cb71-128"><a href="#cb71-128"></a><span class="kw">def</span> check(start: <span class="bu">int</span>, stop: <span class="bu">int</span>):</span>
<span id="cb71-129"><a href="#cb71-129"></a>    <span class="co">"""</span></span>
<span id="cb71-130"><a href="#cb71-130"></a><span class="co">    Check if start is less than or equal to stop. Raise ValueError if not.</span></span>
<span id="cb71-131"><a href="#cb71-131"></a><span class="co">    """</span></span>
<span id="cb71-132"><a href="#cb71-132"></a>    <span class="cf">if</span> start <span class="op">&gt;</span> stop:</span>
<span id="cb71-133"><a href="#cb71-133"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Invalid start: </span><span class="sc">{</span>start<span class="sc">}</span><span class="ss">, stop value: </span><span class="sc">{</span>stop<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb71-134"><a href="#cb71-134"></a></span>
<span id="cb71-135"><a href="#cb71-135"></a><span class="kw">def</span> _mpy_bl(value: <span class="bu">int</span>) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="cb71-136"><a href="#cb71-136"></a>    <span class="co">"""</span></span>
<span id="cb71-137"><a href="#cb71-137"></a><span class="co">    Calculate the bit length of the value.</span></span>
<span id="cb71-138"><a href="#cb71-138"></a><span class="co">    """</span></span>
<span id="cb71-139"><a href="#cb71-139"></a>    <span class="cf">if</span> <span class="dv">0</span> <span class="op">==</span> value:</span>
<span id="cb71-140"><a href="#cb71-140"></a>        <span class="cf">return</span> <span class="dv">0</span></span>
<span id="cb71-141"><a href="#cb71-141"></a>    <span class="cf">return</span> <span class="dv">1</span> <span class="op">+</span> <span class="bu">int</span>(math.log2(<span class="bu">abs</span>(value)))</span>
<span id="cb71-142"><a href="#cb71-142"></a></span>
<span id="cb71-143"><a href="#cb71-143"></a><span class="kw">class</span> BusAdapter:</span>
<span id="cb71-144"><a href="#cb71-144"></a>    <span class="co">"""Adapter class for bus communication."""</span></span>
<span id="cb71-145"><a href="#cb71-145"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, bus: [I2C, SPI]):</span>
<span id="cb71-146"><a href="#cb71-146"></a>        <span class="co">"""</span></span>
<span id="cb71-147"><a href="#cb71-147"></a><span class="co">        Initialize the adapter with the bus.</span></span>
<span id="cb71-148"><a href="#cb71-148"></a><span class="co">        """</span></span>
<span id="cb71-149"><a href="#cb71-149"></a>        <span class="va">self</span>.bus <span class="op">=</span> bus</span>
<span id="cb71-150"><a href="#cb71-150"></a></span>
<span id="cb71-151"><a href="#cb71-151"></a>    <span class="kw">def</span> get_bus_type(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">type</span>:</span>
<span id="cb71-152"><a href="#cb71-152"></a>        <span class="co">"""</span></span>
<span id="cb71-153"><a href="#cb71-153"></a><span class="co">        Return the type of the bus.</span></span>
<span id="cb71-154"><a href="#cb71-154"></a><span class="co">        """</span></span>
<span id="cb71-155"><a href="#cb71-155"></a>        <span class="cf">return</span> <span class="bu">type</span>(<span class="va">self</span>.bus)</span>
<span id="cb71-156"><a href="#cb71-156"></a></span>
<span id="cb71-157"><a href="#cb71-157"></a>    <span class="kw">def</span> read_register(<span class="va">self</span>, device_addr: [<span class="bu">int</span>, Pin], reg_addr: <span class="bu">int</span>, bytes_count: <span class="bu">int</span>) <span class="op">-&gt;</span> <span class="bu">bytes</span>:</span>
<span id="cb71-158"><a href="#cb71-158"></a>        <span class="cf">raise</span> <span class="pp">NotImplementedError</span></span>
<span id="cb71-159"><a href="#cb71-159"></a></span>
<span id="cb71-160"><a href="#cb71-160"></a>    <span class="kw">def</span> write_register(<span class="va">self</span>, device_addr: [<span class="bu">int</span>, Pin], reg_addr: <span class="bu">int</span>, value: [<span class="bu">int</span>, <span class="bu">bytes</span>, <span class="bu">bytearray</span>],</span>
<span id="cb71-161"><a href="#cb71-161"></a>                       bytes_count: <span class="bu">int</span>, byte_order: <span class="bu">str</span>):</span>
<span id="cb71-162"><a href="#cb71-162"></a>        <span class="cf">raise</span> <span class="pp">NotImplementedError</span></span>
<span id="cb71-163"><a href="#cb71-163"></a></span>
<span id="cb71-164"><a href="#cb71-164"></a>    <span class="kw">def</span> read(<span class="va">self</span>, device_addr: [<span class="bu">int</span>, Pin], n_bytes: <span class="bu">int</span>) <span class="op">-&gt;</span> <span class="bu">bytes</span>:</span>
<span id="cb71-165"><a href="#cb71-165"></a>        <span class="cf">raise</span> <span class="pp">NotImplementedError</span></span>
<span id="cb71-166"><a href="#cb71-166"></a></span>
<span id="cb71-167"><a href="#cb71-167"></a>    <span class="kw">def</span> write(<span class="va">self</span>, device_addr: [<span class="bu">int</span>, Pin], buf: <span class="bu">bytes</span>):</span>
<span id="cb71-168"><a href="#cb71-168"></a>        <span class="cf">raise</span> <span class="pp">NotImplementedError</span></span>
<span id="cb71-169"><a href="#cb71-169"></a></span>
<span id="cb71-170"><a href="#cb71-170"></a>    <span class="kw">def</span> write_const(<span class="va">self</span>, device_addr: [<span class="bu">int</span>, Pin], val: <span class="bu">int</span>, count: <span class="bu">int</span>):</span>
<span id="cb71-171"><a href="#cb71-171"></a>        <span class="co">"""</span></span>
<span id="cb71-172"><a href="#cb71-172"></a><span class="co">        Write a constant value to the device multiple times.</span></span>
<span id="cb71-173"><a href="#cb71-173"></a><span class="co">        """</span></span>
<span id="cb71-174"><a href="#cb71-174"></a>        <span class="cf">if</span> <span class="dv">0</span> <span class="op">==</span> count:</span>
<span id="cb71-175"><a href="#cb71-175"></a>            <span class="cf">return</span></span>
<span id="cb71-176"><a href="#cb71-176"></a>        bl <span class="op">=</span> _mpy_bl(val)</span>
<span id="cb71-177"><a href="#cb71-177"></a>        <span class="cf">if</span> bl <span class="op">&gt;</span> <span class="dv">8</span>:</span>
<span id="cb71-178"><a href="#cb71-178"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"The value must take no more than 8 bits! Current: </span><span class="sc">{</span>bl<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb71-179"><a href="#cb71-179"></a>        _max <span class="op">=</span> <span class="dv">16</span></span>
<span id="cb71-180"><a href="#cb71-180"></a>        <span class="cf">if</span> count <span class="op">&lt;</span> _max:</span>
<span id="cb71-181"><a href="#cb71-181"></a>            _max <span class="op">=</span> count</span>
<span id="cb71-182"><a href="#cb71-182"></a>        repeats <span class="op">=</span> count <span class="op">//</span> _max</span>
<span id="cb71-183"><a href="#cb71-183"></a>        b <span class="op">=</span> <span class="bu">bytearray</span>([val <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(_max)])</span>
<span id="cb71-184"><a href="#cb71-184"></a>        <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(repeats):</span>
<span id="cb71-185"><a href="#cb71-185"></a>            <span class="va">self</span>.write(device_addr, b)</span>
<span id="cb71-186"><a href="#cb71-186"></a>        remainder <span class="op">=</span> count <span class="op">-</span> _max <span class="op">*</span> repeats</span>
<span id="cb71-187"><a href="#cb71-187"></a>        <span class="cf">if</span> remainder:</span>
<span id="cb71-188"><a href="#cb71-188"></a>            b <span class="op">=</span> <span class="bu">bytearray</span>([val <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(remainder)])</span>
<span id="cb71-189"><a href="#cb71-189"></a>            <span class="va">self</span>.write(device_addr, b)</span>
<span id="cb71-190"><a href="#cb71-190"></a></span>
<span id="cb71-191"><a href="#cb71-191"></a><span class="kw">class</span> I2cAdapter(BusAdapter):</span>
<span id="cb71-192"><a href="#cb71-192"></a>    <span class="co">"""Adapter class for I2C bus communication."""</span></span>
<span id="cb71-193"><a href="#cb71-193"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, bus: I2C):</span>
<span id="cb71-194"><a href="#cb71-194"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(bus)</span>
<span id="cb71-195"><a href="#cb71-195"></a></span>
<span id="cb71-196"><a href="#cb71-196"></a>    <span class="kw">def</span> write_register(<span class="va">self</span>, device_addr: <span class="bu">int</span>, reg_addr: <span class="bu">int</span>, value: [<span class="bu">int</span>, <span class="bu">bytes</span>, <span class="bu">bytearray</span>],</span>
<span id="cb71-197"><a href="#cb71-197"></a>                       bytes_count: <span class="bu">int</span>, byte_order: <span class="bu">str</span>):</span>
<span id="cb71-198"><a href="#cb71-198"></a>        <span class="co">"""</span></span>
<span id="cb71-199"><a href="#cb71-199"></a><span class="co">        Write to the register of the device.</span></span>
<span id="cb71-200"><a href="#cb71-200"></a><span class="co">        """</span></span>
<span id="cb71-201"><a href="#cb71-201"></a>        buf <span class="op">=</span> <span class="va">None</span></span>
<span id="cb71-202"><a href="#cb71-202"></a>        <span class="cf">if</span> <span class="bu">isinstance</span>(value, <span class="bu">int</span>):</span>
<span id="cb71-203"><a href="#cb71-203"></a>            buf <span class="op">=</span> value.to_bytes(bytes_count, byte_order)</span>
<span id="cb71-204"><a href="#cb71-204"></a>        <span class="cf">if</span> <span class="bu">isinstance</span>(value, (<span class="bu">bytes</span>, <span class="bu">bytearray</span>)):</span>
<span id="cb71-205"><a href="#cb71-205"></a>            buf <span class="op">=</span> value</span>
<span id="cb71-206"><a href="#cb71-206"></a>        <span class="cf">return</span> <span class="va">self</span>.bus.writeto_mem(device_addr, reg_addr, buf)</span>
<span id="cb71-207"><a href="#cb71-207"></a></span>
<span id="cb71-208"><a href="#cb71-208"></a>    <span class="kw">def</span> read_register(<span class="va">self</span>, device_addr: <span class="bu">int</span>, reg_addr: <span class="bu">int</span>, bytes_count: <span class="bu">int</span>) <span class="op">-&gt;</span> <span class="bu">bytes</span>:</span>
<span id="cb71-209"><a href="#cb71-209"></a>        <span class="co">"""</span></span>
<span id="cb71-210"><a href="#cb71-210"></a><span class="co">        Read from the register of the device.</span></span>
<span id="cb71-211"><a href="#cb71-211"></a><span class="co">        """</span></span>
<span id="cb71-212"><a href="#cb71-212"></a>        <span class="cf">return</span> <span class="va">self</span>.bus.readfrom_mem(device_addr, reg_addr, bytes_count)</span>
<span id="cb71-213"><a href="#cb71-213"></a></span>
<span id="cb71-214"><a href="#cb71-214"></a>    <span class="kw">def</span> read(<span class="va">self</span>, device_addr: <span class="bu">int</span>, n_bytes: <span class="bu">int</span>) <span class="op">-&gt;</span> <span class="bu">bytes</span>:</span>
<span id="cb71-215"><a href="#cb71-215"></a>        <span class="co">"""</span></span>
<span id="cb71-216"><a href="#cb71-216"></a><span class="co">        Read bytes from the device.</span></span>
<span id="cb71-217"><a href="#cb71-217"></a><span class="co">        """</span></span>
<span id="cb71-218"><a href="#cb71-218"></a>        <span class="cf">return</span> <span class="va">self</span>.bus.readfrom(device_addr, n_bytes)</span>
<span id="cb71-219"><a href="#cb71-219"></a></span>
<span id="cb71-220"><a href="#cb71-220"></a>    <span class="kw">def</span> readfrom_into(<span class="va">self</span>, device_addr: <span class="bu">int</span>, buf):</span>
<span id="cb71-221"><a href="#cb71-221"></a>        <span class="co">"""</span></span>
<span id="cb71-222"><a href="#cb71-222"></a><span class="co">        Read bytes from the device into the buffer.</span></span>
<span id="cb71-223"><a href="#cb71-223"></a><span class="co">        """</span></span>
<span id="cb71-224"><a href="#cb71-224"></a>        <span class="cf">return</span> <span class="va">self</span>.bus.readfrom_into(device_addr, buf)</span>
<span id="cb71-225"><a href="#cb71-225"></a></span>
<span id="cb71-226"><a href="#cb71-226"></a>    <span class="kw">def</span> read_buf_from_mem(<span class="va">self</span>, device_addr: <span class="bu">int</span>, mem_addr, buf):</span>
<span id="cb71-227"><a href="#cb71-227"></a>        <span class="co">"""</span></span>
<span id="cb71-228"><a href="#cb71-228"></a><span class="co">        Read bytes from the device memory into the buffer.</span></span>
<span id="cb71-229"><a href="#cb71-229"></a><span class="co">        """</span></span>
<span id="cb71-230"><a href="#cb71-230"></a>        <span class="cf">return</span> <span class="va">self</span>.bus.readfrom_mem_into(device_addr, mem_addr, buf)</span>
<span id="cb71-231"><a href="#cb71-231"></a></span>
<span id="cb71-232"><a href="#cb71-232"></a>    <span class="kw">def</span> write(<span class="va">self</span>, device_addr: <span class="bu">int</span>, buf: <span class="bu">bytes</span>):</span>
<span id="cb71-233"><a href="#cb71-233"></a>        <span class="co">"""</span></span>
<span id="cb71-234"><a href="#cb71-234"></a><span class="co">        Write bytes to the device.</span></span>
<span id="cb71-235"><a href="#cb71-235"></a><span class="co">        """</span></span>
<span id="cb71-236"><a href="#cb71-236"></a>        <span class="cf">return</span> <span class="va">self</span>.bus.writeto(device_addr, buf)</span>
<span id="cb71-237"><a href="#cb71-237"></a></span>
<span id="cb71-238"><a href="#cb71-238"></a>    <span class="kw">def</span> write_buf_to_mem(<span class="va">self</span>, device_addr: <span class="bu">int</span>, mem_addr, buf):</span>
<span id="cb71-239"><a href="#cb71-239"></a>        <span class="co">"""</span></span>
<span id="cb71-240"><a href="#cb71-240"></a><span class="co">        Write bytes to the device memory.</span></span>
<span id="cb71-241"><a href="#cb71-241"></a><span class="co">        """</span></span>
<span id="cb71-242"><a href="#cb71-242"></a>        <span class="cf">return</span> <span class="va">self</span>.bus.writeto_mem(device_addr, mem_addr, buf)</span>
<span id="cb71-243"><a href="#cb71-243"></a></span>
<span id="cb71-244"><a href="#cb71-244"></a><span class="kw">class</span> SCD4xSensirion(BaseSensor, Iterator):</span>
<span id="cb71-245"><a href="#cb71-245"></a>    <span class="co">"""Class for SCD4x Sensirion CO2 sensor."""</span></span>
<span id="cb71-246"><a href="#cb71-246"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, adapter: I2cAdapter, address<span class="op">=</span><span class="bn">0x62</span>, this_is_scd41: <span class="bu">bool</span> <span class="op">=</span> <span class="va">True</span>, check_crc: <span class="bu">bool</span> <span class="op">=</span> <span class="va">True</span>):</span>
<span id="cb71-247"><a href="#cb71-247"></a>        <span class="co">"""</span></span>
<span id="cb71-248"><a href="#cb71-248"></a><span class="co">        Initialize the sensor with adapter, address, and settings.</span></span>
<span id="cb71-249"><a href="#cb71-249"></a><span class="co">        """</span></span>
<span id="cb71-250"><a href="#cb71-250"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(adapter, address, <span class="va">True</span>)</span>
<span id="cb71-251"><a href="#cb71-251"></a>        <span class="va">self</span>._buf_3 <span class="op">=</span> <span class="bu">bytearray</span>((<span class="dv">0</span> <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">3</span>)))</span>
<span id="cb71-252"><a href="#cb71-252"></a>        <span class="va">self</span>._buf_9 <span class="op">=</span> <span class="bu">bytearray</span>((<span class="dv">0</span> <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">9</span>)))</span>
<span id="cb71-253"><a href="#cb71-253"></a>        <span class="va">self</span>.check_crc <span class="op">=</span> check_crc</span>
<span id="cb71-254"><a href="#cb71-254"></a>        <span class="va">self</span>._low_power_mode <span class="op">=</span> <span class="va">False</span></span>
<span id="cb71-255"><a href="#cb71-255"></a>        <span class="va">self</span>._single_shot_mode <span class="op">=</span> <span class="va">False</span></span>
<span id="cb71-256"><a href="#cb71-256"></a>        <span class="va">self</span>._rht_only <span class="op">=</span> <span class="va">False</span></span>
<span id="cb71-257"><a href="#cb71-257"></a>        <span class="va">self</span>._isSCD41 <span class="op">=</span> this_is_scd41</span>
<span id="cb71-258"><a href="#cb71-258"></a>        <span class="va">self</span>.byte_order <span class="op">=</span> <span class="va">self</span>._get_byteorder_as_str()</span>
<span id="cb71-259"><a href="#cb71-259"></a></span>
<span id="cb71-260"><a href="#cb71-260"></a>    <span class="kw">def</span> _get_local_buf(<span class="va">self</span>, bytes_for_read: <span class="bu">int</span>) <span class="op">-&gt;</span> [<span class="va">None</span>, <span class="bu">bytearray</span>]:</span>
<span id="cb71-261"><a href="#cb71-261"></a>        <span class="co">"""</span></span>
<span id="cb71-262"><a href="#cb71-262"></a><span class="co">        Return the local buffer for reading.</span></span>
<span id="cb71-263"><a href="#cb71-263"></a><span class="co">        """</span></span>
<span id="cb71-264"><a href="#cb71-264"></a>        <span class="cf">if</span> bytes_for_read <span class="kw">not</span> <span class="kw">in</span> (<span class="dv">0</span>, <span class="dv">3</span>, <span class="dv">9</span>):</span>
<span id="cb71-265"><a href="#cb71-265"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Invalid value for bytes_for_read: </span><span class="sc">{</span>bytes_for_read<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb71-266"><a href="#cb71-266"></a>        <span class="cf">if</span> <span class="kw">not</span> bytes_for_read:</span>
<span id="cb71-267"><a href="#cb71-267"></a>            <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb71-268"><a href="#cb71-268"></a>        <span class="cf">if</span> <span class="dv">3</span> <span class="op">==</span> bytes_for_read:</span>
<span id="cb71-269"><a href="#cb71-269"></a>            <span class="cf">return</span> <span class="va">self</span>._buf_3</span>
<span id="cb71-270"><a href="#cb71-270"></a>        <span class="cf">return</span> <span class="va">self</span>._buf_9</span>
<span id="cb71-271"><a href="#cb71-271"></a></span>
<span id="cb71-272"><a href="#cb71-272"></a>    <span class="kw">def</span> _to_bytes(<span class="va">self</span>, value, length: <span class="bu">int</span>):</span>
<span id="cb71-273"><a href="#cb71-273"></a>        <span class="co">"""</span></span>
<span id="cb71-274"><a href="#cb71-274"></a><span class="co">        Convert value to bytes with specified length.</span></span>
<span id="cb71-275"><a href="#cb71-275"></a><span class="co">        """</span></span>
<span id="cb71-276"><a href="#cb71-276"></a>        byteorder <span class="op">=</span> <span class="va">self</span>.byte_order[<span class="dv">0</span>]</span>
<span id="cb71-277"><a href="#cb71-277"></a>        <span class="cf">return</span> value.to_bytes(length, byteorder)</span>
<span id="cb71-278"><a href="#cb71-278"></a></span>
<span id="cb71-279"><a href="#cb71-279"></a>    <span class="kw">def</span> _write(<span class="va">self</span>, buf: <span class="bu">bytes</span>) <span class="op">-&gt;</span> <span class="bu">bytes</span>:</span>
<span id="cb71-280"><a href="#cb71-280"></a>        <span class="co">"""</span></span>
<span id="cb71-281"><a href="#cb71-281"></a><span class="co">        Write buffer to the device.</span></span>
<span id="cb71-282"><a href="#cb71-282"></a><span class="co">        """</span></span>
<span id="cb71-283"><a href="#cb71-283"></a>        <span class="cf">return</span> <span class="va">self</span>.adapter.write(<span class="va">self</span>.address, buf)</span>
<span id="cb71-284"><a href="#cb71-284"></a></span>
<span id="cb71-285"><a href="#cb71-285"></a>    <span class="kw">def</span> _readfrom_into(<span class="va">self</span>, buf):</span>
<span id="cb71-286"><a href="#cb71-286"></a>        <span class="co">"""</span></span>
<span id="cb71-287"><a href="#cb71-287"></a><span class="co">        Read bytes from the device into the buffer.</span></span>
<span id="cb71-288"><a href="#cb71-288"></a><span class="co">        """</span></span>
<span id="cb71-289"><a href="#cb71-289"></a>        <span class="cf">return</span> <span class="va">self</span>.adapter.readfrom_into(<span class="va">self</span>.address, buf)</span>
<span id="cb71-290"><a href="#cb71-290"></a></span>
<span id="cb71-291"><a href="#cb71-291"></a>    <span class="kw">def</span> _send_command(<span class="va">self</span>, cmd: <span class="bu">int</span>, value: [<span class="bu">bytes</span>, <span class="va">None</span>], wait_time: <span class="bu">int</span> <span class="op">=</span> <span class="dv">0</span>, bytes_for_read: <span class="bu">int</span> <span class="op">=</span> <span class="dv">0</span>,</span>
<span id="cb71-292"><a href="#cb71-292"></a>                      crc_index: <span class="bu">range</span> <span class="op">=</span> <span class="va">None</span>, value_index: <span class="bu">tuple</span> <span class="op">=</span> <span class="va">None</span>) <span class="op">-&gt;</span> [<span class="bu">bytes</span>, <span class="va">None</span>]:</span>
<span id="cb71-293"><a href="#cb71-293"></a>        <span class="co">"""</span></span>
<span id="cb71-294"><a href="#cb71-294"></a><span class="co">        Send a command to the sensor.</span></span>
<span id="cb71-295"><a href="#cb71-295"></a><span class="co">        """</span></span>
<span id="cb71-296"><a href="#cb71-296"></a>        raw_cmd <span class="op">=</span> <span class="va">self</span>._to_bytes(cmd, <span class="dv">2</span>)</span>
<span id="cb71-297"><a href="#cb71-297"></a>        raw_out <span class="op">=</span> raw_cmd</span>
<span id="cb71-298"><a href="#cb71-298"></a>        <span class="cf">if</span> value:</span>
<span id="cb71-299"><a href="#cb71-299"></a>            raw_out <span class="op">+=</span> value</span>
<span id="cb71-300"><a href="#cb71-300"></a>            raw_out <span class="op">+=</span> <span class="va">self</span>._to_bytes(_calc_crc(value), <span class="dv">1</span>)</span>
<span id="cb71-301"><a href="#cb71-301"></a>        <span class="va">self</span>._write(raw_out)</span>
<span id="cb71-302"><a href="#cb71-302"></a>        <span class="cf">if</span> wait_time:</span>
<span id="cb71-303"><a href="#cb71-303"></a>            time.sleep_ms(wait_time)</span>
<span id="cb71-304"><a href="#cb71-304"></a>        <span class="cf">if</span> <span class="kw">not</span> bytes_for_read:</span>
<span id="cb71-305"><a href="#cb71-305"></a>            <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb71-306"><a href="#cb71-306"></a>        b <span class="op">=</span> <span class="va">self</span>._get_local_buf(bytes_for_read)</span>
<span id="cb71-307"><a href="#cb71-307"></a>        <span class="va">self</span>._readfrom_into(b)</span>
<span id="cb71-308"><a href="#cb71-308"></a>        check_value(<span class="bu">len</span>(b), (bytes_for_read,), <span class="ss">f"Invalid buffer length for cmd: </span><span class="sc">{</span>cmd<span class="sc">}</span><span class="ss">. Received </span><span class="sc">{</span><span class="bu">len</span>(b)<span class="sc">}</span><span class="ss"> out of </span><span class="sc">{</span>bytes_for_read<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb71-309"><a href="#cb71-309"></a>        <span class="cf">if</span> <span class="va">self</span>.check_crc:</span>
<span id="cb71-310"><a href="#cb71-310"></a>            crc_from_buf <span class="op">=</span> [b[i] <span class="cf">for</span> i <span class="kw">in</span> crc_index]</span>
<span id="cb71-311"><a href="#cb71-311"></a>            calculated_crc <span class="op">=</span> [_calc_crc(b[rng.start:rng.stop]) <span class="cf">for</span> rng <span class="kw">in</span> value_index]</span>
<span id="cb71-312"><a href="#cb71-312"></a>            <span class="cf">if</span> crc_from_buf <span class="op">!=</span> calculated_crc:</span>
<span id="cb71-313"><a href="#cb71-313"></a>                <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Invalid CRC! Calculated</span><span class="sc">{</span>calculated_crc<span class="sc">}</span><span class="ss">. From buffer </span><span class="sc">{</span>crc_from_buf<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb71-314"><a href="#cb71-314"></a>        <span class="cf">return</span> b</span>
<span id="cb71-315"><a href="#cb71-315"></a></span>
<span id="cb71-316"><a href="#cb71-316"></a>    <span class="kw">def</span> save_config(<span class="va">self</span>):</span>
<span id="cb71-317"><a href="#cb71-317"></a>        <span class="co">"""</span></span>
<span id="cb71-318"><a href="#cb71-318"></a><span class="co">        Save the sensor configuration to EEPROM.</span></span>
<span id="cb71-319"><a href="#cb71-319"></a><span class="co">        """</span></span>
<span id="cb71-320"><a href="#cb71-320"></a>        cmd <span class="op">=</span> <span class="bn">0x3615</span></span>
<span id="cb71-321"><a href="#cb71-321"></a>        <span class="va">self</span>._send_command(cmd, <span class="va">None</span>, <span class="dv">800</span>)</span>
<span id="cb71-322"><a href="#cb71-322"></a></span>
<span id="cb71-323"><a href="#cb71-323"></a>    <span class="kw">def</span> get_id(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">tuple</span>:</span>
<span id="cb71-324"><a href="#cb71-324"></a>        <span class="co">"""</span></span>
<span id="cb71-325"><a href="#cb71-325"></a><span class="co">        Get the unique serial number of the sensor.</span></span>
<span id="cb71-326"><a href="#cb71-326"></a><span class="co">        """</span></span>
<span id="cb71-327"><a href="#cb71-327"></a>        cmd <span class="op">=</span> <span class="bn">0x3682</span></span>
<span id="cb71-328"><a href="#cb71-328"></a>        b <span class="op">=</span> <span class="va">self</span>._send_command(cmd, <span class="va">None</span>, <span class="dv">0</span>, bytes_for_read<span class="op">=</span><span class="dv">9</span>,</span>
<span id="cb71-329"><a href="#cb71-329"></a>                               crc_index<span class="op">=</span><span class="bu">range</span>(<span class="dv">2</span>, <span class="dv">9</span>, <span class="dv">3</span>), value_index<span class="op">=</span>(<span class="bu">range</span>(<span class="dv">2</span>), <span class="bu">range</span>(<span class="dv">3</span>, <span class="dv">5</span>), <span class="bu">range</span>(<span class="dv">6</span>, <span class="dv">8</span>)))</span>
<span id="cb71-330"><a href="#cb71-330"></a>        <span class="cf">return</span> <span class="bu">tuple</span>([(b[i] <span class="op">&lt;&lt;</span> <span class="dv">8</span>) <span class="op">|</span> b[i<span class="op">+</span><span class="dv">1</span>] <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="dv">9</span>, <span class="dv">3</span>)])</span>
<span id="cb71-331"><a href="#cb71-331"></a></span>
<span id="cb71-332"><a href="#cb71-332"></a>    <span class="kw">def</span> soft_reset(<span class="va">self</span>):</span>
<span id="cb71-333"><a href="#cb71-333"></a>        <span class="co">"""</span></span>
<span id="cb71-334"><a href="#cb71-334"></a><span class="co">        Perform a soft reset of the sensor.</span></span>
<span id="cb71-335"><a href="#cb71-335"></a><span class="co">        """</span></span>
<span id="cb71-336"><a href="#cb71-336"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb71-337"><a href="#cb71-337"></a></span>
<span id="cb71-338"><a href="#cb71-338"></a>    <span class="kw">def</span> exec_self_test(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">bool</span>:</span>
<span id="cb71-339"><a href="#cb71-339"></a>        <span class="co">"""</span></span>
<span id="cb71-340"><a href="#cb71-340"></a><span class="co">        Execute self-test on the sensor. Returns True if successful.</span></span>
<span id="cb71-341"><a href="#cb71-341"></a><span class="co">        """</span></span>
<span id="cb71-342"><a href="#cb71-342"></a>        cmd <span class="op">=</span> <span class="bn">0x3639</span></span>
<span id="cb71-343"><a href="#cb71-343"></a>        length <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb71-344"><a href="#cb71-344"></a>        b <span class="op">=</span> <span class="va">self</span>._send_command(cmd, <span class="va">None</span>, wait_time<span class="op">=</span><span class="dv">10_000</span>,</span>
<span id="cb71-345"><a href="#cb71-345"></a>                               bytes_for_read<span class="op">=</span>length, crc_index<span class="op">=</span><span class="bu">range</span>(<span class="dv">2</span>, <span class="dv">3</span>), value_index<span class="op">=</span>(<span class="bu">range</span>(<span class="dv">2</span>),))</span>
<span id="cb71-346"><a href="#cb71-346"></a>        res <span class="op">=</span> <span class="va">self</span>.unpack(<span class="st">"H"</span>, b)[<span class="dv">0</span>]</span>
<span id="cb71-347"><a href="#cb71-347"></a>        <span class="cf">return</span> <span class="dv">0</span> <span class="op">==</span> res</span>
<span id="cb71-348"><a href="#cb71-348"></a></span>
<span id="cb71-349"><a href="#cb71-349"></a>    <span class="kw">def</span> reinit(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb71-350"><a href="#cb71-350"></a>        <span class="co">"""</span></span>
<span id="cb71-351"><a href="#cb71-351"></a><span class="co">        Reinitialize the sensor by reloading user settings from EEPROM.</span></span>
<span id="cb71-352"><a href="#cb71-352"></a><span class="co">        """</span></span>
<span id="cb71-353"><a href="#cb71-353"></a>        cmd <span class="op">=</span> <span class="bn">0x3646</span></span>
<span id="cb71-354"><a href="#cb71-354"></a>        <span class="va">self</span>._send_command(cmd, <span class="va">None</span>, <span class="dv">20</span>)</span>
<span id="cb71-355"><a href="#cb71-355"></a></span>
<span id="cb71-356"><a href="#cb71-356"></a>    <span class="kw">def</span> set_temperature_offset(<span class="va">self</span>, offset: <span class="bu">float</span>):</span>
<span id="cb71-357"><a href="#cb71-357"></a>        <span class="co">"""</span></span>
<span id="cb71-358"><a href="#cb71-358"></a><span class="co">        Set the temperature offset for the sensor.</span></span>
<span id="cb71-359"><a href="#cb71-359"></a><span class="co">        """</span></span>
<span id="cb71-360"><a href="#cb71-360"></a>        cmd <span class="op">=</span> <span class="bn">0x241D</span></span>
<span id="cb71-361"><a href="#cb71-361"></a>        offset_raw <span class="op">=</span> <span class="va">self</span>._to_bytes(<span class="bu">int</span>(<span class="fl">374.49142857</span> <span class="op">*</span> offset), <span class="dv">2</span>)</span>
<span id="cb71-362"><a href="#cb71-362"></a>        <span class="va">self</span>._send_command(cmd, offset_raw, <span class="dv">1</span>)</span>
<span id="cb71-363"><a href="#cb71-363"></a></span>
<span id="cb71-364"><a href="#cb71-364"></a>    <span class="kw">def</span> get_temperature_offset(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb71-365"><a href="#cb71-365"></a>        <span class="co">"""</span></span>
<span id="cb71-366"><a href="#cb71-366"></a><span class="co">        Get the temperature offset from the sensor.</span></span>
<span id="cb71-367"><a href="#cb71-367"></a><span class="co">        """</span></span>
<span id="cb71-368"><a href="#cb71-368"></a>        cmd <span class="op">=</span> <span class="bn">0x2318</span></span>
<span id="cb71-369"><a href="#cb71-369"></a>        b <span class="op">=</span> <span class="va">self</span>._send_command(cmd, <span class="va">None</span>, wait_time<span class="op">=</span><span class="dv">1</span>, bytes_for_read<span class="op">=</span><span class="dv">3</span>, crc_index<span class="op">=</span><span class="bu">range</span>(<span class="dv">2</span>, <span class="dv">3</span>), value_index<span class="op">=</span>(<span class="bu">range</span>(<span class="dv">2</span>),))</span>
<span id="cb71-370"><a href="#cb71-370"></a>        temp_offs <span class="op">=</span> <span class="va">self</span>.unpack(<span class="st">"H"</span>, b)[<span class="dv">0</span>]</span>
<span id="cb71-371"><a href="#cb71-371"></a>        <span class="cf">return</span> <span class="fl">0.0026702880859375</span> <span class="op">*</span> temp_offs</span>
<span id="cb71-372"><a href="#cb71-372"></a></span>
<span id="cb71-373"><a href="#cb71-373"></a>    <span class="kw">def</span> set_altitude(<span class="va">self</span>, masl: <span class="bu">int</span>):</span>
<span id="cb71-374"><a href="#cb71-374"></a>        <span class="co">"""</span></span>
<span id="cb71-375"><a href="#cb71-375"></a><span class="co">        Set the altitude for the sensor in meters above sea level.</span></span>
<span id="cb71-376"><a href="#cb71-376"></a><span class="co">        """</span></span>
<span id="cb71-377"><a href="#cb71-377"></a>        cmd <span class="op">=</span> <span class="bn">0x2427</span></span>
<span id="cb71-378"><a href="#cb71-378"></a>        masl_raw <span class="op">=</span> <span class="va">self</span>._to_bytes(masl, <span class="dv">2</span>)</span>
<span id="cb71-379"><a href="#cb71-379"></a>        <span class="va">self</span>._send_command(cmd, masl_raw, <span class="dv">1</span>)</span>
<span id="cb71-380"><a href="#cb71-380"></a></span>
<span id="cb71-381"><a href="#cb71-381"></a>    <span class="kw">def</span> get_altitude(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="cb71-382"><a href="#cb71-382"></a>        <span class="co">"""</span></span>
<span id="cb71-383"><a href="#cb71-383"></a><span class="co">        Get the altitude from the sensor in meters above sea level.</span></span>
<span id="cb71-384"><a href="#cb71-384"></a><span class="co">        """</span></span>
<span id="cb71-385"><a href="#cb71-385"></a>        cmd <span class="op">=</span> <span class="bn">0x2322</span></span>
<span id="cb71-386"><a href="#cb71-386"></a>        b <span class="op">=</span> <span class="va">self</span>._send_command(cmd, <span class="va">None</span>, wait_time<span class="op">=</span><span class="dv">1</span>, bytes_for_read<span class="op">=</span><span class="dv">3</span>, crc_index<span class="op">=</span><span class="bu">range</span>(<span class="dv">2</span>, <span class="dv">3</span>), value_index<span class="op">=</span>(<span class="bu">range</span>(<span class="dv">2</span>),))</span>
<span id="cb71-387"><a href="#cb71-387"></a>        <span class="cf">return</span> <span class="va">self</span>.unpack(<span class="st">"H"</span>, b)[<span class="dv">0</span>]</span>
<span id="cb71-388"><a href="#cb71-388"></a></span>
<span id="cb71-389"><a href="#cb71-389"></a>    <span class="kw">def</span> set_ambient_pressure(<span class="va">self</span>, pressure: <span class="bu">float</span>):</span>
<span id="cb71-390"><a href="#cb71-390"></a>        <span class="co">"""</span></span>
<span id="cb71-391"><a href="#cb71-391"></a><span class="co">        Set the ambient pressure for the sensor in Pascals.</span></span>
<span id="cb71-392"><a href="#cb71-392"></a><span class="co">        """</span></span>
<span id="cb71-393"><a href="#cb71-393"></a>        cmd <span class="op">=</span> <span class="bn">0xE000</span></span>
<span id="cb71-394"><a href="#cb71-394"></a>        press_raw <span class="op">=</span> <span class="va">self</span>._to_bytes(<span class="bu">int</span>(pressure <span class="op">//</span> <span class="dv">100</span>), <span class="dv">2</span>)</span>
<span id="cb71-395"><a href="#cb71-395"></a>        <span class="va">self</span>._send_command(cmd, press_raw, <span class="dv">1</span>)</span>
<span id="cb71-396"><a href="#cb71-396"></a></span>
<span id="cb71-397"><a href="#cb71-397"></a>    <span class="kw">def</span> force_recalibration(<span class="va">self</span>, target_co2_concentration: <span class="bu">int</span>) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="cb71-398"><a href="#cb71-398"></a>        <span class="co">"""</span></span>
<span id="cb71-399"><a href="#cb71-399"></a><span class="co">        Force recalibration of the sensor with the target CO2 concentration.</span></span>
<span id="cb71-400"><a href="#cb71-400"></a><span class="co">        """</span></span>
<span id="cb71-401"><a href="#cb71-401"></a>        check_value(target_co2_concentration, <span class="bu">range</span>(<span class="dv">2</span><span class="op">**</span><span class="dv">16</span>),</span>
<span id="cb71-402"><a href="#cb71-402"></a>                    <span class="ss">f"Invalid target CO2 concentration: </span><span class="sc">{</span>target_co2_concentration<span class="sc">}</span><span class="ss"> ppm"</span>)</span>
<span id="cb71-403"><a href="#cb71-403"></a>        cmd <span class="op">=</span> <span class="bn">0x362F</span></span>
<span id="cb71-404"><a href="#cb71-404"></a>        target_raw <span class="op">=</span> <span class="va">self</span>._to_bytes(target_co2_concentration, <span class="dv">2</span>)</span>
<span id="cb71-405"><a href="#cb71-405"></a>        b <span class="op">=</span> <span class="va">self</span>._send_command(cmd, target_raw, <span class="dv">400</span>, <span class="dv">3</span>, crc_index<span class="op">=</span><span class="bu">range</span>(<span class="dv">2</span>, <span class="dv">3</span>), value_index<span class="op">=</span>(<span class="bu">range</span>(<span class="dv">2</span>),))</span>
<span id="cb71-406"><a href="#cb71-406"></a>        <span class="cf">return</span> <span class="va">self</span>.unpack(<span class="st">"h"</span>, b)[<span class="dv">0</span>]</span>
<span id="cb71-407"><a href="#cb71-407"></a></span>
<span id="cb71-408"><a href="#cb71-408"></a>    <span class="kw">def</span> is_auto_calibration(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">bool</span>:</span>
<span id="cb71-409"><a href="#cb71-409"></a>        <span class="co">"""</span></span>
<span id="cb71-410"><a href="#cb71-410"></a><span class="co">        Check if automatic self-calibration is enabled on the sensor.</span></span>
<span id="cb71-411"><a href="#cb71-411"></a><span class="co">        """</span></span>
<span id="cb71-412"><a href="#cb71-412"></a>        cmd <span class="op">=</span> <span class="bn">0x2313</span></span>
<span id="cb71-413"><a href="#cb71-413"></a>        b <span class="op">=</span> <span class="va">self</span>._send_command(cmd, <span class="va">None</span>, <span class="dv">1</span>, <span class="dv">3</span>, crc_index<span class="op">=</span><span class="bu">range</span>(<span class="dv">2</span>, <span class="dv">3</span>), value_index<span class="op">=</span>(<span class="bu">range</span>(<span class="dv">2</span>),))</span>
<span id="cb71-414"><a href="#cb71-414"></a>        <span class="cf">return</span> <span class="dv">0</span> <span class="op">!=</span> <span class="va">self</span>.unpack(<span class="st">"H"</span>, b)[<span class="dv">0</span>]</span>
<span id="cb71-415"><a href="#cb71-415"></a></span>
<span id="cb71-416"><a href="#cb71-416"></a>    <span class="kw">def</span> set_auto_calibration(<span class="va">self</span>, value: <span class="bu">bool</span>):</span>
<span id="cb71-417"><a href="#cb71-417"></a>        <span class="co">"""</span></span>
<span id="cb71-418"><a href="#cb71-418"></a><span class="co">        Enable or disable automatic self-calibration on the sensor.</span></span>
<span id="cb71-419"><a href="#cb71-419"></a><span class="co">        """</span></span>
<span id="cb71-420"><a href="#cb71-420"></a>        cmd <span class="op">=</span> <span class="bn">0x2416</span></span>
<span id="cb71-421"><a href="#cb71-421"></a>        value_raw <span class="op">=</span> <span class="va">self</span>._to_bytes(value, <span class="dv">2</span>)</span>
<span id="cb71-422"><a href="#cb71-422"></a>        <span class="va">self</span>._send_command(cmd, value_raw, <span class="dv">1</span>, <span class="dv">3</span>)</span>
<span id="cb71-423"><a href="#cb71-423"></a></span>
<span id="cb71-424"><a href="#cb71-424"></a>    <span class="kw">def</span> set_measurement(<span class="va">self</span>, start: <span class="bu">bool</span>, single_shot: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span>, rht_only: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span>):</span>
<span id="cb71-425"><a href="#cb71-425"></a>        <span class="co">"""</span></span>
<span id="cb71-426"><a href="#cb71-426"></a><span class="co">        Start or stop periodic measurements, or perform a single shot measurement.</span></span>
<span id="cb71-427"><a href="#cb71-427"></a><span class="co">        """</span></span>
<span id="cb71-428"><a href="#cb71-428"></a>        <span class="cf">if</span> single_shot:</span>
<span id="cb71-429"><a href="#cb71-429"></a>            <span class="cf">return</span> <span class="va">self</span>._single_shot_meas(rht_only)</span>
<span id="cb71-430"><a href="#cb71-430"></a>        <span class="cf">return</span> <span class="va">self</span>._periodic_measurement(start)</span>
<span id="cb71-431"><a href="#cb71-431"></a></span>
<span id="cb71-432"><a href="#cb71-432"></a>    <span class="kw">def</span> _periodic_measurement(<span class="va">self</span>, start: <span class="bu">bool</span>):</span>
<span id="cb71-433"><a href="#cb71-433"></a>        <span class="co">"""</span></span>
<span id="cb71-434"><a href="#cb71-434"></a><span class="co">        Start or stop periodic measurements.</span></span>
<span id="cb71-435"><a href="#cb71-435"></a><span class="co">        """</span></span>
<span id="cb71-436"><a href="#cb71-436"></a>        wt <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb71-437"><a href="#cb71-437"></a>        <span class="cf">if</span> start:</span>
<span id="cb71-438"><a href="#cb71-438"></a>            cmd <span class="op">=</span> <span class="bn">0x21AC</span> <span class="cf">if</span> <span class="va">self</span>._low_power_mode <span class="cf">else</span> <span class="bn">0x21B1</span></span>
<span id="cb71-439"><a href="#cb71-439"></a>        <span class="cf">else</span>:</span>
<span id="cb71-440"><a href="#cb71-440"></a>            cmd <span class="op">=</span> <span class="bn">0x3F86</span></span>
<span id="cb71-441"><a href="#cb71-441"></a>            wt <span class="op">=</span> <span class="dv">500</span></span>
<span id="cb71-442"><a href="#cb71-442"></a>        <span class="va">self</span>._send_command(cmd, <span class="va">None</span>, wt)</span>
<span id="cb71-443"><a href="#cb71-443"></a>        <span class="va">self</span>._single_shot_mode <span class="op">=</span> <span class="va">False</span></span>
<span id="cb71-444"><a href="#cb71-444"></a>        <span class="va">self</span>._rht_only <span class="op">=</span> <span class="va">False</span></span>
<span id="cb71-445"><a href="#cb71-445"></a></span>
<span id="cb71-446"><a href="#cb71-446"></a>    <span class="kw">def</span> get_meas_data(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">tuple</span>:</span>
<span id="cb71-447"><a href="#cb71-447"></a>        <span class="co">"""</span></span>
<span id="cb71-448"><a href="#cb71-448"></a><span class="co">        Get the measurement data from the sensor (CO2, temperature, and humidity).</span></span>
<span id="cb71-449"><a href="#cb71-449"></a><span class="co">        """</span></span>
<span id="cb71-450"><a href="#cb71-450"></a>        cmd <span class="op">=</span> <span class="bn">0xEC05</span></span>
<span id="cb71-451"><a href="#cb71-451"></a>        val_index <span class="op">=</span> (<span class="bu">range</span>(<span class="dv">2</span>), <span class="bu">range</span>(<span class="dv">3</span>, <span class="dv">5</span>), <span class="bu">range</span>(<span class="dv">6</span>, <span class="dv">8</span>))</span>
<span id="cb71-452"><a href="#cb71-452"></a>        b <span class="op">=</span> <span class="va">self</span>._send_command(cmd, <span class="va">None</span>, <span class="dv">1</span>, bytes_for_read<span class="op">=</span><span class="dv">9</span>,</span>
<span id="cb71-453"><a href="#cb71-453"></a>                               crc_index<span class="op">=</span><span class="bu">range</span>(<span class="dv">2</span>, <span class="dv">9</span>, <span class="dv">3</span>), value_index<span class="op">=</span>val_index)</span>
<span id="cb71-454"><a href="#cb71-454"></a>        words <span class="op">=</span> [<span class="va">self</span>.unpack(<span class="st">"H"</span>, b[val_rng.start:val_rng.stop])[<span class="dv">0</span>] <span class="cf">for</span> val_rng <span class="kw">in</span> val_index]</span>
<span id="cb71-455"><a href="#cb71-455"></a>        <span class="cf">return</span> words[<span class="dv">0</span>], <span class="op">-</span><span class="dv">45</span> <span class="op">+</span> <span class="fl">0.0026703288</span> <span class="op">*</span> words[<span class="dv">1</span>], <span class="fl">0.0015259022</span> <span class="op">*</span> words[<span class="dv">2</span>]</span>
<span id="cb71-456"><a href="#cb71-456"></a></span>
<span id="cb71-457"><a href="#cb71-457"></a>    <span class="kw">def</span> is_data_ready(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">bool</span>:</span>
<span id="cb71-458"><a href="#cb71-458"></a>        <span class="co">"""</span></span>
<span id="cb71-459"><a href="#cb71-459"></a><span class="co">        Check if the measurement data is ready to be read from the sensor.</span></span>
<span id="cb71-460"><a href="#cb71-460"></a><span class="co">        """</span></span>
<span id="cb71-461"><a href="#cb71-461"></a>        cmd <span class="op">=</span> <span class="bn">0xE4B8</span></span>
<span id="cb71-462"><a href="#cb71-462"></a>        b <span class="op">=</span> <span class="va">self</span>._send_command(cmd, <span class="va">None</span>, <span class="dv">1</span>, <span class="dv">3</span>, crc_index<span class="op">=</span><span class="bu">range</span>(<span class="dv">2</span>, <span class="dv">3</span>), value_index<span class="op">=</span>(<span class="bu">range</span>(<span class="dv">2</span>),))</span>
<span id="cb71-463"><a href="#cb71-463"></a>        <span class="cf">return</span> <span class="bu">bool</span>(<span class="va">self</span>.unpack(<span class="st">"H"</span>, b)[<span class="dv">0</span>] <span class="op">&amp;</span> <span class="bn">0b0000_0111_1111_1111</span>)</span>
<span id="cb71-464"><a href="#cb71-464"></a></span>
<span id="cb71-465"><a href="#cb71-465"></a>    <span class="at">@micropython.native</span></span>
<span id="cb71-466"><a href="#cb71-466"></a>    <span class="kw">def</span> get_conversion_cycle_time(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="cb71-467"><a href="#cb71-467"></a>        <span class="co">"""</span></span>
<span id="cb71-468"><a href="#cb71-468"></a><span class="co">        Get the conversion cycle time of the sensor in milliseconds.</span></span>
<span id="cb71-469"><a href="#cb71-469"></a><span class="co">        """</span></span>
<span id="cb71-470"><a href="#cb71-470"></a>        <span class="cf">if</span> <span class="va">self</span>.is_single_shot_mode <span class="kw">and</span> <span class="va">self</span>.is_rht_only:</span>
<span id="cb71-471"><a href="#cb71-471"></a>            <span class="cf">return</span> <span class="dv">50</span></span>
<span id="cb71-472"><a href="#cb71-472"></a>        <span class="cf">return</span> <span class="dv">5000</span></span>
<span id="cb71-473"><a href="#cb71-473"></a></span>
<span id="cb71-474"><a href="#cb71-474"></a>    <span class="kw">def</span> set_power(<span class="va">self</span>, value: <span class="bu">bool</span>):</span>
<span id="cb71-475"><a href="#cb71-475"></a>        <span class="co">"""</span></span>
<span id="cb71-476"><a href="#cb71-476"></a><span class="co">        Power up or power down the sensor.</span></span>
<span id="cb71-477"><a href="#cb71-477"></a><span class="co">        """</span></span>
<span id="cb71-478"><a href="#cb71-478"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="va">self</span>._isSCD41:</span>
<span id="cb71-479"><a href="#cb71-479"></a>            <span class="cf">return</span></span>
<span id="cb71-480"><a href="#cb71-480"></a>        cmd <span class="op">=</span> <span class="bn">0x36F6</span> <span class="cf">if</span> value <span class="cf">else</span> <span class="bn">0x36E0</span></span>
<span id="cb71-481"><a href="#cb71-481"></a>        wt <span class="op">=</span> <span class="dv">20</span> <span class="cf">if</span> value <span class="cf">else</span> <span class="dv">1</span></span>
<span id="cb71-482"><a href="#cb71-482"></a>        <span class="va">self</span>._send_command(cmd, <span class="va">None</span>, wt)</span>
<span id="cb71-483"><a href="#cb71-483"></a></span>
<span id="cb71-484"><a href="#cb71-484"></a>    <span class="kw">def</span> _single_shot_meas(<span class="va">self</span>, rht_only: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span>):</span>
<span id="cb71-485"><a href="#cb71-485"></a>        <span class="co">"""</span></span>
<span id="cb71-486"><a href="#cb71-486"></a><span class="co">        Perform a single shot measurement.</span></span>
<span id="cb71-487"><a href="#cb71-487"></a><span class="co">        """</span></span>
<span id="cb71-488"><a href="#cb71-488"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="va">self</span>._isSCD41:</span>
<span id="cb71-489"><a href="#cb71-489"></a>            <span class="cf">return</span></span>
<span id="cb71-490"><a href="#cb71-490"></a>        cmd <span class="op">=</span> <span class="bn">0x2196</span> <span class="cf">if</span> rht_only <span class="cf">else</span> <span class="bn">0x219D</span></span>
<span id="cb71-491"><a href="#cb71-491"></a>        <span class="va">self</span>._send_command(cmd, <span class="va">None</span>, <span class="dv">0</span>)</span>
<span id="cb71-492"><a href="#cb71-492"></a>        <span class="va">self</span>._single_shot_mode <span class="op">=</span> <span class="va">True</span></span>
<span id="cb71-493"><a href="#cb71-493"></a>        <span class="va">self</span>._rht_only <span class="op">=</span> rht_only</span>
<span id="cb71-494"><a href="#cb71-494"></a></span>
<span id="cb71-495"><a href="#cb71-495"></a>    <span class="at">@property</span></span>
<span id="cb71-496"><a href="#cb71-496"></a>    <span class="kw">def</span> is_single_shot_mode(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">bool</span>:</span>
<span id="cb71-497"><a href="#cb71-497"></a>        <span class="co">"""</span></span>
<span id="cb71-498"><a href="#cb71-498"></a><span class="co">        Check if the sensor is in single shot mode.</span></span>
<span id="cb71-499"><a href="#cb71-499"></a><span class="co">        """</span></span>
<span id="cb71-500"><a href="#cb71-500"></a>        <span class="cf">return</span> <span class="va">self</span>._single_shot_mode</span>
<span id="cb71-501"><a href="#cb71-501"></a></span>
<span id="cb71-502"><a href="#cb71-502"></a>    <span class="at">@property</span></span>
<span id="cb71-503"><a href="#cb71-503"></a>    <span class="kw">def</span> is_rht_only(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">bool</span>:</span>
<span id="cb71-504"><a href="#cb71-504"></a>        <span class="co">"""</span></span>
<span id="cb71-505"><a href="#cb71-505"></a><span class="co">        Check if the sensor is in RHT-only mode.</span></span>
<span id="cb71-506"><a href="#cb71-506"></a><span class="co">        """</span></span>
<span id="cb71-507"><a href="#cb71-507"></a>        <span class="cf">return</span> <span class="va">self</span>._rht_only</span>
<span id="cb71-508"><a href="#cb71-508"></a></span>
<span id="cb71-509"><a href="#cb71-509"></a>    <span class="kw">def</span> <span class="fu">__iter__</span>(<span class="va">self</span>):</span>
<span id="cb71-510"><a href="#cb71-510"></a>        <span class="cf">return</span> <span class="va">self</span></span>
<span id="cb71-511"><a href="#cb71-511"></a></span>
<span id="cb71-512"><a href="#cb71-512"></a>    <span class="kw">def</span> <span class="fu">__next__</span>(<span class="va">self</span>) <span class="op">-&gt;</span> [<span class="bu">tuple</span>, <span class="va">None</span>]:</span>
<span id="cb71-513"><a href="#cb71-513"></a>        <span class="co">"""</span></span>
<span id="cb71-514"><a href="#cb71-514"></a><span class="co">        Get the next set of measurement data.</span></span>
<span id="cb71-515"><a href="#cb71-515"></a><span class="co">        """</span></span>
<span id="cb71-516"><a href="#cb71-516"></a>        <span class="cf">if</span> <span class="va">self</span>._single_shot_mode:</span>
<span id="cb71-517"><a href="#cb71-517"></a>            <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb71-518"><a href="#cb71-518"></a>        <span class="cf">if</span> <span class="va">self</span>.is_data_ready():</span>
<span id="cb71-519"><a href="#cb71-519"></a>            <span class="cf">return</span> <span class="va">self</span>.get_meas_data()</span>
<span id="cb71-520"><a href="#cb71-520"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb71-521"><a href="#cb71-521"></a></span>
<span id="cb71-522"><a href="#cb71-522"></a><span class="kw">def</span> pa_mmhg(value: <span class="bu">float</span>) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb71-523"><a href="#cb71-523"></a>    <span class="co">"""</span></span>
<span id="cb71-524"><a href="#cb71-524"></a><span class="co">    Convert air pressure from Pascals to millimeters of mercury.</span></span>
<span id="cb71-525"><a href="#cb71-525"></a><span class="co">    """</span></span>
<span id="cb71-526"><a href="#cb71-526"></a>    <span class="cf">return</span> <span class="fl">7.50062E-3</span> <span class="op">*</span> value</span>
<span id="cb71-527"><a href="#cb71-527"></a></span>
<span id="cb71-528"><a href="#cb71-528"></a><span class="kw">def</span> crc8(sequence, polynomial: <span class="bu">int</span>, init_value: <span class="bu">int</span> <span class="op">=</span> <span class="bn">0x00</span>):</span>
<span id="cb71-529"><a href="#cb71-529"></a>    <span class="co">"""</span></span>
<span id="cb71-530"><a href="#cb71-530"></a><span class="co">    Calculate CRC-8 checksum for the given sequence.</span></span>
<span id="cb71-531"><a href="#cb71-531"></a><span class="co">    """</span></span>
<span id="cb71-532"><a href="#cb71-532"></a>    mask <span class="op">=</span> <span class="bn">0xFF</span></span>
<span id="cb71-533"><a href="#cb71-533"></a>    crc <span class="op">=</span> init_value <span class="op">&amp;</span> mask</span>
<span id="cb71-534"><a href="#cb71-534"></a>    <span class="cf">for</span> item <span class="kw">in</span> sequence:</span>
<span id="cb71-535"><a href="#cb71-535"></a>        crc <span class="op">^=</span> item <span class="op">&amp;</span> mask</span>
<span id="cb71-536"><a href="#cb71-536"></a>        <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">8</span>):</span>
<span id="cb71-537"><a href="#cb71-537"></a>            <span class="cf">if</span> crc <span class="op">&amp;</span> <span class="bn">0x80</span>:</span>
<span id="cb71-538"><a href="#cb71-538"></a>                crc <span class="op">=</span> mask <span class="op">&amp;</span> ((crc <span class="op">&lt;&lt;</span> <span class="dv">1</span>) <span class="op">^</span> polynomial)</span>
<span id="cb71-539"><a href="#cb71-539"></a>            <span class="cf">else</span>:</span>
<span id="cb71-540"><a href="#cb71-540"></a>                crc <span class="op">=</span> mask <span class="op">&amp;</span> (crc <span class="op">&lt;&lt;</span> <span class="dv">1</span>)</span>
<span id="cb71-541"><a href="#cb71-541"></a>    <span class="cf">return</span> crc</span>
<span id="cb71-542"><a href="#cb71-542"></a></span>
<span id="cb71-543"><a href="#cb71-543"></a><span class="kw">def</span> check_device_presence(i2c, address):</span>
<span id="cb71-544"><a href="#cb71-544"></a>    <span class="co">"""</span></span>
<span id="cb71-545"><a href="#cb71-545"></a><span class="co">    Check if a device with the given address is present on the I2C bus.</span></span>
<span id="cb71-546"><a href="#cb71-546"></a><span class="co">    """</span></span>
<span id="cb71-547"><a href="#cb71-547"></a>    devices <span class="op">=</span> i2c.scan()</span>
<span id="cb71-548"><a href="#cb71-548"></a>    <span class="cf">return</span> address <span class="kw">in</span> devices</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p>And once you have that done run the following code below on your device or save it to main.py, whatever you’d like.</p>
<details>
<summary>
Main Code
</summary>
<div class="sourceCode" id="cb72"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1"></a><span class="co"># main.py</span></span>
<span id="cb72-2"><a href="#cb72-2"></a></span>
<span id="cb72-3"><a href="#cb72-3"></a><span class="im">from</span> machine <span class="im">import</span> SoftI2C, Pin</span>
<span id="cb72-4"><a href="#cb72-4"></a><span class="im">import</span> time</span>
<span id="cb72-5"><a href="#cb72-5"></a><span class="im">from</span> SCD41 <span class="im">import</span> SCD4xSensirion, I2cAdapter, check_device_presence</span>
<span id="cb72-6"><a href="#cb72-6"></a><span class="im">from</span> ssd1306 <span class="im">import</span> SSD1306_I2C  <span class="co"># Ensure you have the SSD1306 library</span></span>
<span id="cb72-7"><a href="#cb72-7"></a><span class="im">import</span> urequests <span class="im">as</span> requests</span>
<span id="cb72-8"><a href="#cb72-8"></a><span class="im">import</span> network</span>
<span id="cb72-9"><a href="#cb72-9"></a><span class="im">import</span> json</span>
<span id="cb72-10"><a href="#cb72-10"></a><span class="im">import</span> utime</span>
<span id="cb72-11"><a href="#cb72-11"></a><span class="im">import</span> usocket <span class="im">as</span> socket</span>
<span id="cb72-12"><a href="#cb72-12"></a><span class="im">import</span> ssl</span>
<span id="cb72-13"><a href="#cb72-13"></a><span class="im">import</span> ntptime</span>
<span id="cb72-14"><a href="#cb72-14"></a></span>
<span id="cb72-15"><a href="#cb72-15"></a><span class="co"># ThingSpeak settings</span></span>
<span id="cb72-16"><a href="#cb72-16"></a>THINGSPEAK_API_KEY <span class="op">=</span> <span class="st">'YOUR_KEY_HERE'</span></span>
<span id="cb72-17"><a href="#cb72-17"></a>THINGSPEAK_URL <span class="op">=</span> <span class="st">'https://api.thingspeak.com/update'</span></span>
<span id="cb72-18"><a href="#cb72-18"></a>THINGSPEAK_CHANNEL_ID <span class="op">=</span> <span class="st">'00000000'</span></span>
<span id="cb72-19"><a href="#cb72-19"></a>THINGSPEAK_BULK_UPDATE_URL <span class="op">=</span> <span class="st">'https://api.thingspeak.com/channels/'</span><span class="op">+</span><span class="bu">str</span>(THINGSPEAK_CHANNEL_ID)<span class="op">+</span><span class="st">'/bulk_update.json'</span></span>
<span id="cb72-20"><a href="#cb72-20"></a>SEND_TO_THINGSPEAK <span class="op">=</span> <span class="va">True</span></span>
<span id="cb72-21"><a href="#cb72-21"></a></span>
<span id="cb72-22"><a href="#cb72-22"></a>thingspeak_buffer <span class="op">=</span> []  <span class="co"># Buffer for ThingSpeak data</span></span>
<span id="cb72-23"><a href="#cb72-23"></a></span>
<span id="cb72-24"><a href="#cb72-24"></a><span class="co"># Google Sheets settings</span></span>
<span id="cb72-25"><a href="#cb72-25"></a>SPREADSHEET_ID <span class="op">=</span> <span class="st">'VERY_LONG_SPREADSHEET_ID_HERE'</span></span>
<span id="cb72-26"><a href="#cb72-26"></a>RANGE_NAME <span class="op">=</span> <span class="st">'Sheet1!A1:C1'</span></span>
<span id="cb72-27"><a href="#cb72-27"></a>SHEET_NAME <span class="op">=</span> <span class="st">'Sheet1'</span></span>
<span id="cb72-28"><a href="#cb72-28"></a>GOOGLE_URL <span class="op">=</span> <span class="st">'https://script.google.com/macros/s/VERY_LONG_URL/exec'</span></span>
<span id="cb72-29"><a href="#cb72-29"></a></span>
<span id="cb72-30"><a href="#cb72-30"></a><span class="co"># WiFi settings</span></span>
<span id="cb72-31"><a href="#cb72-31"></a>SSID <span class="op">=</span> <span class="st">'YOUR_SSID'</span></span>
<span id="cb72-32"><a href="#cb72-32"></a>PASSWORD <span class="op">=</span> <span class="st">'WIFI_PSWD'</span></span>
<span id="cb72-33"><a href="#cb72-33"></a></span>
<span id="cb72-34"><a href="#cb72-34"></a>switchOnWifi <span class="op">=</span> Pin(<span class="dv">32</span>, Pin.IN, Pin.PULL_UP)</span>
<span id="cb72-35"><a href="#cb72-35"></a>switchOnCalibrate <span class="op">=</span> Pin(<span class="dv">33</span>, Pin.IN, Pin.PULL_UP)</span>
<span id="cb72-36"><a href="#cb72-36"></a>buzzer <span class="op">=</span> Pin(<span class="dv">26</span>, Pin.OUT)</span>
<span id="cb72-37"><a href="#cb72-37"></a></span>
<span id="cb72-38"><a href="#cb72-38"></a>switch_state_calibrate <span class="op">=</span> switchOnCalibrate.value() <span class="co"># If switch is in up position we consider it on.</span></span>
<span id="cb72-39"><a href="#cb72-39"></a><span class="bu">print</span>(switch_state_calibrate)</span>
<span id="cb72-40"><a href="#cb72-40"></a></span>
<span id="cb72-41"><a href="#cb72-41"></a>switch_state_wifi <span class="op">=</span> switchOnWifi.value() <span class="co"># If switch is in up position we consider it on.</span></span>
<span id="cb72-42"><a href="#cb72-42"></a><span class="bu">print</span>(switch_state_wifi)</span>
<span id="cb72-43"><a href="#cb72-43"></a></span>
<span id="cb72-44"><a href="#cb72-44"></a><span class="cf">if</span> switch_state_calibrate <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb72-45"><a href="#cb72-45"></a>    <span class="bu">print</span>(<span class="st">"Calibration switch is on! Calibrating Device..."</span>)</span>
<span id="cb72-46"><a href="#cb72-46"></a><span class="cf">if</span> switch_state_wifi <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb72-47"><a href="#cb72-47"></a>    <span class="bu">print</span>(<span class="st">"Wifi switch is on! Will use Wifi..."</span>)</span>
<span id="cb72-48"><a href="#cb72-48"></a>    </span>
<span id="cb72-49"><a href="#cb72-49"></a><span class="co"># Setup GPIO for OLED power</span></span>
<span id="cb72-50"><a href="#cb72-50"></a>oled_power <span class="op">=</span> Pin(<span class="dv">19</span>, Pin.OUT)</span>
<span id="cb72-51"><a href="#cb72-51"></a></span>
<span id="cb72-52"><a href="#cb72-52"></a><span class="kw">def</span> connect_wifi(ssid, password):</span>
<span id="cb72-53"><a href="#cb72-53"></a>    wlan <span class="op">=</span> network.WLAN(network.STA_IF)</span>
<span id="cb72-54"><a href="#cb72-54"></a>    wlan.active(<span class="va">True</span>)</span>
<span id="cb72-55"><a href="#cb72-55"></a>    wlan.<span class="ex">connect</span>(ssid, password)</span>
<span id="cb72-56"><a href="#cb72-56"></a>    <span class="cf">while</span> <span class="kw">not</span> wlan.isconnected():</span>
<span id="cb72-57"><a href="#cb72-57"></a>        time.sleep(<span class="dv">1</span>)</span>
<span id="cb72-58"><a href="#cb72-58"></a>        <span class="bu">print</span>(<span class="st">"Connecting to WiFi..."</span>)</span>
<span id="cb72-59"><a href="#cb72-59"></a>    <span class="bu">print</span>(<span class="st">"Connected to WiFi"</span>)</span>
<span id="cb72-60"><a href="#cb72-60"></a>    <span class="bu">print</span>(wlan.ifconfig())</span>
<span id="cb72-61"><a href="#cb72-61"></a>    </span>
<span id="cb72-62"><a href="#cb72-62"></a><span class="kw">def</span> get_time_chicago():</span>
<span id="cb72-63"><a href="#cb72-63"></a>    max_retries <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb72-64"><a href="#cb72-64"></a>    <span class="cf">for</span> attempt <span class="kw">in</span> <span class="bu">range</span>(max_retries):</span>
<span id="cb72-65"><a href="#cb72-65"></a>        <span class="cf">try</span>:</span>
<span id="cb72-66"><a href="#cb72-66"></a>            ntptime.settime()</span>
<span id="cb72-67"><a href="#cb72-67"></a>            current_time <span class="op">=</span> utime.localtime()</span>
<span id="cb72-68"><a href="#cb72-68"></a>            <span class="cf">break</span></span>
<span id="cb72-69"><a href="#cb72-69"></a>        <span class="cf">except</span> <span class="pp">OSError</span> <span class="im">as</span> e:</span>
<span id="cb72-70"><a href="#cb72-70"></a>            <span class="bu">print</span>(<span class="ss">f"Failed to get NTP time, attempt </span><span class="sc">{</span>attempt <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="ss"> of </span><span class="sc">{</span>max_retries<span class="sc">}</span><span class="ss">. Error: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb72-71"><a href="#cb72-71"></a>            time.sleep(<span class="dv">1</span>)</span>
<span id="cb72-72"><a href="#cb72-72"></a>    <span class="cf">else</span>:</span>
<span id="cb72-73"><a href="#cb72-73"></a>        <span class="bu">print</span>(<span class="st">"Could not get NTP time, proceeding without time synchronization."</span>)</span>
<span id="cb72-74"><a href="#cb72-74"></a>        <span class="cf">return</span> utime.localtime()</span>
<span id="cb72-75"><a href="#cb72-75"></a></span>
<span id="cb72-76"><a href="#cb72-76"></a>    <span class="co"># Determine if it is daylight saving time (DST)</span></span>
<span id="cb72-77"><a href="#cb72-77"></a>    month <span class="op">=</span> current_time[<span class="dv">1</span>]</span>
<span id="cb72-78"><a href="#cb72-78"></a>    day <span class="op">=</span> current_time[<span class="dv">2</span>]</span>
<span id="cb72-79"><a href="#cb72-79"></a>    hour <span class="op">=</span> current_time[<span class="dv">3</span>]</span>
<span id="cb72-80"><a href="#cb72-80"></a>    <span class="cf">if</span> (month <span class="op">&gt;</span> <span class="dv">3</span> <span class="kw">and</span> month <span class="op">&lt;</span> <span class="dv">11</span>) <span class="kw">or</span> (month <span class="op">==</span> <span class="dv">3</span> <span class="kw">and</span> day <span class="op">&gt;=</span> <span class="dv">8</span> <span class="kw">and</span> hour <span class="op">&gt;=</span> <span class="dv">2</span>) <span class="kw">or</span> (month <span class="op">==</span> <span class="dv">11</span> <span class="kw">and</span> day <span class="op">&lt;</span> <span class="dv">1</span> <span class="kw">and</span> hour <span class="op">&lt;</span> <span class="dv">2</span>):</span>
<span id="cb72-81"><a href="#cb72-81"></a>        is_dst <span class="op">=</span> <span class="va">True</span></span>
<span id="cb72-82"><a href="#cb72-82"></a>    <span class="cf">else</span>:</span>
<span id="cb72-83"><a href="#cb72-83"></a>        is_dst <span class="op">=</span> <span class="va">False</span></span>
<span id="cb72-84"><a href="#cb72-84"></a>    </span>
<span id="cb72-85"><a href="#cb72-85"></a>    offset <span class="op">=</span> <span class="op">-</span><span class="dv">6</span> <span class="op">*</span> <span class="dv">3600</span> <span class="cf">if</span> <span class="kw">not</span> is_dst <span class="cf">else</span> <span class="op">-</span><span class="dv">5</span> <span class="op">*</span> <span class="dv">3600</span></span>
<span id="cb72-86"><a href="#cb72-86"></a>    local_time <span class="op">=</span> utime.mktime(current_time) <span class="op">+</span> offset</span>
<span id="cb72-87"><a href="#cb72-87"></a>    <span class="cf">return</span> utime.localtime(local_time)</span>
<span id="cb72-88"><a href="#cb72-88"></a></span>
<span id="cb72-89"><a href="#cb72-89"></a><span class="co"># Function to sound the buzzer</span></span>
<span id="cb72-90"><a href="#cb72-90"></a><span class="kw">def</span> sound_buzzer():</span>
<span id="cb72-91"><a href="#cb72-91"></a>    <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">5</span>):</span>
<span id="cb72-92"><a href="#cb72-92"></a>        buzzer.value(<span class="dv">1</span>)  <span class="co"># Turn on buzzer</span></span>
<span id="cb72-93"><a href="#cb72-93"></a>        time.sleep(<span class="fl">0.25</span>)  <span class="co"># 250 ms delay</span></span>
<span id="cb72-94"><a href="#cb72-94"></a>        buzzer.value(<span class="dv">0</span>)  <span class="co"># Turn off buzzer</span></span>
<span id="cb72-95"><a href="#cb72-95"></a>        time.sleep(<span class="fl">0.25</span>)  <span class="co"># 250 ms delay</span></span>
<span id="cb72-96"><a href="#cb72-96"></a></span>
<span id="cb72-97"><a href="#cb72-97"></a><span class="kw">def</span> send_data_to_google_sheets(data):</span>
<span id="cb72-98"><a href="#cb72-98"></a>    url <span class="op">=</span> GOOGLE_URL  <span class="co"># Define your Google URL here</span></span>
<span id="cb72-99"><a href="#cb72-99"></a>    headers <span class="op">=</span> {<span class="st">'Content-Type'</span>: <span class="st">'application/x-www-form-urlencoded'</span>}</span>
<span id="cb72-100"><a href="#cb72-100"></a>    encoded_data <span class="op">=</span> (</span>
<span id="cb72-101"><a href="#cb72-101"></a>        <span class="st">"Date="</span> <span class="op">+</span> data[<span class="st">'date'</span>] <span class="op">+</span></span>
<span id="cb72-102"><a href="#cb72-102"></a>        <span class="st">"&amp;Time="</span> <span class="op">+</span> data[<span class="st">'time'</span>] <span class="op">+</span></span>
<span id="cb72-103"><a href="#cb72-103"></a>        <span class="st">"&amp;CO2="</span> <span class="op">+</span> <span class="bu">str</span>(data[<span class="st">'co2'</span>]) <span class="op">+</span></span>
<span id="cb72-104"><a href="#cb72-104"></a>        <span class="st">"&amp;Temperature="</span> <span class="op">+</span> <span class="bu">str</span>(data[<span class="st">'temp_f'</span>]) <span class="op">+</span></span>
<span id="cb72-105"><a href="#cb72-105"></a>        <span class="st">"&amp;Humidity="</span> <span class="op">+</span> <span class="bu">str</span>(data[<span class="st">'humidity'</span>])</span>
<span id="cb72-106"><a href="#cb72-106"></a>    )</span>
<span id="cb72-107"><a href="#cb72-107"></a>    <span class="cf">try</span>:</span>
<span id="cb72-108"><a href="#cb72-108"></a>        <span class="co"># Extract host and path from URL</span></span>
<span id="cb72-109"><a href="#cb72-109"></a>        _, _, host, path <span class="op">=</span> url.split(<span class="st">'/'</span>, <span class="dv">3</span>)</span>
<span id="cb72-110"><a href="#cb72-110"></a>        </span>
<span id="cb72-111"><a href="#cb72-111"></a>        <span class="co"># Set up a socket connection</span></span>
<span id="cb72-112"><a href="#cb72-112"></a>        addr <span class="op">=</span> socket.getaddrinfo(host, <span class="dv">443</span>)[<span class="dv">0</span>][<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb72-113"><a href="#cb72-113"></a>        s <span class="op">=</span> socket.socket()</span>
<span id="cb72-114"><a href="#cb72-114"></a>        s.<span class="ex">connect</span>(addr)</span>
<span id="cb72-115"><a href="#cb72-115"></a>        s <span class="op">=</span> ssl.wrap_socket(s)</span>
<span id="cb72-116"><a href="#cb72-116"></a>        </span>
<span id="cb72-117"><a href="#cb72-117"></a>        <span class="co"># Create the HTTP request manually</span></span>
<span id="cb72-118"><a href="#cb72-118"></a>        request <span class="op">=</span> <span class="ss">f"POST /</span><span class="sc">{</span>path<span class="sc">}</span><span class="ss"> HTTP/1.1</span><span class="ch">\r\n</span><span class="ss">Host: </span><span class="sc">{</span>host<span class="sc">}</span><span class="ch">\r\n</span><span class="ss">"</span></span>
<span id="cb72-119"><a href="#cb72-119"></a>        request <span class="op">+=</span> <span class="st">"Content-Type: application/x-www-form-urlencoded</span><span class="ch">\r\n</span><span class="st">"</span></span>
<span id="cb72-120"><a href="#cb72-120"></a>        request <span class="op">+=</span> <span class="ss">f"Content-Length: </span><span class="sc">{</span><span class="bu">len</span>(encoded_data)<span class="sc">}</span><span class="ch">\r\n\r\n</span><span class="ss">"</span></span>
<span id="cb72-121"><a href="#cb72-121"></a>        request <span class="op">+=</span> encoded_data</span>
<span id="cb72-122"><a href="#cb72-122"></a></span>
<span id="cb72-123"><a href="#cb72-123"></a>        <span class="co"># Send the request</span></span>
<span id="cb72-124"><a href="#cb72-124"></a>        s.write(request)</span>
<span id="cb72-125"><a href="#cb72-125"></a>        </span>
<span id="cb72-126"><a href="#cb72-126"></a>        <span class="co"># Close the socket</span></span>
<span id="cb72-127"><a href="#cb72-127"></a>        s.close()</span>
<span id="cb72-128"><a href="#cb72-128"></a>        <span class="bu">print</span>(<span class="st">'Data sent to Google Sheets!'</span>)</span>
<span id="cb72-129"><a href="#cb72-129"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb72-130"><a href="#cb72-130"></a>        <span class="bu">print</span>(<span class="st">'Failed to send data to Google Sheets:'</span>, e)</span>
<span id="cb72-131"><a href="#cb72-131"></a>        </span>
<span id="cb72-132"><a href="#cb72-132"></a><span class="kw">def</span> send_data_to_thingspeak():</span>
<span id="cb72-133"><a href="#cb72-133"></a>    <span class="co">"""Send data to ThingSpeak."""</span></span>
<span id="cb72-134"><a href="#cb72-134"></a>    <span class="cf">if</span> SEND_TO_THINGSPEAK <span class="kw">and</span> thingspeak_buffer:</span>
<span id="cb72-135"><a href="#cb72-135"></a>        <span class="cf">if</span> <span class="bu">len</span>(thingspeak_buffer) <span class="op">&gt;</span> <span class="dv">1</span>:</span>
<span id="cb72-136"><a href="#cb72-136"></a>            <span class="co"># Bulk update</span></span>
<span id="cb72-137"><a href="#cb72-137"></a>            payload <span class="op">=</span> {</span>
<span id="cb72-138"><a href="#cb72-138"></a>                <span class="st">'write_api_key'</span>: THINGSPEAK_API_KEY,</span>
<span id="cb72-139"><a href="#cb72-139"></a>                <span class="st">'updates'</span>: []</span>
<span id="cb72-140"><a href="#cb72-140"></a>            }</span>
<span id="cb72-141"><a href="#cb72-141"></a>            <span class="cf">for</span> data <span class="kw">in</span> thingspeak_buffer:</span>
<span id="cb72-142"><a href="#cb72-142"></a>                update <span class="op">=</span> {</span>
<span id="cb72-143"><a href="#cb72-143"></a>                    <span class="st">'created_at'</span>: <span class="ss">f"</span><span class="sc">{</span>data[<span class="st">'date'</span>]<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>data[<span class="st">'time'</span>]<span class="sc">}</span><span class="ss"> -0500"</span>,</span>
<span id="cb72-144"><a href="#cb72-144"></a>                    <span class="st">'field1'</span>: data[<span class="st">'co2'</span>],</span>
<span id="cb72-145"><a href="#cb72-145"></a>                    <span class="st">'field2'</span>: data[<span class="st">'temp_f'</span>],</span>
<span id="cb72-146"><a href="#cb72-146"></a>                    <span class="st">'field3'</span>: data[<span class="st">'humidity'</span>]</span>
<span id="cb72-147"><a href="#cb72-147"></a>                }</span>
<span id="cb72-148"><a href="#cb72-148"></a>                payload[<span class="st">'updates'</span>].append(update)</span>
<span id="cb72-149"><a href="#cb72-149"></a></span>
<span id="cb72-150"><a href="#cb72-150"></a>            <span class="cf">try</span>:</span>
<span id="cb72-151"><a href="#cb72-151"></a>                headers <span class="op">=</span> {<span class="st">'Content-Type'</span>: <span class="st">'application/json'</span>}</span>
<span id="cb72-152"><a href="#cb72-152"></a>                json_data <span class="op">=</span> json.dumps(payload)</span>
<span id="cb72-153"><a href="#cb72-153"></a>                response <span class="op">=</span> requests.post(THINGSPEAK_BULK_UPDATE_URL, headers<span class="op">=</span>headers, data<span class="op">=</span>json_data)</span>
<span id="cb72-154"><a href="#cb72-154"></a>                <span class="cf">if</span> response.status_code <span class="op">==</span> <span class="dv">202</span>:</span>
<span id="cb72-155"><a href="#cb72-155"></a>                    <span class="bu">print</span>(<span class="st">'Data posted to ThingSpeak (bulk update):'</span>, response.text)</span>
<span id="cb72-156"><a href="#cb72-156"></a>                    thingspeak_buffer.clear()  <span class="co"># Clear the buffer after successful update</span></span>
<span id="cb72-157"><a href="#cb72-157"></a>                <span class="cf">else</span>:</span>
<span id="cb72-158"><a href="#cb72-158"></a>                    <span class="bu">print</span>(<span class="ss">f'Failed to send data to ThingSpeak (bulk update): </span><span class="sc">{</span>response<span class="sc">.</span>status_code<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>response<span class="sc">.</span>text<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb72-159"><a href="#cb72-159"></a>            <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb72-160"><a href="#cb72-160"></a>                <span class="bu">print</span>(<span class="st">'Failed to send data to ThingSpeak (bulk update):'</span>, e)</span>
<span id="cb72-161"><a href="#cb72-161"></a>        <span class="cf">else</span>:</span>
<span id="cb72-162"><a href="#cb72-162"></a>            data <span class="op">=</span> thingspeak_buffer.pop(<span class="dv">0</span>)  <span class="co"># Get the first item in the buffer</span></span>
<span id="cb72-163"><a href="#cb72-163"></a>            payload <span class="op">=</span> {</span>
<span id="cb72-164"><a href="#cb72-164"></a>                <span class="st">'api_key'</span>: THINGSPEAK_API_KEY,</span>
<span id="cb72-165"><a href="#cb72-165"></a>                <span class="st">'field1'</span>: data[<span class="st">'co2'</span>],</span>
<span id="cb72-166"><a href="#cb72-166"></a>                <span class="st">'field2'</span>: data[<span class="st">'temp_f'</span>],</span>
<span id="cb72-167"><a href="#cb72-167"></a>                <span class="st">'field3'</span>: data[<span class="st">'humidity'</span>]</span>
<span id="cb72-168"><a href="#cb72-168"></a>            }</span>
<span id="cb72-169"><a href="#cb72-169"></a>            <span class="cf">try</span>:</span>
<span id="cb72-170"><a href="#cb72-170"></a>                response <span class="op">=</span> requests.post(THINGSPEAK_URL, json<span class="op">=</span>payload)</span>
<span id="cb72-171"><a href="#cb72-171"></a>                <span class="cf">if</span> response.status_code <span class="op">==</span> <span class="dv">200</span>:</span>
<span id="cb72-172"><a href="#cb72-172"></a>                    <span class="bu">print</span>(<span class="st">'Data posted to ThingSpeak:'</span>, response.text)</span>
<span id="cb72-173"><a href="#cb72-173"></a>                <span class="cf">else</span>:</span>
<span id="cb72-174"><a href="#cb72-174"></a>                    <span class="bu">print</span>(<span class="ss">f'Failed to send data to ThingSpeak: </span><span class="sc">{</span>response<span class="sc">.</span>status_code<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>response<span class="sc">.</span>text<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb72-175"><a href="#cb72-175"></a>            <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb72-176"><a href="#cb72-176"></a>                <span class="bu">print</span>(<span class="st">'Failed to send data to ThingSpeak:'</span>, e)</span>
<span id="cb72-177"><a href="#cb72-177"></a></span>
<span id="cb72-178"><a href="#cb72-178"></a><span class="kw">def</span> get_sensor_reading(sensor, conversion_cycle_time,last_update_sensor):</span>
<span id="cb72-179"><a href="#cb72-179"></a>    <span class="co">"""Get a single sensor reading with a delay equal to the conversion cycle time."""</span></span>
<span id="cb72-180"><a href="#cb72-180"></a>    update <span class="op">=</span> <span class="va">False</span></span>
<span id="cb72-181"><a href="#cb72-181"></a>    <span class="cf">while</span> update <span class="op">==</span> <span class="va">False</span>:</span>
<span id="cb72-182"><a href="#cb72-182"></a>        <span class="bu">print</span>(time.time() <span class="op">-</span> last_update_sensor)</span>
<span id="cb72-183"><a href="#cb72-183"></a>        <span class="cf">if</span> time.time() <span class="op">-</span> last_update_sensor <span class="op">&gt;=</span><span class="dv">30</span>:       </span>
<span id="cb72-184"><a href="#cb72-184"></a>            <span class="cf">try</span>:</span>
<span id="cb72-185"><a href="#cb72-185"></a><span class="co">#                 time.sleep_ms(conversion_cycle_time) #I want more fine grained timing of updating the sensor and sending the data so I don't run into power spikes...</span></span>
<span id="cb72-186"><a href="#cb72-186"></a>                <span class="cf">if</span> sensor.is_data_ready():</span>
<span id="cb72-187"><a href="#cb72-187"></a>                    update<span class="op">=</span><span class="va">True</span></span>
<span id="cb72-188"><a href="#cb72-188"></a>                    <span class="cf">return</span> sensor.get_meas_data()</span>
<span id="cb72-189"><a href="#cb72-189"></a>                <span class="cf">else</span>:</span>
<span id="cb72-190"><a href="#cb72-190"></a>                    <span class="bu">print</span>(<span class="st">"Data not ready."</span>)</span>
<span id="cb72-191"><a href="#cb72-191"></a>                    update<span class="op">=</span><span class="va">False</span></span>
<span id="cb72-192"><a href="#cb72-192"></a>                    time.sleep(<span class="dv">1</span>)</span>
<span id="cb72-193"><a href="#cb72-193"></a>                    <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb72-194"><a href="#cb72-194"></a>                    </span>
<span id="cb72-195"><a href="#cb72-195"></a>            <span class="cf">except</span> <span class="pp">OSError</span> <span class="im">as</span> e:</span>
<span id="cb72-196"><a href="#cb72-196"></a>                <span class="bu">print</span>(<span class="ss">f"Error during sensor reading: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb72-197"><a href="#cb72-197"></a>                update<span class="op">=</span><span class="va">True</span></span>
<span id="cb72-198"><a href="#cb72-198"></a>                <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb72-199"><a href="#cb72-199"></a>        <span class="cf">else</span>:</span>
<span id="cb72-200"><a href="#cb72-200"></a>            time.sleep(<span class="dv">1</span>)</span>
<span id="cb72-201"><a href="#cb72-201"></a>            update<span class="op">=</span><span class="va">False</span></span>
<span id="cb72-202"><a href="#cb72-202"></a>led <span class="op">=</span> Pin(<span class="dv">2</span>, Pin.OUT)</span>
<span id="cb72-203"><a href="#cb72-203"></a>led.value(<span class="dv">0</span>)  <span class="co"># turn off red LED, doesn't work :L hard soldered in.</span></span>
<span id="cb72-204"><a href="#cb72-204"></a></span>
<span id="cb72-205"><a href="#cb72-205"></a><span class="kw">def</span> main():</span>
<span id="cb72-206"><a href="#cb72-206"></a>    reading_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb72-207"><a href="#cb72-207"></a>    <span class="cf">if</span> switch_state_wifi <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb72-208"><a href="#cb72-208"></a>        <span class="co"># Connect to WiFi</span></span>
<span id="cb72-209"><a href="#cb72-209"></a>        connect_wifi(SSID, PASSWORD)</span>
<span id="cb72-210"><a href="#cb72-210"></a>    </span>
<span id="cb72-211"><a href="#cb72-211"></a>    <span class="co"># Initialize I2C communication with the specified pins and frequency</span></span>
<span id="cb72-212"><a href="#cb72-212"></a>    i2c <span class="op">=</span> SoftI2C(scl<span class="op">=</span>Pin(<span class="dv">22</span>), sda<span class="op">=</span>Pin(<span class="dv">21</span>), freq<span class="op">=</span><span class="dv">400_000</span>)</span>
<span id="cb72-213"><a href="#cb72-213"></a>    device_address <span class="op">=</span> <span class="bn">0x62</span></span>
<span id="cb72-214"><a href="#cb72-214"></a></span>
<span id="cb72-215"><a href="#cb72-215"></a>    <span class="co"># Check if the device is present on the I2C bus</span></span>
<span id="cb72-216"><a href="#cb72-216"></a>    <span class="cf">if</span> <span class="kw">not</span> check_device_presence(i2c, device_address):</span>
<span id="cb72-217"><a href="#cb72-217"></a>        <span class="bu">print</span>(<span class="ss">f"Device with address </span><span class="sc">{</span>device_address<span class="sc">}</span><span class="ss"> not found on I2C bus."</span>)</span>
<span id="cb72-218"><a href="#cb72-218"></a>        <span class="cf">return</span></span>
<span id="cb72-219"><a href="#cb72-219"></a></span>
<span id="cb72-220"><a href="#cb72-220"></a>    <span class="bu">print</span>(<span class="ss">f"Device with address </span><span class="sc">{</span>device_address<span class="sc">}</span><span class="ss"> found on I2C bus."</span>)</span>
<span id="cb72-221"><a href="#cb72-221"></a>    oled_power.value(<span class="dv">1</span>)  <span class="co"># Turn on OLED display</span></span>
<span id="cb72-222"><a href="#cb72-222"></a>    <span class="co"># Setup SoftI2C for OLED</span></span>
<span id="cb72-223"><a href="#cb72-223"></a>    i2c_oled <span class="op">=</span> SoftI2C(scl<span class="op">=</span>Pin(<span class="dv">4</span>), sda<span class="op">=</span>Pin(<span class="dv">5</span>))</span>
<span id="cb72-224"><a href="#cb72-224"></a>    <span class="co"># Scan for OLED device</span></span>
<span id="cb72-225"><a href="#cb72-225"></a>    <span class="bu">print</span>(<span class="st">'Scanning for I2C devices...'</span>)</span>
<span id="cb72-226"><a href="#cb72-226"></a>    devices <span class="op">=</span> i2c_oled.scan()</span>
<span id="cb72-227"><a href="#cb72-227"></a>    <span class="cf">if</span> <span class="bu">len</span>(devices) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb72-228"><a href="#cb72-228"></a>        <span class="bu">print</span>(<span class="st">"No I2C OLED devices found."</span>)</span>
<span id="cb72-229"><a href="#cb72-229"></a>        OLEDaddress <span class="op">=</span> <span class="va">None</span></span>
<span id="cb72-230"><a href="#cb72-230"></a>    <span class="cf">else</span>:</span>
<span id="cb72-231"><a href="#cb72-231"></a>        <span class="bu">print</span>(<span class="st">'I2C OLED devices found:'</span>, <span class="bu">len</span>(devices))</span>
<span id="cb72-232"><a href="#cb72-232"></a>        OLEDaddress <span class="op">=</span> devices[<span class="dv">0</span>]  <span class="co"># Assuming the first device found is the OLED</span></span>
<span id="cb72-233"><a href="#cb72-233"></a>        <span class="cf">for</span> device <span class="kw">in</span> devices:</span>
<span id="cb72-234"><a href="#cb72-234"></a>            <span class="bu">print</span>(<span class="st">"Device address: "</span>, <span class="bu">hex</span>(device))</span>
<span id="cb72-235"><a href="#cb72-235"></a></span>
<span id="cb72-236"><a href="#cb72-236"></a>    <span class="co"># Initialize OLED if found</span></span>
<span id="cb72-237"><a href="#cb72-237"></a>    <span class="cf">if</span> OLEDaddress:</span>
<span id="cb72-238"><a href="#cb72-238"></a>        <span class="bu">print</span>(<span class="st">"Testing OLED..."</span>)</span>
<span id="cb72-239"><a href="#cb72-239"></a>        oled <span class="op">=</span> SSD1306_I2C(<span class="dv">128</span>, <span class="dv">64</span>, i2c_oled)</span>
<span id="cb72-240"><a href="#cb72-240"></a>        i <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb72-241"><a href="#cb72-241"></a>        <span class="cf">while</span> i <span class="op">&lt;</span> <span class="dv">10</span>:</span>
<span id="cb72-242"><a href="#cb72-242"></a>            time.sleep(<span class="dv">1</span>)</span>
<span id="cb72-243"><a href="#cb72-243"></a>            oled_power.value(<span class="dv">1</span>)</span>
<span id="cb72-244"><a href="#cb72-244"></a>            oled.fill(<span class="dv">0</span>)</span>
<span id="cb72-245"><a href="#cb72-245"></a>            oled.text(<span class="ss">f"Init: Test </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span>, <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb72-246"><a href="#cb72-246"></a>            oled.show()</span>
<span id="cb72-247"><a href="#cb72-247"></a>            time.sleep(<span class="dv">1</span>)</span>
<span id="cb72-248"><a href="#cb72-248"></a>            i <span class="op">=</span> i<span class="op">+</span><span class="dv">1</span></span>
<span id="cb72-249"><a href="#cb72-249"></a>            oled_power.value(<span class="dv">0</span>)</span>
<span id="cb72-250"><a href="#cb72-250"></a>        oled_power.value(<span class="dv">1</span>)</span>
<span id="cb72-251"><a href="#cb72-251"></a>        oled.fill(<span class="dv">0</span>)</span>
<span id="cb72-252"><a href="#cb72-252"></a>        <span class="cf">if</span> switch_state_calibrate <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb72-253"><a href="#cb72-253"></a>            oled.text(<span class="ss">f"CALIBRATION ON"</span>, <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb72-254"><a href="#cb72-254"></a>        <span class="cf">if</span> switch_state_calibrate <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb72-255"><a href="#cb72-255"></a>            oled.text(<span class="ss">f"CALIBRATION OFF"</span>, <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb72-256"><a href="#cb72-256"></a>        <span class="cf">if</span> switch_state_wifi <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb72-257"><a href="#cb72-257"></a>            oled.text(<span class="ss">f"WIFI ON"</span>, <span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb72-258"><a href="#cb72-258"></a>        <span class="cf">if</span> switch_state_wifi <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb72-259"><a href="#cb72-259"></a>            oled.text(<span class="ss">f"WIFI OFF"</span>, <span class="dv">0</span>, <span class="dv">10</span>) </span>
<span id="cb72-260"><a href="#cb72-260"></a>        oled.show()</span>
<span id="cb72-261"><a href="#cb72-261"></a>        time.sleep(<span class="dv">10</span>)</span>
<span id="cb72-262"><a href="#cb72-262"></a>        oled_power.value(<span class="dv">0</span>)</span>
<span id="cb72-263"><a href="#cb72-263"></a>    <span class="co"># Create an I2C adapter and sensor instance</span></span>
<span id="cb72-264"><a href="#cb72-264"></a>    adapter <span class="op">=</span> I2cAdapter(i2c)</span>
<span id="cb72-265"><a href="#cb72-265"></a>    sensor <span class="op">=</span> SCD4xSensirion(adapter)</span>
<span id="cb72-266"><a href="#cb72-266"></a>    sensor.set_measurement(start<span class="op">=</span><span class="va">False</span>, single_shot<span class="op">=</span><span class="va">False</span>) <span class="co">#if looping need to put sensor back into IDLE mode. Sensor can't exec self test if currently reading...</span></span>
<span id="cb72-267"><a href="#cb72-267"></a>    </span>
<span id="cb72-268"><a href="#cb72-268"></a>    <span class="co"># Check if sensor is good to go. Note you may need to power cycle to pass this test. Make sure 5V in.</span></span>
<span id="cb72-269"><a href="#cb72-269"></a>    selfTest <span class="op">=</span> <span class="va">False</span></span>
<span id="cb72-270"><a href="#cb72-270"></a>    <span class="cf">while</span> selfTest <span class="op">==</span> <span class="va">False</span>:</span>
<span id="cb72-271"><a href="#cb72-271"></a>        <span class="cf">try</span>:</span>
<span id="cb72-272"><a href="#cb72-272"></a>            <span class="cf">if</span> sensor.exec_self_test():</span>
<span id="cb72-273"><a href="#cb72-273"></a>                <span class="bu">print</span>(<span class="st">"Sensor self test shows good to go"</span>)</span>
<span id="cb72-274"><a href="#cb72-274"></a>                selfTest <span class="op">=</span> <span class="va">True</span></span>
<span id="cb72-275"><a href="#cb72-275"></a>            <span class="cf">else</span>:</span>
<span id="cb72-276"><a href="#cb72-276"></a>                <span class="bu">print</span>(<span class="st">"Sensor self test failed!"</span>)</span>
<span id="cb72-277"><a href="#cb72-277"></a>                selfTest <span class="op">=</span> <span class="va">False</span></span>
<span id="cb72-278"><a href="#cb72-278"></a>                time.sleep(<span class="dv">1</span>)</span>
<span id="cb72-279"><a href="#cb72-279"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb72-280"><a href="#cb72-280"></a>            <span class="bu">print</span>(<span class="st">"Exception occurred:"</span>, e)</span>
<span id="cb72-281"><a href="#cb72-281"></a></span>
<span id="cb72-282"><a href="#cb72-282"></a></span>
<span id="cb72-283"><a href="#cb72-283"></a>    <span class="co"># Ensure the sensor is in IDLE mode</span></span>
<span id="cb72-284"><a href="#cb72-284"></a>    sensor.set_measurement(start<span class="op">=</span><span class="va">False</span>, single_shot<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb72-285"><a href="#cb72-285"></a></span>
<span id="cb72-286"><a href="#cb72-286"></a>    <span class="co"># Retrieve and display the sensor ID</span></span>
<span id="cb72-287"><a href="#cb72-287"></a>    sensor_id <span class="op">=</span> sensor.get_id()</span>
<span id="cb72-288"><a href="#cb72-288"></a>    <span class="bu">print</span>(<span class="ss">f"Sensor ID: </span><span class="sc">{</span>sensor_id[<span class="dv">0</span>]<span class="sc">:x}</span><span class="ss">:</span><span class="sc">{</span>sensor_id[<span class="dv">1</span>]<span class="sc">:x}</span><span class="ss">:</span><span class="sc">{</span>sensor_id[<span class="dv">2</span>]<span class="sc">:x}</span><span class="ss">"</span>)</span>
<span id="cb72-289"><a href="#cb72-289"></a></span>
<span id="cb72-290"><a href="#cb72-290"></a>    <span class="co"># Retrieve and display the temperature offset</span></span>
<span id="cb72-291"><a href="#cb72-291"></a>    temp_offset <span class="op">=</span> sensor.get_temperature_offset()</span>
<span id="cb72-292"><a href="#cb72-292"></a>    <span class="bu">print</span>(<span class="ss">f"Temperature offset: </span><span class="sc">{</span>temp_offset<span class="sc">:.6f}</span><span class="ss"> F"</span>)</span>
<span id="cb72-293"><a href="#cb72-293"></a></span>
<span id="cb72-294"><a href="#cb72-294"></a>    <span class="co"># Set and retrieve the altitude (meters above sea level)</span></span>
<span id="cb72-295"><a href="#cb72-295"></a>    altitude <span class="op">=</span> <span class="dv">198</span></span>
<span id="cb72-296"><a href="#cb72-296"></a>    retrieved_altitude <span class="op">=</span> sensor.get_altitude()</span>
<span id="cb72-297"><a href="#cb72-297"></a>    <span class="bu">print</span>(<span class="ss">f"Desired Altitude: </span><span class="sc">{</span>altitude<span class="sc">}</span><span class="ss"> m, Retrieved Altitude: </span><span class="sc">{</span>retrieved_altitude<span class="sc">}</span><span class="ss"> m"</span>)</span>
<span id="cb72-298"><a href="#cb72-298"></a>    <span class="cf">if</span> altitude <span class="op">!=</span> retrieved_altitude:</span>
<span id="cb72-299"><a href="#cb72-299"></a>        sensor.set_altitude(altitude)</span>
<span id="cb72-300"><a href="#cb72-300"></a>        <span class="bu">print</span>(<span class="ss">f"Altitude set to: </span><span class="sc">{</span>altitude<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb72-301"><a href="#cb72-301"></a>    </span>
<span id="cb72-302"><a href="#cb72-302"></a>    <span class="co"># Check if automatic self-calibration is enabled</span></span>
<span id="cb72-303"><a href="#cb72-303"></a>    <span class="cf">if</span> sensor.is_auto_calibration():</span>
<span id="cb72-304"><a href="#cb72-304"></a>        <span class="bu">print</span>(<span class="st">"Automatic self-calibration is ON."</span>)</span>
<span id="cb72-305"><a href="#cb72-305"></a>    <span class="cf">else</span>:</span>
<span id="cb72-306"><a href="#cb72-306"></a>        <span class="bu">print</span>(<span class="st">"Automatic self-calibration is OFF."</span>)</span>
<span id="cb72-307"><a href="#cb72-307"></a>    </span>
<span id="cb72-308"><a href="#cb72-308"></a>    <span class="co"># Start periodic measurement</span></span>
<span id="cb72-309"><a href="#cb72-309"></a>    sensor._low_power_mode <span class="op">=</span> <span class="va">True</span></span>
<span id="cb72-310"><a href="#cb72-310"></a>    sensor.set_measurement(start<span class="op">=</span><span class="va">True</span>, single_shot<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb72-311"><a href="#cb72-311"></a>    conversion_cycle_time <span class="op">=</span> sensor.get_conversion_cycle_time()</span>
<span id="cb72-312"><a href="#cb72-312"></a>    last_update_sensor <span class="op">=</span>  time.time()</span>
<span id="cb72-313"><a href="#cb72-313"></a>    <span class="bu">print</span>(<span class="ss">f"Low Power Mode: </span><span class="sc">{</span>sensor<span class="sc">.</span>_low_power_mode<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb72-314"><a href="#cb72-314"></a>    <span class="bu">print</span>(<span class="ss">f"Low power periodic measurement started with conversion cycle time: </span><span class="sc">{</span>conversion_cycle_time<span class="sc">}</span><span class="ss"> ms"</span>)</span>
<span id="cb72-315"><a href="#cb72-315"></a>    <span class="bu">print</span>(<span class="st">"Periodic measurement started."</span>)</span>
<span id="cb72-316"><a href="#cb72-316"></a></span>
<span id="cb72-317"><a href="#cb72-317"></a><span class="co">#     # Wait for two consecutive valid readings before entering the endless loop</span></span>
<span id="cb72-318"><a href="#cb72-318"></a><span class="co">#     valid_readings = 0</span></span>
<span id="cb72-319"><a href="#cb72-319"></a><span class="co">#     while valid_readings &lt; 10:</span></span>
<span id="cb72-320"><a href="#cb72-320"></a><span class="co">#         reading = get_sensor_reading(sensor, conversion_cycle_time)</span></span>
<span id="cb72-321"><a href="#cb72-321"></a><span class="co">#         if reading:</span></span>
<span id="cb72-322"><a href="#cb72-322"></a><span class="co">#             co2, temp, humidity = reading</span></span>
<span id="cb72-323"><a href="#cb72-323"></a><span class="co">#             temp = temp * 9 / 5 +32</span></span>
<span id="cb72-324"><a href="#cb72-324"></a><span class="co">#             time.sleep(30)</span></span>
<span id="cb72-325"><a href="#cb72-325"></a><span class="co">#             print(f"Initial Reading {valid_readings + 1}: CO2: {co2} ppm, Temperature: {temp:.2f} 閹虹煵, Humidity: {humidity:.2f} %")</span></span>
<span id="cb72-326"><a href="#cb72-326"></a><span class="co">#             valid_readings += 1</span></span>
<span id="cb72-327"><a href="#cb72-327"></a><span class="co">#         else:</span></span>
<span id="cb72-328"><a href="#cb72-328"></a><span class="co">#             # Reset the sensor and reinitialize if an error occurs</span></span>
<span id="cb72-329"><a href="#cb72-329"></a><span class="co">#             print("Attempting to reinitialize the sensor...")</span></span>
<span id="cb72-330"><a href="#cb72-330"></a><span class="co">#             sensor.set_measurement(start=False, single_shot=False)</span></span>
<span id="cb72-331"><a href="#cb72-331"></a><span class="co">#             sensor.set_measurement(start=True, single_shot=False)</span></span>
<span id="cb72-332"><a href="#cb72-332"></a><span class="co">#             valid_readings = 0</span></span>
<span id="cb72-333"><a href="#cb72-333"></a>    <span class="cf">if</span> switch_state_calibrate <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb72-334"><a href="#cb72-334"></a>        <span class="co">#### We wanna calibrate it with this chunk if anything...</span></span>
<span id="cb72-335"><a href="#cb72-335"></a>        <span class="co"># Start periodic measurement</span></span>
<span id="cb72-336"><a href="#cb72-336"></a>        <span class="bu">print</span>(<span class="st">"Performing sensor calibration in 30 seconds..."</span>)</span>
<span id="cb72-337"><a href="#cb72-337"></a>        <span class="bu">print</span>(<span class="st">"The sensor will be calibrated over 60 min in fresh air."</span>)</span>
<span id="cb72-338"><a href="#cb72-338"></a>        time.sleep(<span class="dv">30</span>)</span>
<span id="cb72-339"><a href="#cb72-339"></a>        sensorCycle <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb72-340"><a href="#cb72-340"></a>        calibrateMe <span class="op">=</span> <span class="va">True</span></span>
<span id="cb72-341"><a href="#cb72-341"></a></span>
<span id="cb72-342"><a href="#cb72-342"></a>        <span class="co"># Perform factory reset and reinitialize</span></span>
<span id="cb72-343"><a href="#cb72-343"></a>        sensor.perform_factory_reset()</span>
<span id="cb72-344"><a href="#cb72-344"></a>        <span class="bu">print</span>(<span class="st">"Factory reset performed."</span>)</span>
<span id="cb72-345"><a href="#cb72-345"></a>        time.sleep(<span class="dv">2</span>)  <span class="co"># Wait for the factory reset to complete</span></span>
<span id="cb72-346"><a href="#cb72-346"></a>        </span>
<span id="cb72-347"><a href="#cb72-347"></a>        <span class="co"># Perform soft reset and reinitialize</span></span>
<span id="cb72-348"><a href="#cb72-348"></a>        sensor.soft_reset()</span>
<span id="cb72-349"><a href="#cb72-349"></a>        time.sleep(<span class="dv">1</span>)  <span class="co"># Wait for the reset to complete</span></span>
<span id="cb72-350"><a href="#cb72-350"></a>        sensor.set_measurement(start<span class="op">=</span><span class="va">False</span>, single_shot<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb72-351"><a href="#cb72-351"></a>        time.sleep(<span class="dv">1</span>)</span>
<span id="cb72-352"><a href="#cb72-352"></a>        sensor.set_measurement(start<span class="op">=</span><span class="va">True</span>, single_shot<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb72-353"><a href="#cb72-353"></a>        time.sleep(<span class="dv">1</span>)</span>
<span id="cb72-354"><a href="#cb72-354"></a>        <span class="bu">print</span>(<span class="st">"Performing soft reset and reinitialization..."</span>)</span>
<span id="cb72-355"><a href="#cb72-355"></a></span>
<span id="cb72-356"><a href="#cb72-356"></a>        <span class="cf">while</span> sensorCycle <span class="op">&lt;</span> <span class="dv">60</span>:</span>
<span id="cb72-357"><a href="#cb72-357"></a>            conversion_cycle_time <span class="op">=</span> sensor.get_conversion_cycle_time()</span>
<span id="cb72-358"><a href="#cb72-358"></a>            reading <span class="op">=</span> get_sensor_reading(sensor, conversion_cycle_time)</span>
<span id="cb72-359"><a href="#cb72-359"></a>            <span class="cf">if</span> reading:</span>
<span id="cb72-360"><a href="#cb72-360"></a>                co2, temp, humidity <span class="op">=</span> reading</span>
<span id="cb72-361"><a href="#cb72-361"></a>                time.sleep(<span class="dv">30</span>)</span>
<span id="cb72-362"><a href="#cb72-362"></a>                sensorCycle <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb72-363"><a href="#cb72-363"></a>                <span class="bu">print</span>(<span class="ss">f"Continuous Reading: CO2: </span><span class="sc">{</span>co2<span class="sc">}</span><span class="ss"> ppm, Temperature: </span><span class="sc">{</span>temp<span class="sc">:.2f}</span><span class="ss"> F, Humidity: </span><span class="sc">{</span>humidity<span class="sc">:.2f}</span><span class="ss"> %"</span>)</span>
<span id="cb72-364"><a href="#cb72-364"></a>                <span class="bu">print</span>(<span class="ss">f"Sensor Cycled </span><span class="sc">{</span>sensorCycle<span class="sc">}</span><span class="ss"> times of 3600"</span>)</span>
<span id="cb72-365"><a href="#cb72-365"></a>                <span class="cf">if</span> sensorCycle <span class="op">==</span> <span class="dv">59</span>:</span>
<span id="cb72-366"><a href="#cb72-366"></a>                    <span class="cf">if</span> calibrateMe <span class="op">==</span> <span class="va">True</span>:</span>
<span id="cb72-367"><a href="#cb72-367"></a>                        <span class="bu">print</span>(<span class="st">"Initiating forced recalibration..."</span>)</span>
<span id="cb72-368"><a href="#cb72-368"></a>                        target_co2_concentration <span class="op">=</span> <span class="bu">int</span>(<span class="dv">426</span> <span class="op">*</span> <span class="fl">1.15</span>)  <span class="co"># Mauna Loa CO2 = 426.57ppm April 2024 + 15-20% differential for being near/in a major city(Chicago), to int bc need int for low level</span></span>
<span id="cb72-369"><a href="#cb72-369"></a>                        correction_value <span class="op">=</span> sensor.force_recalibration(target_co2_concentration)</span>
<span id="cb72-370"><a href="#cb72-370"></a>                        <span class="bu">print</span>(<span class="ss">f"Forced recalibration completed with correction value: </span><span class="sc">{</span>correction_value<span class="sc">}</span><span class="ss"> ppm"</span>)</span>
<span id="cb72-371"><a href="#cb72-371"></a>                        sensor.set_auto_calibration(<span class="va">False</span>)</span>
<span id="cb72-372"><a href="#cb72-372"></a>                        <span class="bu">print</span>(<span class="st">"Sensor Auto Calibration set to: </span><span class="sc">{sensor.get_auto_calibration}</span><span class="st">. Rerun the program after power cycling with the calibration commented out to double check persistence! "</span>)</span>
<span id="cb72-373"><a href="#cb72-373"></a>                        sensor.save_config()</span>
<span id="cb72-374"><a href="#cb72-374"></a>                        <span class="bu">print</span>(<span class="st">"Settings saved."</span>)</span>
<span id="cb72-375"><a href="#cb72-375"></a>            <span class="cf">else</span>:</span>
<span id="cb72-376"><a href="#cb72-376"></a>                <span class="co"># Reset the sensor and reinitialize if an error occurs</span></span>
<span id="cb72-377"><a href="#cb72-377"></a>                <span class="bu">print</span>(<span class="st">"Attempting to reinitialize the sensor..."</span>)</span>
<span id="cb72-378"><a href="#cb72-378"></a>                sensor.set_measurement(start<span class="op">=</span><span class="va">False</span>, single_shot<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb72-379"><a href="#cb72-379"></a>                sensor.set_measurement(start<span class="op">=</span><span class="va">True</span>, single_shot<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb72-380"><a href="#cb72-380"></a>    <span class="cf">if</span> switch_state_calibrate <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb72-381"><a href="#cb72-381"></a>        <span class="bu">print</span>(<span class="st">"Skipping calibration."</span>)</span>
<span id="cb72-382"><a href="#cb72-382"></a>    <span class="co"># Endless loop to continuously read and display sensor data</span></span>
<span id="cb72-383"><a href="#cb72-383"></a></span>
<span id="cb72-384"><a href="#cb72-384"></a>    <span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb72-385"><a href="#cb72-385"></a>        <span class="cf">try</span>:</span>
<span id="cb72-386"><a href="#cb72-386"></a>            date_str <span class="op">=</span> <span class="va">None</span></span>
<span id="cb72-387"><a href="#cb72-387"></a>            reading <span class="op">=</span> get_sensor_reading(sensor, conversion_cycle_time,last_update_sensor)</span>
<span id="cb72-388"><a href="#cb72-388"></a>            <span class="cf">if</span> reading:</span>
<span id="cb72-389"><a href="#cb72-389"></a>                co2, temp, humidity <span class="op">=</span> reading</span>
<span id="cb72-390"><a href="#cb72-390"></a>                last_update_sensor <span class="op">=</span>  time.time()</span>
<span id="cb72-391"><a href="#cb72-391"></a>                temp <span class="op">=</span> temp <span class="op">*</span> <span class="dv">9</span> <span class="op">/</span> <span class="dv">5</span> <span class="op">+</span> <span class="dv">32</span></span>
<span id="cb72-392"><a href="#cb72-392"></a>                <span class="bu">print</span>(<span class="ss">f"Continuous Reading: CO2: </span><span class="sc">{</span>co2<span class="sc">}</span><span class="ss"> ppm, Temperature: </span><span class="sc">{</span>temp<span class="sc">:.2f}</span><span class="ss"> F, Humidity: </span><span class="sc">{</span>humidity<span class="sc">:.2f}</span><span class="ss"> %"</span>)</span>
<span id="cb72-393"><a href="#cb72-393"></a>                <span class="co"># Check CO2 level and sound the buzzer if above threshold</span></span>
<span id="cb72-394"><a href="#cb72-394"></a>                <span class="cf">if</span> co2 <span class="op">&gt;</span> <span class="dv">1500</span>:</span>
<span id="cb72-395"><a href="#cb72-395"></a>                    <span class="bu">print</span>(<span class="st">"CO2 level exceeded 1500 ppm. Activating buzzer."</span>)</span>
<span id="cb72-396"><a href="#cb72-396"></a>                    sound_buzzer()</span>
<span id="cb72-397"><a href="#cb72-397"></a>                </span>
<span id="cb72-398"><a href="#cb72-398"></a>                    </span>
<span id="cb72-399"><a href="#cb72-399"></a>                <span class="cf">if</span> switch_state_wifi <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb72-400"><a href="#cb72-400"></a>                    <span class="co"># Get current date and time</span></span>
<span id="cb72-401"><a href="#cb72-401"></a>                    current_time <span class="op">=</span> get_time_chicago()</span>
<span id="cb72-402"><a href="#cb72-402"></a>                    date_str <span class="op">=</span> <span class="st">"</span><span class="sc">{:04}</span><span class="st">-</span><span class="sc">{:02}</span><span class="st">-</span><span class="sc">{:02}</span><span class="st">"</span>.<span class="bu">format</span>(current_time[<span class="dv">0</span>], current_time[<span class="dv">1</span>], current_time[<span class="dv">2</span>])</span>
<span id="cb72-403"><a href="#cb72-403"></a>                    time_str <span class="op">=</span> <span class="st">"</span><span class="sc">{:02}</span><span class="st">:</span><span class="sc">{:02}</span><span class="st">:</span><span class="sc">{:02}</span><span class="st">"</span>.<span class="bu">format</span>(current_time[<span class="dv">3</span>], current_time[<span class="dv">4</span>], current_time[<span class="dv">5</span>])</span>
<span id="cb72-404"><a href="#cb72-404"></a></span>
<span id="cb72-405"><a href="#cb72-405"></a>                    data <span class="op">=</span> {</span>
<span id="cb72-406"><a href="#cb72-406"></a>                    <span class="st">'date'</span>: date_str, </span>
<span id="cb72-407"><a href="#cb72-407"></a>                    <span class="st">'time'</span>: time_str, </span>
<span id="cb72-408"><a href="#cb72-408"></a>                    <span class="st">'co2'</span>: co2,</span>
<span id="cb72-409"><a href="#cb72-409"></a>                    <span class="st">'temp_f'</span>: temp,</span>
<span id="cb72-410"><a href="#cb72-410"></a>                    <span class="st">'humidity'</span>: humidity</span>
<span id="cb72-411"><a href="#cb72-411"></a>                }</span>
<span id="cb72-412"><a href="#cb72-412"></a>                </span>
<span id="cb72-413"><a href="#cb72-413"></a>                    send_data_to_google_sheets(data)</span>
<span id="cb72-414"><a href="#cb72-414"></a>                    thingspeak_buffer.append(data)  <span class="co"># Add data to buffer</span></span>
<span id="cb72-415"><a href="#cb72-415"></a>                    send_data_to_thingspeak()</span>
<span id="cb72-416"><a href="#cb72-416"></a>                <span class="cf">if</span> switch_state_wifi <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb72-417"><a href="#cb72-417"></a>                    thingspeak_buffer.clear()</span>
<span id="cb72-418"><a href="#cb72-418"></a>               <span class="co">#OLED Logic</span></span>
<span id="cb72-419"><a href="#cb72-419"></a>                <span class="cf">if</span> OLEDaddress:</span>
<span id="cb72-420"><a href="#cb72-420"></a>                    reading_count <span class="op">=</span> reading_count <span class="op">+</span><span class="dv">1</span></span>
<span id="cb72-421"><a href="#cb72-421"></a>                    oled_power.value(<span class="dv">1</span>)</span>
<span id="cb72-422"><a href="#cb72-422"></a>                    oled.fill(<span class="dv">0</span>)</span>
<span id="cb72-423"><a href="#cb72-423"></a>                    oled.text(<span class="ss">f'Reading: </span><span class="sc">{</span>reading_count<span class="sc">}</span><span class="ss">'</span>, <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb72-424"><a href="#cb72-424"></a>                    <span class="cf">if</span> date_str <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb72-425"><a href="#cb72-425"></a>                        oled.text(<span class="ss">f'Date: </span><span class="sc">{</span>date_str<span class="sc">}</span><span class="ss">'</span>, <span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb72-426"><a href="#cb72-426"></a>                        oled.text(<span class="ss">f'Time: </span><span class="sc">{</span>time_str<span class="sc">}</span><span class="ss">'</span>, <span class="dv">0</span>, <span class="dv">20</span>)</span>
<span id="cb72-427"><a href="#cb72-427"></a>                    oled.text(<span class="ss">f'CO2:</span><span class="sc">{</span><span class="bu">int</span>(co2)<span class="sc">}</span><span class="ss">ppm'</span>, <span class="dv">0</span>, <span class="dv">30</span>)</span>
<span id="cb72-428"><a href="#cb72-428"></a>                    oled.text(<span class="ss">f'Temp:</span><span class="sc">{</span>temp<span class="sc">:.2f}</span><span class="ss">F'</span>,<span class="dv">0</span>,<span class="dv">40</span>)</span>
<span id="cb72-429"><a href="#cb72-429"></a>                    oled.text(<span class="ss">f'Hum:</span><span class="sc">{</span>humidity<span class="sc">:.2f}</span><span class="ss">%'</span>, <span class="dv">0</span>, <span class="dv">50</span>)</span>
<span id="cb72-430"><a href="#cb72-430"></a>                    oled.show()</span>
<span id="cb72-431"><a href="#cb72-431"></a>                    time.sleep(<span class="dv">20</span>)</span>
<span id="cb72-432"><a href="#cb72-432"></a>                    oled_power.value(<span class="dv">0</span>) </span>
<span id="cb72-433"><a href="#cb72-433"></a>                time.sleep(<span class="dv">3</span>)</span>
<span id="cb72-434"><a href="#cb72-434"></a>    <span class="co">#         else:</span></span>
<span id="cb72-435"><a href="#cb72-435"></a>    <span class="co">#             # Reset the sensor and reinitialize if an error occurs</span></span>
<span id="cb72-436"><a href="#cb72-436"></a>    <span class="co">#             print("Attempting to reinitialize the sensor...")</span></span>
<span id="cb72-437"><a href="#cb72-437"></a>    <span class="co">#             sensor.set_measurement(start=False, single_shot=False)</span></span>
<span id="cb72-438"><a href="#cb72-438"></a>    <span class="co">#             sensor.set_measurement(start=True, single_shot=False)</span></span>
<span id="cb72-439"><a href="#cb72-439"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb72-440"><a href="#cb72-440"></a>                <span class="bu">print</span>(<span class="st">"Error occurred:"</span>, e)</span>
<span id="cb72-441"><a href="#cb72-441"></a>                time.sleep(<span class="dv">5</span>)  <span class="co"># Wait for 5 seconds before retrying</span></span>
<span id="cb72-442"><a href="#cb72-442"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">'__main__'</span>:</span>
<span id="cb72-443"><a href="#cb72-443"></a>    <span class="cf">try</span>:</span>
<span id="cb72-444"><a href="#cb72-444"></a>        main()</span>
<span id="cb72-445"><a href="#cb72-445"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb72-446"><a href="#cb72-446"></a>                <span class="bu">print</span>(<span class="st">"Error occurred:"</span>, e)</span>
<span id="cb72-447"><a href="#cb72-447"></a>                time.sleep(<span class="dv">5</span>)  <span class="co"># Wait for 5 seconds before retrying</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p>I’m not going to the go too much into the code as the SCD41 chip supports a variety of different modes and unless you do a deep dive into the datasheet and the code for some cursed reason you should be fine with the code above. I was able to log readings fairly close to the reported values for my town and breathing on the device and near the device increased the sensor readings reliably. I did note that the sensor took some time to get back down to baseline and took a bit to get up to the max with me breathing on it. It was roughly 2.5 minutes to get back down to baseline and that’s roughly in line with what we would ideally sample at due to the humidity sampling interval mentioned in the technical specs above. See image below:</p>
<p><a href="CO2_Values.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6"><img src="CO2_Values.png" class="img-fluid"></a></p>
</section>
<section id="limitations-of-the-scd41" class="level3">
<h3 class="anchored" data-anchor-id="limitations-of-the-scd41">Limitations of the SCD41</h3>
<p>As mentioned above we will have a slight delay in logging values so the results won’t be instantaneous. Additionally as mentioned by: <a href="https://github.com/octaprog7/SCD4x" class="uri">https://github.com/octaprog7/SCD4x</a> one will notice an increase in temperature reading from the sensor if the interval is less than 15 seconds as the sensor will self heat. Additionally, both the SCD40/41 sensors have an auto-calibrate mode which will take the lowest CO2 value from the past 7 days and assumes it is 400ppm. This can cause sensor drift over time unless one regularly(once a week) exposes the sensor to fresh air. It is possible to turn off this auto-calibration mode and one will note that in the code above[set_auto_calibration]. An anecdote from <a href="https://www.reddit.com/r/esp32/comments/12y0x5k/warning_about_the_sensirion_scd4041_co2_sensors/">User Anx2K on the r/ESP32 Reddit</a> mentions that there is roughly a 40ppm(10%) drift year to year if one turns off auto calibration. Calibration takes 5 minutes, but is an inherently manual process. It would be nice to be somewhere near a weather monitoring station and set up this CO2 monitor alongside a MH-Z19B/C and MH-Z1+ which use NDIR and compare the initial and end of 24 hour values and assess drift.</p>
</section>
<section id="applications-of-the-scd41" class="level3">
<h3 class="anchored" data-anchor-id="applications-of-the-scd41">Applications of the SCD41</h3>
<p>I am particularly interested in environmental monitoring to assess indoor air quality at a competitive price, allowing users to swap sensors in and out as needed. This flexibility is crucial for adapting to different monitoring requirements without significant additional costs.</p>
<p>Additionally, monitoring transient dump flows from businesses during off-hours (midnight to 3 AM) is vital. This involves tracking the release of CO2 and other gaseous components using the MQ-* sensor series. While this approach may not provide quantitative measurements due to various confounding factors, it serves as an initial assessment tool. This preliminary analysis can justify the purchase or lease of more advanced testing equipment, costing under $100 in upfront expenses and requiring only a few hours of labor.</p>
<p>Another intriguing experiment involves mapping a town with sensors placed every few blocks to monitor localized CO2 concentrations. This data can be correlated with consumer, commercial, and industrial activities, providing valuable insights into the town’s environmental impact.</p>
<p>Other applications include monitoring the respiratory activity of plants by measuring CO2 exchange in greenhouse or agricultural research settings. This can offer insights into plant health, photosynthetic efficiency, and growth patterns. Pairing this with R/G/B, UV, and light sensors can help determine several growth parameters. Note that NPK (Nitrogen/Phosphorous/Potassium) sensors are often unreliable based on my research. Therefore, it’s better to use actual chemical testing methods or automate the chemical testing apparatus rather than relying on electronic sensors for these measurements.</p>
<p>In biotechnology and biochemical engineering contexts, monitoring CO2 levels in cellular cultures and bioreactors is essential. Maintaining precise CO2 concentrations ensures the optimal growth of microorganisms, which can significantly reduce production costs. This is particularly important for the pharmaceutical industry, biofuel production, and other bio-based manufacturing processes.</p>
</section>
<section id="personal-testing" class="level3">
<h3 class="anchored" data-anchor-id="personal-testing">Personal Testing</h3>
<p>In the recent heat wave I noted that it took roughly 30 minutes to air out the house and cut CO2 levels from ~1200ppm to ~650ppm.</p>
<p><a href="CO2_Reduction.jpg" class="lightbox" data-gallery="quarto-lightbox-gallery-7"><img src="CO2_Reduction.jpg" class="img-fluid"></a></p>
<p>Its interesting to note that the temperature jumped only a few degrees over the 30 minutes per below:</p>
<p><a href="Temp_Humidity.jpeg" class="lightbox" data-gallery="quarto-lightbox-gallery-8"><img src="Temp_Humidity.jpeg" class="img-fluid"></a></p>
<p>The actual “enclosure” of the sensor is just an old Raspberry Pi 5 Case box, a FLIRC model. The solid wire coming from the main board is hooked up to a smaller board used for data display, switching wifi/calibration on/off, and alerting users to high CO2(1500ppm). Note that I didn’t feel like potentially burning the board or buying a soldering attachment to safely remove the LED so I covered it with some cardboard to remove some of the interference caused by the light on the sensor. See below:</p>
<p>Raw Boards, no case</p>
<p><a href="SCD41_NoBox.jpg" class="lightbox" data-gallery="quarto-lightbox-gallery-9"><img src="SCD41_NoBox.jpg" class="img-fluid"></a></p>
<p>Wifi/Calibration Screen, with case</p>
<p><a href="SwitchesScreen.jpg" class="lightbox" data-gallery="quarto-lightbox-gallery-10"><img src="SwitchesScreen.jpg" class="img-fluid"></a></p>
<p>Normal Output, with case</p>
<p><a href="SCD41_Example_Data.jpg" class="lightbox" data-gallery="quarto-lightbox-gallery-11"><img src="SCD41_Example_Data.jpg" class="img-fluid"></a></p>
</section>
<section id="conclusion" class="level3">
<h3 class="anchored" data-anchor-id="conclusion">Conclusion</h3>
<p>The SCD41 sensor offers a versatile and accurate solution for CO2 monitoring in various applications. For our particular application, provided we either calibrate it once at the beginning then once more every year we can enjoy accurate CO2 monitoring at a low price.</p>


</section>

</main> <!-- /main -->






    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Support Page</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>

        .centered-text {

            text-align: center; /* Centers text for elements with this class */

        }

        .centered-content {

            display: flex; /* Uses Flexbox for layout */

            justify-content: center; /* Horizontally centers the content within the container */

            align-items: center; /* Vertically centers the content within the container */

        }

        .email-share-button {

            background: #007BFF; /* Example: a distinct blue color for the email button */

            color: white; /* Ensure text and icon are white for visibility */

        }

        #share-buttons {

            display: flex;

            align-items: center;

            justify-content: center;

            gap: 5px;

        }

        .share-button {

            display: inline-flex;

            padding: 2px 4px;

            font-size: 14px;

            cursor: pointer;

            text-align: center;

            color: white;

            border-radius: 0px;

        }

    </style>





    <footer class="centered-text">

        <p>Copyright © <span id="copyright-year"></span> Jesse Anderson</p>

        <!-- Other footer details -->

    </footer>

    <div>

        <hr>

        <h3 class="centered-text">Support my work with a Coffee/Monster</h3>

        <div class="centered-content">

            <script type="text/javascript" src="https://cdnjs.buymeacoffee.com/1.0.0/button.prod.min.js" data-name="bmc-button" data-slug="jesseanderson" data-color="#06436e" data-emoji="☕" data-font="Lato" data-text="Support me" data-outline-color="#ffffff" data-font-color="#ffffff" data-coffee-color="#FFDD00" data-height="40px"></script>

        </div>

        <!-- Footer content -->

        <h3 class="centered-text">Share</h3>

        <!-- Share Buttons -->

        <div id="share-buttons" class="centered-content">

            <!-- Twitter Share Button, dynamically setting the URL -->

            <a href="#" class="share-button twitter-share-button" data-size="large" data-hashtags="computerscience" data-via="JesseA7C5" data-show-count="false">Tweet</a>

            <script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

            <!-- Facebook SDK with Dynamic Nonce -->

            <div id="fb-root"></div>

            <script id="facebook-jssdk" async="" defer="" crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js#xfbml=1&amp;version=v10.0"></script>

            <div class="fb-share-button share-button" data-href="" data-layout="button_count">

            </div>

            <!-- LinkedIn Share Button -->

            <script src="https://platform.linkedin.com/in.js" type="text/javascript">lang: en_US</script>

            <script type="IN/Share" data-url=""></script>

            <!-- Email Share Button -->

            <a href="#" class="share-button email-share-button"><i class="fas fa-envelope"></i></a>

        </div>

    </div>

    <script>

        // Function to generate a random nonce

        function generateNonce(length = 16) {

            const possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";

            let text = "";

            for (let i = 0; i < length; i++) {

                text += possible.charAt(Math.floor(Math.random() * possible.length));

            }

            return text;

        }

        // Set the nonce attribute for the Facebook SDK script and dynamically set URLs

        document.addEventListener('DOMContentLoaded', function() {

            const nonce = generateNonce();

            const facebookSDKScript = document.getElementById('facebook-jssdk');

            facebookSDKScript.setAttribute('nonce', nonce);

            var elems = document.querySelectorAll('script[type="IN/Share"]');

            for (var i = 0; i < elems.length; i++) {

                elems[i].setAttribute('data-url', window.location.href);

            }

            // Set dynamic URLs for social sharing

            const currentUrl = window.location.href;

            const currentTitle = document.title; // Use the current document title as the email subject

            // Facebook

            document.querySelector('.fb-share-button').setAttribute('data-href', currentUrl);

            // LinkedIn

            document.querySelectorAll('script[type="IN/Share"]')[0].setAttribute('data-url', currentUrl);

            // Twitter

            document.querySelector('.twitter-share-button').setAttribute('href', 'https://twitter.com/share?url=' + encodeURIComponent(currentUrl) + '&hashtags=rstats');

            // Email

            document.querySelector('.email-share-button').setAttribute('href', `mailto:?subject=${encodeURIComponent(currentTitle)}&body=Check out this link: ${encodeURIComponent(currentUrl)}`);

            // Dynamically set the current year in the copyright footer

            document.getElementById('copyright-year').textContent = new Date().getFullYear();

        });

        // This script below to put a latest posts list after the comment system was such a pain in the ass.

        document.addEventListener('DOMContentLoaded', function() {

            // console.log("Latest Posts Populating...");

            // Create the latest posts container

            const latestPostsContainer = document.createElement('div');

            latestPostsContainer.className = 'latest-posts';

            latestPostsContainer.innerHTML = `

                <h3>Latest Posts</h3>

                <ul id="latest-posts-list">

                    <!-- Latest posts will be inserted here -->

                </ul>

            `;

            // Find the footer element

            const footer = document.querySelector('footer.footer');

            // Insert the latest posts container before footer, easier than after utterances.

            footer.parentNode.insertBefore(latestPostsContainer, footer);

            // Fetch latest posts from the archive page

            fetch('https://jesse-anderson.github.io/Blog/_site/archive.html')

                .then(response => response.text())

                .then(data => {

                    const parser = new DOMParser();

                    const doc = parser.parseFromString(data, 'text/html');

                    const posts = doc.querySelectorAll('.quarto-listing-container-table tbody tr');

                    // console.log("Posts: ", posts);

                    const latestPostsList = document.getElementById('latest-posts-list');

                    let count = 0;

                    posts.forEach(post => {

                        if (count < 4) {

                            // console.log("Title populating...");

                            const titleElement = post.querySelector('.listing-title'); // Correctly select the <a> tag with the title class

                            // console.log(titleElement)

                              const imageElement = post.querySelector('.listing-image img');

                              // console.log(imageElement)

                            if (titleElement) {

                                const title = titleElement.textContent.trim();

                                // console.log('Title: ', title);

                                let url = titleElement.getAttribute('href');

                                // console.log('URL: ', url);

                                if (url && !url.startsWith('http')) {

                                    url = 'https://jesse-anderson.github.io/Blog/_site/' + url.replace(/^\.\//, '');

                                }

                                // console.log('Formatted URL: ', url);

                                const imageUrl = imageElement ? imageElement.getAttribute('src').replace(/^\.\//, 'https://jesse-anderson.github.io/Blog/_site/') : 'default-image.jpg'; // Fallback image

                                // console.log('Image URL: ', imageUrl);

                                const listItem = document.createElement('li');

                                listItem.innerHTML = `<a href="${url}"><img src="${imageUrl}" alt="Post Image" style="height: 20px;"> ${title}</a>`;

                                latestPostsList.appendChild(listItem);

                                // console.log('ListItem: ', listItem);

                                count++;

                            } else {

                                console.warn('Missing elements for post:', post);

                            }

                        }

                    });

                });

        });

    </script>





<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="jesse-anderson/blogComments" issue-term="title" theme="github-dark" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">

<div class="cookie-consent-footer"><a href="#" id="open_preferences_center">Cookie Preferences</a></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>
<script>var lightboxQuarto = GLightbox({"openEffect":"zoom","closeEffect":"zoom","selector":".lightbox","loop":false,"descPosition":"bottom"});
window.onload = () => {
  lightboxQuarto.on('slide_before_load', (data) => {
    const { slideIndex, slideNode, slideConfig, player, trigger } = data;
    const href = trigger.getAttribute('href');
    if (href !== null) {
      const imgEl = window.document.querySelector(`a[href="${href}"] img`);
      if (imgEl !== null) {
        const srcAttr = imgEl.getAttribute("src");
        if (srcAttr && srcAttr.startsWith("data:")) {
          slideConfig.href = srcAttr;
        }
      }
    } 
  });

  lightboxQuarto.on('slide_after_load', (data) => {
    const { slideIndex, slideNode, slideConfig, player, trigger } = data;
    if (window.Quarto?.typesetMath) {
      window.Quarto.typesetMath(slideNode);
    }
  });

};
          </script>




</body></html>