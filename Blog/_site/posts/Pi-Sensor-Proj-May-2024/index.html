<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Jesse Anderson">
<meta name="dcterms.date" content="2024-05-16">

<title>Jesse Anderson’s Blog - Raspberry Pi Sensor Server Project</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/cookie-consent/cookie-consent.js"></script>
<link href="../../site_libs/cookie-consent/cookie-consent.css" rel="stylesheet">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="../../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-5CSPYCMY55"></script>

<script type="text/plain" cookie-consent="tracking">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-5CSPYCMY55', { 'anonymize_ip': true});
</script>

<script type="text/javascript" charset="UTF-8">
document.addEventListener('DOMContentLoaded', function () {
cookieconsent.run({
  "notice_banner_type":"simple",
  "consent_type":"implied",
  "palette":"light",
  "language":"en",
  "page_load_consent_levels":["strictly-necessary","functionality","tracking","targeting"],
  "notice_banner_reject_button_hide":false,
  "preferences_center_close_button_hide":false,
  "website_name":""
  ,
"language":"en"
  });
});
</script> 
  


<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="Jesse Anderson’s Blog - Raspberry Pi Sensor Server Project">
<meta property="og:description" content="">
<meta property="og:image" content="Pi Sensor Flow Complete.png">
<meta property="og:site_name" content="Jesse Anderson's Blog">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Jesse Anderson’s Blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../archive.html"> 
<span class="menu-text">Archive</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://jesse-anderson.github.io"> <i class="bi bi-Folder symlink fill" role="img">
</i> 
<span class="menu-text">Portfolio</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/jesse-anderson/"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/jesse-anderson-a7c5/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Raspberry Pi Sensor Server Project</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">Raspberry Pi</div>
                <div class="quarto-category">IoT</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Jesse Anderson </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">May 16, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<p>I finally decided to use the Raspberry Pi 4 Model B+ 8gb I had lying around to play around with some sensors. Luckily I took an electrical engineering course in circuits[ECE210 at UIC], which made it pretty straight forward to wire things up. I had also already flashed an OS to the SD card and only encountered a few issues with booting up with the pi in its case(with fan!) and the temperature/humidity sensor plugged in. Please note that setting up VNC Server(RPI) and VNC Viewer(Desktop) will speed this up dramatically. Below is a pretty simple mockup of the connection I used with the Fan’s Power on pin 4[+,5.0VDC] and pin 14[-] and the DHT11 sensor on Pin 2[+,5.0VDC], Pin 6[-], and Pin 7[GPIO7].</p>
<p><a href="GPIO-Pinout-Diagram-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="GPIO-Pinout-Diagram-2.png" class="img-fluid"></a></p>
<p><a href="https://www.raspberrypi.com/documentation/computers/raspberry-pi.html">Image source</a></p>
<p>And here’s the setup:</p>
<p><a href="DHT11 Project_bb.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="DHT11 Project_bb.png" class="img-fluid"></a></p>
<p>As a side note, Fritzing worked really well to generate the image above and I used the build at: <a href="https://github.com/Move2win/Fritzing-0.9.9.64.pc-Compiled-Build" class="uri">https://github.com/Move2win/Fritzing-0.9.9.64.pc-Compiled-Build</a></p>
<p>It is a compiled .exe on a random github repository and one should take care….. but it was definitely faster than trying to build Fritzing from source.</p>
<p>Next I got a basic python script working on my Raspberry Pi after installing the Adafruit_DHT library.</p>
<p>Installation was pretty straight forward. Enter this into the command prompt</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">sudo</span> apt-get install git-core</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Next:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1"></a><span class="fu">git</span> clone https://github.com/adafruit/Adafruit_Python_DHT.git</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Change directories:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1"></a><span class="bu">cd</span> Adafruit_Python_DHT</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1"></a><span class="fu">sudo</span> apt-get install build-essential python-dev</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Finally….:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1"></a><span class="fu">sudo</span> python setup.py install</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now create a .py file and enter the following:</p>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb6"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1"></a>{python}</span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="im">import</span> Adafruit_DHT</span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="im">import</span> requests</span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="im">import</span> time</span>
<span id="cb6-5"><a href="#cb6-5"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb6-6"><a href="#cb6-6"></a></span>
<span id="cb6-7"><a href="#cb6-7"></a><span class="co"># Sensor setup</span></span>
<span id="cb6-8"><a href="#cb6-8"></a>SENSOR <span class="op">=</span> Adafruit_DHT.DHT11  <span class="co"># Using DHT11 sensor</span></span>
<span id="cb6-9"><a href="#cb6-9"></a>PIN <span class="op">=</span> <span class="dv">4</span>  <span class="co"># Change this to the GPIO pin number that the sensor is connected to</span></span>
<span id="cb6-10"><a href="#cb6-10"></a></span>
<span id="cb6-11"><a href="#cb6-11"></a><span class="co"># Buffer to store data</span></span>
<span id="cb6-12"><a href="#cb6-12"></a>data_buffer <span class="op">=</span> []</span>
<span id="cb6-13"><a href="#cb6-13"></a></span>
<span id="cb6-14"><a href="#cb6-14"></a><span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb6-15"><a href="#cb6-15"></a>    <span class="co"># Read humidity and temperature from DHT sensor</span></span>
<span id="cb6-16"><a href="#cb6-16"></a>    humidityPercent, temperature_C <span class="op">=</span> Adafruit_DHT.read_retry(SENSOR, PIN)</span>
<span id="cb6-17"><a href="#cb6-17"></a>    </span>
<span id="cb6-18"><a href="#cb6-18"></a>    <span class="cf">if</span> humidityPercent <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> temperature_C <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb6-19"><a href="#cb6-19"></a>        </span>
<span id="cb6-20"><a href="#cb6-20"></a>        <span class="co"># Prepare the data payload</span></span>
<span id="cb6-21"><a href="#cb6-21"></a>        temperature_F <span class="op">=</span> temperature_C <span class="op">*</span> <span class="fl">9.0</span> <span class="op">/</span> <span class="fl">5.0</span> <span class="op">+</span> <span class="dv">32</span></span>
<span id="cb6-22"><a href="#cb6-22"></a>        now <span class="op">=</span> datetime.now()</span>
<span id="cb6-23"><a href="#cb6-23"></a>        date <span class="op">=</span> now.strftime(<span class="st">"%m-</span><span class="sc">%d</span><span class="st">-%Y"</span>)</span>
<span id="cb6-24"><a href="#cb6-24"></a>        timeNow <span class="op">=</span> now.strftime(<span class="st">"%H:%M:%S"</span>)</span>
<span id="cb6-25"><a href="#cb6-25"></a>        </span>
<span id="cb6-26"><a href="#cb6-26"></a>        data <span class="op">=</span> {</span>
<span id="cb6-27"><a href="#cb6-27"></a>            <span class="st">'date'</span>: date,</span>
<span id="cb6-28"><a href="#cb6-28"></a>            <span class="st">'time'</span>: timeNow,</span>
<span id="cb6-29"><a href="#cb6-29"></a>            <span class="st">'humidityPercent'</span>: humidityPercent,</span>
<span id="cb6-30"><a href="#cb6-30"></a>            <span class="st">'temperatureFahrenheit'</span>: temperature_F,</span>
<span id="cb6-31"><a href="#cb6-31"></a>            <span class="st">'temperatureCelsius'</span>: temperature_C</span>
<span id="cb6-32"><a href="#cb6-32"></a>        }</span>
<span id="cb6-33"><a href="#cb6-33"></a>        <span class="co"># Log data to buffer</span></span>
<span id="cb6-34"><a href="#cb6-34"></a>        data_buffer.append(data)</span>
<span id="cb6-35"><a href="#cb6-35"></a>        <span class="bu">print</span>(<span class="ss">f"Logged data: </span><span class="sc">{</span>data<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-36"><a href="#cb6-36"></a>        <span class="co">#clear data buffer</span></span>
<span id="cb6-37"><a href="#cb6-37"></a>        data_buffer.clear()</span>
<span id="cb6-38"><a href="#cb6-38"></a>    <span class="co"># Wait for 1 second before logging the next reading</span></span>
<span id="cb6-39"><a href="#cb6-39"></a>    time.sleep(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<details>
<summary>
Code Summary
</summary>
<p>This Python code snippet reads humidity and temperature data from a DHT11 sensor connected to a Raspberry Pi, formats the data with timestamps, and logs it. Here’s a breakdown of the key steps:</p>
<ol type="1">
<li><p><strong>Imports Necessary Libraries</strong>:</p>
<ul>
<li><p><strong><code>Adafruit_DHT</code></strong> for interfacing with the DHT11 sensor.</p></li>
<li><p><strong><code>requests</code></strong> for sending HTTP requests (though not used in this snippet).</p></li>
<li><p><strong><code>time</code></strong> for managing sleep intervals.</p></li>
<li><p><strong><code>datetime</code></strong> for timestamping data.</p></li>
</ul></li>
<li><p><strong>Sensor Setup</strong>:</p>
<ul>
<li><p>The sensor type is defined as <strong><code>DHT11</code></strong>.</p></li>
<li><p>The GPIO pin to which the sensor is connected is set to <strong><code>PIN = 4</code></strong>.</p></li>
</ul></li>
<li><p><strong>Data Buffer Initialization</strong>:</p>
<ul>
<li>An empty list <strong><code>data_buffer</code></strong> is initialized to store the sensor readings.</li>
</ul></li>
<li><p><strong>Continuous Data Logging Loop</strong>:</p>
<ul>
<li><p>Enters an infinite loop to continuously read data from the sensor.</p></li>
<li><p>Reads humidity and temperature (in Celsius) from the DHT11 sensor using <strong><code>Adafruit_DHT.read_retry(SENSOR, PIN)</code></strong>.</p></li>
<li><p>If valid data is read (i.e., not <strong><code>None</code></strong>), the following actions are performed:</p>
<ul>
<li><p>Converts the temperature from Celsius to Fahrenheit.</p></li>
<li><p>Gets the current date and time using <strong><code>datetime.now()</code></strong> and formats them as strings.</p></li>
<li><p>Prepares a dictionary <strong><code>data</code></strong> containing the date, time, humidity, temperature in Celsius, and temperature in Fahrenheit.</p></li>
<li><p>Appends the <strong><code>data</code></strong> dictionary to <strong><code>data_buffer</code></strong>.</p></li>
<li><p>Logs the data by printing it to the console.</p></li>
<li><p>Clears the <strong><code>data_buffer</code></strong> list to reset it for the next set of readings.</p></li>
</ul></li>
<li><p>Waits for 1 second before taking the next reading using <strong><code>time.sleep(1)</code></strong>.</p></li>
</ul></li>
</ol>
<p>Overall, this code continuously monitors environmental data from a DHT11 sensor, timestamps the readings, and logs them to a buffer (though the buffer is cleared immediately in this example).</p>
</details>
<p>This script will grab the current date, time, Percent Humidity, Temp in Fahrenheit/Celsius and display it to the user. Note that we are appending it to a buffer which will become important later.</p>
<p>Next I tried various server/serverless options to get realtime data and decided on Vercel. I also tried out ThingSpeak and really liked its interface, but the fact that I would have to pay(if I wasn’t a student) made me consider other options. To implement a basic realtime logging of sensor data in ThingSpeak one would sign up for an account, create a channel, populate a channel and add field labels such as Temperature and Humidity, and save the channel to receive a unique Channel ID and API key. The code for thingspeak is pretty straightforward and one can implement the code below to populate a ThingSpeak channel.</p>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb7"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1"></a>{python}</span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="im">import</span> Adafruit_DHT</span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="im">import</span> requests</span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="im">import</span> time</span>
<span id="cb7-5"><a href="#cb7-5"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb7-6"><a href="#cb7-6"></a></span>
<span id="cb7-7"><a href="#cb7-7"></a><span class="co"># Sensor setup</span></span>
<span id="cb7-8"><a href="#cb7-8"></a>SENSOR <span class="op">=</span> Adafruit_DHT.DHT11  <span class="co"># Using DHT11 sensor</span></span>
<span id="cb7-9"><a href="#cb7-9"></a>PIN <span class="op">=</span> <span class="dv">4</span>  <span class="co"># Change this to the GPIO pin number that the sensor is connected to</span></span>
<span id="cb7-10"><a href="#cb7-10"></a></span>
<span id="cb7-11"><a href="#cb7-11"></a><span class="co"># Buffer to store data</span></span>
<span id="cb7-12"><a href="#cb7-12"></a>data_buffer <span class="op">=</span> []</span>
<span id="cb7-13"><a href="#cb7-13"></a></span>
<span id="cb7-14"><a href="#cb7-14"></a><span class="co"># ThingSpeak URL</span></span>
<span id="cb7-15"><a href="#cb7-15"></a>base_url <span class="op">=</span> <span class="st">'https://api.thingspeak.com/update'</span></span>
<span id="cb7-16"><a href="#cb7-16"></a></span>
<span id="cb7-17"><a href="#cb7-17"></a><span class="co"># Replace 'YOUR_API_KEY' with your actual ThingSpeak channel write API key</span></span>
<span id="cb7-18"><a href="#cb7-18"></a>api_key <span class="op">=</span> <span class="st">'YOUR_API_KEY'</span></span>
<span id="cb7-19"><a href="#cb7-19"></a></span>
<span id="cb7-20"><a href="#cb7-20"></a><span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb7-21"><a href="#cb7-21"></a>    <span class="co"># Read humidity and temperature from DHT sensor</span></span>
<span id="cb7-22"><a href="#cb7-22"></a>    humidityPercent, temperature_C <span class="op">=</span> Adafruit_DHT.read_retry(SENSOR, PIN)</span>
<span id="cb7-23"><a href="#cb7-23"></a>    </span>
<span id="cb7-24"><a href="#cb7-24"></a>    <span class="cf">if</span> humidityPercent <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> temperature_C <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb7-25"><a href="#cb7-25"></a>        </span>
<span id="cb7-26"><a href="#cb7-26"></a>        <span class="co"># Prepare the data payload</span></span>
<span id="cb7-27"><a href="#cb7-27"></a>        temperature_F <span class="op">=</span> temperature_C <span class="op">*</span> <span class="fl">9.0</span> <span class="op">/</span> <span class="fl">5.0</span> <span class="op">+</span> <span class="dv">32</span></span>
<span id="cb7-28"><a href="#cb7-28"></a>        now <span class="op">=</span> datetime.now()</span>
<span id="cb7-29"><a href="#cb7-29"></a>        date <span class="op">=</span> now.strftime(<span class="st">"%m-</span><span class="sc">%d</span><span class="st">-%Y"</span>)</span>
<span id="cb7-30"><a href="#cb7-30"></a>        timeNow <span class="op">=</span> now.strftime(<span class="st">"%H:%M:%S"</span>)</span>
<span id="cb7-31"><a href="#cb7-31"></a>        </span>
<span id="cb7-32"><a href="#cb7-32"></a>        data <span class="op">=</span> {</span>
<span id="cb7-33"><a href="#cb7-33"></a>            <span class="st">'api_key'</span>: api_key,</span>
<span id="cb7-34"><a href="#cb7-34"></a>            <span class="st">'field1'</span>: temperature_C,</span>
<span id="cb7-35"><a href="#cb7-35"></a>            <span class="st">'field2'</span>: temperature_F,</span>
<span id="cb7-36"><a href="#cb7-36"></a>            <span class="st">'field3'</span>: humidityPercent</span>
<span id="cb7-37"><a href="#cb7-37"></a>        }</span>
<span id="cb7-38"><a href="#cb7-38"></a>        <span class="co"># Send data to ThingSpeak</span></span>
<span id="cb7-39"><a href="#cb7-39"></a>        <span class="cf">try</span>:</span>
<span id="cb7-40"><a href="#cb7-40"></a>            response <span class="op">=</span> requests.get(base_url, params<span class="op">=</span>payload)</span>
<span id="cb7-41"><a href="#cb7-41"></a>            <span class="bu">print</span>(<span class="st">'Data posted to ThingSpeak'</span>, response.text)</span>
<span id="cb7-42"><a href="#cb7-42"></a>        <span class="cf">except</span> requests.exceptions.RequestException <span class="im">as</span> e:</span>
<span id="cb7-43"><a href="#cb7-43"></a>            <span class="bu">print</span>(<span class="st">'Failed to send data:'</span>, e)</span>
<span id="cb7-44"><a href="#cb7-44"></a>        <span class="co"># Log data to buffer</span></span>
<span id="cb7-45"><a href="#cb7-45"></a>        data_buffer.append(data)</span>
<span id="cb7-46"><a href="#cb7-46"></a>        <span class="bu">print</span>(<span class="ss">f"Logged data: </span><span class="sc">{</span>data<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb7-47"><a href="#cb7-47"></a>        <span class="co">#clear data buffer</span></span>
<span id="cb7-48"><a href="#cb7-48"></a>        data_buffer.clear()</span>
<span id="cb7-49"><a href="#cb7-49"></a>    <span class="co"># Wait for 1 second before logging the next reading</span></span>
<span id="cb7-50"><a href="#cb7-50"></a>    time.sleep(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<details>
<summary>
Code Summary
</summary>
<p>This Python script reads environmental data from a DHT11 sensor and sends it to the ThingSpeak cloud service. Here is a summary of the main components and functionality:</p>
<ol type="1">
<li><p><strong>Imports Necessary Libraries</strong>:</p>
<ul>
<li><p><strong><code>Adafruit_DHT</code></strong> for interfacing with the DHT11 sensor.</p></li>
<li><p><strong><code>requests</code></strong> for making HTTP requests to ThingSpeak.</p></li>
<li><p><strong><code>time</code></strong> for managing sleep intervals.</p></li>
<li><p><strong><code>datetime</code></strong> for timestamping data.</p></li>
</ul></li>
<li><p><strong>Sensor Setup</strong>:</p>
<ul>
<li><p>The sensor type is defined as <strong><code>DHT11</code></strong>.</p></li>
<li><p>The GPIO pin to which the sensor is connected is set to <strong><code>PIN = 4</code></strong>.</p></li>
</ul></li>
<li><p><strong>Data Buffer Initialization</strong>:</p>
<ul>
<li>An empty list <strong><code>data_buffer</code></strong> is initialized to store the sensor readings.</li>
</ul></li>
<li><p><strong>ThingSpeak Configuration</strong>:</p>
<ul>
<li><p>The base URL for ThingSpeak updates is defined as <strong><code>base_url</code></strong>.</p></li>
<li><p>An API key placeholder <strong><code>api_key</code></strong> is set to <strong><code>'YOUR_API_KEY'</code></strong>. Replace this with your actual ThingSpeak channel write API key.</p></li>
</ul></li>
<li><p><strong>Continuous Data Logging Loop</strong>:</p>
<ul>
<li><p>Enters an infinite loop to continuously read data from the sensor.</p></li>
<li><p>Reads humidity and temperature (in Celsius) from the DHT11 sensor using <strong><code>Adafruit_DHT.read_retry(SENSOR, PIN)</code></strong>.</p></li>
<li><p>If valid data is read (i.e., not <strong><code>None</code></strong>), the following actions are performed:</p>
<ul>
<li><p>Converts the temperature from Celsius to Fahrenheit.</p></li>
<li><p>Gets the current date and time using <strong><code>datetime.now()</code></strong> and formats them as strings.</p></li>
<li><p>Prepares a dictionary <strong><code>data</code></strong> containing the API key, temperature in Celsius, temperature in Fahrenheit, and humidity.</p></li>
<li><p>Sends the <strong><code>data</code></strong> dictionary to ThingSpeak via a GET request using <strong><code>requests.get()</code></strong>.</p></li>
<li><p>Logs the response from ThingSpeak and any exceptions that occur during the request.</p></li>
<li><p>Logs the data to <strong><code>data_buffer</code></strong> by appending the <strong><code>data</code></strong> dictionary.</p></li>
<li><p>Clears the <strong><code>data_buffer</code></strong> list to reset it for the next set of readings.</p></li>
</ul></li>
<li><p>Waits for 1 second before taking the next reading using <strong><code>time.sleep(1)</code></strong>.</p></li>
</ul></li>
</ol>
<p>This script continuously monitors environmental data from a DHT11 sensor, sends the data to ThingSpeak, and logs the readings locally.</p>
</details>
<p>The resulting channel is functional enough:</p>
<p><a href="ThingSpeak.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="ThingSpeak.png" class="img-fluid"></a></p>
<p>Location: <a href="https://thingspeak.com/channels/2545447" class="uri">https://thingspeak.com/channels/2545447</a></p>
<p>Realistically, I may incorporate sending the data to ThingSpeak as well as the other option I chose for monitoring.</p>
<p>I got my account up and running with Vercel, installing it on a private Github repo. I then <a href="https://nodejs.org/">installed Node.js and npm</a>. Then I navigated to the repo and opened up a command prompt:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1"></a><span class="ex">npm</span> init <span class="at">-y</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>I then created a ‘/api’ directory and created a file for my sensor data handling called ‘/api/sensor.js’. Note the addition of the API_KEY variable that you should add to your Vercel global environment variables to make sure there’s some added security.</p>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb9"><pre class="sourceCode numberSource javascript number-lines code-with-copy"><code class="sourceCode javascript"><span id="cb9-1"><a href="#cb9-1"></a>{javascript}</span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="kw">const</span> API_KEY <span class="op">=</span> <span class="bu">process</span><span class="op">.</span><span class="at">env</span><span class="op">.</span><span class="at">API_KEY</span><span class="op">;</span> <span class="co">// Retrieve the API key from environment variables</span></span>
<span id="cb9-3"><a href="#cb9-3"></a></span>
<span id="cb9-4"><a href="#cb9-4"></a><span class="co">// Function for real-time data monitoring</span></span>
<span id="cb9-5"><a href="#cb9-5"></a>module<span class="op">.</span><span class="at">exports</span><span class="op">.</span><span class="at">realTimeDataMonitoring</span> <span class="op">=</span> <span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> {</span>
<span id="cb9-6"><a href="#cb9-6"></a>    <span class="cf">if</span> (req<span class="op">.</span><span class="at">method</span> <span class="op">===</span> <span class="st">'POST'</span>) {</span>
<span id="cb9-7"><a href="#cb9-7"></a>        <span class="cf">try</span> {</span>
<span id="cb9-8"><a href="#cb9-8"></a>            <span class="co">// Extract API key from request headers</span></span>
<span id="cb9-9"><a href="#cb9-9"></a>            <span class="kw">const</span> providedApiKey <span class="op">=</span> req<span class="op">.</span><span class="at">headers</span>[<span class="st">'x-api-key'</span>]<span class="op">;</span></span>
<span id="cb9-10"><a href="#cb9-10"></a></span>
<span id="cb9-11"><a href="#cb9-11"></a>            <span class="co">// Check if API key is provided and matches the expected API key</span></span>
<span id="cb9-12"><a href="#cb9-12"></a>            <span class="cf">if</span> (<span class="op">!</span>providedApiKey <span class="op">||</span> providedApiKey <span class="op">!==</span> API_KEY) {</span>
<span id="cb9-13"><a href="#cb9-13"></a>                <span class="cf">return</span> res<span class="op">.</span><span class="fu">status</span>(<span class="dv">401</span>)<span class="op">.</span><span class="fu">json</span>({ <span class="dt">error</span><span class="op">:</span> <span class="st">'Unauthorized'</span> })<span class="op">;</span></span>
<span id="cb9-14"><a href="#cb9-14"></a>            }</span>
<span id="cb9-15"><a href="#cb9-15"></a></span>
<span id="cb9-16"><a href="#cb9-16"></a>            <span class="co">// Extract data from request body just to log and test the handling</span></span>
<span id="cb9-17"><a href="#cb9-17"></a>            <span class="kw">const</span> { temperature<span class="op">,</span> humidity } <span class="op">=</span> req<span class="op">.</span><span class="at">body</span><span class="op">;</span></span>
<span id="cb9-18"><a href="#cb9-18"></a></span>
<span id="cb9-19"><a href="#cb9-19"></a>            <span class="co">// Log the data received to console for verification</span></span>
<span id="cb9-20"><a href="#cb9-20"></a>            <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Received - Temperature: </span><span class="sc">${</span>temperature<span class="sc">}</span><span class="vs">, Humidity: </span><span class="sc">${</span>humidity<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb9-21"><a href="#cb9-21"></a></span>
<span id="cb9-22"><a href="#cb9-22"></a>            <span class="co">// Send a successful response back to the client without any database interaction</span></span>
<span id="cb9-23"><a href="#cb9-23"></a>            res<span class="op">.</span><span class="fu">status</span>(<span class="dv">200</span>)<span class="op">.</span><span class="fu">json</span>({ <span class="dt">message</span><span class="op">:</span> <span class="st">'Data received successfully!'</span><span class="op">,</span> temperature<span class="op">,</span> humidity })<span class="op">;</span></span>
<span id="cb9-24"><a href="#cb9-24"></a>        } <span class="cf">catch</span> (e) {</span>
<span id="cb9-25"><a href="#cb9-25"></a>            <span class="co">// Handle errors and send an error response</span></span>
<span id="cb9-26"><a href="#cb9-26"></a>            <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(e)<span class="op">;</span></span>
<span id="cb9-27"><a href="#cb9-27"></a>            res<span class="op">.</span><span class="fu">status</span>(<span class="dv">500</span>)<span class="op">.</span><span class="fu">json</span>({ <span class="dt">error</span><span class="op">:</span> <span class="st">'An internal error occurred'</span><span class="op">,</span> <span class="dt">details</span><span class="op">:</span> e<span class="op">.</span><span class="at">message</span> })<span class="op">;</span></span>
<span id="cb9-28"><a href="#cb9-28"></a>        }</span>
<span id="cb9-29"><a href="#cb9-29"></a>    } <span class="cf">else</span> {</span>
<span id="cb9-30"><a href="#cb9-30"></a>        <span class="co">// Respond with method not allowed if not a POST request</span></span>
<span id="cb9-31"><a href="#cb9-31"></a>        res<span class="op">.</span><span class="fu">status</span>(<span class="dv">405</span>)<span class="op">.</span><span class="fu">json</span>({ <span class="dt">error</span><span class="op">:</span> <span class="st">'Method not allowed'</span> })<span class="op">;</span></span>
<span id="cb9-32"><a href="#cb9-32"></a>    }</span>
<span id="cb9-33"><a href="#cb9-33"></a>}<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<details>
<summary>
Code Summary
</summary>
<p>This JavaScript code defines a function for real-time data monitoring, intended to be used as part of an API in a Node.js environment. The function is exported as <strong><code>realTimeDataMonitoring</code></strong> and handles HTTP POST requests to log temperature and humidity data received from clients. Here is a summary of its main components and functionality:</p>
<ol type="1">
<li><p><strong>API Key Retrieval</strong>:</p>
<ul>
<li>The API key is retrieved from environment variables using <strong><code>process.env.API_KEY</code></strong>.</li>
</ul></li>
<li><p><strong>Function Definition</strong>:</p>
<ul>
<li>The <strong><code>realTimeDataMonitoring</code></strong> function is an asynchronous function designed to handle HTTP requests, specifically POST requests.</li>
</ul></li>
<li><p><strong>Request Handling</strong>:</p>
<ul>
<li>The function first checks if the request method is POST. If not, it responds with a <strong><code>405 Method Not Allowed</code></strong> status.</li>
</ul></li>
<li><p><strong>API Key Validation</strong>:</p>
<ul>
<li><p>The function extracts the provided API key from the request headers (<strong><code>x-api-key</code></strong>).</p></li>
<li><p>It checks if the provided API key matches the expected API key. If not, it responds with a <strong><code>401 Unauthorized</code></strong> status.</p></li>
</ul></li>
<li><p><strong>Data Extraction and Logging</strong>:</p>
<ul>
<li><p>If the API key is valid, the function extracts temperature and humidity data from the request body.</p></li>
<li><p>It logs the received data to the console for verification.</p></li>
</ul></li>
<li><p><strong>Response to Client</strong>:</p>
<ul>
<li>The function sends a <strong><code>200 OK</code></strong> response back to the client, confirming successful data reception, along with the received temperature and humidity data.</li>
</ul></li>
<li><p><strong>Error Handling</strong>:</p>
<ul>
<li>If an error occurs during the process, it catches the exception, logs the error, and responds with a <strong><code>500 Internal Server Error</code></strong> status, including the error details.</li>
</ul></li>
<li><p><strong>Exporting the Function</strong>:</p>
<ul>
<li>The function is exported using <strong><code>module.exports</code></strong> for use in other parts of the application.</li>
</ul></li>
</ol>
<p>This setup ensures secure and controlled data reception for real-time monitoring, with proper error handling and validation mechanisms in place.</p>
</details>
<p>From here I pushed the changes to github which caused the Vercel site to redeploy and changed the code on the Raspberry Pi to the following:</p>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb10"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1"></a>{python}</span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="im">import</span> Adafruit_DHT</span>
<span id="cb10-3"><a href="#cb10-3"></a><span class="im">import</span> requests</span>
<span id="cb10-4"><a href="#cb10-4"></a><span class="im">import</span> time</span>
<span id="cb10-5"><a href="#cb10-5"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb10-6"><a href="#cb10-6"></a></span>
<span id="cb10-7"><a href="#cb10-7"></a><span class="co"># Sensor setup</span></span>
<span id="cb10-8"><a href="#cb10-8"></a>SENSOR <span class="op">=</span> Adafruit_DHT.DHT11  <span class="co"># Using DHT11 sensor</span></span>
<span id="cb10-9"><a href="#cb10-9"></a>PIN <span class="op">=</span> <span class="dv">4</span>  <span class="co"># Change this to the GPIO pin number that the sensor is connected to</span></span>
<span id="cb10-10"><a href="#cb10-10"></a></span>
<span id="cb10-11"><a href="#cb10-11"></a><span class="co"># Buffer to store data</span></span>
<span id="cb10-12"><a href="#cb10-12"></a>data_buffer <span class="op">=</span> []</span>
<span id="cb10-13"><a href="#cb10-13"></a></span>
<span id="cb10-14"><a href="#cb10-14"></a><span class="co"># Vercel endpoint URL</span></span>
<span id="cb10-15"><a href="#cb10-15"></a>URL <span class="op">=</span> <span class="st">'https://your-vercel-url.vercel.app/api/sensor'</span></span>
<span id="cb10-16"><a href="#cb10-16"></a></span>
<span id="cb10-17"><a href="#cb10-17"></a><span class="co"># Define your Vercel API key</span></span>
<span id="cb10-18"><a href="#cb10-18"></a>API_KEY <span class="op">=</span> <span class="st">'YOUR_API_KEY'</span></span>
<span id="cb10-19"><a href="#cb10-19"></a></span>
<span id="cb10-20"><a href="#cb10-20"></a><span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb10-21"><a href="#cb10-21"></a>    <span class="co"># Read humidity and temperature from DHT sensor</span></span>
<span id="cb10-22"><a href="#cb10-22"></a>    humidityPercent, temperature_C <span class="op">=</span> Adafruit_DHT.read_retry(SENSOR, PIN)</span>
<span id="cb10-23"><a href="#cb10-23"></a>    </span>
<span id="cb10-24"><a href="#cb10-24"></a>    <span class="cf">if</span> humidityPercent <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> temperature_C <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb10-25"><a href="#cb10-25"></a>        </span>
<span id="cb10-26"><a href="#cb10-26"></a>        <span class="co"># Prepare the data payload</span></span>
<span id="cb10-27"><a href="#cb10-27"></a>        temperature_F <span class="op">=</span> temperature_C <span class="op">*</span> <span class="fl">9.0</span> <span class="op">/</span> <span class="fl">5.0</span> <span class="op">+</span> <span class="dv">32</span></span>
<span id="cb10-28"><a href="#cb10-28"></a>        now <span class="op">=</span> datetime.now()</span>
<span id="cb10-29"><a href="#cb10-29"></a>        date <span class="op">=</span> now.strftime(<span class="st">"%m-</span><span class="sc">%d</span><span class="st">-%Y"</span>)</span>
<span id="cb10-30"><a href="#cb10-30"></a>        timeNow <span class="op">=</span> now.strftime(<span class="st">"%H:%M:%S"</span>)</span>
<span id="cb10-31"><a href="#cb10-31"></a>        </span>
<span id="cb10-32"><a href="#cb10-32"></a>        data <span class="op">=</span> {</span>
<span id="cb10-33"><a href="#cb10-33"></a>            <span class="st">'date'</span>: date,</span>
<span id="cb10-34"><a href="#cb10-34"></a>            <span class="st">'time'</span>: timeNow,</span>
<span id="cb10-35"><a href="#cb10-35"></a>            <span class="st">'humidityPercent'</span>: humidityPercent,</span>
<span id="cb10-36"><a href="#cb10-36"></a>            <span class="st">'temperatureFahrenheit'</span>: temperature_F,</span>
<span id="cb10-37"><a href="#cb10-37"></a>            <span class="st">'temperatureCelsius'</span>: temperature_C</span>
<span id="cb10-38"><a href="#cb10-38"></a>        }</span>
<span id="cb10-39"><a href="#cb10-39"></a></span>
<span id="cb10-40"><a href="#cb10-40"></a>        <span class="co"># Send data to Vercel</span></span>
<span id="cb10-41"><a href="#cb10-41"></a>        <span class="cf">try</span>:</span>
<span id="cb10-42"><a href="#cb10-42"></a>            <span class="co"># Send the data to the server with the API key in the headers</span></span>
<span id="cb10-43"><a href="#cb10-43"></a>            headers <span class="op">=</span> {<span class="st">'x-api-key'</span>: API_KEY}</span>
<span id="cb10-44"><a href="#cb10-44"></a>            response <span class="op">=</span> requests.post(URL, json<span class="op">=</span>data, headers<span class="op">=</span>headers)</span>
<span id="cb10-45"><a href="#cb10-45"></a>            <span class="bu">print</span>(<span class="ss">f"Data sent to server: </span><span class="sc">{</span>response<span class="sc">.</span>text<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb10-46"><a href="#cb10-46"></a>        <span class="cf">except</span> requests.exceptions.RequestException <span class="im">as</span> e:</span>
<span id="cb10-47"><a href="#cb10-47"></a>            <span class="co"># Handle exceptions that arise from sending the request</span></span>
<span id="cb10-48"><a href="#cb10-48"></a>            <span class="bu">print</span>(<span class="ss">f"Failed to send data to server: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb10-49"><a href="#cb10-49"></a>    <span class="cf">else</span>:</span>
<span id="cb10-50"><a href="#cb10-50"></a>        <span class="co"># Handle cases where sensor fails to read</span></span>
<span id="cb10-51"><a href="#cb10-51"></a>        <span class="bu">print</span>(<span class="st">"Failed to retrieve data from sensor"</span>)</span>
<span id="cb10-52"><a href="#cb10-52"></a>    </span>
<span id="cb10-53"><a href="#cb10-53"></a>    <span class="co"># Wait for 1 second before logging the next reading</span></span>
<span id="cb10-54"><a href="#cb10-54"></a>    time.sleep(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<details>
<summary>
Code Summary
</summary>
<p>This Python script reads environmental data from a DHT11 sensor and sends it to a Vercel endpoint for real-time monitoring. Here are the main components and functionalities of the script:</p>
<ol type="1">
<li><p><strong>Imports Necessary Libraries</strong>:</p>
<ul>
<li><p><strong><code>Adafruit_DHT</code></strong> for interfacing with the DHT11 sensor.</p></li>
<li><p><strong><code>requests</code></strong> for making HTTP POST requests to the Vercel endpoint.</p></li>
<li><p><strong><code>time</code></strong> for managing sleep intervals.</p></li>
<li><p><strong><code>datetime</code></strong> for timestamping data.</p></li>
</ul></li>
<li><p><strong>Sensor Setup</strong>:</p>
<ul>
<li><p>Defines the sensor type as <strong><code>DHT11</code></strong>.</p></li>
<li><p>Sets the GPIO pin connected to the sensor as <strong><code>PIN = 4</code></strong>.</p></li>
</ul></li>
<li><p><strong>Data Buffer Initialization</strong>:</p>
<ul>
<li>Initializes an empty list <strong><code>data_buffer</code></strong> to store the sensor readings (though it is not used in this script).</li>
</ul></li>
<li><p><strong>Vercel Configuration</strong>:</p>
<ul>
<li><p>Defines the Vercel endpoint URL (<strong><code>URL</code></strong>).</p></li>
<li><p>Sets an API key (<strong><code>API_KEY</code></strong>) for authenticating with the Vercel endpoint.</p></li>
</ul></li>
<li><p><strong>Continuous Data Logging Loop</strong>:</p>
<ul>
<li><p>Enters an infinite loop to continuously read data from the sensor.</p></li>
<li><p>Reads humidity and temperature (in Celsius) from the DHT11 sensor using <strong><code>Adafruit_DHT.read_retry(SENSOR, PIN)</code></strong>.</p></li>
<li><p>If valid data is read (i.e., not <strong><code>None</code></strong>), the following actions are performed:</p>
<ul>
<li><p>Converts the temperature from Celsius to Fahrenheit.</p></li>
<li><p>Gets the current date and time using <strong><code>datetime.now()</code></strong> and formats them as strings.</p></li>
<li><p>Prepares a dictionary <strong><code>data</code></strong> containing the date, time, humidity, temperature in Celsius, and temperature in Fahrenheit.</p></li>
<li><p>Sends the <strong><code>data</code></strong> dictionary to the Vercel endpoint via a POST request using <strong><code>requests.post()</code></strong>.</p></li>
<li><p>Prints the server’s response to the console.</p></li>
<li><p>Catches and handles any exceptions that arise from sending the request, printing an error message if the request fails.</p></li>
</ul></li>
<li><p>If the sensor fails to read data, it prints an error message.</p></li>
<li><p>Waits for 1 second before taking the next reading using <strong><code>time.sleep(1)</code></strong>.</p></li>
</ul></li>
</ol>
<p>This script continuously monitors environmental data from a DHT11 sensor, sends the data to a Vercel endpoint for real-time monitoring, and logs the readings locally. It includes error handling for both sensor read failures and HTTP request failures.</p>
</details>
<p>I will omit the fact that I spent forever trying to also get MongoDB to work within Vercel and later found out that I needed to perform some sort of installation to get it to work. I did however find out that Vercel offered a PostgreSQL implementation so I could store my data as it came in. I navigated to Storage and found it was a few pretty simple clicks to get it going.</p>
<p>I created a table using:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode numberSource sql number-lines code-with-copy"><code class="sourceCode sql"><span id="cb11-1"><a href="#cb11-1"></a>{sql}</span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> readings (</span>
<span id="cb11-3"><a href="#cb11-3"></a>    <span class="kw">id</span> SERIAL <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb11-4"><a href="#cb11-4"></a>    <span class="dt">Date</span> <span class="dt">DATE</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb11-5"><a href="#cb11-5"></a>    <span class="dt">Time</span> <span class="dt">TIME</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb11-6"><a href="#cb11-6"></a>    humidityPercent <span class="dt">FLOAT</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb11-7"><a href="#cb11-7"></a>    temperatureFahrenheit <span class="dt">FLOAT</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb11-8"><a href="#cb11-8"></a>    temperatureCelsius <span class="dt">FLOAT</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb11-9"><a href="#cb11-9"></a>);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>And extended sensor.js a bit…Namely I edited it so it can handle a data_buffer of multiple points as well as singular points to cut down on server connection overhead. I also added some logging for the sake of sanity on the off chance anything ever goes wrong.</p>
<p>Note, you need to install pg on your github directory for PostgreSQL to work.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1"></a><span class="bu">cd</span> yourDirectory</span>
<span id="cb12-2"><a href="#cb12-2"></a><span class="ex">npm</span> install pg</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb13"><pre class="sourceCode numberSource javascript number-lines code-with-copy"><code class="sourceCode javascript"><span id="cb13-1"><a href="#cb13-1"></a>{javascript}</span>
<span id="cb13-2"><a href="#cb13-2"></a><span class="kw">const</span> API_KEY <span class="op">=</span> <span class="bu">process</span><span class="op">.</span><span class="at">env</span><span class="op">.</span><span class="at">API_KEY</span><span class="op">;</span> <span class="co">// Retrieve the API key from environment variables</span></span>
<span id="cb13-3"><a href="#cb13-3"></a></span>
<span id="cb13-4"><a href="#cb13-4"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">'API Key:'</span><span class="op">,</span> API_KEY)<span class="op">;</span>  <span class="co">// For debugging purposes</span></span>
<span id="cb13-5"><a href="#cb13-5"></a></span>
<span id="cb13-6"><a href="#cb13-6"></a><span class="kw">const</span> { Pool } <span class="op">=</span> <span class="pp">require</span>(<span class="st">'pg'</span>)<span class="op">;</span></span>
<span id="cb13-7"><a href="#cb13-7"></a></span>
<span id="cb13-8"><a href="#cb13-8"></a><span class="co">// PostgreSQL connection setup</span></span>
<span id="cb13-9"><a href="#cb13-9"></a><span class="kw">const</span> pool <span class="op">=</span> <span class="kw">new</span> <span class="fu">Pool</span>({</span>
<span id="cb13-10"><a href="#cb13-10"></a>    <span class="dt">connectionString</span><span class="op">:</span> <span class="bu">process</span><span class="op">.</span><span class="at">env</span><span class="op">.</span><span class="at">POSTGRES_URL</span><span class="op">,</span> <span class="co">// Make sure to set this environment variable in Vercel</span></span>
<span id="cb13-11"><a href="#cb13-11"></a>    <span class="dt">ssl</span><span class="op">:</span> {</span>
<span id="cb13-12"><a href="#cb13-12"></a>        <span class="dt">rejectUnauthorized</span><span class="op">:</span> <span class="kw">false</span></span>
<span id="cb13-13"><a href="#cb13-13"></a>    }</span>
<span id="cb13-14"><a href="#cb13-14"></a>})<span class="op">;</span></span>
<span id="cb13-15"><a href="#cb13-15"></a></span>
<span id="cb13-16"><a href="#cb13-16"></a><span class="co">// Function to handle logging and appending data to PostgreSQL</span></span>
<span id="cb13-17"><a href="#cb13-17"></a><span class="kw">const</span> handleSensorData <span class="op">=</span> <span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> {</span>
<span id="cb13-18"><a href="#cb13-18"></a>    <span class="cf">if</span> (req<span class="op">.</span><span class="at">method</span> <span class="op">!==</span> <span class="st">'POST'</span>) {</span>
<span id="cb13-19"><a href="#cb13-19"></a>        <span class="cf">return</span> res<span class="op">.</span><span class="fu">status</span>(<span class="dv">405</span>)<span class="op">.</span><span class="fu">json</span>({ <span class="dt">error</span><span class="op">:</span> <span class="st">'Method not allowed'</span> })<span class="op">;</span></span>
<span id="cb13-20"><a href="#cb13-20"></a>    }</span>
<span id="cb13-21"><a href="#cb13-21"></a></span>
<span id="cb13-22"><a href="#cb13-22"></a>    <span class="cf">try</span> {</span>
<span id="cb13-23"><a href="#cb13-23"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">'Request received'</span>)<span class="op">;</span>  <span class="co">// For debugging purposes</span></span>
<span id="cb13-24"><a href="#cb13-24"></a></span>
<span id="cb13-25"><a href="#cb13-25"></a>        <span class="co">// Extract API key from request headers</span></span>
<span id="cb13-26"><a href="#cb13-26"></a>        <span class="kw">const</span> providedApiKey <span class="op">=</span> req<span class="op">.</span><span class="at">headers</span>[<span class="st">'x-api-key'</span>]<span class="op">;</span></span>
<span id="cb13-27"><a href="#cb13-27"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">'Provided API Key:'</span><span class="op">,</span> providedApiKey)<span class="op">;</span>  <span class="co">// For debugging purposes</span></span>
<span id="cb13-28"><a href="#cb13-28"></a></span>
<span id="cb13-29"><a href="#cb13-29"></a>        <span class="co">// Check if API key is provided and matches the expected API key</span></span>
<span id="cb13-30"><a href="#cb13-30"></a>        <span class="cf">if</span> (<span class="op">!</span>providedApiKey <span class="op">||</span> providedApiKey <span class="op">!==</span> API_KEY) {</span>
<span id="cb13-31"><a href="#cb13-31"></a>            <span class="cf">return</span> res<span class="op">.</span><span class="fu">status</span>(<span class="dv">401</span>)<span class="op">.</span><span class="fu">json</span>({ <span class="dt">error</span><span class="op">:</span> <span class="st">'Unauthorized'</span> })<span class="op">;</span></span>
<span id="cb13-32"><a href="#cb13-32"></a>        }</span>
<span id="cb13-33"><a href="#cb13-33"></a></span>
<span id="cb13-34"><a href="#cb13-34"></a>        <span class="co">// Extract data from request body</span></span>
<span id="cb13-35"><a href="#cb13-35"></a>        <span class="kw">const</span> data <span class="op">=</span> req<span class="op">.</span><span class="at">body</span><span class="op">;</span></span>
<span id="cb13-36"><a href="#cb13-36"></a></span>
<span id="cb13-37"><a href="#cb13-37"></a>        <span class="co">// Log the data received to console for verification</span></span>
<span id="cb13-38"><a href="#cb13-38"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">'Received data:'</span><span class="op">,</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(data<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></span>
<span id="cb13-39"><a href="#cb13-39"></a></span>
<span id="cb13-40"><a href="#cb13-40"></a>        <span class="kw">let</span> query<span class="op">;</span></span>
<span id="cb13-41"><a href="#cb13-41"></a>        <span class="kw">let</span> values<span class="op">;</span></span>
<span id="cb13-42"><a href="#cb13-42"></a></span>
<span id="cb13-43"><a href="#cb13-43"></a>        <span class="co">// Check if data is an array (multiple readings) or a single reading</span></span>
<span id="cb13-44"><a href="#cb13-44"></a>        <span class="cf">if</span> (<span class="bu">Array</span><span class="op">.</span><span class="fu">isArray</span>(data)) {</span>
<span id="cb13-45"><a href="#cb13-45"></a>            <span class="co">// SQL query to insert multiple readings</span></span>
<span id="cb13-46"><a href="#cb13-46"></a>            query <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb13-47"><a href="#cb13-47"></a><span class="vs">                INSERT INTO readings (temperatureCelsius, temperatureFahrenheit, humidityPercent, date, time)</span></span>
<span id="cb13-48"><a href="#cb13-48"></a><span class="vs">                VALUES </span><span class="sc">${</span>data<span class="op">.</span><span class="fu">map</span>((_<span class="op">,</span> index) <span class="kw">=&gt;</span> <span class="vs">`($</span><span class="sc">${</span>index <span class="op">*</span> <span class="dv">5</span> <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="vs">, $</span><span class="sc">${</span>index <span class="op">*</span> <span class="dv">5</span> <span class="op">+</span> <span class="dv">2</span><span class="sc">}</span><span class="vs">, $</span><span class="sc">${</span>index <span class="op">*</span> <span class="dv">5</span> <span class="op">+</span> <span class="dv">3</span><span class="sc">}</span><span class="vs">, $</span><span class="sc">${</span>index <span class="op">*</span> <span class="dv">5</span> <span class="op">+</span> <span class="dv">4</span><span class="sc">}</span><span class="vs">, $</span><span class="sc">${</span>index <span class="op">*</span> <span class="dv">5</span> <span class="op">+</span> <span class="dv">5</span><span class="sc">}</span><span class="vs">)`</span>)<span class="op">.</span><span class="fu">join</span>(<span class="st">', '</span>)<span class="sc">}</span></span>
<span id="cb13-49"><a href="#cb13-49"></a><span class="vs">                RETURNING *;</span></span>
<span id="cb13-50"><a href="#cb13-50"></a><span class="vs">            `</span><span class="op">;</span></span>
<span id="cb13-51"><a href="#cb13-51"></a></span>
<span id="cb13-52"><a href="#cb13-52"></a>            <span class="co">// Flatten the array of data into a single array of values</span></span>
<span id="cb13-53"><a href="#cb13-53"></a>            values <span class="op">=</span> data<span class="op">.</span><span class="fu">flatMap</span>(({ temperatureCelsius<span class="op">,</span> temperatureFahrenheit<span class="op">,</span> humidityPercent<span class="op">,</span> date<span class="op">,</span> time }) <span class="kw">=&gt;</span> [</span>
<span id="cb13-54"><a href="#cb13-54"></a>                temperatureCelsius <span class="op">!==</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> temperatureCelsius <span class="op">!==</span> <span class="kw">undefined</span> <span class="op">?</span> temperatureCelsius <span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb13-55"><a href="#cb13-55"></a>                temperatureFahrenheit <span class="op">!==</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> temperatureFahrenheit <span class="op">!==</span> <span class="kw">undefined</span> <span class="op">?</span> temperatureFahrenheit <span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb13-56"><a href="#cb13-56"></a>                humidityPercent <span class="op">!==</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> humidityPercent <span class="op">!==</span> <span class="kw">undefined</span> <span class="op">?</span> humidityPercent <span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb13-57"><a href="#cb13-57"></a>                date <span class="op">!==</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> date <span class="op">!==</span> <span class="kw">undefined</span> <span class="op">?</span> date <span class="op">:</span> <span class="kw">new</span> <span class="bu">Date</span>()<span class="op">.</span><span class="fu">toISOString</span>()<span class="op">.</span><span class="fu">split</span>(<span class="st">'T'</span>)[<span class="dv">0</span>]<span class="op">,</span></span>
<span id="cb13-58"><a href="#cb13-58"></a>                time <span class="op">!==</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> time <span class="op">!==</span> <span class="kw">undefined</span> <span class="op">?</span> time <span class="op">:</span> <span class="kw">new</span> <span class="bu">Date</span>()<span class="op">.</span><span class="fu">toISOString</span>()<span class="op">.</span><span class="fu">split</span>(<span class="st">'T'</span>)[<span class="dv">1</span>]<span class="op">.</span><span class="fu">split</span>(<span class="st">'.'</span>)[<span class="dv">0</span>]</span>
<span id="cb13-59"><a href="#cb13-59"></a>            ])<span class="op">;</span></span>
<span id="cb13-60"><a href="#cb13-60"></a>        } <span class="cf">else</span> {</span>
<span id="cb13-61"><a href="#cb13-61"></a>            <span class="co">// SQL query to insert a single reading</span></span>
<span id="cb13-62"><a href="#cb13-62"></a>            query <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb13-63"><a href="#cb13-63"></a><span class="vs">                INSERT INTO readings (temperatureCelsius, temperatureFahrenheit, humidityPercent, date, time)</span></span>
<span id="cb13-64"><a href="#cb13-64"></a><span class="vs">                VALUES ($1, $2, $3, $4, $5)</span></span>
<span id="cb13-65"><a href="#cb13-65"></a><span class="vs">                RETURNING *;</span></span>
<span id="cb13-66"><a href="#cb13-66"></a><span class="vs">            `</span><span class="op">;</span></span>
<span id="cb13-67"><a href="#cb13-67"></a></span>
<span id="cb13-68"><a href="#cb13-68"></a>            <span class="co">// Single reading values</span></span>
<span id="cb13-69"><a href="#cb13-69"></a>            values <span class="op">=</span> [</span>
<span id="cb13-70"><a href="#cb13-70"></a>                data<span class="op">.</span><span class="at">temperatureCelsius</span> <span class="op">!==</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> data<span class="op">.</span><span class="at">temperatureCelsius</span> <span class="op">!==</span> <span class="kw">undefined</span> <span class="op">?</span> data<span class="op">.</span><span class="at">temperatureCelsius</span> <span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb13-71"><a href="#cb13-71"></a>                data<span class="op">.</span><span class="at">temperatureFahrenheit</span> <span class="op">!==</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> data<span class="op">.</span><span class="at">temperatureFahrenheit</span> <span class="op">!==</span> <span class="kw">undefined</span> <span class="op">?</span> data<span class="op">.</span><span class="at">temperatureFahrenheit</span> <span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb13-72"><a href="#cb13-72"></a>                data<span class="op">.</span><span class="at">humidityPercent</span> <span class="op">!==</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> data<span class="op">.</span><span class="at">humidityPercent</span> <span class="op">!==</span> <span class="kw">undefined</span> <span class="op">?</span> data<span class="op">.</span><span class="at">humidityPercent</span> <span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb13-73"><a href="#cb13-73"></a>                data<span class="op">.</span><span class="at">date</span> <span class="op">!==</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> data<span class="op">.</span><span class="at">date</span> <span class="op">!==</span> <span class="kw">undefined</span> <span class="op">?</span> data<span class="op">.</span><span class="at">date</span> <span class="op">:</span> <span class="kw">new</span> <span class="bu">Date</span>()<span class="op">.</span><span class="fu">toISOString</span>()<span class="op">.</span><span class="fu">split</span>(<span class="st">'T'</span>)[<span class="dv">0</span>]<span class="op">,</span></span>
<span id="cb13-74"><a href="#cb13-74"></a>                data<span class="op">.</span><span class="at">time</span> <span class="op">!==</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> data<span class="op">.</span><span class="at">time</span> <span class="op">!==</span> <span class="kw">undefined</span> <span class="op">?</span> data<span class="op">.</span><span class="at">time</span> <span class="op">:</span> <span class="kw">new</span> <span class="bu">Date</span>()<span class="op">.</span><span class="fu">toISOString</span>()<span class="op">.</span><span class="fu">split</span>(<span class="st">'T'</span>)[<span class="dv">1</span>]<span class="op">.</span><span class="fu">split</span>(<span class="st">'.'</span>)[<span class="dv">0</span>]</span>
<span id="cb13-75"><a href="#cb13-75"></a>            ]<span class="op">;</span></span>
<span id="cb13-76"><a href="#cb13-76"></a>        }</span>
<span id="cb13-77"><a href="#cb13-77"></a></span>
<span id="cb13-78"><a href="#cb13-78"></a>        <span class="co">// Execute the query</span></span>
<span id="cb13-79"><a href="#cb13-79"></a>        <span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> pool<span class="op">.</span><span class="fu">query</span>(query<span class="op">,</span> values)<span class="op">;</span></span>
<span id="cb13-80"><a href="#cb13-80"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">'Data stored in PostgreSQL:'</span><span class="op">,</span> result<span class="op">.</span><span class="at">rows</span>)<span class="op">;</span></span>
<span id="cb13-81"><a href="#cb13-81"></a></span>
<span id="cb13-82"><a href="#cb13-82"></a>        <span class="co">// Send a successful response back to the client</span></span>
<span id="cb13-83"><a href="#cb13-83"></a>        res<span class="op">.</span><span class="fu">status</span>(<span class="dv">200</span>)<span class="op">.</span><span class="fu">json</span>({ <span class="dt">message</span><span class="op">:</span> <span class="st">'Data received and stored successfully!'</span><span class="op">,</span> <span class="dt">data</span><span class="op">:</span> result<span class="op">.</span><span class="at">rows</span> })<span class="op">;</span></span>
<span id="cb13-84"><a href="#cb13-84"></a>    } <span class="cf">catch</span> (e) {</span>
<span id="cb13-85"><a href="#cb13-85"></a>        <span class="co">// Handle errors and send an error response</span></span>
<span id="cb13-86"><a href="#cb13-86"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">"Error connecting to PostgreSQL or inserting data:"</span><span class="op">,</span> e)<span class="op">;</span></span>
<span id="cb13-87"><a href="#cb13-87"></a>        res<span class="op">.</span><span class="fu">status</span>(<span class="dv">500</span>)<span class="op">.</span><span class="fu">json</span>({ <span class="dt">error</span><span class="op">:</span> <span class="st">'Failed to connect to database or insert data'</span><span class="op">,</span> <span class="dt">details</span><span class="op">:</span> e<span class="op">.</span><span class="at">message</span> })<span class="op">;</span></span>
<span id="cb13-88"><a href="#cb13-88"></a>    }</span>
<span id="cb13-89"><a href="#cb13-89"></a>}<span class="op">;</span></span>
<span id="cb13-90"><a href="#cb13-90"></a></span>
<span id="cb13-91"><a href="#cb13-91"></a><span class="co">// Export the function for Vercel</span></span>
<span id="cb13-92"><a href="#cb13-92"></a>module<span class="op">.</span><span class="at">exports</span> <span class="op">=</span> handleSensorData<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<details>
<summary>
Code Summary
</summary>
<p>This JavaScript code handles real-time sensor data logging and storage in a PostgreSQL database. It is designed to be used in a Node.js environment and is likely intended to run on Vercel. Here is a summary of the main components and functionality:</p>
<ol type="1">
<li><p><strong>API Key Retrieval</strong>:</p>
<ul>
<li>The API key is retrieved from environment variables using <strong><code>process.env.API_KEY</code></strong>.</li>
</ul></li>
<li><p><strong>Debugging Logs</strong>:</p>
<ul>
<li>Logs the API key and other debugging information to the console.</li>
</ul></li>
<li><p><strong>PostgreSQL Connection Setup</strong>:</p>
<ul>
<li><p>Uses the <strong><code>pg</code></strong> library to create a connection pool to the PostgreSQL database.</p></li>
<li><p>The connection string is retrieved from the <strong><code>POSTGRES_URL</code></strong> environment variable.</p></li>
<li><p>SSL connection is configured with <strong><code>rejectUnauthorized: false</code></strong>.</p></li>
</ul></li>
<li><p><strong>Function to Handle Sensor Data</strong>:</p>
<ul>
<li><p>The function <strong><code>handleSensorData</code></strong> is exported for use in Vercel.</p></li>
<li><p>It handles HTTP POST requests to log and store sensor data.</p></li>
</ul></li>
<li><p><strong>Request Handling</strong>:</p>
<ul>
<li><p>Checks if the request method is POST. If not, it responds with a <strong><code>405 Method Not Allowed</code></strong> status.</p></li>
<li><p>Extracts the provided API key from the request headers and logs it for debugging.</p></li>
<li><p>Compares the provided API key with the expected API key. If they do not match, it responds with a <strong><code>401 Unauthorized</code></strong> status.</p></li>
</ul></li>
<li><p><strong>Data Extraction and Logging</strong>:</p>
<ul>
<li>Extracts the sensor data from the request body and logs it to the console for verification.</li>
</ul></li>
<li><p><strong>SQL Query Preparation</strong>:</p>
<ul>
<li><p>Prepares an SQL query to insert the sensor data into the <strong><code>readings</code></strong> table in PostgreSQL.</p></li>
<li><p>Supports both single reading and multiple readings (batch) insertions.</p></li>
<li><p>Constructs the query and flattens the data array for batch insertions.</p></li>
</ul></li>
<li><p><strong>Database Insertion</strong>:</p>
<ul>
<li><p>Executes the SQL query using the connection pool.</p></li>
<li><p>Logs the inserted data to the console.</p></li>
</ul></li>
<li><p><strong>Response to Client</strong>:</p>
<ul>
<li>Sends a <strong><code>200 OK</code></strong> response back to the client, confirming successful data reception and storage, along with the inserted data.</li>
</ul></li>
<li><p><strong>Error Handling</strong>:</p>
<ul>
<li><p>Catches any exceptions that occur during the database connection or data insertion.</p></li>
<li><p>Logs the error and responds with a <strong><code>500 Internal Server Error</code></strong> status, including error details.</p></li>
</ul></li>
</ol>
<p>This script ensures secure, real-time logging of sensor data, with proper validation and error handling, and stores the data in a PostgreSQL database.</p>
</details>
<p>From there what my final product looks like is an html page which displays the latest sensor readings, a javascript function to pull the entire dataset, a javascript function which pushes the data into the database, and the python script on the raspberry pi sending the data. I actually bunch up the data before I push it to save on the overhead costs of establishing a connection. Realistically the data isn’t too time sensitive and a window of 1-5 minutes is perfectly acceptable for readings. They are below:</p>
<p>Html:</p>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb14"><pre class="sourceCode numberSource html number-lines code-with-copy"><code class="sourceCode html"><span id="cb14-1"><a href="#cb14-1"></a>{html}</span>
<span id="cb14-2"><a href="#cb14-2"></a><span class="dt">&lt;!DOCTYPE</span> html<span class="dt">&gt;</span></span>
<span id="cb14-3"><a href="#cb14-3"></a><span class="dt">&lt;</span><span class="kw">html</span><span class="ot"> lang</span><span class="op">=</span><span class="st">"en"</span><span class="dt">&gt;</span></span>
<span id="cb14-4"><a href="#cb14-4"></a><span class="dt">&lt;</span><span class="kw">head</span><span class="dt">&gt;</span></span>
<span id="cb14-5"><a href="#cb14-5"></a>    <span class="dt">&lt;</span><span class="kw">meta</span><span class="ot"> charset</span><span class="op">=</span><span class="st">"UTF-8"</span><span class="dt">&gt;</span></span>
<span id="cb14-6"><a href="#cb14-6"></a>    <span class="dt">&lt;</span><span class="kw">meta</span><span class="ot"> name</span><span class="op">=</span><span class="st">"viewport"</span><span class="ot"> content</span><span class="op">=</span><span class="st">"width=device-width, initial-scale=1.0"</span><span class="dt">&gt;</span></span>
<span id="cb14-7"><a href="#cb14-7"></a>    <span class="dt">&lt;</span><span class="kw">title</span><span class="dt">&gt;</span>Download Table Data<span class="dt">&lt;/</span><span class="kw">title</span><span class="dt">&gt;</span></span>
<span id="cb14-8"><a href="#cb14-8"></a>    <span class="dt">&lt;</span><span class="kw">style</span><span class="dt">&gt;</span></span>
<span id="cb14-9"><a href="#cb14-9"></a>        <span class="co">/* CSS to style the table with borders */</span></span>
<span id="cb14-10"><a href="#cb14-10"></a>        table {</span>
<span id="cb14-11"><a href="#cb14-11"></a>            <span class="kw">border-collapse</span><span class="ch">:</span> <span class="dv">collapse</span><span class="op">;</span></span>
<span id="cb14-12"><a href="#cb14-12"></a>            <span class="kw">width</span><span class="ch">:</span> <span class="dv">100</span><span class="dt">%</span><span class="op">;</span></span>
<span id="cb14-13"><a href="#cb14-13"></a>        }</span>
<span id="cb14-14"><a href="#cb14-14"></a>        th<span class="op">,</span> td {</span>
<span id="cb14-15"><a href="#cb14-15"></a>            <span class="kw">border</span><span class="ch">:</span> <span class="dv">1</span><span class="dt">px</span> <span class="dv">solid</span> <span class="cn">#dddddd</span><span class="op">;</span></span>
<span id="cb14-16"><a href="#cb14-16"></a>            <span class="kw">text-align</span><span class="ch">:</span> <span class="dv">left</span><span class="op">;</span></span>
<span id="cb14-17"><a href="#cb14-17"></a>            <span class="kw">padding</span><span class="ch">:</span> <span class="dv">8</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb14-18"><a href="#cb14-18"></a>        }</span>
<span id="cb14-19"><a href="#cb14-19"></a>        th {</span>
<span id="cb14-20"><a href="#cb14-20"></a>            <span class="kw">background-color</span><span class="ch">:</span> <span class="cn">#f2f2f2</span><span class="op">;</span></span>
<span id="cb14-21"><a href="#cb14-21"></a>        }</span>
<span id="cb14-22"><a href="#cb14-22"></a>    <span class="dt">&lt;/</span><span class="kw">style</span><span class="dt">&gt;</span></span>
<span id="cb14-23"><a href="#cb14-23"></a><span class="dt">&lt;/</span><span class="kw">head</span><span class="dt">&gt;</span></span>
<span id="cb14-24"><a href="#cb14-24"></a><span class="dt">&lt;</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb14-25"><a href="#cb14-25"></a>    <span class="dt">&lt;</span><span class="kw">h1</span><span class="dt">&gt;</span>Download Table Data<span class="dt">&lt;/</span><span class="kw">h1</span><span class="dt">&gt;</span></span>
<span id="cb14-26"><a href="#cb14-26"></a>    <span class="dt">&lt;</span><span class="kw">a</span><span class="ot"> href</span><span class="op">=</span><span class="st">"/api/displaySQL"</span><span class="dt">&gt;</span>Download Table Data as CSV<span class="dt">&lt;/</span><span class="kw">a</span><span class="dt">&gt;</span></span>
<span id="cb14-27"><a href="#cb14-27"></a></span>
<span id="cb14-28"><a href="#cb14-28"></a>    <span class="dt">&lt;</span><span class="kw">h2</span><span class="dt">&gt;</span>Current Readings<span class="dt">&lt;/</span><span class="kw">h2</span><span class="dt">&gt;</span></span>
<span id="cb14-29"><a href="#cb14-29"></a>    <span class="dt">&lt;</span><span class="kw">table</span><span class="ot"> id</span><span class="op">=</span><span class="st">"currentReadings"</span><span class="dt">&gt;</span></span>
<span id="cb14-30"><a href="#cb14-30"></a><span class="dt">&lt;</span><span class="kw">tr</span><span class="dt">&gt;</span></span>
<span id="cb14-31"><a href="#cb14-31"></a><span class="dt">&lt;</span><span class="kw">th</span><span class="dt">&gt;</span>Date<span class="dt">&lt;/</span><span class="kw">th</span><span class="dt">&gt;</span></span>
<span id="cb14-32"><a href="#cb14-32"></a><span class="dt">&lt;</span><span class="kw">th</span><span class="dt">&gt;</span>Time<span class="dt">&lt;/</span><span class="kw">th</span><span class="dt">&gt;</span></span>
<span id="cb14-33"><a href="#cb14-33"></a><span class="dt">&lt;</span><span class="kw">th</span><span class="dt">&gt;</span>Humidity (%)<span class="dt">&lt;/</span><span class="kw">th</span><span class="dt">&gt;</span></span>
<span id="cb14-34"><a href="#cb14-34"></a><span class="dt">&lt;</span><span class="kw">th</span><span class="dt">&gt;</span>Temperature (F)<span class="dt">&lt;/</span><span class="kw">th</span><span class="dt">&gt;</span></span>
<span id="cb14-35"><a href="#cb14-35"></a><span class="dt">&lt;</span><span class="kw">th</span><span class="dt">&gt;</span>Temperature (C)<span class="dt">&lt;/</span><span class="kw">th</span><span class="dt">&gt;</span></span>
<span id="cb14-36"><a href="#cb14-36"></a><span class="dt">&lt;/</span><span class="kw">tr</span><span class="dt">&gt;</span></span>
<span id="cb14-37"><a href="#cb14-37"></a><span class="dt">&lt;/</span><span class="kw">table</span><span class="dt">&gt;</span></span>
<span id="cb14-38"><a href="#cb14-38"></a></span>
<span id="cb14-39"><a href="#cb14-39"></a>    <span class="dt">&lt;</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb14-40"><a href="#cb14-40"></a>        <span class="co">// Function to format the date</span></span>
<span id="cb14-41"><a href="#cb14-41"></a>        <span class="kw">function</span> <span class="fu">formatDate</span>(dateString) {</span>
<span id="cb14-42"><a href="#cb14-42"></a>            <span class="kw">const</span> date <span class="op">=</span> <span class="kw">new</span> <span class="bu">Date</span>(dateString)<span class="op">;</span></span>
<span id="cb14-43"><a href="#cb14-43"></a>            <span class="cf">return</span> date<span class="op">.</span><span class="fu">toLocaleDateString</span>(<span class="st">'en-US'</span>)<span class="op">;</span></span>
<span id="cb14-44"><a href="#cb14-44"></a>}</span>
<span id="cb14-45"><a href="#cb14-45"></a></span>
<span id="cb14-46"><a href="#cb14-46"></a>        <span class="co">// Fetch the last row data from the serverless function</span></span>
<span id="cb14-47"><a href="#cb14-47"></a>        <span class="fu">fetch</span>(<span class="st">'/api/displayLastRowSQL'</span>)</span>
<span id="cb14-48"><a href="#cb14-48"></a>            <span class="op">.</span><span class="fu">then</span>(response <span class="kw">=&gt;</span> response<span class="op">.</span><span class="fu">json</span>())</span>
<span id="cb14-49"><a href="#cb14-49"></a>            <span class="op">.</span><span class="fu">then</span>(data <span class="kw">=&gt;</span> {</span>
<span id="cb14-50"><a href="#cb14-50"></a>                <span class="co">// Extract the relevant data from the last row</span></span>
<span id="cb14-51"><a href="#cb14-51"></a>                <span class="kw">const</span> time <span class="op">=</span> data<span class="op">.</span><span class="at">time</span><span class="op">;</span></span>
<span id="cb14-52"><a href="#cb14-52"></a>                <span class="kw">const</span> humidity <span class="op">=</span> data<span class="op">.</span><span class="at">humiditypercent</span><span class="op">;</span></span>
<span id="cb14-53"><a href="#cb14-53"></a>                <span class="kw">const</span> temperatureF <span class="op">=</span> data<span class="op">.</span><span class="at">temperaturefahrenheit</span><span class="op">;</span></span>
<span id="cb14-54"><a href="#cb14-54"></a>                <span class="kw">const</span> temperatureC <span class="op">=</span> data<span class="op">.</span><span class="at">temperaturecelsius</span><span class="op">;</span></span>
<span id="cb14-55"><a href="#cb14-55"></a>                <span class="kw">const</span> date <span class="op">=</span> <span class="fu">formatDate</span>(data<span class="op">.</span><span class="at">date</span>)<span class="op">;</span></span>
<span id="cb14-56"><a href="#cb14-56"></a></span>
<span id="cb14-57"><a href="#cb14-57"></a>                <span class="co">// Display the data in the HTML table</span></span>
<span id="cb14-58"><a href="#cb14-58"></a>                <span class="kw">const</span> currentReadingsTable <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">'currentReadings'</span>)<span class="op">;</span></span>
<span id="cb14-59"><a href="#cb14-59"></a>                <span class="kw">const</span> newRow <span class="op">=</span> currentReadingsTable<span class="op">.</span><span class="fu">insertRow</span>()<span class="op">;</span></span>
<span id="cb14-60"><a href="#cb14-60"></a>                newRow<span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb14-61"><a href="#cb14-61"></a><span class="vs">                    &lt;td&gt;</span><span class="sc">${</span>date<span class="sc">}</span><span class="vs">&lt;/td&gt;</span></span>
<span id="cb14-62"><a href="#cb14-62"></a><span class="vs">                    &lt;td&gt;</span><span class="sc">${</span>time<span class="sc">}</span><span class="vs">&lt;/td&gt;</span></span>
<span id="cb14-63"><a href="#cb14-63"></a><span class="vs">                    &lt;td&gt;</span><span class="sc">${</span>humidity<span class="sc">}</span><span class="vs">&lt;/td&gt;</span></span>
<span id="cb14-64"><a href="#cb14-64"></a><span class="vs">                    &lt;td&gt;</span><span class="sc">${</span>temperatureF<span class="sc">}</span><span class="vs">&lt;/td&gt;</span></span>
<span id="cb14-65"><a href="#cb14-65"></a><span class="vs">                    &lt;td&gt;</span><span class="sc">${</span>temperatureC<span class="sc">}</span><span class="vs">&lt;/td&gt;</span></span>
<span id="cb14-66"><a href="#cb14-66"></a><span class="vs">                `</span><span class="op">;</span></span>
<span id="cb14-67"><a href="#cb14-67"></a>            })</span>
<span id="cb14-68"><a href="#cb14-68"></a>            <span class="op">.</span><span class="fu">catch</span>(error <span class="kw">=&gt;</span> {</span>
<span id="cb14-69"><a href="#cb14-69"></a>                <span class="co">// Handle errors</span></span>
<span id="cb14-70"><a href="#cb14-70"></a>                <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">'Error fetching current readings:'</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb14-71"><a href="#cb14-71"></a>            })<span class="op">;</span></span>
<span id="cb14-72"><a href="#cb14-72"></a>    <span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb14-73"><a href="#cb14-73"></a><span class="dt">&lt;/</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb14-74"><a href="#cb14-74"></a><span class="dt">&lt;/</span><span class="kw">html</span><span class="dt">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p>Javascript to pull entire dataset:</p>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb15"><pre class="sourceCode numberSource javascript number-lines code-with-copy"><code class="sourceCode javascript"><span id="cb15-1"><a href="#cb15-1"></a>{javascript}</span>
<span id="cb15-2"><a href="#cb15-2"></a><span class="co">// Import the necessary libraries</span></span>
<span id="cb15-3"><a href="#cb15-3"></a><span class="kw">const</span> { Pool } <span class="op">=</span> <span class="pp">require</span>(<span class="st">'pg'</span>)<span class="op">;</span></span>
<span id="cb15-4"><a href="#cb15-4"></a><span class="kw">const</span> { Parser } <span class="op">=</span> <span class="pp">require</span>(<span class="st">'json2csv'</span>)<span class="op">;</span></span>
<span id="cb15-5"><a href="#cb15-5"></a></span>
<span id="cb15-6"><a href="#cb15-6"></a><span class="co">// PostgreSQL connection setup</span></span>
<span id="cb15-7"><a href="#cb15-7"></a><span class="kw">const</span> pool <span class="op">=</span> <span class="kw">new</span> <span class="fu">Pool</span>({</span>
<span id="cb15-8"><a href="#cb15-8"></a>    <span class="dt">connectionString</span><span class="op">:</span> <span class="bu">process</span><span class="op">.</span><span class="at">env</span><span class="op">.</span><span class="at">POSTGRES_URL</span><span class="op">,</span> <span class="co">// Make sure to set this environment variable in Vercel</span></span>
<span id="cb15-9"><a href="#cb15-9"></a>    <span class="dt">ssl</span><span class="op">:</span> {</span>
<span id="cb15-10"><a href="#cb15-10"></a>        <span class="dt">rejectUnauthorized</span><span class="op">:</span> <span class="kw">false</span></span>
<span id="cb15-11"><a href="#cb15-11"></a>    }</span>
<span id="cb15-12"><a href="#cb15-12"></a>})<span class="op">;</span></span>
<span id="cb15-13"><a href="#cb15-13"></a></span>
<span id="cb15-14"><a href="#cb15-14"></a><span class="co">// Serverless function exported for Vercel //note slow loop of formatted rows. FIX!!!!</span></span>
<span id="cb15-15"><a href="#cb15-15"></a>module<span class="op">.</span><span class="at">exports</span> <span class="op">=</span> <span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> {</span>
<span id="cb15-16"><a href="#cb15-16"></a>    <span class="cf">try</span> {</span>
<span id="cb15-17"><a href="#cb15-17"></a>        <span class="co">// SQL Query to select all records from the table</span></span>
<span id="cb15-18"><a href="#cb15-18"></a>        <span class="kw">const</span> query <span class="op">=</span> <span class="st">'SELECT * FROM readings'</span><span class="op">;</span></span>
<span id="cb15-19"><a href="#cb15-19"></a>        </span>
<span id="cb15-20"><a href="#cb15-20"></a>        <span class="co">// Execute the query</span></span>
<span id="cb15-21"><a href="#cb15-21"></a>        <span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> pool<span class="op">.</span><span class="fu">query</span>(query)<span class="op">;</span></span>
<span id="cb15-22"><a href="#cb15-22"></a></span>
<span id="cb15-23"><a href="#cb15-23"></a>        <span class="co">// Format the date field in each row</span></span>
<span id="cb15-24"><a href="#cb15-24"></a>        <span class="kw">const</span> formattedRows <span class="op">=</span> result<span class="op">.</span><span class="at">rows</span><span class="op">.</span><span class="fu">map</span>(row <span class="kw">=&gt;</span> {</span>
<span id="cb15-25"><a href="#cb15-25"></a>            <span class="kw">const</span> formattedDate <span class="op">=</span> row<span class="op">.</span><span class="at">date</span> <span class="op">?</span> <span class="kw">new</span> <span class="bu">Date</span>(row<span class="op">.</span><span class="at">date</span>)<span class="op">.</span><span class="fu">toLocaleDateString</span>(<span class="st">'en-US'</span>) <span class="op">:</span> <span class="st">''</span><span class="op">;</span> <span class="co">// Format date to locale string (excluding time)</span></span>
<span id="cb15-26"><a href="#cb15-26"></a>            <span class="cf">return</span> { <span class="op">...</span>row<span class="op">,</span> <span class="dt">date</span><span class="op">:</span> formattedDate }<span class="op">;</span></span>
<span id="cb15-27"><a href="#cb15-27"></a>        })<span class="op">;</span></span>
<span id="cb15-28"><a href="#cb15-28"></a></span>
<span id="cb15-29"><a href="#cb15-29"></a>        <span class="co">// Convert the formatted rows to CSV format</span></span>
<span id="cb15-30"><a href="#cb15-30"></a>        <span class="kw">const</span> json2csvParser <span class="op">=</span> <span class="kw">new</span> <span class="fu">Parser</span>()<span class="op">;</span></span>
<span id="cb15-31"><a href="#cb15-31"></a>        <span class="kw">const</span> csvData <span class="op">=</span> json2csvParser<span class="op">.</span><span class="fu">parse</span>(formattedRows)<span class="op">;</span></span>
<span id="cb15-32"><a href="#cb15-32"></a></span>
<span id="cb15-33"><a href="#cb15-33"></a>        <span class="co">// Set response headers to indicate a CSV file download</span></span>
<span id="cb15-34"><a href="#cb15-34"></a>        res<span class="op">.</span><span class="fu">setHeader</span>(<span class="st">'Content-Type'</span><span class="op">,</span> <span class="st">'text/csv'</span>)<span class="op">;</span></span>
<span id="cb15-35"><a href="#cb15-35"></a>        res<span class="op">.</span><span class="fu">setHeader</span>(<span class="st">'Content-Disposition'</span><span class="op">,</span> <span class="st">'attachment; filename="table_data.csv"'</span>)<span class="op">;</span></span>
<span id="cb15-36"><a href="#cb15-36"></a></span>
<span id="cb15-37"><a href="#cb15-37"></a>        <span class="co">// Send the CSV data as the response</span></span>
<span id="cb15-38"><a href="#cb15-38"></a>        res<span class="op">.</span><span class="fu">status</span>(<span class="dv">200</span>)<span class="op">.</span><span class="fu">send</span>(csvData)<span class="op">;</span></span>
<span id="cb15-39"><a href="#cb15-39"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb15-40"><a href="#cb15-40"></a>        <span class="co">// Handle errors and send an error response</span></span>
<span id="cb15-41"><a href="#cb15-41"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">"Error fetching data from PostgreSQL:"</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb15-42"><a href="#cb15-42"></a>        res<span class="op">.</span><span class="fu">status</span>(<span class="dv">500</span>)<span class="op">.</span><span class="fu">json</span>({ <span class="dt">error</span><span class="op">:</span> <span class="st">'Failed to fetch data from database'</span><span class="op">,</span> <span class="dt">details</span><span class="op">:</span> error<span class="op">.</span><span class="at">message</span> })<span class="op">;</span></span>
<span id="cb15-43"><a href="#cb15-43"></a>    }</span>
<span id="cb15-44"><a href="#cb15-44"></a>}<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<details>
<summary>
Code Summary
</summary>
<p>This JavaScript code defines a serverless function that fetches data from a PostgreSQL database, formats the data, converts it to CSV format, and sends it as a downloadable file in the HTTP response. It is designed to be deployed on Vercel. Here is a summary of the main components and functionality:</p>
<ol type="1">
<li><p><strong>Import Necessary Libraries</strong>:</p>
<ul>
<li><p><strong><code>pg</code></strong> for connecting to the PostgreSQL database.</p></li>
<li><p><strong><code>json2csv</code></strong> for converting JSON data to CSV format.</p></li>
</ul></li>
<li><p><strong>PostgreSQL Connection Setup</strong>:</p>
<ul>
<li><p>Uses the <strong><code>pg</code></strong> library to create a connection pool to the PostgreSQL database.</p></li>
<li><p>The connection string is retrieved from the <strong><code>POSTGRES_URL</code></strong> environment variable.</p></li>
<li><p>SSL connection is configured with <strong><code>rejectUnauthorized: false</code></strong>.</p></li>
</ul></li>
<li><p><strong>Serverless Function Exported for Vercel</strong>:</p>
<ul>
<li>The function is exported to be used as a serverless function in Vercel.</li>
</ul></li>
<li><p><strong>Fetching Data from PostgreSQL</strong>:</p>
<ul>
<li><p>Defines an SQL query to select all records from the <strong><code>readings</code></strong> table.</p></li>
<li><p>Executes the query using the connection pool and stores the result.</p></li>
</ul></li>
<li><p><strong>Formatting Data</strong>:</p>
<ul>
<li><p>Formats the <strong><code>date</code></strong> field in each row to a locale date string (excluding time).</p></li>
<li><p>Uses <strong><code>Array.map()</code></strong> to iterate over each row and apply the date formatting.</p></li>
</ul></li>
<li><p><strong>Converting Data to CSV</strong>:</p>
<ul>
<li><p>Uses <strong><code>json2csv</code></strong> to convert the formatted JSON data to CSV format.</p></li>
<li><p>Initializes a <strong><code>Parser</code></strong> object and calls the <strong><code>parse()</code></strong> method with the formatted rows.</p></li>
</ul></li>
<li><p><strong>Setting Response Headers for CSV Download</strong>:</p>
<ul>
<li><p>Sets the <strong><code>Content-Type</code></strong> header to <strong><code>text/csv</code></strong>.</p></li>
<li><p>Sets the <strong><code>Content-Disposition</code></strong> header to indicate a file download with the filename <strong><code>table_data.csv</code></strong>.</p></li>
</ul></li>
<li><p><strong>Sending the CSV Data as Response</strong>:</p>
<ul>
<li>Sends the CSV data as the HTTP response with a <strong><code>200 OK</code></strong> status.</li>
</ul></li>
<li><p><strong>Error Handling</strong>:</p>
<ul>
<li><p>Catches any errors that occur during data fetching or processing.</p></li>
<li><p>Logs the error and responds with a <strong><code>500 Internal Server Error</code></strong> status, including error details.</p></li>
</ul></li>
</ol>
<p>This script ensures that data from the PostgreSQL database is formatted and made available for download as a CSV file, with proper error handling to manage potential issues during execution.</p>
</details>
<p>Javascript to display latest sensor readings:</p>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb16"><pre class="sourceCode numberSource javascript number-lines code-with-copy"><code class="sourceCode javascript"><span id="cb16-1"><a href="#cb16-1"></a>{javascript}</span>
<span id="cb16-2"><a href="#cb16-2"></a><span class="co">// Import the necessary libraries</span></span>
<span id="cb16-3"><a href="#cb16-3"></a><span class="kw">const</span> { Pool } <span class="op">=</span> <span class="pp">require</span>(<span class="st">'pg'</span>)<span class="op">;</span></span>
<span id="cb16-4"><a href="#cb16-4"></a></span>
<span id="cb16-5"><a href="#cb16-5"></a><span class="co">// PostgreSQL connection setup</span></span>
<span id="cb16-6"><a href="#cb16-6"></a><span class="kw">const</span> pool <span class="op">=</span> <span class="kw">new</span> <span class="fu">Pool</span>({</span>
<span id="cb16-7"><a href="#cb16-7"></a>    <span class="dt">connectionString</span><span class="op">:</span> <span class="bu">process</span><span class="op">.</span><span class="at">env</span><span class="op">.</span><span class="at">POSTGRES_URL</span><span class="op">,</span> <span class="co">// Make sure to set this environment variable in Vercel</span></span>
<span id="cb16-8"><a href="#cb16-8"></a>    <span class="dt">ssl</span><span class="op">:</span> {</span>
<span id="cb16-9"><a href="#cb16-9"></a>        <span class="dt">rejectUnauthorized</span><span class="op">:</span> <span class="kw">false</span></span>
<span id="cb16-10"><a href="#cb16-10"></a>    }</span>
<span id="cb16-11"><a href="#cb16-11"></a>})<span class="op">;</span></span>
<span id="cb16-12"><a href="#cb16-12"></a></span>
<span id="cb16-13"><a href="#cb16-13"></a><span class="co">// Serverless function exported for Vercel</span></span>
<span id="cb16-14"><a href="#cb16-14"></a>module<span class="op">.</span><span class="at">exports</span> <span class="op">=</span> <span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> {</span>
<span id="cb16-15"><a href="#cb16-15"></a>    <span class="cf">try</span> {</span>
<span id="cb16-16"><a href="#cb16-16"></a>        <span class="co">// SQL Query to select the last row from the table with the specified order</span></span>
<span id="cb16-17"><a href="#cb16-17"></a>        <span class="kw">const</span> query <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb16-18"><a href="#cb16-18"></a><span class="vs">            SELECT time,</span></span>
<span id="cb16-19"><a href="#cb16-19"></a><span class="vs">                   humiditypercent,</span></span>
<span id="cb16-20"><a href="#cb16-20"></a><span class="vs">                   temperaturefahrenheit,</span></span>
<span id="cb16-21"><a href="#cb16-21"></a><span class="vs">                   temperaturecelsius,</span></span>
<span id="cb16-22"><a href="#cb16-22"></a><span class="vs">                   date</span></span>
<span id="cb16-23"><a href="#cb16-23"></a><span class="vs">            FROM readings</span></span>
<span id="cb16-24"><a href="#cb16-24"></a><span class="vs">            ORDER BY id DESC</span></span>
<span id="cb16-25"><a href="#cb16-25"></a><span class="vs">            LIMIT 1</span></span>
<span id="cb16-26"><a href="#cb16-26"></a><span class="vs">        `</span><span class="op">;</span></span>
<span id="cb16-27"><a href="#cb16-27"></a>        </span>
<span id="cb16-28"><a href="#cb16-28"></a>        <span class="co">// Execute the query</span></span>
<span id="cb16-29"><a href="#cb16-29"></a>        <span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> pool<span class="op">.</span><span class="fu">query</span>(query)<span class="op">;</span></span>
<span id="cb16-30"><a href="#cb16-30"></a></span>
<span id="cb16-31"><a href="#cb16-31"></a>        <span class="co">// Check if result.rows is not empty</span></span>
<span id="cb16-32"><a href="#cb16-32"></a>        <span class="cf">if</span> (result<span class="op">.</span><span class="at">rows</span><span class="op">.</span><span class="at">length</span> <span class="op">===</span> <span class="dv">0</span>) {</span>
<span id="cb16-33"><a href="#cb16-33"></a>            res<span class="op">.</span><span class="fu">status</span>(<span class="dv">404</span>)<span class="op">.</span><span class="fu">json</span>({ <span class="dt">error</span><span class="op">:</span> <span class="st">'No data found in the database'</span> })<span class="op">;</span></span>
<span id="cb16-34"><a href="#cb16-34"></a>            <span class="cf">return</span><span class="op">;</span></span>
<span id="cb16-35"><a href="#cb16-35"></a>        }</span>
<span id="cb16-36"><a href="#cb16-36"></a></span>
<span id="cb16-37"><a href="#cb16-37"></a>        <span class="co">// Format the date field to 'YYYY-MM-DD'</span></span>
<span id="cb16-38"><a href="#cb16-38"></a>        <span class="kw">const</span> row <span class="op">=</span> result<span class="op">.</span><span class="at">rows</span>[<span class="dv">0</span>]<span class="op">;</span></span>
<span id="cb16-39"><a href="#cb16-39"></a>        row<span class="op">.</span><span class="at">date</span> <span class="op">=</span> row<span class="op">.</span><span class="at">date</span> <span class="op">?</span> <span class="kw">new</span> <span class="bu">Date</span>(row<span class="op">.</span><span class="at">date</span>)<span class="op">.</span><span class="fu">toLocaleDateString</span>(<span class="st">'en-us'</span>)<span class="op">.</span><span class="fu">slice</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">10</span>) <span class="op">:</span> <span class="st">'Invalid date'</span><span class="op">;</span></span>
<span id="cb16-40"><a href="#cb16-40"></a></span>
<span id="cb16-41"><a href="#cb16-41"></a>        <span class="co">// Debugging: Log the formatted date to inspect it</span></span>
<span id="cb16-42"><a href="#cb16-42"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">"Formatted date:"</span><span class="op">,</span> row<span class="op">.</span><span class="at">date</span>)<span class="op">;</span></span>
<span id="cb16-43"><a href="#cb16-43"></a></span>
<span id="cb16-44"><a href="#cb16-44"></a>        <span class="co">// Send the last row data as the response</span></span>
<span id="cb16-45"><a href="#cb16-45"></a>        res<span class="op">.</span><span class="fu">status</span>(<span class="dv">200</span>)<span class="op">.</span><span class="fu">json</span>(row)<span class="op">;</span> <span class="co">// Assuming there is at least one row in the table</span></span>
<span id="cb16-46"><a href="#cb16-46"></a>    } <span class="cf">catch</span> (error) {</span>
<span id="cb16-47"><a href="#cb16-47"></a>        <span class="co">// Handle errors and send an error response</span></span>
<span id="cb16-48"><a href="#cb16-48"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">"Error fetching data from PostgreSQL:"</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb16-49"><a href="#cb16-49"></a>        res<span class="op">.</span><span class="fu">status</span>(<span class="dv">500</span>)<span class="op">.</span><span class="fu">json</span>({ <span class="dt">error</span><span class="op">:</span> <span class="st">'Failed to fetch data from database'</span><span class="op">,</span> <span class="dt">details</span><span class="op">:</span> error<span class="op">.</span><span class="at">message</span> })<span class="op">;</span></span>
<span id="cb16-50"><a href="#cb16-50"></a>    }</span>
<span id="cb16-51"><a href="#cb16-51"></a>}<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<details>
<summary>
Code Summary
</summary>
<p>This JavaScript code defines a serverless function that fetches the most recent data entry from a PostgreSQL database and returns it as a JSON response. It is designed to be deployed on Vercel. Here is a summary of the main components and functionality:</p>
<ol type="1">
<li><p><strong>Import Necessary Libraries</strong>:</p>
<ul>
<li><strong><code>pg</code></strong> for connecting to the PostgreSQL database.</li>
</ul></li>
<li><p><strong>PostgreSQL Connection Setup</strong>:</p>
<ul>
<li><p>Uses the <strong><code>pg</code></strong> library to create a connection pool to the PostgreSQL database.</p></li>
<li><p>The connection string is retrieved from the <strong><code>POSTGRES_URL</code></strong> environment variable.</p></li>
<li><p>SSL connection is configured with <strong><code>rejectUnauthorized: false</code></strong>.</p></li>
</ul></li>
<li><p><strong>Serverless Function Exported for Vercel</strong>:</p>
<ul>
<li>The function is exported to be used as a serverless function in Vercel.</li>
</ul></li>
<li><p><strong>Fetching the Latest Data from PostgreSQL</strong>:</p>
<ul>
<li><p>Defines an SQL query to select the last row from the <strong><code>readings</code></strong> table, ordered by the <strong><code>id</code></strong> column in descending order.</p></li>
<li><p>Limits the query to return only one row (<strong><code>LIMIT 1</code></strong>).</p></li>
</ul></li>
<li><p><strong>Executing the SQL Query</strong>:</p>
<ul>
<li>Executes the query using the connection pool and stores the result.</li>
</ul></li>
<li><p><strong>Checking if Data is Available</strong>:</p>
<ul>
<li><p>Checks if the <strong><code>result.rows</code></strong> array is not empty.</p></li>
<li><p>If no data is found, responds with a <strong><code>404 Not Found</code></strong> status and an error message.</p></li>
</ul></li>
<li><p><strong>Formatting the Date Field</strong>:</p>
<ul>
<li><p>Formats the <strong><code>date</code></strong> field in the retrieved row to the ‘YYYY-MM-DD’ format.</p></li>
<li><p>Uses <strong><code>new Date(row.date).toLocaleDateString('en-us').slice(0, 10)</code></strong> to format the date, ensuring only the date part is included.</p></li>
</ul></li>
<li><p><strong>Debugging Log</strong>:</p>
<ul>
<li>Logs the formatted date to the console for inspection.</li>
</ul></li>
<li><p><strong>Sending the Data as Response</strong>:</p>
<ul>
<li>Sends the retrieved and formatted data as the HTTP response with a <strong><code>200 OK</code></strong> status.</li>
</ul></li>
<li><p><strong>Error Handling</strong>:</p>
<ul>
<li><p>Catches any errors that occur during data fetching or processing.</p></li>
<li><p>Logs the error and responds with a <strong><code>500 Internal Server Error</code></strong> status, including error details.</p></li>
</ul></li>
</ol>
<p>This script ensures that the most recent data entry from the PostgreSQL database is retrieved, formatted, and returned as a JSON response, with proper error handling to manage potential issues during execution. The debugging log provides insight into the formatted date for verification.</p>
</details>
<p>Python script on the raspberry pi:</p>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb17"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1"></a>{python}</span>
<span id="cb17-2"><a href="#cb17-2"></a><span class="im">import</span> Adafruit_DHT</span>
<span id="cb17-3"><a href="#cb17-3"></a><span class="im">import</span> requests</span>
<span id="cb17-4"><a href="#cb17-4"></a><span class="im">import</span> time</span>
<span id="cb17-5"><a href="#cb17-5"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb17-6"><a href="#cb17-6"></a></span>
<span id="cb17-7"><a href="#cb17-7"></a><span class="co"># Define your Vercel API key</span></span>
<span id="cb17-8"><a href="#cb17-8"></a>API_KEY <span class="op">=</span> <span class="st">'YOUR_API_KEY'</span></span>
<span id="cb17-9"><a href="#cb17-9"></a></span>
<span id="cb17-10"><a href="#cb17-10"></a><span class="co"># Sensor setup</span></span>
<span id="cb17-11"><a href="#cb17-11"></a>SENSOR <span class="op">=</span> Adafruit_DHT.DHT11  <span class="co"># Using DHT11 sensor</span></span>
<span id="cb17-12"><a href="#cb17-12"></a>PIN <span class="op">=</span> <span class="dv">4</span>  <span class="co"># Change this to the GPIO pin number that the sensor is connected to</span></span>
<span id="cb17-13"><a href="#cb17-13"></a></span>
<span id="cb17-14"><a href="#cb17-14"></a><span class="co"># Vercel endpoint URL</span></span>
<span id="cb17-15"><a href="#cb17-15"></a>URL <span class="op">=</span> <span class="st">'https://your-vercel-url.vercel.app/api/sensor'</span></span>
<span id="cb17-16"><a href="#cb17-16"></a></span>
<span id="cb17-17"><a href="#cb17-17"></a><span class="co"># Buffer to store data</span></span>
<span id="cb17-18"><a href="#cb17-18"></a>data_buffer <span class="op">=</span> []</span>
<span id="cb17-19"><a href="#cb17-19"></a>i <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb17-20"><a href="#cb17-20"></a><span class="kw">def</span> send_data(data):</span>
<span id="cb17-21"><a href="#cb17-21"></a>    <span class="co">"""Send data to the server."""</span></span>
<span id="cb17-22"><a href="#cb17-22"></a>    <span class="cf">try</span>:</span>
<span id="cb17-23"><a href="#cb17-23"></a>        <span class="co"># Include API key in the headers</span></span>
<span id="cb17-24"><a href="#cb17-24"></a>        headers <span class="op">=</span> {<span class="st">'X-API-Key'</span>: API_KEY}</span>
<span id="cb17-25"><a href="#cb17-25"></a>        response <span class="op">=</span> requests.post(URL, json<span class="op">=</span>data, headers<span class="op">=</span>headers)</span>
<span id="cb17-26"><a href="#cb17-26"></a>        <span class="bu">print</span>(<span class="ss">f"Data sent to server: </span><span class="sc">{</span>response<span class="sc">.</span>text<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb17-27"><a href="#cb17-27"></a>    <span class="cf">except</span> requests.exceptions.RequestException <span class="im">as</span> e:</span>
<span id="cb17-28"><a href="#cb17-28"></a>        <span class="bu">print</span>(<span class="ss">f"Failed to send data to server: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb17-29"><a href="#cb17-29"></a></span>
<span id="cb17-30"><a href="#cb17-30"></a><span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb17-31"><a href="#cb17-31"></a>    <span class="co"># Read humidity and temperature from DHT sensor</span></span>
<span id="cb17-32"><a href="#cb17-32"></a>    humidityPercent, temperature_C <span class="op">=</span> Adafruit_DHT.read_retry(SENSOR, PIN)</span>
<span id="cb17-33"><a href="#cb17-33"></a>    </span>
<span id="cb17-34"><a href="#cb17-34"></a>    <span class="cf">if</span> humidityPercent <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> temperature_C <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb17-35"><a href="#cb17-35"></a>        <span class="co"># Prepare the data payload</span></span>
<span id="cb17-36"><a href="#cb17-36"></a>        temperature_F <span class="op">=</span> temperature_C <span class="op">*</span> <span class="fl">9.0</span> <span class="op">/</span> <span class="fl">5.0</span> <span class="op">+</span> <span class="dv">32</span></span>
<span id="cb17-37"><a href="#cb17-37"></a>        </span>
<span id="cb17-38"><a href="#cb17-38"></a>        now <span class="op">=</span> datetime.now()</span>
<span id="cb17-39"><a href="#cb17-39"></a>        date <span class="op">=</span> now.strftime(<span class="st">"%m-</span><span class="sc">%d</span><span class="st">-%Y"</span>)</span>
<span id="cb17-40"><a href="#cb17-40"></a>        timeNow <span class="op">=</span> now.strftime(<span class="st">"%H:%M:%S"</span>)</span>
<span id="cb17-41"><a href="#cb17-41"></a>        </span>
<span id="cb17-42"><a href="#cb17-42"></a>        data <span class="op">=</span> {</span>
<span id="cb17-43"><a href="#cb17-43"></a>            <span class="st">'date'</span>: date,</span>
<span id="cb17-44"><a href="#cb17-44"></a>            <span class="st">'time'</span>: timeNow,</span>
<span id="cb17-45"><a href="#cb17-45"></a>            <span class="st">'humidityPercent'</span>: humidityPercent,</span>
<span id="cb17-46"><a href="#cb17-46"></a>            <span class="st">'temperatureFahrenheit'</span>: temperature_F,</span>
<span id="cb17-47"><a href="#cb17-47"></a>            <span class="st">'temperatureCelsius'</span>: temperature_C</span>
<span id="cb17-48"><a href="#cb17-48"></a>        }</span>
<span id="cb17-49"><a href="#cb17-49"></a>        </span>
<span id="cb17-50"><a href="#cb17-50"></a>        <span class="co"># Log data to buffer</span></span>
<span id="cb17-51"><a href="#cb17-51"></a>        data_buffer.append(data)</span>
<span id="cb17-52"><a href="#cb17-52"></a>        <span class="cf">if</span> i <span class="op">%</span> <span class="dv">60</span> <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb17-53"><a href="#cb17-53"></a>            <span class="bu">print</span>(<span class="ss">f"Logged data: </span><span class="sc">{</span>data<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb17-54"><a href="#cb17-54"></a>        </span>
<span id="cb17-55"><a href="#cb17-55"></a>        <span class="co"># Check if 300 seconds have passed</span></span>
<span id="cb17-56"><a href="#cb17-56"></a>        <span class="cf">if</span> <span class="bu">len</span>(data_buffer) <span class="op">&gt;=</span> <span class="dv">300</span>:</span>
<span id="cb17-57"><a href="#cb17-57"></a>            send_data(data_buffer)</span>
<span id="cb17-58"><a href="#cb17-58"></a>            </span>
<span id="cb17-59"><a href="#cb17-59"></a>            <span class="co"># Clear the buffer after sending</span></span>
<span id="cb17-60"><a href="#cb17-60"></a>            data_buffer.clear()</span>
<span id="cb17-61"><a href="#cb17-61"></a>            i <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb17-62"><a href="#cb17-62"></a>    <span class="cf">else</span>:</span>
<span id="cb17-63"><a href="#cb17-63"></a>        <span class="co"># Handle cases where sensor fails to read</span></span>
<span id="cb17-64"><a href="#cb17-64"></a>        <span class="bu">print</span>(<span class="st">"Failed to retrieve data from sensor"</span>)</span>
<span id="cb17-65"><a href="#cb17-65"></a>    </span>
<span id="cb17-66"><a href="#cb17-66"></a>    <span class="co"># Wait for 1 second before logging the next reading</span></span>
<span id="cb17-67"><a href="#cb17-67"></a>    time.sleep(<span class="dv">1</span>)</span>
<span id="cb17-68"><a href="#cb17-68"></a>    i <span class="op">+=</span> <span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<details>
<summary>
Code
</summary>
<p>This Python script reads environmental data from a DHT11 sensor every second, stores it in a buffer, and sends the buffered data to a Vercel endpoint every 5 minutes (300 seconds). The script includes error handling for sensor read failures and HTTP request failures. Here is a summary of the main components and functionality:</p>
<ol type="1">
<li><p><strong>Imports Necessary Libraries</strong>:</p>
<ul>
<li><p><strong><code>Adafruit_DHT</code></strong> for interfacing with the DHT11 sensor.</p></li>
<li><p><strong><code>requests</code></strong> for making HTTP POST requests to the Vercel endpoint.</p></li>
<li><p><strong><code>time</code></strong> for managing sleep intervals.</p></li>
<li><p><strong><code>datetime</code></strong> for timestamping data.</p></li>
</ul></li>
<li><p><strong>Vercel API Key and Endpoint Setup</strong>:</p>
<ul>
<li>Defines the Vercel API key (<strong><code>API_KEY</code></strong>) and endpoint URL (<strong><code>URL</code></strong>).</li>
</ul></li>
<li><p><strong>Sensor Setup</strong>:</p>
<ul>
<li><p>Defines the sensor type as <strong><code>DHT11</code></strong>.</p></li>
<li><p>Sets the GPIO pin connected to the sensor (<strong><code>PIN = 4</code></strong>).</p></li>
</ul></li>
<li><p><strong>Buffer Initialization</strong>:</p>
<ul>
<li><p>Initializes an empty list <strong><code>data_buffer</code></strong> to store sensor readings.</p></li>
<li><p>Initializes a counter <strong><code>i</code></strong> to keep track of the number of readings.</p></li>
</ul></li>
<li><p><strong>Data Sending Function</strong>:</p>
<ul>
<li><p><strong><code>send_data(data)</code></strong>: Sends the buffered data to the Vercel endpoint.</p>
<ul>
<li><p>Includes the API key in the request headers.</p></li>
<li><p>Sends the data using an HTTP POST request.</p></li>
<li><p>Logs the response or any exceptions that occur.</p></li>
</ul></li>
</ul></li>
<li><p><strong>Continuous Data Logging Loop</strong>:</p>
<ul>
<li><p>Enters an infinite loop to continuously read data from the sensor every second.</p></li>
<li><p>Reads humidity and temperature (in Celsius) from the DHT11 sensor using <strong><code>Adafruit_DHT.read_retry(SENSOR, PIN)</code></strong>.</p></li>
<li><p>If valid data is read (i.e., not <strong><code>None</code></strong>), the following actions are performed:</p>
<ul>
<li><p>Converts the temperature from Celsius to Fahrenheit.</p></li>
<li><p>Gets the current date and time using <strong><code>datetime.now()</code></strong> and formats them as strings.</p></li>
<li><p>Prepares a dictionary <strong><code>data</code></strong> containing the date, time, humidity, temperature in Celsius, and temperature in Fahrenheit.</p></li>
<li><p>Appends the <strong><code>data</code></strong> dictionary to <strong><code>data_buffer</code></strong>.</p></li>
<li><p>Logs the data to the console every 60 readings.</p></li>
<li><p>Checks if 300 readings (300 seconds) have been collected.</p>
<ul>
<li><p>If so, calls <strong><code>send_data(data_buffer)</code></strong> to send the buffered data to the Vercel endpoint.</p></li>
<li><p>Clears the <strong><code>data_buffer</code></strong> and resets the counter <strong><code>i</code></strong>.</p></li>
</ul></li>
</ul></li>
<li><p>If the sensor fails to read data, it logs an error message.</p></li>
<li><p>Waits for 1 second before taking the next reading using <strong><code>time.sleep(1)</code></strong>.</p></li>
<li><p>Increments the counter <strong><code>i</code></strong> with each iteration.</p></li>
</ul></li>
</ol>
<p>This script ensures continuous monitoring and logging of environmental data from a DHT11 sensor, with periodic transmission of the data to a Vercel endpoint for real-time monitoring or further processing.</p>
</details>
<p>I intend to add more sensors such as a VOC sensor, CO2 sensor, PM2.5/PM10 sensor to have real time air quality data. That should be plug and play and a few lines of code. Getting the raspberry pi, server, and database to get along is a lot more work than wiring up a few sensors. I will also likely throw the data into a mongoDB and also push the data to ThingSpeak regularly once I have figured out what the best storage medium is. Unfortunately server uptime is counted as compute time for the purpose of using PostgreSQL in Vercel, so its great for testing, but definitely won’t be my long term solution. I might just do the unhinged option and use Google Sheets as a database. It should be possible to have up to 10 million cells which, when coupled with the data being logged at Date, Time, Humidity, TempF, and TempC that means I can have roughly 2 million rows before I need to think of pushing to another sheet. With a safety factor of 2 I have 1 million and that means I have 1,000,000/60 = 16,666 seconds/60 = 277 hours/24 = 11.5 days of data before I need to consider using another sheet. I can likely shorten this to 7 days and dynamically generate a new sheet every week.</p>
<p>**Edit**: I actually went ahead and tried the google sheets option. Created a Google Cloud Project, enabled the Google Sheets API, and created credentials/downloaded the resultant JSON.</p>
<p>I also had to make sure some Google Python libraries were installed:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1"></a><span class="ex">pip</span> install google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Next I implemented a pretty basic program to send a few values to a Google Sheet:</p>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb19"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1"></a>{python}</span>
<span id="cb19-2"><a href="#cb19-2"></a><span class="im">import</span> os</span>
<span id="cb19-3"><a href="#cb19-3"></a><span class="im">import</span> google.auth</span>
<span id="cb19-4"><a href="#cb19-4"></a><span class="im">from</span> google.auth.transport.requests <span class="im">import</span> Request</span>
<span id="cb19-5"><a href="#cb19-5"></a><span class="im">from</span> google.oauth2.credentials <span class="im">import</span> Credentials</span>
<span id="cb19-6"><a href="#cb19-6"></a><span class="im">from</span> google_auth_oauthlib.flow <span class="im">import</span> InstalledAppFlow</span>
<span id="cb19-7"><a href="#cb19-7"></a><span class="im">from</span> googleapiclient.discovery <span class="im">import</span> build</span>
<span id="cb19-8"><a href="#cb19-8"></a><span class="im">from</span> googleapiclient.errors <span class="im">import</span> HttpError</span>
<span id="cb19-9"><a href="#cb19-9"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb19-10"><a href="#cb19-10"></a></span>
<span id="cb19-11"><a href="#cb19-11"></a><span class="co"># Define the scopes required for the Google Sheets API</span></span>
<span id="cb19-12"><a href="#cb19-12"></a>SCOPES <span class="op">=</span> [<span class="st">'https://www.googleapis.com/auth/spreadsheets'</span>]</span>
<span id="cb19-13"><a href="#cb19-13"></a></span>
<span id="cb19-14"><a href="#cb19-14"></a><span class="co"># Function to get authenticated service</span></span>
<span id="cb19-15"><a href="#cb19-15"></a><span class="kw">def</span> get_sheets_service():</span>
<span id="cb19-16"><a href="#cb19-16"></a>    creds <span class="op">=</span> <span class="va">None</span></span>
<span id="cb19-17"><a href="#cb19-17"></a>    <span class="cf">if</span> os.path.exists(<span class="st">'token.json'</span>):</span>
<span id="cb19-18"><a href="#cb19-18"></a>        creds <span class="op">=</span> Credentials.from_authorized_user_file(<span class="st">'token.json'</span>, SCOPES)</span>
<span id="cb19-19"><a href="#cb19-19"></a>    <span class="cf">if</span> <span class="kw">not</span> creds <span class="kw">or</span> <span class="kw">not</span> creds.valid:</span>
<span id="cb19-20"><a href="#cb19-20"></a>        <span class="cf">if</span> creds <span class="kw">and</span> creds.expired <span class="kw">and</span> creds.refresh_token:</span>
<span id="cb19-21"><a href="#cb19-21"></a>            creds.refresh(Request())</span>
<span id="cb19-22"><a href="#cb19-22"></a>        <span class="cf">else</span>:</span>
<span id="cb19-23"><a href="#cb19-23"></a>            flow <span class="op">=</span> InstalledAppFlow.from_client_secrets_file(<span class="st">'credentials.json'</span>, SCOPES)</span>
<span id="cb19-24"><a href="#cb19-24"></a>            creds <span class="op">=</span> flow.run_local_server(port<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb19-25"><a href="#cb19-25"></a>        <span class="cf">with</span> <span class="bu">open</span>(<span class="st">'token.json'</span>, <span class="st">'w'</span>) <span class="im">as</span> token:</span>
<span id="cb19-26"><a href="#cb19-26"></a>            token.write(creds.to_json())</span>
<span id="cb19-27"><a href="#cb19-27"></a>    service <span class="op">=</span> build(<span class="st">'sheets'</span>, <span class="st">'v4'</span>, credentials<span class="op">=</span>creds)</span>
<span id="cb19-28"><a href="#cb19-28"></a>    <span class="cf">return</span> service</span>
<span id="cb19-29"><a href="#cb19-29"></a></span>
<span id="cb19-30"><a href="#cb19-30"></a><span class="co"># Function to create a new Google Sheet with a given name</span></span>
<span id="cb19-31"><a href="#cb19-31"></a><span class="kw">def</span> create_new_sheet(sheet_name):</span>
<span id="cb19-32"><a href="#cb19-32"></a>    service <span class="op">=</span> get_sheets_service()</span>
<span id="cb19-33"><a href="#cb19-33"></a>    spreadsheet <span class="op">=</span> {</span>
<span id="cb19-34"><a href="#cb19-34"></a>        <span class="st">'properties'</span>: {</span>
<span id="cb19-35"><a href="#cb19-35"></a>            <span class="st">'title'</span>: sheet_name</span>
<span id="cb19-36"><a href="#cb19-36"></a>        }</span>
<span id="cb19-37"><a href="#cb19-37"></a>    }</span>
<span id="cb19-38"><a href="#cb19-38"></a>    spreadsheet <span class="op">=</span> service.spreadsheets().create(body<span class="op">=</span>spreadsheet, fields<span class="op">=</span><span class="st">'spreadsheetId'</span>).execute()</span>
<span id="cb19-39"><a href="#cb19-39"></a>    <span class="bu">print</span>(<span class="ss">f"Created new spreadsheet with ID: </span><span class="sc">{</span>spreadsheet<span class="sc">.</span>get(<span class="st">'spreadsheetId'</span>)<span class="sc">}</span><span class="ss">, Name: </span><span class="sc">{</span>sheet_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-40"><a href="#cb19-40"></a>    <span class="cf">return</span> spreadsheet.get(<span class="st">'spreadsheetId'</span>)</span>
<span id="cb19-41"><a href="#cb19-41"></a></span>
<span id="cb19-42"><a href="#cb19-42"></a><span class="co"># Function to check the number of cells in the Google Sheet and create a new one if it doesn't exist</span></span>
<span id="cb19-43"><a href="#cb19-43"></a><span class="kw">def</span> check_sheet_size(spreadsheet_id, new_sheet_name):</span>
<span id="cb19-44"><a href="#cb19-44"></a>    service <span class="op">=</span> get_sheets_service()</span>
<span id="cb19-45"><a href="#cb19-45"></a>    <span class="cf">try</span>:</span>
<span id="cb19-46"><a href="#cb19-46"></a>        sheet <span class="op">=</span> service.spreadsheets().get(spreadsheetId<span class="op">=</span>spreadsheet_id).execute()</span>
<span id="cb19-47"><a href="#cb19-47"></a>        sheets <span class="op">=</span> sheet.get(<span class="st">'sheets'</span>, [])</span>
<span id="cb19-48"><a href="#cb19-48"></a>    <span class="cf">except</span> HttpError <span class="im">as</span> e:</span>
<span id="cb19-49"><a href="#cb19-49"></a>        <span class="bu">print</span>(<span class="ss">f"HttpError encountered: Status code: </span><span class="sc">{</span>e<span class="sc">.</span>resp<span class="sc">.</span>status<span class="sc">}</span><span class="ss">, Reason: </span><span class="sc">{</span>e<span class="sc">.</span>error_details<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-50"><a href="#cb19-50"></a>        <span class="cf">if</span> e.resp.status <span class="op">==</span> <span class="dv">404</span>:</span>
<span id="cb19-51"><a href="#cb19-51"></a>            <span class="bu">print</span>(<span class="ss">f"Spreadsheet with ID '</span><span class="sc">{</span>spreadsheet_id<span class="sc">}</span><span class="ss">' not found. Creating a new sheet."</span>)</span>
<span id="cb19-52"><a href="#cb19-52"></a>            <span class="cf">return</span> create_new_sheet(new_sheet_name), <span class="dv">0</span></span>
<span id="cb19-53"><a href="#cb19-53"></a>        <span class="cf">else</span>:</span>
<span id="cb19-54"><a href="#cb19-54"></a>            <span class="cf">raise</span></span>
<span id="cb19-55"><a href="#cb19-55"></a></span>
<span id="cb19-56"><a href="#cb19-56"></a>    total_cells <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb19-57"><a href="#cb19-57"></a>    <span class="cf">for</span> sheet <span class="kw">in</span> sheets:</span>
<span id="cb19-58"><a href="#cb19-58"></a>        properties <span class="op">=</span> sheet.get(<span class="st">'properties'</span>, {})</span>
<span id="cb19-59"><a href="#cb19-59"></a>        grid_properties <span class="op">=</span> properties.get(<span class="st">'gridProperties'</span>, {})</span>
<span id="cb19-60"><a href="#cb19-60"></a>        rows <span class="op">=</span> grid_properties.get(<span class="st">'rowCount'</span>, <span class="dv">0</span>)</span>
<span id="cb19-61"><a href="#cb19-61"></a>        cols <span class="op">=</span> grid_properties.get(<span class="st">'columnCount'</span>, <span class="dv">0</span>)</span>
<span id="cb19-62"><a href="#cb19-62"></a>        total_cells <span class="op">+=</span> rows <span class="op">*</span> cols</span>
<span id="cb19-63"><a href="#cb19-63"></a></span>
<span id="cb19-64"><a href="#cb19-64"></a>    <span class="cf">return</span> spreadsheet_id, total_cells</span>
<span id="cb19-65"><a href="#cb19-65"></a></span>
<span id="cb19-66"><a href="#cb19-66"></a><span class="co"># Function to read data from a Google Sheet</span></span>
<span id="cb19-67"><a href="#cb19-67"></a><span class="kw">def</span> read_data(spreadsheet_id, range_name):</span>
<span id="cb19-68"><a href="#cb19-68"></a>    service <span class="op">=</span> get_sheets_service()</span>
<span id="cb19-69"><a href="#cb19-69"></a>    result <span class="op">=</span> service.spreadsheets().values().get(spreadsheetId<span class="op">=</span>spreadsheet_id, <span class="bu">range</span><span class="op">=</span>range_name).execute()</span>
<span id="cb19-70"><a href="#cb19-70"></a>    rows <span class="op">=</span> result.get(<span class="st">'values'</span>, [])</span>
<span id="cb19-71"><a href="#cb19-71"></a>    <span class="cf">return</span> rows</span>
<span id="cb19-72"><a href="#cb19-72"></a></span>
<span id="cb19-73"><a href="#cb19-73"></a><span class="co"># Function to write data to a Google Sheet</span></span>
<span id="cb19-74"><a href="#cb19-74"></a><span class="kw">def</span> write_data(spreadsheet_id, range_name, values):</span>
<span id="cb19-75"><a href="#cb19-75"></a>    service <span class="op">=</span> get_sheets_service()</span>
<span id="cb19-76"><a href="#cb19-76"></a>    body <span class="op">=</span> {</span>
<span id="cb19-77"><a href="#cb19-77"></a>        <span class="st">'values'</span>: values</span>
<span id="cb19-78"><a href="#cb19-78"></a>    }</span>
<span id="cb19-79"><a href="#cb19-79"></a>    result <span class="op">=</span> service.spreadsheets().values().update(</span>
<span id="cb19-80"><a href="#cb19-80"></a>        spreadsheetId<span class="op">=</span>spreadsheet_id, <span class="bu">range</span><span class="op">=</span>range_name,</span>
<span id="cb19-81"><a href="#cb19-81"></a>        valueInputOption<span class="op">=</span><span class="st">'RAW'</span>, body<span class="op">=</span>body).execute()</span>
<span id="cb19-82"><a href="#cb19-82"></a>    <span class="cf">return</span> result</span>
<span id="cb19-83"><a href="#cb19-83"></a></span>
<span id="cb19-84"><a href="#cb19-84"></a><span class="co"># Function to append data to a Google Sheet</span></span>
<span id="cb19-85"><a href="#cb19-85"></a><span class="kw">def</span> append_data(spreadsheet_id, range_name, values):</span>
<span id="cb19-86"><a href="#cb19-86"></a>    service <span class="op">=</span> get_sheets_service()</span>
<span id="cb19-87"><a href="#cb19-87"></a>    body <span class="op">=</span> {</span>
<span id="cb19-88"><a href="#cb19-88"></a>        <span class="st">'values'</span>: values</span>
<span id="cb19-89"><a href="#cb19-89"></a>    }</span>
<span id="cb19-90"><a href="#cb19-90"></a>    result <span class="op">=</span> service.spreadsheets().values().append(</span>
<span id="cb19-91"><a href="#cb19-91"></a>        spreadsheetId<span class="op">=</span>spreadsheet_id, <span class="bu">range</span><span class="op">=</span>range_name,</span>
<span id="cb19-92"><a href="#cb19-92"></a>        valueInputOption<span class="op">=</span><span class="st">'RAW'</span>, body<span class="op">=</span>body).execute()</span>
<span id="cb19-93"><a href="#cb19-93"></a>    <span class="cf">return</span> result</span>
<span id="cb19-94"><a href="#cb19-94"></a></span>
<span id="cb19-95"><a href="#cb19-95"></a><span class="co"># Function to delete data in a Google Sheet</span></span>
<span id="cb19-96"><a href="#cb19-96"></a><span class="kw">def</span> clear_data(spreadsheet_id, range_name):</span>
<span id="cb19-97"><a href="#cb19-97"></a>    service <span class="op">=</span> get_sheets_service()</span>
<span id="cb19-98"><a href="#cb19-98"></a>    result <span class="op">=</span> service.spreadsheets().values().clear(spreadsheetId<span class="op">=</span>spreadsheet_id, <span class="bu">range</span><span class="op">=</span>range_name).execute()</span>
<span id="cb19-99"><a href="#cb19-99"></a>    <span class="cf">return</span> result</span>
<span id="cb19-100"><a href="#cb19-100"></a></span>
<span id="cb19-101"><a href="#cb19-101"></a><span class="kw">def</span> main():</span>
<span id="cb19-102"><a href="#cb19-102"></a>    spreadsheet_id <span class="op">=</span> <span class="st">'your-spreadsheet-id'</span>  <span class="co"># Replace with your Google Sheet ID</span></span>
<span id="cb19-103"><a href="#cb19-103"></a>    read_range <span class="op">=</span> <span class="st">'Sheet1!A1:E5'</span></span>
<span id="cb19-104"><a href="#cb19-104"></a>    write_range <span class="op">=</span> <span class="st">'Sheet1!A1'</span></span>
<span id="cb19-105"><a href="#cb19-105"></a>    append_range <span class="op">=</span> <span class="st">'Sheet1!A1'</span></span>
<span id="cb19-106"><a href="#cb19-106"></a>    clear_range <span class="op">=</span> <span class="st">'Sheet1!A1:E5'</span></span>
<span id="cb19-107"><a href="#cb19-107"></a>    max_cells <span class="op">=</span> <span class="dv">5000000</span></span>
<span id="cb19-108"><a href="#cb19-108"></a>    </span>
<span id="cb19-109"><a href="#cb19-109"></a>    <span class="co"># Get current date and time</span></span>
<span id="cb19-110"><a href="#cb19-110"></a>    current_time <span class="op">=</span> datetime.now().strftime(<span class="st">"%Y-%m-</span><span class="sc">%d</span><span class="st"> %H:%M:%S"</span>)</span>
<span id="cb19-111"><a href="#cb19-111"></a>    new_sheet_name <span class="op">=</span> <span class="ss">f"Pi-Sensor </span><span class="sc">{</span>current_time<span class="sc">}</span><span class="ss">"</span>  <span class="co"># New sheet name with date and time</span></span>
<span id="cb19-112"><a href="#cb19-112"></a>    </span>
<span id="cb19-113"><a href="#cb19-113"></a>    <span class="co"># Check sheet size and create new sheet if necessary</span></span>
<span id="cb19-114"><a href="#cb19-114"></a>    spreadsheet_id, total_cells <span class="op">=</span> check_sheet_size(spreadsheet_id, new_sheet_name)</span>
<span id="cb19-115"><a href="#cb19-115"></a>    <span class="bu">print</span>(<span class="ss">f"Total cells in the sheet: </span><span class="sc">{</span>total_cells<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-116"><a href="#cb19-116"></a>    </span>
<span id="cb19-117"><a href="#cb19-117"></a>    <span class="cf">if</span> total_cells <span class="op">&gt;=</span> max_cells:</span>
<span id="cb19-118"><a href="#cb19-118"></a>        <span class="bu">print</span>(<span class="st">"The sheet has reached the maximum cell limit. Creating a new sheet."</span>)</span>
<span id="cb19-119"><a href="#cb19-119"></a>        spreadsheet_id <span class="op">=</span> create_new_sheet(new_sheet_name)</span>
<span id="cb19-120"><a href="#cb19-120"></a>    <span class="cf">else</span>:</span>
<span id="cb19-121"><a href="#cb19-121"></a>        <span class="bu">print</span>(<span class="st">"The sheet has not reached the maximum cell limit."</span>)</span>
<span id="cb19-122"><a href="#cb19-122"></a>    </span>
<span id="cb19-123"><a href="#cb19-123"></a>    <span class="co"># Reading data</span></span>
<span id="cb19-124"><a href="#cb19-124"></a>    rows <span class="op">=</span> read_data(spreadsheet_id, read_range)</span>
<span id="cb19-125"><a href="#cb19-125"></a>    <span class="bu">print</span>(<span class="st">"Read data:"</span>)</span>
<span id="cb19-126"><a href="#cb19-126"></a>    <span class="cf">for</span> row <span class="kw">in</span> rows:</span>
<span id="cb19-127"><a href="#cb19-127"></a>        <span class="bu">print</span>(row)</span>
<span id="cb19-128"><a href="#cb19-128"></a>    </span>
<span id="cb19-129"><a href="#cb19-129"></a>    <span class="co"># Writing data</span></span>
<span id="cb19-130"><a href="#cb19-130"></a>    values_to_write <span class="op">=</span> [</span>
<span id="cb19-131"><a href="#cb19-131"></a>        [<span class="st">'Name'</span>, <span class="st">'Age'</span>, <span class="st">'City'</span>],</span>
<span id="cb19-132"><a href="#cb19-132"></a>        [<span class="st">'John Doe'</span>, <span class="st">'30'</span>, <span class="st">'New York'</span>],</span>
<span id="cb19-133"><a href="#cb19-133"></a>        [<span class="st">'Jane Smith'</span>, <span class="st">'25'</span>, <span class="st">'Los Angeles'</span>]</span>
<span id="cb19-134"><a href="#cb19-134"></a>    ]</span>
<span id="cb19-135"><a href="#cb19-135"></a>    write_result <span class="op">=</span> write_data(spreadsheet_id, write_range, values_to_write)</span>
<span id="cb19-136"><a href="#cb19-136"></a>    <span class="bu">print</span>(<span class="ss">f"Data written: </span><span class="sc">{</span>write_result<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-137"><a href="#cb19-137"></a>    </span>
<span id="cb19-138"><a href="#cb19-138"></a>    <span class="co"># Appending data</span></span>
<span id="cb19-139"><a href="#cb19-139"></a>    values_to_append <span class="op">=</span> [</span>
<span id="cb19-140"><a href="#cb19-140"></a>        [<span class="st">'Alice'</span>, <span class="st">'35'</span>, <span class="st">'Chicago'</span>],</span>
<span id="cb19-141"><a href="#cb19-141"></a>        [<span class="st">'Bob'</span>, <span class="st">'40'</span>, <span class="st">'San Francisco'</span>]</span>
<span id="cb19-142"><a href="#cb19-142"></a>    ]</span>
<span id="cb19-143"><a href="#cb19-143"></a>    append_result <span class="op">=</span> append_data(spreadsheet_id, append_range, values_to_append)</span>
<span id="cb19-144"><a href="#cb19-144"></a>    <span class="bu">print</span>(<span class="ss">f"Data appended: </span><span class="sc">{</span>append_result<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-145"><a href="#cb19-145"></a>    </span>
<span id="cb19-146"><a href="#cb19-146"></a>    <span class="co"># # Clearing data</span></span>
<span id="cb19-147"><a href="#cb19-147"></a>    <span class="co"># clear_result = clear_data(spreadsheet_id, clear_range)</span></span>
<span id="cb19-148"><a href="#cb19-148"></a>    <span class="co"># print(f"Data cleared: {clear_result}")</span></span>
<span id="cb19-149"><a href="#cb19-149"></a></span>
<span id="cb19-150"><a href="#cb19-150"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">'__main__'</span>:</span>
<span id="cb19-151"><a href="#cb19-151"></a>    main()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<details>
<summary>
Code Summary
</summary>
<p>This Python script provides functionalities to interact with Google Sheets using the Google Sheets API. It includes authentication, creating new sheets, checking sheet size, reading data, writing data, appending data, and clearing data in a Google Sheet. Here is a summary of the main components and functionality:</p>
<section id="key-components" class="level3">
<h3 class="anchored" data-anchor-id="key-components"><strong>Key Components:</strong></h3>
<ol type="1">
<li><p><strong>Imports and Authentication</strong>:</p>
<ul>
<li><p>Imports necessary libraries for Google Sheets API, Google authentication, and handling HTTP errors.</p></li>
<li><p>Defines the scope required for accessing the Google Sheets API.</p></li>
</ul></li>
<li><p><strong>Authentication Function</strong>:</p>
<ul>
<li><strong><code>get_sheets_service()</code></strong>: Authenticates the user using OAuth 2.0 and returns a service object for interacting with Google Sheets.</li>
</ul></li>
<li><p><strong>Create New Google Sheet</strong>:</p>
<ul>
<li><strong><code>create_new_sheet(sheet_name)</code></strong>: Creates a new Google Sheet with the given name and returns its spreadsheet ID.</li>
</ul></li>
<li><p><strong>Check Sheet Size</strong>:</p>
<ul>
<li><strong><code>check_sheet_size(spreadsheet_id, new_sheet_name)</code></strong>: Checks the number of cells in the specified Google Sheet and creates a new sheet if the current sheet doesn’t exist or has reached the maximum cell limit.</li>
</ul></li>
<li><p><strong>Read Data from Google Sheet</strong>:</p>
<ul>
<li><strong><code>read_data(spreadsheet_id, range_name)</code></strong>: Reads data from the specified range in the Google Sheet and returns the rows of data.</li>
</ul></li>
<li><p><strong>Write Data to Google Sheet</strong>:</p>
<ul>
<li><strong><code>write_data(spreadsheet_id, range_name, values)</code></strong>: Writes the provided values to the specified range in the Google Sheet.</li>
</ul></li>
<li><p><strong>Append Data to Google Sheet</strong>:</p>
<ul>
<li><strong><code>append_data(spreadsheet_id, range_name, values)</code></strong>: Appends the provided values to the specified range in the Google Sheet.</li>
</ul></li>
<li><p><strong>Clear Data in Google Sheet</strong>:</p>
<ul>
<li><strong><code>clear_data(spreadsheet_id, range_name)</code></strong>: Clears data in the specified range in the Google Sheet.</li>
</ul></li>
</ol>
</section>
<section id="main-function" class="level3">
<h3 class="anchored" data-anchor-id="main-function"><strong>Main Function:</strong></h3>
<ol type="1">
<li><p><strong>Initialization</strong>:</p>
<ul>
<li><p>Specifies the Google Sheet ID (<strong><code>spreadsheet_id</code></strong>) and various ranges for reading, writing, appending, and clearing data.</p></li>
<li><p>Defines the maximum number of cells allowed (<strong><code>max_cells</code></strong>).</p></li>
</ul></li>
<li><p><strong>Current Date and Time</strong>:</p>
<ul>
<li>Retrieves the current date and time to create a unique name for new sheets.</li>
</ul></li>
<li><p><strong>Check and Create Sheet</strong>:</p>
<ul>
<li>Checks the size of the specified sheet and creates a new sheet if necessary.</li>
</ul></li>
<li><p><strong>Read Data</strong>:</p>
<ul>
<li>Reads data from the specified range and prints it.</li>
</ul></li>
<li><p><strong>Write Data</strong>:</p>
<ul>
<li>Writes a set of values to the specified range in the Google Sheet.</li>
</ul></li>
<li><p><strong>Append Data</strong>:</p>
<ul>
<li>Appends another set of values to the specified range in the Google Sheet.</li>
</ul></li>
<li><p><strong>Clear Data</strong> (Commented Out):</p>
<ul>
<li>Optionally clears data in the specified range.</li>
</ul></li>
</ol>
</section>
<section id="script-execution" class="level3">
<h3 class="anchored" data-anchor-id="script-execution"><strong>Script Execution:</strong></h3>
<ul>
<li>The <strong><code>main()</code></strong> function is called when the script is executed, performing the above operations sequentially.</li>
</ul>
</section>
<section id="example-output" class="level3">
<h3 class="anchored" data-anchor-id="example-output"><strong>Example Output:</strong></h3>
<ul>
<li>The script provides feedback through print statements, indicating the creation of new sheets, reading data, writing data, appending data, and handling errors.</li>
</ul>
</section>
<section id="notes" class="level3">
<h3 class="anchored" data-anchor-id="notes"><strong>Notes:</strong></h3>
<ul>
<li><p>Replace <strong><code>'your-spreadsheet-id'</code></strong> with your actual Google Sheet ID.</p></li>
<li><p>Ensure you have <strong><code>token.json</code></strong> for storing the user’s access and refresh tokens.</p></li>
</ul>
<p>This script facilitates seamless interaction with Google Sheets, allowing for efficient data management and automation of tasks.</p>
</section></details>
<p>Once I was assured that the Google Sheets API was functioning correctly I tweaked the existing Python code to also send data to a Google Sheet. The sheet was set to read only globally so I could later on access it via my github.io site or similar via javascript. I also added a *.txt file for persistence across runs where that sheet contains my spreadsheet_id, workbook_name, and sheet_name so I can start and stop the Python script whenever I wanted. I also added back in the ThingSpeak code from before with two additional parameters, date and time. That way I can bypass the 15second update limit of ThingSpeak by sending bulk data every 15 seconds and I can also use the date/time parameters to generate a plot on the off chance that the datasent uses the timestamp of receipt as the X axis when plotting. The final result is the plot below:</p>
<p><a href="ThingSpeakPlot.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="ThingSpeakPlot.png" class="img-fluid"></a></p>
<p>The Matlab code used:</p>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb20"><pre class="sourceCode numberSource matlab number-lines code-with-copy"><code class="sourceCode matlab"><span id="cb20-1"><a href="#cb20-1"></a>{<span class="va">matlab</span>}</span>
<span id="cb20-2"><a href="#cb20-2"></a><span class="co">% Template MATLAB code for visualizing data from a channel as a 2D line</span></span>
<span id="cb20-3"><a href="#cb20-3"></a><span class="co">% plot using PLOT function.</span></span>
<span id="cb20-4"><a href="#cb20-4"></a></span>
<span id="cb20-5"><a href="#cb20-5"></a><span class="co">% Prior to running this MATLAB code template, assign the channel variables.</span></span>
<span id="cb20-6"><a href="#cb20-6"></a><span class="co">% Set 'readChannelID' to the channel ID of the channel to read from. </span></span>
<span id="cb20-7"><a href="#cb20-7"></a><span class="co">% Also, assign the read field ID to 'fieldID1'. </span></span>
<span id="cb20-8"><a href="#cb20-8"></a></span>
<span id="cb20-9"><a href="#cb20-9"></a><span class="co">% </span><span class="al">TODO</span><span class="co"> - Replace the [] with channel ID to read data from:</span></span>
<span id="cb20-10"><a href="#cb20-10"></a><span class="va">readChannelID</span> <span class="op">=</span> <span class="fl">2545447</span><span class="op">;</span></span>
<span id="cb20-11"><a href="#cb20-11"></a><span class="co">% </span><span class="al">TODO</span><span class="co"> - Replace the [] with the Field ID to read data from:</span></span>
<span id="cb20-12"><a href="#cb20-12"></a><span class="va">fieldID1</span> <span class="op">=</span> <span class="fl">1</span><span class="op">;</span></span>
<span id="cb20-13"><a href="#cb20-13"></a><span class="va">fieldID2</span> <span class="op">=</span> <span class="fl">2</span><span class="op">;</span></span>
<span id="cb20-14"><a href="#cb20-14"></a><span class="va">fieldID3</span> <span class="op">=</span> <span class="fl">3</span><span class="op">;</span></span>
<span id="cb20-15"><a href="#cb20-15"></a><span class="va">fieldID4</span> <span class="op">=</span> <span class="fl">4</span><span class="op">;</span></span>
<span id="cb20-16"><a href="#cb20-16"></a><span class="va">fieldID5</span> <span class="op">=</span> <span class="fl">5</span><span class="op">;</span></span>
<span id="cb20-17"><a href="#cb20-17"></a><span class="co">% Channel Read API Key </span></span>
<span id="cb20-18"><a href="#cb20-18"></a><span class="co">% If your channel is private, then enter the read API</span></span>
<span id="cb20-19"><a href="#cb20-19"></a><span class="co">% Key between the '' below: </span></span>
<span id="cb20-20"><a href="#cb20-20"></a><span class="va">readAPIKey</span> <span class="op">=</span> <span class="ss">''</span><span class="op">;</span></span>
<span id="cb20-21"><a href="#cb20-21"></a></span>
<span id="cb20-22"><a href="#cb20-22"></a><span class="co">%% Read Data %%</span></span>
<span id="cb20-23"><a href="#cb20-23"></a>[<span class="va">data</span><span class="op">,</span> <span class="va">time</span>] <span class="op">=</span> <span class="va">thingSpeakRead</span>(<span class="va">readChannelID</span><span class="op">,</span> <span class="ss">'Field'</span><span class="op">,</span> <span class="va">fieldID1</span><span class="op">,</span> <span class="ss">'NumPoints'</span><span class="op">,</span> <span class="fl">2400</span><span class="op">,</span> <span class="ss">'ReadKey'</span><span class="op">,</span> <span class="va">readAPIKey</span>)<span class="op">;</span></span>
<span id="cb20-24"><a href="#cb20-24"></a>[<span class="va">data2</span><span class="op">,</span> <span class="va">time</span>] <span class="op">=</span> <span class="va">thingSpeakRead</span>(<span class="va">readChannelID</span><span class="op">,</span> <span class="ss">'Field'</span><span class="op">,</span> <span class="va">fieldID2</span><span class="op">,</span> <span class="ss">'NumPoints'</span><span class="op">,</span> <span class="fl">2400</span><span class="op">,</span> <span class="ss">'ReadKey'</span><span class="op">,</span> <span class="va">readAPIKey</span>)<span class="op">;</span></span>
<span id="cb20-25"><a href="#cb20-25"></a>[<span class="va">data3</span><span class="op">,</span> <span class="va">time</span>] <span class="op">=</span> <span class="va">thingSpeakRead</span>(<span class="va">readChannelID</span><span class="op">,</span> <span class="ss">'Field'</span><span class="op">,</span> <span class="va">fieldID3</span><span class="op">,</span> <span class="ss">'NumPoints'</span><span class="op">,</span> <span class="fl">2400</span><span class="op">,</span> <span class="ss">'ReadKey'</span><span class="op">,</span> <span class="va">readAPIKey</span>)<span class="op">;</span></span>
<span id="cb20-26"><a href="#cb20-26"></a>[<span class="va">data4</span><span class="op">,</span> <span class="va">time</span>] <span class="op">=</span> <span class="va">thingSpeakRead</span>(<span class="va">readChannelID</span><span class="op">,</span> <span class="ss">'Field'</span><span class="op">,</span> <span class="va">fieldID4</span><span class="op">,</span> <span class="ss">'NumPoints'</span><span class="op">,</span> <span class="fl">2400</span><span class="op">,</span> <span class="ss">'ReadKey'</span><span class="op">,</span> <span class="va">readAPIKey</span><span class="op">,</span><span class="ss">'OutputFormat'</span><span class="op">,</span> <span class="ss">'timetable'</span>)<span class="op">;</span></span>
<span id="cb20-27"><a href="#cb20-27"></a>[<span class="va">data5</span><span class="op">,</span> <span class="op">~</span>] <span class="op">=</span> <span class="va">thingSpeakRead</span>(<span class="va">readChannelID</span><span class="op">,</span> <span class="ss">'Field'</span><span class="op">,</span> <span class="va">fieldID5</span><span class="op">,</span> <span class="ss">'NumPoints'</span><span class="op">,</span> <span class="fl">2400</span><span class="op">,</span> <span class="ss">'ReadKey'</span><span class="op">,</span> <span class="va">readAPIKey</span><span class="op">,</span><span class="ss">'OutputFormat'</span><span class="op">,</span> <span class="ss">'timetable'</span>)<span class="op">;</span></span>
<span id="cb20-28"><a href="#cb20-28"></a><span class="co">%disp("data4")</span></span>
<span id="cb20-29"><a href="#cb20-29"></a><span class="co">%disp(data4)</span></span>
<span id="cb20-30"><a href="#cb20-30"></a><span class="co">%disp("data5")</span></span>
<span id="cb20-31"><a href="#cb20-31"></a><span class="co">%disp(data5)</span></span>
<span id="cb20-32"><a href="#cb20-32"></a></span>
<span id="cb20-33"><a href="#cb20-33"></a><span class="co">% Convert timestamps to datetime</span></span>
<span id="cb20-34"><a href="#cb20-34"></a><span class="va">timeComponents</span> <span class="op">=</span> <span class="va">split</span>(<span class="va">data4</span>.<span class="va">Time</span><span class="op">,</span> <span class="ss">':'</span>)<span class="op">;</span></span>
<span id="cb20-35"><a href="#cb20-35"></a><span class="va">hour</span> <span class="op">=</span> <span class="va">str2double</span>(<span class="va">timeComponents</span>(<span class="op">:,</span><span class="fl">1</span>))<span class="op">;</span></span>
<span id="cb20-36"><a href="#cb20-36"></a><span class="va">minute</span> <span class="op">=</span> <span class="va">str2double</span>(<span class="va">timeComponents</span>(<span class="op">:,</span><span class="fl">2</span>))<span class="op">;</span></span>
<span id="cb20-37"><a href="#cb20-37"></a><span class="va">second</span> <span class="op">=</span> <span class="va">str2double</span>(<span class="va">timeComponents</span>(<span class="op">:,</span><span class="fl">3</span>))<span class="op">;</span></span>
<span id="cb20-38"><a href="#cb20-38"></a><span class="va">timeOfDay</span> <span class="op">=</span> <span class="va">duration</span>(<span class="va">hour</span><span class="op">,</span> <span class="va">minute</span><span class="op">,</span> <span class="va">second</span>)<span class="op">;</span></span>
<span id="cb20-39"><a href="#cb20-39"></a><span class="va">dateTime</span> <span class="op">=</span> <span class="va">data5</span>.<span class="va">Timestamps</span> <span class="op">+</span> <span class="va">timeOfDay</span><span class="op">;</span></span>
<span id="cb20-40"><a href="#cb20-40"></a></span>
<span id="cb20-41"><a href="#cb20-41"></a></span>
<span id="cb20-42"><a href="#cb20-42"></a><span class="co">% Trim or interpolate data if necessary to match the length of timeData</span></span>
<span id="cb20-43"><a href="#cb20-43"></a><span class="va">data</span> <span class="op">=</span> <span class="va">data</span>(<span class="fl">1</span><span class="op">:</span><span class="va">length</span>(<span class="va">dateTime</span>))<span class="op">;</span></span>
<span id="cb20-44"><a href="#cb20-44"></a><span class="va">data2</span> <span class="op">=</span> <span class="va">data2</span>(<span class="fl">1</span><span class="op">:</span><span class="va">length</span>(<span class="va">dateTime</span>))<span class="op">;</span></span>
<span id="cb20-45"><a href="#cb20-45"></a><span class="va">data3</span> <span class="op">=</span> <span class="va">data3</span>(<span class="fl">1</span><span class="op">:</span><span class="va">length</span>(<span class="va">dateTime</span>))<span class="op">;</span></span>
<span id="cb20-46"><a href="#cb20-46"></a></span>
<span id="cb20-47"><a href="#cb20-47"></a><span class="co">% Visualize Data</span></span>
<span id="cb20-48"><a href="#cb20-48"></a><span class="va">figure</span><span class="op">;</span></span>
<span id="cb20-49"><a href="#cb20-49"></a><span class="va">plot</span>(<span class="va">dateTime</span><span class="op">,</span> [<span class="va">data</span><span class="op">,</span> <span class="va">data2</span><span class="op">,</span> <span class="va">data3</span>])<span class="op">;</span></span>
<span id="cb20-50"><a href="#cb20-50"></a><span class="va">xlabel</span>(<span class="ss">''</span>)<span class="op">;</span></span>
<span id="cb20-51"><a href="#cb20-51"></a><span class="va">ylabel</span>(<span class="ss">'Data'</span>)<span class="op">;</span></span>
<span id="cb20-52"><a href="#cb20-52"></a><span class="va">title</span>(<span class="ss">'ThingSpeak Data'</span>)<span class="op">;</span></span>
<span id="cb20-53"><a href="#cb20-53"></a><span class="va">legend</span>(<span class="ss">'Temp_C'</span><span class="op">,</span> <span class="ss">'Temp_F'</span><span class="op">,</span> <span class="ss">'Humidity%'</span><span class="op">,</span> <span class="ss">'Location'</span><span class="op">,</span> <span class="ss">'eastoutside'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<details>
<summary>
Code Summary
</summary>
<p>This MATLAB script visualizes data from a ThingSpeak channel as a 2D line plot. The script reads data from multiple fields of the specified ThingSpeak channel, processes the timestamps, and then plots the data. Here is a detailed summary of the script:</p>

<section id="key-components-1" class="level3">
<h3 class="anchored" data-anchor-id="key-components-1"><strong>Key Components:</strong></h3>
<ol type="1">
<li><p><strong>Channel Configuration</strong>:</p>
<ul>
<li><p><strong><code>readChannelID</code></strong>: The ID of the ThingSpeak channel to read data from.</p></li>
<li><p><strong><code>fieldID1</code></strong> to <strong><code>fieldID5</code></strong>: The field IDs from which data will be read.</p></li>
<li><p><strong><code>readAPIKey</code></strong>: The API key to access the channel (if it is private).</p></li>
</ul></li>
<li><p><strong>Reading Data</strong>:</p>
<ul>
<li><strong><code>thingSpeakRead</code></strong>: Reads data from the specified channel fields, up to 2400 points.</li>
</ul></li>
<li><p><strong>Processing Timestamps</strong>:</p>
<ul>
<li><p>Converts the timestamps into a format that MATLAB can use for plotting.</p></li>
<li><p>Combines the date from one field with the time from another to create a datetime array.</p></li>
</ul></li>
<li><p><strong>Data Trimming</strong>:</p>
<ul>
<li>Ensures that the data arrays match in length to avoid plotting issues.</li>
</ul></li>
<li><p><strong>Plotting Data</strong>:</p>
<ul>
<li>Uses the <strong><code>plot</code></strong> function to create a 2D line plot of the data.</li>
</ul></li>
<li><p>Adds labels, a title, and a legend to the plot.</p></li>
</ol>
</section>
<section id="explanation" class="level3">
<h3 class="anchored" data-anchor-id="explanation"><strong>Explanation:</strong></h3>
<ol type="1">
<li><p><strong>Channel and Field Setup</strong>:</p>
<ul>
<li><p>Replace <strong><code>readChannelID</code></strong> and <strong><code>fieldID1</code></strong> to <strong><code>fieldID5</code></strong> with your actual ThingSpeak channel ID and field IDs.</p></li>
<li><p>If the channel is private, provide the <strong><code>readAPIKey</code></strong>.</p></li>
</ul></li>
<li><p><strong>Reading Data</strong>:</p>
<ul>
<li><p>The <strong><code>thingSpeakRead</code></strong> function is used to read data from each specified field.</p></li>
<li><p>The ‘NumPoints’ parameter limits the data to the latest 2400 points.</p></li>
</ul></li>
<li><p><strong>Timestamp Processing</strong>:</p>
<ul>
<li><p>Extracts and splits the time components (hours, minutes, and seconds) from <strong><code>data4.Time</code></strong>.</p></li>
<li><p>Creates a <strong><code>duration</code></strong> array for the time of day and combines it with <strong><code>data5.Timestamps</code></strong> to form a <strong><code>datetime</code></strong> array.</p></li>
</ul></li>
<li><p><strong>Data Trimming</strong>:</p>
<ul>
<li>Ensures all data arrays (<strong><code>data</code></strong>, <strong><code>data2</code></strong>, <strong><code>data3</code></strong>) match the length of <strong><code>dateTime</code></strong> to avoid issues in plotting.</li>
</ul></li>
<li><p><strong>Plotting</strong>:</p>
<ul>
<li><p>Creates a line plot of the data with the time on the x-axis and the data values on the y-axis.</p></li>
<li><p>Adds labels to the x and y axes, a title to the plot, and a legend.</p></li>
</ul></li>
</ol>
<p>This script provides a clear and structured way to visualize data from multiple fields of a ThingSpeak channel in MATLAB. Adjust the channel ID, field IDs, and API key as needed for your specific use case.</p>
</section></details>
<p>Now as far as the Python code goes, it is pretty lengthy at this point so buyer beware:</p>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb21"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1"></a>{python}</span>
<span id="cb21-2"><a href="#cb21-2"></a><span class="im">import</span> os</span>
<span id="cb21-3"><a href="#cb21-3"></a><span class="im">import</span> time <span class="im">as</span> time_module</span>
<span id="cb21-4"><a href="#cb21-4"></a><span class="im">import</span> requests</span>
<span id="cb21-5"><a href="#cb21-5"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb21-6"><a href="#cb21-6"></a><span class="im">import</span> random</span>
<span id="cb21-7"><a href="#cb21-7"></a><span class="im">import</span> json</span>
<span id="cb21-8"><a href="#cb21-8"></a><span class="im">import</span> Adafruit_DHT</span>
<span id="cb21-9"><a href="#cb21-9"></a><span class="im">from</span> google.auth.transport.requests <span class="im">import</span> Request</span>
<span id="cb21-10"><a href="#cb21-10"></a><span class="im">from</span> google.oauth2.credentials <span class="im">import</span> Credentials</span>
<span id="cb21-11"><a href="#cb21-11"></a><span class="im">from</span> google_auth_oauthlib.flow <span class="im">import</span> InstalledAppFlow</span>
<span id="cb21-12"><a href="#cb21-12"></a><span class="im">from</span> googleapiclient.discovery <span class="im">import</span> build</span>
<span id="cb21-13"><a href="#cb21-13"></a><span class="im">from</span> googleapiclient.errors <span class="im">import</span> HttpError</span>
<span id="cb21-14"><a href="#cb21-14"></a></span>
<span id="cb21-15"><a href="#cb21-15"></a><span class="co"># Control flags</span></span>
<span id="cb21-16"><a href="#cb21-16"></a>SEND_TO_VERCEL <span class="op">=</span> <span class="va">True</span></span>
<span id="cb21-17"><a href="#cb21-17"></a>SEND_TO_GOOGLE_SHEETS <span class="op">=</span> <span class="va">True</span></span>
<span id="cb21-18"><a href="#cb21-18"></a>SEND_TO_THINGSPEAK <span class="op">=</span> <span class="va">True</span></span>
<span id="cb21-19"><a href="#cb21-19"></a></span>
<span id="cb21-20"><a href="#cb21-20"></a><span class="co"># ThingSpeak API settings</span></span>
<span id="cb21-21"><a href="#cb21-21"></a>THINGSPEAK_API_KEY <span class="op">=</span> <span class="st">'KEY'</span> <span class="co"># Replace with your ThingSpeak API key</span></span>
<span id="cb21-22"><a href="#cb21-22"></a>THINGSPEAK_BASE_URL <span class="op">=</span> <span class="st">'https://api.thingspeak.com/update'</span></span>
<span id="cb21-23"><a href="#cb21-23"></a></span>
<span id="cb21-24"><a href="#cb21-24"></a>VERCEL_API_KEY <span class="op">=</span> <span class="st">'SETMEUPINENVIRONMENTVARIABLES'</span></span>
<span id="cb21-25"><a href="#cb21-25"></a><span class="co"># Sensor setup</span></span>
<span id="cb21-26"><a href="#cb21-26"></a>SENSOR <span class="op">=</span> Adafruit_DHT.DHT11  <span class="co"># Using DHT11 sensor</span></span>
<span id="cb21-27"><a href="#cb21-27"></a>PIN <span class="op">=</span> <span class="dv">4</span>  <span class="co"># Change this to the GPIO pin number that the sensor is connected to</span></span>
<span id="cb21-28"><a href="#cb21-28"></a></span>
<span id="cb21-29"><a href="#cb21-29"></a><span class="co"># Vercel endpoint URL</span></span>
<span id="cb21-30"><a href="#cb21-30"></a>URL <span class="op">=</span> <span class="st">'YOURURL'</span></span>
<span id="cb21-31"><a href="#cb21-31"></a></span>
<span id="cb21-32"><a href="#cb21-32"></a><span class="co"># Buffer to store data</span></span>
<span id="cb21-33"><a href="#cb21-33"></a>data_buffer <span class="op">=</span> []</span>
<span id="cb21-34"><a href="#cb21-34"></a>thingspeak_buffer <span class="op">=</span> []  <span class="co"># Buffer for ThingSpeak data</span></span>
<span id="cb21-35"><a href="#cb21-35"></a></span>
<span id="cb21-36"><a href="#cb21-36"></a><span class="co"># Define loop time in seconds</span></span>
<span id="cb21-37"><a href="#cb21-37"></a>LOOP_TIME <span class="op">=</span> <span class="dv">1</span>  <span class="co"># You can change this to the desired loop time in seconds</span></span>
<span id="cb21-38"><a href="#cb21-38"></a></span>
<span id="cb21-39"><a href="#cb21-39"></a><span class="co"># Define the scopes required for the Google Sheets and Drive APIs</span></span>
<span id="cb21-40"><a href="#cb21-40"></a>SCOPES <span class="op">=</span> [</span>
<span id="cb21-41"><a href="#cb21-41"></a>    <span class="st">'https://www.googleapis.com/auth/spreadsheets'</span>,</span>
<span id="cb21-42"><a href="#cb21-42"></a>    <span class="st">'https://www.googleapis.com/auth/drive.file'</span></span>
<span id="cb21-43"><a href="#cb21-43"></a>]</span>
<span id="cb21-44"><a href="#cb21-44"></a></span>
<span id="cb21-45"><a href="#cb21-45"></a><span class="co"># Global variable to hold credentials</span></span>
<span id="cb21-46"><a href="#cb21-46"></a>creds <span class="op">=</span> <span class="va">None</span></span>
<span id="cb21-47"><a href="#cb21-47"></a></span>
<span id="cb21-48"><a href="#cb21-48"></a><span class="co"># Function to get authenticated Sheets service</span></span>
<span id="cb21-49"><a href="#cb21-49"></a><span class="kw">def</span> get_sheets_service():</span>
<span id="cb21-50"><a href="#cb21-50"></a>    <span class="kw">global</span> creds</span>
<span id="cb21-51"><a href="#cb21-51"></a>    <span class="cf">if</span> os.path.exists(<span class="st">'token.json'</span>):</span>
<span id="cb21-52"><a href="#cb21-52"></a>        creds <span class="op">=</span> Credentials.from_authorized_user_file(<span class="st">'token.json'</span>, SCOPES)</span>
<span id="cb21-53"><a href="#cb21-53"></a>    <span class="cf">if</span> <span class="kw">not</span> creds <span class="kw">or</span> <span class="kw">not</span> creds.valid:</span>
<span id="cb21-54"><a href="#cb21-54"></a>        <span class="cf">if</span> creds <span class="kw">and</span> creds.expired <span class="kw">and</span> creds.refresh_token:</span>
<span id="cb21-55"><a href="#cb21-55"></a>            creds.refresh(Request())</span>
<span id="cb21-56"><a href="#cb21-56"></a>        <span class="cf">else</span>:</span>
<span id="cb21-57"><a href="#cb21-57"></a>            flow <span class="op">=</span> InstalledAppFlow.from_client_secrets_file(<span class="st">'credentials.json'</span>, SCOPES)</span>
<span id="cb21-58"><a href="#cb21-58"></a>            creds <span class="op">=</span> flow.run_local_server(port<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb21-59"><a href="#cb21-59"></a>        <span class="cf">with</span> <span class="bu">open</span>(<span class="st">'token.json'</span>, <span class="st">'w'</span>) <span class="im">as</span> token:</span>
<span id="cb21-60"><a href="#cb21-60"></a>            token.write(creds.to_json())</span>
<span id="cb21-61"><a href="#cb21-61"></a>    <span class="cf">return</span> build(<span class="st">'sheets'</span>, <span class="st">'v4'</span>, credentials<span class="op">=</span>creds)</span>
<span id="cb21-62"><a href="#cb21-62"></a></span>
<span id="cb21-63"><a href="#cb21-63"></a><span class="co"># Function to get authenticated Drive service</span></span>
<span id="cb21-64"><a href="#cb21-64"></a><span class="kw">def</span> get_drive_service():</span>
<span id="cb21-65"><a href="#cb21-65"></a>    <span class="kw">global</span> creds</span>
<span id="cb21-66"><a href="#cb21-66"></a>    <span class="cf">if</span> creds <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb21-67"><a href="#cb21-67"></a>        get_sheets_service()  <span class="co"># This will initialize creds</span></span>
<span id="cb21-68"><a href="#cb21-68"></a>    <span class="cf">return</span> build(<span class="st">'drive'</span>, <span class="st">'v3'</span>, credentials<span class="op">=</span>creds)</span>
<span id="cb21-69"><a href="#cb21-69"></a></span>
<span id="cb21-70"><a href="#cb21-70"></a><span class="co"># Function to set a Google Sheet's permissions to public</span></span>
<span id="cb21-71"><a href="#cb21-71"></a><span class="kw">def</span> set_sheet_public(spreadsheet_id):</span>
<span id="cb21-72"><a href="#cb21-72"></a>    drive_service <span class="op">=</span> get_drive_service()</span>
<span id="cb21-73"><a href="#cb21-73"></a>    permission <span class="op">=</span> {</span>
<span id="cb21-74"><a href="#cb21-74"></a>        <span class="st">'type'</span>: <span class="st">'anyone'</span>,</span>
<span id="cb21-75"><a href="#cb21-75"></a>        <span class="st">'role'</span>: <span class="st">'reader'</span></span>
<span id="cb21-76"><a href="#cb21-76"></a>    }</span>
<span id="cb21-77"><a href="#cb21-77"></a>    <span class="cf">try</span>:</span>
<span id="cb21-78"><a href="#cb21-78"></a>        drive_service.permissions().create(fileId<span class="op">=</span>spreadsheet_id, body<span class="op">=</span>permission).execute()</span>
<span id="cb21-79"><a href="#cb21-79"></a>        <span class="bu">print</span>(<span class="ss">f"Set spreadsheet with ID </span><span class="sc">{</span>spreadsheet_id<span class="sc">}</span><span class="ss"> to public"</span>)</span>
<span id="cb21-80"><a href="#cb21-80"></a>    <span class="cf">except</span> HttpError <span class="im">as</span> error:</span>
<span id="cb21-81"><a href="#cb21-81"></a>        <span class="bu">print</span>(<span class="ss">f"An error occurred: </span><span class="sc">{</span>error<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-82"><a href="#cb21-82"></a></span>
<span id="cb21-83"><a href="#cb21-83"></a><span class="co"># Function to create a new Google Sheet with a given name</span></span>
<span id="cb21-84"><a href="#cb21-84"></a><span class="kw">def</span> create_new_sheet(sheet_name):</span>
<span id="cb21-85"><a href="#cb21-85"></a>    service <span class="op">=</span> get_sheets_service()</span>
<span id="cb21-86"><a href="#cb21-86"></a>    spreadsheet <span class="op">=</span> {</span>
<span id="cb21-87"><a href="#cb21-87"></a>        <span class="st">'properties'</span>: {</span>
<span id="cb21-88"><a href="#cb21-88"></a>            <span class="st">'title'</span>: sheet_name</span>
<span id="cb21-89"><a href="#cb21-89"></a>        }</span>
<span id="cb21-90"><a href="#cb21-90"></a>    }</span>
<span id="cb21-91"><a href="#cb21-91"></a>    spreadsheet <span class="op">=</span> service.spreadsheets().create(body<span class="op">=</span>spreadsheet, fields<span class="op">=</span><span class="st">'spreadsheetId'</span>).execute()</span>
<span id="cb21-92"><a href="#cb21-92"></a>    spreadsheet_id <span class="op">=</span> spreadsheet.get(<span class="st">'spreadsheetId'</span>)</span>
<span id="cb21-93"><a href="#cb21-93"></a>    <span class="bu">print</span>(<span class="ss">f"Created new spreadsheet with ID: </span><span class="sc">{</span>spreadsheet_id<span class="sc">}</span><span class="ss">, Name: </span><span class="sc">{</span>sheet_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-94"><a href="#cb21-94"></a></span>
<span id="cb21-95"><a href="#cb21-95"></a>    <span class="co"># Set the new sheet to be publicly viewable</span></span>
<span id="cb21-96"><a href="#cb21-96"></a>    set_sheet_public(spreadsheet_id)</span>
<span id="cb21-97"><a href="#cb21-97"></a></span>
<span id="cb21-98"><a href="#cb21-98"></a>    <span class="co"># Save the new spreadsheet info</span></span>
<span id="cb21-99"><a href="#cb21-99"></a>    save_spreadsheet_info(spreadsheet_id, sheet_name, <span class="st">"Sheet1"</span>)</span>
<span id="cb21-100"><a href="#cb21-100"></a></span>
<span id="cb21-101"><a href="#cb21-101"></a>    <span class="cf">return</span> spreadsheet_id</span>
<span id="cb21-102"><a href="#cb21-102"></a></span>
<span id="cb21-103"><a href="#cb21-103"></a><span class="co"># Function to check the number of cells in the Google Sheet and create a new one if it doesn't exist</span></span>
<span id="cb21-104"><a href="#cb21-104"></a><span class="kw">def</span> check_sheet_size(spreadsheet_id, new_sheet_name):</span>
<span id="cb21-105"><a href="#cb21-105"></a>    service <span class="op">=</span> get_sheets_service()</span>
<span id="cb21-106"><a href="#cb21-106"></a>    <span class="cf">try</span>:</span>
<span id="cb21-107"><a href="#cb21-107"></a>        sheet <span class="op">=</span> service.spreadsheets().get(spreadsheetId<span class="op">=</span>spreadsheet_id).execute()</span>
<span id="cb21-108"><a href="#cb21-108"></a>        sheets <span class="op">=</span> sheet.get(<span class="st">'sheets'</span>, [])</span>
<span id="cb21-109"><a href="#cb21-109"></a>    <span class="cf">except</span> HttpError <span class="im">as</span> e:</span>
<span id="cb21-110"><a href="#cb21-110"></a>        <span class="bu">print</span>(<span class="ss">f"HttpError encountered: Status code: </span><span class="sc">{</span>e<span class="sc">.</span>resp<span class="sc">.</span>status<span class="sc">}</span><span class="ss">, Reason: </span><span class="sc">{</span>e<span class="sc">.</span>error_details<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-111"><a href="#cb21-111"></a>        <span class="cf">if</span> e.resp.status <span class="op">==</span> <span class="dv">404</span>:</span>
<span id="cb21-112"><a href="#cb21-112"></a>            <span class="bu">print</span>(<span class="ss">f"Spreadsheet with ID '</span><span class="sc">{</span>spreadsheet_id<span class="sc">}</span><span class="ss">' not found. Creating a new sheet."</span>)</span>
<span id="cb21-113"><a href="#cb21-113"></a>            <span class="cf">return</span> create_new_sheet(new_sheet_name), <span class="dv">0</span></span>
<span id="cb21-114"><a href="#cb21-114"></a>        <span class="cf">else</span>:</span>
<span id="cb21-115"><a href="#cb21-115"></a>            <span class="cf">raise</span></span>
<span id="cb21-116"><a href="#cb21-116"></a></span>
<span id="cb21-117"><a href="#cb21-117"></a>    total_cells <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb21-118"><a href="#cb21-118"></a>    <span class="cf">for</span> sheet <span class="kw">in</span> sheets:</span>
<span id="cb21-119"><a href="#cb21-119"></a>        properties <span class="op">=</span> sheet.get(<span class="st">'properties'</span>, {})</span>
<span id="cb21-120"><a href="#cb21-120"></a>        grid_properties <span class="op">=</span> properties.get(<span class="st">'gridProperties'</span>, {})</span>
<span id="cb21-121"><a href="#cb21-121"></a>        rows <span class="op">=</span> grid_properties.get(<span class="st">'rowCount'</span>, <span class="dv">0</span>)</span>
<span id="cb21-122"><a href="#cb21-122"></a>        cols <span class="op">=</span> grid_properties.get(<span class="st">'columnCount'</span>, <span class="dv">0</span>)</span>
<span id="cb21-123"><a href="#cb21-123"></a>        total_cells <span class="op">+=</span> rows <span class="op">*</span> cols</span>
<span id="cb21-124"><a href="#cb21-124"></a></span>
<span id="cb21-125"><a href="#cb21-125"></a>    <span class="cf">return</span> spreadsheet_id, total_cells</span>
<span id="cb21-126"><a href="#cb21-126"></a></span>
<span id="cb21-127"><a href="#cb21-127"></a><span class="co"># Function to find the last empty row in the Google Sheet</span></span>
<span id="cb21-128"><a href="#cb21-128"></a><span class="kw">def</span> find_last_empty_row(service, spreadsheet_id, sheet_name):</span>
<span id="cb21-129"><a href="#cb21-129"></a>    max_retries <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb21-130"><a href="#cb21-130"></a>    retry_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb21-131"><a href="#cb21-131"></a>    backoff_factor <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb21-132"><a href="#cb21-132"></a></span>
<span id="cb21-133"><a href="#cb21-133"></a>    range_name <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>sheet_name<span class="sc">}</span><span class="ss">!A:A"</span></span>
<span id="cb21-134"><a href="#cb21-134"></a></span>
<span id="cb21-135"><a href="#cb21-135"></a>    <span class="cf">while</span> retry_count <span class="op">&lt;</span> max_retries:</span>
<span id="cb21-136"><a href="#cb21-136"></a>        <span class="cf">try</span>:</span>
<span id="cb21-137"><a href="#cb21-137"></a>            result <span class="op">=</span> service.spreadsheets().values().get(</span>
<span id="cb21-138"><a href="#cb21-138"></a>                spreadsheetId<span class="op">=</span>spreadsheet_id,</span>
<span id="cb21-139"><a href="#cb21-139"></a>                <span class="bu">range</span><span class="op">=</span>range_name</span>
<span id="cb21-140"><a href="#cb21-140"></a>            ).execute()</span>
<span id="cb21-141"><a href="#cb21-141"></a></span>
<span id="cb21-142"><a href="#cb21-142"></a>            values <span class="op">=</span> result.get(<span class="st">'values'</span>, [])</span>
<span id="cb21-143"><a href="#cb21-143"></a>            <span class="bu">print</span>(<span class="ss">f"Debug - Number of rows in column A: </span><span class="sc">{</span><span class="bu">len</span>(values)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-144"><a href="#cb21-144"></a>            <span class="cf">return</span> <span class="bu">len</span>(values) <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb21-145"><a href="#cb21-145"></a>        <span class="cf">except</span> HttpError <span class="im">as</span> e:</span>
<span id="cb21-146"><a href="#cb21-146"></a>            <span class="cf">if</span> e.resp.status <span class="kw">in</span> [<span class="dv">500</span>, <span class="dv">503</span>]:</span>
<span id="cb21-147"><a href="#cb21-147"></a>                retry_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb21-148"><a href="#cb21-148"></a>                sleep_time <span class="op">=</span> backoff_factor <span class="op">**</span> retry_count <span class="op">+</span> random.uniform(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb21-149"><a href="#cb21-149"></a>                <span class="bu">print</span>(<span class="ss">f"HttpError </span><span class="sc">{</span>e<span class="sc">.</span>resp<span class="sc">.</span>status<span class="sc">}</span><span class="ss"> encountered. Retrying in </span><span class="sc">{</span>sleep_time<span class="sc">:.1f}</span><span class="ss"> seconds..."</span>)</span>
<span id="cb21-150"><a href="#cb21-150"></a>                time.sleep(sleep_time)</span>
<span id="cb21-151"><a href="#cb21-151"></a>            <span class="cf">else</span>:</span>
<span id="cb21-152"><a href="#cb21-152"></a>                <span class="cf">raise</span></span>
<span id="cb21-153"><a href="#cb21-153"></a>    <span class="cf">raise</span> <span class="pp">Exception</span>(<span class="st">"Failed to retrieve last empty row after several retries"</span>)</span>
<span id="cb21-154"><a href="#cb21-154"></a></span>
<span id="cb21-155"><a href="#cb21-155"></a><span class="co"># Function to append data to a Google Sheet</span></span>
<span id="cb21-156"><a href="#cb21-156"></a><span class="kw">def</span> append_data_to_sheet(spreadsheet_id, sheet_name, values):</span>
<span id="cb21-157"><a href="#cb21-157"></a>    <span class="cf">if</span> SEND_TO_GOOGLE_SHEETS:</span>
<span id="cb21-158"><a href="#cb21-158"></a>        service <span class="op">=</span> get_sheets_service()</span>
<span id="cb21-159"><a href="#cb21-159"></a>        last_empty_row <span class="op">=</span> find_last_empty_row(service, spreadsheet_id, sheet_name)</span>
<span id="cb21-160"><a href="#cb21-160"></a>        range_name <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>sheet_name<span class="sc">}</span><span class="ss">!A</span><span class="sc">{</span>last_empty_row<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb21-161"><a href="#cb21-161"></a>        body <span class="op">=</span> {</span>
<span id="cb21-162"><a href="#cb21-162"></a>            <span class="st">'values'</span>: values</span>
<span id="cb21-163"><a href="#cb21-163"></a>        }</span>
<span id="cb21-164"><a href="#cb21-164"></a>        result <span class="op">=</span> service.spreadsheets().values().append(</span>
<span id="cb21-165"><a href="#cb21-165"></a>            spreadsheetId<span class="op">=</span>spreadsheet_id, <span class="bu">range</span><span class="op">=</span>range_name,</span>
<span id="cb21-166"><a href="#cb21-166"></a>            valueInputOption<span class="op">=</span><span class="st">'RAW'</span>, body<span class="op">=</span>body).execute()</span>
<span id="cb21-167"><a href="#cb21-167"></a>        <span class="cf">return</span> result</span>
<span id="cb21-168"><a href="#cb21-168"></a></span>
<span id="cb21-169"><a href="#cb21-169"></a><span class="co"># Function to send data to the server</span></span>
<span id="cb21-170"><a href="#cb21-170"></a><span class="kw">def</span> send_data(data):</span>
<span id="cb21-171"><a href="#cb21-171"></a>    <span class="co">"""Send data to the server."""</span></span>
<span id="cb21-172"><a href="#cb21-172"></a>    <span class="cf">if</span> SEND_TO_VERCEL:</span>
<span id="cb21-173"><a href="#cb21-173"></a>        <span class="cf">try</span>:</span>
<span id="cb21-174"><a href="#cb21-174"></a>            <span class="co"># Include API key in the headers</span></span>
<span id="cb21-175"><a href="#cb21-175"></a>            headers <span class="op">=</span> {<span class="st">'x-api-key'</span>: VERCEL_API_KEY}</span>
<span id="cb21-176"><a href="#cb21-176"></a>            response <span class="op">=</span> requests.post(URL, json<span class="op">=</span>data, headers<span class="op">=</span>headers)</span>
<span id="cb21-177"><a href="#cb21-177"></a>            response.raise_for_status()</span>
<span id="cb21-178"><a href="#cb21-178"></a>            <span class="bu">print</span>(data)</span>
<span id="cb21-179"><a href="#cb21-179"></a>            <span class="bu">print</span>(headers)</span>
<span id="cb21-180"><a href="#cb21-180"></a>            <span class="bu">print</span>(<span class="ss">f"Data sent to server: </span><span class="sc">{</span>response<span class="sc">.</span>text<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-181"><a href="#cb21-181"></a>        <span class="cf">except</span> requests.exceptions.RequestException <span class="im">as</span> e:</span>
<span id="cb21-182"><a href="#cb21-182"></a>            <span class="bu">print</span>(<span class="ss">f"Failed to send data to server: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-183"><a href="#cb21-183"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb21-184"><a href="#cb21-184"></a>            <span class="bu">print</span>(<span class="ss">f"An unexpected error occurred: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-185"><a href="#cb21-185"></a><span class="co"># Function to send data to ThingSpeak</span></span>
<span id="cb21-186"><a href="#cb21-186"></a><span class="kw">def</span> send_data_to_thingspeak():</span>
<span id="cb21-187"><a href="#cb21-187"></a>    <span class="co">"""Send data to ThingSpeak."""</span></span>
<span id="cb21-188"><a href="#cb21-188"></a>    <span class="cf">if</span> SEND_TO_THINGSPEAK <span class="kw">and</span> thingspeak_buffer:</span>
<span id="cb21-189"><a href="#cb21-189"></a>        data <span class="op">=</span> thingspeak_buffer.pop(<span class="dv">0</span>)  <span class="co"># Get the first item in the buffer</span></span>
<span id="cb21-190"><a href="#cb21-190"></a>        payload <span class="op">=</span> {</span>
<span id="cb21-191"><a href="#cb21-191"></a>            <span class="st">'api_key'</span>: THINGSPEAK_API_KEY,</span>
<span id="cb21-192"><a href="#cb21-192"></a>            <span class="st">'field1'</span>: data[<span class="st">'temperature_C'</span>],</span>
<span id="cb21-193"><a href="#cb21-193"></a>            <span class="st">'field2'</span>: data[<span class="st">'temperature_F'</span>],</span>
<span id="cb21-194"><a href="#cb21-194"></a>            <span class="st">'field3'</span>: data[<span class="st">'humidityPercent'</span>],</span>
<span id="cb21-195"><a href="#cb21-195"></a>            <span class="st">'field4'</span>: data[<span class="st">'time'</span>],</span>
<span id="cb21-196"><a href="#cb21-196"></a>            <span class="st">'field5'</span>: data[<span class="st">'date'</span>]</span>
<span id="cb21-197"><a href="#cb21-197"></a>        }</span>
<span id="cb21-198"><a href="#cb21-198"></a>        <span class="cf">try</span>:</span>
<span id="cb21-199"><a href="#cb21-199"></a>            response <span class="op">=</span> requests.get(THINGSPEAK_BASE_URL, params<span class="op">=</span>payload)</span>
<span id="cb21-200"><a href="#cb21-200"></a>            <span class="bu">print</span>(<span class="st">'Data posted to ThingSpeak'</span>, response.text)</span>
<span id="cb21-201"><a href="#cb21-201"></a>        <span class="cf">except</span> requests.exceptions.RequestException <span class="im">as</span> e:</span>
<span id="cb21-202"><a href="#cb21-202"></a>            <span class="bu">print</span>(<span class="st">'Failed to send data to ThingSpeak:'</span>, e)</span>
<span id="cb21-203"><a href="#cb21-203"></a></span>
<span id="cb21-204"><a href="#cb21-204"></a><span class="co"># Function to save spreadsheet info to a file</span></span>
<span id="cb21-205"><a href="#cb21-205"></a><span class="kw">def</span> save_spreadsheet_info(spreadsheet_id, workbook_name, sheet_name):</span>
<span id="cb21-206"><a href="#cb21-206"></a>    info <span class="op">=</span> {</span>
<span id="cb21-207"><a href="#cb21-207"></a>        <span class="st">'spreadsheet_id'</span>: spreadsheet_id,</span>
<span id="cb21-208"><a href="#cb21-208"></a>        <span class="st">'workbook_name'</span>: workbook_name,</span>
<span id="cb21-209"><a href="#cb21-209"></a>        <span class="st">'sheet_name'</span>: sheet_name</span>
<span id="cb21-210"><a href="#cb21-210"></a>    }</span>
<span id="cb21-211"><a href="#cb21-211"></a>    <span class="cf">with</span> <span class="bu">open</span>(<span class="st">'spreadsheet_info.txt'</span>, <span class="st">'w'</span>) <span class="im">as</span> f:</span>
<span id="cb21-212"><a href="#cb21-212"></a>        json.dump(info, f)</span>
<span id="cb21-213"><a href="#cb21-213"></a></span>
<span id="cb21-214"><a href="#cb21-214"></a><span class="co"># Function to load spreadsheet info from a file</span></span>
<span id="cb21-215"><a href="#cb21-215"></a><span class="kw">def</span> load_spreadsheet_info():</span>
<span id="cb21-216"><a href="#cb21-216"></a>    <span class="cf">if</span> os.path.exists(<span class="st">'spreadsheet_info.txt'</span>):</span>
<span id="cb21-217"><a href="#cb21-217"></a>        <span class="cf">with</span> <span class="bu">open</span>(<span class="st">'spreadsheet_info.txt'</span>, <span class="st">'r'</span>) <span class="im">as</span> f:</span>
<span id="cb21-218"><a href="#cb21-218"></a>            info <span class="op">=</span> json.load(f)</span>
<span id="cb21-219"><a href="#cb21-219"></a>            <span class="cf">return</span> info[<span class="st">'spreadsheet_id'</span>], info[<span class="st">'workbook_name'</span>], info[<span class="st">'sheet_name'</span>]</span>
<span id="cb21-220"><a href="#cb21-220"></a>    <span class="cf">return</span> <span class="va">None</span>, <span class="va">None</span>, <span class="va">None</span></span>
<span id="cb21-221"><a href="#cb21-221"></a></span>
<span id="cb21-222"><a href="#cb21-222"></a><span class="kw">def</span> main():</span>
<span id="cb21-223"><a href="#cb21-223"></a>    <span class="co"># Load spreadsheet info from file</span></span>
<span id="cb21-224"><a href="#cb21-224"></a>    spreadsheet_id, workbook_name, sheet_name <span class="op">=</span> load_spreadsheet_info()</span>
<span id="cb21-225"><a href="#cb21-225"></a></span>
<span id="cb21-226"><a href="#cb21-226"></a>    <span class="cf">if</span> spreadsheet_id <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> workbook_name <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> sheet_name <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb21-227"><a href="#cb21-227"></a>        <span class="co"># Initialize new sheet if no info found</span></span>
<span id="cb21-228"><a href="#cb21-228"></a>        workbook_name <span class="op">=</span> <span class="st">'your-workbook-name'</span>  <span class="co"># Replace with your Google Sheet ID</span></span>
<span id="cb21-229"><a href="#cb21-229"></a>        spreadsheet_id <span class="op">=</span> <span class="st">'your-spreadsheet-id'</span>  <span class="co"># Replace with your Google Sheet ID</span></span>
<span id="cb21-230"><a href="#cb21-230"></a>        sheet_name <span class="op">=</span> <span class="st">'Sheet1'</span>  <span class="co"># Adjust the sheet name as needed</span></span>
<span id="cb21-231"><a href="#cb21-231"></a></span>
<span id="cb21-232"><a href="#cb21-232"></a>    max_cells <span class="op">=</span> <span class="dv">5000000</span></span>
<span id="cb21-233"><a href="#cb21-233"></a></span>
<span id="cb21-234"><a href="#cb21-234"></a>    <span class="co"># Initialize loop counter</span></span>
<span id="cb21-235"><a href="#cb21-235"></a>    i <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb21-236"><a href="#cb21-236"></a></span>
<span id="cb21-237"><a href="#cb21-237"></a>    <span class="co"># Get current date and time for the new sheet name if needed</span></span>
<span id="cb21-238"><a href="#cb21-238"></a>    current_time <span class="op">=</span> datetime.now().strftime(<span class="st">"%Y-%m-</span><span class="sc">%d</span><span class="st"> %H:%M:%S"</span>)</span>
<span id="cb21-239"><a href="#cb21-239"></a>    new_sheet_name <span class="op">=</span> <span class="ss">f"Pi-Sensor </span><span class="sc">{</span>current_time<span class="sc">}</span><span class="ss">"</span>  <span class="co"># New sheet name with date and time</span></span>
<span id="cb21-240"><a href="#cb21-240"></a>    </span>
<span id="cb21-241"><a href="#cb21-241"></a>    <span class="co"># Check sheet size and create new sheet if necessary</span></span>
<span id="cb21-242"><a href="#cb21-242"></a>    <span class="cf">if</span> SEND_TO_GOOGLE_SHEETS:</span>
<span id="cb21-243"><a href="#cb21-243"></a>        spreadsheet_id, total_cells <span class="op">=</span> check_sheet_size(spreadsheet_id, new_sheet_name)</span>
<span id="cb21-244"><a href="#cb21-244"></a>        <span class="bu">print</span>(<span class="ss">f"Total cells in the sheet: </span><span class="sc">{</span>total_cells<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-245"><a href="#cb21-245"></a>        </span>
<span id="cb21-246"><a href="#cb21-246"></a>        <span class="cf">if</span> total_cells <span class="op">&gt;=</span> max_cells:</span>
<span id="cb21-247"><a href="#cb21-247"></a>            <span class="bu">print</span>(<span class="st">"The sheet has reached the maximum cell limit. Creating a new sheet."</span>)</span>
<span id="cb21-248"><a href="#cb21-248"></a>            spreadsheet_id <span class="op">=</span> create_new_sheet(new_sheet_name)</span>
<span id="cb21-249"><a href="#cb21-249"></a>            sheet_name <span class="op">=</span> <span class="st">'Sheet1'</span>  <span class="co"># Reset to default sheet name for new spreadsheet</span></span>
<span id="cb21-250"><a href="#cb21-250"></a>        <span class="cf">else</span>:</span>
<span id="cb21-251"><a href="#cb21-251"></a>            <span class="bu">print</span>(<span class="st">"The sheet has not reached the maximum cell limit."</span>)</span>
<span id="cb21-252"><a href="#cb21-252"></a></span>
<span id="cb21-253"><a href="#cb21-253"></a>    <span class="co"># Time tracking for ThingSpeak</span></span>
<span id="cb21-254"><a href="#cb21-254"></a>    last_thingspeak_update <span class="op">=</span> time_module.time()</span>
<span id="cb21-255"><a href="#cb21-255"></a>    </span>
<span id="cb21-256"><a href="#cb21-256"></a>    <span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb21-257"><a href="#cb21-257"></a>        <span class="co"># Get the current time at the start of the loop</span></span>
<span id="cb21-258"><a href="#cb21-258"></a>        start_time <span class="op">=</span> time_module.time()</span>
<span id="cb21-259"><a href="#cb21-259"></a>        </span>
<span id="cb21-260"><a href="#cb21-260"></a>        <span class="co"># Read humidity and temperature from DHT sensor</span></span>
<span id="cb21-261"><a href="#cb21-261"></a>        humidityPercent, temperature_C <span class="op">=</span> Adafruit_DHT.read_retry(SENSOR, PIN)</span>
<span id="cb21-262"><a href="#cb21-262"></a>        </span>
<span id="cb21-263"><a href="#cb21-263"></a>        <span class="cf">if</span> humidityPercent <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> temperature_C <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb21-264"><a href="#cb21-264"></a>            <span class="co"># Prepare the data payload</span></span>
<span id="cb21-265"><a href="#cb21-265"></a>            temperature_F <span class="op">=</span> temperature_C <span class="op">*</span> <span class="fl">9.0</span> <span class="op">/</span> <span class="fl">5.0</span> <span class="op">+</span> <span class="dv">32</span></span>
<span id="cb21-266"><a href="#cb21-266"></a>            </span>
<span id="cb21-267"><a href="#cb21-267"></a>            now <span class="op">=</span> datetime.now()</span>
<span id="cb21-268"><a href="#cb21-268"></a>            date <span class="op">=</span> now.strftime(<span class="st">"%m-</span><span class="sc">%d</span><span class="st">-%Y"</span>)</span>
<span id="cb21-269"><a href="#cb21-269"></a>            timeNow <span class="op">=</span> now.strftime(<span class="st">"%H:%M:%S"</span>)</span>
<span id="cb21-270"><a href="#cb21-270"></a>            </span>
<span id="cb21-271"><a href="#cb21-271"></a>            data <span class="op">=</span> {</span>
<span id="cb21-272"><a href="#cb21-272"></a>                <span class="st">'date'</span>: date,</span>
<span id="cb21-273"><a href="#cb21-273"></a>                <span class="st">'time'</span>: timeNow,</span>
<span id="cb21-274"><a href="#cb21-274"></a>                <span class="st">'humidityPercent'</span>: humidityPercent,</span>
<span id="cb21-275"><a href="#cb21-275"></a>                <span class="st">'temperatureFahrenheit'</span>: temperature_F,</span>
<span id="cb21-276"><a href="#cb21-276"></a>                <span class="st">'temperatureCelsius'</span>: temperature_C</span>
<span id="cb21-277"><a href="#cb21-277"></a>            }</span>
<span id="cb21-278"><a href="#cb21-278"></a>            </span>
<span id="cb21-279"><a href="#cb21-279"></a>            <span class="co"># Log data to buffer</span></span>
<span id="cb21-280"><a href="#cb21-280"></a>            data_buffer.append(data)</span>
<span id="cb21-281"><a href="#cb21-281"></a>            <span class="cf">if</span> i <span class="op">%</span> <span class="dv">60</span> <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb21-282"><a href="#cb21-282"></a>                <span class="bu">print</span>(<span class="ss">f"Logged data: </span><span class="sc">{</span>data<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-283"><a href="#cb21-283"></a>            </span>
<span id="cb21-284"><a href="#cb21-284"></a>            <span class="co"># Append data to Google Sheet</span></span>
<span id="cb21-285"><a href="#cb21-285"></a>            append_data_to_sheet(spreadsheet_id, sheet_name, [[date, timeNow, humidityPercent, temperature_F, temperature_C]])</span>
<span id="cb21-286"><a href="#cb21-286"></a>            </span>
<span id="cb21-287"><a href="#cb21-287"></a>            <span class="co"># Add data to ThingSpeak buffer</span></span>
<span id="cb21-288"><a href="#cb21-288"></a>            thingspeak_buffer.append({</span>
<span id="cb21-289"><a href="#cb21-289"></a>                <span class="st">'temperature_C'</span>: temperature_C,</span>
<span id="cb21-290"><a href="#cb21-290"></a>                <span class="st">'temperature_F'</span>: temperature_F,</span>
<span id="cb21-291"><a href="#cb21-291"></a>                <span class="st">'humidityPercent'</span>: humidityPercent,</span>
<span id="cb21-292"><a href="#cb21-292"></a>                <span class="st">'time'</span>: timeNow,</span>
<span id="cb21-293"><a href="#cb21-293"></a>                <span class="st">'date'</span>: date</span>
<span id="cb21-294"><a href="#cb21-294"></a>            })</span>
<span id="cb21-295"><a href="#cb21-295"></a>            </span>
<span id="cb21-296"><a href="#cb21-296"></a>            <span class="co"># Check if 300 readings have been logged</span></span>
<span id="cb21-297"><a href="#cb21-297"></a>            <span class="cf">if</span> <span class="bu">len</span>(data_buffer) <span class="op">&gt;=</span> <span class="dv">300</span>:</span>
<span id="cb21-298"><a href="#cb21-298"></a>                send_data(data_buffer)</span>
<span id="cb21-299"><a href="#cb21-299"></a>                </span>
<span id="cb21-300"><a href="#cb21-300"></a>                <span class="co"># Clear the buffer after sending</span></span>
<span id="cb21-301"><a href="#cb21-301"></a>                data_buffer.clear()</span>
<span id="cb21-302"><a href="#cb21-302"></a>                i <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb21-303"><a href="#cb21-303"></a></span>
<span id="cb21-304"><a href="#cb21-304"></a>            <span class="co"># Check if it's time to send data to ThingSpeak</span></span>
<span id="cb21-305"><a href="#cb21-305"></a>            <span class="cf">if</span> time_module.time() <span class="op">-</span> last_thingspeak_update <span class="op">&gt;=</span> <span class="dv">15</span>:</span>
<span id="cb21-306"><a href="#cb21-306"></a>                send_data_to_thingspeak()</span>
<span id="cb21-307"><a href="#cb21-307"></a>                last_thingspeak_update <span class="op">=</span> time_module.time()</span>
<span id="cb21-308"><a href="#cb21-308"></a>        <span class="cf">else</span>:</span>
<span id="cb21-309"><a href="#cb21-309"></a>            <span class="co"># Handle cases where sensor fails to read</span></span>
<span id="cb21-310"><a href="#cb21-310"></a>            <span class="bu">print</span>(<span class="st">"Failed to retrieve data from sensor"</span>)</span>
<span id="cb21-311"><a href="#cb21-311"></a>        </span>
<span id="cb21-312"><a href="#cb21-312"></a>        <span class="co"># Wait until the LOOP_TIME has elapsed</span></span>
<span id="cb21-313"><a href="#cb21-313"></a>        <span class="cf">while</span> time_module.time() <span class="op">-</span> start_time <span class="op">&lt;</span> LOOP_TIME:</span>
<span id="cb21-314"><a href="#cb21-314"></a>            time_module.sleep(<span class="fl">0.01</span>)  <span class="co"># Sleep a short time to avoid busy-waiting</span></span>
<span id="cb21-315"><a href="#cb21-315"></a></span>
<span id="cb21-316"><a href="#cb21-316"></a>        i <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb21-317"><a href="#cb21-317"></a></span>
<span id="cb21-318"><a href="#cb21-318"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">'__main__'</span>:</span>
<span id="cb21-319"><a href="#cb21-319"></a>    main()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<details>
<summary>
Code Summary
</summary>
<p>This Python script reads environmental data from a DHT11 sensor, processes the data, and sends it to three different endpoints: Vercel, Google Sheets, and ThingSpeak. The script includes functionalities for authentication, data reading, data logging, and sending data to different services. Here is a summary of the main components and functionality:</p>

<section id="key-components-2" class="level3">
<h3 class="anchored" data-anchor-id="key-components-2"><strong>Key Components:</strong></h3>
<ol type="1">
<li><p><strong>Imports and Setup</strong>:</p>
<ul>
<li><p>Imports necessary libraries for reading sensor data (<strong><code>Adafruit_DHT</code></strong>), making HTTP requests (<strong><code>requests</code></strong>), handling time (<strong><code>time</code></strong>, <strong><code>datetime</code></strong>), and interacting with Google APIs (<strong><code>google.auth</code></strong>, <strong><code>google.oauth2</code></strong>, <strong><code>googleapiclient</code></strong>).</p></li>
<li><p>Defines control flags to enable/disable sending data to Vercel, Google Sheets, and ThingSpeak.</p></li>
</ul></li>
<li><p><strong>API Key and Endpoint Configuration</strong>:</p>
<ul>
<li><p><strong><code>THINGSPEAK_API_KEY</code></strong> and <strong><code>THINGSPEAK_BASE_URL</code></strong> for ThingSpeak.</p></li>
<li><p><strong><code>VERCEL_API_KEY</code></strong> and <strong><code>URL</code></strong> for Vercel.</p></li>
<li><p>Google Sheets and Drive API scopes are defined.</p></li>
</ul></li>
<li><p><strong>Sensor Setup</strong>:</p>
<ul>
<li>Defines the DHT11 sensor and the GPIO pin to which it is connected.</li>
</ul></li>
<li><p><strong>Data Buffers</strong>:</p>
<ul>
<li>Initializes buffers for storing data before sending it to Vercel and ThingSpeak.</li>
</ul></li>
<li><p><strong>Google Sheets Authentication</strong>:</p>
<ul>
<li><p><strong><code>get_sheets_service()</code></strong>: Authenticates and returns the Google Sheets service object.</p></li>
<li><p><strong><code>get_drive_service()</code></strong>: Authenticates and returns the Google Drive service object.</p></li>
</ul></li>
<li><p><strong>Google Sheets Management</strong>:</p>
<ul>
<li><p><strong><code>set_sheet_public(spreadsheet_id)</code></strong>: Sets the permissions of a Google Sheet to public.</p></li>
<li><p><strong><code>create_new_sheet(sheet_name)</code></strong>: Creates a new Google Sheet with the specified name.</p></li>
<li><p><strong><code>check_sheet_size(spreadsheet_id, new_sheet_name)</code></strong>: Checks the size of a Google Sheet and creates a new one if necessary.</p></li>
<li><p><strong><code>find_last_empty_row(service, spreadsheet_id, sheet_name)</code></strong>: Finds the last empty row in a Google Sheet.</p></li>
<li><p><strong><code>append_data_to_sheet(spreadsheet_id, sheet_name, values)</code></strong>: Appends data to a Google Sheet.</p></li>
<li><p><strong><code>save_spreadsheet_info(spreadsheet_id, workbook_name, sheet_name)</code></strong>: Saves Google Sheet info to a file.</p></li>
<li><p><strong><code>load_spreadsheet_info()</code></strong>: Loads Google Sheet info from a file.</p></li>
</ul></li>
<li><p><strong>Sending Data</strong>:</p>
<ul>
<li><p><strong><code>send_data(data)</code></strong>: Sends data to the Vercel endpoint.</p></li>
<li><p><strong><code>send_data_to_thingspeak()</code></strong>: Sends data to the ThingSpeak channel.</p></li>
</ul></li>
<li><p><strong>Main Function</strong>:</p>
<ul>
<li><p>Loads spreadsheet info or initializes a new sheet.</p></li>
<li><p>Checks the size of the Google Sheet and creates a new one if it has reached its cell limit.</p></li>
<li><p>Enters an infinite loop to read data from the DHT11 sensor every second.</p></li>
<li><p>Prepares and logs data to buffers.</p></li>
<li><p>Appends data to Google Sheets.</p></li>
<li><p>Sends buffered data to Vercel every 300 readings.</p></li>
<li><p>Sends data to ThingSpeak every 15 seconds.</p></li>
<li><p>Includes error handling for sensor read failures and HTTP request failures.</p></li>
</ul></li>
</ol>
</section>
<section id="example-output-1" class="level3">
<h3 class="anchored" data-anchor-id="example-output-1"><strong>Example Output:</strong></h3>
<ul>
<li>The script provides feedback through print statements, indicating the creation of new sheets, reading data, writing data, appending data, and handling errors.</li>
</ul>
</section>
<section id="notes-1" class="level3">
<h3 class="anchored" data-anchor-id="notes-1"><strong>Notes:</strong></h3>
<ul>
<li><p>Replace <strong><code>YOUR_API_KEY</code></strong> with your actual ThingSpeak API key.</p></li>
<li><p>Replace <strong><code>YOURURL</code></strong> with your actual Vercel endpoint URL.</p></li>
<li><p>Replace <strong><code>your-workbook-name</code></strong> and <strong><code>your-spreadsheet-id</code></strong> with your actual Google Sheet name and ID.</p></li>
<li><p>Ensure you have <strong><code>credentials.json</code></strong> for Google API OAuth 2.0 and <strong><code>token.json</code></strong> for storing the user’s access and refresh tokens.</p></li>
</ul>
<p>This script facilitates continuous monitoring and logging of environmental data from a DHT11 sensor, with automated data management and reporting using Vercel, Google Sheets, and ThingSpeak.</p>
</section></details>
<p>That’s 3 services down, with one more crack at MongoDB. The tentative plan is to push everything from the Python script then use some form of authentication to eventually be able to grab the data directly from MongoDB but use the Vercel site to “host” the csv/data. A rough sketch of the setup is below:</p>
<p><a href="Pi Sensor Flow Complete.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5"><img src="Pi Sensor Flow Complete.png" class="img-fluid"></a></p>
<p>This was fairly straightforward and with one function and a couple of lines of Python I was all set up. Note that I changed the timings, notably Vercel. As the server spins up and stays active for 5 minutes after it receives data. The limit for Compute time is 60 hrs/month, so at the basic vCPU of 0.6 I will be at 0.6*(5minutes/60minutes)*24hour*30days=36 hours if I update it hourly. This is just safe enough for me to do and as a bonus its not like this is an AWS instance with my Credit Card linked.</p>
<p>Timings:</p>
<table class="table">
<colgroup>
<col style="width: 26%">
<col style="width: 36%">
<col style="width: 36%">
</colgroup>
<tbody>
<tr class="odd">
<td>Database</td>
<td>Update Interval</td>
<td>Capacity</td>
</tr>
<tr class="even">
<td>Google Sheets</td>
<td>1 second(with network delay more like 2)</td>
<td>2 million entries(10 million cells)</td>
</tr>
<tr class="odd">
<td>ThingSpeak</td>
<td>15 seconds(bulk update works around this)</td>
<td>2 million entries(this is suspicious…)</td>
</tr>
<tr class="even">
<td>MongoDB</td>
<td>60 seconds</td>
<td>512mb</td>
</tr>
<tr class="odd">
<td>Vercel PostgreSQL</td>
<td>3600 seconds</td>
<td>256mb</td>
</tr>
</tbody>
</table>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb22"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1"></a><span class="im">import</span> os</span>
<span id="cb22-2"><a href="#cb22-2"></a><span class="im">import</span> time <span class="im">as</span> time_module</span>
<span id="cb22-3"><a href="#cb22-3"></a><span class="im">import</span> requests</span>
<span id="cb22-4"><a href="#cb22-4"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb22-5"><a href="#cb22-5"></a><span class="im">import</span> random</span>
<span id="cb22-6"><a href="#cb22-6"></a><span class="im">import</span> json</span>
<span id="cb22-7"><a href="#cb22-7"></a><span class="im">import</span> subprocess</span>
<span id="cb22-8"><a href="#cb22-8"></a><span class="im">import</span> Adafruit_DHT</span>
<span id="cb22-9"><a href="#cb22-9"></a><span class="im">from</span> pymongo <span class="im">import</span> MongoClient</span>
<span id="cb22-10"><a href="#cb22-10"></a><span class="im">from</span> google.auth.transport.requests <span class="im">import</span> Request</span>
<span id="cb22-11"><a href="#cb22-11"></a><span class="im">from</span> google.oauth2.credentials <span class="im">import</span> Credentials</span>
<span id="cb22-12"><a href="#cb22-12"></a><span class="im">from</span> google_auth_oauthlib.flow <span class="im">import</span> InstalledAppFlow</span>
<span id="cb22-13"><a href="#cb22-13"></a><span class="im">from</span> googleapiclient.discovery <span class="im">import</span> build</span>
<span id="cb22-14"><a href="#cb22-14"></a><span class="im">from</span> googleapiclient.errors <span class="im">import</span> HttpError</span>
<span id="cb22-15"><a href="#cb22-15"></a></span>
<span id="cb22-16"><a href="#cb22-16"></a><span class="co"># Control flags</span></span>
<span id="cb22-17"><a href="#cb22-17"></a>SEND_TO_VERCEL <span class="op">=</span> <span class="va">True</span></span>
<span id="cb22-18"><a href="#cb22-18"></a>SEND_TO_GOOGLE_SHEETS <span class="op">=</span> <span class="va">True</span></span>
<span id="cb22-19"><a href="#cb22-19"></a>SEND_TO_THINGSPEAK <span class="op">=</span> <span class="va">True</span></span>
<span id="cb22-20"><a href="#cb22-20"></a>SEND_TO_MONGODB <span class="op">=</span> <span class="va">True</span></span>
<span id="cb22-21"><a href="#cb22-21"></a></span>
<span id="cb22-22"><a href="#cb22-22"></a><span class="co"># ThingSpeak API settings</span></span>
<span id="cb22-23"><a href="#cb22-23"></a>THINGSPEAK_API_KEY <span class="op">=</span> <span class="st">'Your-API-Key'</span><span class="co"># Replace with your ThingSpeak API key</span></span>
<span id="cb22-24"><a href="#cb22-24"></a></span>
<span id="cb22-25"><a href="#cb22-25"></a>THINGSPEAK_BASE_URL <span class="op">=</span> <span class="st">'https://api.thingspeak.com/update'</span></span>
<span id="cb22-26"><a href="#cb22-26"></a>THINGSPEAK_CHANNEL_ID <span class="op">=</span> <span class="dv">000000</span> <span class="st">'Replace with your channel ID</span></span>
<span id="cb22-27"><a href="#cb22-27"></a><span class="er">THINGSPEAK_BULK_UPDATE_URL = 'https://api.thingspeak.com/channels/'+str(THINGSPEAK_CHANNEL_ID)+'/bulk_update.json'</span></span>
<span id="cb22-28"><a href="#cb22-28"></a><span class="bu">print</span>(THINGSPEAK_BULK_UPDATE_URL)</span>
<span id="cb22-29"><a href="#cb22-29"></a></span>
<span id="cb22-30"><a href="#cb22-30"></a>VERCEL_API_KEY <span class="op">=</span> <span class="st">'Your-Vercel-ID'</span></span>
<span id="cb22-31"><a href="#cb22-31"></a></span>
<span id="cb22-32"><a href="#cb22-32"></a>MONGODB_URI <span class="op">=</span> <span class="st">'mongodb+srv://&lt;user&gt;:&lt;password&gt;@&lt;cluster-number&gt;.&lt;specialURL&gt;.mongodb.net'</span></span>
<span id="cb22-33"><a href="#cb22-33"></a>MONGODB_DB_NAME <span class="op">=</span> <span class="st">'Raspberry_Pi'</span> <span class="co">#Your DB Name</span></span>
<span id="cb22-34"><a href="#cb22-34"></a>MONGODB_COLLECTION_NAME <span class="op">=</span> <span class="st">'Readings'</span><span class="co">#Your Collection Name</span></span>
<span id="cb22-35"><a href="#cb22-35"></a><span class="co"># Sensor setup</span></span>
<span id="cb22-36"><a href="#cb22-36"></a>SENSOR <span class="op">=</span> Adafruit_DHT.DHT11  <span class="co"># Using DHT11 sensor</span></span>
<span id="cb22-37"><a href="#cb22-37"></a>PIN <span class="op">=</span> <span class="dv">4</span>  <span class="co"># Change this to the GPIO pin number that the sensor is connected to</span></span>
<span id="cb22-38"><a href="#cb22-38"></a></span>
<span id="cb22-39"><a href="#cb22-39"></a><span class="co"># Vercel endpoint URL</span></span>
<span id="cb22-40"><a href="#cb22-40"></a>URL <span class="op">=</span> <span class="st">'https://your-vercel-url.vercel.app/api/sensor'</span></span>
<span id="cb22-41"><a href="#cb22-41"></a></span>
<span id="cb22-42"><a href="#cb22-42"></a><span class="co"># Buffer to store data</span></span>
<span id="cb22-43"><a href="#cb22-43"></a>data_buffer_vercel <span class="op">=</span> []</span>
<span id="cb22-44"><a href="#cb22-44"></a>data_buffer_mongodb <span class="op">=</span> []</span>
<span id="cb22-45"><a href="#cb22-45"></a>thingspeak_buffer <span class="op">=</span> []  <span class="co"># Buffer for ThingSpeak data</span></span>
<span id="cb22-46"><a href="#cb22-46"></a></span>
<span id="cb22-47"><a href="#cb22-47"></a><span class="co"># Define loop time in seconds</span></span>
<span id="cb22-48"><a href="#cb22-48"></a>LOOP_TIME <span class="op">=</span> <span class="dv">1</span>  <span class="co"># You can change this to the desired loop time in seconds</span></span>
<span id="cb22-49"><a href="#cb22-49"></a></span>
<span id="cb22-50"><a href="#cb22-50"></a><span class="co"># Define the scopes required for the Google Sheets and Drive APIs</span></span>
<span id="cb22-51"><a href="#cb22-51"></a>SCOPES <span class="op">=</span> [</span>
<span id="cb22-52"><a href="#cb22-52"></a>    <span class="st">'https://www.googleapis.com/auth/spreadsheets'</span>,</span>
<span id="cb22-53"><a href="#cb22-53"></a>    <span class="st">'https://www.googleapis.com/auth/drive.file'</span></span>
<span id="cb22-54"><a href="#cb22-54"></a>]</span>
<span id="cb22-55"><a href="#cb22-55"></a></span>
<span id="cb22-56"><a href="#cb22-56"></a><span class="co"># Global variable to hold credentials</span></span>
<span id="cb22-57"><a href="#cb22-57"></a>creds <span class="op">=</span> <span class="va">None</span></span>
<span id="cb22-58"><a href="#cb22-58"></a></span>
<span id="cb22-59"><a href="#cb22-59"></a><span class="co"># Function to get authenticated Sheets service</span></span>
<span id="cb22-60"><a href="#cb22-60"></a><span class="kw">def</span> get_sheets_service():</span>
<span id="cb22-61"><a href="#cb22-61"></a>    <span class="kw">global</span> creds</span>
<span id="cb22-62"><a href="#cb22-62"></a>    <span class="cf">if</span> os.path.exists(<span class="st">'token.json'</span>):</span>
<span id="cb22-63"><a href="#cb22-63"></a>        creds <span class="op">=</span> Credentials.from_authorized_user_file(<span class="st">'token.json'</span>, SCOPES)</span>
<span id="cb22-64"><a href="#cb22-64"></a>    <span class="cf">if</span> <span class="kw">not</span> creds <span class="kw">or</span> <span class="kw">not</span> creds.valid:</span>
<span id="cb22-65"><a href="#cb22-65"></a>        <span class="cf">if</span> creds <span class="kw">and</span> creds.expired <span class="kw">and</span> creds.refresh_token:</span>
<span id="cb22-66"><a href="#cb22-66"></a>            creds.refresh(Request())</span>
<span id="cb22-67"><a href="#cb22-67"></a>        <span class="cf">else</span>:</span>
<span id="cb22-68"><a href="#cb22-68"></a>            flow <span class="op">=</span> InstalledAppFlow.from_client_secrets_file(<span class="st">'credentials.json'</span>, SCOPES)</span>
<span id="cb22-69"><a href="#cb22-69"></a>            creds <span class="op">=</span> flow.run_local_server(port<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb22-70"><a href="#cb22-70"></a>        <span class="cf">with</span> <span class="bu">open</span>(<span class="st">'token.json'</span>, <span class="st">'w'</span>) <span class="im">as</span> token:</span>
<span id="cb22-71"><a href="#cb22-71"></a>            token.write(creds.to_json())</span>
<span id="cb22-72"><a href="#cb22-72"></a>    <span class="cf">return</span> build(<span class="st">'sheets'</span>, <span class="st">'v4'</span>, credentials<span class="op">=</span>creds)</span>
<span id="cb22-73"><a href="#cb22-73"></a></span>
<span id="cb22-74"><a href="#cb22-74"></a><span class="co"># Function to get authenticated Drive service</span></span>
<span id="cb22-75"><a href="#cb22-75"></a><span class="kw">def</span> get_drive_service():</span>
<span id="cb22-76"><a href="#cb22-76"></a>    <span class="kw">global</span> creds</span>
<span id="cb22-77"><a href="#cb22-77"></a>    <span class="cf">if</span> creds <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb22-78"><a href="#cb22-78"></a>        get_sheets_service()  <span class="co"># This will initialize creds</span></span>
<span id="cb22-79"><a href="#cb22-79"></a>    <span class="cf">return</span> build(<span class="st">'drive'</span>, <span class="st">'v3'</span>, credentials<span class="op">=</span>creds)</span>
<span id="cb22-80"><a href="#cb22-80"></a></span>
<span id="cb22-81"><a href="#cb22-81"></a><span class="co"># Function to set a Google Sheet's permissions to public</span></span>
<span id="cb22-82"><a href="#cb22-82"></a><span class="kw">def</span> set_sheet_public(spreadsheet_id):</span>
<span id="cb22-83"><a href="#cb22-83"></a>    drive_service <span class="op">=</span> get_drive_service()</span>
<span id="cb22-84"><a href="#cb22-84"></a>    permission <span class="op">=</span> {</span>
<span id="cb22-85"><a href="#cb22-85"></a>        <span class="st">'type'</span>: <span class="st">'anyone'</span>,</span>
<span id="cb22-86"><a href="#cb22-86"></a>        <span class="st">'role'</span>: <span class="st">'reader'</span></span>
<span id="cb22-87"><a href="#cb22-87"></a>    }</span>
<span id="cb22-88"><a href="#cb22-88"></a>    <span class="cf">try</span>:</span>
<span id="cb22-89"><a href="#cb22-89"></a>        drive_service.permissions().create(fileId<span class="op">=</span>spreadsheet_id, body<span class="op">=</span>permission).execute()</span>
<span id="cb22-90"><a href="#cb22-90"></a>        <span class="bu">print</span>(<span class="ss">f"Set spreadsheet with ID </span><span class="sc">{</span>spreadsheet_id<span class="sc">}</span><span class="ss"> to public"</span>)</span>
<span id="cb22-91"><a href="#cb22-91"></a>    <span class="cf">except</span> HttpError <span class="im">as</span> error:</span>
<span id="cb22-92"><a href="#cb22-92"></a>        <span class="bu">print</span>(<span class="ss">f"An error occurred: </span><span class="sc">{</span>error<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb22-93"><a href="#cb22-93"></a></span>
<span id="cb22-94"><a href="#cb22-94"></a><span class="co"># Function to create a new Google Sheet with a given name</span></span>
<span id="cb22-95"><a href="#cb22-95"></a><span class="kw">def</span> create_new_sheet(sheet_name):</span>
<span id="cb22-96"><a href="#cb22-96"></a>    service <span class="op">=</span> get_sheets_service()</span>
<span id="cb22-97"><a href="#cb22-97"></a>    spreadsheet <span class="op">=</span> {</span>
<span id="cb22-98"><a href="#cb22-98"></a>        <span class="st">'properties'</span>: {</span>
<span id="cb22-99"><a href="#cb22-99"></a>            <span class="st">'title'</span>: sheet_name</span>
<span id="cb22-100"><a href="#cb22-100"></a>        }</span>
<span id="cb22-101"><a href="#cb22-101"></a>    }</span>
<span id="cb22-102"><a href="#cb22-102"></a>    spreadsheet <span class="op">=</span> service.spreadsheets().create(body<span class="op">=</span>spreadsheet, fields<span class="op">=</span><span class="st">'spreadsheetId'</span>).execute()</span>
<span id="cb22-103"><a href="#cb22-103"></a>    spreadsheet_id <span class="op">=</span> spreadsheet.get(<span class="st">'spreadsheetId'</span>)</span>
<span id="cb22-104"><a href="#cb22-104"></a>    <span class="bu">print</span>(<span class="ss">f"Created new spreadsheet with ID: </span><span class="sc">{</span>spreadsheet_id<span class="sc">}</span><span class="ss">, Name: </span><span class="sc">{</span>sheet_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb22-105"><a href="#cb22-105"></a></span>
<span id="cb22-106"><a href="#cb22-106"></a>    <span class="co"># Set the new sheet to be publicly viewable</span></span>
<span id="cb22-107"><a href="#cb22-107"></a>    set_sheet_public(spreadsheet_id)</span>
<span id="cb22-108"><a href="#cb22-108"></a></span>
<span id="cb22-109"><a href="#cb22-109"></a>    <span class="co"># Save the new spreadsheet info</span></span>
<span id="cb22-110"><a href="#cb22-110"></a>    save_spreadsheet_info(spreadsheet_id, sheet_name, <span class="st">"Sheet1"</span>)</span>
<span id="cb22-111"><a href="#cb22-111"></a></span>
<span id="cb22-112"><a href="#cb22-112"></a>    <span class="cf">return</span> spreadsheet_id</span>
<span id="cb22-113"><a href="#cb22-113"></a></span>
<span id="cb22-114"><a href="#cb22-114"></a><span class="co"># Function to check the number of cells in the Google Sheet and create a new one if it doesn't exist</span></span>
<span id="cb22-115"><a href="#cb22-115"></a><span class="kw">def</span> check_sheet_size(spreadsheet_id, new_sheet_name):</span>
<span id="cb22-116"><a href="#cb22-116"></a>    service <span class="op">=</span> get_sheets_service()</span>
<span id="cb22-117"><a href="#cb22-117"></a>    <span class="cf">try</span>:</span>
<span id="cb22-118"><a href="#cb22-118"></a>        sheet <span class="op">=</span> service.spreadsheets().get(spreadsheetId<span class="op">=</span>spreadsheet_id).execute()</span>
<span id="cb22-119"><a href="#cb22-119"></a>        sheets <span class="op">=</span> sheet.get(<span class="st">'sheets'</span>, [])</span>
<span id="cb22-120"><a href="#cb22-120"></a>    <span class="cf">except</span> HttpError <span class="im">as</span> e:</span>
<span id="cb22-121"><a href="#cb22-121"></a>        <span class="bu">print</span>(<span class="ss">f"HttpError encountered: Status code: </span><span class="sc">{</span>e<span class="sc">.</span>resp<span class="sc">.</span>status<span class="sc">}</span><span class="ss">, Reason: </span><span class="sc">{</span>e<span class="sc">.</span>error_details<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb22-122"><a href="#cb22-122"></a>        <span class="cf">if</span> e.resp.status <span class="op">==</span> <span class="dv">404</span>:</span>
<span id="cb22-123"><a href="#cb22-123"></a>            <span class="bu">print</span>(<span class="ss">f"Spreadsheet with ID '</span><span class="sc">{</span>spreadsheet_id<span class="sc">}</span><span class="ss">' not found. Creating a new sheet."</span>)</span>
<span id="cb22-124"><a href="#cb22-124"></a>            <span class="cf">return</span> create_new_sheet(new_sheet_name), <span class="dv">0</span></span>
<span id="cb22-125"><a href="#cb22-125"></a>        <span class="cf">else</span>:</span>
<span id="cb22-126"><a href="#cb22-126"></a>            <span class="cf">raise</span></span>
<span id="cb22-127"><a href="#cb22-127"></a></span>
<span id="cb22-128"><a href="#cb22-128"></a>    total_cells <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb22-129"><a href="#cb22-129"></a>    <span class="cf">for</span> sheet <span class="kw">in</span> sheets:</span>
<span id="cb22-130"><a href="#cb22-130"></a>        properties <span class="op">=</span> sheet.get(<span class="st">'properties'</span>, {})</span>
<span id="cb22-131"><a href="#cb22-131"></a>        grid_properties <span class="op">=</span> properties.get(<span class="st">'gridProperties'</span>, {})</span>
<span id="cb22-132"><a href="#cb22-132"></a>        rows <span class="op">=</span> grid_properties.get(<span class="st">'rowCount'</span>, <span class="dv">0</span>)</span>
<span id="cb22-133"><a href="#cb22-133"></a>        cols <span class="op">=</span> grid_properties.get(<span class="st">'columnCount'</span>, <span class="dv">0</span>)</span>
<span id="cb22-134"><a href="#cb22-134"></a>        total_cells <span class="op">+=</span> rows <span class="op">*</span> cols</span>
<span id="cb22-135"><a href="#cb22-135"></a></span>
<span id="cb22-136"><a href="#cb22-136"></a>    <span class="cf">return</span> spreadsheet_id, total_cells</span>
<span id="cb22-137"><a href="#cb22-137"></a></span>
<span id="cb22-138"><a href="#cb22-138"></a><span class="co"># Function to find the last empty row in the Google Sheet</span></span>
<span id="cb22-139"><a href="#cb22-139"></a><span class="kw">def</span> find_last_empty_row(service, spreadsheet_id, sheet_name,i):</span>
<span id="cb22-140"><a href="#cb22-140"></a>    max_retries <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb22-141"><a href="#cb22-141"></a>    retry_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb22-142"><a href="#cb22-142"></a>    backoff_factor <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb22-143"><a href="#cb22-143"></a></span>
<span id="cb22-144"><a href="#cb22-144"></a>    range_name <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>sheet_name<span class="sc">}</span><span class="ss">!A:A"</span></span>
<span id="cb22-145"><a href="#cb22-145"></a></span>
<span id="cb22-146"><a href="#cb22-146"></a>    <span class="cf">while</span> retry_count <span class="op">&lt;</span> max_retries:</span>
<span id="cb22-147"><a href="#cb22-147"></a>        <span class="cf">try</span>:</span>
<span id="cb22-148"><a href="#cb22-148"></a>            result <span class="op">=</span> service.spreadsheets().values().get(</span>
<span id="cb22-149"><a href="#cb22-149"></a>                spreadsheetId<span class="op">=</span>spreadsheet_id,</span>
<span id="cb22-150"><a href="#cb22-150"></a>                <span class="bu">range</span><span class="op">=</span>range_name</span>
<span id="cb22-151"><a href="#cb22-151"></a>            ).execute()</span>
<span id="cb22-152"><a href="#cb22-152"></a></span>
<span id="cb22-153"><a href="#cb22-153"></a>            values <span class="op">=</span> result.get(<span class="st">'values'</span>, [])</span>
<span id="cb22-154"><a href="#cb22-154"></a>            <span class="cf">if</span> i<span class="op">%</span><span class="dv">15</span><span class="op">==</span><span class="dv">0</span>:</span>
<span id="cb22-155"><a href="#cb22-155"></a>                <span class="bu">print</span>(<span class="ss">f"Debug Google - Number of rows in column A: </span><span class="sc">{</span><span class="bu">len</span>(values)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb22-156"><a href="#cb22-156"></a>            <span class="cf">return</span> <span class="bu">len</span>(values) <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb22-157"><a href="#cb22-157"></a>        <span class="cf">except</span> HttpError <span class="im">as</span> e:</span>
<span id="cb22-158"><a href="#cb22-158"></a>            <span class="cf">if</span> e.resp.status <span class="kw">in</span> [<span class="dv">500</span>, <span class="dv">503</span>]:</span>
<span id="cb22-159"><a href="#cb22-159"></a>                retry_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb22-160"><a href="#cb22-160"></a>                sleep_time <span class="op">=</span> backoff_factor <span class="op">**</span> retry_count <span class="op">+</span> random.uniform(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb22-161"><a href="#cb22-161"></a>                <span class="bu">print</span>(<span class="ss">f"HttpError </span><span class="sc">{</span>e<span class="sc">.</span>resp<span class="sc">.</span>status<span class="sc">}</span><span class="ss"> encountered. Retrying in </span><span class="sc">{</span>sleep_time<span class="sc">:.1f}</span><span class="ss"> seconds..."</span>)</span>
<span id="cb22-162"><a href="#cb22-162"></a>                time.sleep(sleep_time)</span>
<span id="cb22-163"><a href="#cb22-163"></a>            <span class="cf">else</span>:</span>
<span id="cb22-164"><a href="#cb22-164"></a>                <span class="cf">raise</span></span>
<span id="cb22-165"><a href="#cb22-165"></a>    <span class="cf">raise</span> <span class="pp">Exception</span>(<span class="st">"Failed to retrieve last empty row after several retries"</span>)</span>
<span id="cb22-166"><a href="#cb22-166"></a></span>
<span id="cb22-167"><a href="#cb22-167"></a><span class="co"># Function to append data to a Google Sheet</span></span>
<span id="cb22-168"><a href="#cb22-168"></a><span class="kw">def</span> append_data_to_sheet(spreadsheet_id, sheet_name, values,i):</span>
<span id="cb22-169"><a href="#cb22-169"></a>    <span class="cf">if</span> SEND_TO_GOOGLE_SHEETS:</span>
<span id="cb22-170"><a href="#cb22-170"></a>        service <span class="op">=</span> get_sheets_service()</span>
<span id="cb22-171"><a href="#cb22-171"></a>        last_empty_row <span class="op">=</span> find_last_empty_row(service, spreadsheet_id, sheet_name,i)</span>
<span id="cb22-172"><a href="#cb22-172"></a>        range_name <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>sheet_name<span class="sc">}</span><span class="ss">!A</span><span class="sc">{</span>last_empty_row<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb22-173"><a href="#cb22-173"></a>        body <span class="op">=</span> {</span>
<span id="cb22-174"><a href="#cb22-174"></a>            <span class="st">'values'</span>: values</span>
<span id="cb22-175"><a href="#cb22-175"></a>        }</span>
<span id="cb22-176"><a href="#cb22-176"></a>        result <span class="op">=</span> service.spreadsheets().values().append(</span>
<span id="cb22-177"><a href="#cb22-177"></a>            spreadsheetId<span class="op">=</span>spreadsheet_id, <span class="bu">range</span><span class="op">=</span>range_name,</span>
<span id="cb22-178"><a href="#cb22-178"></a>            valueInputOption<span class="op">=</span><span class="st">'RAW'</span>, body<span class="op">=</span>body).execute()</span>
<span id="cb22-179"><a href="#cb22-179"></a>        <span class="cf">return</span> result</span>
<span id="cb22-180"><a href="#cb22-180"></a></span>
<span id="cb22-181"><a href="#cb22-181"></a><span class="co"># Function to send data to the server</span></span>
<span id="cb22-182"><a href="#cb22-182"></a><span class="kw">def</span> send_data_vercel(data):</span>
<span id="cb22-183"><a href="#cb22-183"></a>    <span class="co">"""Send data to the server."""</span></span>
<span id="cb22-184"><a href="#cb22-184"></a>    <span class="cf">if</span> SEND_TO_VERCEL:</span>
<span id="cb22-185"><a href="#cb22-185"></a>        <span class="cf">try</span>:</span>
<span id="cb22-186"><a href="#cb22-186"></a>            <span class="co"># Include API key in the headers</span></span>
<span id="cb22-187"><a href="#cb22-187"></a>            headers <span class="op">=</span> {<span class="st">'x-api-key'</span>: VERCEL_API_KEY}</span>
<span id="cb22-188"><a href="#cb22-188"></a>            <span class="bu">print</span>(data)</span>
<span id="cb22-189"><a href="#cb22-189"></a>            <span class="bu">print</span>(headers)</span>
<span id="cb22-190"><a href="#cb22-190"></a>            response <span class="op">=</span> requests.post(URL, json<span class="op">=</span>data, headers<span class="op">=</span>headers)</span>
<span id="cb22-191"><a href="#cb22-191"></a>            response.raise_for_status()</span>
<span id="cb22-192"><a href="#cb22-192"></a>            <span class="co">#print(data)</span></span>
<span id="cb22-193"><a href="#cb22-193"></a>            <span class="co">#print(headers)</span></span>
<span id="cb22-194"><a href="#cb22-194"></a>            <span class="bu">print</span>(<span class="ss">f"Data sent to Vercel server: </span><span class="sc">{</span>response<span class="sc">.</span>text<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb22-195"><a href="#cb22-195"></a>        <span class="cf">except</span> requests.exceptions.RequestException <span class="im">as</span> e:</span>
<span id="cb22-196"><a href="#cb22-196"></a>            <span class="bu">print</span>(<span class="ss">f"Failed to send data to server: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb22-197"><a href="#cb22-197"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb22-198"><a href="#cb22-198"></a>            <span class="bu">print</span>(<span class="ss">f"An unexpected error occurred: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb22-199"><a href="#cb22-199"></a><span class="co"># Function to send data to ThingSpeak</span></span>
<span id="cb22-200"><a href="#cb22-200"></a><span class="kw">def</span> thingspeak_update():</span>
<span id="cb22-201"><a href="#cb22-201"></a>    <span class="co">"""Send data to ThingSpeak."""</span></span>
<span id="cb22-202"><a href="#cb22-202"></a>    <span class="cf">if</span> SEND_TO_THINGSPEAK <span class="kw">and</span> thingspeak_buffer:</span>
<span id="cb22-203"><a href="#cb22-203"></a>        <span class="cf">if</span> <span class="bu">len</span>(thingspeak_buffer) <span class="op">&gt;</span> <span class="dv">1</span>:</span>
<span id="cb22-204"><a href="#cb22-204"></a>            <span class="co"># Bulk update</span></span>
<span id="cb22-205"><a href="#cb22-205"></a>            payload <span class="op">=</span> {</span>
<span id="cb22-206"><a href="#cb22-206"></a>                <span class="st">'write_api_key'</span>: THINGSPEAK_API_KEY,</span>
<span id="cb22-207"><a href="#cb22-207"></a>                <span class="st">'updates'</span>: []</span>
<span id="cb22-208"><a href="#cb22-208"></a>            }</span>
<span id="cb22-209"><a href="#cb22-209"></a>            <span class="co">#print(THINGSPEAK_API_KEY)</span></span>
<span id="cb22-210"><a href="#cb22-210"></a>            <span class="co"># Convert buffer data to the format required by ThingSpeak</span></span>
<span id="cb22-211"><a href="#cb22-211"></a>            </span>
<span id="cb22-212"><a href="#cb22-212"></a>            <span class="cf">for</span> data <span class="kw">in</span> thingspeak_buffer:</span>
<span id="cb22-213"><a href="#cb22-213"></a>                update <span class="op">=</span> {</span>
<span id="cb22-214"><a href="#cb22-214"></a>                    <span class="st">'created_at'</span>: <span class="ss">f"</span><span class="sc">{</span>data[<span class="st">'date'</span>]<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>data[<span class="st">'time'</span>]<span class="sc">}</span><span class="ss"> -0500"</span>,</span>
<span id="cb22-215"><a href="#cb22-215"></a>                    <span class="st">'field1'</span>: data[<span class="st">'temperature_C'</span>],</span>
<span id="cb22-216"><a href="#cb22-216"></a>                    <span class="st">'field2'</span>: data[<span class="st">'temperature_F'</span>],</span>
<span id="cb22-217"><a href="#cb22-217"></a>                    <span class="st">'field3'</span>: data[<span class="st">'humidityPercent'</span>],</span>
<span id="cb22-218"><a href="#cb22-218"></a>                    <span class="st">'field4'</span>: data[<span class="st">'time'</span>],</span>
<span id="cb22-219"><a href="#cb22-219"></a>                    <span class="st">'field5'</span>: data[<span class="st">'date'</span>]</span>
<span id="cb22-220"><a href="#cb22-220"></a>                }</span>
<span id="cb22-221"><a href="#cb22-221"></a>                payload[<span class="st">'updates'</span>].append(update)</span>
<span id="cb22-222"><a href="#cb22-222"></a></span>
<span id="cb22-223"><a href="#cb22-223"></a>            <span class="cf">try</span>:</span>
<span id="cb22-224"><a href="#cb22-224"></a>                <span class="co"># Send the bulk update request to ThingSpeak</span></span>
<span id="cb22-225"><a href="#cb22-225"></a>                headers <span class="op">=</span> {<span class="st">'Content-Type'</span>: <span class="st">'application/json'</span>}</span>
<span id="cb22-226"><a href="#cb22-226"></a>                <span class="co">#print(len(thingspeak_buffer))</span></span>
<span id="cb22-227"><a href="#cb22-227"></a>                <span class="co">#print(headers)</span></span>
<span id="cb22-228"><a href="#cb22-228"></a>                <span class="co">#print(json.dumps(payload))</span></span>
<span id="cb22-229"><a href="#cb22-229"></a>                <span class="co"># Convert the data payload to JSON format</span></span>
<span id="cb22-230"><a href="#cb22-230"></a>                json_data <span class="op">=</span> json.dumps(payload)</span>
<span id="cb22-231"><a href="#cb22-231"></a>                response <span class="op">=</span> requests.post(THINGSPEAK_BULK_UPDATE_URL,headers<span class="op">=</span>headers,data<span class="op">=</span>json_data)</span>
<span id="cb22-232"><a href="#cb22-232"></a>                <span class="cf">if</span> response.status_code <span class="op">==</span> <span class="dv">202</span>:</span>
<span id="cb22-233"><a href="#cb22-233"></a>                    <span class="bu">print</span>(<span class="st">'Data posted to ThingSpeak (bulk update):'</span>, response.text)</span>
<span id="cb22-234"><a href="#cb22-234"></a>                    thingspeak_buffer.clear()  <span class="co"># Clear the buffer after successful update</span></span>
<span id="cb22-235"><a href="#cb22-235"></a>                <span class="cf">else</span>:</span>
<span id="cb22-236"><a href="#cb22-236"></a>                    <span class="bu">print</span>(<span class="ss">f'Failed to send data to ThingSpeak (bulk update): </span><span class="sc">{</span>response<span class="sc">.</span>status_code<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>response<span class="sc">.</span>text<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb22-237"><a href="#cb22-237"></a>            <span class="cf">except</span> requests.exceptions.RequestException <span class="im">as</span> e:</span>
<span id="cb22-238"><a href="#cb22-238"></a>                <span class="bu">print</span>(<span class="st">'Failed to send data to ThingSpeak (bulk update):'</span>, e)</span>
<span id="cb22-239"><a href="#cb22-239"></a>        <span class="cf">else</span>:</span>
<span id="cb22-240"><a href="#cb22-240"></a>            <span class="co"># Simple update</span></span>
<span id="cb22-241"><a href="#cb22-241"></a>            data <span class="op">=</span> thingspeak_buffer[<span class="dv">0</span>]</span>
<span id="cb22-242"><a href="#cb22-242"></a>            payload <span class="op">=</span> {</span>
<span id="cb22-243"><a href="#cb22-243"></a>                <span class="st">'api_key'</span>: THINGSPEAK_API_KEY,</span>
<span id="cb22-244"><a href="#cb22-244"></a>                <span class="st">'field1'</span>: data[<span class="st">'temperature_C'</span>],</span>
<span id="cb22-245"><a href="#cb22-245"></a>                <span class="st">'field2'</span>: data[<span class="st">'temperature_F'</span>],</span>
<span id="cb22-246"><a href="#cb22-246"></a>                <span class="st">'field3'</span>: data[<span class="st">'humidityPercent'</span>],</span>
<span id="cb22-247"><a href="#cb22-247"></a>                <span class="st">'field4'</span>: data[<span class="st">'time'</span>],</span>
<span id="cb22-248"><a href="#cb22-248"></a>                <span class="st">'field5'</span>: data[<span class="st">'date'</span>],</span>
<span id="cb22-249"><a href="#cb22-249"></a>                <span class="st">'created_at'</span>: <span class="ss">f"</span><span class="sc">{</span>data[<span class="st">'date'</span>]<span class="sc">}</span><span class="ss">T</span><span class="sc">{</span>data[<span class="st">'time'</span>]<span class="sc">}</span><span class="ss">Z"</span></span>
<span id="cb22-250"><a href="#cb22-250"></a>            }</span>
<span id="cb22-251"><a href="#cb22-251"></a></span>
<span id="cb22-252"><a href="#cb22-252"></a>            <span class="cf">try</span>:</span>
<span id="cb22-253"><a href="#cb22-253"></a>                <span class="co"># Send the simple update request to ThingSpeak</span></span>
<span id="cb22-254"><a href="#cb22-254"></a>                headers <span class="op">=</span> {</span>
<span id="cb22-255"><a href="#cb22-255"></a>                    <span class="st">'User-Agent'</span>: <span class="st">'mw.doc.simple-update (Raspberry Pi)'</span>,</span>
<span id="cb22-256"><a href="#cb22-256"></a>                    <span class="st">'Content-Type'</span>: <span class="st">'application/x-www-form-urlencoded'</span></span>
<span id="cb22-257"><a href="#cb22-257"></a>                }</span>
<span id="cb22-258"><a href="#cb22-258"></a>                response <span class="op">=</span> requests.post(THINGSPEAK_BASE_URL, headers<span class="op">=</span>headers, params<span class="op">=</span>payload)</span>
<span id="cb22-259"><a href="#cb22-259"></a>                <span class="cf">if</span> response.status_code <span class="op">==</span> <span class="dv">200</span>:</span>
<span id="cb22-260"><a href="#cb22-260"></a>                    <span class="bu">print</span>(<span class="st">'Data posted to ThingSpeak (simple update):'</span>, response.text)</span>
<span id="cb22-261"><a href="#cb22-261"></a>                    thingspeak_buffer.clear()  <span class="co"># Clear the buffer after successful update</span></span>
<span id="cb22-262"><a href="#cb22-262"></a>                <span class="cf">else</span>:</span>
<span id="cb22-263"><a href="#cb22-263"></a>                    <span class="bu">print</span>(<span class="ss">f'Failed to send data to ThingSpeak (simple update): </span><span class="sc">{</span>response<span class="sc">.</span>status_code<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>response<span class="sc">.</span>text<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb22-264"><a href="#cb22-264"></a>            <span class="cf">except</span> requests.exceptions.RequestException <span class="im">as</span> e:</span>
<span id="cb22-265"><a href="#cb22-265"></a>                <span class="bu">print</span>(<span class="st">'Failed to send data to ThingSpeak (simple update):'</span>, e)</span>
<span id="cb22-266"><a href="#cb22-266"></a></span>
<span id="cb22-267"><a href="#cb22-267"></a><span class="co"># Function to send data to MongoDB</span></span>
<span id="cb22-268"><a href="#cb22-268"></a><span class="kw">def</span> send_data_mongodb(data_mongo):</span>
<span id="cb22-269"><a href="#cb22-269"></a>    <span class="co">"""Send data to MongoDB."""</span></span>
<span id="cb22-270"><a href="#cb22-270"></a>    <span class="cf">if</span> SEND_TO_MONGODB:</span>
<span id="cb22-271"><a href="#cb22-271"></a>        <span class="cf">try</span>:</span>
<span id="cb22-272"><a href="#cb22-272"></a>            client <span class="op">=</span> MongoClient(MONGODB_URI)</span>
<span id="cb22-273"><a href="#cb22-273"></a>            db <span class="op">=</span> client[MONGODB_DB_NAME]</span>
<span id="cb22-274"><a href="#cb22-274"></a>            collection <span class="op">=</span> db[MONGODB_COLLECTION_NAME]</span>
<span id="cb22-275"><a href="#cb22-275"></a>            result <span class="op">=</span> collection.insert_many(data_mongo)</span>
<span id="cb22-276"><a href="#cb22-276"></a>            <span class="bu">print</span>(<span class="ss">f"Data sent to MongoDB: </span><span class="sc">{</span>result<span class="sc">.</span>inserted_ids<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb22-277"><a href="#cb22-277"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb22-278"><a href="#cb22-278"></a>            <span class="bu">print</span>(<span class="ss">f"Failed to send data to MongoDB: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb22-279"><a href="#cb22-279"></a><span class="co"># Function to save spreadsheet info to a file</span></span>
<span id="cb22-280"><a href="#cb22-280"></a><span class="kw">def</span> save_spreadsheet_info(spreadsheet_id, workbook_name, sheet_name):</span>
<span id="cb22-281"><a href="#cb22-281"></a>    info <span class="op">=</span> {</span>
<span id="cb22-282"><a href="#cb22-282"></a>        <span class="st">'spreadsheet_id'</span>: spreadsheet_id,</span>
<span id="cb22-283"><a href="#cb22-283"></a>        <span class="st">'workbook_name'</span>: workbook_name,</span>
<span id="cb22-284"><a href="#cb22-284"></a>        <span class="st">'sheet_name'</span>: sheet_name</span>
<span id="cb22-285"><a href="#cb22-285"></a>    }</span>
<span id="cb22-286"><a href="#cb22-286"></a>    <span class="cf">with</span> <span class="bu">open</span>(<span class="st">'spreadsheet_info.txt'</span>, <span class="st">'w'</span>) <span class="im">as</span> f:</span>
<span id="cb22-287"><a href="#cb22-287"></a>        json.dump(info, f)</span>
<span id="cb22-288"><a href="#cb22-288"></a></span>
<span id="cb22-289"><a href="#cb22-289"></a><span class="co"># Function to load spreadsheet info from a file</span></span>
<span id="cb22-290"><a href="#cb22-290"></a><span class="kw">def</span> load_spreadsheet_info():</span>
<span id="cb22-291"><a href="#cb22-291"></a>    <span class="cf">if</span> os.path.exists(<span class="st">'spreadsheet_info.txt'</span>):</span>
<span id="cb22-292"><a href="#cb22-292"></a>        <span class="cf">with</span> <span class="bu">open</span>(<span class="st">'spreadsheet_info.txt'</span>, <span class="st">'r'</span>) <span class="im">as</span> f:</span>
<span id="cb22-293"><a href="#cb22-293"></a>            info <span class="op">=</span> json.load(f)</span>
<span id="cb22-294"><a href="#cb22-294"></a>            <span class="cf">return</span> info[<span class="st">'spreadsheet_id'</span>], info[<span class="st">'workbook_name'</span>], info[<span class="st">'sheet_name'</span>]</span>
<span id="cb22-295"><a href="#cb22-295"></a>    <span class="cf">return</span> <span class="va">None</span>, <span class="va">None</span>, <span class="va">None</span></span>
<span id="cb22-296"><a href="#cb22-296"></a></span>
<span id="cb22-297"><a href="#cb22-297"></a><span class="kw">def</span> main():</span>
<span id="cb22-298"><a href="#cb22-298"></a>    <span class="co"># Load spreadsheet info from file</span></span>
<span id="cb22-299"><a href="#cb22-299"></a>    spreadsheet_id, workbook_name, sheet_name <span class="op">=</span> load_spreadsheet_info()</span>
<span id="cb22-300"><a href="#cb22-300"></a></span>
<span id="cb22-301"><a href="#cb22-301"></a>    <span class="cf">if</span> spreadsheet_id <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> workbook_name <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> sheet_name <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb22-302"><a href="#cb22-302"></a>        <span class="co"># Initialize new sheet if no info found</span></span>
<span id="cb22-303"><a href="#cb22-303"></a>        workbook_name <span class="op">=</span> <span class="st">'your-workbook-name'</span>  <span class="co"># Replace with your Google Sheet ID</span></span>
<span id="cb22-304"><a href="#cb22-304"></a>        spreadsheet_id <span class="op">=</span> <span class="st">'your-spreadsheet-id'</span>  <span class="co"># Replace with your Google Sheet ID</span></span>
<span id="cb22-305"><a href="#cb22-305"></a>        sheet_name <span class="op">=</span> <span class="st">'Sheet1'</span>  <span class="co"># Adjust the sheet name as needed</span></span>
<span id="cb22-306"><a href="#cb22-306"></a></span>
<span id="cb22-307"><a href="#cb22-307"></a>    max_cells <span class="op">=</span> <span class="dv">5000000</span></span>
<span id="cb22-308"><a href="#cb22-308"></a></span>
<span id="cb22-309"><a href="#cb22-309"></a>    <span class="co"># Initialize loop counter</span></span>
<span id="cb22-310"><a href="#cb22-310"></a>    i <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb22-311"><a href="#cb22-311"></a></span>
<span id="cb22-312"><a href="#cb22-312"></a>    <span class="co"># Get current date and time for the new sheet name if needed</span></span>
<span id="cb22-313"><a href="#cb22-313"></a>    current_time <span class="op">=</span> datetime.now().strftime(<span class="st">"%Y-%m-</span><span class="sc">%d</span><span class="st"> %H:%M:%S"</span>)</span>
<span id="cb22-314"><a href="#cb22-314"></a>    new_sheet_name <span class="op">=</span> <span class="ss">f"Pi-Sensor </span><span class="sc">{</span>current_time<span class="sc">}</span><span class="ss">"</span>  <span class="co"># New sheet name with date and time</span></span>
<span id="cb22-315"><a href="#cb22-315"></a>    </span>
<span id="cb22-316"><a href="#cb22-316"></a>    <span class="co"># Check sheet size and create new sheet if necessary</span></span>
<span id="cb22-317"><a href="#cb22-317"></a>    <span class="cf">if</span> SEND_TO_GOOGLE_SHEETS:</span>
<span id="cb22-318"><a href="#cb22-318"></a>        spreadsheet_id, total_cells <span class="op">=</span> check_sheet_size(spreadsheet_id, new_sheet_name)</span>
<span id="cb22-319"><a href="#cb22-319"></a>        <span class="bu">print</span>(<span class="ss">f"Total cells in the sheet: </span><span class="sc">{</span>total_cells<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb22-320"><a href="#cb22-320"></a>        </span>
<span id="cb22-321"><a href="#cb22-321"></a>        <span class="cf">if</span> total_cells <span class="op">&gt;=</span> max_cells:</span>
<span id="cb22-322"><a href="#cb22-322"></a>            <span class="bu">print</span>(<span class="st">"The sheet has reached the maximum cell limit. Creating a new sheet."</span>)</span>
<span id="cb22-323"><a href="#cb22-323"></a>            spreadsheet_id <span class="op">=</span> create_new_sheet(new_sheet_name)</span>
<span id="cb22-324"><a href="#cb22-324"></a>            sheet_name <span class="op">=</span> <span class="st">'Sheet1'</span>  <span class="co"># Reset to default sheet name for new spreadsheet</span></span>
<span id="cb22-325"><a href="#cb22-325"></a>        <span class="cf">else</span>:</span>
<span id="cb22-326"><a href="#cb22-326"></a>            <span class="bu">print</span>(<span class="st">"The sheet has not reached the maximum cell limit."</span>)</span>
<span id="cb22-327"><a href="#cb22-327"></a></span>
<span id="cb22-328"><a href="#cb22-328"></a>    <span class="co"># Time tracking for ThingSpeak</span></span>
<span id="cb22-329"><a href="#cb22-329"></a>    last_thingspeak_update <span class="op">=</span> time_module.time()</span>
<span id="cb22-330"><a href="#cb22-330"></a>    last_mongodb_update <span class="op">=</span> time_module.time()</span>
<span id="cb22-331"><a href="#cb22-331"></a>    last_vercel_update <span class="op">=</span> time_module.time()</span>
<span id="cb22-332"><a href="#cb22-332"></a>    <span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb22-333"><a href="#cb22-333"></a>        <span class="co"># Get the current time at the start of the loop</span></span>
<span id="cb22-334"><a href="#cb22-334"></a>        start_time <span class="op">=</span> time_module.time()</span>
<span id="cb22-335"><a href="#cb22-335"></a>        </span>
<span id="cb22-336"><a href="#cb22-336"></a>        <span class="co"># Read humidity and temperature from DHT sensor</span></span>
<span id="cb22-337"><a href="#cb22-337"></a>        humidityPercent, temperature_C <span class="op">=</span> Adafruit_DHT.read_retry(SENSOR, PIN)</span>
<span id="cb22-338"><a href="#cb22-338"></a>        </span>
<span id="cb22-339"><a href="#cb22-339"></a>        <span class="cf">if</span> humidityPercent <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> temperature_C <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb22-340"><a href="#cb22-340"></a>            <span class="co"># Prepare the data payload</span></span>
<span id="cb22-341"><a href="#cb22-341"></a>            temperature_F <span class="op">=</span> temperature_C <span class="op">*</span> <span class="fl">9.0</span> <span class="op">/</span> <span class="fl">5.0</span> <span class="op">+</span> <span class="dv">32</span></span>
<span id="cb22-342"><a href="#cb22-342"></a>            </span>
<span id="cb22-343"><a href="#cb22-343"></a>            now <span class="op">=</span> datetime.now()</span>
<span id="cb22-344"><a href="#cb22-344"></a>            date <span class="op">=</span> now.strftime(<span class="st">"%m-</span><span class="sc">%d</span><span class="st">-%Y"</span>)</span>
<span id="cb22-345"><a href="#cb22-345"></a>            timeNow <span class="op">=</span> now.strftime(<span class="st">"%H:%M:%S"</span>)</span>
<span id="cb22-346"><a href="#cb22-346"></a>            </span>
<span id="cb22-347"><a href="#cb22-347"></a>            dataVercel <span class="op">=</span> {</span>
<span id="cb22-348"><a href="#cb22-348"></a>                <span class="st">'date'</span>: date,</span>
<span id="cb22-349"><a href="#cb22-349"></a>                <span class="st">'time'</span>: timeNow,</span>
<span id="cb22-350"><a href="#cb22-350"></a>                <span class="st">'humidityPercent'</span>: humidityPercent,</span>
<span id="cb22-351"><a href="#cb22-351"></a>                <span class="st">'temperatureFahrenheit'</span>: temperature_F,</span>
<span id="cb22-352"><a href="#cb22-352"></a>                <span class="st">'temperatureCelsius'</span>: temperature_C</span>
<span id="cb22-353"><a href="#cb22-353"></a>            }</span>
<span id="cb22-354"><a href="#cb22-354"></a>            dataMongo <span class="op">=</span> {</span>
<span id="cb22-355"><a href="#cb22-355"></a>                <span class="st">'date'</span>: date,</span>
<span id="cb22-356"><a href="#cb22-356"></a>                <span class="st">'time'</span>: timeNow,</span>
<span id="cb22-357"><a href="#cb22-357"></a>                <span class="st">'humidityPercent'</span>: humidityPercent,</span>
<span id="cb22-358"><a href="#cb22-358"></a>                <span class="st">'temperatureFahrenheit'</span>: temperature_F,</span>
<span id="cb22-359"><a href="#cb22-359"></a>                <span class="st">'temperatureCelsius'</span>: temperature_C</span>
<span id="cb22-360"><a href="#cb22-360"></a>            }</span>
<span id="cb22-361"><a href="#cb22-361"></a>            <span class="co"># Log data to buffer. had to separate data as sometimes ObjectID would somehow get passed to Vercel's buffer.</span></span>
<span id="cb22-362"><a href="#cb22-362"></a>            data_buffer_vercel.append(dataVercel)</span>
<span id="cb22-363"><a href="#cb22-363"></a>            data_buffer_mongodb.append(dataMongo)</span>
<span id="cb22-364"><a href="#cb22-364"></a>            <span class="cf">if</span> i <span class="op">%</span> <span class="dv">60</span> <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb22-365"><a href="#cb22-365"></a>                <span class="bu">print</span>(<span class="ss">f"Logged data: </span><span class="sc">{</span>dataVercel<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb22-366"><a href="#cb22-366"></a>            </span>
<span id="cb22-367"><a href="#cb22-367"></a>            <span class="co"># Append data to Google Sheet</span></span>
<span id="cb22-368"><a href="#cb22-368"></a>            append_data_to_sheet(spreadsheet_id, sheet_name, [[date, timeNow, humidityPercent, temperature_F, temperature_C]],i)</span>
<span id="cb22-369"><a href="#cb22-369"></a>            </span>
<span id="cb22-370"><a href="#cb22-370"></a>            <span class="co"># Add data to ThingSpeak buffer</span></span>
<span id="cb22-371"><a href="#cb22-371"></a>            thingspeak_buffer.append({</span>
<span id="cb22-372"><a href="#cb22-372"></a>                <span class="st">'temperature_C'</span>: temperature_C,</span>
<span id="cb22-373"><a href="#cb22-373"></a>                <span class="st">'temperature_F'</span>: temperature_F,</span>
<span id="cb22-374"><a href="#cb22-374"></a>                <span class="st">'humidityPercent'</span>: humidityPercent,</span>
<span id="cb22-375"><a href="#cb22-375"></a>                <span class="st">'time'</span>: timeNow,</span>
<span id="cb22-376"><a href="#cb22-376"></a>                <span class="st">'date'</span>: datetime.strptime(date, <span class="st">"%m-</span><span class="sc">%d</span><span class="st">-%Y"</span>).strftime(<span class="st">"%Y-%m-</span><span class="sc">%d</span><span class="st">"</span>)</span>
<span id="cb22-377"><a href="#cb22-377"></a>            })</span>
<span id="cb22-378"><a href="#cb22-378"></a>            </span>
<span id="cb22-379"><a href="#cb22-379"></a>            <span class="co"># Check if 300 readings have been logged</span></span>
<span id="cb22-380"><a href="#cb22-380"></a>            <span class="cf">if</span> time_module.time() <span class="op">-</span> last_vercel_update <span class="op">&gt;=</span> <span class="dv">3600</span>:</span>
<span id="cb22-381"><a href="#cb22-381"></a>                send_data_vercel(data_buffer_vercel)</span>
<span id="cb22-382"><a href="#cb22-382"></a>                <span class="co"># Clear the buffer after sending</span></span>
<span id="cb22-383"><a href="#cb22-383"></a>                data_buffer_vercel.clear()</span>
<span id="cb22-384"><a href="#cb22-384"></a>                last_vercel_update <span class="op">=</span> time_module.time()</span>
<span id="cb22-385"><a href="#cb22-385"></a>            <span class="co"># Check if it's time to send data to Mongodb</span></span>
<span id="cb22-386"><a href="#cb22-386"></a>            <span class="cf">if</span> time_module.time() <span class="op">-</span> last_mongodb_update <span class="op">&gt;=</span> <span class="dv">60</span>:</span>
<span id="cb22-387"><a href="#cb22-387"></a>                send_data_mongodb(data_buffer_mongodb)</span>
<span id="cb22-388"><a href="#cb22-388"></a>                data_buffer_mongodb.clear()</span>
<span id="cb22-389"><a href="#cb22-389"></a>                last_mongodb_update <span class="op">=</span> time_module.time()</span>
<span id="cb22-390"><a href="#cb22-390"></a>                </span>
<span id="cb22-391"><a href="#cb22-391"></a>            <span class="co"># Check if it's time to send data to ThingSpeak</span></span>
<span id="cb22-392"><a href="#cb22-392"></a>            <span class="cf">if</span> time_module.time() <span class="op">-</span> last_thingspeak_update <span class="op">&gt;=</span> <span class="dv">15</span>:</span>
<span id="cb22-393"><a href="#cb22-393"></a>                thingspeak_update()</span>
<span id="cb22-394"><a href="#cb22-394"></a>                last_thingspeak_update <span class="op">=</span> time_module.time()</span>
<span id="cb22-395"><a href="#cb22-395"></a>        <span class="cf">else</span>:</span>
<span id="cb22-396"><a href="#cb22-396"></a>            <span class="co"># Handle cases where sensor fails to read</span></span>
<span id="cb22-397"><a href="#cb22-397"></a>            <span class="bu">print</span>(<span class="st">"Failed to retrieve data from sensor"</span>)</span>
<span id="cb22-398"><a href="#cb22-398"></a>        </span>
<span id="cb22-399"><a href="#cb22-399"></a>        <span class="co"># Wait until the LOOP_TIME has elapsed</span></span>
<span id="cb22-400"><a href="#cb22-400"></a>        <span class="cf">while</span> time_module.time() <span class="op">-</span> start_time <span class="op">&lt;</span> LOOP_TIME:</span>
<span id="cb22-401"><a href="#cb22-401"></a>            time_module.sleep(<span class="fl">0.01</span>)  <span class="co"># Sleep a short time to avoid busy-waiting</span></span>
<span id="cb22-402"><a href="#cb22-402"></a></span>
<span id="cb22-403"><a href="#cb22-403"></a>        i <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb22-404"><a href="#cb22-404"></a></span>
<span id="cb22-405"><a href="#cb22-405"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">'__main__'</span>:</span>
<span id="cb22-406"><a href="#cb22-406"></a>    main()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<details>
<summary>
Code Summary
</summary>
<p>This Python script reads environmental data from a DHT11 sensor and sends it to multiple endpoints: Vercel, Google Sheets, ThingSpeak, and MongoDB. The script also includes functionality for managing Google Sheets, such as creating new sheets and appending data to them. Below is a detailed summary of the main components and their functionality:</p>

<section id="key-components-3" class="level3">
<h3 class="anchored" data-anchor-id="key-components-3"><strong>Key Components:</strong></h3>
<ol type="1">
<li><p><strong>Imports and Setup</strong>:</p>
<ul>
<li><p>Imports necessary libraries for reading sensor data, making HTTP requests, handling time, and interacting with Google APIs and MongoDB.</p></li>
<li><p>Defines control flags to enable/disable sending data to Vercel, Google Sheets, ThingSpeak, and MongoDB.</p></li>
</ul></li>
<li><p><strong>API Key and Endpoint Configuration</strong>:</p>
<ul>
<li><p>ThingSpeak API settings including API key, base URL, channel ID, and bulk update URL.</p></li>
<li><p>Vercel API key.</p></li>
<li><p>MongoDB URI, database name, and collection name.</p></li>
</ul></li>
<li><p><strong>Sensor Setup</strong>:</p>
<ul>
<li>Defines the DHT11 sensor and the GPIO pin to which it is connected.</li>
</ul></li>
<li><p><strong>Data Buffers</strong>:</p>
<ul>
<li>Initializes buffers for storing data before sending it to Vercel, MongoDB, and ThingSpeak.</li>
</ul></li>
<li><p><strong>Google Sheets Authentication</strong>:</p>
<ul>
<li><p><strong><code>get_sheets_service()</code></strong>: Authenticates and returns the Google Sheets service object.</p></li>
<li><p><strong><code>get_drive_service()</code></strong>: Authenticates and returns the Google Drive service object.</p></li>
</ul></li>
<li><p><strong>Google Sheets Management</strong>:</p>
<ul>
<li><p><strong><code>set_sheet_public(spreadsheet_id)</code></strong>: Sets the permissions of a Google Sheet to public.</p></li>
<li><p><strong><code>create_new_sheet(sheet_name)</code></strong>: Creates a new Google Sheet with the specified name.</p></li>
<li><p><strong><code>check_sheet_size(spreadsheet_id, new_sheet_name)</code></strong>: Checks the size of a Google Sheet and creates a new one if necessary.</p></li>
<li><p><strong><code>find_last_empty_row(service, spreadsheet_id, sheet_name, i)</code></strong>: Finds the last empty row in a Google Sheet.</p></li>
<li><p><strong><code>append_data_to_sheet(spreadsheet_id, sheet_name, values, i)</code></strong>: Appends data to a Google Sheet.</p></li>
<li><p><strong><code>save_spreadsheet_info(spreadsheet_id, workbook_name, sheet_name)</code></strong>: Saves Google Sheet info to a file.</p></li>
<li><p><strong><code>load_spreadsheet_info()</code></strong>: Loads Google Sheet info from a file.</p></li>
</ul></li>
<li><p><strong>Sending Data</strong>:</p>
<ul>
<li><p><strong><code>send_data_vercel(data)</code></strong>: Sends data to the Vercel endpoint.</p></li>
<li><p><strong><code>thingspeak_update()</code></strong>: Sends data to the ThingSpeak channel, either as a bulk update or a simple update.</p></li>
<li><p><strong><code>send_data_mongodb(data_mongo)</code></strong>: Sends data to MongoDB.</p></li>
</ul></li>
<li><p><strong>Main Function</strong>:</p>
<ul>
<li><p>Loads spreadsheet info or initializes a new sheet.</p></li>
<li><p>Checks the size of the Google Sheet and creates a new one if it has reached its cell limit.</p></li>
<li><p>Enters an infinite loop to read data from the DHT11 sensor every second.</p></li>
<li><p>Prepares and logs data to buffers.</p></li>
<li><p>Appends data to Google Sheets.</p></li>
<li><p>Sends buffered data to Vercel every hour.</p></li>
<li><p>Sends data to MongoDB every 60 seconds.</p></li>
<li><p>Sends data to ThingSpeak every 15 seconds.</p></li>
<li><p>Includes error handling for sensor read failures and HTTP request failures.</p></li>
</ul></li>
</ol>
</section>
<section id="example-output-2" class="level3">
<h3 class="anchored" data-anchor-id="example-output-2"><strong>Example Output:</strong></h3>
<ul>
<li>The script provides feedback through print statements, indicating the creation of new sheets, reading data, writing data, appending data, and handling errors.</li>
</ul>
</section>
<section id="notes-2" class="level3">
<h3 class="anchored" data-anchor-id="notes-2"><strong>Notes:</strong></h3>
<ul>
<li><p>Replace <strong><code>'Your-API-Key'</code></strong>, <strong><code>'Your-Vercel-ID'</code></strong>, and <strong><code>'mongodb+srv://&lt;user&gt;:&lt;password&gt;@&lt;cluster-number&gt;.&lt;specialURL&gt;.mongodb.net'</code></strong> with your actual API keys and URIs.</p></li>
<li><p>Replace <strong><code>your-workbook-name</code></strong> and <strong><code>your-spreadsheet-id</code></strong> with your actual Google Sheet name and ID.</p></li>
<li><p>Ensure you have <strong><code>credentials.json</code></strong> and <strong><code>token.json</code></strong> files for Google API OAuth 2.0 and token management.</p></li>
</ul>
<p>This script facilitates continuous monitoring and logging of environmental data from a DHT11 sensor, with automated data management and reporting using Vercel, Google Sheets, ThingSpeak, and MongoDB.</p>
</section></details>
<p>Currently, sending to all 4 servers, I experience a max “drop” of the sensor data of 3 seconds and that is running a .py file with a desktop running in the background.</p>
<p>To set up the .py script to start up at boot I did the following:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1"></a><span class="fu">sudo</span> nano /etc/systemd/system/sensor_data.service</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>And within that file:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1"></a><span class="ex">[Unit]</span></span>
<span id="cb24-2"><a href="#cb24-2"></a><span class="va">Description</span><span class="op">=</span>Sensor <span class="ex">Data</span> Collection Service</span>
<span id="cb24-3"><a href="#cb24-3"></a><span class="va">After</span><span class="op">=</span>network.target</span>
<span id="cb24-4"><a href="#cb24-4"></a></span>
<span id="cb24-5"><a href="#cb24-5"></a><span class="ex">[Service]</span></span>
<span id="cb24-6"><a href="#cb24-6"></a><span class="va">ExecStart</span><span class="op">=</span>/usr/local/bin/python3.12 <span class="ex">/home/pi/Desktop/TempHumidityVercelGoogleMongoThinkSpeak.py</span></span>
<span id="cb24-7"><a href="#cb24-7"></a><span class="va">WorkingDirectory</span><span class="op">=</span>/home/pi/Desktop</span>
<span id="cb24-8"><a href="#cb24-8"></a><span class="va">StandardOutput</span><span class="op">=</span>append:/home/pi/sensor_data.log</span>
<span id="cb24-9"><a href="#cb24-9"></a><span class="va">StandardError</span><span class="op">=</span>append:/home/pi/sensor_data.log</span>
<span id="cb24-10"><a href="#cb24-10"></a><span class="va">Restart</span><span class="op">=</span>always</span>
<span id="cb24-11"><a href="#cb24-11"></a><span class="va">User</span><span class="op">=</span>pi</span>
<span id="cb24-12"><a href="#cb24-12"></a></span>
<span id="cb24-13"><a href="#cb24-13"></a><span class="ex">[Install]</span></span>
<span id="cb24-14"><a href="#cb24-14"></a><span class="va">WantedBy</span><span class="op">=</span>multi-user.target</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This sets it up to run at boot and also to log the output.</p>
<p>Enable and start the service:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1"></a><span class="fu">sudo</span> systemctl enable sensor_data.service</span>
<span id="cb25-2"><a href="#cb25-2"></a><span class="fu">sudo</span> systemctl start sensor_data.service</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Check the status:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb26-1"><a href="#cb26-1"></a><span class="fu">sudo</span> systemctl status sensor_data.service</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>I made a separate service file to make sure I can see the log by firing up my pi and leaving it be:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1"></a><span class="fu">sudo</span> apt-get install logrotate</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb28"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb28-1"><a href="#cb28-1"></a><span class="fu">sudo</span> nano /etc/logrotate.d/sensor_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>And within that file:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1"></a><span class="ex">/home/pi/sensor_data.log</span> {</span>
<span id="cb29-2"><a href="#cb29-2"></a>    <span class="ex">daily</span></span>
<span id="cb29-3"><a href="#cb29-3"></a>    <span class="ex">missingok</span></span>
<span id="cb29-4"><a href="#cb29-4"></a>    <span class="ex">rotate</span> 7</span>
<span id="cb29-5"><a href="#cb29-5"></a>    <span class="ex">compress</span></span>
<span id="cb29-6"><a href="#cb29-6"></a>    <span class="ex">delaycompress</span></span>
<span id="cb29-7"><a href="#cb29-7"></a>    <span class="ex">notifempty</span></span>
<span id="cb29-8"><a href="#cb29-8"></a>    <span class="ex">create</span> 0640 pi pi</span>
<span id="cb29-9"><a href="#cb29-9"></a>    <span class="ex">postrotate</span></span>
<span id="cb29-10"><a href="#cb29-10"></a>        <span class="ex">systemctl</span> restart sensor_data.service <span class="op">&gt;</span> /dev/null</span>
<span id="cb29-11"><a href="#cb29-11"></a>    <span class="ex">endscript</span></span>
<span id="cb29-12"><a href="#cb29-12"></a><span class="er">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This will rotate the log file daily, keep 7 rotations, compress the old logs, and restart the service after every log rotation.</p>
<p>Next set up a script that checks for specific keywords including errors and sends a notification:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb30-1"><a href="#cb30-1"></a><span class="fu">nano</span> /home/pi/check_logs.sh</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb31"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb31-1"><a href="#cb31-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb31-2"><a href="#cb31-2"></a></span>
<span id="cb31-3"><a href="#cb31-3"></a><span class="va">LOG_FILE</span><span class="op">=</span><span class="st">"/home/pi/sensor_data.log"</span></span>
<span id="cb31-4"><a href="#cb31-4"></a><span class="va">ERROR_KEYWORDS</span><span class="op">=</span><span class="va">(</span><span class="st">"ERROR"</span> <span class="st">"FAIL"</span> <span class="st">"exception"</span><span class="va">)</span></span>
<span id="cb31-5"><a href="#cb31-5"></a></span>
<span id="cb31-6"><a href="#cb31-6"></a><span class="cf">for</span> keyword <span class="kw">in</span> <span class="st">"</span><span class="va">${ERROR_KEYWORDS</span><span class="op">[@]</span><span class="va">}</span><span class="st">"</span><span class="kw">;</span> <span class="cf">do</span></span>
<span id="cb31-7"><a href="#cb31-7"></a>    <span class="cf">if</span> <span class="fu">grep</span> <span class="at">-q</span> <span class="st">"</span><span class="va">$keyword</span><span class="st">"</span> <span class="st">"</span><span class="va">$LOG_FILE</span><span class="st">"</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb31-8"><a href="#cb31-8"></a>        <span class="bu">echo</span> <span class="st">"Error detected in sensor_data service logs:"</span></span>
<span id="cb31-9"><a href="#cb31-9"></a>        <span class="fu">grep</span> <span class="st">"</span><span class="va">$keyword</span><span class="st">"</span> <span class="st">"</span><span class="va">$LOG_FILE</span><span class="st">"</span></span>
<span id="cb31-10"><a href="#cb31-10"></a>        <span class="cf">break</span></span>
<span id="cb31-11"><a href="#cb31-11"></a>    <span class="cf">fi</span></span>
<span id="cb31-12"><a href="#cb31-12"></a><span class="cf">done</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Make it executable:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb32-1"><a href="#cb32-1"></a><span class="fu">chmod</span> +x /home/pi/check_logs.sh</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Access Cron to schedule jobs:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb33-1"><a href="#cb33-1"></a><span class="fu">crontab</span> <span class="at">-e</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Set the job to run * * * * *, or every minute of every hour of every day of every month.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb34-1"><a href="#cb34-1"></a><span class="ex">*</span> <span class="pp">*</span> <span class="pp">*</span> <span class="pp">*</span> <span class="pp">*</span> /home/pi/check_logs.sh</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Check that it worked:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb35-1"><a href="#cb35-1"></a><span class="fu">crontab</span> <span class="at">-l</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>From here I also wanted to display the output at boot as well. This is optional, but I wanna see a running log of what’s going on:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb36-1"><a href="#cb36-1"></a><span class="fu">sudo</span> nano /etc/systemd/system/monitor_sensor_logs.service</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb37"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb37-1"><a href="#cb37-1"></a><span class="ex">[Unit]</span></span>
<span id="cb37-2"><a href="#cb37-2"></a><span class="va">Description</span><span class="op">=</span>Monitor <span class="ex">Sensor</span> Data Service Logs</span>
<span id="cb37-3"><a href="#cb37-3"></a><span class="va">After</span><span class="op">=</span>sensor_data.service</span>
<span id="cb37-4"><a href="#cb37-4"></a><span class="va">Requires</span><span class="op">=</span>sensor_data.service</span>
<span id="cb37-5"><a href="#cb37-5"></a></span>
<span id="cb37-6"><a href="#cb37-6"></a><span class="ex">[Service]</span></span>
<span id="cb37-7"><a href="#cb37-7"></a><span class="va">ExecStart</span><span class="op">=</span>/bin/bash <span class="ex">-c</span> <span class="st">'journalctl -u sensor_data.service -f'</span></span>
<span id="cb37-8"><a href="#cb37-8"></a><span class="va">StandardOutput</span><span class="op">=</span>inherit</span>
<span id="cb37-9"><a href="#cb37-9"></a><span class="va">StandardError</span><span class="op">=</span>inherit</span>
<span id="cb37-10"><a href="#cb37-10"></a><span class="va">Restart</span><span class="op">=</span>always</span>
<span id="cb37-11"><a href="#cb37-11"></a><span class="va">User</span><span class="op">=</span>pi</span>
<span id="cb37-12"><a href="#cb37-12"></a></span>
<span id="cb37-13"><a href="#cb37-13"></a><span class="ex">[Install]</span></span>
<span id="cb37-14"><a href="#cb37-14"></a><span class="va">WantedBy</span><span class="op">=</span>multi-user.target</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Enable on boot:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb38-1"><a href="#cb38-1"></a><span class="fu">sudo</span> systemctl enable monitor_sensor_logs.service</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Disabling the desktop[Boot into Command Line Interface]:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb39-1"><a href="#cb39-1"></a><span class="fu">sudo</span> raspi-config</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><a href="raspi-config.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6"><img src="raspi-config.png" class="img-fluid"></a></p>
<p><a href="raspi-config2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-7"><img src="raspi-config2.png" class="img-fluid"></a></p>
<p><a href="raspi-config3.png" class="lightbox" data-gallery="quarto-lightbox-gallery-8"><img src="raspi-config3.png" class="img-fluid"></a></p>
<p>Finally reboot and you’re done!</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb40-1"><a href="#cb40-1"></a><span class="fu">sudo</span> reboot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>After setting up the python script to run at bootup and disabling the desktop I experience a drop of “1-2” seconds with a larger amount of 1 second drops than 2.</p>
<p>I must have made some sort of mistake in getting the logging to work, but the data is being sent and that’s good enough for now.</p>
<p>Running this command after the pi boots up works well enough:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb41-1"><a href="#cb41-1"></a><span class="fu">tail</span> <span class="at">-f</span> /home/pi/sensor_data.log</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>And don’t forget that if you want to connect via SSH(if you didn’t already)”</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb42-1"><a href="#cb42-1"></a><span class="fu">ssh</span> pi@<span class="op">&lt;</span>IP_ADDRESS_OF_YOUR_PI<span class="op">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If you want to get the desktop back simply type into the Pi console:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb43-1"><a href="#cb43-1"></a><span class="ex">startx</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now for the results:</p>
<p>To get the Google Script working I deployed a Google Aps Script:</p>
<p>Go to script.google.com and create a new project</p>
<p>Write a function to fetch data from my Google Sheets:</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode numberSource javascript number-lines code-with-copy"><code class="sourceCode javascript"><span id="cb44-1"><a href="#cb44-1"></a><span class="kw">function</span> <span class="fu">doGet</span>(e) {</span>
<span id="cb44-2"><a href="#cb44-2"></a>  <span class="cf">try</span> {</span>
<span id="cb44-3"><a href="#cb44-3"></a>    <span class="co">// Open the spreadsheet by ID and get the specified sheet</span></span>
<span id="cb44-4"><a href="#cb44-4"></a>    <span class="kw">const</span> sheet <span class="op">=</span> SpreadsheetApp<span class="op">.</span><span class="fu">openById</span>(<span class="st">'1n4iZYfgdhv08PeREqz26F4-eQYfnXdHaSQywnQ8UYWk'</span>)<span class="op">.</span><span class="fu">getSheetByName</span>(<span class="st">'Sheet1'</span>)<span class="op">;</span></span>
<span id="cb44-5"><a href="#cb44-5"></a>    Logger<span class="op">.</span><span class="fu">log</span>(<span class="st">'Sheet accessed successfully'</span>)<span class="op">;</span></span>
<span id="cb44-6"><a href="#cb44-6"></a>    </span>
<span id="cb44-7"><a href="#cb44-7"></a>    <span class="co">// Get the last row number</span></span>
<span id="cb44-8"><a href="#cb44-8"></a>    <span class="kw">const</span> lastRow <span class="op">=</span> sheet<span class="op">.</span><span class="fu">getLastRow</span>()<span class="op">;</span></span>
<span id="cb44-9"><a href="#cb44-9"></a>    Logger<span class="op">.</span><span class="fu">log</span>(<span class="st">'Last row number: '</span> <span class="op">+</span> lastRow)<span class="op">;</span></span>
<span id="cb44-10"><a href="#cb44-10"></a>    </span>
<span id="cb44-11"><a href="#cb44-11"></a>    <span class="co">// Get the values of the last row</span></span>
<span id="cb44-12"><a href="#cb44-12"></a>    <span class="kw">const</span> lastRowData <span class="op">=</span> sheet<span class="op">.</span><span class="fu">getRange</span>(lastRow<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> sheet<span class="op">.</span><span class="fu">getLastColumn</span>())<span class="op">.</span><span class="fu">getValues</span>()[<span class="dv">0</span>]<span class="op">;</span></span>
<span id="cb44-13"><a href="#cb44-13"></a>    Logger<span class="op">.</span><span class="fu">log</span>(<span class="st">'Last row data: '</span> <span class="op">+</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(lastRowData))<span class="op">;</span></span>
<span id="cb44-14"><a href="#cb44-14"></a>    </span>
<span id="cb44-15"><a href="#cb44-15"></a>    <span class="co">// Get the headers from the first row</span></span>
<span id="cb44-16"><a href="#cb44-16"></a>    <span class="kw">const</span> headers <span class="op">=</span> sheet<span class="op">.</span><span class="fu">getRange</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> sheet<span class="op">.</span><span class="fu">getLastColumn</span>())<span class="op">.</span><span class="fu">getValues</span>()[<span class="dv">0</span>]<span class="op">;</span></span>
<span id="cb44-17"><a href="#cb44-17"></a>    Logger<span class="op">.</span><span class="fu">log</span>(<span class="st">'Headers: '</span> <span class="op">+</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(headers))<span class="op">;</span></span>
<span id="cb44-18"><a href="#cb44-18"></a>    </span>
<span id="cb44-19"><a href="#cb44-19"></a>    <span class="co">// Create an object to store the last row data</span></span>
<span id="cb44-20"><a href="#cb44-20"></a>    <span class="kw">const</span> result <span class="op">=</span> {}<span class="op">;</span></span>
<span id="cb44-21"><a href="#cb44-21"></a>    </span>
<span id="cb44-22"><a href="#cb44-22"></a>    <span class="co">// Populate the result object with the headers as keys and last row data as values</span></span>
<span id="cb44-23"><a href="#cb44-23"></a>    headers<span class="op">.</span><span class="fu">forEach</span>((header<span class="op">,</span> index) <span class="kw">=&gt;</span> {</span>
<span id="cb44-24"><a href="#cb44-24"></a>      result[header] <span class="op">=</span> lastRowData[index]<span class="op">;</span></span>
<span id="cb44-25"><a href="#cb44-25"></a>    })<span class="op">;</span></span>
<span id="cb44-26"><a href="#cb44-26"></a>    Logger<span class="op">.</span><span class="fu">log</span>(<span class="st">'Result object: '</span> <span class="op">+</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(result))<span class="op">;</span></span>
<span id="cb44-27"><a href="#cb44-27"></a>    </span>
<span id="cb44-28"><a href="#cb44-28"></a>    <span class="co">// Convert the result object to JSON</span></span>
<span id="cb44-29"><a href="#cb44-29"></a>    <span class="kw">const</span> json <span class="op">=</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(result)<span class="op">;</span></span>
<span id="cb44-30"><a href="#cb44-30"></a>    </span>
<span id="cb44-31"><a href="#cb44-31"></a>    <span class="co">// Set CORS headers</span></span>
<span id="cb44-32"><a href="#cb44-32"></a>    <span class="kw">const</span> output <span class="op">=</span> ContentService<span class="op">.</span><span class="fu">createTextOutput</span>(json)<span class="op">.</span><span class="fu">setMimeType</span>(ContentService<span class="op">.</span><span class="at">MimeType</span><span class="op">.</span><span class="at">JSON</span>)<span class="op">;</span></span>
<span id="cb44-33"><a href="#cb44-33"></a>    </span>
<span id="cb44-34"><a href="#cb44-34"></a>    <span class="cf">return</span> output<span class="op">;</span></span>
<span id="cb44-35"><a href="#cb44-35"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb44-36"><a href="#cb44-36"></a>    Logger<span class="op">.</span><span class="fu">log</span>(<span class="st">'Error: '</span> <span class="op">+</span> error<span class="op">.</span><span class="at">message</span>)<span class="op">;</span></span>
<span id="cb44-37"><a href="#cb44-37"></a>    <span class="cf">return</span> ContentService<span class="op">.</span><span class="fu">createTextOutput</span>(<span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({ <span class="dt">error</span><span class="op">:</span> error<span class="op">.</span><span class="at">message</span> }))<span class="op">.</span><span class="fu">setMimeType</span>(ContentService<span class="op">.</span><span class="at">MimeType</span><span class="op">.</span><span class="at">JSON</span>)<span class="op">;</span></span>
<span id="cb44-38"><a href="#cb44-38"></a>  }</span>
<span id="cb44-39"><a href="#cb44-39"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol type="1">
<li><p><strong>Deploy the script</strong> as a web app:</p>
<ul>
<li><p>Click on the “Deploy” button.</p></li>
<li><p>Choose “Manage Deployments”.</p></li>
<li><p>Click “New Deployment”.</p></li>
<li><p>Select “Web app”.</p></li>
<li><p>Set “Execute the app as” to “Me” and “Who has access” to “Anyone”.</p></li>
</ul></li>
</ol>
<p>And then finally use the web app URL in my client-side code. Note that I tried fetching it manually, but got a:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode numberSource plaintext number-lines code-with-copy"><code class="sourceCode"><span id="cb45-1"><a href="#cb45-1"></a>Access to fetch at 'https://docs.google.com/spreadsheets/d/1n4iZYfgdhv08PeREqz26F4-eQYfnXdHaSQywnQ8UYWk/gviz/tq?tqx=out:json&amp;sheet=Sheet1&amp;range=A:E' from origin 'null' has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource. If an opaque response serves your needs, set the request's mode to 'no-cors' to fetch the resource with CORS disabled.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Latest sensor reading Google Sheets(button loads latest data):</p>
<div>
<!-- Google Sheets Data Display -->
<section>
    <h2 class="anchored">Google Sheets Data Display</h2>
    <button class="load-button" onclick="loadLastRowGoogle()">Load Google Sheets Data</button>
    
<table id="google-data-table" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th">Time</th>
<th data-quarto-table-cell-role="th">Humidity %</th>
<th data-quarto-table-cell-role="th">Temp F</th>
<th data-quarto-table-cell-role="th">Temp C</th>
</tr>
</thead>
<tbody>
</tbody>
</table>

</section>
<script>
    async function loadLastRowGoogle() {
        const url = 'https://script.google.com/macros/s/AKfycbxs1lTq0o8Abb_iggM7yxQybOsWRAE_DPf7Gr4EE_ID9rSLonikadwaHlnzPlFwjOp3WQ/exec';

        try {
            console.log('Fetching data from URL:', url);
            const response = await fetch(url);
            console.log('Response status:', response.status);
            
            if (!response.ok) {
                throw new Error('Network response was not ok ' + response.statusText);
            }

            const json = await response.json();
            console.log('Fetched data:', json);
            
            if (json && json.length) {
                displayTableGoogle(json);
            } else {
                console.log('No data found.');
            }
        } catch (error) {
            console.error("Error fetching data from Google Sheets:", error);
        }
    }

    function displayTableGoogle(row) {
        console.log('Displaying data in Google Sheets table:', row);
        const table = document.getElementById('google-data-table');
        const tbody = table.querySelector('tbody');
        const newRow = tbody.insertRow();
        newRow.id = 'google-data-table-row';

        row.forEach((cell, index) => {
            const newCell = newRow.insertCell();
            newCell.id = `google-data-table-cell-${index + 1}`;
            const text = document.createTextNode(cell);
            newCell.appendChild(text);
        });
    }
</script>
<style>
    #google-data-table {
        width: 50%;
        border-collapse: collapse;
        margin: 50px auto;
    }
    #google-data-table th, #google-data-table td {
        padding: 10px;
        border: 1px solid #ddd;
        text-align: center;
    }
    #google-data-table th {
        background-color: #f2f2f2;
    }
    .load-button {
        display: block;
        margin: 20px auto;
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
    }
</style>
</div>
<p>Latest Sensor Reading ThingSpeak(press button):</p>
<div>
<!-- ThingSpeak Data Display -->
<section>
    <h2 class="anchored">ThingSpeak Data Display</h2>
    <button class="load-button" onclick="loadThingSpeakData()">Load ThingSpeak Data</button>
    
<table id="thingspeak-data-table" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th">Time</th>
<th data-quarto-table-cell-role="th">Humidity %</th>
<th data-quarto-table-cell-role="th">Temp F</th>
<th data-quarto-table-cell-role="th">Temp C</th>
</tr>
</thead>
<tbody>
</tbody>
</table>

</section>

<script>
    async function loadThingSpeakData() {
        const url = 'https://api.thingspeak.com/channels/2545447/feeds.json?results=1';

        try {
            const response = await fetch(url);
            const json = await response.json();
            if (json.feeds && json.feeds.length) {
                const lastFeed = json.feeds[json.feeds.length - 1];
                displayTableThingSpeak(lastFeed);
            } else {
                console.log('No data found.');
            }
        } catch (error) {
            console.error("Error fetching data from ThingSpeak:", error);
        }
    }

    function displayTableThingSpeak(feed) {
        const table = document.getElementById('thingspeak-data-table');
        const tbody = table.querySelector('tbody');
        const newRow = tbody.insertRow();
        newRow.id = 'thingspeak-data-table-row';

        const fields = ['field5', 'field4', 'field3', 'field2', 'field1'];
        fields.forEach((field) => {
            const newCell = newRow.insertCell();
            newCell.id = `thingspeak-data-table-cell-${field}`;
            const text = document.createTextNode(feed[field] || '');
            newCell.appendChild(text);
        });
    }
</script>

<style>
    #thingspeak-data-table {
        width: 50%;
        border-collapse: collapse;
        margin: 50px auto;
    }
    #thingspeak-data-table th, #thingspeak-data-table td {
        padding: 10px;
        border: 1px solid #ddd;
        text-align: center;
    }
    #thingspeak-data-table th {
        background-color: #f2f2f2;
    }
    .load-button {
        display: block;
        margin: 20px auto;
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
    }
</style>
</div>
<p>Configuring MongoDB to grab the sensor readings and the CSV required me to do quite a bit of configuring of Vercel(timeout increase) and making sure that the MongoDB was no longer using fixed IP addresses(I’m not implementing some cursed dynamic IP allocation). I also implement a 3 second wait just in case there’s a lot of requests/readers(unlikely).</p>
<p>Latest Sensor Reading MongoDB(Read-Only User):</p>
<div>
<!-- MongoDB Data Display -->
<section>
    <h2 class="anchored">MongoDB Data Display</h2>
    <a href="https://vercel-raspberry-pi-server.vercel.app/api/displaySQLMongoDB">Download MongoDB Table Data as CSV</a>
    <button class="load-button" onclick="loadMongoDBData()">Load MongoDB Data</button>
    
<table id="mongodb-data-table" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th">Time</th>
<th data-quarto-table-cell-role="th">Humidity %</th>
<th data-quarto-table-cell-role="th">Temp F</th>
<th data-quarto-table-cell-role="th">Temp C</th>
</tr>
</thead>
<tbody>
</tbody>
</table>

</section>
<script>
    async function loadMongoDBData() {
        const url = 'https://vercel-raspberry-pi-server.vercel.app/api/displayLastRowSQLMongoDB';

        try {
            const response = await fetch(url);
            const json = await response.json();
            if (json) {
                setTimeout(() => displayTableMongo(json), 3000); // Wait for 3 seconds before populating the table
            } else {
                console.log('No data found.');
            }
        } catch (error) {
            console.error("Error fetching data:", error);
        }
    }

    function displayTableMongo(data) {
        const table = document.getElementById('mongodb-data-table');
        const tbody = table.querySelector('tbody');
        const newRow = tbody.insertRow();

        const fields = ['date', 'time', 'humidityPercent', 'temperatureFahrenheit', 'temperatureCelsius'];
        fields.forEach((field) => {
            const newCell = newRow.insertCell();
            newCell.id = `mongodb-data-table-cell-${field}`;
            const text = document.createTextNode(data[field] || '');
            newCell.appendChild(text);
        });
    }
</script>
<style>
    #mongodb-data-table {
        width: 50%;
        border-collapse: collapse;
        margin: 50px auto;
    }
    #mongodb-data-table th, #mongodb-data-table td {
        padding: 10px;
        border: 1px solid #ddd;
        text-align: center;
    }
    #mongodb-data-table th {
        background-color: #f2f2f2;
    }
    .load-button {
        display: block;
        margin: 20px auto;
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
    }
</style>
</div>
<p>Latest Sensor Reading Vercel PostgreSQL(Read-Only User):</p>
<div>
<!-- Vercel Data Display -->
<section>
    <h2 class="anchored">Vercel Data Display</h2>
    <a href="https://vercel-raspberry-pi-server.vercel.app/api/displaySQL">Download Vercel Table Data as CSV</a>
    <button class="load-button" onclick="loadVercelData()">Load Vercel Data</button>
    
<table id="vercel-data-table" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th">Time</th>
<th data-quarto-table-cell-role="th">Humidity %</th>
<th data-quarto-table-cell-role="th">Temp F</th>
<th data-quarto-table-cell-role="th">Temp C</th>
</tr>
</thead>
<tbody>
</tbody>
</table>

</section>
<script>
    async function loadVercelData() {
        const url = 'https://vercel-raspberry-pi-server.vercel.app/api/displayLastRowSQL';

        try {
            const response = await fetch(url);
            const json = await response.json();
            if (json) {
                setTimeout(() => displayTableVercel(json), 3000); // Wait for 3 seconds before populating the table
            } else {
                console.log('No data found.');
            }
        } catch (error) {
            console.error("Error fetching data:", error);
        }
    }

    function displayTableVercel(data) {
        const table = document.getElementById('vercel-data-table');
        const tbody = table.querySelector('tbody');
        const newRow = tbody.insertRow();

        const fields = ['date', 'time', 'humiditypercent', 'temperaturefahrenheit', 'temperaturecelsius'];
        fields.forEach((field) => {
            const newCell = newRow.insertCell();
            newCell.id = `vercel-data-table-cell-${field}`;
            const text = document.createTextNode(data[field] || '');
            newCell.appendChild(text);
        });
    }
</script>
<style>
    #vercel-data-table {
        width: 50%;
        border-collapse: collapse;
        margin: 50px auto;
    }
    #vercel-data-table th, #vercel-data-table td {
        padding: 10px;
        border: 1px solid #ddd;
        text-align: center;
    }
    #vercel-data-table th {
        background-color: #f2f2f2;
    }
    .load-button {
        display: block;
        margin: 20px auto;
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
    }
</style>
</div>
<p>Final Python Script on the off chance something changed:</p>
<p><strong><em>*Note you can run with this pretty easily, change the flags to True for whatever “database” you’re using.</em></strong>*</p>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb46"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1"></a><span class="im">import</span> os</span>
<span id="cb46-2"><a href="#cb46-2"></a><span class="im">import</span> time <span class="im">as</span> time_module</span>
<span id="cb46-3"><a href="#cb46-3"></a><span class="im">import</span> requests</span>
<span id="cb46-4"><a href="#cb46-4"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb46-5"><a href="#cb46-5"></a><span class="im">import</span> random</span>
<span id="cb46-6"><a href="#cb46-6"></a><span class="im">import</span> json</span>
<span id="cb46-7"><a href="#cb46-7"></a><span class="im">import</span> subprocess</span>
<span id="cb46-8"><a href="#cb46-8"></a><span class="im">import</span> Adafruit_DHT</span>
<span id="cb46-9"><a href="#cb46-9"></a><span class="im">from</span> pymongo <span class="im">import</span> MongoClient</span>
<span id="cb46-10"><a href="#cb46-10"></a><span class="im">from</span> google.auth.transport.requests <span class="im">import</span> Request</span>
<span id="cb46-11"><a href="#cb46-11"></a><span class="im">from</span> google.oauth2.credentials <span class="im">import</span> Credentials</span>
<span id="cb46-12"><a href="#cb46-12"></a><span class="im">from</span> google_auth_oauthlib.flow <span class="im">import</span> InstalledAppFlow</span>
<span id="cb46-13"><a href="#cb46-13"></a><span class="im">from</span> googleapiclient.discovery <span class="im">import</span> build</span>
<span id="cb46-14"><a href="#cb46-14"></a><span class="im">from</span> googleapiclient.errors <span class="im">import</span> HttpError</span>
<span id="cb46-15"><a href="#cb46-15"></a></span>
<span id="cb46-16"><a href="#cb46-16"></a><span class="co"># Control flags</span></span>
<span id="cb46-17"><a href="#cb46-17"></a>SEND_TO_VERCEL <span class="op">=</span> <span class="va">True</span></span>
<span id="cb46-18"><a href="#cb46-18"></a>SEND_TO_GOOGLE_SHEETS <span class="op">=</span> <span class="va">True</span></span>
<span id="cb46-19"><a href="#cb46-19"></a>SEND_TO_THINGSPEAK <span class="op">=</span> <span class="va">True</span></span>
<span id="cb46-20"><a href="#cb46-20"></a>SEND_TO_MONGODB <span class="op">=</span> <span class="va">True</span></span>
<span id="cb46-21"><a href="#cb46-21"></a></span>
<span id="cb46-22"><a href="#cb46-22"></a><span class="co"># ThingSpeak API settings</span></span>
<span id="cb46-23"><a href="#cb46-23"></a>THINGSPEAK_API_KEY <span class="op">=</span> <span class="st">'YOUR-THINGSPEAK-API-KEY'</span>  <span class="co"># Replace with your ThingSpeak API key</span></span>
<span id="cb46-24"><a href="#cb46-24"></a></span>
<span id="cb46-25"><a href="#cb46-25"></a>THINGSPEAK_BASE_URL <span class="op">=</span> <span class="st">'https://api.thingspeak.com/update'</span></span>
<span id="cb46-26"><a href="#cb46-26"></a>THINGSPEAK_CHANNEL_ID <span class="op">=</span> <span class="dv">00000000</span> <span class="co">#CHANGE ME</span></span>
<span id="cb46-27"><a href="#cb46-27"></a>THINGSPEAK_BULK_UPDATE_URL <span class="op">=</span> <span class="st">'https://api.thingspeak.com/channels/'</span><span class="op">+</span><span class="bu">str</span>(THINGSPEAK_CHANNEL_ID)<span class="op">+</span><span class="st">'/bulk_update.json'</span></span>
<span id="cb46-28"><a href="#cb46-28"></a><span class="bu">print</span>(THINGSPEAK_BULK_UPDATE_URL)</span>
<span id="cb46-29"><a href="#cb46-29"></a></span>
<span id="cb46-30"><a href="#cb46-30"></a>VERCEL_API_KEY <span class="op">=</span> <span class="st">'YOUR-VERCEL-API-KEY'</span></span>
<span id="cb46-31"><a href="#cb46-31"></a></span>
<span id="cb46-32"><a href="#cb46-32"></a>MONGODB_URI <span class="op">=</span> <span class="st">'mongodb+srv://&lt;USERNAME&gt;:&lt;PASSWORD&gt;@cluster0.YOUR-URL.mongodb.net'</span></span>
<span id="cb46-33"><a href="#cb46-33"></a>MONGODB_DB_NAME <span class="op">=</span> <span class="st">'Raspberry_Pi'</span></span>
<span id="cb46-34"><a href="#cb46-34"></a>MONGODB_COLLECTION_NAME <span class="op">=</span> <span class="st">'Readings'</span></span>
<span id="cb46-35"><a href="#cb46-35"></a><span class="co"># Sensor setup</span></span>
<span id="cb46-36"><a href="#cb46-36"></a>SENSOR <span class="op">=</span> Adafruit_DHT.DHT11  <span class="co"># Using DHT11 sensor</span></span>
<span id="cb46-37"><a href="#cb46-37"></a>PIN <span class="op">=</span> <span class="dv">4</span>  <span class="co"># Change this to the GPIO pin number that the sensor is connected to</span></span>
<span id="cb46-38"><a href="#cb46-38"></a></span>
<span id="cb46-39"><a href="#cb46-39"></a><span class="co"># Vercel endpoint URL</span></span>
<span id="cb46-40"><a href="#cb46-40"></a>URL <span class="op">=</span> <span class="st">'https://YOUR-VERCEL-URL.vercel.app/api/sensor'</span></span>
<span id="cb46-41"><a href="#cb46-41"></a></span>
<span id="cb46-42"><a href="#cb46-42"></a><span class="co"># Buffer to store data</span></span>
<span id="cb46-43"><a href="#cb46-43"></a>data_buffer_vercel <span class="op">=</span> []</span>
<span id="cb46-44"><a href="#cb46-44"></a>data_buffer_mongodb <span class="op">=</span> []</span>
<span id="cb46-45"><a href="#cb46-45"></a>thingspeak_buffer <span class="op">=</span> []  <span class="co"># Buffer for ThingSpeak data</span></span>
<span id="cb46-46"><a href="#cb46-46"></a></span>
<span id="cb46-47"><a href="#cb46-47"></a><span class="co"># Define loop time in seconds</span></span>
<span id="cb46-48"><a href="#cb46-48"></a>LOOP_TIME <span class="op">=</span> <span class="dv">1</span>  <span class="co"># You can change this to the desired loop time in seconds</span></span>
<span id="cb46-49"><a href="#cb46-49"></a></span>
<span id="cb46-50"><a href="#cb46-50"></a><span class="co"># Define the scopes required for the Google Sheets and Drive APIs</span></span>
<span id="cb46-51"><a href="#cb46-51"></a>SCOPES <span class="op">=</span> [</span>
<span id="cb46-52"><a href="#cb46-52"></a>    <span class="st">'https://www.googleapis.com/auth/spreadsheets'</span>,</span>
<span id="cb46-53"><a href="#cb46-53"></a>    <span class="st">'https://www.googleapis.com/auth/drive.file'</span></span>
<span id="cb46-54"><a href="#cb46-54"></a>]</span>
<span id="cb46-55"><a href="#cb46-55"></a></span>
<span id="cb46-56"><a href="#cb46-56"></a><span class="co"># Global variable to hold credentials</span></span>
<span id="cb46-57"><a href="#cb46-57"></a>creds <span class="op">=</span> <span class="va">None</span></span>
<span id="cb46-58"><a href="#cb46-58"></a></span>
<span id="cb46-59"><a href="#cb46-59"></a><span class="co"># Function to get authenticated Sheets service</span></span>
<span id="cb46-60"><a href="#cb46-60"></a><span class="kw">def</span> get_sheets_service():</span>
<span id="cb46-61"><a href="#cb46-61"></a>    <span class="kw">global</span> creds</span>
<span id="cb46-62"><a href="#cb46-62"></a>    <span class="cf">if</span> os.path.exists(<span class="st">'token.json'</span>):</span>
<span id="cb46-63"><a href="#cb46-63"></a>        creds <span class="op">=</span> Credentials.from_authorized_user_file(<span class="st">'token.json'</span>, SCOPES)</span>
<span id="cb46-64"><a href="#cb46-64"></a>    <span class="cf">if</span> <span class="kw">not</span> creds <span class="kw">or</span> <span class="kw">not</span> creds.valid:</span>
<span id="cb46-65"><a href="#cb46-65"></a>        <span class="cf">if</span> creds <span class="kw">and</span> creds.expired <span class="kw">and</span> creds.refresh_token:</span>
<span id="cb46-66"><a href="#cb46-66"></a>            creds.refresh(Request())</span>
<span id="cb46-67"><a href="#cb46-67"></a>        <span class="cf">else</span>:</span>
<span id="cb46-68"><a href="#cb46-68"></a>            flow <span class="op">=</span> InstalledAppFlow.from_client_secrets_file(<span class="st">'credentials.json'</span>, SCOPES)</span>
<span id="cb46-69"><a href="#cb46-69"></a>            creds <span class="op">=</span> flow.run_local_server(port<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb46-70"><a href="#cb46-70"></a>        <span class="cf">with</span> <span class="bu">open</span>(<span class="st">'token.json'</span>, <span class="st">'w'</span>) <span class="im">as</span> token:</span>
<span id="cb46-71"><a href="#cb46-71"></a>            token.write(creds.to_json())</span>
<span id="cb46-72"><a href="#cb46-72"></a>    <span class="cf">return</span> build(<span class="st">'sheets'</span>, <span class="st">'v4'</span>, credentials<span class="op">=</span>creds)</span>
<span id="cb46-73"><a href="#cb46-73"></a></span>
<span id="cb46-74"><a href="#cb46-74"></a><span class="co"># Function to get authenticated Drive service</span></span>
<span id="cb46-75"><a href="#cb46-75"></a><span class="kw">def</span> get_drive_service():</span>
<span id="cb46-76"><a href="#cb46-76"></a>    <span class="kw">global</span> creds</span>
<span id="cb46-77"><a href="#cb46-77"></a>    <span class="cf">if</span> creds <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb46-78"><a href="#cb46-78"></a>        get_sheets_service()  <span class="co"># This will initialize creds</span></span>
<span id="cb46-79"><a href="#cb46-79"></a>    <span class="cf">return</span> build(<span class="st">'drive'</span>, <span class="st">'v3'</span>, credentials<span class="op">=</span>creds)</span>
<span id="cb46-80"><a href="#cb46-80"></a></span>
<span id="cb46-81"><a href="#cb46-81"></a><span class="co"># Function to set a Google Sheet's permissions to public</span></span>
<span id="cb46-82"><a href="#cb46-82"></a><span class="kw">def</span> set_sheet_public(spreadsheet_id):</span>
<span id="cb46-83"><a href="#cb46-83"></a>    drive_service <span class="op">=</span> get_drive_service()</span>
<span id="cb46-84"><a href="#cb46-84"></a>    permission <span class="op">=</span> {</span>
<span id="cb46-85"><a href="#cb46-85"></a>        <span class="st">'type'</span>: <span class="st">'anyone'</span>,</span>
<span id="cb46-86"><a href="#cb46-86"></a>        <span class="st">'role'</span>: <span class="st">'reader'</span></span>
<span id="cb46-87"><a href="#cb46-87"></a>    }</span>
<span id="cb46-88"><a href="#cb46-88"></a>    <span class="cf">try</span>:</span>
<span id="cb46-89"><a href="#cb46-89"></a>        drive_service.permissions().create(fileId<span class="op">=</span>spreadsheet_id, body<span class="op">=</span>permission).execute()</span>
<span id="cb46-90"><a href="#cb46-90"></a>        <span class="bu">print</span>(<span class="ss">f"Set spreadsheet with ID </span><span class="sc">{</span>spreadsheet_id<span class="sc">}</span><span class="ss"> to public"</span>)</span>
<span id="cb46-91"><a href="#cb46-91"></a>    <span class="cf">except</span> HttpError <span class="im">as</span> error:</span>
<span id="cb46-92"><a href="#cb46-92"></a>        <span class="bu">print</span>(<span class="ss">f"An error occurred: </span><span class="sc">{</span>error<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb46-93"><a href="#cb46-93"></a></span>
<span id="cb46-94"><a href="#cb46-94"></a><span class="co"># Function to create a new Google Sheet with a given name</span></span>
<span id="cb46-95"><a href="#cb46-95"></a><span class="kw">def</span> create_new_sheet(sheet_name):</span>
<span id="cb46-96"><a href="#cb46-96"></a>    service <span class="op">=</span> get_sheets_service()</span>
<span id="cb46-97"><a href="#cb46-97"></a>    spreadsheet <span class="op">=</span> {</span>
<span id="cb46-98"><a href="#cb46-98"></a>        <span class="st">'properties'</span>: {</span>
<span id="cb46-99"><a href="#cb46-99"></a>            <span class="st">'title'</span>: sheet_name</span>
<span id="cb46-100"><a href="#cb46-100"></a>        }</span>
<span id="cb46-101"><a href="#cb46-101"></a>    }</span>
<span id="cb46-102"><a href="#cb46-102"></a>    spreadsheet <span class="op">=</span> service.spreadsheets().create(body<span class="op">=</span>spreadsheet, fields<span class="op">=</span><span class="st">'spreadsheetId'</span>).execute()</span>
<span id="cb46-103"><a href="#cb46-103"></a>    spreadsheet_id <span class="op">=</span> spreadsheet.get(<span class="st">'spreadsheetId'</span>)</span>
<span id="cb46-104"><a href="#cb46-104"></a>    <span class="bu">print</span>(<span class="ss">f"Created new spreadsheet with ID: </span><span class="sc">{</span>spreadsheet_id<span class="sc">}</span><span class="ss">, Name: </span><span class="sc">{</span>sheet_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb46-105"><a href="#cb46-105"></a></span>
<span id="cb46-106"><a href="#cb46-106"></a>    <span class="co"># Set the new sheet to be publicly viewable</span></span>
<span id="cb46-107"><a href="#cb46-107"></a>    set_sheet_public(spreadsheet_id)</span>
<span id="cb46-108"><a href="#cb46-108"></a></span>
<span id="cb46-109"><a href="#cb46-109"></a>    <span class="co"># Save the new spreadsheet info</span></span>
<span id="cb46-110"><a href="#cb46-110"></a>    save_spreadsheet_info(spreadsheet_id, sheet_name, <span class="st">"Sheet1"</span>)</span>
<span id="cb46-111"><a href="#cb46-111"></a></span>
<span id="cb46-112"><a href="#cb46-112"></a>    <span class="cf">return</span> spreadsheet_id</span>
<span id="cb46-113"><a href="#cb46-113"></a></span>
<span id="cb46-114"><a href="#cb46-114"></a><span class="co"># Function to check the number of cells in the Google Sheet and create a new one if it doesn't exist</span></span>
<span id="cb46-115"><a href="#cb46-115"></a><span class="kw">def</span> check_sheet_size(spreadsheet_id, new_sheet_name):</span>
<span id="cb46-116"><a href="#cb46-116"></a>    service <span class="op">=</span> get_sheets_service()</span>
<span id="cb46-117"><a href="#cb46-117"></a>    <span class="cf">try</span>:</span>
<span id="cb46-118"><a href="#cb46-118"></a>        sheet <span class="op">=</span> service.spreadsheets().get(spreadsheetId<span class="op">=</span>spreadsheet_id).execute()</span>
<span id="cb46-119"><a href="#cb46-119"></a>        sheets <span class="op">=</span> sheet.get(<span class="st">'sheets'</span>, [])</span>
<span id="cb46-120"><a href="#cb46-120"></a>    <span class="cf">except</span> HttpError <span class="im">as</span> e:</span>
<span id="cb46-121"><a href="#cb46-121"></a>        <span class="bu">print</span>(<span class="ss">f"HttpError encountered: Status code: </span><span class="sc">{</span>e<span class="sc">.</span>resp<span class="sc">.</span>status<span class="sc">}</span><span class="ss">, Reason: </span><span class="sc">{</span>e<span class="sc">.</span>error_details<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb46-122"><a href="#cb46-122"></a>        <span class="cf">if</span> e.resp.status <span class="op">==</span> <span class="dv">404</span>:</span>
<span id="cb46-123"><a href="#cb46-123"></a>            <span class="bu">print</span>(<span class="ss">f"Spreadsheet with ID '</span><span class="sc">{</span>spreadsheet_id<span class="sc">}</span><span class="ss">' not found. Creating a new sheet."</span>)</span>
<span id="cb46-124"><a href="#cb46-124"></a>            <span class="cf">return</span> create_new_sheet(new_sheet_name), <span class="dv">0</span></span>
<span id="cb46-125"><a href="#cb46-125"></a>        <span class="cf">else</span>:</span>
<span id="cb46-126"><a href="#cb46-126"></a>            <span class="cf">raise</span></span>
<span id="cb46-127"><a href="#cb46-127"></a></span>
<span id="cb46-128"><a href="#cb46-128"></a>    total_cells <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb46-129"><a href="#cb46-129"></a>    <span class="cf">for</span> sheet <span class="kw">in</span> sheets:</span>
<span id="cb46-130"><a href="#cb46-130"></a>        properties <span class="op">=</span> sheet.get(<span class="st">'properties'</span>, {})</span>
<span id="cb46-131"><a href="#cb46-131"></a>        grid_properties <span class="op">=</span> properties.get(<span class="st">'gridProperties'</span>, {})</span>
<span id="cb46-132"><a href="#cb46-132"></a>        rows <span class="op">=</span> grid_properties.get(<span class="st">'rowCount'</span>, <span class="dv">0</span>)</span>
<span id="cb46-133"><a href="#cb46-133"></a>        cols <span class="op">=</span> grid_properties.get(<span class="st">'columnCount'</span>, <span class="dv">0</span>)</span>
<span id="cb46-134"><a href="#cb46-134"></a>        total_cells <span class="op">+=</span> rows <span class="op">*</span> cols</span>
<span id="cb46-135"><a href="#cb46-135"></a></span>
<span id="cb46-136"><a href="#cb46-136"></a>    <span class="cf">return</span> spreadsheet_id, total_cells</span>
<span id="cb46-137"><a href="#cb46-137"></a></span>
<span id="cb46-138"><a href="#cb46-138"></a><span class="co"># Function to find the last empty row in the Google Sheet</span></span>
<span id="cb46-139"><a href="#cb46-139"></a><span class="kw">def</span> find_last_empty_row(service, spreadsheet_id, sheet_name,i):</span>
<span id="cb46-140"><a href="#cb46-140"></a>    max_retries <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb46-141"><a href="#cb46-141"></a>    retry_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb46-142"><a href="#cb46-142"></a>    backoff_factor <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb46-143"><a href="#cb46-143"></a></span>
<span id="cb46-144"><a href="#cb46-144"></a>    range_name <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>sheet_name<span class="sc">}</span><span class="ss">!A:A"</span></span>
<span id="cb46-145"><a href="#cb46-145"></a></span>
<span id="cb46-146"><a href="#cb46-146"></a>    <span class="cf">while</span> retry_count <span class="op">&lt;</span> max_retries:</span>
<span id="cb46-147"><a href="#cb46-147"></a>        <span class="cf">try</span>:</span>
<span id="cb46-148"><a href="#cb46-148"></a>            result <span class="op">=</span> service.spreadsheets().values().get(</span>
<span id="cb46-149"><a href="#cb46-149"></a>                spreadsheetId<span class="op">=</span>spreadsheet_id,</span>
<span id="cb46-150"><a href="#cb46-150"></a>                <span class="bu">range</span><span class="op">=</span>range_name</span>
<span id="cb46-151"><a href="#cb46-151"></a>            ).execute()</span>
<span id="cb46-152"><a href="#cb46-152"></a></span>
<span id="cb46-153"><a href="#cb46-153"></a>            values <span class="op">=</span> result.get(<span class="st">'values'</span>, [])</span>
<span id="cb46-154"><a href="#cb46-154"></a>            <span class="cf">if</span> i<span class="op">%</span><span class="dv">15</span><span class="op">==</span><span class="dv">0</span>:</span>
<span id="cb46-155"><a href="#cb46-155"></a>                <span class="bu">print</span>(<span class="ss">f"Debug Google - Number of rows in column A: </span><span class="sc">{</span><span class="bu">len</span>(values)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb46-156"><a href="#cb46-156"></a>            <span class="cf">return</span> <span class="bu">len</span>(values) <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb46-157"><a href="#cb46-157"></a>        <span class="cf">except</span> HttpError <span class="im">as</span> e:</span>
<span id="cb46-158"><a href="#cb46-158"></a>            <span class="cf">if</span> e.resp.status <span class="kw">in</span> [<span class="dv">500</span>, <span class="dv">503</span>]:</span>
<span id="cb46-159"><a href="#cb46-159"></a>                retry_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb46-160"><a href="#cb46-160"></a>                sleep_time <span class="op">=</span> backoff_factor <span class="op">**</span> retry_count <span class="op">+</span> random.uniform(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb46-161"><a href="#cb46-161"></a>                <span class="bu">print</span>(<span class="ss">f"HttpError </span><span class="sc">{</span>e<span class="sc">.</span>resp<span class="sc">.</span>status<span class="sc">}</span><span class="ss"> encountered. Retrying in </span><span class="sc">{</span>sleep_time<span class="sc">:.1f}</span><span class="ss"> seconds..."</span>)</span>
<span id="cb46-162"><a href="#cb46-162"></a>                time.sleep(sleep_time)</span>
<span id="cb46-163"><a href="#cb46-163"></a>            <span class="cf">else</span>:</span>
<span id="cb46-164"><a href="#cb46-164"></a>                <span class="cf">raise</span></span>
<span id="cb46-165"><a href="#cb46-165"></a>    <span class="cf">raise</span> <span class="pp">Exception</span>(<span class="st">"Failed to retrieve last empty row after several retries"</span>)</span>
<span id="cb46-166"><a href="#cb46-166"></a></span>
<span id="cb46-167"><a href="#cb46-167"></a><span class="co"># Function to append data to a Google Sheet</span></span>
<span id="cb46-168"><a href="#cb46-168"></a><span class="kw">def</span> append_data_to_sheet(spreadsheet_id, sheet_name, values,i):</span>
<span id="cb46-169"><a href="#cb46-169"></a>    <span class="cf">if</span> SEND_TO_GOOGLE_SHEETS:</span>
<span id="cb46-170"><a href="#cb46-170"></a>        service <span class="op">=</span> get_sheets_service()</span>
<span id="cb46-171"><a href="#cb46-171"></a>        last_empty_row <span class="op">=</span> find_last_empty_row(service, spreadsheet_id, sheet_name,i)</span>
<span id="cb46-172"><a href="#cb46-172"></a>        range_name <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>sheet_name<span class="sc">}</span><span class="ss">!A</span><span class="sc">{</span>last_empty_row<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb46-173"><a href="#cb46-173"></a>        body <span class="op">=</span> {</span>
<span id="cb46-174"><a href="#cb46-174"></a>            <span class="st">'values'</span>: values</span>
<span id="cb46-175"><a href="#cb46-175"></a>        }</span>
<span id="cb46-176"><a href="#cb46-176"></a>        result <span class="op">=</span> service.spreadsheets().values().append(</span>
<span id="cb46-177"><a href="#cb46-177"></a>            spreadsheetId<span class="op">=</span>spreadsheet_id, <span class="bu">range</span><span class="op">=</span>range_name,</span>
<span id="cb46-178"><a href="#cb46-178"></a>            valueInputOption<span class="op">=</span><span class="st">'RAW'</span>, body<span class="op">=</span>body).execute()</span>
<span id="cb46-179"><a href="#cb46-179"></a>        <span class="cf">return</span> result</span>
<span id="cb46-180"><a href="#cb46-180"></a></span>
<span id="cb46-181"><a href="#cb46-181"></a><span class="co"># Function to send data to the server</span></span>
<span id="cb46-182"><a href="#cb46-182"></a><span class="kw">def</span> send_data_vercel(data):</span>
<span id="cb46-183"><a href="#cb46-183"></a>    <span class="co">"""Send data to the server."""</span></span>
<span id="cb46-184"><a href="#cb46-184"></a>    <span class="cf">if</span> SEND_TO_VERCEL:</span>
<span id="cb46-185"><a href="#cb46-185"></a>        <span class="cf">try</span>:</span>
<span id="cb46-186"><a href="#cb46-186"></a>            <span class="co"># Include API key in the headers</span></span>
<span id="cb46-187"><a href="#cb46-187"></a>            headers <span class="op">=</span> {<span class="st">'x-api-key'</span>: VERCEL_API_KEY}</span>
<span id="cb46-188"><a href="#cb46-188"></a>            <span class="bu">print</span>(data)</span>
<span id="cb46-189"><a href="#cb46-189"></a>            <span class="bu">print</span>(headers)</span>
<span id="cb46-190"><a href="#cb46-190"></a>            response <span class="op">=</span> requests.post(URL, json<span class="op">=</span>data, headers<span class="op">=</span>headers)</span>
<span id="cb46-191"><a href="#cb46-191"></a>            response.raise_for_status()</span>
<span id="cb46-192"><a href="#cb46-192"></a>            <span class="co">#print(data)</span></span>
<span id="cb46-193"><a href="#cb46-193"></a>            <span class="co">#print(headers)</span></span>
<span id="cb46-194"><a href="#cb46-194"></a>            <span class="bu">print</span>(<span class="ss">f"Data sent to Vercel server: </span><span class="sc">{</span>response<span class="sc">.</span>text<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb46-195"><a href="#cb46-195"></a>        <span class="cf">except</span> requests.exceptions.RequestException <span class="im">as</span> e:</span>
<span id="cb46-196"><a href="#cb46-196"></a>            <span class="bu">print</span>(<span class="ss">f"Failed to send data to server: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb46-197"><a href="#cb46-197"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb46-198"><a href="#cb46-198"></a>            <span class="bu">print</span>(<span class="ss">f"An unexpected error occurred: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb46-199"><a href="#cb46-199"></a><span class="co"># Function to send data to ThingSpeak</span></span>
<span id="cb46-200"><a href="#cb46-200"></a><span class="kw">def</span> thingspeak_update():</span>
<span id="cb46-201"><a href="#cb46-201"></a>    <span class="co">"""Send data to ThingSpeak."""</span></span>
<span id="cb46-202"><a href="#cb46-202"></a>    <span class="cf">if</span> SEND_TO_THINGSPEAK <span class="kw">and</span> thingspeak_buffer:</span>
<span id="cb46-203"><a href="#cb46-203"></a>        <span class="cf">if</span> <span class="bu">len</span>(thingspeak_buffer) <span class="op">&gt;</span> <span class="dv">1</span>:</span>
<span id="cb46-204"><a href="#cb46-204"></a>            <span class="co"># Bulk update</span></span>
<span id="cb46-205"><a href="#cb46-205"></a>            payload <span class="op">=</span> {</span>
<span id="cb46-206"><a href="#cb46-206"></a>                <span class="st">'write_api_key'</span>: THINGSPEAK_API_KEY,</span>
<span id="cb46-207"><a href="#cb46-207"></a>                <span class="st">'updates'</span>: []</span>
<span id="cb46-208"><a href="#cb46-208"></a>            }</span>
<span id="cb46-209"><a href="#cb46-209"></a>            <span class="co">#print(THINGSPEAK_API_KEY)</span></span>
<span id="cb46-210"><a href="#cb46-210"></a>            <span class="co"># Convert buffer data to the format required by ThingSpeak</span></span>
<span id="cb46-211"><a href="#cb46-211"></a>            </span>
<span id="cb46-212"><a href="#cb46-212"></a>            <span class="cf">for</span> data <span class="kw">in</span> thingspeak_buffer:</span>
<span id="cb46-213"><a href="#cb46-213"></a>                update <span class="op">=</span> {</span>
<span id="cb46-214"><a href="#cb46-214"></a>                    <span class="st">'created_at'</span>: <span class="ss">f"</span><span class="sc">{</span>data[<span class="st">'date'</span>]<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>data[<span class="st">'time'</span>]<span class="sc">}</span><span class="ss"> -0500"</span>,</span>
<span id="cb46-215"><a href="#cb46-215"></a>                    <span class="st">'field1'</span>: data[<span class="st">'temperature_C'</span>],</span>
<span id="cb46-216"><a href="#cb46-216"></a>                    <span class="st">'field2'</span>: data[<span class="st">'temperature_F'</span>],</span>
<span id="cb46-217"><a href="#cb46-217"></a>                    <span class="st">'field3'</span>: data[<span class="st">'humidityPercent'</span>],</span>
<span id="cb46-218"><a href="#cb46-218"></a>                    <span class="st">'field4'</span>: data[<span class="st">'time'</span>],</span>
<span id="cb46-219"><a href="#cb46-219"></a>                    <span class="st">'field5'</span>: data[<span class="st">'date'</span>]</span>
<span id="cb46-220"><a href="#cb46-220"></a>                }</span>
<span id="cb46-221"><a href="#cb46-221"></a>                payload[<span class="st">'updates'</span>].append(update)</span>
<span id="cb46-222"><a href="#cb46-222"></a></span>
<span id="cb46-223"><a href="#cb46-223"></a>            <span class="cf">try</span>:</span>
<span id="cb46-224"><a href="#cb46-224"></a>                <span class="co"># Send the bulk update request to ThingSpeak</span></span>
<span id="cb46-225"><a href="#cb46-225"></a>                headers <span class="op">=</span> {<span class="st">'Content-Type'</span>: <span class="st">'application/json'</span>}</span>
<span id="cb46-226"><a href="#cb46-226"></a>                <span class="co">#print(len(thingspeak_buffer))</span></span>
<span id="cb46-227"><a href="#cb46-227"></a>                <span class="co">#print(headers)</span></span>
<span id="cb46-228"><a href="#cb46-228"></a>                <span class="co">#print(json.dumps(payload))</span></span>
<span id="cb46-229"><a href="#cb46-229"></a>                <span class="co"># Convert the data payload to JSON format</span></span>
<span id="cb46-230"><a href="#cb46-230"></a>                json_data <span class="op">=</span> json.dumps(payload)</span>
<span id="cb46-231"><a href="#cb46-231"></a>                response <span class="op">=</span> requests.post(THINGSPEAK_BULK_UPDATE_URL,headers<span class="op">=</span>headers,data<span class="op">=</span>json_data)</span>
<span id="cb46-232"><a href="#cb46-232"></a>                <span class="cf">if</span> response.status_code <span class="op">==</span> <span class="dv">202</span>:</span>
<span id="cb46-233"><a href="#cb46-233"></a>                    <span class="bu">print</span>(<span class="st">'Data posted to ThingSpeak (bulk update):'</span>, response.text)</span>
<span id="cb46-234"><a href="#cb46-234"></a>                    thingspeak_buffer.clear()  <span class="co"># Clear the buffer after successful update</span></span>
<span id="cb46-235"><a href="#cb46-235"></a>                <span class="cf">else</span>:</span>
<span id="cb46-236"><a href="#cb46-236"></a>                    <span class="bu">print</span>(<span class="ss">f'Failed to send data to ThingSpeak (bulk update): </span><span class="sc">{</span>response<span class="sc">.</span>status_code<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>response<span class="sc">.</span>text<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb46-237"><a href="#cb46-237"></a>            <span class="cf">except</span> requests.exceptions.RequestException <span class="im">as</span> e:</span>
<span id="cb46-238"><a href="#cb46-238"></a>                <span class="bu">print</span>(<span class="st">'Failed to send data to ThingSpeak (bulk update):'</span>, e)</span>
<span id="cb46-239"><a href="#cb46-239"></a>        <span class="cf">else</span>:</span>
<span id="cb46-240"><a href="#cb46-240"></a>            <span class="co"># Simple update</span></span>
<span id="cb46-241"><a href="#cb46-241"></a>            data <span class="op">=</span> thingspeak_buffer[<span class="dv">0</span>]</span>
<span id="cb46-242"><a href="#cb46-242"></a>            payload <span class="op">=</span> {</span>
<span id="cb46-243"><a href="#cb46-243"></a>                <span class="st">'api_key'</span>: THINGSPEAK_API_KEY,</span>
<span id="cb46-244"><a href="#cb46-244"></a>                <span class="st">'field1'</span>: data[<span class="st">'temperature_C'</span>],</span>
<span id="cb46-245"><a href="#cb46-245"></a>                <span class="st">'field2'</span>: data[<span class="st">'temperature_F'</span>],</span>
<span id="cb46-246"><a href="#cb46-246"></a>                <span class="st">'field3'</span>: data[<span class="st">'humidityPercent'</span>],</span>
<span id="cb46-247"><a href="#cb46-247"></a>                <span class="st">'field4'</span>: data[<span class="st">'time'</span>],</span>
<span id="cb46-248"><a href="#cb46-248"></a>                <span class="st">'field5'</span>: data[<span class="st">'date'</span>],</span>
<span id="cb46-249"><a href="#cb46-249"></a>                <span class="st">'created_at'</span>: <span class="ss">f"</span><span class="sc">{</span>data[<span class="st">'date'</span>]<span class="sc">}</span><span class="ss">T</span><span class="sc">{</span>data[<span class="st">'time'</span>]<span class="sc">}</span><span class="ss">Z"</span></span>
<span id="cb46-250"><a href="#cb46-250"></a>            }</span>
<span id="cb46-251"><a href="#cb46-251"></a></span>
<span id="cb46-252"><a href="#cb46-252"></a>            <span class="cf">try</span>:</span>
<span id="cb46-253"><a href="#cb46-253"></a>                <span class="co"># Send the simple update request to ThingSpeak</span></span>
<span id="cb46-254"><a href="#cb46-254"></a>                headers <span class="op">=</span> {</span>
<span id="cb46-255"><a href="#cb46-255"></a>                    <span class="st">'User-Agent'</span>: <span class="st">'mw.doc.simple-update (Raspberry Pi)'</span>,</span>
<span id="cb46-256"><a href="#cb46-256"></a>                    <span class="st">'Content-Type'</span>: <span class="st">'application/x-www-form-urlencoded'</span></span>
<span id="cb46-257"><a href="#cb46-257"></a>                }</span>
<span id="cb46-258"><a href="#cb46-258"></a>                response <span class="op">=</span> requests.post(THINGSPEAK_BASE_URL, headers<span class="op">=</span>headers, params<span class="op">=</span>payload)</span>
<span id="cb46-259"><a href="#cb46-259"></a>                <span class="cf">if</span> response.status_code <span class="op">==</span> <span class="dv">200</span>:</span>
<span id="cb46-260"><a href="#cb46-260"></a>                    <span class="bu">print</span>(<span class="st">'Data posted to ThingSpeak (simple update):'</span>, response.text)</span>
<span id="cb46-261"><a href="#cb46-261"></a>                    thingspeak_buffer.clear()  <span class="co"># Clear the buffer after successful update</span></span>
<span id="cb46-262"><a href="#cb46-262"></a>                <span class="cf">else</span>:</span>
<span id="cb46-263"><a href="#cb46-263"></a>                    <span class="bu">print</span>(<span class="ss">f'Failed to send data to ThingSpeak (simple update): </span><span class="sc">{</span>response<span class="sc">.</span>status_code<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>response<span class="sc">.</span>text<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb46-264"><a href="#cb46-264"></a>            <span class="cf">except</span> requests.exceptions.RequestException <span class="im">as</span> e:</span>
<span id="cb46-265"><a href="#cb46-265"></a>                <span class="bu">print</span>(<span class="st">'Failed to send data to ThingSpeak (simple update):'</span>, e)</span>
<span id="cb46-266"><a href="#cb46-266"></a></span>
<span id="cb46-267"><a href="#cb46-267"></a><span class="co"># Function to send data to MongoDB</span></span>
<span id="cb46-268"><a href="#cb46-268"></a><span class="kw">def</span> send_data_mongodb(data_mongo):</span>
<span id="cb46-269"><a href="#cb46-269"></a>    <span class="co">"""Send data to MongoDB."""</span></span>
<span id="cb46-270"><a href="#cb46-270"></a>    <span class="cf">if</span> SEND_TO_MONGODB:</span>
<span id="cb46-271"><a href="#cb46-271"></a>        <span class="cf">try</span>:</span>
<span id="cb46-272"><a href="#cb46-272"></a>            client <span class="op">=</span> MongoClient(MONGODB_URI)</span>
<span id="cb46-273"><a href="#cb46-273"></a>            db <span class="op">=</span> client[MONGODB_DB_NAME]</span>
<span id="cb46-274"><a href="#cb46-274"></a>            collection <span class="op">=</span> db[MONGODB_COLLECTION_NAME]</span>
<span id="cb46-275"><a href="#cb46-275"></a>            result <span class="op">=</span> collection.insert_many(data_mongo)</span>
<span id="cb46-276"><a href="#cb46-276"></a>            <span class="bu">print</span>(<span class="ss">f"Data sent to MongoDB: </span><span class="sc">{</span>result<span class="sc">.</span>inserted_ids<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb46-277"><a href="#cb46-277"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb46-278"><a href="#cb46-278"></a>            <span class="bu">print</span>(<span class="ss">f"Failed to send data to MongoDB: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb46-279"><a href="#cb46-279"></a></span>
<span id="cb46-280"><a href="#cb46-280"></a><span class="co"># Function to initialize the current count of the index from MongoDB</span></span>
<span id="cb46-281"><a href="#cb46-281"></a><span class="co">#I was debating on introducing an index to make sure I knew what the current count of values was..</span></span>
<span id="cb46-282"><a href="#cb46-282"></a><span class="co">#But that seemed pretty wasteful.</span></span>
<span id="cb46-283"><a href="#cb46-283"></a><span class="co"># def initialize_index():</span></span>
<span id="cb46-284"><a href="#cb46-284"></a><span class="co">#     global index</span></span>
<span id="cb46-285"><a href="#cb46-285"></a><span class="co">#     try:</span></span>
<span id="cb46-286"><a href="#cb46-286"></a><span class="co">#         client = MongoClient(MONGODB_URI)</span></span>
<span id="cb46-287"><a href="#cb46-287"></a><span class="co">#         db = client[MONGODB_DB_NAME]</span></span>
<span id="cb46-288"><a href="#cb46-288"></a><span class="co">#         collection = db[MONGODB_COLLECTION_NAME]</span></span>
<span id="cb46-289"><a href="#cb46-289"></a><span class="co">#         last_entry = collection.find().sort([('_id', -1)]).limit(1)</span></span>
<span id="cb46-290"><a href="#cb46-290"></a><span class="co">#         if last_entry.count() &gt; 0:</span></span>
<span id="cb46-291"><a href="#cb46-291"></a><span class="co">#             index = last_entry[0].get('index', 0) + 1</span></span>
<span id="cb46-292"><a href="#cb46-292"></a><span class="co">#         else:</span></span>
<span id="cb46-293"><a href="#cb46-293"></a><span class="co">#             index = 1</span></span>
<span id="cb46-294"><a href="#cb46-294"></a><span class="co">#         print(f"Index initialized to {index}")</span></span>
<span id="cb46-295"><a href="#cb46-295"></a><span class="co">#     except Exception as e:</span></span>
<span id="cb46-296"><a href="#cb46-296"></a><span class="co">#         print(f"Failed to initialize index: {e}")</span></span>
<span id="cb46-297"><a href="#cb46-297"></a>        </span>
<span id="cb46-298"><a href="#cb46-298"></a><span class="co"># Function to save spreadsheet info to a file</span></span>
<span id="cb46-299"><a href="#cb46-299"></a><span class="kw">def</span> save_spreadsheet_info(spreadsheet_id, workbook_name, sheet_name):</span>
<span id="cb46-300"><a href="#cb46-300"></a>    info <span class="op">=</span> {</span>
<span id="cb46-301"><a href="#cb46-301"></a>        <span class="st">'spreadsheet_id'</span>: spreadsheet_id,</span>
<span id="cb46-302"><a href="#cb46-302"></a>        <span class="st">'workbook_name'</span>: workbook_name,</span>
<span id="cb46-303"><a href="#cb46-303"></a>        <span class="st">'sheet_name'</span>: sheet_name</span>
<span id="cb46-304"><a href="#cb46-304"></a>    }</span>
<span id="cb46-305"><a href="#cb46-305"></a>    <span class="cf">with</span> <span class="bu">open</span>(<span class="st">'spreadsheet_info.txt'</span>, <span class="st">'w'</span>) <span class="im">as</span> f:</span>
<span id="cb46-306"><a href="#cb46-306"></a>        json.dump(info, f)</span>
<span id="cb46-307"><a href="#cb46-307"></a></span>
<span id="cb46-308"><a href="#cb46-308"></a><span class="co"># Function to load spreadsheet info from a file</span></span>
<span id="cb46-309"><a href="#cb46-309"></a><span class="kw">def</span> load_spreadsheet_info():</span>
<span id="cb46-310"><a href="#cb46-310"></a>    <span class="cf">if</span> os.path.exists(<span class="st">'spreadsheet_info.txt'</span>):</span>
<span id="cb46-311"><a href="#cb46-311"></a>        <span class="cf">with</span> <span class="bu">open</span>(<span class="st">'spreadsheet_info.txt'</span>, <span class="st">'r'</span>) <span class="im">as</span> f:</span>
<span id="cb46-312"><a href="#cb46-312"></a>            info <span class="op">=</span> json.load(f)</span>
<span id="cb46-313"><a href="#cb46-313"></a>            <span class="cf">return</span> info[<span class="st">'spreadsheet_id'</span>], info[<span class="st">'workbook_name'</span>], info[<span class="st">'sheet_name'</span>]</span>
<span id="cb46-314"><a href="#cb46-314"></a>    <span class="cf">return</span> <span class="va">None</span>, <span class="va">None</span>, <span class="va">None</span></span>
<span id="cb46-315"><a href="#cb46-315"></a></span>
<span id="cb46-316"><a href="#cb46-316"></a><span class="kw">def</span> main():</span>
<span id="cb46-317"><a href="#cb46-317"></a>    <span class="co"># Load spreadsheet info from file</span></span>
<span id="cb46-318"><a href="#cb46-318"></a>    spreadsheet_id, workbook_name, sheet_name <span class="op">=</span> load_spreadsheet_info()</span>
<span id="cb46-319"><a href="#cb46-319"></a></span>
<span id="cb46-320"><a href="#cb46-320"></a>    <span class="cf">if</span> spreadsheet_id <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> workbook_name <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> sheet_name <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb46-321"><a href="#cb46-321"></a>        <span class="co"># Initialize new sheet if no info found</span></span>
<span id="cb46-322"><a href="#cb46-322"></a>        workbook_name <span class="op">=</span> <span class="st">'your-workbook-name'</span>  <span class="co"># Replace with your Google Sheet ID</span></span>
<span id="cb46-323"><a href="#cb46-323"></a>        spreadsheet_id <span class="op">=</span> <span class="st">'your-spreadsheet-id'</span>  <span class="co"># Replace with your Google Sheet ID</span></span>
<span id="cb46-324"><a href="#cb46-324"></a>        sheet_name <span class="op">=</span> <span class="st">'Sheet1'</span>  <span class="co"># Adjust the sheet name as needed</span></span>
<span id="cb46-325"><a href="#cb46-325"></a></span>
<span id="cb46-326"><a href="#cb46-326"></a>    max_cells <span class="op">=</span> <span class="dv">5000000</span></span>
<span id="cb46-327"><a href="#cb46-327"></a></span>
<span id="cb46-328"><a href="#cb46-328"></a>    <span class="co"># Initialize loop counter</span></span>
<span id="cb46-329"><a href="#cb46-329"></a>    i <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb46-330"><a href="#cb46-330"></a></span>
<span id="cb46-331"><a href="#cb46-331"></a>    <span class="co"># Get current date and time for the new sheet name if needed</span></span>
<span id="cb46-332"><a href="#cb46-332"></a>    current_time <span class="op">=</span> datetime.now().strftime(<span class="st">"%Y-%m-</span><span class="sc">%d</span><span class="st"> %H:%M:%S"</span>)</span>
<span id="cb46-333"><a href="#cb46-333"></a>    new_sheet_name <span class="op">=</span> <span class="ss">f"Pi-Sensor </span><span class="sc">{</span>current_time<span class="sc">}</span><span class="ss">"</span>  <span class="co"># New sheet name with date and time</span></span>
<span id="cb46-334"><a href="#cb46-334"></a>    </span>
<span id="cb46-335"><a href="#cb46-335"></a>    <span class="co"># Check sheet size and create new sheet if necessary</span></span>
<span id="cb46-336"><a href="#cb46-336"></a>    <span class="cf">if</span> SEND_TO_GOOGLE_SHEETS:</span>
<span id="cb46-337"><a href="#cb46-337"></a>        spreadsheet_id, total_cells <span class="op">=</span> check_sheet_size(spreadsheet_id, new_sheet_name)</span>
<span id="cb46-338"><a href="#cb46-338"></a>        <span class="bu">print</span>(<span class="ss">f"Total cells in the sheet: </span><span class="sc">{</span>total_cells<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb46-339"><a href="#cb46-339"></a>        </span>
<span id="cb46-340"><a href="#cb46-340"></a>        <span class="cf">if</span> total_cells <span class="op">&gt;=</span> max_cells:</span>
<span id="cb46-341"><a href="#cb46-341"></a>            <span class="bu">print</span>(<span class="st">"The sheet has reached the maximum cell limit. Creating a new sheet."</span>)</span>
<span id="cb46-342"><a href="#cb46-342"></a>            spreadsheet_id <span class="op">=</span> create_new_sheet(new_sheet_name)</span>
<span id="cb46-343"><a href="#cb46-343"></a>            sheet_name <span class="op">=</span> <span class="st">'Sheet1'</span>  <span class="co"># Reset to default sheet name for new spreadsheet</span></span>
<span id="cb46-344"><a href="#cb46-344"></a>        <span class="cf">else</span>:</span>
<span id="cb46-345"><a href="#cb46-345"></a>            <span class="bu">print</span>(<span class="st">"The sheet has not reached the maximum cell limit."</span>)</span>
<span id="cb46-346"><a href="#cb46-346"></a></span>
<span id="cb46-347"><a href="#cb46-347"></a>    <span class="co"># Time tracking for ThingSpeak</span></span>
<span id="cb46-348"><a href="#cb46-348"></a>    last_thingspeak_update <span class="op">=</span> time_module.time()</span>
<span id="cb46-349"><a href="#cb46-349"></a>    last_mongodb_update <span class="op">=</span> time_module.time()</span>
<span id="cb46-350"><a href="#cb46-350"></a>    last_vercel_update <span class="op">=</span> time_module.time()</span>
<span id="cb46-351"><a href="#cb46-351"></a>    </span>
<span id="cb46-352"><a href="#cb46-352"></a>    <span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb46-353"><a href="#cb46-353"></a>        <span class="co"># Get the current time at the start of the loop</span></span>
<span id="cb46-354"><a href="#cb46-354"></a>        start_time <span class="op">=</span> time_module.time()</span>
<span id="cb46-355"><a href="#cb46-355"></a>        </span>
<span id="cb46-356"><a href="#cb46-356"></a>        <span class="co"># Read humidity and temperature from DHT sensor</span></span>
<span id="cb46-357"><a href="#cb46-357"></a>        humidityPercent, temperature_C <span class="op">=</span> Adafruit_DHT.read_retry(SENSOR, PIN)</span>
<span id="cb46-358"><a href="#cb46-358"></a>        </span>
<span id="cb46-359"><a href="#cb46-359"></a>        <span class="cf">if</span> humidityPercent <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> temperature_C <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb46-360"><a href="#cb46-360"></a>            <span class="co"># Prepare the data payload</span></span>
<span id="cb46-361"><a href="#cb46-361"></a>            temperature_F <span class="op">=</span> temperature_C <span class="op">*</span> <span class="fl">9.0</span> <span class="op">/</span> <span class="fl">5.0</span> <span class="op">+</span> <span class="dv">32</span></span>
<span id="cb46-362"><a href="#cb46-362"></a>            </span>
<span id="cb46-363"><a href="#cb46-363"></a>            now <span class="op">=</span> datetime.now()</span>
<span id="cb46-364"><a href="#cb46-364"></a>            date <span class="op">=</span> now.strftime(<span class="st">"%m-</span><span class="sc">%d</span><span class="st">-%Y"</span>)</span>
<span id="cb46-365"><a href="#cb46-365"></a>            timeNow <span class="op">=</span> now.strftime(<span class="st">"%H:%M:%S"</span>)</span>
<span id="cb46-366"><a href="#cb46-366"></a>            </span>
<span id="cb46-367"><a href="#cb46-367"></a>            dataVercel <span class="op">=</span> {</span>
<span id="cb46-368"><a href="#cb46-368"></a>                <span class="st">'date'</span>: date,</span>
<span id="cb46-369"><a href="#cb46-369"></a>                <span class="st">'time'</span>: timeNow,</span>
<span id="cb46-370"><a href="#cb46-370"></a>                <span class="st">'humidityPercent'</span>: humidityPercent,</span>
<span id="cb46-371"><a href="#cb46-371"></a>                <span class="st">'temperatureFahrenheit'</span>: temperature_F,</span>
<span id="cb46-372"><a href="#cb46-372"></a>                <span class="st">'temperatureCelsius'</span>: temperature_C</span>
<span id="cb46-373"><a href="#cb46-373"></a>            }</span>
<span id="cb46-374"><a href="#cb46-374"></a>            dataMongo <span class="op">=</span> {</span>
<span id="cb46-375"><a href="#cb46-375"></a>                <span class="st">'date'</span>: date,</span>
<span id="cb46-376"><a href="#cb46-376"></a>                <span class="st">'time'</span>: timeNow,</span>
<span id="cb46-377"><a href="#cb46-377"></a>                <span class="st">'humidityPercent'</span>: humidityPercent,</span>
<span id="cb46-378"><a href="#cb46-378"></a>                <span class="st">'temperatureFahrenheit'</span>: temperature_F,</span>
<span id="cb46-379"><a href="#cb46-379"></a>                <span class="st">'temperatureCelsius'</span>: temperature_C,</span>
<span id="cb46-380"><a href="#cb46-380"></a>            }</span>
<span id="cb46-381"><a href="#cb46-381"></a>            <span class="co"># Log data to buffer. had to separate data as sometimes ObjectID would somehow get passed to Vercel's buffer.</span></span>
<span id="cb46-382"><a href="#cb46-382"></a>            data_buffer_vercel.append(dataVercel)</span>
<span id="cb46-383"><a href="#cb46-383"></a>            data_buffer_mongodb.append(dataMongo)</span>
<span id="cb46-384"><a href="#cb46-384"></a>            <span class="cf">if</span> i <span class="op">%</span> <span class="dv">60</span> <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb46-385"><a href="#cb46-385"></a>                <span class="bu">print</span>(<span class="ss">f"Logged data: </span><span class="sc">{</span>dataVercel<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb46-386"><a href="#cb46-386"></a>            </span>
<span id="cb46-387"><a href="#cb46-387"></a>            <span class="co"># Append data to Google Sheet</span></span>
<span id="cb46-388"><a href="#cb46-388"></a>            append_data_to_sheet(spreadsheet_id, sheet_name, [[date, timeNow, humidityPercent, temperature_F, temperature_C]],i)</span>
<span id="cb46-389"><a href="#cb46-389"></a>            </span>
<span id="cb46-390"><a href="#cb46-390"></a>            <span class="co"># Add data to ThingSpeak buffer</span></span>
<span id="cb46-391"><a href="#cb46-391"></a>            thingspeak_buffer.append({</span>
<span id="cb46-392"><a href="#cb46-392"></a>                <span class="st">'temperature_C'</span>: temperature_C,</span>
<span id="cb46-393"><a href="#cb46-393"></a>                <span class="st">'temperature_F'</span>: temperature_F,</span>
<span id="cb46-394"><a href="#cb46-394"></a>                <span class="st">'humidityPercent'</span>: humidityPercent,</span>
<span id="cb46-395"><a href="#cb46-395"></a>                <span class="st">'time'</span>: timeNow,</span>
<span id="cb46-396"><a href="#cb46-396"></a>                <span class="st">'date'</span>: datetime.strptime(date, <span class="st">"%m-</span><span class="sc">%d</span><span class="st">-%Y"</span>).strftime(<span class="st">"%Y-%m-</span><span class="sc">%d</span><span class="st">"</span>)</span>
<span id="cb46-397"><a href="#cb46-397"></a>            })</span>
<span id="cb46-398"><a href="#cb46-398"></a>            </span>
<span id="cb46-399"><a href="#cb46-399"></a>            <span class="co"># Check if 300 readings have been logged</span></span>
<span id="cb46-400"><a href="#cb46-400"></a>            <span class="cf">if</span> time_module.time() <span class="op">-</span> last_vercel_update <span class="op">&gt;=</span> <span class="dv">3600</span>:</span>
<span id="cb46-401"><a href="#cb46-401"></a>                send_data_vercel(data_buffer_vercel)</span>
<span id="cb46-402"><a href="#cb46-402"></a>                <span class="co"># Clear the buffer after sending</span></span>
<span id="cb46-403"><a href="#cb46-403"></a>                data_buffer_vercel.clear()</span>
<span id="cb46-404"><a href="#cb46-404"></a>                last_vercel_update <span class="op">=</span> time_module.time()</span>
<span id="cb46-405"><a href="#cb46-405"></a>            <span class="co"># Check if it's time to send data to Mongodb</span></span>
<span id="cb46-406"><a href="#cb46-406"></a>            <span class="cf">if</span> time_module.time() <span class="op">-</span> last_mongodb_update <span class="op">&gt;=</span> <span class="dv">60</span>:</span>
<span id="cb46-407"><a href="#cb46-407"></a>                send_data_mongodb(data_buffer_mongodb)</span>
<span id="cb46-408"><a href="#cb46-408"></a>                data_buffer_mongodb.clear()</span>
<span id="cb46-409"><a href="#cb46-409"></a>                last_mongodb_update <span class="op">=</span> time_module.time()</span>
<span id="cb46-410"><a href="#cb46-410"></a>                </span>
<span id="cb46-411"><a href="#cb46-411"></a>            <span class="co"># Check if it's time to send data to ThingSpeak</span></span>
<span id="cb46-412"><a href="#cb46-412"></a>            <span class="cf">if</span> time_module.time() <span class="op">-</span> last_thingspeak_update <span class="op">&gt;=</span> <span class="dv">15</span>:</span>
<span id="cb46-413"><a href="#cb46-413"></a>                thingspeak_update()</span>
<span id="cb46-414"><a href="#cb46-414"></a>                last_thingspeak_update <span class="op">=</span> time_module.time()</span>
<span id="cb46-415"><a href="#cb46-415"></a>        <span class="cf">else</span>:</span>
<span id="cb46-416"><a href="#cb46-416"></a>            <span class="co"># Handle cases where sensor fails to read</span></span>
<span id="cb46-417"><a href="#cb46-417"></a>            <span class="bu">print</span>(<span class="st">"Failed to retrieve data from sensor"</span>)</span>
<span id="cb46-418"><a href="#cb46-418"></a>        </span>
<span id="cb46-419"><a href="#cb46-419"></a>        <span class="co"># Wait until the LOOP_TIME has elapsed</span></span>
<span id="cb46-420"><a href="#cb46-420"></a>        <span class="cf">while</span> time_module.time() <span class="op">-</span> start_time <span class="op">&lt;</span> LOOP_TIME:</span>
<span id="cb46-421"><a href="#cb46-421"></a>            time_module.sleep(<span class="fl">0.01</span>)  <span class="co"># Sleep a short time to avoid busy-waiting</span></span>
<span id="cb46-422"><a href="#cb46-422"></a></span>
<span id="cb46-423"><a href="#cb46-423"></a>        i <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb46-424"><a href="#cb46-424"></a></span>
<span id="cb46-425"><a href="#cb46-425"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">'__main__'</span>:</span>
<span id="cb46-426"><a href="#cb46-426"></a>    main()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p>And there you have it. 4 different databases and the ability to write/read to them in near real time via a simple web portal. I could have used any of these individually but I wanted to explore the strengths/weaknesses of different configurations. I like the idea of just using a pretty long Google Sheet for most projects and completely ignoring actual databases for simple home automation. Using MongoDB was pretty straightforward via VSCode and it is a strong second choice. Tying for second would be ThingSpeak with its cool online interface, but I’m wary of Mathworks in general with their pay to play scheme. Last place is definitely Vercel’s own implementation of PostgreSQL mostly because of the compute/size limitations.</p>
<p>I would have implemented multiple sensors, likely in the form of PM2.5/10, CO2, a better DHT22 sensor, and a VOC sensor. Here’s my Amazon wish list for future projects:</p>
<p>PM2.5/10[PMS5003]: <a href="https://www.adafruit.com/product/3686" class="uri">https://www.adafruit.com/product/3686</a></p>
<p>CO2[MH-Z19]: <a href="https://www.amazon.com/EC-Buying-Monitoring-Concentration-Detection/dp/B0CRKH5XVX/" class="uri">https://www.amazon.com/EC-Buying-Monitoring-Concentration-Detection/dp/B0CRKH5XVX/</a></p>
<p>Temperature/Humidity[DHT22]: <a href="https://www.amazon.com/SHILLEHTEK-Digital-Temperature-Humidity-Sensor/dp/B0CN5PN225/" class="uri">https://www.amazon.com/SHILLEHTEK-Digital-Temperature-Humidity-Sensor/dp/B0CN5PN225/</a></p>
<p>Temp/Humidity/Pressure/VOC[BME680]: <a href="https://www.amazon.com/CJMCU-680-Temperature-Humidity-Ultra-Small-Development/dp/B07K1CGQTJ/" class="uri">https://www.amazon.com/CJMCU-680-Temperature-Humidity-Ultra-Small-Development/dp/B07K1CGQTJ/</a></p>
<p>Air Quality/VOC[MQ135]: <a href="https://www.amazon.com/Ximimark-Quality-Hazardous-Detection-Arduino/dp/B07L73VTTY/" class="uri">https://www.amazon.com/Ximimark-Quality-Hazardous-Detection-Arduino/dp/B07L73VTTY/</a></p>
<p>While a description of extract, transform, and load(ETL) probably belongs up top I feel like it fits the narrative better to define it here and describe how this project is one giant homegrown ETL pipeline…</p>

<section id="what-is-an-etl-pipeline" class="level2">
<h2 class="anchored" data-anchor-id="what-is-an-etl-pipeline"><strong>What is an ETL Pipeline?</strong></h2>
<section id="definition" class="level3">
<h3 class="anchored" data-anchor-id="definition"><strong>Definition</strong></h3>
<p>ETL stands for Extract, Transform, Load. It’s a process used in data management to:</p>
<ol type="1">
<li><p><strong>Extract</strong> data from various sources.</p></li>
<li><p><strong>Transform</strong> the data into a suitable format or structure for analysis and reporting.</p></li>
<li><p><strong>Load</strong> the transformed data into a target database, data warehouse, or data lake.</p></li>
</ol>
</section>
<section id="how-it-works" class="level3">
<h3 class="anchored" data-anchor-id="how-it-works"><strong>How it Works</strong></h3>
<ol type="1">
<li><p><strong>Extract</strong>:</p>
<ul>
<li><p>Data is collected from different sources like databases, APIs, files, or sensors.</p></li>
<li><p>This step involves connecting to the source, querying or retrieving the data, and pulling it into the pipeline.</p></li>
</ul></li>
<li><p><strong>Transform</strong>:</p>
<ul>
<li><p>The extracted data is cleaned, validated, and transformed to fit the schema of the target system.</p></li>
<li><p>Transformations might include filtering, aggregating, joining, sorting, or converting data types.</p></li>
<li><p>This step ensures data quality and prepares it for efficient loading and querying in the target system.</p></li>
</ul></li>
<li><p><strong>Load</strong>:</p>
<ul>
<li><p>The transformed data is loaded into the target database, data warehouse, or data lake.</p></li>
<li><p>This involves writing the data into the storage system, ensuring it’s available for querying and analysis.</p></li>
<li><p>The loading process can be a full load (overwriting existing data) or an incremental load (updating or adding new data).</p></li>
</ul></li>
</ol>
</section>
<section id="applications" class="level3">
<h3 class="anchored" data-anchor-id="applications"><strong>Applications</strong></h3>
<p>ETL pipelines are used in various scenarios, including:</p>
<ul>
<li><p><strong>Data Warehousing</strong>: Collecting and consolidating data from multiple sources into a central repository for reporting and analysis.</p></li>
<li><p><strong>Business Intelligence (BI)</strong>: Providing clean and structured data for BI tools to generate insights and reports.</p></li>
<li><p><strong>Data Integration</strong>: Integrating data from different systems to provide a unified view.</p></li>
<li><p><strong>Data Migration</strong>: Moving data from one system to another, often during system upgrades or cloud migrations.</p></li>
<li><p><strong>Data Analytics</strong>: Preparing data for analysis and machine learning models.</p></li>
</ul>
</section>
<section id="example-of-a-homegrown-etl-pipeline-in-the-project" class="level3">
<h3 class="anchored" data-anchor-id="example-of-a-homegrown-etl-pipeline-in-the-project"><strong>Example of a Homegrown ETL Pipeline in the Project</strong></h3>
<p>The project described above is a great example of a homegrown ETL pipeline, using a Raspberry Pi and various data storage solutions.</p>
<section id="extract" class="level4">
<h4 class="anchored" data-anchor-id="extract"><strong>Extract</strong></h4>
<ul>
<li><p><strong>Data Sources</strong>: Environmental data is extracted from various sensors (e.g., DHT11 for temperature and humidity).</p></li>
<li><p><strong>Data Collection</strong>: The sensors are connected to the Raspberry Pi, which reads data at regular intervals.</p></li>
</ul>
</section>
<section id="transform" class="level4">
<h4 class="anchored" data-anchor-id="transform"><strong>Transform</strong></h4>
<ul>
<li><p><strong>Data Processing</strong>: The raw data from the sensors is processed to convert it into a readable format (e.g., converting temperature from Celsius to Fahrenheit).</p></li>
<li><p><strong>Data Formatting</strong>: The data is formatted into JSON objects for a consistent structure across different storage solutions.</p></li>
</ul>
</section>
<section id="load" class="level4">
<h4 class="anchored" data-anchor-id="load"><strong>Load</strong></h4>
<ul>
<li><p><strong>Data Storage</strong>: The transformed data is loaded into multiple storage solutions:</p>
<ul>
<li><p><strong>Google Sheets</strong>: For easy access and sharing.</p></li>
<li><p><strong>ThingSpeak</strong>: For real-time visualization and monitoring.</p></li>
<li><p><strong>MongoDB</strong>: For flexible, document-based storage.</p></li>
<li><p><strong>Vercel PostgreSQL</strong>: For relational database storage.</p></li>
</ul></li>
</ul>
</section>
</section>
<section id="how-the-project-implements-etl" class="level3">
<h3 class="anchored" data-anchor-id="how-the-project-implements-etl"><strong>How the Project Implements ETL</strong></h3>
<ol type="1">
<li><p><strong>Extract</strong>:</p>
<ul>
<li>The Raspberry Pi reads data from the DHT11 sensor every second using the <strong><code>Adafruit_DHT</code></strong> library.</li>
</ul></li>
<li><p><strong>Transform</strong>:</p>
<ul>
<li><p>The raw data (humidity and temperature) is processed to convert temperature to Fahrenheit and format the date and time.</p></li>
<li><p>The data is structured into JSON objects for consistency.</p></li>
</ul></li>
<li><p><strong>Load</strong>:</p>
<ul>
<li><p>The data is sent to multiple endpoints:</p>
<ul>
<li><p><strong>Google Sheets</strong>: Using the Google Sheets API to append new rows.</p></li>
<li><p><strong>ThingSpeak</strong>: Using the ThingSpeak API for both simple and bulk updates.</p></li>
<li><p><strong>MongoDB</strong>: Using the MongoDB Python client to insert data into the collection.</p></li>
<li><p><strong>Vercel PostgreSQL</strong>: Sending data to a Vercel serverless function which writes to a PostgreSQL database.</p></li>
</ul></li>
</ul></li>
</ol>
</section>
<section id="benefits-of-this-etl-pipeline" class="level3">
<h3 class="anchored" data-anchor-id="benefits-of-this-etl-pipeline"><strong>Benefits of this ETL Pipeline</strong></h3>
<ul>
<li><p><strong>Real-time Data Processing</strong>: The pipeline processes and loads data in near real-time, providing up-to-date information.</p></li>
<li><p><strong>Multi-Storage Integration</strong>: The data is stored in various platforms, each with its strengths, ensuring data availability and flexibility.</p></li>
<li><p><strong>Scalability</strong>: The modular approach allows easy addition of new sensors or data sources.</p></li>
<li><p><strong>Automation</strong>: The use of scheduled tasks and services ensures continuous data collection and processing without manual intervention.</p></li>
</ul>
</section>
<section id="conclusion" class="level3">
<h3 class="anchored" data-anchor-id="conclusion"><strong>Conclusion</strong></h3>
<p>This project shows off a homegrown ETL pipeline that efficiently collects, processes, and stores environmental data from sensors. By using various storage solutions, it demonstrates how a flexible and scalable ETL process can be implemented for real-time data monitoring and analysis in a home automation context.</p>


</section>
</section>

</main> <!-- /main -->






    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Support Page</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>

        .centered-text {

            text-align: center; /* Centers text for elements with this class */

        }

        .centered-content {

            display: flex; /* Uses Flexbox for layout */

            justify-content: center; /* Horizontally centers the content within the container */

            align-items: center; /* Vertically centers the content within the container */

        }

        .email-share-button {

            background: #007BFF; /* Example: a distinct blue color for the email button */

            color: white; /* Ensure text and icon are white for visibility */

        }

        #share-buttons {

            display: flex;

            align-items: center;

            justify-content: center;

            gap: 5px;

        }

        .share-button {

            display: inline-flex;

            padding: 2px 4px;

            font-size: 14px;

            cursor: pointer;

            text-align: center;

            color: white;

            border-radius: 0px;

        }

    </style>





    <footer class="centered-text">

        <p>Copyright © <span id="copyright-year"></span> Jesse Anderson</p>

        <!-- Other footer details -->

    </footer>

    <div>

        <hr>

        <h3 class="centered-text">Support my work with a Coffee/Monster</h3>

        <div class="centered-content">

            <script type="text/javascript" src="https://cdnjs.buymeacoffee.com/1.0.0/button.prod.min.js" data-name="bmc-button" data-slug="jesseanderson" data-color="#06436e" data-emoji="☕" data-font="Lato" data-text="Support me" data-outline-color="#ffffff" data-font-color="#ffffff" data-coffee-color="#FFDD00" data-height="40px"></script>

        </div>

        <!-- Footer content -->

        <h3 class="centered-text">Share</h3>

        <!-- Share Buttons -->

        <div id="share-buttons" class="centered-content">

            <!-- Twitter Share Button, dynamically setting the URL -->

            <a href="#" class="share-button twitter-share-button" data-size="large" data-hashtags="computerscience" data-via="JesseA7C5" data-show-count="false">Tweet</a>

            <script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

            <!-- Facebook SDK with Dynamic Nonce -->

            <div id="fb-root"></div>

            <script id="facebook-jssdk" async="" defer="" crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js#xfbml=1&amp;version=v10.0"></script>

            <div class="fb-share-button share-button" data-href="" data-layout="button_count">

            </div>

            <!-- LinkedIn Share Button -->

            <script src="https://platform.linkedin.com/in.js" type="text/javascript">lang: en_US</script>

            <script type="IN/Share" data-url=""></script>

            <!-- Email Share Button -->

            <a href="#" class="share-button email-share-button"><i class="fas fa-envelope"></i></a>

        </div>

    </div>

    <script>

        // Function to generate a random nonce

        function generateNonce(length = 16) {

            const possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";

            let text = "";

            for (let i = 0; i < length; i++) {

                text += possible.charAt(Math.floor(Math.random() * possible.length));

            }

            return text;

        }

        // Set the nonce attribute for the Facebook SDK script and dynamically set URLs

        document.addEventListener('DOMContentLoaded', function() {

            const nonce = generateNonce();

            const facebookSDKScript = document.getElementById('facebook-jssdk');

            facebookSDKScript.setAttribute('nonce', nonce);

            var elems = document.querySelectorAll('script[type="IN/Share"]');

            for (var i = 0; i < elems.length; i++) {

                elems[i].setAttribute('data-url', window.location.href);

            }

            // Set dynamic URLs for social sharing

            const currentUrl = window.location.href;

            const currentTitle = document.title; // Use the current document title as the email subject

            // Facebook

            document.querySelector('.fb-share-button').setAttribute('data-href', currentUrl);

            // LinkedIn

            document.querySelectorAll('script[type="IN/Share"]')[0].setAttribute('data-url', currentUrl);

            // Twitter

            document.querySelector('.twitter-share-button').setAttribute('href', 'https://twitter.com/share?url=' + encodeURIComponent(currentUrl) + '&hashtags=rstats');

            // Email

            document.querySelector('.email-share-button').setAttribute('href', `mailto:?subject=${encodeURIComponent(currentTitle)}&body=Check out this link: ${encodeURIComponent(currentUrl)}`);

            // Dynamically set the current year in the copyright footer

            document.getElementById('copyright-year').textContent = new Date().getFullYear();

        });

        // This script below to put a latest posts list after the comment system was such a pain in the ass.

        document.addEventListener('DOMContentLoaded', function() {

            // console.log("Latest Posts Populating...");

            // Create the latest posts container

            const latestPostsContainer = document.createElement('div');

            latestPostsContainer.className = 'latest-posts';

            latestPostsContainer.innerHTML = `

                <h3>Latest Posts</h3>

                <ul id="latest-posts-list">

                    <!-- Latest posts will be inserted here -->

                </ul>

            `;

            // Find the footer element

            const footer = document.querySelector('footer.footer');

            // Insert the latest posts container before footer, easier than after utterances.

            footer.parentNode.insertBefore(latestPostsContainer, footer);

            // Fetch latest posts from the archive page

            fetch('https://jesse-anderson.github.io/Blog/_site/archive.html')

                .then(response => response.text())

                .then(data => {

                    const parser = new DOMParser();

                    const doc = parser.parseFromString(data, 'text/html');

                    const posts = doc.querySelectorAll('.quarto-listing-container-table tbody tr');

                    // console.log("Posts: ", posts);

                    const latestPostsList = document.getElementById('latest-posts-list');

                    let count = 0;

                    posts.forEach(post => {

                        if (count < 4) {

                            // console.log("Title populating...");

                            const titleElement = post.querySelector('.listing-title'); // Correctly select the <a> tag with the title class

                            // console.log(titleElement)

                              const imageElement = post.querySelector('.listing-image img');

                              // console.log(imageElement)

                            if (titleElement) {

                                const title = titleElement.textContent.trim();

                                // console.log('Title: ', title);

                                let url = titleElement.getAttribute('href');

                                // console.log('URL: ', url);

                                if (url && !url.startsWith('http')) {

                                    url = 'https://jesse-anderson.github.io/Blog/_site/' + url.replace(/^\.\//, '');

                                }

                                // console.log('Formatted URL: ', url);

                                const imageUrl = imageElement ? imageElement.getAttribute('src').replace(/^\.\//, 'https://jesse-anderson.github.io/Blog/_site/') : 'default-image.jpg'; // Fallback image

                                // console.log('Image URL: ', imageUrl);

                                const listItem = document.createElement('li');

                                listItem.innerHTML = `<a href="${url}"><img src="${imageUrl}" alt="Post Image" style="height: 20px;"> ${title}</a>`;

                                latestPostsList.appendChild(listItem);

                                // console.log('ListItem: ', listItem);

                                count++;

                            } else {

                                console.warn('Missing elements for post:', post);

                            }

                        }

                    });

                });

        });

    </script>





<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="jesse-anderson/blogComments" issue-term="title" theme="github-dark" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">

<div class="cookie-consent-footer"><a href="#" id="open_preferences_center">Cookie Preferences</a></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>
<script>var lightboxQuarto = GLightbox({"selector":".lightbox","closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom"});
window.onload = () => {
  lightboxQuarto.on('slide_before_load', (data) => {
    const { slideIndex, slideNode, slideConfig, player, trigger } = data;
    const href = trigger.getAttribute('href');
    if (href !== null) {
      const imgEl = window.document.querySelector(`a[href="${href}"] img`);
      if (imgEl !== null) {
        const srcAttr = imgEl.getAttribute("src");
        if (srcAttr && srcAttr.startsWith("data:")) {
          slideConfig.href = srcAttr;
        }
      }
    } 
  });

  lightboxQuarto.on('slide_after_load', (data) => {
    const { slideIndex, slideNode, slideConfig, player, trigger } = data;
    if (window.Quarto?.typesetMath) {
      window.Quarto.typesetMath(slideNode);
    }
  });

};
          </script>




</body></html>