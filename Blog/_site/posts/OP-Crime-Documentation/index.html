<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Jesse Anderson">
<meta name="dcterms.date" content="2025-01-09">

<title>Jesse Anderson’s Blog - Oak Park Crime Reporting</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/cookie-consent/cookie-consent.js"></script>
<link href="../../site_libs/cookie-consent/cookie-consent.css" rel="stylesheet">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-5CSPYCMY55"></script>

<script type="text/plain" cookie-consent="tracking">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-5CSPYCMY55', { 'anonymize_ip': true});
</script>

<script type="text/javascript" charset="UTF-8">
document.addEventListener('DOMContentLoaded', function () {
cookieconsent.run({
  "notice_banner_type":"simple",
  "consent_type":"implied",
  "palette":"light",
  "language":"en",
  "page_load_consent_levels":["strictly-necessary","functionality","tracking","targeting"],
  "notice_banner_reject_button_hide":false,
  "preferences_center_close_button_hide":false,
  "website_name":""
  ,
"language":"en"
  });
});
</script> 
  


<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="Jesse Anderson’s Blog - Oak Park Crime Reporting">
<meta property="og:description" content="">
<meta property="og:image" content="image.jpg">
<meta property="og:site_name" content="Jesse Anderson's Blog">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Jesse Anderson’s Blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../archive.html"> 
<span class="menu-text">Archive</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://jesse-anderson.github.io"> <i class="bi bi-Folder symlink fill" role="img">
</i> 
<span class="menu-text">Portfolio</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/jesse-anderson/"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/jesse-anderson-a7c5/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Oak Park Crime Reporting</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">Data Science</div>
                <div class="quarto-category">Data Analytics</div>
                <div class="quarto-category">Data Engineering</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Jesse Anderson </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">January 9, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="oak-park-crime-reporting-documentation" class="level2">
<h2 class="anchored" data-anchor-id="oak-park-crime-reporting-documentation"><strong>Oak Park Crime Reporting Documentation</strong></h2>
<section id="table-of-contents" class="level3">
<h3 class="anchored" data-anchor-id="table-of-contents"><strong>Table of Contents</strong></h3>
<ol type="1">
<li><p><a href="#Motivation">Motivation</a></p></li>
<li><p><a href="#how-to-use-the-tool">How to Use the Tool</a></p>
<ul>
<li><p><a href="#accessing-live-streamlit-dashboard">Using the Live Streamlit Dashboard</a></p></li>
<li><p><a href="#accessing-static-html-maps">Accessing the Static HTML Maps</a></p></li>
<li><p><a href="#signing-up-for-weekly-updates">Signing Up for Weekly Email Updates</a></p></li>
</ul></li>
<li><p><a href="#documentation-introduction">Documentation Introduction</a></p></li>
<li><p><a href="#data-parsing">Data Parsing</a></p>
<ul>
<li><p><a href="#overview">Overview</a></p></li>
<li><p><a href="#key-components">Key Components</a></p>
<ul>
<li><p><a href="#1-oakpark_crime_reporting_webpy">1. <code>OakPark_Crime_Reporting_Web.py</code></a></p></li>
<li><p><a href="#2-utilspy">2. <code>utils.py</code></a></p></li>
</ul></li>
<li><p><a href="#detailed-code-breakdown">Detailed Code Breakdown</a></p></li>
</ul></li>
<li><p><a href="#live-streamlit-dashboard">Live Streamlit Dashboard</a></p>
<ul>
<li><p><a href="#overview-1">Overview</a></p></li>
<li><p><a href="#key-components-1">Key Components</a></p>
<ul>
<li><a href="#1-streamlit_apppy">1. <code>streamlit_app.py</code></a></li>
</ul></li>
<li><p><a href="#detailed-code-breakdown-1">Detailed Code Breakdown</a></p></li>
</ul></li>
<li><p><a href="#static-html-generation">Static HTML Generation</a></p>
<ul>
<li><p><a href="#overview-2">Overview</a></p></li>
<li><p><a href="#key-components-2">Key Components</a></p>
<ul>
<li><a href="#1-weekly_crime_reportpy">1. <code>weekly_crime_report.py</code></a></li>
</ul></li>
<li><p><a href="#detailed-code-breakdown-2">Detailed Code Breakdown</a></p></li>
</ul></li>
<li><p><a href="#conclusion">Conclusion</a></p></li>
<li><p><a href="#future-enhancements">Future Enhancements</a></p></li>
</ol>
</section>
</section>
<section id="Motivation" class="level2">
<h2 class="anchored" data-anchor-id="Motivation"><strong>Motivation</strong></h2>
<p>Tracking and analyzing crime data is crucial for fostering safer communities and enabling informed decision-making. While this tool is not designed nor should not be used in any informal or informal decision making per the disclaimers presented within the application it is my hope that it triggers discussion regarding using analytics to enable data driven decision making per my other projects both personal and professional. My journey to develop a comprehensive crime tracking tool for Oak Park was driven by the challenges and inefficiencies I encountered while navigating the Oak Park Police Department’s (OPPD) publicly available resources.</p>
<section id="initial-challenges" class="level3">
<h3 class="anchored" data-anchor-id="initial-challenges"><strong>Initial Challenges</strong></h3>
<p>Navigating the OPPD website presented a significant hurdle. The process involved manually accessing PDF files for specific dates, meticulously copying and pasting individual crime reports, and then attempting to locate each incident on a map. This method was not only <strong>time-consuming</strong> but also <strong>prone to errors</strong>, making it difficult to:</p>
<ul>
<li><p><strong>Quickly Assess Crime Trends</strong>: Without an aggregated view, understanding the frequency and distribution of crimes over a given period was arduous.</p></li>
<li><p><strong>Identify Crime Hotspots</strong>: Pinpointing areas with high concentrations of criminal activity lacked precision and was labor-intensive.</p></li>
<li><p><strong>Monitor Crime Progression</strong>: Determining whether crime rates were escalating or declining within Oak Park required extensive manual effort.</p></li>
</ul>
</section>
<section id="embarking-on-a-solution" class="level3">
<h3 class="anchored" data-anchor-id="embarking-on-a-solution"><strong>Embarking on a Solution</strong></h3>
<p>Determined to streamline this process, I embarked on automating data extraction and visualization. The primary objective was to transform unstructured PDF data into a structured format that could be easily analyzed and visualized.</p>
</section>
<section id="overcoming-technical-hurdles" class="level3">
<h3 class="anchored" data-anchor-id="overcoming-technical-hurdles"><strong>Overcoming Technical Hurdles</strong></h3>
<p>The transition from PDFs to actionable data was fraught with challenges:</p>
<ol type="1">
<li><p><strong>Data Extraction Complexity</strong>:</p>
<ul>
<li><p><strong>Initial Approach</strong>: I leveraged <strong>Regular Expressions (Regex)</strong> to parse and extract relevant crime data from the PDFs.</p></li>
<li><p><strong>Error Rates</strong>: The initial extraction efforts yielded error rates between <strong>20-30%</strong>, compromising data reliability.</p></li>
</ul></li>
<li><p><strong>Optimizing Data Accuracy</strong>:</p>
<ul>
<li><p><strong>Refining Regex Patterns</strong>: Through iterative testing and refinement of Regex patterns, I significantly reduced error rates to <strong>10%</strong> and eventually to <strong>5%</strong>.</p></li>
<li><p><strong>Additional Optimizations</strong>: Implementing data validation checks and leveraging Python’s robust data processing libraries further enhanced extraction accuracy.</p></li>
</ul></li>
</ol>
</section>
<section id="creating-insightful-visualizations" class="level3">
<h3 class="anchored" data-anchor-id="creating-insightful-visualizations"><strong>Creating Insightful Visualizations</strong></h3>
<p>With accurate data in hand, the next step was to visualize it in a meaningful way:</p>
<ul>
<li><p><strong>Interactive Maps</strong>: Utilizing <strong>Folium</strong>, I created dynamic maps that plot each crime incident, providing a spatial understanding of criminal activity.</p></li>
<li><p><strong>Identifying Hotspots</strong>: By incorporating <strong>Marker Clustering</strong>, the maps highlight areas with high crime densities, enabling quick identification of hotspots.</p></li>
<li><p><strong>Filtering Capabilities</strong>: Implementing filtering options allows users to view specific types of crimes or incidents within selected time frames, enhancing the map’s utility.</p></li>
</ul>
</section>
<section id="expanding-analytical-capabilities" class="level3">
<h3 class="anchored" data-anchor-id="expanding-analytical-capabilities"><strong>Expanding Analytical Capabilities</strong></h3>
<p>The success of the initial visualization opened avenues for further enhancements:</p>
<ul>
<li><p><strong>Natural Language Processing (NLP)</strong>: I recognized the potential to analyze crime narratives using NLP techniques to uncover commonalities and emerging patterns across different incidents.</p></li>
<li><p><strong>Trend Analysis</strong>: Incorporating statistical analyses and trend graphs could provide deeper insights into the progression of crime rates over time.</p></li>
</ul>
<p><u><strong><em>Note: While NLP and advanced trend analyses offer substantial benefits, they are beyond the scope of this documentation and are earmarked for future development.</em></strong></u></p>
</section>
<section id="personal-satisfaction-and-practical-usage" class="level3">
<h3 class="anchored" data-anchor-id="personal-satisfaction-and-practical-usage"><strong>Personal Satisfaction and Practical Usage</strong></h3>
<p>The culmination of these efforts resulted in a robust, user-friendly tool that not only alleviates the tedious manual processes but also empowers users with actionable insights into Oak Park’s crime landscape. The tool’s ability to:</p>
<ul>
<li><p><strong>Streamline Data Processing</strong>: Automates the extraction and visualization of crime data, saving valuable time.</p></li>
<li><p><strong>Enhance Decision-Making</strong>: Provides clear visual representations of crime trends and hotspots, facilitating informed community and law enforcement decisions.</p></li>
<li><p><strong>Promote Community Safety</strong>: By making crime data more accessible and understandable, it fosters a proactive approach to community safety initiatives.</p></li>
</ul>
<p>I am immensely satisfied with the outcome of this project. The tool has become an integral part of my routine, allowing me to stay informed about the evolving crime dynamics in Oak Park efficiently and effectively.</p>
<hr>
</section>
</section>
<section id="how-to-use-the-tool" class="level2">
<h2 class="anchored" data-anchor-id="how-to-use-the-tool"><strong>How to Use the Tool</strong></h2>
<p>The Oak Park Crime Reporting tool is designed to provide comprehensive insights into crime data within Oak Park through interactive dashboards, static maps, and automated email updates. This section guides you through the various functionalities and how to effectively utilize them.</p>
<section id="accessing-live-streamlit-dashboard" class="level3">
<h3 class="anchored" data-anchor-id="accessing-live-streamlit-dashboard"><strong>Using the Live Streamlit Dashboard</strong></h3>
<p>The <strong>Live Streamlit Dashboard</strong> offers an interactive platform to explore and visualize crime data in real-time. Here’s how to make the most of it:</p>
<ol type="1">
<li><p><strong>Accessing the Dashboard</strong>:</p>
<ul>
<li><p><strong>Local Deployment</strong>: If you’re running the dashboard locally, navigate to the project directory in your terminal and execute:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1"></a><span class="ex">streamlit</span> run streamlit_app.py</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This command will launch the dashboard in your default web browser.</p></li>
<li><p><strong>Hosted Deployment</strong>: To access the current free deployment I am using as I don’t particularly want to pay for an AWS instance without funds coming in… access it via the provided URL (e.g., <a href="https://op-crime.streamlit.app/"><code>https://op-crime.streamlit.app/</code></a>).</p></li>
</ul></li>
<li><p><strong>Navigating the Dashboard</strong>:</p>
<ul>
<li><p><strong>Disclaimer Agreement</strong>: Upon first access, you’ll be presented with a legal disclaimer. Read through the terms and check the agreement box to proceed.</p></li>
<li><p><strong>Interactive Filters</strong>:</p>
<ul>
<li><p><strong>Date Range</strong>: Select the desired date range using the date pickers to filter crime data accordingly.</p></li>
<li><p><strong>Offense Type</strong>: Use the multiselect dropdown to filter crimes based on specific offense categories.</p></li>
</ul></li>
<li><p><strong>Visualizing Data</strong>:</p>
<ul>
<li><p><strong>Map Display</strong>: The right panel displays a dynamic map highlighting crime incidents based on your filters. Click on markers to view detailed information about each incident.</p></li>
<li><p><strong>Data Table</strong>: Optionally, a table listing all filtered crime records may be available for reference.</p></li>
</ul></li>
</ul></li>
<li><p><strong>Additional Features</strong>:</p>
<ul>
<li><p><strong>Navigation Links</strong>: Access related resources such as the author’s portfolio, blog, and documentation through the top navigation links.</p></li>
<li><p><strong>Email Subscription</strong>: There’s an option to subscribe or unsubscribe from weekly email updates for the latest crime reports. Currently the script is run automatically daily to capture new incidents and a report is emailed to myself and a few other people once weekly.</p></li>
</ul></li>
</ol>
</section>
<section id="accessing-static-html-maps" class="level3">
<h3 class="anchored" data-anchor-id="accessing-static-html-maps"><strong>Accessing the Static HTML Maps</strong></h3>
<p>For users who prefer or require static reports, the tool generates HTML maps that can be accessed independently of the Streamlit dashboard. Here’s how to access and utilize them:</p>
<ol type="1">
<li><p><strong>Generated Maps</strong>:</p>
<ul>
<li><p><strong>Weekly Crime Map</strong>: Provides a snapshot of crime incidents from the past week.</p></li>
<li><p><strong>Cumulative Crime Map</strong>: Displays all recorded crime incidents to date.</p></li>
</ul></li>
<li><p><strong>Access Methods</strong>:</p>
<ul>
<li><p><strong>GitHub Pages</strong>: The static maps are hosted on GitHub Pages for easy access. Navigate to the respective URLs:</p>
<ul>
<li><p><strong>Weekly Map</strong>: <code>https://jesse-anderson.github.io/OP-Crime-Maps/crime_map_weekly_YYYY-MM-DD.html</code></p></li>
<li><p><strong>Cumulative Map</strong>: <code>https://jesse-anderson.github.io/OP-Crime-Maps/crime_map_cumulative.html</code></p></li>
</ul></li>
<li><p><strong>Direct Access</strong>: If hosting elsewhere, ensure the HTML files are uploaded to a web-accessible directory and navigate to their URLs.</p></li>
</ul></li>
<li><p><strong>Interacting with the Maps</strong>:</p>
<ul>
<li><p><strong>Zoom and Pan</strong>: Use your browser’s native controls to zoom in/out and pan across the map.</p></li>
<li><p><strong>Marker Details</strong>: Click on individual markers to view detailed information about each crime incident, including links to original PDF reports.</p></li>
</ul></li>
<li><p><strong>Embedding Maps</strong>:</p>
<ul>
<li><strong>Web Integration</strong>: Embed the HTML maps into other websites or internal dashboards using <code>&lt;iframe&gt;</code> tags or direct links for seamless integration.</li>
</ul></li>
</ol>
</section>
<section id="signing-up-for-weekly-updates" class="level3">
<h3 class="anchored" data-anchor-id="signing-up-for-weekly-updates"><strong>Signing Up for Weekly Email Updates</strong></h3>
<p>Stay informed with the latest crime reports by subscribing to our weekly email updates. Follow these steps to sign up:</p>
<ol type="1">
<li><p><strong>Access the Subscription Form</strong>:</p>
<ul>
<li><p><strong>Streamlit Dashboard</strong>: Navigate to the “📧 Email Updates” section within the dashboard.</p></li>
<li><p><strong>Direct Link</strong>: Alternatively, use the provided Google Forms link: <a href="https://forms.gle/GnyaVwo1Vzm8nBH6A">Add me to Weekly Updates</a></p></li>
</ul></li>
<li><p><strong>Submitting Your Email</strong>:</p>
<ul>
<li><p><strong>Subscription</strong>:</p>
<ul>
<li><p><strong>Form Fill</strong>: Enter your valid email address in the subscription form.</p></li>
<li><p><strong>Confirmation</strong>: Upon successful submission, you’ll receive a confirmation email verifying your subscription.</p></li>
</ul></li>
<li><p><strong>Unsubscription</strong>:</p>
<ul>
<li><p><strong>Form Fill</strong>: To unsubscribe, provide your email address in the unsubscription section of the form.</p></li>
<li><p><strong>Confirmation</strong>: A confirmation email will notify you of the successful removal from the mailing list.</p></li>
</ul></li>
</ul></li>
<li><p><strong>Managing Preferences</strong>:</p>
<ul>
<li><p><strong>Frequency</strong>: Currently, the tool sends out weekly updates. Future enhancements may include customizable frequencies such as daily or weekly.</p></li>
<li><p><strong>Content</strong>: Receive links to the latest weekly and cumulative maps, along with attached CSV reports detailing the most recent crime data.</p></li>
</ul></li>
<li><p><strong>Privacy Assurance</strong>:</p>
<ul>
<li><p><strong>Data Handling</strong>: Your email address is securely handled and only used for sending crime report updates.</p></li>
<li><p><strong>Opt-Out Anytime</strong>: You can unsubscribe at any time without any hassle through the provided unsubscription process.</p></li>
</ul></li>
</ol>
<hr>
</section>
</section>
<section id="documentation-introduction" class="level2">
<h2 class="anchored" data-anchor-id="documentation-introduction"><strong>Documentation Introduction</strong></h2>
<p>The Oak Park Crime Reporting project is designed to streamline the process of tracking, analyzing, and visualizing crime data within Oak Park. The project automates data extraction from the Oak Park Police Department’s (OPPD) reports, processes and cleans the data, visualizes it on interactive maps, and disseminates the information through various channels such as a Streamlit dashboard and static HTML pages. This documentation provides an in-depth look into the project’s components, focusing initially on data parsing.</p>
</section>
<section id="data-parsing" class="level2">
<h2 class="anchored" data-anchor-id="data-parsing"><strong>Data Parsing</strong></h2>
<section id="overview" class="level3">
<h3 class="anchored" data-anchor-id="overview"><strong>Overview</strong></h3>
<p>Data parsing is the foundational step in the Oak Park Crime Reporting pipeline. It involves extracting relevant information from the OPPD’s PDF reports, cleaning and structuring the data, and preparing it for visualization and analysis. The primary scripts responsible for this phase are:</p>
<ol type="1">
<li><p><code>OakPark_Crime_Reporting_Web.py</code></p></li>
<li><p><code>utils.py</code></p></li>
</ol>
<p>These scripts work in tandem to automate the cumbersome manual process of navigating through PDF files, extracting crime details, and geocoding locations for mapping.</p>
</section>
<section id="key-components" class="level3">
<h3 class="anchored" data-anchor-id="key-components"><strong>Key Components</strong></h3>
<section id="oakpark_crime_reporting_web.py" class="level4">
<h4 class="anchored" data-anchor-id="oakpark_crime_reporting_web.py"><strong>1. <code>OakPark_Crime_Reporting_Web.py</code></strong></h4>
<p><strong>Purpose</strong>: This script orchestrates the data parsing workflow. It handles downloading PDF reports from the OPPD website, extracting crime data, geocoding locations, managing caches to optimize performance, and committing the processed data to a GitHub repository.</p>
<strong>Imports and Dependencies</strong>:
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb2"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1"></a><span class="im">import</span> os</span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="im">import</span> re</span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="im">import</span> json</span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb2-6"><a href="#cb2-6"></a><span class="im">import</span> logging</span>
<span id="cb2-7"><a href="#cb2-7"></a><span class="im">from</span> collections <span class="im">import</span> defaultdict</span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="im">import</span> time</span>
<span id="cb2-9"><a href="#cb2-9"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb2-10"><a href="#cb2-10"></a><span class="im">import</span> string</span>
<span id="cb2-11"><a href="#cb2-11"></a><span class="im">import</span> googlemaps</span>
<span id="cb2-12"><a href="#cb2-12"></a><span class="im">import</span> zipfile</span>
<span id="cb2-13"><a href="#cb2-13"></a></span>
<span id="cb2-14"><a href="#cb2-14"></a><span class="im">from</span> utils <span class="im">import</span> (</span>
<span id="cb2-15"><a href="#cb2-15"></a>    load_env_vars,</span>
<span id="cb2-16"><a href="#cb2-16"></a>    normalize_location,</span>
<span id="cb2-17"><a href="#cb2-17"></a>    load_json_cache,</span>
<span id="cb2-18"><a href="#cb2-18"></a>    save_json_cache,</span>
<span id="cb2-19"><a href="#cb2-19"></a>    fetch_pdf_links,</span>
<span id="cb2-20"><a href="#cb2-20"></a>    download_pdf,</span>
<span id="cb2-21"><a href="#cb2-21"></a>    extract_data_from_pdf,</span>
<span id="cb2-22"><a href="#cb2-22"></a>    clean_narrative_basic,</span>
<span id="cb2-23"><a href="#cb2-23"></a>    process_narrative_nlp,</span>
<span id="cb2-24"><a href="#cb2-24"></a>    parse_date,</span>
<span id="cb2-25"><a href="#cb2-25"></a>    clean_text,</span>
<span id="cb2-26"><a href="#cb2-26"></a>    get_lat_long,</span>
<span id="cb2-27"><a href="#cb2-27"></a>    get_api_call_count,</span>
<span id="cb2-28"><a href="#cb2-28"></a>    extract_year,</span>
<span id="cb2-29"><a href="#cb2-29"></a>    git_commit_and_push</span>
<span id="cb2-30"><a href="#cb2-30"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<ul>
<li><p><strong>Standard Libraries</strong>: <code>os</code>, <code>re</code>, <code>json</code>, <code>pandas</code>, <code>pathlib</code>, <code>logging</code>, <code>collections</code>, <code>time</code>, <code>datetime</code>, <code>string</code>, <code>zipfile</code></p></li>
<li><p><strong>Third-Party Libraries</strong>: <code>googlemaps</code></p></li>
<li><p><strong>Local Utilities</strong>: Functions imported from <code>utils.py</code></p></li>
</ul>
<p><strong>Main Functionality</strong>: The <code>main()</code> function serves as the entry point, executing the following steps:</p>
<ol type="1">
<li><p><strong>Environment Setup</strong>:</p>
<ul>
<li><p>Determines the script’s directory.</p></li>
<li><p>Loads environment variables from <code>env_vars.txt</code>.</p></li>
<li><p>Initializes the Google Maps client using the API key.</p></li>
</ul></li>
<li><p><strong>Directory and Path Configuration</strong>:</p>
<ul>
<li><p>Sets up directories for downloading PDFs, storing data, and caching.</p></li>
<li><p>Defines paths for output CSV and ZIP files.</p></li>
</ul></li>
<li><p><strong>Cache Management</strong>:</p>
<ul>
<li><p>Loads existing caches to avoid redundant processing.</p></li>
<li><p>Tracks already processed complaint numbers to prevent duplicates.</p></li>
</ul></li>
<li><p><strong>PDF Processing Loop</strong>:</p>
<ul>
<li><p>Fetches PDF links from the OPPD website.</p></li>
<li><p>Downloads each PDF unless it’s already processed and unchanged.</p></li>
<li><p>Extracts crime data from PDFs, handling errors and logging.</p></li>
</ul></li>
<li><p><strong>Data Aggregation and Storage</strong>:</p>
<ul>
<li><p>Combines new data with existing data, removes duplicates, and sorts by date.</p></li>
<li><p>Compresses the aggregated data into a ZIP file.</p></li>
</ul></li>
<li><p><strong>Logging and Reporting</strong>:</p>
<ul>
<li><p>Records processing statistics and errors.</p></li>
<li><p>Saves logs to a dated log file.</p></li>
<li><p>Calculates and records the error rate in <code>error_rate.txt</code> for the current run.</p></li>
</ul></li>
<li><p><strong>GitHub Integration</strong>:</p>
<ul>
<li>Commits and pushes the updated data to a GitHub repository.</li>
</ul></li>
</ol>
<p><strong>Sample Code Snippet</strong>:</p>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb3"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1"></a><span class="kw">def</span> main():</span>
<span id="cb3-2"><a href="#cb3-2"></a>    start_time <span class="op">=</span> time.time()</span>
<span id="cb3-3"><a href="#cb3-3"></a>    start_time_str <span class="op">=</span> datetime.now().strftime(<span class="st">"%Y-%m-</span><span class="sc">%d</span><span class="st"> %H:%M:%S"</span>)</span>
<span id="cb3-4"><a href="#cb3-4"></a></span>
<span id="cb3-5"><a href="#cb3-5"></a>    <span class="co"># Determine the directory where this script resides</span></span>
<span id="cb3-6"><a href="#cb3-6"></a>    script_dir <span class="op">=</span> Path(<span class="va">__file__</span>).parent.resolve()</span>
<span id="cb3-7"><a href="#cb3-7"></a></span>
<span id="cb3-8"><a href="#cb3-8"></a>    <span class="co"># Path to the environment variables file relative to script directory</span></span>
<span id="cb3-9"><a href="#cb3-9"></a>    env_file_path <span class="op">=</span> script_dir <span class="op">/</span> <span class="st">"env_vars.txt"</span></span>
<span id="cb3-10"><a href="#cb3-10"></a></span>
<span id="cb3-11"><a href="#cb3-11"></a>    <span class="co"># Load environment variables</span></span>
<span id="cb3-12"><a href="#cb3-12"></a>    <span class="cf">try</span>:</span>
<span id="cb3-13"><a href="#cb3-13"></a>        load_env_vars(env_file_path)</span>
<span id="cb3-14"><a href="#cb3-14"></a>    <span class="cf">except</span> <span class="pp">FileNotFoundError</span> <span class="im">as</span> e:</span>
<span id="cb3-15"><a href="#cb3-15"></a>        <span class="bu">print</span>(e)</span>
<span id="cb3-16"><a href="#cb3-16"></a>        <span class="cf">return</span></span>
<span id="cb3-17"><a href="#cb3-17"></a>    </span>
<span id="cb3-18"><a href="#cb3-18"></a>    googlemaps_api_key <span class="op">=</span> os.getenv(<span class="st">"GOOGLEMAPS_API_KEY"</span>)</span>
<span id="cb3-19"><a href="#cb3-19"></a>    <span class="cf">if</span> <span class="kw">not</span> googlemaps_api_key:</span>
<span id="cb3-20"><a href="#cb3-20"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Google Maps API key not found in environment variables."</span>)</span>
<span id="cb3-21"><a href="#cb3-21"></a></span>
<span id="cb3-22"><a href="#cb3-22"></a>    <span class="co"># Initialize Google Maps client</span></span>
<span id="cb3-23"><a href="#cb3-23"></a>    <span class="cf">try</span>:</span>
<span id="cb3-24"><a href="#cb3-24"></a>        gmaps_client <span class="op">=</span> googlemaps.Client(key<span class="op">=</span>googlemaps_api_key)</span>
<span id="cb3-25"><a href="#cb3-25"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb3-26"><a href="#cb3-26"></a>        logging.critical(<span class="ss">f"Failed to initialize Google Maps client: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-27"><a href="#cb3-27"></a>        <span class="bu">print</span>(<span class="ss">f"Failed to initialize Google Maps client: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-28"><a href="#cb3-28"></a>        <span class="cf">return</span></span>
<span id="cb3-29"><a href="#cb3-29"></a></span>
<span id="cb3-30"><a href="#cb3-30"></a>    <span class="co"># Define paths relative to script directory</span></span>
<span id="cb3-31"><a href="#cb3-31"></a>    base_url <span class="op">=</span> <span class="st">'https://www.oak-park.us/village-services/police-department/police-activity-summary-reports'</span></span>
<span id="cb3-32"><a href="#cb3-32"></a>    download_dir <span class="op">=</span> script_dir <span class="op">/</span> <span class="st">'downloaded_pdfs'</span></span>
<span id="cb3-33"><a href="#cb3-33"></a>    data_dir <span class="op">=</span> script_dir <span class="op">/</span> <span class="st">'data'</span></span>
<span id="cb3-34"><a href="#cb3-34"></a>    cache_dir <span class="op">=</span> script_dir <span class="op">/</span> <span class="st">'cache'</span></span>
<span id="cb3-35"><a href="#cb3-35"></a>    data_dir.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-36"><a href="#cb3-36"></a>    cache_dir.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-37"><a href="#cb3-37"></a></span>
<span id="cb3-38"><a href="#cb3-38"></a>    <span class="co"># ...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p><strong>Explanation</strong>:</p>
<ul>
<li><p><strong>Environment Variables</strong>: Critical for configuring API keys and repository paths without hardcoding sensitive information.</p></li>
<li><p><strong>Google Maps Client</strong>: Essential for geocoding addresses to latitude and longitude coordinates.</p></li>
<li><p><strong>Directory Setup</strong>: Organizes downloaded PDFs, processed data, and caches systematically.</p></li>
</ul>
</section>
<section id="utils.py" class="level4">
<h4 class="anchored" data-anchor-id="utils.py"><strong>2. <code>utils.py</code></strong></h4>
<p><strong>Purpose</strong>:<br>
<code>utils.py</code> contains a collection of helper functions that support the main data parsing operations. These functions handle tasks such as loading environment variables, normalizing location strings, caching mechanisms, PDF link fetching, PDF downloading, text cleaning, date parsing, geocoding, and GitHub file uploads.</p>
<p><strong>Key Functions</strong>:</p>
<ol type="1">
<li><p><strong>Environment Management</strong>:</p>
<ul>
<li><code>load_env_vars(file_path)</code>: Loads environment variables from a specified file.</li>
</ul></li>
<li><p><strong>Data Normalization and Cleaning</strong>:</p>
<ul>
<li><p><code>normalize_location(loc_str)</code>: Standardizes location strings for consistency.</p></li>
<li><p><code>clean_text(text)</code>: Cleans raw text extracted from PDFs.</p></li>
<li><p><code>parse_date(date_str)</code>: Parses various date formats into a standardized <code>YYYY-MM-DD</code> format.</p></li>
</ul></li>
<li><p><strong>Caching Mechanisms</strong>:</p>
<ul>
<li><p><code>load_json_cache(cache_path)</code>: Loads cache data from a JSON file.</p></li>
<li><p><code>save_json_cache(cache_path, data)</code>: Saves cache data to a JSON file.</p></li>
</ul></li>
<li><p><strong>PDF Handling</strong>:</p>
<ul>
<li><p><code>fetch_pdf_links(base_url)</code>: Scrapes the OPPD website to retrieve PDF report links.</p></li>
<li><p><code>download_pdf(url, download_dir, redownload=False)</code>: Downloads PDFs from given URLs.</p></li>
</ul></li>
<li><p><strong>Data Extraction and Processing</strong>:</p>
<ul>
<li><p><code>extract_data_from_pdf(file_path, gmaps_client, location_cache, reprocess_locs, existing_complaint_numbers)</code>: Extracts structured crime data from PDFs.</p></li>
<li><p><code>clean_narrative_basic(narrative)</code>: Performs basic cleaning on narrative text.</p></li>
<li><p><code>process_narrative_nlp(narrative)</code>: Applies NLP techniques to process narrative text.</p></li>
</ul></li>
<li><p><strong>Geocoding</strong>:</p>
<ul>
<li><p><code>get_lat_long(location_string, gmaps_client)</code>: Converts location strings to geographical coordinates using the Google Maps API.</p></li>
<li><p><code>get_api_call_count()</code>: Retrieves the count of API calls made (useful for monitoring rate limits).</p></li>
</ul></li>
<li><p><strong>GitHub Integration</strong>:</p>
<ul>
<li><p><code>upload_file_to_github(file_path, github_repo_path, target_subfolder)</code>: Uploads a single file to a specified GitHub repository subfolder.</p></li>
<li><p><code>upload_files_to_github_batch(file_paths, github_repo_path, target_subfolder)</code>: Facilitates batch uploading of multiple files.</p></li>
<li><p><code>git_commit_and_push(repo_path, commit_message)</code>: Commits and pushes changes to the GitHub repository, handling authentication and potential conflicts.</p></li>
</ul></li>
</ol>
<p><strong>Sample Code Snippet</strong>:</p>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb4"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1"></a><span class="kw">def</span> extract_data_from_pdf(file_path, gmaps_client, location_cache, reprocess_locs, existing_complaint_numbers):</span>
<span id="cb4-2"><a href="#cb4-2"></a>    <span class="co">"""</span></span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="co">    Extract data from PDF, returning (report, log_entries).</span></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="co">    Only processes complaints not already in existing_complaint_numbers.</span></span>
<span id="cb4-5"><a href="#cb4-5"></a></span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="co">    Args:</span></span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="co">        file_path (str or Path): Path to the PDF file.</span></span>
<span id="cb4-8"><a href="#cb4-8"></a><span class="co">        gmaps_client (googlemaps.Client): Initialized Google Maps client.</span></span>
<span id="cb4-9"><a href="#cb4-9"></a><span class="co">        location_cache (dict): Cache of normalized locations to (lat, lng).</span></span>
<span id="cb4-10"><a href="#cb4-10"></a><span class="co">        reprocess_locs (bool): Flag to force reprocessing of locations.</span></span>
<span id="cb4-11"><a href="#cb4-11"></a><span class="co">        existing_complaint_numbers (set): Set of complaint numbers already processed.</span></span>
<span id="cb4-12"><a href="#cb4-12"></a></span>
<span id="cb4-13"><a href="#cb4-13"></a><span class="co">    Returns:</span></span>
<span id="cb4-14"><a href="#cb4-14"></a><span class="co">        tuple: (list of report entries, list of log entries)</span></span>
<span id="cb4-15"><a href="#cb4-15"></a><span class="co">    """</span></span>
<span id="cb4-16"><a href="#cb4-16"></a>    <span class="cf">try</span>:</span>
<span id="cb4-17"><a href="#cb4-17"></a>        reader <span class="op">=</span> PdfReader(file_path)</span>
<span id="cb4-18"><a href="#cb4-18"></a>        raw_text <span class="op">=</span> <span class="st">" "</span>.join([page.extract_text() <span class="kw">or</span> <span class="st">""</span> <span class="cf">for</span> page <span class="kw">in</span> reader.pages])</span>
<span id="cb4-19"><a href="#cb4-19"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb4-20"><a href="#cb4-20"></a>        logging.error(<span class="ss">f"Failed to read PDF '</span><span class="sc">{</span>file_path<span class="sc">}</span><span class="ss">': </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-21"><a href="#cb4-21"></a>        <span class="cf">return</span> [], [<span class="ss">f"Failed to read PDF '</span><span class="sc">{</span>file_path<span class="sc">}</span><span class="ss">': </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>]</span>
<span id="cb4-22"><a href="#cb4-22"></a>    text <span class="op">=</span> clean_text(raw_text)</span>
<span id="cb4-23"><a href="#cb4-23"></a>    base_url_static <span class="op">=</span> <span class="st">'https://www.oak-park.us/sites/default/files/police/summaries/'</span></span>
<span id="cb4-24"><a href="#cb4-24"></a>    <span class="co"># Log a preview of the cleaned text</span></span>
<span id="cb4-25"><a href="#cb4-25"></a>    logging.debug(<span class="ss">f"Cleaned Text Preview (first 500 chars): </span><span class="sc">{</span>text[:<span class="dv">500</span>]<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb4-26"><a href="#cb4-26"></a>    </span>
<span id="cb4-27"><a href="#cb4-27"></a>    complaint_pattern <span class="op">=</span> <span class="vs">r"COMPLAINT NUMBER:\s*(\d</span><span class="sc">{2}</span><span class="vs">-\d</span><span class="sc">{5}</span><span class="vs">)"</span></span>
<span id="cb4-28"><a href="#cb4-28"></a>    offense_pattern   <span class="op">=</span> <span class="vs">r"OFFENSE:\s+([A-Z\s]+)"</span></span>
<span id="cb4-29"><a href="#cb4-29"></a>    date_pattern      <span class="op">=</span> <span class="vs">r"DATE\(S\)\s*:?\s+([A-Za-z0-9\s&amp;\-–—/]+?)(?=\s+TIME\(S\)|\s+$)"</span></span>
<span id="cb4-30"><a href="#cb4-30"></a>    time_pattern      <span class="op">=</span> <span class="vs">r"TIME\(S\):\s+([\d:HRS\s\-–—]+)"</span></span>
<span id="cb4-31"><a href="#cb4-31"></a>    location_pattern  <span class="op">=</span> <span class="vs">r"LOCATION:\s+(.+?)(?=\s+(?:VICTIM/ADDRESS|NARRATIVE|NARRITIVE|NARRTIVE))"</span></span>
<span id="cb4-32"><a href="#cb4-32"></a>    victim_pattern    <span class="op">=</span> <span class="vs">r"VICTIM/ADDRESS:\s+(.+?)(?=\s+NARRATIVE|NARRITIVE|NARRTIVE)"</span></span>
<span id="cb4-33"><a href="#cb4-33"></a>    narrative_pattern <span class="op">=</span> <span class="vs">r"NARR(?:ATIVE|ITIVE|TIVE)\s*:\s+(.+?)(?=COMPLAINT NUMBER|$)"</span></span>
<span id="cb4-34"><a href="#cb4-34"></a></span>
<span id="cb4-35"><a href="#cb4-35"></a>    complaints <span class="op">=</span> re.findall(complaint_pattern, text)</span>
<span id="cb4-36"><a href="#cb4-36"></a>    offenses   <span class="op">=</span> re.findall(offense_pattern, text)</span>
<span id="cb4-37"><a href="#cb4-37"></a>    dates      <span class="op">=</span> re.findall(date_pattern, text)</span>
<span id="cb4-38"><a href="#cb4-38"></a>    times      <span class="op">=</span> re.findall(time_pattern, text)</span>
<span id="cb4-39"><a href="#cb4-39"></a>    locations  <span class="op">=</span> re.findall(location_pattern, text)</span>
<span id="cb4-40"><a href="#cb4-40"></a>    victims    <span class="op">=</span> re.findall(victim_pattern, text)</span>
<span id="cb4-41"><a href="#cb4-41"></a>    narratives <span class="op">=</span> re.findall(narrative_pattern, text)</span>
<span id="cb4-42"><a href="#cb4-42"></a>    </span>
<span id="cb4-43"><a href="#cb4-43"></a>    <span class="co"># Clean offenses</span></span>
<span id="cb4-44"><a href="#cb4-44"></a>    offenses <span class="op">=</span> [o.replace(<span class="st">"DATE"</span>, <span class="st">""</span>).strip() <span class="cf">for</span> o <span class="kw">in</span> offenses]</span>
<span id="cb4-45"><a href="#cb4-45"></a>    </span>
<span id="cb4-46"><a href="#cb4-46"></a>    report <span class="op">=</span> []</span>
<span id="cb4-47"><a href="#cb4-47"></a>    log_entries <span class="op">=</span> []</span>
<span id="cb4-48"><a href="#cb4-48"></a>    time.sleep(<span class="fl">0.2</span>)  <span class="co"># Respectful pause for API calls</span></span>
<span id="cb4-49"><a href="#cb4-49"></a>    </span>
<span id="cb4-50"><a href="#cb4-50"></a>    num_entries <span class="op">=</span> <span class="bu">len</span>(complaints)</span>
<span id="cb4-51"><a href="#cb4-51"></a>    logging.debug(<span class="ss">f"Number of complaints found: </span><span class="sc">{</span>num_entries<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-52"><a href="#cb4-52"></a>    </span>
<span id="cb4-53"><a href="#cb4-53"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(num_entries):</span>
<span id="cb4-54"><a href="#cb4-54"></a>        <span class="cf">try</span>:</span>
<span id="cb4-55"><a href="#cb4-55"></a>            <span class="co"># Safe indexing</span></span>
<span id="cb4-56"><a href="#cb4-56"></a>            comp_num <span class="op">=</span> complaints[i] <span class="cf">if</span> i <span class="op">&lt;</span> <span class="bu">len</span>(complaints) <span class="cf">else</span> <span class="st">"N/A"</span></span>
<span id="cb4-57"><a href="#cb4-57"></a>            </span>
<span id="cb4-58"><a href="#cb4-58"></a>            <span class="co"># Skip already processed complaints</span></span>
<span id="cb4-59"><a href="#cb4-59"></a>            <span class="cf">if</span> comp_num <span class="kw">in</span> existing_complaint_numbers:</span>
<span id="cb4-60"><a href="#cb4-60"></a>                logging.info(<span class="ss">f"Skipping already processed Complaint # </span><span class="sc">{</span>comp_num<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-61"><a href="#cb4-61"></a>                <span class="cf">continue</span></span>
<span id="cb4-62"><a href="#cb4-62"></a></span>
<span id="cb4-63"><a href="#cb4-63"></a>            <span class="co"># Extract other fields</span></span>
<span id="cb4-64"><a href="#cb4-64"></a>            offense  <span class="op">=</span> offenses[i].strip() <span class="cf">if</span> i <span class="op">&lt;</span> <span class="bu">len</span>(offenses) <span class="cf">else</span> <span class="st">"N/A"</span></span>
<span id="cb4-65"><a href="#cb4-65"></a>            time_str <span class="op">=</span> times[i].strip() <span class="cf">if</span> i <span class="op">&lt;</span> <span class="bu">len</span>(times) <span class="cf">else</span> <span class="st">"N/A"</span></span>
<span id="cb4-66"><a href="#cb4-66"></a>            loc_str  <span class="op">=</span> locations[i].strip() <span class="cf">if</span> i <span class="op">&lt;</span> <span class="bu">len</span>(locations) <span class="cf">else</span> <span class="st">"N/A"</span></span>
<span id="cb4-67"><a href="#cb4-67"></a>            victim   <span class="op">=</span> victims[i].strip() <span class="cf">if</span> i <span class="op">&lt;</span> <span class="bu">len</span>(victims) <span class="cf">else</span> <span class="st">"N/A"</span></span>
<span id="cb4-68"><a href="#cb4-68"></a>            narr_raw <span class="op">=</span> narratives[i].strip() <span class="cf">if</span> i <span class="op">&lt;</span> <span class="bu">len</span>(narratives) <span class="cf">else</span> <span class="st">"N/A"</span></span>
<span id="cb4-69"><a href="#cb4-69"></a></span>
<span id="cb4-70"><a href="#cb4-70"></a>            <span class="co"># ...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p><strong>Explanation</strong>:</p>
<ul>
<li><p><strong>PDF Reading</strong>: Utilizes <code>PyPDF2.PdfReader</code> to extract text from each page of the PDF.</p></li>
<li><p><strong>Regex Patterns</strong>: Defined to capture specific sections like Complaint Number, Offense, Date, Time, Location, Victim Address, and Narrative. Of note is capturing different variations of date and of capturing various spellings.</p></li>
<li><p><strong>Data Extraction</strong>: Uses <code>re.findall</code> to extract relevant data based on the defined patterns.</p></li>
<li><p><strong>Data Cleaning</strong>: Processes extracted data to ensure consistency and accuracy.</p></li>
<li><p><strong>Duplicate Handling</strong>: Skips complaints that have already been processed to prevent duplication.</p></li>
</ul>
</section>
<section id="detailed-code-breakdown" class="level4">
<h4 class="anchored" data-anchor-id="detailed-code-breakdown"><strong>Detailed Code Breakdown</strong></h4>
<p>Let’s delve deeper into some of the critical functions within <code>utils.py</code> to understand their roles and implementations.</p>
<section id="a.-environment-variables-loading" class="level5">
<h5 class="anchored" data-anchor-id="a.-environment-variables-loading"><strong>a. Environment Variables Loading</strong></h5>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb5"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1"></a><span class="kw">def</span> load_env_vars(file_path):</span>
<span id="cb5-2"><a href="#cb5-2"></a>    <span class="co">"""</span></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="co">    Load environment variables from a file and set them in os.environ.</span></span>
<span id="cb5-4"><a href="#cb5-4"></a></span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="co">    Args:</span></span>
<span id="cb5-6"><a href="#cb5-6"></a><span class="co">        file_path (str or Path): The path to the environment variables file.</span></span>
<span id="cb5-7"><a href="#cb5-7"></a></span>
<span id="cb5-8"><a href="#cb5-8"></a><span class="co">    Raises:</span></span>
<span id="cb5-9"><a href="#cb5-9"></a><span class="co">        FileNotFoundError: If the specified file does not exist.</span></span>
<span id="cb5-10"><a href="#cb5-10"></a><span class="co">    """</span></span>
<span id="cb5-11"><a href="#cb5-11"></a>    env_file <span class="op">=</span> Path(file_path)</span>
<span id="cb5-12"><a href="#cb5-12"></a>    <span class="cf">if</span> <span class="kw">not</span> env_file.exists():</span>
<span id="cb5-13"><a href="#cb5-13"></a>        <span class="cf">raise</span> <span class="pp">FileNotFoundError</span>(<span class="ss">f"Environment file '</span><span class="sc">{</span>file_path<span class="sc">}</span><span class="ss">' not found."</span>)</span>
<span id="cb5-14"><a href="#cb5-14"></a>    </span>
<span id="cb5-15"><a href="#cb5-15"></a>    <span class="cf">with</span> env_file.<span class="bu">open</span>(<span class="st">'r'</span>) <span class="im">as</span> f:</span>
<span id="cb5-16"><a href="#cb5-16"></a>        <span class="cf">for</span> line <span class="kw">in</span> f:</span>
<span id="cb5-17"><a href="#cb5-17"></a>            <span class="co"># Remove leading/trailing whitespace</span></span>
<span id="cb5-18"><a href="#cb5-18"></a>            line <span class="op">=</span> line.strip()</span>
<span id="cb5-19"><a href="#cb5-19"></a>            <span class="co"># Skip empty lines and comments</span></span>
<span id="cb5-20"><a href="#cb5-20"></a>            <span class="cf">if</span> <span class="kw">not</span> line <span class="kw">or</span> line.startswith(<span class="st">'#'</span>):</span>
<span id="cb5-21"><a href="#cb5-21"></a>                <span class="cf">continue</span></span>
<span id="cb5-22"><a href="#cb5-22"></a>            <span class="co"># Split into key and value</span></span>
<span id="cb5-23"><a href="#cb5-23"></a>            <span class="cf">if</span> <span class="st">'='</span> <span class="kw">in</span> line:</span>
<span id="cb5-24"><a href="#cb5-24"></a>                key, value <span class="op">=</span> line.split(<span class="st">'='</span>, <span class="dv">1</span>)</span>
<span id="cb5-25"><a href="#cb5-25"></a>                key <span class="op">=</span> key.strip()</span>
<span id="cb5-26"><a href="#cb5-26"></a>                value <span class="op">=</span> value.strip()</span>
<span id="cb5-27"><a href="#cb5-27"></a>                os.environ[key] <span class="op">=</span> value</span>
<span id="cb5-28"><a href="#cb5-28"></a>                <span class="bu">print</span>(<span class="ss">f"Loaded environment variable"</span>)  </span>
<span id="cb5-29"><a href="#cb5-29"></a>            <span class="cf">else</span>:</span>
<span id="cb5-30"><a href="#cb5-30"></a>                <span class="bu">print</span>(<span class="ss">f"Ignoring invalid line in env file"</span>)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p><strong>Functionality</strong>:</p>
<ul>
<li><p><strong>Purpose</strong>: Reads a file containing environment variables and sets them in the <code>os.environ</code> dictionary for use throughout the application.</p></li>
<li><p><strong>Error Handling</strong>: Raises a <code>FileNotFoundError</code> if the specified environment file does not exist.</p></li>
<li><p><strong>Parsing Logic</strong>:</p>
<ul>
<li><p>Ignores empty lines and lines starting with <code>#</code> (comments).</p></li>
<li><p>Splits each valid line into a key-value pair based on the <code>=</code> delimiter.</p></li>
<li><p>Trims whitespace and sets the environment variable.</p></li>
</ul></li>
</ul>
<p><strong>Usage</strong>: This function ensures that sensitive information like API keys and repository paths are not hardcoded into the scripts but are instead loaded securely from an external file.</p>
</section>
<section id="b.-location-normalization" class="level5">
<h5 class="anchored" data-anchor-id="b.-location-normalization"><strong>b. Location Normalization</strong></h5>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb6"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1"></a><span class="kw">def</span> normalize_location(loc_str):</span>
<span id="cb6-2"><a href="#cb6-2"></a>    <span class="co">"""</span></span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="co">    Normalize the location string to ensure consistency in caching.</span></span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="co">    </span></span>
<span id="cb6-5"><a href="#cb6-5"></a><span class="co">    Steps:</span></span>
<span id="cb6-6"><a href="#cb6-6"></a><span class="co">    - Convert to lowercase.</span></span>
<span id="cb6-7"><a href="#cb6-7"></a><span class="co">    - Remove leading/trailing whitespace.</span></span>
<span id="cb6-8"><a href="#cb6-8"></a><span class="co">    - Remove punctuation.</span></span>
<span id="cb6-9"><a href="#cb6-9"></a><span class="co">    - Replace multiple spaces with a single space.</span></span>
<span id="cb6-10"><a href="#cb6-10"></a><span class="co">    - Standardize common street suffixes.</span></span>
<span id="cb6-11"><a href="#cb6-11"></a><span class="co">    </span></span>
<span id="cb6-12"><a href="#cb6-12"></a><span class="co">    Args:</span></span>
<span id="cb6-13"><a href="#cb6-13"></a><span class="co">        loc_str (str or float): The original location string.</span></span>
<span id="cb6-14"><a href="#cb6-14"></a></span>
<span id="cb6-15"><a href="#cb6-15"></a><span class="co">    Returns:</span></span>
<span id="cb6-16"><a href="#cb6-16"></a><span class="co">        str: The normalized location string.</span></span>
<span id="cb6-17"><a href="#cb6-17"></a><span class="co">    """</span></span>
<span id="cb6-18"><a href="#cb6-18"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(loc_str, <span class="bu">str</span>):</span>
<span id="cb6-19"><a href="#cb6-19"></a>        <span class="cf">if</span> pd.isna(loc_str):</span>
<span id="cb6-20"><a href="#cb6-20"></a>            loc_str <span class="op">=</span> <span class="st">""</span></span>
<span id="cb6-21"><a href="#cb6-21"></a>        <span class="cf">else</span>:</span>
<span id="cb6-22"><a href="#cb6-22"></a>            loc_str <span class="op">=</span> <span class="bu">str</span>(loc_str)</span>
<span id="cb6-23"><a href="#cb6-23"></a>    </span>
<span id="cb6-24"><a href="#cb6-24"></a>    <span class="cf">if</span> <span class="kw">not</span> loc_str:</span>
<span id="cb6-25"><a href="#cb6-25"></a>        <span class="cf">return</span> <span class="st">""</span></span>
<span id="cb6-26"><a href="#cb6-26"></a>    </span>
<span id="cb6-27"><a href="#cb6-27"></a>    <span class="co"># Convert to lowercase</span></span>
<span id="cb6-28"><a href="#cb6-28"></a>    loc_str <span class="op">=</span> loc_str.lower()</span>
<span id="cb6-29"><a href="#cb6-29"></a>    <span class="co"># Remove leading/trailing whitespace</span></span>
<span id="cb6-30"><a href="#cb6-30"></a>    loc_str <span class="op">=</span> loc_str.strip()</span>
<span id="cb6-31"><a href="#cb6-31"></a>    <span class="co"># Remove punctuation</span></span>
<span id="cb6-32"><a href="#cb6-32"></a>    loc_str <span class="op">=</span> loc_str.translate(<span class="bu">str</span>.maketrans(<span class="st">''</span>, <span class="st">''</span>, string.punctuation))</span>
<span id="cb6-33"><a href="#cb6-33"></a>    <span class="co"># Replace multiple spaces with a single space</span></span>
<span id="cb6-34"><a href="#cb6-34"></a>    loc_str <span class="op">=</span> re.sub(<span class="vs">r'\s+'</span>, <span class="st">' '</span>, loc_str)</span>
<span id="cb6-35"><a href="#cb6-35"></a>    <span class="co"># Standardize suffixes</span></span>
<span id="cb6-36"><a href="#cb6-36"></a>    loc_str <span class="op">=</span> standardize_suffix(loc_str)</span>
<span id="cb6-37"><a href="#cb6-37"></a>    <span class="cf">return</span> loc_str</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p><strong>Functionality</strong>:</p>
<ul>
<li><p><strong>Purpose</strong>: Ensures that location strings are consistently formatted to improve caching efficiency and reduce redundancy.</p></li>
<li><p><strong>Normalization Steps</strong>:</p>
<ol type="1">
<li><p><strong>Type Handling</strong>: Converts non-string inputs to strings, handling missing values gracefully.</p></li>
<li><p><strong>Case Conversion</strong>: Transforms the string to lowercase to ensure case-insensitive matching.</p></li>
<li><p><strong>Whitespace Trimming</strong>: Removes unnecessary leading and trailing spaces.</p></li>
<li><p><strong>Punctuation Removal</strong>: Strips out all punctuation to avoid discrepancies caused by different punctuation marks.</p></li>
<li><p><strong>Whitespace Reduction</strong>: Collapses multiple spaces into a single space for uniformity.</p></li>
<li><p><strong>Suffix Standardization</strong>: Converts common street suffixes (e.g., “st” to “street”) to a standardized form.</p></li>
</ol></li>
</ul>
</section>
<section id="c.-pdf-link-fetching" class="level5">
<h5 class="anchored" data-anchor-id="c.-pdf-link-fetching"><strong>c.&nbsp;PDF Link Fetching</strong></h5>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb7"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1"></a><span class="kw">def</span> fetch_pdf_links(base_url):</span>
<span id="cb7-2"><a href="#cb7-2"></a>    <span class="co">"""</span></span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="co">    Fetch PDF links from Oak Park site.</span></span>
<span id="cb7-4"><a href="#cb7-4"></a></span>
<span id="cb7-5"><a href="#cb7-5"></a><span class="co">    Args:</span></span>
<span id="cb7-6"><a href="#cb7-6"></a><span class="co">        base_url (str): The base URL to fetch PDFs from.</span></span>
<span id="cb7-7"><a href="#cb7-7"></a></span>
<span id="cb7-8"><a href="#cb7-8"></a><span class="co">    Returns:</span></span>
<span id="cb7-9"><a href="#cb7-9"></a><span class="co">        list: List of PDF URLs.</span></span>
<span id="cb7-10"><a href="#cb7-10"></a><span class="co">    """</span></span>
<span id="cb7-11"><a href="#cb7-11"></a>    <span class="cf">try</span>:</span>
<span id="cb7-12"><a href="#cb7-12"></a>        response <span class="op">=</span> requests.get(base_url)</span>
<span id="cb7-13"><a href="#cb7-13"></a>        response.raise_for_status()</span>
<span id="cb7-14"><a href="#cb7-14"></a>    <span class="cf">except</span> requests.RequestException <span class="im">as</span> e:</span>
<span id="cb7-15"><a href="#cb7-15"></a>        logging.error(<span class="ss">f"Failed to fetch PDF links from '</span><span class="sc">{</span>base_url<span class="sc">}</span><span class="ss">': </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb7-16"><a href="#cb7-16"></a>        <span class="cf">return</span> []</span>
<span id="cb7-17"><a href="#cb7-17"></a></span>
<span id="cb7-18"><a href="#cb7-18"></a>    soup <span class="op">=</span> BeautifulSoup(response.content, <span class="st">'html.parser'</span>)</span>
<span id="cb7-19"><a href="#cb7-19"></a>    pdf_links <span class="op">=</span> []</span>
<span id="cb7-20"><a href="#cb7-20"></a>    <span class="cf">for</span> link <span class="kw">in</span> soup.find_all(<span class="st">'a'</span>, href<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb7-21"><a href="#cb7-21"></a>        href <span class="op">=</span> link[<span class="st">'href'</span>]</span>
<span id="cb7-22"><a href="#cb7-22"></a>        <span class="cf">if</span> href.lower().endswith(<span class="st">'.pdf'</span>):</span>
<span id="cb7-23"><a href="#cb7-23"></a>            <span class="cf">if</span> href.startswith(<span class="st">'http'</span>):</span>
<span id="cb7-24"><a href="#cb7-24"></a>                pdf_links.append(href)</span>
<span id="cb7-25"><a href="#cb7-25"></a>            <span class="cf">else</span>:</span>
<span id="cb7-26"><a href="#cb7-26"></a>                pdf_links.append(<span class="st">'https://www.oak-park.us'</span> <span class="op">+</span> href)</span>
<span id="cb7-27"><a href="#cb7-27"></a>    <span class="cf">return</span> pdf_links</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p><strong>Functionality</strong>:</p>
<ul>
<li><p><strong>Purpose</strong>: Scrapes the OPPD website to retrieve all available PDF report links.</p></li>
<li><p><strong>Process</strong>:</p>
<ol type="1">
<li><p><strong>HTTP Request</strong>: Sends a GET request to the specified <code>base_url</code>.</p></li>
<li><p><strong>Error Handling</strong>: Logs and returns an empty list if the request fails.</p></li>
<li><p><strong>HTML Parsing</strong>: Utilizes <code>BeautifulSoup</code> to parse the HTML content.</p></li>
<li><p><strong>Link Extraction</strong>: Iterates through all <code>&lt;a&gt;</code> tags with <code>href</code> attributes, filtering those that end with <code>.pdf</code>.</p></li>
<li><p><strong>URL Formation</strong>: Ensures that all PDF links are absolute URLs by prefixing relative paths with the base domain.</p></li>
</ol></li>
</ul>
<p><strong>Usage</strong>: This function dynamically gathers all relevant PDF reports, ensuring that the data parsing pipeline remains up-to-date with the latest reports published by the OPPD.</p>
</section>
</section>
</section>
<section id="conclusion-of-data-parsing-section" class="level3">
<h3 class="anchored" data-anchor-id="conclusion-of-data-parsing-section"><strong>Conclusion of Data Parsing Section</strong></h3>
<p>The Data Parsing component is meticulously crafted to automate the extraction and preparation of crime data from PDF reports. By leveraging robust libraries like <code>PyPDF2</code>, <code>googlemaps</code>, and <code>BeautifulSoup</code>, alongside custom utility functions, the scripts ensure data accuracy, consistency, and efficiency. Caching mechanisms play a pivotal role in optimizing performance by preventing redundant downloading, processing and minimizing API calls. Additionally, seamless integration with GitHub facilitates version control and data dissemination.</p>
<hr>
</section>
</section>
<section id="live-streamlit-dashboard" class="level2">
<h2 class="anchored" data-anchor-id="live-streamlit-dashboard"><strong>Live Streamlit Dashboard</strong></h2>
<section id="overview-1" class="level3">
<h3 class="anchored" data-anchor-id="overview-1"><strong>Overview</strong></h3>
<p>The <strong>Live Streamlit Dashboard</strong> serves as the interactive frontend of the Oak Park Crime Reporting project. It provides users with a dynamic interface to explore, filter, and visualize crime data within Oak Park. Leveraging Streamlit’s capabilities, the dashboard offers:</p>
<ul>
<li><p><strong>Interactive Maps</strong>: Visual representation of crime incidents using Folium.</p></li>
<li><p><strong>Dynamic Filters</strong>: Date range and offense type filters to customize data views.</p></li>
<li><p><strong>Email Subscription</strong>: Integration with Mailchimp for users to subscribe or unsubscribe from updates.</p></li>
<li><p><strong>Navigation Links</strong>: Quick access to related resources like Portfolio, Blog, Documentation, and signing up for Email Updates.</p></li>
</ul>
<p>The primary script responsible for this component is <code>streamlit_app.py</code>.</p>
</section>
<section id="key-components-1" class="level3">
<h3 class="anchored" data-anchor-id="key-components-1"><strong>Key Components</strong></h3>
<section id="streamlit_app.py" class="level4">
<h4 class="anchored" data-anchor-id="streamlit_app.py"><strong>1. <code>streamlit_app.py</code></strong></h4>
<p><strong>Purpose</strong>:<br>
This script builds the interactive Streamlit dashboard, enabling users to filter crime data by date and offense type, visualize the data on a map, and manage email subscriptions for updates.</p>
<p><strong>Imports and Dependencies</strong>:</p>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb8"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1"></a><span class="im">import</span> streamlit <span class="im">as</span> st</span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="im">import</span> folium</span>
<span id="cb8-4"><a href="#cb8-4"></a><span class="im">from</span> streamlit_folium <span class="im">import</span> st_folium</span>
<span id="cb8-5"><a href="#cb8-5"></a><span class="im">from</span> datetime <span class="im">import</span> datetime, timedelta</span>
<span id="cb8-6"><a href="#cb8-6"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb8-7"><a href="#cb8-7"></a><span class="im">import</span> re</span>
<span id="cb8-8"><a href="#cb8-8"></a><span class="im">import</span> hashlib</span>
<span id="cb8-9"><a href="#cb8-9"></a><span class="im">import</span> requests</span>
<span id="cb8-10"><a href="#cb8-10"></a></span>
<span id="cb8-11"><a href="#cb8-11"></a><span class="co"># Define Mailchimp API details from secrets</span></span>
<span id="cb8-12"><a href="#cb8-12"></a>MAILCHIMP_API_KEY <span class="op">=</span> st.secrets[<span class="st">"mailchimp"</span>][<span class="st">"api_key"</span>]</span>
<span id="cb8-13"><a href="#cb8-13"></a>MAILCHIMP_AUDIENCE_ID <span class="op">=</span> st.secrets[<span class="st">"mailchimp"</span>][<span class="st">"audience_id"</span>]</span>
<span id="cb8-14"><a href="#cb8-14"></a>MAILCHIMP_DATA_CENTER <span class="op">=</span> st.secrets[<span class="st">"mailchimp"</span>][<span class="st">"data_center"</span>]</span>
<span id="cb8-15"><a href="#cb8-15"></a></span>
<span id="cb8-16"><a href="#cb8-16"></a><span class="co"># Mailchimp API endpoint</span></span>
<span id="cb8-17"><a href="#cb8-17"></a>MAILCHIMP_API_URL <span class="op">=</span> <span class="ss">f"https://</span><span class="sc">{</span>MAILCHIMP_DATA_CENTER<span class="sc">}</span><span class="ss">.api.mailchimp.com/3.0"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<ul>
<li><p><strong>Standard Libraries</strong>: <code>datetime</code>, <code>timedelta</code>, <code>re</code>, <code>hashlib</code>, <code>requests</code></p></li>
<li><p><strong>Third-Party Libraries</strong>: <code>streamlit</code>, <code>pandas</code>, <code>folium</code>, <code>streamlit_folium</code>, <code>numpy</code></p></li>
<li><p><strong>Mailchimp Integration</strong>: Accesses Mailchimp API credentials securely via <code>st.secrets</code></p></li>
</ul>
<p><strong>Main Functionalities</strong>:</p>
<ol type="1">
<li><p><strong>Data Loading</strong>: Reads and caches the processed crime data from a ZIP file.</p></li>
<li><p><strong>Disclaimer Enforcement</strong>: Presents a legal disclaimer that users must agree to before accessing the dashboard.</p></li>
<li><p><strong>Email Subscription Management</strong>: Allows users to subscribe or unsubscribe from email updates via Mailchimp.</p></li>
<li><p><strong>Navigation Links</strong>: Provides quick access to Portfolio, Blog, Documentation, Contact, Email Updates, and a Cumulative Map.</p></li>
<li><p><strong>Interactive Filters</strong>: Users can filter crime data by date range and offense type.</p></li>
<li><p><strong>Data Visualization</strong>: Displays filtered crime incidents on an interactive Folium map with detailed popups.</p></li>
</ol>
<p><strong>Sample Code Snippets and Explanations</strong>:</p>
<section id="a.-safe-field-handling" class="level5">
<h5 class="anchored" data-anchor-id="a.-safe-field-handling"><strong>a. Safe Field Handling</strong></h5>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb9"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1"></a><span class="kw">def</span> safe_field(value):</span>
<span id="cb9-2"><a href="#cb9-2"></a>    <span class="co">"""</span></span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="co">    Return the string version of a field or 'Not found' if it's missing/NaN/empty.</span></span>
<span id="cb9-4"><a href="#cb9-4"></a><span class="co">    """</span></span>
<span id="cb9-5"><a href="#cb9-5"></a>    <span class="cf">if</span> pd.isnull(value) <span class="kw">or</span> value <span class="op">==</span> <span class="st">""</span>:</span>
<span id="cb9-6"><a href="#cb9-6"></a>        <span class="cf">return</span> <span class="st">"Not found"</span></span>
<span id="cb9-7"><a href="#cb9-7"></a>    <span class="cf">return</span> <span class="bu">str</span>(value)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p><strong>Explanation</strong>:</p>
<ul>
<li><strong>Purpose</strong>: Ensures that all fields displayed in the dashboard are present and readable. If a field is missing (<code>NaN</code>) or empty, it returns “Not found” to maintain consistency in the UI.</li>
</ul>
</section>
<section id="b.-data-loading-with-caching" class="level5">
<h5 class="anchored" data-anchor-id="b.-data-loading-with-caching"><strong>b. Data Loading with Caching</strong></h5>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb10"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1"></a><span class="at">@st.cache_data</span></span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="kw">def</span> load_data():</span>
<span id="cb10-3"><a href="#cb10-3"></a>    <span class="co">"""</span></span>
<span id="cb10-4"><a href="#cb10-4"></a><span class="co">    Reads 'summary_report.zip' once, caching the DataFrame in memory.</span></span>
<span id="cb10-5"><a href="#cb10-5"></a><span class="co">    This prevents re-reading the file on every app rerun.</span></span>
<span id="cb10-6"><a href="#cb10-6"></a><span class="co">    """</span></span>
<span id="cb10-7"><a href="#cb10-7"></a>    df <span class="op">=</span> pd.read_csv(<span class="st">"data/summary_report.zip"</span>, compression<span class="op">=</span><span class="st">"zip"</span>, encoding<span class="op">=</span><span class="st">"cp1252"</span>)</span>
<span id="cb10-8"><a href="#cb10-8"></a>    <span class="cf">return</span> df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p><strong>Explanation</strong>:</p>
<ul>
<li><p><strong>Functionality</strong>: Loads the crime data from a compressed ZIP file and caches it using Streamlit’s <code>@st.cache_data</code> decorator.</p></li>
<li><p><strong>Benefits</strong>:</p>
<ul>
<li><p><strong>Performance</strong>: Reduces load times by preventing redundant reads.</p></li>
<li><p><strong>Efficiency</strong>: Ensures that the dashboard remains responsive, especially with large datasets.</p></li>
</ul></li>
</ul>
</section>
<section id="c.-disclaimer-gate" class="level5">
<h5 class="anchored" data-anchor-id="c.-disclaimer-gate"><strong>c.&nbsp;Disclaimer Gate</strong></h5>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb11"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1"></a><span class="kw">def</span> show_disclaimer():</span>
<span id="cb11-2"><a href="#cb11-2"></a>    <span class="co">"""</span></span>
<span id="cb11-3"><a href="#cb11-3"></a><span class="co">    Show a disclaimer 'gate' that the user must agree to in order to proceed.</span></span>
<span id="cb11-4"><a href="#cb11-4"></a><span class="co">    """</span></span>
<span id="cb11-5"><a href="#cb11-5"></a>    st.markdown(</span>
<span id="cb11-6"><a href="#cb11-6"></a>        <span class="st">"""</span></span>
<span id="cb11-7"><a href="#cb11-7"></a><span class="st">        # Important Legal Disclaimer</span></span>
<span id="cb11-8"><a href="#cb11-8"></a><span class="st">        </span></span>
<span id="cb11-9"><a href="#cb11-9"></a><span class="st">        **By using this demonstrative research tool, you acknowledge and agree**:</span></span>
<span id="cb11-10"><a href="#cb11-10"></a><span class="st">        </span></span>
<span id="cb11-11"><a href="#cb11-11"></a><span class="st">        - This tool is for **demonstration purposes only**.</span></span>
<span id="cb11-12"><a href="#cb11-12"></a><span class="st">        - The data originated from publicly available Oak Park Police Department PDF files.</span></span>
<span id="cb11-13"><a href="#cb11-13"></a><span class="st">          View the official site here: [Oak Park Police Department](https://www.oak-park.us/village-services/police-department).</span></span>
<span id="cb11-14"><a href="#cb11-14"></a><span class="st">        - During parsing, **~10%** of complaints were **omitted** due to parsing issues; </span></span>
<span id="cb11-15"><a href="#cb11-15"></a><span class="st">          thus the data is **incomplete**.</span></span>
<span id="cb11-16"><a href="#cb11-16"></a><span class="st">        - The **official** and **complete** PDF files remain with the Oak Park Police Department.</span></span>
<span id="cb11-17"><a href="#cb11-17"></a><span class="st">        - You **will not hold** the author **liable** for **any** decisions—formal or informal—based on this tool.</span></span>
<span id="cb11-18"><a href="#cb11-18"></a><span class="st">        - This tool **should not** be used in **any** official or unofficial **decision-making**.</span></span>
<span id="cb11-19"><a href="#cb11-19"></a><span class="st">        </span></span>
<span id="cb11-20"><a href="#cb11-20"></a><span class="st">        By continuing, you indicate your acceptance of these terms and disclaim all liability. </span></span>
<span id="cb11-21"><a href="#cb11-21"></a><span class="st">        """</span></span>
<span id="cb11-22"><a href="#cb11-22"></a>    )</span>
<span id="cb11-23"><a href="#cb11-23"></a>    agree <span class="op">=</span> st.checkbox(<span class="st">"I have read the disclaimer and I agree to continue."</span>)</span>
<span id="cb11-24"><a href="#cb11-24"></a>    <span class="cf">if</span> agree:</span>
<span id="cb11-25"><a href="#cb11-25"></a>        st.session_state[<span class="st">"user_agreed"</span>] <span class="op">=</span> <span class="va">True</span></span>
<span id="cb11-26"><a href="#cb11-26"></a>        st.rerun()</span>
<span id="cb11-27"><a href="#cb11-27"></a>    <span class="cf">else</span>:</span>
<span id="cb11-28"><a href="#cb11-28"></a>        st.stop()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p><strong>Explanation</strong>:</p>
<ul>
<li><p><strong>Purpose</strong>: Presents a mandatory disclaimer to users, ensuring they acknowledge the tool’s limitations and liabilities before accessing the dashboard.</p></li>
<li><p><strong>Mechanism</strong>:</p>
<ul>
<li><p><strong>Checkbox</strong>: Users must check the box indicating their agreement to proceed.</p></li>
<li><p><strong>Session State</strong>: Utilizes <code>st.session_state</code> to remember the user’s agreement across interactions.</p></li>
<li><p><strong>Flow Control</strong>: If the user does not agree, the app stops rendering further content.</p></li>
</ul></li>
</ul>
</section>
<section id="d.-email-validation-and-subscription-functions" class="level5">
<h5 class="anchored" data-anchor-id="d.-email-validation-and-subscription-functions"><strong>d.&nbsp;Email Validation and Subscription Functions</strong></h5>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb12"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1"></a><span class="kw">def</span> validate_email(email):</span>
<span id="cb12-2"><a href="#cb12-2"></a>    <span class="co">"""</span></span>
<span id="cb12-3"><a href="#cb12-3"></a><span class="co">    Validates the email format using regex.</span></span>
<span id="cb12-4"><a href="#cb12-4"></a><span class="co">    """</span></span>
<span id="cb12-5"><a href="#cb12-5"></a>    email_regex <span class="op">=</span> <span class="vs">r"(^[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+$)"</span></span>
<span id="cb12-6"><a href="#cb12-6"></a>    <span class="cf">return</span> re.match(email_regex, email) <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span></span>
<span id="cb12-7"><a href="#cb12-7"></a></span>
<span id="cb12-8"><a href="#cb12-8"></a><span class="kw">def</span> subscribe_email(email):</span>
<span id="cb12-9"><a href="#cb12-9"></a>    <span class="co">"""</span></span>
<span id="cb12-10"><a href="#cb12-10"></a><span class="co">    Subscribes an email to the Mailchimp audience.</span></span>
<span id="cb12-11"><a href="#cb12-11"></a><span class="co">    """</span></span>
<span id="cb12-12"><a href="#cb12-12"></a>    <span class="co"># Mailchimp requires the subscriber hash, which is the MD5 hash of the lowercase version of the email</span></span>
<span id="cb12-13"><a href="#cb12-13"></a>    email_lower <span class="op">=</span> email.lower().encode()</span>
<span id="cb12-14"><a href="#cb12-14"></a>    subscriber_hash <span class="op">=</span> hashlib.md5(email_lower).hexdigest()</span>
<span id="cb12-15"><a href="#cb12-15"></a></span>
<span id="cb12-16"><a href="#cb12-16"></a>    url <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>MAILCHIMP_API_URL<span class="sc">}</span><span class="ss">/lists/</span><span class="sc">{</span>MAILCHIMP_AUDIENCE_ID<span class="sc">}</span><span class="ss">/members/</span><span class="sc">{</span>subscriber_hash<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb12-17"><a href="#cb12-17"></a></span>
<span id="cb12-18"><a href="#cb12-18"></a>    data <span class="op">=</span> {</span>
<span id="cb12-19"><a href="#cb12-19"></a>        <span class="st">"email_address"</span>: email,</span>
<span id="cb12-20"><a href="#cb12-20"></a>        <span class="st">"status"</span>: <span class="st">"subscribed"</span>,  <span class="co"># Explicitly set status to 'subscribed'</span></span>
<span id="cb12-21"><a href="#cb12-21"></a>        <span class="st">"status_if_new"</span>: <span class="st">"subscribed"</span>  <span class="co"># Ensure new members are subscribed</span></span>
<span id="cb12-22"><a href="#cb12-22"></a>    }</span>
<span id="cb12-23"><a href="#cb12-23"></a></span>
<span id="cb12-24"><a href="#cb12-24"></a>    response <span class="op">=</span> requests.put(</span>
<span id="cb12-25"><a href="#cb12-25"></a>        url,</span>
<span id="cb12-26"><a href="#cb12-26"></a>        auth<span class="op">=</span>(<span class="st">"anystring"</span>, MAILCHIMP_API_KEY),</span>
<span id="cb12-27"><a href="#cb12-27"></a>        json<span class="op">=</span>data</span>
<span id="cb12-28"><a href="#cb12-28"></a>    )</span>
<span id="cb12-29"><a href="#cb12-29"></a></span>
<span id="cb12-30"><a href="#cb12-30"></a>    <span class="cf">return</span> response</span>
<span id="cb12-31"><a href="#cb12-31"></a></span>
<span id="cb12-32"><a href="#cb12-32"></a><span class="kw">def</span> unsubscribe_email(email):</span>
<span id="cb12-33"><a href="#cb12-33"></a>    <span class="co">"""</span></span>
<span id="cb12-34"><a href="#cb12-34"></a><span class="co">    Unsubscribes an email from the Mailchimp audience.</span></span>
<span id="cb12-35"><a href="#cb12-35"></a><span class="co">    """</span></span>
<span id="cb12-36"><a href="#cb12-36"></a>    <span class="co"># Mailchimp requires the subscriber hash, which is the MD5 hash of the lowercase version of the email</span></span>
<span id="cb12-37"><a href="#cb12-37"></a>    email_lower <span class="op">=</span> email.lower().encode()</span>
<span id="cb12-38"><a href="#cb12-38"></a>    subscriber_hash <span class="op">=</span> hashlib.md5(email_lower).hexdigest()</span>
<span id="cb12-39"><a href="#cb12-39"></a></span>
<span id="cb12-40"><a href="#cb12-40"></a>    url <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>MAILCHIMP_API_URL<span class="sc">}</span><span class="ss">/lists/</span><span class="sc">{</span>MAILCHIMP_AUDIENCE_ID<span class="sc">}</span><span class="ss">/members/</span><span class="sc">{</span>subscriber_hash<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb12-41"><a href="#cb12-41"></a></span>
<span id="cb12-42"><a href="#cb12-42"></a>    data <span class="op">=</span> {</span>
<span id="cb12-43"><a href="#cb12-43"></a>        <span class="st">"status"</span>: <span class="st">"unsubscribed"</span></span>
<span id="cb12-44"><a href="#cb12-44"></a>    }</span>
<span id="cb12-45"><a href="#cb12-45"></a></span>
<span id="cb12-46"><a href="#cb12-46"></a>    response <span class="op">=</span> requests.patch(</span>
<span id="cb12-47"><a href="#cb12-47"></a>        url,</span>
<span id="cb12-48"><a href="#cb12-48"></a>        auth<span class="op">=</span>(<span class="st">"anystring"</span>, MAILCHIMP_API_KEY),</span>
<span id="cb12-49"><a href="#cb12-49"></a>        json<span class="op">=</span>data</span>
<span id="cb12-50"><a href="#cb12-50"></a>    )</span>
<span id="cb12-51"><a href="#cb12-51"></a></span>
<span id="cb12-52"><a href="#cb12-52"></a>    <span class="cf">return</span> response</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p><strong>Explanation</strong>:</p>
<ul>
<li><p><strong>Email Validation</strong>:</p>
<ul>
<li><p><strong>Purpose</strong>: Ensures that users enter a correctly formatted email address before attempting subscription or unsubscription.</p></li>
<li><p><strong>Method</strong>: Uses a regular expression to match standard email formats.</p></li>
</ul></li>
<li><p><strong>Subscription Functions</strong>:</p>
<ul>
<li><p><strong><code>subscribe_email</code></strong>:</p>
<ul>
<li><p><strong>Functionality</strong>: Subscribes a user to the Mailchimp audience list.</p></li>
<li><p><strong>Process</strong>:</p>
<ul>
<li><p><strong>Hashing</strong>: Generates an MD5 hash of the email to comply with Mailchimp’s API requirements.</p></li>
<li><p><strong>API Request</strong>: Sends a PUT request to Mailchimp to add or update the subscriber’s status to “subscribed”.</p></li>
</ul></li>
</ul></li>
<li><p><strong><code>unsubscribe_email</code></strong>:</p>
<ul>
<li><p><strong>Functionality</strong>: Removes a user from the Mailchimp audience list.</p></li>
<li><p><strong>Process</strong>:</p>
<ul>
<li><p><strong>Hashing</strong>: Similar to the subscription function.</p></li>
<li><p><strong>API Request</strong>: Sends a PATCH request to update the subscriber’s status to “unsubscribed”.</p></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="e.-navigation-links" class="level5">
<h5 class="anchored" data-anchor-id="e.-navigation-links"><strong>e. Navigation Links</strong></h5>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb13"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1"></a><span class="kw">def</span> add_top_links():</span>
<span id="cb13-2"><a href="#cb13-2"></a>    <span class="co">"""</span></span>
<span id="cb13-3"><a href="#cb13-3"></a><span class="co">    Adds horizontal navigation links: Portfolio, Blog, and Email Updates.</span></span>
<span id="cb13-4"><a href="#cb13-4"></a><span class="co">    """</span></span>
<span id="cb13-5"><a href="#cb13-5"></a>    <span class="co"># Create six equal columns for the links</span></span>
<span id="cb13-6"><a href="#cb13-6"></a>    col1, col2, col3, col4, col5, col6 <span class="op">=</span> st.columns(<span class="dv">6</span>)</span>
<span id="cb13-7"><a href="#cb13-7"></a>    <span class="cf">with</span> col1:</span>
<span id="cb13-8"><a href="#cb13-8"></a>        st.markdown(<span class="st">'[**Portfolio**](https://jesse-anderson.net/)'</span>, unsafe_allow_html<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb13-9"><a href="#cb13-9"></a>    <span class="cf">with</span> col2:</span>
<span id="cb13-10"><a href="#cb13-10"></a>        st.markdown(<span class="st">'[**Blog**](https://blog.jesse-anderson.net/)'</span>, unsafe_allow_html<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb13-11"><a href="#cb13-11"></a>    <span class="cf">with</span> col3:</span>
<span id="cb13-12"><a href="#cb13-12"></a>        st.markdown(<span class="st">'[**Documentation**](https://blog.jesse-anderson.net/)'</span>, unsafe_allow_html<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb13-13"><a href="#cb13-13"></a>    <span class="cf">with</span> col4:</span>
<span id="cb13-14"><a href="#cb13-14"></a>        st.markdown(<span class="st">'[**Contact**](mailto:jesse@jesse-anderson.net?subject=Inquiry</span><span class="sc">%20f</span><span class="st">rom%20Oak%20Park%20Crime%20Map%20App&amp;body=Hello%20Jesse,%0A%0A)'</span>, unsafe_allow_html<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb13-15"><a href="#cb13-15"></a>    <span class="cf">with</span> col5:</span>
<span id="cb13-16"><a href="#cb13-16"></a>        <span class="co"># Email Updates link pointing to the email updates section</span></span>
<span id="cb13-17"><a href="#cb13-17"></a>        <span class="co">#Google forms is better. .-.</span></span>
<span id="cb13-18"><a href="#cb13-18"></a>        st.markdown(<span class="st">'[**📧 Email Updates**](https://forms.gle/GnyaVwo1Vzm8nBH6A)'</span>)</span>
<span id="cb13-19"><a href="#cb13-19"></a>    <span class="cf">with</span> col6:</span>
<span id="cb13-20"><a href="#cb13-20"></a>        <span class="co"># Cumulative static map with all crimes</span></span>
<span id="cb13-21"><a href="#cb13-21"></a>        st.markdown(<span class="st">'[**Comp. Map**](https://jesse-anderson.net/OP-Crime-Maps/crime_map_cumulative.html)'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p><strong>Explanation</strong>:</p>
<ul>
<li><p><strong>Purpose</strong>: Provides users with quick access to related resources and sections of the project.</p></li>
<li><p><strong>Layout</strong>: Utilizes Streamlit’s <code>st.columns</code> to arrange six links horizontally.</p></li>
<li><p><strong>Links Included</strong>:</p>
<ul>
<li><p><strong>Portfolio</strong>: Directs to the author’s personal portfolio.</p></li>
<li><p><strong>Blog</strong>: Links to the author’s blog.</p></li>
<li><p><strong>Documentation</strong>: Accesses the project’s documentation.</p></li>
<li><p><strong>Contact</strong>: Opens the user’s default email client to send an inquiry.</p></li>
<li><p><strong>Email Updates</strong>: Directs to a Google Forms page for email subscriptions.</p></li>
<li><p><strong>Comp. Map</strong>: Links to a cumulative static map of all crimes.</p></li>
</ul></li>
</ul>
</section>
<section id="f.-main-application-logic" class="level5">
<h5 class="anchored" data-anchor-id="f.-main-application-logic"><strong>f.&nbsp;Main Application Logic</strong></h5>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb14"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1"></a><span class="kw">def</span> main_app():</span>
<span id="cb14-2"><a href="#cb14-2"></a>    <span class="co">"""</span></span>
<span id="cb14-3"><a href="#cb14-3"></a><span class="co">    The main body of the application: date filters, offense filter, map, etc.</span></span>
<span id="cb14-4"><a href="#cb14-4"></a><span class="co">    """</span></span>
<span id="cb14-5"><a href="#cb14-5"></a></span>
<span id="cb14-6"><a href="#cb14-6"></a>    st.title(<span class="st">"Oak Park Crime Map"</span>)</span>
<span id="cb14-7"><a href="#cb14-7"></a></span>
<span id="cb14-8"><a href="#cb14-8"></a>    <span class="co"># 1) Load data from the ZIP (cached)</span></span>
<span id="cb14-9"><a href="#cb14-9"></a>    df <span class="op">=</span> load_data()</span>
<span id="cb14-10"><a href="#cb14-10"></a></span>
<span id="cb14-11"><a href="#cb14-11"></a>    <span class="co"># Convert 'Date' to datetime, remove rows with date=1900 or missing lat/long</span></span>
<span id="cb14-12"><a href="#cb14-12"></a>    df[<span class="st">'Date'</span>] <span class="op">=</span> pd.to_datetime(df[<span class="st">'Date'</span>], errors<span class="op">=</span><span class="st">'coerce'</span>)</span>
<span id="cb14-13"><a href="#cb14-13"></a>    df <span class="op">=</span> df[(df[<span class="st">'Date'</span>].notna()) <span class="op">&amp;</span> (df[<span class="st">'Date'</span>] <span class="op">!=</span> pd.Timestamp(<span class="st">"1900-01-01"</span>))]</span>
<span id="cb14-14"><a href="#cb14-14"></a>    df <span class="op">=</span> df.dropna(subset<span class="op">=</span>[<span class="st">'Lat'</span>, <span class="st">'Long'</span>])</span>
<span id="cb14-15"><a href="#cb14-15"></a></span>
<span id="cb14-16"><a href="#cb14-16"></a>    <span class="co"># Determine data's min/max date</span></span>
<span id="cb14-17"><a href="#cb14-17"></a>    min_date_in_data <span class="op">=</span> df[<span class="st">'Date'</span>].<span class="bu">min</span>().date()</span>
<span id="cb14-18"><a href="#cb14-18"></a>    max_date_in_data <span class="op">=</span> df[<span class="st">'Date'</span>].<span class="bu">max</span>().date()</span>
<span id="cb14-19"><a href="#cb14-19"></a></span>
<span id="cb14-20"><a href="#cb14-20"></a>    <span class="co"># We'll still allow up to 3 months, but default to just the last 1 month for faster display</span></span>
<span id="cb14-21"><a href="#cb14-21"></a>    today <span class="op">=</span> datetime.now().date()</span>
<span id="cb14-22"><a href="#cb14-22"></a>    </span>
<span id="cb14-23"><a href="#cb14-23"></a>    <span class="co"># Default = last 1 month</span></span>
<span id="cb14-24"><a href="#cb14-24"></a>    <span class="co"># e.g. 31 days; you can do 30 if you prefer</span></span>
<span id="cb14-25"><a href="#cb14-25"></a>    default_start <span class="op">=</span> <span class="bu">max</span>(min_date_in_data, today <span class="op">-</span> timedelta(days<span class="op">=</span><span class="dv">31</span>))</span>
<span id="cb14-26"><a href="#cb14-26"></a>    default_end   <span class="op">=</span> <span class="bu">min</span>(today, max_date_in_data)</span>
<span id="cb14-27"><a href="#cb14-27"></a></span>
<span id="cb14-28"><a href="#cb14-28"></a>    <span class="co"># Create columns with ratio [1, 2]: left filter (narrow), right map (wider)</span></span>
<span id="cb14-29"><a href="#cb14-29"></a>    col_filter, col_map <span class="op">=</span> st.columns([<span class="dv">1</span>, <span class="dv">2</span>], gap<span class="op">=</span><span class="st">"small"</span>)</span>
<span id="cb14-30"><a href="#cb14-30"></a></span>
<span id="cb14-31"><a href="#cb14-31"></a>    <span class="cf">with</span> col_filter:</span>
<span id="cb14-32"><a href="#cb14-32"></a>        st.subheader(<span class="st">"Date Range (up to 3 months)"</span>)</span>
<span id="cb14-33"><a href="#cb14-33"></a></span>
<span id="cb14-34"><a href="#cb14-34"></a>        <span class="co"># Start &amp; End date pickers</span></span>
<span id="cb14-35"><a href="#cb14-35"></a>        start_date <span class="op">=</span> st.date_input(</span>
<span id="cb14-36"><a href="#cb14-36"></a>            <span class="st">"Start Date"</span>,</span>
<span id="cb14-37"><a href="#cb14-37"></a>            value<span class="op">=</span>default_start,</span>
<span id="cb14-38"><a href="#cb14-38"></a>            min_value<span class="op">=</span>min_date_in_data,</span>
<span id="cb14-39"><a href="#cb14-39"></a>            max_value<span class="op">=</span>max_date_in_data</span>
<span id="cb14-40"><a href="#cb14-40"></a>        )</span>
<span id="cb14-41"><a href="#cb14-41"></a>        end_date <span class="op">=</span> st.date_input(</span>
<span id="cb14-42"><a href="#cb14-42"></a>            <span class="st">"End Date"</span>,</span>
<span id="cb14-43"><a href="#cb14-43"></a>            value<span class="op">=</span>default_end,</span>
<span id="cb14-44"><a href="#cb14-44"></a>            min_value<span class="op">=</span>min_date_in_data,</span>
<span id="cb14-45"><a href="#cb14-45"></a>            max_value<span class="op">=</span>max_date_in_data</span>
<span id="cb14-46"><a href="#cb14-46"></a>        )</span>
<span id="cb14-47"><a href="#cb14-47"></a></span>
<span id="cb14-48"><a href="#cb14-48"></a>        <span class="co"># Validate date logic</span></span>
<span id="cb14-49"><a href="#cb14-49"></a>        <span class="cf">if</span> end_date <span class="op">&lt;</span> start_date:</span>
<span id="cb14-50"><a href="#cb14-50"></a>            st.warning(<span class="st">"End date cannot be before start date. Please adjust."</span>)</span>
<span id="cb14-51"><a href="#cb14-51"></a>            st.stop()</span>
<span id="cb14-52"><a href="#cb14-52"></a></span>
<span id="cb14-53"><a href="#cb14-53"></a>        date_diff <span class="op">=</span> (end_date <span class="op">-</span> start_date).days</span>
<span id="cb14-54"><a href="#cb14-54"></a>        <span class="co"># Still enforce up to 3 months (~92 days)</span></span>
<span id="cb14-55"><a href="#cb14-55"></a>        <span class="cf">if</span> date_diff <span class="op">&gt;</span> <span class="dv">92</span>:</span>
<span id="cb14-56"><a href="#cb14-56"></a>            st.warning(<span class="st">"Time range cannot exceed ~3 months (92 days). Please shorten."</span>)</span>
<span id="cb14-57"><a href="#cb14-57"></a>            st.stop()</span>
<span id="cb14-58"><a href="#cb14-58"></a></span>
<span id="cb14-59"><a href="#cb14-59"></a>        <span class="co"># Filter by date</span></span>
<span id="cb14-60"><a href="#cb14-60"></a>        start_dt <span class="op">=</span> pd.to_datetime(start_date)</span>
<span id="cb14-61"><a href="#cb14-61"></a>        end_dt   <span class="op">=</span> pd.to_datetime(end_date) <span class="op">+</span> pd.Timedelta(days<span class="op">=</span><span class="dv">1</span>)  <span class="co"># inclusive</span></span>
<span id="cb14-62"><a href="#cb14-62"></a>        date_mask <span class="op">=</span> (df[<span class="st">'Date'</span>] <span class="op">&gt;=</span> start_dt) <span class="op">&amp;</span> (df[<span class="st">'Date'</span>] <span class="op">&lt;</span> end_dt)</span>
<span id="cb14-63"><a href="#cb14-63"></a>        partial_df <span class="op">=</span> df[date_mask]</span>
<span id="cb14-64"><a href="#cb14-64"></a></span>
<span id="cb14-65"><a href="#cb14-65"></a>        <span class="cf">if</span> partial_df.empty:</span>
<span id="cb14-66"><a href="#cb14-66"></a>            st.info(<span class="st">"No records found for the selected date range."</span>)</span>
<span id="cb14-67"><a href="#cb14-67"></a>            st.stop()</span>
<span id="cb14-68"><a href="#cb14-68"></a></span>
<span id="cb14-69"><a href="#cb14-69"></a>        <span class="co"># Dynamically gather offenses from partial_df</span></span>
<span id="cb14-70"><a href="#cb14-70"></a>        unique_offenses <span class="op">=</span> <span class="bu">sorted</span>(partial_df[<span class="st">'Offense'</span>].dropna().unique())</span>
<span id="cb14-71"><a href="#cb14-71"></a></span>
<span id="cb14-72"><a href="#cb14-72"></a>        st.subheader(<span class="st">"Offense Filter"</span>)</span>
<span id="cb14-73"><a href="#cb14-73"></a>        <span class="cf">with</span> st.expander(<span class="st">"Select Offenses (scrollable)"</span>, expanded<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb14-74"><a href="#cb14-74"></a>            <span class="cf">if</span> <span class="kw">not</span> unique_offenses:</span>
<span id="cb14-75"><a href="#cb14-75"></a>                st.write(<span class="st">"No offenses found for this date range."</span>)</span>
<span id="cb14-76"><a href="#cb14-76"></a>                selected_offenses <span class="op">=</span> []</span>
<span id="cb14-77"><a href="#cb14-77"></a>            <span class="cf">else</span>:</span>
<span id="cb14-78"><a href="#cb14-78"></a>                <span class="co"># By default, no offenses =&gt; show all</span></span>
<span id="cb14-79"><a href="#cb14-79"></a>                selected_offenses <span class="op">=</span> st.multiselect(</span>
<span id="cb14-80"><a href="#cb14-80"></a>                    <span class="st">"Offense(s)"</span>,</span>
<span id="cb14-81"><a href="#cb14-81"></a>                    options<span class="op">=</span>unique_offenses,</span>
<span id="cb14-82"><a href="#cb14-82"></a>                    default<span class="op">=</span>[],  <span class="co"># empty =&gt; show all</span></span>
<span id="cb14-83"><a href="#cb14-83"></a>                    <span class="bu">help</span><span class="op">=</span><span class="st">"Scroll to find more offenses. If empty =&gt; show all."</span></span>
<span id="cb14-84"><a href="#cb14-84"></a>                )</span>
<span id="cb14-85"><a href="#cb14-85"></a></span>
<span id="cb14-86"><a href="#cb14-86"></a>    <span class="co"># If user picks no offense =&gt; show all</span></span>
<span id="cb14-87"><a href="#cb14-87"></a>    <span class="cf">if</span> selected_offenses:</span>
<span id="cb14-88"><a href="#cb14-88"></a>        final_df <span class="op">=</span> partial_df[partial_df[<span class="st">'Offense'</span>].isin(selected_offenses)]</span>
<span id="cb14-89"><a href="#cb14-89"></a>    <span class="cf">else</span>:</span>
<span id="cb14-90"><a href="#cb14-90"></a>        final_df <span class="op">=</span> partial_df</span>
<span id="cb14-91"><a href="#cb14-91"></a></span>
<span id="cb14-92"><a href="#cb14-92"></a>    <span class="cf">if</span> final_df.empty:</span>
<span id="cb14-93"><a href="#cb14-93"></a>        st.info(<span class="st">"No records found for the selected offense(s)."</span>)</span>
<span id="cb14-94"><a href="#cb14-94"></a>        st.stop()</span>
<span id="cb14-95"><a href="#cb14-95"></a></span>
<span id="cb14-96"><a href="#cb14-96"></a>    <span class="co"># Truncate to 2,000</span></span>
<span id="cb14-97"><a href="#cb14-97"></a>    total_recs <span class="op">=</span> <span class="bu">len</span>(final_df)</span>
<span id="cb14-98"><a href="#cb14-98"></a>    <span class="cf">if</span> total_recs <span class="op">&gt;</span> <span class="dv">2000</span>:</span>
<span id="cb14-99"><a href="#cb14-99"></a>        st.info(<span class="ss">f"There are </span><span class="sc">{</span>total_recs<span class="sc">}</span><span class="ss"> matching records. Showing only the first 2,000."</span>)</span>
<span id="cb14-100"><a href="#cb14-100"></a>        final_df <span class="op">=</span> final_df.iloc[:<span class="dv">2000</span>]</span>
<span id="cb14-101"><a href="#cb14-101"></a>    </span>
<span id="cb14-102"><a href="#cb14-102"></a>    base_url_static <span class="op">=</span> <span class="st">'https://www.oak-park.us/sites/default/files/police/summaries/'</span></span>
<span id="cb14-103"><a href="#cb14-103"></a></span>
<span id="cb14-104"><a href="#cb14-104"></a>    <span class="cf">with</span> col_map:</span>
<span id="cb14-105"><a href="#cb14-105"></a>        st.write(<span class="ss">f"**Displaying </span><span class="sc">{</span><span class="bu">len</span>(final_df)<span class="sc">}</span><span class="ss"> records on the map**."</span>)</span>
<span id="cb14-106"><a href="#cb14-106"></a></span>
<span id="cb14-107"><a href="#cb14-107"></a>        <span class="co"># Create Folium map</span></span>
<span id="cb14-108"><a href="#cb14-108"></a>        oak_park_center <span class="op">=</span> [<span class="fl">41.885</span>, <span class="op">-</span><span class="fl">87.78</span>]</span>
<span id="cb14-109"><a href="#cb14-109"></a>        crime_map <span class="op">=</span> folium.Map(location<span class="op">=</span>oak_park_center, zoom_start<span class="op">=</span><span class="dv">13</span>)</span>
<span id="cb14-110"><a href="#cb14-110"></a></span>
<span id="cb14-111"><a href="#cb14-111"></a>        <span class="cf">for</span> _, row <span class="kw">in</span> final_df.iterrows():</span>
<span id="cb14-112"><a href="#cb14-112"></a>            complaint   <span class="op">=</span> safe_field(row.get(<span class="st">'Complaint #'</span>))</span>
<span id="cb14-113"><a href="#cb14-113"></a>            offense_val <span class="op">=</span> safe_field(row.get(<span class="st">'Offense'</span>))</span>
<span id="cb14-114"><a href="#cb14-114"></a>            date_val    <span class="op">=</span> row.get(<span class="st">'Date'</span>)</span>
<span id="cb14-115"><a href="#cb14-115"></a>            date_str    <span class="op">=</span> safe_field(date_val.strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>) <span class="cf">if</span> pd.notnull(date_val) <span class="cf">else</span> np.nan)</span>
<span id="cb14-116"><a href="#cb14-116"></a>            time_val    <span class="op">=</span> safe_field(row.get(<span class="st">'Time'</span>))</span>
<span id="cb14-117"><a href="#cb14-117"></a>            location    <span class="op">=</span> safe_field(row.get(<span class="st">'Location'</span>))</span>
<span id="cb14-118"><a href="#cb14-118"></a>            victim      <span class="op">=</span> safe_field(row.get(<span class="st">'Victim/Address'</span>))</span>
<span id="cb14-119"><a href="#cb14-119"></a>            narrative   <span class="op">=</span> safe_field(row.get(<span class="st">'Narrative'</span>))</span>
<span id="cb14-120"><a href="#cb14-120"></a>            filename <span class="op">=</span> safe_field(row.get(<span class="st">'File Name'</span>))</span>
<span id="cb14-121"><a href="#cb14-121"></a>            <span class="co"># Extract the year from the filename</span></span>
<span id="cb14-122"><a href="#cb14-122"></a>            year <span class="op">=</span> extract_year(filename)</span>
<span id="cb14-123"><a href="#cb14-123"></a>            <span class="cf">if</span> year:</span>
<span id="cb14-124"><a href="#cb14-124"></a>                base_url <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>base_url_static<span class="sc">}{</span>year<span class="sc">}</span><span class="ss">/"</span></span>
<span id="cb14-125"><a href="#cb14-125"></a>                link <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>base_url<span class="sc">}{</span>filename<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb14-126"><a href="#cb14-126"></a>            <span class="cf">else</span>:</span>
<span id="cb14-127"><a href="#cb14-127"></a>                <span class="co"># Handle cases where the year isn't found or is out of range</span></span>
<span id="cb14-128"><a href="#cb14-128"></a>                link <span class="op">=</span> <span class="st">"#"</span></span>
<span id="cb14-129"><a href="#cb14-129"></a>                st.warning(<span class="ss">f"Year not found or out of range in filename: </span><span class="sc">{</span>filename<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-130"><a href="#cb14-130"></a></span>
<span id="cb14-131"><a href="#cb14-131"></a>            popup_html <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb14-132"><a href="#cb14-132"></a><span class="ss">            &lt;b&gt;Complaint #:&lt;/b&gt; </span><span class="sc">{</span>complaint<span class="sc">}</span><span class="ss">&lt;br/&gt;</span></span>
<span id="cb14-133"><a href="#cb14-133"></a><span class="ss">            &lt;b&gt;Offense:&lt;/b&gt; </span><span class="sc">{</span>offense_val<span class="sc">}</span><span class="ss">&lt;br/&gt;</span></span>
<span id="cb14-134"><a href="#cb14-134"></a><span class="ss">            &lt;b&gt;Date:&lt;/b&gt; </span><span class="sc">{</span>date_str<span class="sc">}</span><span class="ss">&lt;br/&gt;</span></span>
<span id="cb14-135"><a href="#cb14-135"></a><span class="ss">            &lt;details&gt;</span></span>
<span id="cb14-136"><a href="#cb14-136"></a><span class="ss">              &lt;summary&gt;&lt;b&gt;View Details&lt;/b&gt;&lt;/summary&gt;</span></span>
<span id="cb14-137"><a href="#cb14-137"></a><span class="ss">              &lt;b&gt;Time:&lt;/b&gt; </span><span class="sc">{</span>time_val<span class="sc">}</span><span class="ss">&lt;br/&gt;</span></span>
<span id="cb14-138"><a href="#cb14-138"></a><span class="ss">              &lt;b&gt;Location:&lt;/b&gt; </span><span class="sc">{</span>location<span class="sc">}</span><span class="ss">&lt;br/&gt;</span></span>
<span id="cb14-139"><a href="#cb14-139"></a><span class="ss">              &lt;b&gt;Victim:&lt;/b&gt; </span><span class="sc">{</span>victim<span class="sc">}</span><span class="ss">&lt;br/&gt;</span></span>
<span id="cb14-140"><a href="#cb14-140"></a><span class="ss">              &lt;b&gt;Narrative:&lt;/b&gt; </span><span class="sc">{</span>narrative<span class="sc">}</span><span class="ss">&lt;br/&gt;</span></span>
<span id="cb14-141"><a href="#cb14-141"></a><span class="ss">              &lt;b&gt;URL:&lt;/b&gt; &lt;a href="</span><span class="sc">{</span>link<span class="sc">}</span><span class="ss">" target="_blank"&gt;PDF Link&lt;/a&gt;</span></span>
<span id="cb14-142"><a href="#cb14-142"></a><span class="ss">            &lt;/details&gt;</span></span>
<span id="cb14-143"><a href="#cb14-143"></a><span class="ss">        """</span></span>
<span id="cb14-144"><a href="#cb14-144"></a></span>
<span id="cb14-145"><a href="#cb14-145"></a>            folium.Marker(</span>
<span id="cb14-146"><a href="#cb14-146"></a>                location<span class="op">=</span>[row[<span class="st">'Lat'</span>], row[<span class="st">'Long'</span>]],</span>
<span id="cb14-147"><a href="#cb14-147"></a>                popup<span class="op">=</span>folium.Popup(popup_html, max_width<span class="op">=</span><span class="dv">400</span>),</span>
<span id="cb14-148"><a href="#cb14-148"></a>                tooltip<span class="op">=</span><span class="ss">f"Complaint # </span><span class="sc">{</span>complaint<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb14-149"><a href="#cb14-149"></a>                icon<span class="op">=</span>folium.Icon(color<span class="op">=</span><span class="st">"blue"</span>, icon<span class="op">=</span><span class="st">"info-sign"</span>)</span>
<span id="cb14-150"><a href="#cb14-150"></a>            ).add_to(crime_map)</span>
<span id="cb14-151"><a href="#cb14-151"></a></span>
<span id="cb14-152"><a href="#cb14-152"></a>        st_folium(crime_map, width<span class="op">=</span><span class="dv">1000</span>, height<span class="op">=</span><span class="dv">1000</span>, use_container_width<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p><strong>Explanation</strong>:</p>
<ul>
<li><p><strong>Title</strong>: Sets the dashboard’s title to “Oak Park Crime Map”.</p></li>
<li><p><strong>Data Filtering</strong>:</p>
<ul>
<li><p><strong>Date Conversion</strong>: Converts the ‘Date’ column to datetime objects, removing entries with invalid dates (e.g., “1900-01-01”) or missing geographical coordinates.</p></li>
<li><p><strong>Date Range Determination</strong>: Identifies the earliest and latest dates in the dataset to set the boundaries for date selection.</p></li>
<li><p><strong>Default Dates</strong>: Sets the default date range to the last 31 days, ensuring that the data displayed is recent and relevant.</p></li>
</ul></li>
<li><p><strong>Layout Setup</strong>:</p>
<ul>
<li><p><strong>Columns</strong>: Utilizes Streamlit’s <code>st.columns</code> to create a two-column layout:</p>
<ul>
<li><p><strong>Left Column (<code>col_filter</code>)</strong>: Contains filters for date range and offense type.</p></li>
<li><p><strong>Right Column (<code>col_map</code>)</strong>: Displays the interactive Folium map.</p></li>
</ul></li>
</ul></li>
<li><p><strong>Interactive Filters</strong>:</p>
<ul>
<li><p><strong>Date Range Picker</strong>: Allows users to select a start and end date within the permissible range.</p>
<ul>
<li><strong>Validation</strong>: Ensures that the end date is not before the start date and that the selected range does not exceed three months (92 days).</li>
</ul></li>
<li><p><strong>Offense Type Multiselect</strong>:</p>
<ul>
<li><p><strong>Dynamic Options</strong>: Populates the multiselect options based on the offenses present in the filtered date range.</p></li>
<li><p><strong>Default Behavior</strong>: If no offenses are selected, all offenses are displayed.</p></li>
</ul></li>
</ul></li>
<li><p><strong>Data Truncation</strong>:</p>
<ul>
<li><strong>Limitation</strong>: Caps the number of records displayed on the map to 2,000 to maintain performance and usability.</li>
</ul></li>
<li><p><strong>Map Generation</strong>:</p>
<ul>
<li><p><strong>Folium Map</strong>: Centers the map on Oak Park’s geographical coordinates.</p></li>
<li><p><strong>Markers</strong>:</p>
<ul>
<li><p><strong>Customization</strong>: Each crime incident is represented by a blue marker with an info-sign icon.</p></li>
<li><p><strong>Popups</strong>: Clicking on a marker reveals detailed information about the incident, including a link to the original PDF report.</p></li>
</ul></li>
</ul></li>
<li><p><strong>Streamlit Folium Integration</strong>:</p>
<ul>
<li><strong><code>st_folium</code></strong>: Embeds the Folium map within the Streamlit app, ensuring seamless interactivity.</li>
</ul></li>
</ul>
</section>
<section id="g.-main-function-to-control-app-flow" class="level5">
<h5 class="anchored" data-anchor-id="g.-main-function-to-control-app-flow"><strong>g. Main Function to Control App Flow</strong></h5>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb15"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1"></a><span class="kw">def</span> main():</span>
<span id="cb15-2"><a href="#cb15-2"></a>    <span class="co"># Check if user has agreed to disclaimer</span></span>
<span id="cb15-3"><a href="#cb15-3"></a>    <span class="cf">if</span> <span class="st">"user_agreed"</span> <span class="kw">not</span> <span class="kw">in</span> st.session_state:</span>
<span id="cb15-4"><a href="#cb15-4"></a>        st.session_state[<span class="st">"user_agreed"</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb15-5"><a href="#cb15-5"></a></span>
<span id="cb15-6"><a href="#cb15-6"></a>    <span class="cf">if</span> <span class="kw">not</span> st.session_state[<span class="st">"user_agreed"</span>]:</span>
<span id="cb15-7"><a href="#cb15-7"></a>        show_disclaimer()</span>
<span id="cb15-8"><a href="#cb15-8"></a>    <span class="cf">else</span>:</span>
<span id="cb15-9"><a href="#cb15-9"></a>        <span class="co"># Set the page layout to wide</span></span>
<span id="cb15-10"><a href="#cb15-10"></a>        st.set_page_config(page_title<span class="op">=</span><span class="st">"Oak Park Crime"</span>, layout<span class="op">=</span><span class="st">"wide"</span>)</span>
<span id="cb15-11"><a href="#cb15-11"></a></span>
<span id="cb15-12"><a href="#cb15-12"></a>        <span class="co"># Add horizontal navigation links at the top</span></span>
<span id="cb15-13"><a href="#cb15-13"></a>        add_top_links()</span>
<span id="cb15-14"><a href="#cb15-14"></a></span>
<span id="cb15-15"><a href="#cb15-15"></a>        <span class="co"># Proceed with the main application</span></span>
<span id="cb15-16"><a href="#cb15-16"></a>        main_app()</span>
<span id="cb15-17"><a href="#cb15-17"></a></span>
<span id="cb15-18"><a href="#cb15-18"></a>        <span class="co"># # Add Email Updates section at the bottom</span></span>
<span id="cb15-19"><a href="#cb15-19"></a>        <span class="co"># add_email_subscription()</span></span>
<span id="cb15-20"><a href="#cb15-20"></a></span>
<span id="cb15-21"><a href="#cb15-21"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb15-22"><a href="#cb15-22"></a>    main()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p><strong>Explanation</strong>:</p>
<ul>
<li><p><strong>Disclaimer Check</strong>:</p>
<ul>
<li><p><strong>Session State</strong>: Utilizes <code>st.session_state</code> to track whether the user has agreed to the disclaimer.</p></li>
<li><p><strong>Flow Control</strong>: If the user hasn’t agreed, the disclaimer is displayed; otherwise, the main application proceeds.</p></li>
</ul></li>
<li><p><strong>Page Configuration</strong>:</p>
<ul>
<li><p><strong>Layout</strong>: Sets the Streamlit app layout to “wide” for better use of screen real estate.</p></li>
<li><p><strong>Page Title</strong>: Labels the browser tab as “Oak Park Crime”.</p></li>
</ul></li>
<li><p><strong>Navigation Links</strong>: Invokes <code>add_top_links()</code> to display navigation links at the top of the dashboard.</p></li>
<li><p><strong>Main Application Execution</strong>: Calls <code>main_app()</code> to render the interactive filters and map.</p></li>
<li><p><strong>Email Subscription</strong>: The <code>add_email_subscription()</code> function is present but commented out, now instead of potentially exposing the site to some sort of injection type attack we redirect users to a simple google forms sheet to subscribe/unsubscribe.</p></li>
</ul>
</section>
</section>
</section>
<section id="detailed-code-breakdown-1" class="level3">
<h3 class="anchored" data-anchor-id="detailed-code-breakdown-1"><strong>Detailed Code Breakdown</strong></h3>
<p>Let’s delve deeper into specific functions and sections of <code>streamlit_app.py</code> to understand their roles and implementations.</p>
<section id="a.-email-subscription-management" class="level4">
<h4 class="anchored" data-anchor-id="a.-email-subscription-management"><strong>a. Email Subscription Management</strong></h4>
<p>Although the <code>add_email_subscription()</code> function is commented out, it’s essential to understand its intended functionality, as it may be incorporated in the future in some one off project of mine and this documentation would greatly assist..</p>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb16"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1"></a><span class="kw">def</span> add_email_subscription():</span>
<span id="cb16-2"><a href="#cb16-2"></a>    <span class="co">"""</span></span>
<span id="cb16-3"><a href="#cb16-3"></a><span class="co">    Displays subscription and unsubscription forms at the bottom of the page.</span></span>
<span id="cb16-4"><a href="#cb16-4"></a><span class="co">    The forms are within a collapsed expander that the user can expand manually.</span></span>
<span id="cb16-5"><a href="#cb16-5"></a><span class="co">    """</span></span>
<span id="cb16-6"><a href="#cb16-6"></a>    <span class="co"># Add an anchor to scroll to</span></span>
<span id="cb16-7"><a href="#cb16-7"></a>    st.markdown(<span class="st">'&lt;a id="email-updates"&gt;&lt;/a&gt;'</span>, unsafe_allow_html<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb16-8"><a href="#cb16-8"></a>    </span>
<span id="cb16-9"><a href="#cb16-9"></a>    <span class="co"># **3. Implement Email Updates within a Collapsed Expander**</span></span>
<span id="cb16-10"><a href="#cb16-10"></a>    <span class="cf">with</span> st.expander(<span class="st">"📧 Email Updates"</span>, expanded<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb16-11"><a href="#cb16-11"></a>        st.markdown(<span class="st">"### Subscribe to Email Updates"</span>)</span>
<span id="cb16-12"><a href="#cb16-12"></a>        <span class="cf">with</span> st.form(<span class="st">"email_subscription_form"</span>):</span>
<span id="cb16-13"><a href="#cb16-13"></a>            subscribe_email_input <span class="op">=</span> st.text_input(<span class="st">"Enter your email address to subscribe:"</span>)</span>
<span id="cb16-14"><a href="#cb16-14"></a>            subscribe_submit <span class="op">=</span> st.form_submit_button(<span class="st">"Subscribe"</span>)</span>
<span id="cb16-15"><a href="#cb16-15"></a></span>
<span id="cb16-16"><a href="#cb16-16"></a>            <span class="cf">if</span> subscribe_submit:</span>
<span id="cb16-17"><a href="#cb16-17"></a>                <span class="cf">if</span> validate_email(subscribe_email_input):</span>
<span id="cb16-18"><a href="#cb16-18"></a>                    response <span class="op">=</span> subscribe_email(subscribe_email_input)</span>
<span id="cb16-19"><a href="#cb16-19"></a>                    <span class="cf">if</span> response.status_code <span class="op">==</span> <span class="dv">200</span>:</span>
<span id="cb16-20"><a href="#cb16-20"></a>                        <span class="co"># Check if the email was already subscribed</span></span>
<span id="cb16-21"><a href="#cb16-21"></a>                        response_data <span class="op">=</span> response.json()</span>
<span id="cb16-22"><a href="#cb16-22"></a>                        status <span class="op">=</span> response_data.get(<span class="st">"status"</span>)</span>
<span id="cb16-23"><a href="#cb16-23"></a>                        <span class="cf">if</span> status <span class="op">==</span> <span class="st">"subscribed"</span>:</span>
<span id="cb16-24"><a href="#cb16-24"></a>                            <span class="co"># Check if the 'previous_status' was 'unsubscribed' to provide accurate feedback</span></span>
<span id="cb16-25"><a href="#cb16-25"></a>                            previous_status <span class="op">=</span> response_data.get(<span class="st">"status_if_new"</span>)</span>
<span id="cb16-26"><a href="#cb16-26"></a>                            <span class="cf">if</span> previous_status <span class="op">==</span> <span class="st">"subscribed"</span>:</span>
<span id="cb16-27"><a href="#cb16-27"></a>                                st.success(<span class="st">"Subscription successful! You've been resubscribed to the email list."</span>)</span>
<span id="cb16-28"><a href="#cb16-28"></a>                            <span class="cf">else</span>:</span>
<span id="cb16-29"><a href="#cb16-29"></a>                                st.success(<span class="st">"Subscription successful! You've been added to the email list."</span>)</span>
<span id="cb16-30"><a href="#cb16-30"></a>                        <span class="cf">else</span>:</span>
<span id="cb16-31"><a href="#cb16-31"></a>                            st.info(<span class="st">"You are already subscribed."</span>)</span>
<span id="cb16-32"><a href="#cb16-32"></a>                    <span class="cf">else</span>:</span>
<span id="cb16-33"><a href="#cb16-33"></a>                        <span class="co"># Handle errors</span></span>
<span id="cb16-34"><a href="#cb16-34"></a>                        error_message <span class="op">=</span> response.json().get(<span class="st">'detail'</span>, <span class="st">'An error occurred.'</span>)</span>
<span id="cb16-35"><a href="#cb16-35"></a>                        st.error(<span class="ss">f"Subscription failed: </span><span class="sc">{</span>error_message<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb16-36"><a href="#cb16-36"></a>                <span class="cf">else</span>:</span>
<span id="cb16-37"><a href="#cb16-37"></a>                    st.error(<span class="st">"Please enter a valid email address."</span>)</span>
<span id="cb16-38"><a href="#cb16-38"></a></span>
<span id="cb16-39"><a href="#cb16-39"></a>        st.markdown(<span class="st">"---"</span>)  <span class="co"># Separator</span></span>
<span id="cb16-40"><a href="#cb16-40"></a></span>
<span id="cb16-41"><a href="#cb16-41"></a>        st.markdown(<span class="st">"### Unsubscribe from Email Updates"</span>)</span>
<span id="cb16-42"><a href="#cb16-42"></a>        <span class="cf">with</span> st.form(<span class="st">"email_unsubscription_form"</span>):</span>
<span id="cb16-43"><a href="#cb16-43"></a>            unsubscribe_email_input <span class="op">=</span> st.text_input(<span class="st">"Enter your email address to unsubscribe:"</span>)</span>
<span id="cb16-44"><a href="#cb16-44"></a>            unsubscribe_submit <span class="op">=</span> st.form_submit_button(<span class="st">"Unsubscribe"</span>)</span>
<span id="cb16-45"><a href="#cb16-45"></a></span>
<span id="cb16-46"><a href="#cb16-46"></a>            <span class="cf">if</span> unsubscribe_submit:</span>
<span id="cb16-47"><a href="#cb16-47"></a>                <span class="cf">if</span> validate_email(unsubscribe_email_input):</span>
<span id="cb16-48"><a href="#cb16-48"></a>                    response <span class="op">=</span> unsubscribe_email(unsubscribe_email_input)</span>
<span id="cb16-49"><a href="#cb16-49"></a>                    <span class="cf">if</span> response.status_code <span class="op">==</span> <span class="dv">200</span>:</span>
<span id="cb16-50"><a href="#cb16-50"></a>                        response_data <span class="op">=</span> response.json()</span>
<span id="cb16-51"><a href="#cb16-51"></a>                        status <span class="op">=</span> response_data.get(<span class="st">"status"</span>)</span>
<span id="cb16-52"><a href="#cb16-52"></a>                        <span class="cf">if</span> status <span class="op">==</span> <span class="st">"unsubscribed"</span>:</span>
<span id="cb16-53"><a href="#cb16-53"></a>                            st.success(<span class="st">"You have been unsubscribed successfully."</span>)</span>
<span id="cb16-54"><a href="#cb16-54"></a>                        <span class="cf">else</span>:</span>
<span id="cb16-55"><a href="#cb16-55"></a>                            st.info(<span class="st">"Your email was not found in our list."</span>)</span>
<span id="cb16-56"><a href="#cb16-56"></a>                    <span class="cf">else</span>:</span>
<span id="cb16-57"><a href="#cb16-57"></a>                        <span class="co"># Handle errors</span></span>
<span id="cb16-58"><a href="#cb16-58"></a>                        error_message <span class="op">=</span> response.json().get(<span class="st">'detail'</span>, <span class="st">'An error occurred.'</span>)</span>
<span id="cb16-59"><a href="#cb16-59"></a>                        st.error(<span class="ss">f"Unsubscription failed: </span><span class="sc">{</span>error_message<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb16-60"><a href="#cb16-60"></a>                <span class="cf">else</span>:</span>
<span id="cb16-61"><a href="#cb16-61"></a>                    st.error(<span class="st">"Please enter a valid email address."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p><strong>Explanation</strong>:</p>
<ul>
<li><p><strong>Purpose</strong>: Provides users with forms to subscribe or unsubscribe from email updates.</p></li>
<li><p><strong>Structure</strong>:</p>
<ul>
<li><p><strong>Expander</strong>: Collapses the email update section to keep the dashboard clean.</p></li>
<li><p><strong>Subscription Form</strong>:</p>
<ul>
<li><p><strong>Input</strong>: Email address field.</p></li>
<li><p><strong>Submission</strong>: Validates and processes the subscription request via Mailchimp.</p></li>
<li><p><strong>Feedback</strong>: Displays success or error messages based on the API response.</p></li>
</ul></li>
<li><p><strong>Unsubscription Form</strong>:</p>
<ul>
<li><p><strong>Input</strong>: Email address field.</p></li>
<li><p><strong>Submission</strong>: Validates and processes the unsubscription request via Mailchimp.</p></li>
<li><p><strong>Feedback</strong>: Displays success or error messages based on the API response.</p></li>
</ul></li>
</ul></li>
<li><p><strong>Current Status</strong>: The entire function is commented out, indicating it’s not active(obvious).</p></li>
</ul>
</section>
<section id="b.-year-extraction-from-filename" class="level4">
<h4 class="anchored" data-anchor-id="b.-year-extraction-from-filename"><strong>b. Year Extraction from Filename</strong></h4>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb17"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1"></a><span class="kw">def</span> extract_year(filename, start_year<span class="op">=</span><span class="dv">2017</span>, end_year<span class="op">=</span><span class="dv">2030</span>):</span>
<span id="cb17-2"><a href="#cb17-2"></a>    <span class="co">"""</span></span>
<span id="cb17-3"><a href="#cb17-3"></a><span class="co">    Extracts a four-digit year from the filename.</span></span>
<span id="cb17-4"><a href="#cb17-4"></a><span class="co">    Returns the year as a string if found and within the range.</span></span>
<span id="cb17-5"><a href="#cb17-5"></a><span class="co">    Returns None otherwise.</span></span>
<span id="cb17-6"><a href="#cb17-6"></a><span class="co">    """</span></span>
<span id="cb17-7"><a href="#cb17-7"></a>    match <span class="op">=</span> re.search(<span class="vs">r'(20[1][7-9]|20[2][0-9]|2030)'</span>, filename)</span>
<span id="cb17-8"><a href="#cb17-8"></a>    <span class="cf">if</span> match:</span>
<span id="cb17-9"><a href="#cb17-9"></a>        <span class="cf">return</span> match.group(<span class="dv">0</span>)</span>
<span id="cb17-10"><a href="#cb17-10"></a>    <span class="cf">return</span> <span class="va">None</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p><strong>Explanation</strong>:</p>
<ul>
<li><p><strong>Purpose</strong>: Retrieves the year from the PDF filename to construct accurate URLs linking back to the original reports.</p></li>
<li><p><strong>Logic</strong>:</p>
<ul>
<li><p><strong>Regex Pattern</strong>: Searches for years ranging from 2017 to 2030. If this tool is still in use by 2030 and/or crime records pre 2018 are on the oak park website or somewhere else then this should be fixed.</p></li>
<li><p><strong>Return Value</strong>: Provides the matched year as a string or <code>None</code> if no valid year is found.</p></li>
</ul></li>
</ul>
<p><strong>Usage in <code>main_app()</code></strong>:</p>
<ul>
<li><p><strong>URL Construction</strong>: Utilizes the extracted year to build the base URL for the PDF link.</p></li>
<li><p><strong>Fallback Handling</strong>: If the year isn’t found, the PDF link defaults to <code>#</code>, and a warning is displayed.</p></li>
</ul>
</section>
<section id="c.-interactive-map-rendering" class="level4">
<h4 class="anchored" data-anchor-id="c.-interactive-map-rendering"><strong>c.&nbsp;Interactive Map Rendering</strong></h4>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb18"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1"></a><span class="cf">with</span> col_map:</span>
<span id="cb18-2"><a href="#cb18-2"></a>    st.write(<span class="ss">f"**Displaying </span><span class="sc">{</span><span class="bu">len</span>(final_df)<span class="sc">}</span><span class="ss"> records on the map**."</span>)</span>
<span id="cb18-3"><a href="#cb18-3"></a></span>
<span id="cb18-4"><a href="#cb18-4"></a>    <span class="co"># Create Folium map</span></span>
<span id="cb18-5"><a href="#cb18-5"></a>    oak_park_center <span class="op">=</span> [<span class="fl">41.885</span>, <span class="op">-</span><span class="fl">87.78</span>]</span>
<span id="cb18-6"><a href="#cb18-6"></a>    crime_map <span class="op">=</span> folium.Map(location<span class="op">=</span>oak_park_center, zoom_start<span class="op">=</span><span class="dv">13</span>)</span>
<span id="cb18-7"><a href="#cb18-7"></a></span>
<span id="cb18-8"><a href="#cb18-8"></a>    <span class="cf">for</span> _, row <span class="kw">in</span> final_df.iterrows():</span>
<span id="cb18-9"><a href="#cb18-9"></a>        complaint   <span class="op">=</span> safe_field(row.get(<span class="st">'Complaint #'</span>))</span>
<span id="cb18-10"><a href="#cb18-10"></a>        offense_val <span class="op">=</span> safe_field(row.get(<span class="st">'Offense'</span>))</span>
<span id="cb18-11"><a href="#cb18-11"></a>        date_val    <span class="op">=</span> row.get(<span class="st">'Date'</span>)</span>
<span id="cb18-12"><a href="#cb18-12"></a>        date_str    <span class="op">=</span> safe_field(date_val.strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>) <span class="cf">if</span> pd.notnull(date_val) <span class="cf">else</span> np.nan)</span>
<span id="cb18-13"><a href="#cb18-13"></a>        time_val    <span class="op">=</span> safe_field(row.get(<span class="st">'Time'</span>))</span>
<span id="cb18-14"><a href="#cb18-14"></a>        location    <span class="op">=</span> safe_field(row.get(<span class="st">'Location'</span>))</span>
<span id="cb18-15"><a href="#cb18-15"></a>        victim      <span class="op">=</span> safe_field(row.get(<span class="st">'Victim/Address'</span>))</span>
<span id="cb18-16"><a href="#cb18-16"></a>        narrative   <span class="op">=</span> safe_field(row.get(<span class="st">'Narrative'</span>))</span>
<span id="cb18-17"><a href="#cb18-17"></a>        filename <span class="op">=</span> safe_field(row.get(<span class="st">'File Name'</span>))</span>
<span id="cb18-18"><a href="#cb18-18"></a>        <span class="co"># Extract the year from the filename</span></span>
<span id="cb18-19"><a href="#cb18-19"></a>        year <span class="op">=</span> extract_year(filename)</span>
<span id="cb18-20"><a href="#cb18-20"></a>        <span class="cf">if</span> year:</span>
<span id="cb18-21"><a href="#cb18-21"></a>            base_url <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>base_url_static<span class="sc">}{</span>year<span class="sc">}</span><span class="ss">/"</span></span>
<span id="cb18-22"><a href="#cb18-22"></a>            link <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>base_url<span class="sc">}{</span>filename<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb18-23"><a href="#cb18-23"></a>        <span class="cf">else</span>:</span>
<span id="cb18-24"><a href="#cb18-24"></a>            <span class="co"># Handle cases where the year isn't found or is out of range</span></span>
<span id="cb18-25"><a href="#cb18-25"></a>            link <span class="op">=</span> <span class="st">"#"</span></span>
<span id="cb18-26"><a href="#cb18-26"></a>            st.warning(<span class="ss">f"Year not found or out of range in filename: </span><span class="sc">{</span>filename<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb18-27"><a href="#cb18-27"></a></span>
<span id="cb18-28"><a href="#cb18-28"></a>        popup_html <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb18-29"><a href="#cb18-29"></a><span class="ss">        &lt;b&gt;Complaint #:&lt;/b&gt; </span><span class="sc">{</span>complaint<span class="sc">}</span><span class="ss">&lt;br/&gt;</span></span>
<span id="cb18-30"><a href="#cb18-30"></a><span class="ss">        &lt;b&gt;Offense:&lt;/b&gt; </span><span class="sc">{</span>offense_val<span class="sc">}</span><span class="ss">&lt;br/&gt;</span></span>
<span id="cb18-31"><a href="#cb18-31"></a><span class="ss">        &lt;b&gt;Date:&lt;/b&gt; </span><span class="sc">{</span>date_str<span class="sc">}</span><span class="ss">&lt;br/&gt;</span></span>
<span id="cb18-32"><a href="#cb18-32"></a><span class="ss">        &lt;details&gt;</span></span>
<span id="cb18-33"><a href="#cb18-33"></a><span class="ss">          &lt;summary&gt;&lt;b&gt;View Details&lt;/b&gt;&lt;/summary&gt;</span></span>
<span id="cb18-34"><a href="#cb18-34"></a><span class="ss">          &lt;b&gt;Time:&lt;/b&gt; </span><span class="sc">{</span>time_val<span class="sc">}</span><span class="ss">&lt;br/&gt;</span></span>
<span id="cb18-35"><a href="#cb18-35"></a><span class="ss">          &lt;b&gt;Location:&lt;/b&gt; </span><span class="sc">{</span>location<span class="sc">}</span><span class="ss">&lt;br/&gt;</span></span>
<span id="cb18-36"><a href="#cb18-36"></a><span class="ss">          &lt;b&gt;Victim:&lt;/b&gt; </span><span class="sc">{</span>victim<span class="sc">}</span><span class="ss">&lt;br/&gt;</span></span>
<span id="cb18-37"><a href="#cb18-37"></a><span class="ss">          &lt;b&gt;Narrative:&lt;/b&gt; </span><span class="sc">{</span>narrative<span class="sc">}</span><span class="ss">&lt;br/&gt;</span></span>
<span id="cb18-38"><a href="#cb18-38"></a><span class="ss">          &lt;b&gt;URL:&lt;/b&gt; &lt;a href="</span><span class="sc">{</span>link<span class="sc">}</span><span class="ss">" target="_blank"&gt;PDF Link&lt;/a&gt;</span></span>
<span id="cb18-39"><a href="#cb18-39"></a><span class="ss">        &lt;/details&gt;</span></span>
<span id="cb18-40"><a href="#cb18-40"></a><span class="ss">    """</span></span>
<span id="cb18-41"><a href="#cb18-41"></a></span>
<span id="cb18-42"><a href="#cb18-42"></a>        folium.Marker(</span>
<span id="cb18-43"><a href="#cb18-43"></a>            location<span class="op">=</span>[row[<span class="st">'Lat'</span>], row[<span class="st">'Long'</span>]],</span>
<span id="cb18-44"><a href="#cb18-44"></a>            popup<span class="op">=</span>folium.Popup(popup_html, max_width<span class="op">=</span><span class="dv">400</span>),</span>
<span id="cb18-45"><a href="#cb18-45"></a>            tooltip<span class="op">=</span><span class="ss">f"Complaint # </span><span class="sc">{</span>complaint<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb18-46"><a href="#cb18-46"></a>            icon<span class="op">=</span>folium.Icon(color<span class="op">=</span><span class="st">"blue"</span>, icon<span class="op">=</span><span class="st">"info-sign"</span>)</span>
<span id="cb18-47"><a href="#cb18-47"></a>        ).add_to(crime_map)</span>
<span id="cb18-48"><a href="#cb18-48"></a></span>
<span id="cb18-49"><a href="#cb18-49"></a>    st_folium(crime_map, width<span class="op">=</span><span class="dv">1000</span>, height<span class="op">=</span><span class="dv">1000</span>, use_container_width<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p><strong>Explanation</strong>:</p>
<ul>
<li><p><strong>Map Initialization</strong>:</p>
<ul>
<li><strong>Centering</strong>: The map is centered on Oak Park’s geographical coordinates with a zoom level of 13 for optimal visibility.</li>
</ul></li>
<li><p><strong>Marker Creation</strong>:</p>
<ul>
<li><p><strong>Looping Through Data</strong>: Iterates over each record in the filtered DataFrame (<code>final_df</code>).</p></li>
<li><p><strong>Data Extraction</strong>: Retrieves necessary fields like Complaint Number, Offense, Date, Time, Location, Victim Address, Narrative, and File Name.</p></li>
<li><p><strong>URL Formation</strong>: Constructs a direct link to the original PDF report using the extracted year. If the year isn’t found, the link defaults to <code>#</code>, and a warning is displayed.</p></li>
<li><p><strong>Popup HTML</strong>: Formats the incident details into an HTML structure that includes expandable sections (<code>&lt;details&gt;</code>) for additional information and the PDF link.</p></li>
</ul></li>
<li><p><strong>Folium Marker Customization</strong>:</p>
<ul>
<li><p><strong>Location</strong>: Plots the marker based on latitude and longitude.</p></li>
<li><p><strong>Popup</strong>: Attaches the formatted HTML popup to the marker.</p></li>
<li><p><strong>Tooltip</strong>: Displays the Complaint Number when hovering over the marker.</p></li>
<li><p><strong>Icon</strong>: Uses a blue info-sign icon for consistency and visibility.</p></li>
</ul></li>
<li><p><strong>Map Embedding</strong>:</p>
<ul>
<li><strong><code>st_folium</code></strong>: Renders the Folium map within the Streamlit dashboard, allowing for interactivity like zooming and panning.</li>
</ul></li>
</ul>
</section>
</section>
<section id="conclusion-of-live-streamlit-dashboard-section" class="level3">
<h3 class="anchored" data-anchor-id="conclusion-of-live-streamlit-dashboard-section"><strong>Conclusion of Live Streamlit Dashboard Section</strong></h3>
<p>The <strong>Live Streamlit Dashboard</strong> is a pivotal component of the Oak Park Crime Reporting project, offering users an intuitive and interactive means to explore crime data. By integrating dynamic filters, interactive maps, and email subscription management, the dashboard enhances user engagement and data accessibility. The modular design, leveraging Streamlit’s capabilities and third-party integrations like Mailchimp, ensures scalability and maintainability.</p>
<hr>
</section>
</section>
<section id="static-html-generation" class="level2">
<h2 class="anchored" data-anchor-id="static-html-generation"><strong>Static HTML Generation</strong></h2>
<section id="overview-2" class="level3">
<h3 class="anchored" data-anchor-id="overview-2"><strong>Overview</strong></h3>
<p>The <strong>Static HTML Generation</strong> component automates the creation of static HTML reports and maps based on the latest crime data. This ensures that the information remains accessible even outside the interactive Streamlit dashboard environment. The component performs the following tasks:</p>
<ol type="1">
<li><p><strong>Data Aggregation</strong>: Compiles crime data for the past week.</p></li>
<li><p><strong>Map Creation</strong>: Generates interactive and cumulative Folium maps with detailed popups.</p></li>
<li><p><strong>GitHub Integration</strong>: Uploads the generated HTML reports and CSV files to a GitHub repository, facilitating easy sharing and hosting via GitHub Pages.</p></li>
<li><p><strong>Email Dissemination</strong>: Sends automated emails containing the latest reports and links to subscribers.</p></li>
</ol>
<p>The primary script responsible for this component is <code>weekly_crime_report.py</code>.</p>
</section>
<section id="key-components-2" class="level3">
<h3 class="anchored" data-anchor-id="key-components-2"><strong>Key Components</strong></h3>
<section id="weekly_crime_report.py" class="level4">
<h4 class="anchored" data-anchor-id="weekly_crime_report.py"><strong>1. <code>weekly_crime_report.py</code></strong></h4>
<p><strong>Purpose</strong>:<br>
This script automates the generation of weekly crime reports, including interactive maps and CSV data files. It handles data filtering, map creation with disclaimers, uploading to GitHub, and sending out emails to subscribers with the latest reports.</p>
<p><strong>Imports and Dependencies</strong>:</p>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb19"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1"></a><span class="im">import</span> os</span>
<span id="cb19-2"><a href="#cb19-2"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb19-3"><a href="#cb19-3"></a><span class="im">import</span> folium</span>
<span id="cb19-4"><a href="#cb19-4"></a><span class="im">import</span> logging</span>
<span id="cb19-5"><a href="#cb19-5"></a><span class="im">import</span> zipfile</span>
<span id="cb19-6"><a href="#cb19-6"></a><span class="im">import</span> time</span>
<span id="cb19-7"><a href="#cb19-7"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb19-8"><a href="#cb19-8"></a><span class="im">from</span> datetime <span class="im">import</span> datetime, timedelta</span>
<span id="cb19-9"><a href="#cb19-9"></a><span class="im">from</span> email.mime.multipart <span class="im">import</span> MIMEMultipart</span>
<span id="cb19-10"><a href="#cb19-10"></a><span class="im">from</span> email.mime.text <span class="im">import</span> MIMEText</span>
<span id="cb19-11"><a href="#cb19-11"></a><span class="im">from</span> email.mime.application <span class="im">import</span> MIMEApplication</span>
<span id="cb19-12"><a href="#cb19-12"></a><span class="im">import</span> base64</span>
<span id="cb19-13"><a href="#cb19-13"></a><span class="im">import</span> sys</span>
<span id="cb19-14"><a href="#cb19-14"></a></span>
<span id="cb19-15"><a href="#cb19-15"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb19-16"><a href="#cb19-16"></a><span class="im">import</span> re</span>
<span id="cb19-17"><a href="#cb19-17"></a><span class="im">import</span> hashlib</span>
<span id="cb19-18"><a href="#cb19-18"></a><span class="im">import</span> requests</span>
<span id="cb19-19"><a href="#cb19-19"></a></span>
<span id="cb19-20"><a href="#cb19-20"></a><span class="im">from</span> google.auth.transport.requests <span class="im">import</span> Request</span>
<span id="cb19-21"><a href="#cb19-21"></a><span class="im">from</span> google_auth_oauthlib.flow <span class="im">import</span> InstalledAppFlow</span>
<span id="cb19-22"><a href="#cb19-22"></a><span class="im">from</span> google.oauth2.credentials <span class="im">import</span> Credentials</span>
<span id="cb19-23"><a href="#cb19-23"></a><span class="im">from</span> googleapiclient.discovery <span class="im">import</span> build</span>
<span id="cb19-24"><a href="#cb19-24"></a><span class="im">from</span> googleapiclient.errors <span class="im">import</span> HttpError</span>
<span id="cb19-25"><a href="#cb19-25"></a></span>
<span id="cb19-26"><a href="#cb19-26"></a><span class="co"># Local utility to load env vars</span></span>
<span id="cb19-27"><a href="#cb19-27"></a><span class="im">from</span> utils <span class="im">import</span> load_env_vars, extract_year, upload_file_to_github, upload_files_to_github_batch</span>
<span id="cb19-28"><a href="#cb19-28"></a></span>
<span id="cb19-29"><a href="#cb19-29"></a><span class="co"># Folium plugins</span></span>
<span id="cb19-30"><a href="#cb19-30"></a><span class="im">from</span> folium.plugins <span class="im">import</span> MarkerCluster</span>
<span id="cb19-31"><a href="#cb19-31"></a></span>
<span id="cb19-32"><a href="#cb19-32"></a><span class="co"># Define Gmail API scope</span></span>
<span id="cb19-33"><a href="#cb19-33"></a>SCOPES <span class="op">=</span> [<span class="st">'https://www.googleapis.com/auth/gmail.send'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<ul>
<li><p><strong>Standard Libraries</strong>: <code>os</code>, <code>re</code>, <code>json</code>, <code>pandas</code>, <code>pathlib</code>, <code>logging</code>, <code>collections</code>, <code>time</code>, <code>datetime</code>, <code>string</code>, <code>zipfile</code>, <code>email</code>, <code>base64</code>, <code>sys</code></p></li>
<li><p><strong>Third-Party Libraries</strong>: <code>numpy</code>, <code>folium</code>, <code>google-auth</code>, <code>google-auth-oauthlib</code>, <code>google-auth-httplib2</code>, <code>google-api-python-client</code>, <code>requests</code></p></li>
<li><p><strong>Local Utilities</strong>: Functions imported from <code>utils.py</code></p></li>
</ul>
<p><strong>Main Functionalities</strong>:</p>
<ol type="1">
<li><p><strong>Environment Setup</strong>:</p>
<ul>
<li><p>Loads environment variables from <code>env_vars.txt</code>.</p></li>
<li><p>Configures logging.</p></li>
<li><p>Sets up directories for data, maps, CSVs, and GitHub integration.</p></li>
</ul></li>
<li><p><strong>Data Processing</strong>:</p>
<ul>
<li><p>Loads all crime data from a compressed ZIP file.</p></li>
<li><p>Filters data for the past week.</p></li>
<li><p>Writes the filtered data to a CSV file.</p></li>
</ul></li>
<li><p><strong>Map Creation</strong>:</p>
<ul>
<li><p>Generates an interactive Folium map with markers for each crime incident.</p></li>
<li><p>Generates a cumulative Folium map displaying all crime incidents.</p></li>
<li><p>Adds disclaimers as overlaying HTML elements on the maps.</p></li>
</ul></li>
<li><p><strong>GitHub Integration</strong>:</p>
<ul>
<li>Uploads the generated HTML maps and CSV files to specified GitHub repository subfolders.</li>
</ul></li>
<li><p><strong>Email Dissemination</strong>:</p>
<ul>
<li><p>Authenticates with the Gmail API.</p></li>
<li><p>Prepares and sends an email to subscribers with links to the latest reports and attached CSV files.</p></li>
</ul></li>
<li><p><strong>Logging and Reporting</strong>:</p>
<ul>
<li><p>Logs processing steps, errors, and summary statistics.</p></li>
<li><p>Measures and records the execution time of the script.</p></li>
</ul></li>
</ol>
<p><strong>Sample Code Snippet</strong>:</p>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb20"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1"></a><span class="kw">def</span> create_folium_map_filtered_data(</span>
<span id="cb20-2"><a href="#cb20-2"></a>    df,</span>
<span id="cb20-3"><a href="#cb20-3"></a>    lat_col<span class="op">=</span><span class="st">'Lat'</span>,</span>
<span id="cb20-4"><a href="#cb20-4"></a>    lng_col<span class="op">=</span><span class="st">'Long'</span>,</span>
<span id="cb20-5"><a href="#cb20-5"></a>    offense_col<span class="op">=</span><span class="st">'Offense'</span>,</span>
<span id="cb20-6"><a href="#cb20-6"></a>    date_col<span class="op">=</span><span class="st">'Date'</span>,</span>
<span id="cb20-7"><a href="#cb20-7"></a>    output_html_path<span class="op">=</span><span class="st">'weekly_map.html'</span></span>
<span id="cb20-8"><a href="#cb20-8"></a>):</span>
<span id="cb20-9"><a href="#cb20-9"></a>    <span class="co">"""</span></span>
<span id="cb20-10"><a href="#cb20-10"></a><span class="co">    Creates a Folium map plotting each record in df with disclaimers overlay (JS + HTML) </span></span>
<span id="cb20-11"><a href="#cb20-11"></a><span class="co">    and saves it to 'output_html_path'.</span></span>
<span id="cb20-12"><a href="#cb20-12"></a><span class="co">    """</span></span>
<span id="cb20-13"><a href="#cb20-13"></a>    oak_park_center <span class="op">=</span> [<span class="fl">41.885</span>, <span class="op">-</span><span class="fl">87.78</span>]</span>
<span id="cb20-14"><a href="#cb20-14"></a>    crime_map <span class="op">=</span> folium.Map(location<span class="op">=</span>oak_park_center, zoom_start<span class="op">=</span><span class="dv">13</span>)</span>
<span id="cb20-15"><a href="#cb20-15"></a></span>
<span id="cb20-16"><a href="#cb20-16"></a>    marker_cluster <span class="op">=</span> MarkerCluster().add_to(crime_map)</span>
<span id="cb20-17"><a href="#cb20-17"></a>    <span class="co"># Define the static part of the base URL</span></span>
<span id="cb20-18"><a href="#cb20-18"></a>    base_url_static <span class="op">=</span> <span class="st">'https://www.oak-park.us/sites/default/files/police/summaries/'</span></span>
<span id="cb20-19"><a href="#cb20-19"></a></span>
<span id="cb20-20"><a href="#cb20-20"></a>    <span class="cf">for</span> _, row <span class="kw">in</span> df.iterrows():</span>
<span id="cb20-21"><a href="#cb20-21"></a>        lat <span class="op">=</span> row[lat_col]</span>
<span id="cb20-22"><a href="#cb20-22"></a>        lng <span class="op">=</span> row[lng_col]</span>
<span id="cb20-23"><a href="#cb20-23"></a>        offense <span class="op">=</span> row.get(offense_col, <span class="st">"Unknown"</span>)</span>
<span id="cb20-24"><a href="#cb20-24"></a>        complaint <span class="op">=</span> safe_field(row.get(<span class="st">'Complaint #'</span>))</span>
<span id="cb20-25"><a href="#cb20-25"></a>        offense_val <span class="op">=</span> safe_field(offense)</span>
<span id="cb20-26"><a href="#cb20-26"></a>        date_str <span class="op">=</span> safe_field(row[<span class="st">'Date'</span>].strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>) <span class="cf">if</span> pd.notnull(row[<span class="st">'Date'</span>]) <span class="cf">else</span> np.nan)</span>
<span id="cb20-27"><a href="#cb20-27"></a>        time_val <span class="op">=</span> safe_field(row.get(<span class="st">'Time'</span>))</span>
<span id="cb20-28"><a href="#cb20-28"></a>        location <span class="op">=</span> safe_field(row.get(<span class="st">'Location'</span>))</span>
<span id="cb20-29"><a href="#cb20-29"></a>        victim <span class="op">=</span> safe_field(row.get(<span class="st">'Victim/Address'</span>))</span>
<span id="cb20-30"><a href="#cb20-30"></a>        narrative <span class="op">=</span> safe_field(row.get(<span class="st">'Narrative'</span>))</span>
<span id="cb20-31"><a href="#cb20-31"></a>        filename <span class="op">=</span> safe_field(row.get(<span class="st">'File Name'</span>))</span>
<span id="cb20-32"><a href="#cb20-32"></a></span>
<span id="cb20-33"><a href="#cb20-33"></a>        popup_html <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb20-34"><a href="#cb20-34"></a><span class="ss">            &lt;b&gt;Complaint #:&lt;/b&gt; </span><span class="sc">{</span>complaint<span class="sc">}</span><span class="ss">&lt;br/&gt;</span></span>
<span id="cb20-35"><a href="#cb20-35"></a><span class="ss">            &lt;b&gt;Offense:&lt;/b&gt; </span><span class="sc">{</span>offense_val<span class="sc">}</span><span class="ss">&lt;br/&gt;</span></span>
<span id="cb20-36"><a href="#cb20-36"></a><span class="ss">            &lt;b&gt;Date:&lt;/b&gt; </span><span class="sc">{</span>date_str<span class="sc">}</span><span class="ss">&lt;br/&gt;</span></span>
<span id="cb20-37"><a href="#cb20-37"></a><span class="ss">            &lt;details&gt;</span></span>
<span id="cb20-38"><a href="#cb20-38"></a><span class="ss">              &lt;summary&gt;&lt;b&gt;View Details&lt;/b&gt;&lt;/summary&gt;</span></span>
<span id="cb20-39"><a href="#cb20-39"></a><span class="ss">              &lt;b&gt;Time:&lt;/b&gt; </span><span class="sc">{</span>time_val<span class="sc">}</span><span class="ss">&lt;br/&gt;</span></span>
<span id="cb20-40"><a href="#cb20-40"></a><span class="ss">              &lt;b&gt;Location:&lt;/b&gt; </span><span class="sc">{</span>location<span class="sc">}</span><span class="ss">&lt;br/&gt;</span></span>
<span id="cb20-41"><a href="#cb20-41"></a><span class="ss">              &lt;b&gt;Victim:&lt;/b&gt; </span><span class="sc">{</span>victim<span class="sc">}</span><span class="ss">&lt;br/&gt;</span></span>
<span id="cb20-42"><a href="#cb20-42"></a><span class="ss">              &lt;b&gt;Narrative:&lt;/b&gt; </span><span class="sc">{</span>narrative<span class="sc">}</span><span class="ss">&lt;br/&gt;</span></span>
<span id="cb20-43"><a href="#cb20-43"></a><span class="ss">              &lt;b&gt;URL:&lt;/b&gt; &lt;a href="</span><span class="sc">{</span>filename<span class="sc">}</span><span class="ss">" target="_blank"&gt;PDF Link&lt;/a&gt;</span></span>
<span id="cb20-44"><a href="#cb20-44"></a><span class="ss">            &lt;/details&gt;</span></span>
<span id="cb20-45"><a href="#cb20-45"></a><span class="ss">        """</span></span>
<span id="cb20-46"><a href="#cb20-46"></a></span>
<span id="cb20-47"><a href="#cb20-47"></a>        folium.Marker(</span>
<span id="cb20-48"><a href="#cb20-48"></a>            location<span class="op">=</span>[lat, lng],</span>
<span id="cb20-49"><a href="#cb20-49"></a>            popup<span class="op">=</span>folium.Popup(popup_html, max_width<span class="op">=</span><span class="dv">300</span>),</span>
<span id="cb20-50"><a href="#cb20-50"></a>            icon<span class="op">=</span>folium.Icon(color<span class="op">=</span><span class="st">'red'</span>, icon<span class="op">=</span><span class="st">'info-sign'</span>)</span>
<span id="cb20-51"><a href="#cb20-51"></a>        ).add_to(marker_cluster)</span>
<span id="cb20-52"><a href="#cb20-52"></a></span>
<span id="cb20-53"><a href="#cb20-53"></a>    <span class="co"># Basic map title</span></span>
<span id="cb20-54"><a href="#cb20-54"></a>    title_html <span class="op">=</span> <span class="st">'''</span></span>
<span id="cb20-55"><a href="#cb20-55"></a><span class="st">    &lt;h3 align="center" style="font-size:20px"&gt;&lt;b&gt;Oak Park Crime Map&lt;/b&gt;&lt;/h3&gt;</span></span>
<span id="cb20-56"><a href="#cb20-56"></a><span class="st">    &lt;br&gt;</span></span>
<span id="cb20-57"><a href="#cb20-57"></a><span class="st">    &lt;h3 align="center" style="font-size:10px"&gt;</span></span>
<span id="cb20-58"><a href="#cb20-58"></a><span class="st">    &lt;a href="https://jesse-anderson.net/"&gt;My Portfolio&lt;/a&gt; |</span></span>
<span id="cb20-59"><a href="#cb20-59"></a><span class="st">    &lt;a href="https://blog.jesse-anderson.net/"&gt;My Blog&lt;/a&gt; |</span></span>
<span id="cb20-60"><a href="#cb20-60"></a><span class="st">    &lt;a href="https://blog.jesse-anderson.net/"&gt;Documentation&lt;/a&gt; |</span></span>
<span id="cb20-61"><a href="#cb20-61"></a><span class="st">    &lt;a href="mailto:jesse@jesse-anderson.net"&gt;Contact&lt;/a&gt; |</span></span>
<span id="cb20-62"><a href="#cb20-62"></a><span class="st">    &lt;a href="https://forms.gle/GnyaVwo1Vzm8nBH6A"&gt;</span></span>
<span id="cb20-63"><a href="#cb20-63"></a><span class="st">        Add me to Weekly Updates</span></span>
<span id="cb20-64"><a href="#cb20-64"></a><span class="st">    &lt;/a&gt;</span></span>
<span id="cb20-65"><a href="#cb20-65"></a><span class="st">    &lt;/h3&gt;</span></span>
<span id="cb20-66"><a href="#cb20-66"></a><span class="st">'''</span></span>
<span id="cb20-67"><a href="#cb20-67"></a>    crime_map.get_root().html.add_child(folium.Element(title_html))</span>
<span id="cb20-68"><a href="#cb20-68"></a></span>
<span id="cb20-69"><a href="#cb20-69"></a>    <span class="co"># 1) Overlays disclaimers in a "splash screen" with JavaScript:</span></span>
<span id="cb20-70"><a href="#cb20-70"></a>    disclaimers_overlay <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb20-71"><a href="#cb20-71"></a><span class="st">    &lt;style&gt;</span></span>
<span id="cb20-72"><a href="#cb20-72"></a><span class="st">    /* Full-page overlay styling */</span></span>
<span id="cb20-73"><a href="#cb20-73"></a><span class="st">    #disclaimerOverlay {</span></span>
<span id="cb20-74"><a href="#cb20-74"></a><span class="st">      position: fixed;</span></span>
<span id="cb20-75"><a href="#cb20-75"></a><span class="st">      z-index: 9999; /* On top of everything */</span></span>
<span id="cb20-76"><a href="#cb20-76"></a><span class="st">      left: 0;</span></span>
<span id="cb20-77"><a href="#cb20-77"></a><span class="st">      top: 0;</span></span>
<span id="cb20-78"><a href="#cb20-78"></a><span class="st">      width: 100%;</span></span>
<span id="cb20-79"><a href="#cb20-79"></a><span class="st">      height: 100%;</span></span>
<span id="cb20-80"><a href="#cb20-80"></a><span class="st">      background-color: rgba(255, 255, 255, 0.95);</span></span>
<span id="cb20-81"><a href="#cb20-81"></a><span class="st">      color: #333;</span></span>
<span id="cb20-82"><a href="#cb20-82"></a><span class="st">      display: block; /* Visible by default */</span></span>
<span id="cb20-83"><a href="#cb20-83"></a><span class="st">      overflow: auto;</span></span>
<span id="cb20-84"><a href="#cb20-84"></a><span class="st">      text-align: center;</span></span>
<span id="cb20-85"><a href="#cb20-85"></a><span class="st">      padding-top: 100px;</span></span>
<span id="cb20-86"><a href="#cb20-86"></a><span class="st">      font-family: Arial, sans-serif;</span></span>
<span id="cb20-87"><a href="#cb20-87"></a><span class="st">    }</span></span>
<span id="cb20-88"><a href="#cb20-88"></a><span class="st">    #disclaimerContent {</span></span>
<span id="cb20-89"><a href="#cb20-89"></a><span class="st">      background: #f9f9f9;</span></span>
<span id="cb20-90"><a href="#cb20-90"></a><span class="st">      border: 1px solid #ccc;</span></span>
<span id="cb20-91"><a href="#cb20-91"></a><span class="st">      display: inline-block;</span></span>
<span id="cb20-92"><a href="#cb20-92"></a><span class="st">      padding: 20px;</span></span>
<span id="cb20-93"><a href="#cb20-93"></a><span class="st">      max-width: 800px;</span></span>
<span id="cb20-94"><a href="#cb20-94"></a><span class="st">      text-align: left;</span></span>
<span id="cb20-95"><a href="#cb20-95"></a><span class="st">    }</span></span>
<span id="cb20-96"><a href="#cb20-96"></a><span class="st">    #acceptButton {</span></span>
<span id="cb20-97"><a href="#cb20-97"></a><span class="st">      margin-top: 20px;</span></span>
<span id="cb20-98"><a href="#cb20-98"></a><span class="st">      padding: 10px 20px;</span></span>
<span id="cb20-99"><a href="#cb20-99"></a><span class="st">      font-size: 16px;</span></span>
<span id="cb20-100"><a href="#cb20-100"></a><span class="st">      cursor: pointer;</span></span>
<span id="cb20-101"><a href="#cb20-101"></a><span class="st">    }</span></span>
<span id="cb20-102"><a href="#cb20-102"></a><span class="st">    &lt;/style&gt;</span></span>
<span id="cb20-103"><a href="#cb20-103"></a></span>
<span id="cb20-104"><a href="#cb20-104"></a><span class="st">    &lt;div id="disclaimerOverlay"&gt;</span></span>
<span id="cb20-105"><a href="#cb20-105"></a><span class="st">      &lt;div id="disclaimerContent"&gt;</span></span>
<span id="cb20-106"><a href="#cb20-106"></a><span class="st">        &lt;h2&gt;Important Legal Disclaimer&lt;/h2&gt;</span></span>
<span id="cb20-107"><a href="#cb20-107"></a><span class="st">        &lt;p&gt;&lt;strong&gt;By using this demonstrative research tool, you acknowledge and agree:&lt;/strong&gt;&lt;/p&gt;</span></span>
<span id="cb20-108"><a href="#cb20-108"></a><span class="st">        &lt;ul&gt;</span></span>
<span id="cb20-109"><a href="#cb20-109"></a><span class="st">            &lt;li&gt;This tool is for &lt;strong&gt;demonstration purposes only&lt;/strong&gt;.&lt;/li&gt;</span></span>
<span id="cb20-110"><a href="#cb20-110"></a><span class="st">            &lt;li&gt;The data originated from publicly available Oak Park Police Department PDF files.</span></span>
<span id="cb20-111"><a href="#cb20-111"></a><span class="st">                View the official site here: </span></span>
<span id="cb20-112"><a href="#cb20-112"></a><span class="st">                &lt;a href="https://www.oak-park.us/village-services/police-department"</span></span>
<span id="cb20-113"><a href="#cb20-113"></a><span class="st">                   target="_blank"&gt;Oak Park Police Department&lt;/a&gt;.&lt;/li&gt;</span></span>
<span id="cb20-114"><a href="#cb20-114"></a><span class="st">            &lt;li&gt;During parsing, &lt;strong&gt;~10%&lt;/strong&gt; of complaints were &lt;strong&gt;omitted&lt;/strong&gt; </span></span>
<span id="cb20-115"><a href="#cb20-115"></a><span class="st">                due to parsing issues; thus the data is &lt;strong&gt;incomplete&lt;/strong&gt;.&lt;/li&gt;</span></span>
<span id="cb20-116"><a href="#cb20-116"></a><span class="st">            &lt;li&gt;The &lt;strong&gt;official&lt;/strong&gt; and &lt;strong&gt;complete&lt;/strong&gt; PDF files remain </span></span>
<span id="cb20-117"><a href="#cb20-117"></a><span class="st">                with the Oak Park Police Department.&lt;/li&gt;</span></span>
<span id="cb20-118"><a href="#cb20-118"></a><span class="st">            &lt;li&gt;You &lt;strong&gt;will not hold&lt;/strong&gt; the author &lt;strong&gt;liable&lt;/strong&gt; for &lt;strong&gt;any&lt;/strong&gt; </span></span>
<span id="cb20-119"><a href="#cb20-119"></a><span class="st">                decisions—formal or informal—based on this tool.&lt;/li&gt;</span></span>
<span id="cb20-120"><a href="#cb20-120"></a><span class="st">            &lt;li&gt;This tool &lt;strong&gt;should not&lt;/strong&gt; be used in &lt;strong&gt;any&lt;/strong&gt; official or unofficial </span></span>
<span id="cb20-121"><a href="#cb20-121"></a><span class="st">                &lt;strong&gt;decision-making&lt;/strong&gt;.&lt;/li&gt;</span></span>
<span id="cb20-122"><a href="#cb20-122"></a><span class="st">        &lt;/ul&gt;</span></span>
<span id="cb20-123"><a href="#cb20-123"></a><span class="st">        &lt;p&gt;&lt;strong&gt;By continuing, you indicate your acceptance of these terms </span></span>
<span id="cb20-124"><a href="#cb20-124"></a><span class="st">           and disclaim all liability.&lt;/strong&gt;&lt;/p&gt;</span></span>
<span id="cb20-125"><a href="#cb20-125"></a><span class="st">        &lt;hr/&gt;</span></span>
<span id="cb20-126"><a href="#cb20-126"></a><span class="st">        &lt;button id="acceptButton" onclick="hideOverlay()"&gt;I Accept&lt;/button&gt;</span></span>
<span id="cb20-127"><a href="#cb20-127"></a><span class="st">      &lt;/div&gt;</span></span>
<span id="cb20-128"><a href="#cb20-128"></a><span class="st">    &lt;/div&gt;</span></span>
<span id="cb20-129"><a href="#cb20-129"></a></span>
<span id="cb20-130"><a href="#cb20-130"></a><span class="st">    &lt;script&gt;</span></span>
<span id="cb20-131"><a href="#cb20-131"></a><span class="st">    function hideOverlay() {</span></span>
<span id="cb20-132"><a href="#cb20-132"></a><span class="st">      var overlay = document.getElementById('disclaimerOverlay');</span></span>
<span id="cb20-133"><a href="#cb20-133"></a><span class="st">      overlay.style.display = 'none'; </span></span>
<span id="cb20-134"><a href="#cb20-134"></a><span class="st">    }</span></span>
<span id="cb20-135"><a href="#cb20-135"></a><span class="st">    &lt;/script&gt;</span></span>
<span id="cb20-136"><a href="#cb20-136"></a><span class="st">    """</span></span>
<span id="cb20-137"><a href="#cb20-137"></a></span>
<span id="cb20-138"><a href="#cb20-138"></a>    disclaimers_element <span class="op">=</span> folium.Element(disclaimers_overlay)</span>
<span id="cb20-139"><a href="#cb20-139"></a>    crime_map.get_root().html.add_child(disclaimers_element)</span>
<span id="cb20-140"><a href="#cb20-140"></a></span>
<span id="cb20-141"><a href="#cb20-141"></a>    <span class="co"># 2) Save final HTML</span></span>
<span id="cb20-142"><a href="#cb20-142"></a>    crime_map.save(<span class="bu">str</span>(output_html_path))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p><strong>Explanation</strong>:</p>
<ul>
<li><p><strong>Map Initialization</strong>:</p>
<ul>
<li><strong>Centering</strong>: Centers the Folium map on Oak Park’s geographical coordinates with a zoom level of 13 for optimal visibility.</li>
</ul></li>
<li><p><strong>Marker Creation</strong>:</p>
<ul>
<li><p><strong>Customization</strong>: Each crime incident is represented by a red marker with an info-sign icon.</p></li>
<li><p><strong>Popups</strong>: Clicking on a marker reveals detailed information about the incident, including a link to the original PDF report.</p></li>
</ul></li>
<li><p><strong>Title Addition</strong>:</p>
<ul>
<li><strong>HTML Styling</strong>: Adds a title and navigation links directly onto the Folium map using HTML and inline CSS.</li>
</ul></li>
<li><p><strong>Disclaimer Overlay</strong>:</p>
<ul>
<li><p><strong>Purpose</strong>: Overlays a full-page disclaimer that users must accept before interacting with the map.</p></li>
<li><p><strong>Implementation</strong>:</p>
<ul>
<li><p><strong>CSS</strong>: Styles the overlay to cover the entire page with semi-transparent background.</p></li>
<li><p><strong>HTML</strong>: Structures the disclaimer content within a styled div.</p></li>
<li><p><strong>JavaScript</strong>: Provides a function to hide the overlay when the user clicks the “I Accept” button.</p></li>
</ul></li>
</ul></li>
<li><p><strong>Map Saving</strong>:</p>
<ul>
<li><strong>Output</strong>: Saves the generated map with overlays to the specified HTML file path.</li>
</ul></li>
</ul>
<section id="d.-gmail-api-service-setup" class="level5">
<h5 class="anchored" data-anchor-id="d.-gmail-api-service-setup"><strong>d.&nbsp;Gmail API Service Setup</strong></h5>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb21"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1"></a><span class="kw">def</span> get_gmail_service():</span>
<span id="cb21-2"><a href="#cb21-2"></a>    <span class="co">"""</span></span>
<span id="cb21-3"><a href="#cb21-3"></a><span class="co">    Authenticates the user and returns the Gmail API service.</span></span>
<span id="cb21-4"><a href="#cb21-4"></a><span class="co">    """</span></span>
<span id="cb21-5"><a href="#cb21-5"></a>    creds <span class="op">=</span> <span class="va">None</span></span>
<span id="cb21-6"><a href="#cb21-6"></a>    token_path <span class="op">=</span> Path(<span class="st">'token.json'</span>)</span>
<span id="cb21-7"><a href="#cb21-7"></a></span>
<span id="cb21-8"><a href="#cb21-8"></a>    <span class="cf">if</span> token_path.exists():</span>
<span id="cb21-9"><a href="#cb21-9"></a>        creds <span class="op">=</span> Credentials.from_authorized_user_file(<span class="bu">str</span>(token_path), SCOPES)</span>
<span id="cb21-10"><a href="#cb21-10"></a></span>
<span id="cb21-11"><a href="#cb21-11"></a>    <span class="cf">if</span> <span class="kw">not</span> creds <span class="kw">or</span> <span class="kw">not</span> creds.valid:</span>
<span id="cb21-12"><a href="#cb21-12"></a>        <span class="cf">if</span> creds <span class="kw">and</span> creds.expired <span class="kw">and</span> creds.refresh_token:</span>
<span id="cb21-13"><a href="#cb21-13"></a>            <span class="cf">try</span>:</span>
<span id="cb21-14"><a href="#cb21-14"></a>                creds.refresh(Request())</span>
<span id="cb21-15"><a href="#cb21-15"></a>                logging.info(<span class="st">"Credentials refreshed successfully."</span>)</span>
<span id="cb21-16"><a href="#cb21-16"></a>            <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb21-17"><a href="#cb21-17"></a>                logging.error(<span class="ss">f"Error refreshing credentials: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-18"><a href="#cb21-18"></a>                <span class="bu">print</span>(<span class="ss">f"[ERROR] Could not refresh credentials: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-19"><a href="#cb21-19"></a>                <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb21-20"><a href="#cb21-20"></a>        <span class="cf">else</span>:</span>
<span id="cb21-21"><a href="#cb21-21"></a>            <span class="cf">try</span>:</span>
<span id="cb21-22"><a href="#cb21-22"></a>                flow <span class="op">=</span> InstalledAppFlow.from_client_secrets_file(</span>
<span id="cb21-23"><a href="#cb21-23"></a>                    <span class="st">'credentials.json'</span>, SCOPES</span>
<span id="cb21-24"><a href="#cb21-24"></a>                )</span>
<span id="cb21-25"><a href="#cb21-25"></a>                creds <span class="op">=</span> flow.run_local_server(port<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb21-26"><a href="#cb21-26"></a>                logging.info(<span class="st">"Authentication flow completed successfully."</span>)</span>
<span id="cb21-27"><a href="#cb21-27"></a>            <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb21-28"><a href="#cb21-28"></a>                logging.error(<span class="ss">f"Error during OAuth flow: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-29"><a href="#cb21-29"></a>                <span class="bu">print</span>(<span class="ss">f"[ERROR] Could not complete OAuth flow: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-30"><a href="#cb21-30"></a>                <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb21-31"><a href="#cb21-31"></a></span>
<span id="cb21-32"><a href="#cb21-32"></a>        <span class="cf">try</span>:</span>
<span id="cb21-33"><a href="#cb21-33"></a>            <span class="cf">with</span> <span class="bu">open</span>(token_path, <span class="st">'w'</span>) <span class="im">as</span> token:</span>
<span id="cb21-34"><a href="#cb21-34"></a>                token.write(creds.to_json())</span>
<span id="cb21-35"><a href="#cb21-35"></a>                logging.info(<span class="st">"Credentials saved to token.json."</span>)</span>
<span id="cb21-36"><a href="#cb21-36"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb21-37"><a href="#cb21-37"></a>            logging.error(<span class="ss">f"Failed to save credentials: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-38"><a href="#cb21-38"></a>            <span class="bu">print</span>(<span class="ss">f"[ERROR] Could not save credentials: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-39"><a href="#cb21-39"></a></span>
<span id="cb21-40"><a href="#cb21-40"></a>    <span class="cf">try</span>:</span>
<span id="cb21-41"><a href="#cb21-41"></a>        service <span class="op">=</span> build(<span class="st">'gmail'</span>, <span class="st">'v1'</span>, credentials<span class="op">=</span>creds)</span>
<span id="cb21-42"><a href="#cb21-42"></a>        logging.info(<span class="st">"Gmail service created successfully."</span>)</span>
<span id="cb21-43"><a href="#cb21-43"></a>        <span class="cf">return</span> service</span>
<span id="cb21-44"><a href="#cb21-44"></a>    <span class="cf">except</span> HttpError <span class="im">as</span> error:</span>
<span id="cb21-45"><a href="#cb21-45"></a>        logging.error(<span class="ss">f"An error occurred while building Gmail service: </span><span class="sc">{</span>error<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-46"><a href="#cb21-46"></a>        <span class="bu">print</span>(<span class="ss">f"[ERROR] An error occurred while building Gmail service: </span><span class="sc">{</span>error<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-47"><a href="#cb21-47"></a>        <span class="cf">return</span> <span class="va">None</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p><strong>Explanation</strong>:</p>
<ul>
<li><p><strong>Purpose</strong>: Authenticates the user and establishes a connection with the Gmail API to send emails.</p></li>
<li><p><strong>Authentication Flow</strong>:</p>
<ol type="1">
<li><p><strong>Token Check</strong>: Looks for existing credentials in <code>token.json</code>.</p></li>
<li><p><strong>Token Refresh</strong>: If credentials are expired but have a refresh token, it attempts to refresh them.</p></li>
<li><p><strong>OAuth Flow</strong>: If no valid credentials exist, initiates the OAuth flow using <code>credentials.json</code>.</p></li>
<li><p><strong>Credential Saving</strong>: Saves the new or refreshed credentials back to <code>token.json</code> for future use.</p></li>
</ol></li>
<li><p><strong>Error Handling</strong>: Logs and prints errors encountered during authentication or service creation.</p></li>
</ul>
<p><strong>Usage</strong>: This function ensures secure and authenticated access to the Gmail API, enabling the script to send automated emails containing the latest crime reports.</p>
</section>
<section id="e.-email-sending-function" class="level5">
<h5 class="anchored" data-anchor-id="e.-email-sending-function"><strong>e. Email Sending Function</strong></h5>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb22"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1"></a><span class="kw">def</span> send_email_with_disclaimer_and_links(</span>
<span id="cb22-2"><a href="#cb22-2"></a>    service,</span>
<span id="cb22-3"><a href="#cb22-3"></a>    sender_email,</span>
<span id="cb22-4"><a href="#cb22-4"></a>    to_emails,</span>
<span id="cb22-5"><a href="#cb22-5"></a>    subject,</span>
<span id="cb22-6"><a href="#cb22-6"></a>    body_text,</span>
<span id="cb22-7"><a href="#cb22-7"></a>    attachments</span>
<span id="cb22-8"><a href="#cb22-8"></a>):</span>
<span id="cb22-9"><a href="#cb22-9"></a>    <span class="co">"""</span></span>
<span id="cb22-10"><a href="#cb22-10"></a><span class="co">    Sends an email with disclaimers and links using the Gmail API.</span></span>
<span id="cb22-11"><a href="#cb22-11"></a><span class="co">    """</span></span>
<span id="cb22-12"><a href="#cb22-12"></a>    <span class="cf">try</span>:</span>
<span id="cb22-13"><a href="#cb22-13"></a>        message <span class="op">=</span> MIMEMultipart()</span>
<span id="cb22-14"><a href="#cb22-14"></a>        message[<span class="st">'to'</span>] <span class="op">=</span> <span class="st">"Undisclosed Recipients &lt;jesse@jesse-anderson.net&gt;"</span></span>
<span id="cb22-15"><a href="#cb22-15"></a>        message[<span class="st">'subject'</span>] <span class="op">=</span> subject</span>
<span id="cb22-16"><a href="#cb22-16"></a>        message[<span class="st">'from'</span>] <span class="op">=</span> sender_email</span>
<span id="cb22-17"><a href="#cb22-17"></a></span>
<span id="cb22-18"><a href="#cb22-18"></a>        <span class="co"># disclaimer = """</span></span>
<span id="cb22-19"><a href="#cb22-19"></a>        <span class="co"># &lt;p&gt;&lt;strong&gt;Important Legal Disclaimer&lt;/strong&gt;&lt;/p&gt;</span></span>
<span id="cb22-20"><a href="#cb22-20"></a>        <span class="co"># &lt;p&gt;&lt;strong&gt;By using this demonstrative research tool, you acknowledge and agree:&lt;/strong&gt;&lt;/p&gt;</span></span>
<span id="cb22-21"><a href="#cb22-21"></a>        <span class="co"># &lt;ul&gt;</span></span>
<span id="cb22-22"><a href="#cb22-22"></a>        <span class="co">#     &lt;li&gt;This tool is for &lt;strong&gt;demonstration purposes only&lt;/strong&gt;.&lt;/li&gt;</span></span>
<span id="cb22-23"><a href="#cb22-23"></a>        <span class="co">#     &lt;li&gt;The data originated from publicly available Oak Park Police Department PDF files.</span></span>
<span id="cb22-24"><a href="#cb22-24"></a>        <span class="co">#         &lt;a href="https://www.oak-park.us/village-services/police-department"&gt;Official site&lt;/a&gt;.&lt;/li&gt;</span></span>
<span id="cb22-25"><a href="#cb22-25"></a>        <span class="co">#     &lt;li&gt;During parsing, &lt;strong&gt;~10%&lt;/strong&gt; of complaints were &lt;strong&gt;omitted&lt;/strong&gt;.&lt;/li&gt;</span></span>
<span id="cb22-26"><a href="#cb22-26"></a>        <span class="co">#     &lt;li&gt;The &lt;strong&gt;official&lt;/strong&gt; and &lt;strong&gt;complete&lt;/strong&gt; PDF files remain with the Oak Park Police Department.&lt;/li&gt;</span></span>
<span id="cb22-27"><a href="#cb22-27"></a>        <span class="co">#     &lt;li&gt;You &lt;strong&gt;will not hold&lt;/strong&gt; the author &lt;strong&gt;liable&lt;/strong&gt; for any decisions</span></span>
<span id="cb22-28"><a href="#cb22-28"></a>        <span class="co">#         based on this tool.&lt;/li&gt;</span></span>
<span id="cb22-29"><a href="#cb22-29"></a>        <span class="co">#     &lt;li&gt;This tool &lt;strong&gt;should not&lt;/strong&gt; be used in any official or unofficial &lt;strong&gt;decision-making&lt;/strong&gt;.&lt;/li&gt;</span></span>
<span id="cb22-30"><a href="#cb22-30"></a>        <span class="co"># &lt;/ul&gt;</span></span>
<span id="cb22-31"><a href="#cb22-31"></a>        <span class="co"># &lt;p&gt;&lt;strong&gt;By continuing, you disclaim all liability.&lt;/strong&gt;&lt;/p&gt;</span></span>
<span id="cb22-32"><a href="#cb22-32"></a>        <span class="co"># &lt;hr&gt;</span></span>
<span id="cb22-33"><a href="#cb22-33"></a>        <span class="co"># """</span></span>
<span id="cb22-34"><a href="#cb22-34"></a></span>
<span id="cb22-35"><a href="#cb22-35"></a>        links <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb22-36"><a href="#cb22-36"></a><span class="st">        &lt;p&gt;</span></span>
<span id="cb22-37"><a href="#cb22-37"></a><span class="st">            &lt;a href="https://jesse-anderson.net/"&gt;My Portfolio&lt;/a&gt; | </span></span>
<span id="cb22-38"><a href="#cb22-38"></a><span class="st">            &lt;a href="https://blog.jesse-anderson.net/"&gt;My Blog&lt;/a&gt;</span></span>
<span id="cb22-39"><a href="#cb22-39"></a><span class="st">        &lt;/p&gt;</span></span>
<span id="cb22-40"><a href="#cb22-40"></a><span class="st">        &lt;hr&gt;</span></span>
<span id="cb22-41"><a href="#cb22-41"></a><span class="st">        """</span></span>
<span id="cb22-42"><a href="#cb22-42"></a></span>
<span id="cb22-43"><a href="#cb22-43"></a>        <span class="co"># Define the plain text content</span></span>
<span id="cb22-44"><a href="#cb22-44"></a>        plain_text <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb22-45"><a href="#cb22-45"></a><span class="ss">        Important Legal Disclaimer</span></span>
<span id="cb22-46"><a href="#cb22-46"></a><span class="ss">        </span></span>
<span id="cb22-47"><a href="#cb22-47"></a><span class="ss">        By using this demonstrative research tool, you acknowledge and agree:</span></span>
<span id="cb22-48"><a href="#cb22-48"></a></span>
<span id="cb22-49"><a href="#cb22-49"></a><span class="ss">        - This tool is for demonstration purposes only.</span></span>
<span id="cb22-50"><a href="#cb22-50"></a><span class="ss">        - The data originated from publicly available Oak Park Police Department PDF files.</span></span>
<span id="cb22-51"><a href="#cb22-51"></a><span class="ss">          View the official site here: https://www.oak-park.us/village-services/police-department.</span></span>
<span id="cb22-52"><a href="#cb22-52"></a><span class="ss">        - During parsing, ~10% of total complaints since 2018 were omitted due to parsing issues; </span></span>
<span id="cb22-53"><a href="#cb22-53"></a><span class="ss">          thus the data is incomplete.</span></span>
<span id="cb22-54"><a href="#cb22-54"></a><span class="ss">        - The official and complete PDF files remain with the Oak Park Police Department.</span></span>
<span id="cb22-55"><a href="#cb22-55"></a><span class="ss">        - You will not hold the author liable for any decisions—formal or informal—based on this tool.</span></span>
<span id="cb22-56"><a href="#cb22-56"></a><span class="ss">        - This tool should not be used in any official or unofficial decision-making.</span></span>
<span id="cb22-57"><a href="#cb22-57"></a></span>
<span id="cb22-58"><a href="#cb22-58"></a><span class="ss">        By continuing, you indicate your acceptance of these terms and disclaim all liability.</span></span>
<span id="cb22-59"><a href="#cb22-59"></a></span>
<span id="cb22-60"><a href="#cb22-60"></a><span class="ss">        ------------</span></span>
<span id="cb22-61"><a href="#cb22-61"></a></span>
<span id="cb22-62"><a href="#cb22-62"></a><span class="ss">        Hello,</span></span>
<span id="cb22-63"><a href="#cb22-63"></a><span class="ss">        The crime report from </span><span class="sc">{</span>body_text[<span class="st">'start_date'</span>]<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>body_text[<span class="st">'end_date'</span>]<span class="sc">}</span><span class="ss"> is attached as a .csv file.</span></span>
<span id="cb22-64"><a href="#cb22-64"></a></span>
<span id="cb22-65"><a href="#cb22-65"></a><span class="ss">        Interactive map:</span></span>
<span id="cb22-66"><a href="#cb22-66"></a><span class="ss">        </span><span class="sc">{</span>body_text[<span class="st">'weekly_map_url'</span>]<span class="sc">}</span></span>
<span id="cb22-67"><a href="#cb22-67"></a></span>
<span id="cb22-68"><a href="#cb22-68"></a><span class="ss">        Cumulative map:</span></span>
<span id="cb22-69"><a href="#cb22-69"></a><span class="ss">        </span><span class="sc">{</span>body_text[<span class="st">'cumulative_map_url'</span>]<span class="sc">}</span></span>
<span id="cb22-70"><a href="#cb22-70"></a><span class="ss">        </span></span>
<span id="cb22-71"><a href="#cb22-71"></a><span class="ss">        Last week's data:</span></span>
<span id="cb22-72"><a href="#cb22-72"></a><span class="ss">        </span><span class="sc">{</span>body_text[<span class="st">'csv_url'</span>]<span class="sc">}</span></span>
<span id="cb22-73"><a href="#cb22-73"></a><span class="ss">        """</span></span>
<span id="cb22-74"><a href="#cb22-74"></a></span>
<span id="cb22-75"><a href="#cb22-75"></a>        part1 <span class="op">=</span> MIMEText(plain_text, <span class="st">'plain'</span>)</span>
<span id="cb22-76"><a href="#cb22-76"></a>        message.attach(part1)</span>
<span id="cb22-77"><a href="#cb22-77"></a></span>
<span id="cb22-78"><a href="#cb22-78"></a>        bcc_emails <span class="op">=</span> <span class="st">", "</span>.join(to_emails)</span>
<span id="cb22-79"><a href="#cb22-79"></a>        message[<span class="st">'bcc'</span>] <span class="op">=</span> bcc_emails</span>
<span id="cb22-80"><a href="#cb22-80"></a></span>
<span id="cb22-81"><a href="#cb22-81"></a>        <span class="co"># Attach the CSV</span></span>
<span id="cb22-82"><a href="#cb22-82"></a>        <span class="cf">for</span> file_path <span class="kw">in</span> attachments:</span>
<span id="cb22-83"><a href="#cb22-83"></a>            file_path <span class="op">=</span> Path(file_path)</span>
<span id="cb22-84"><a href="#cb22-84"></a>            <span class="cf">if</span> <span class="kw">not</span> file_path.exists():</span>
<span id="cb22-85"><a href="#cb22-85"></a>                logging.warning(<span class="ss">f"Attachment '</span><span class="sc">{</span>file_path<span class="sc">}</span><span class="ss">' not found, skipping."</span>)</span>
<span id="cb22-86"><a href="#cb22-86"></a>                <span class="cf">continue</span></span>
<span id="cb22-87"><a href="#cb22-87"></a>            <span class="cf">with</span> <span class="bu">open</span>(file_path, <span class="st">'rb'</span>) <span class="im">as</span> f:</span>
<span id="cb22-88"><a href="#cb22-88"></a>                mime_application <span class="op">=</span> MIMEApplication(f.read(), Name<span class="op">=</span>file_path.name)</span>
<span id="cb22-89"><a href="#cb22-89"></a>            mime_application[<span class="st">'Content-Disposition'</span>] <span class="op">=</span> <span class="ss">f'attachment; filename="</span><span class="sc">{</span>file_path<span class="sc">.</span>name<span class="sc">}</span><span class="ss">"'</span></span>
<span id="cb22-90"><a href="#cb22-90"></a>            message.attach(mime_application)</span>
<span id="cb22-91"><a href="#cb22-91"></a></span>
<span id="cb22-92"><a href="#cb22-92"></a>        raw_message <span class="op">=</span> base64.urlsafe_b64encode(message.as_bytes()).decode()</span>
<span id="cb22-93"><a href="#cb22-93"></a>        body <span class="op">=</span> {<span class="st">'raw'</span>: raw_message}</span>
<span id="cb22-94"><a href="#cb22-94"></a></span>
<span id="cb22-95"><a href="#cb22-95"></a>        sent_message <span class="op">=</span> service.users().messages().send(userId<span class="op">=</span><span class="st">"me"</span>, body<span class="op">=</span>body).execute()</span>
<span id="cb22-96"><a href="#cb22-96"></a>        logging.info(<span class="ss">f"Email sent successfully. Message ID: </span><span class="sc">{</span>sent_message[<span class="st">'id'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb22-97"><a href="#cb22-97"></a>        <span class="bu">print</span>(<span class="st">"Crime report email sent successfully."</span>)</span>
<span id="cb22-98"><a href="#cb22-98"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb22-99"><a href="#cb22-99"></a>        logging.error(<span class="ss">f"Failed to send email: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb22-100"><a href="#cb22-100"></a>        <span class="bu">print</span>(<span class="ss">f"[ERROR] Failed to send email: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p><strong>Explanation</strong>:</p>
<ul>
<li><p><strong>Purpose</strong>: Composes and sends an email containing the latest crime reports and links to interactive maps.</p></li>
<li><p><strong>Structure</strong>:</p>
<ul>
<li><p><strong>Email Composition</strong>:</p>
<ul>
<li><p><strong>Plain Text</strong>: Provides a disclaimer and details about the latest crime reports.</p></li>
<li><p><strong>Attachments</strong>: Attaches the filtered CSV report.</p></li>
</ul></li>
<li><p><strong>BCC</strong>: Sends the email to undisclosed recipients to maintain privacy.</p></li>
</ul></li>
<li><p><strong>Encoding</strong>: Encodes the email content in base64 to comply with Gmail API requirements.</p></li>
<li><p><strong>Sending</strong>: Utilizes the authenticated Gmail service to send the email.</p></li>
<li><p><strong>Error Handling</strong>: Logs and prints errors encountered during the email sending process.</p></li>
</ul>
</section>
<section id="f.-main-report-generation-workflow" class="level5">
<h5 class="anchored" data-anchor-id="f.-main-report-generation-workflow"><strong>f.&nbsp;Main Report Generation Workflow</strong></h5>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb23"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1"></a><span class="kw">def</span> main_report_generation():</span>
<span id="cb23-2"><a href="#cb23-2"></a>    <span class="co">"""</span></span>
<span id="cb23-3"><a href="#cb23-3"></a><span class="co">    Executes the full pipeline:</span></span>
<span id="cb23-4"><a href="#cb23-4"></a><span class="co">    1. Load environment variables</span></span>
<span id="cb23-5"><a href="#cb23-5"></a><span class="co">    2. Load &amp; filter data for the last 7 days</span></span>
<span id="cb23-6"><a href="#cb23-6"></a><span class="co">    3. Create &amp; save Folium map with disclaimers overlay</span></span>
<span id="cb23-7"><a href="#cb23-7"></a><span class="co">    4. Upload HTML to GitHub</span></span>
<span id="cb23-8"><a href="#cb23-8"></a><span class="co">    5. Send email with CSV attached</span></span>
<span id="cb23-9"><a href="#cb23-9"></a><span class="co">    """</span></span>
<span id="cb23-10"><a href="#cb23-10"></a>    start_time <span class="op">=</span> time.time()</span>
<span id="cb23-11"><a href="#cb23-11"></a>    script_dir <span class="op">=</span> Path(<span class="va">__file__</span>).parent.resolve()</span>
<span id="cb23-12"><a href="#cb23-12"></a></span>
<span id="cb23-13"><a href="#cb23-13"></a>    env_file_path <span class="op">=</span> script_dir <span class="op">/</span> <span class="st">"env_vars.txt"</span></span>
<span id="cb23-14"><a href="#cb23-14"></a>    <span class="cf">try</span>:</span>
<span id="cb23-15"><a href="#cb23-15"></a>        load_env_vars(env_file_path)</span>
<span id="cb23-16"><a href="#cb23-16"></a>    <span class="cf">except</span> <span class="pp">FileNotFoundError</span> <span class="im">as</span> e:</span>
<span id="cb23-17"><a href="#cb23-17"></a>        <span class="bu">print</span>(<span class="ss">f"[ERROR] </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-18"><a href="#cb23-18"></a>        <span class="cf">return</span></span>
<span id="cb23-19"><a href="#cb23-19"></a></span>
<span id="cb23-20"><a href="#cb23-20"></a>    sender_email <span class="op">=</span> os.getenv(<span class="st">"SENDER_EMAIL"</span>)</span>
<span id="cb23-21"><a href="#cb23-21"></a>    <span class="cf">if</span> <span class="kw">not</span> sender_email:</span>
<span id="cb23-22"><a href="#cb23-22"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Missing SENDER_EMAIL in env_vars.txt"</span>)</span>
<span id="cb23-23"><a href="#cb23-23"></a></span>
<span id="cb23-24"><a href="#cb23-24"></a>    logging.basicConfig(</span>
<span id="cb23-25"><a href="#cb23-25"></a>        filename<span class="op">=</span>script_dir <span class="op">/</span> <span class="st">'full_crime_report.log'</span>,</span>
<span id="cb23-26"><a href="#cb23-26"></a>        level<span class="op">=</span>logging.DEBUG,</span>
<span id="cb23-27"><a href="#cb23-27"></a>        <span class="bu">format</span><span class="op">=</span><span class="st">'</span><span class="sc">%(asctime)s</span><span class="st"> - </span><span class="sc">%(levelname)s</span><span class="st"> - </span><span class="sc">%(message)s</span><span class="st">'</span></span>
<span id="cb23-28"><a href="#cb23-28"></a>    )</span>
<span id="cb23-29"><a href="#cb23-29"></a></span>
<span id="cb23-30"><a href="#cb23-30"></a>    data_dir <span class="op">=</span> script_dir <span class="op">/</span> <span class="st">'data'</span></span>
<span id="cb23-31"><a href="#cb23-31"></a>    map_dir <span class="op">=</span> script_dir <span class="op">/</span> <span class="st">'generated_maps'</span></span>
<span id="cb23-32"><a href="#cb23-32"></a>    <span class="co"># recipients_csv = script_dir / 'recipients.csv'</span></span>
<span id="cb23-33"><a href="#cb23-33"></a>    csv_dir <span class="op">=</span> script_dir <span class="op">/</span> <span class="st">'generated_csvs'</span>  <span class="co"># New directory for CSVs</span></span>
<span id="cb23-34"><a href="#cb23-34"></a>    map_dir.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb23-35"><a href="#cb23-35"></a>    csv_dir.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb23-36"><a href="#cb23-36"></a></span>
<span id="cb23-37"><a href="#cb23-37"></a>    zip_file_path <span class="op">=</span> data_dir <span class="op">/</span> <span class="st">'summary_report.zip'</span></span>
<span id="cb23-38"><a href="#cb23-38"></a></span>
<span id="cb23-39"><a href="#cb23-39"></a>    execution_date <span class="op">=</span> datetime.now().date()</span>
<span id="cb23-40"><a href="#cb23-40"></a>    date_str <span class="op">=</span> execution_date.strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>)</span>
<span id="cb23-41"><a href="#cb23-41"></a></span>
<span id="cb23-42"><a href="#cb23-42"></a>    <span class="co"># CSV &amp; HTML output</span></span>
<span id="cb23-43"><a href="#cb23-43"></a>    filtered_subset_filename <span class="op">=</span> <span class="ss">f'filtered_subset_</span><span class="sc">{</span>date_str<span class="sc">}</span><span class="ss">.csv'</span></span>
<span id="cb23-44"><a href="#cb23-44"></a>    filtered_subset_path <span class="op">=</span> csv_dir <span class="op">/</span> filtered_subset_filename</span>
<span id="cb23-45"><a href="#cb23-45"></a>    weekly_map_output_filename <span class="op">=</span> <span class="ss">f'crime_map_weekly_</span><span class="sc">{</span>date_str<span class="sc">}</span><span class="ss">.html'</span></span>
<span id="cb23-46"><a href="#cb23-46"></a>    weekly_map_output_path <span class="op">=</span> map_dir <span class="op">/</span> weekly_map_output_filename</span>
<span id="cb23-47"><a href="#cb23-47"></a>    cumulative_map_output_filename <span class="op">=</span> <span class="ss">f'crime_map_cumulative.html'</span></span>
<span id="cb23-48"><a href="#cb23-48"></a>    cumulative_map_output_path <span class="op">=</span> map_dir <span class="op">/</span> cumulative_map_output_filename</span>
<span id="cb23-49"><a href="#cb23-49"></a></span>
<span id="cb23-50"><a href="#cb23-50"></a>    <span class="co"># Local GitHub Pages folder</span></span>
<span id="cb23-51"><a href="#cb23-51"></a>    github_repo_path <span class="op">=</span> os.getenv(<span class="st">"GITHUB_REPO"</span>)</span>
<span id="cb23-52"><a href="#cb23-52"></a>    github_repo_path <span class="op">=</span> Path(github_repo_path)</span>
<span id="cb23-53"><a href="#cb23-53"></a></span>
<span id="cb23-54"><a href="#cb23-54"></a>    <span class="co"># (C) Load data</span></span>
<span id="cb23-55"><a href="#cb23-55"></a>    <span class="cf">try</span>:</span>
<span id="cb23-56"><a href="#cb23-56"></a>        df_full <span class="op">=</span> load_all_crimes(zip_file_path)</span>
<span id="cb23-57"><a href="#cb23-57"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb23-58"><a href="#cb23-58"></a>        logging.error(<span class="ss">f"Failed to load all crimes: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-59"><a href="#cb23-59"></a>        <span class="bu">print</span>(<span class="ss">f"[ERROR] Could not load all crimes: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-60"><a href="#cb23-60"></a>        <span class="cf">return</span></span>
<span id="cb23-61"><a href="#cb23-61"></a></span>
<span id="cb23-62"><a href="#cb23-62"></a>    <span class="cf">if</span> df_full.empty:</span>
<span id="cb23-63"><a href="#cb23-63"></a>        logging.info(<span class="st">"No crime data—no map or CSV generated."</span>)</span>
<span id="cb23-64"><a href="#cb23-64"></a>        <span class="bu">print</span>(<span class="st">"No crime data—no map or CSV generated."</span>)</span>
<span id="cb23-65"><a href="#cb23-65"></a>        <span class="cf">return</span></span>
<span id="cb23-66"><a href="#cb23-66"></a></span>
<span id="cb23-67"><a href="#cb23-67"></a>    <span class="co"># (D) Filter last 7 days</span></span>
<span id="cb23-68"><a href="#cb23-68"></a>    <span class="cf">try</span>:</span>
<span id="cb23-69"><a href="#cb23-69"></a>        start_date, end_date <span class="op">=</span> determine_date_range(df_full, execution_date)</span>
<span id="cb23-70"><a href="#cb23-70"></a>        df_filtered <span class="op">=</span> filter_crime_data(df_full, start_date, end_date)</span>
<span id="cb23-71"><a href="#cb23-71"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb23-72"><a href="#cb23-72"></a>        logging.error(<span class="ss">f"Error determining date range: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-73"><a href="#cb23-73"></a>        <span class="bu">print</span>(<span class="ss">f"[ERROR] Could not determine date range: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-74"><a href="#cb23-74"></a>        <span class="cf">return</span></span>
<span id="cb23-75"><a href="#cb23-75"></a></span>
<span id="cb23-76"><a href="#cb23-76"></a>    <span class="cf">if</span> df_filtered.empty:</span>
<span id="cb23-77"><a href="#cb23-77"></a>        logging.info(<span class="st">"No crimes found—no map or CSV generated."</span>)</span>
<span id="cb23-78"><a href="#cb23-78"></a>        <span class="bu">print</span>(<span class="st">"No crimes found in the determined date range—no map or CSV generated."</span>)</span>
<span id="cb23-79"><a href="#cb23-79"></a>        <span class="cf">return</span></span>
<span id="cb23-80"><a href="#cb23-80"></a></span>
<span id="cb23-81"><a href="#cb23-81"></a>    <span class="co"># (E) Write filtered CSV</span></span>
<span id="cb23-82"><a href="#cb23-82"></a>    <span class="cf">try</span>:</span>
<span id="cb23-83"><a href="#cb23-83"></a>        df_filtered.to_csv(filtered_subset_path, index<span class="op">=</span><span class="va">False</span>, encoding<span class="op">=</span><span class="st">"cp1252"</span>)</span>
<span id="cb23-84"><a href="#cb23-84"></a>        logging.info(<span class="ss">f"Filtered data written to </span><span class="sc">{</span>filtered_subset_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-85"><a href="#cb23-85"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb23-86"><a href="#cb23-86"></a>        logging.error(<span class="ss">f"Failed to write filtered data to CSV: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-87"><a href="#cb23-87"></a>        <span class="bu">print</span>(<span class="ss">f"[ERROR] Could not write filtered data to CSV: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-88"><a href="#cb23-88"></a>        <span class="cf">return</span></span>
<span id="cb23-89"><a href="#cb23-89"></a></span>
<span id="cb23-90"><a href="#cb23-90"></a>    <span class="co"># (F) Create Folium map with disclaimers overlay</span></span>
<span id="cb23-91"><a href="#cb23-91"></a>    <span class="cf">try</span>:</span>
<span id="cb23-92"><a href="#cb23-92"></a>        create_folium_map_filtered_data(</span>
<span id="cb23-93"><a href="#cb23-93"></a>            df<span class="op">=</span>df_filtered,</span>
<span id="cb23-94"><a href="#cb23-94"></a>            lat_col<span class="op">=</span><span class="st">'Lat'</span>,</span>
<span id="cb23-95"><a href="#cb23-95"></a>            lng_col<span class="op">=</span><span class="st">'Long'</span>,</span>
<span id="cb23-96"><a href="#cb23-96"></a>            offense_col<span class="op">=</span><span class="st">'Offense'</span>,</span>
<span id="cb23-97"><a href="#cb23-97"></a>            date_col<span class="op">=</span><span class="st">'Date'</span>,</span>
<span id="cb23-98"><a href="#cb23-98"></a>            output_html_path<span class="op">=</span>weekly_map_output_path</span>
<span id="cb23-99"><a href="#cb23-99"></a>        )</span>
<span id="cb23-100"><a href="#cb23-100"></a>        logging.info(<span class="ss">f"Folium map created at </span><span class="sc">{</span>weekly_map_output_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-101"><a href="#cb23-101"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb23-102"><a href="#cb23-102"></a>        logging.error(<span class="ss">f"Error creating Folium map: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-103"><a href="#cb23-103"></a>        <span class="bu">print</span>(<span class="ss">f"[ERROR] Could not create Folium map: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-104"><a href="#cb23-104"></a>        <span class="cf">return</span></span>
<span id="cb23-105"><a href="#cb23-105"></a></span>
<span id="cb23-106"><a href="#cb23-106"></a>    <span class="cf">try</span>:</span>
<span id="cb23-107"><a href="#cb23-107"></a>        create_folium_map_cumulative(</span>
<span id="cb23-108"><a href="#cb23-108"></a>            df<span class="op">=</span>df_full,  <span class="co"># Use the full dataset for cumulative map</span></span>
<span id="cb23-109"><a href="#cb23-109"></a>            lat_col<span class="op">=</span><span class="st">'Lat'</span>,</span>
<span id="cb23-110"><a href="#cb23-110"></a>            lng_col<span class="op">=</span><span class="st">'Long'</span>,</span>
<span id="cb23-111"><a href="#cb23-111"></a>            offense_col<span class="op">=</span><span class="st">'Offense'</span>,</span>
<span id="cb23-112"><a href="#cb23-112"></a>            date_col<span class="op">=</span><span class="st">'Date'</span>,</span>
<span id="cb23-113"><a href="#cb23-113"></a>            output_html_path<span class="op">=</span>cumulative_map_output_path</span>
<span id="cb23-114"><a href="#cb23-114"></a>        )</span>
<span id="cb23-115"><a href="#cb23-115"></a>        logging.info(<span class="ss">f"Cumulative Folium map created at </span><span class="sc">{</span>cumulative_map_output_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-116"><a href="#cb23-116"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb23-117"><a href="#cb23-117"></a>        logging.error(<span class="ss">f"Error creating cumulative Folium map: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-118"><a href="#cb23-118"></a>        <span class="bu">print</span>(<span class="ss">f"[ERROR] Could not create cumulative Folium map: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-119"><a href="#cb23-119"></a>        <span class="cf">return</span></span>
<span id="cb23-120"><a href="#cb23-120"></a>    </span>
<span id="cb23-121"><a href="#cb23-121"></a>    test <span class="op">=</span> <span class="va">False</span></span>
<span id="cb23-122"><a href="#cb23-122"></a>    <span class="cf">if</span> <span class="kw">not</span> test:</span>
<span id="cb23-123"><a href="#cb23-123"></a>        <span class="co"># (G) Upload Map and csv</span></span>
<span id="cb23-124"><a href="#cb23-124"></a>        <span class="cf">try</span>:</span>
<span id="cb23-125"><a href="#cb23-125"></a>            <span class="co"># Upload Maps</span></span>
<span id="cb23-126"><a href="#cb23-126"></a>            files_to_upload_maps <span class="op">=</span> [weekly_map_output_path, cumulative_map_output_path]</span>
<span id="cb23-127"><a href="#cb23-127"></a>            upload_files_to_github_batch(</span>
<span id="cb23-128"><a href="#cb23-128"></a>                file_paths<span class="op">=</span>files_to_upload_maps,</span>
<span id="cb23-129"><a href="#cb23-129"></a>                github_repo_path<span class="op">=</span>github_repo_path,</span>
<span id="cb23-130"><a href="#cb23-130"></a>                target_subfolder<span class="op">=</span><span class="st">'OP-Crime-Maps'</span></span>
<span id="cb23-131"><a href="#cb23-131"></a>            )</span>
<span id="cb23-132"><a href="#cb23-132"></a>            time.sleep(<span class="dv">5</span>) <span class="co">#paranoia</span></span>
<span id="cb23-133"><a href="#cb23-133"></a>            <span class="co"># Upload CSV</span></span>
<span id="cb23-134"><a href="#cb23-134"></a>            files_to_upload_csv <span class="op">=</span> filtered_subset_path</span>
<span id="cb23-135"><a href="#cb23-135"></a>            upload_file_to_github(</span>
<span id="cb23-136"><a href="#cb23-136"></a>                file_path<span class="op">=</span>files_to_upload_csv,</span>
<span id="cb23-137"><a href="#cb23-137"></a>                github_repo_path<span class="op">=</span>github_repo_path,</span>
<span id="cb23-138"><a href="#cb23-138"></a>                target_subfolder<span class="op">=</span><span class="st">'OP-Crime-Data'</span></span>
<span id="cb23-139"><a href="#cb23-139"></a>            )</span>
<span id="cb23-140"><a href="#cb23-140"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb23-141"><a href="#cb23-141"></a>            logging.error(<span class="ss">f"Failed to upload files to GitHub: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-142"><a href="#cb23-142"></a>            <span class="bu">print</span>(<span class="ss">f"[ERROR] Could not upload files to GitHub: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-143"><a href="#cb23-143"></a>            <span class="cf">return</span></span>
<span id="cb23-144"><a href="#cb23-144"></a>        <span class="co"># (I) Generate GitHub URLs for the uploaded files</span></span>
<span id="cb23-145"><a href="#cb23-145"></a>        <span class="co"># Assuming GitHub Pages are served from the root of the repository</span></span>
<span id="cb23-146"><a href="#cb23-146"></a>        github_base_url <span class="op">=</span> <span class="st">"https://jesse-anderson.github.io"</span></span>
<span id="cb23-147"><a href="#cb23-147"></a></span>
<span id="cb23-148"><a href="#cb23-148"></a>        weekly_map_url <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>github_base_url<span class="sc">}</span><span class="ss">/OP-Crime-Maps/</span><span class="sc">{</span>weekly_map_output_filename<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb23-149"><a href="#cb23-149"></a>        cumulative_map_url <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>github_base_url<span class="sc">}</span><span class="ss">/OP-Crime-Maps/</span><span class="sc">{</span>cumulative_map_output_filename<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb23-150"><a href="#cb23-150"></a>        csv_url <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>github_base_url<span class="sc">}</span><span class="ss">/OP-Crime-Data/</span><span class="sc">{</span>filtered_subset_filename<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb23-151"><a href="#cb23-151"></a></span>
<span id="cb23-152"><a href="#cb23-152"></a>        <span class="co"># (J) Gmail API &amp; Email</span></span>
<span id="cb23-153"><a href="#cb23-153"></a>        <span class="cf">try</span>:</span>
<span id="cb23-154"><a href="#cb23-154"></a>            service <span class="op">=</span> get_gmail_service()</span>
<span id="cb23-155"><a href="#cb23-155"></a>            <span class="cf">if</span> <span class="kw">not</span> service:</span>
<span id="cb23-156"><a href="#cb23-156"></a>                <span class="cf">raise</span> <span class="pp">Exception</span>(<span class="st">"Failed to create Gmail service."</span>)</span>
<span id="cb23-157"><a href="#cb23-157"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb23-158"><a href="#cb23-158"></a>            logging.error(<span class="ss">f"Authentication failed: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-159"><a href="#cb23-159"></a>            <span class="bu">print</span>(<span class="ss">f"[ERROR] Authentication failed: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-160"><a href="#cb23-160"></a>            <span class="cf">return</span></span>
<span id="cb23-161"><a href="#cb23-161"></a>        time.sleep(<span class="dv">60</span>) <span class="co">#time to build github pages....</span></span>
<span id="cb23-162"><a href="#cb23-162"></a>        <span class="co"># (K) Load Recipients</span></span>
<span id="cb23-163"><a href="#cb23-163"></a>        <span class="cf">try</span>:</span>
<span id="cb23-164"><a href="#cb23-164"></a>            <span class="co"># to_list = load_recipients_list(recipients_csv)</span></span>
<span id="cb23-165"><a href="#cb23-165"></a>            <span class="co"># to_list = get_mailchimp_subscribers()</span></span>
<span id="cb23-166"><a href="#cb23-166"></a>            to_list <span class="op">=</span> [<span class="st">"myemail@gmail.com"</span>]</span>
<span id="cb23-167"><a href="#cb23-167"></a>        <span class="cf">except</span> <span class="pp">FileNotFoundError</span> <span class="im">as</span> e:</span>
<span id="cb23-168"><a href="#cb23-168"></a>            logging.error(<span class="ss">f"Error loading recipients: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-169"><a href="#cb23-169"></a>            <span class="bu">print</span>(<span class="ss">f"[ERROR] </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-170"><a href="#cb23-170"></a>            <span class="cf">return</span></span>
<span id="cb23-171"><a href="#cb23-171"></a></span>
<span id="cb23-172"><a href="#cb23-172"></a>        <span class="cf">if</span> <span class="kw">not</span> to_list:</span>
<span id="cb23-173"><a href="#cb23-173"></a>            logging.warning(<span class="st">"No recipients found—cannot send email."</span>)</span>
<span id="cb23-174"><a href="#cb23-174"></a>            <span class="bu">print</span>(<span class="st">"No recipients found in recipients.csv—cannot send email."</span>)</span>
<span id="cb23-175"><a href="#cb23-175"></a>            <span class="cf">return</span></span>
<span id="cb23-176"><a href="#cb23-176"></a></span>
<span id="cb23-177"><a href="#cb23-177"></a>        subject <span class="op">=</span> <span class="ss">f"Crime Report from </span><span class="sc">{</span>start_date<span class="sc">.</span>strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>)<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>end_date<span class="sc">.</span>strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>)<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb23-178"><a href="#cb23-178"></a>        body_text <span class="op">=</span> {</span>
<span id="cb23-179"><a href="#cb23-179"></a>            <span class="st">'start_date'</span>: start_date.strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>),</span>
<span id="cb23-180"><a href="#cb23-180"></a>            <span class="st">'end_date'</span>: end_date.strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>),</span>
<span id="cb23-181"><a href="#cb23-181"></a>            <span class="st">'weekly_map_url'</span>: weekly_map_url,</span>
<span id="cb23-182"><a href="#cb23-182"></a>            <span class="st">'cumulative_map_url'</span>: cumulative_map_url,</span>
<span id="cb23-183"><a href="#cb23-183"></a>            <span class="st">'csv_url'</span>: csv_url</span>
<span id="cb23-184"><a href="#cb23-184"></a>        }</span>
<span id="cb23-185"><a href="#cb23-185"></a>        attachments <span class="op">=</span> []</span>
<span id="cb23-186"><a href="#cb23-186"></a></span>
<span id="cb23-187"><a href="#cb23-187"></a>        <span class="cf">try</span>:</span>
<span id="cb23-188"><a href="#cb23-188"></a>            send_email_with_disclaimer_and_links(</span>
<span id="cb23-189"><a href="#cb23-189"></a>                service<span class="op">=</span>service,</span>
<span id="cb23-190"><a href="#cb23-190"></a>                sender_email<span class="op">=</span>sender_email,</span>
<span id="cb23-191"><a href="#cb23-191"></a>                to_emails<span class="op">=</span>to_list,</span>
<span id="cb23-192"><a href="#cb23-192"></a>                subject<span class="op">=</span>subject,</span>
<span id="cb23-193"><a href="#cb23-193"></a>                body_text<span class="op">=</span>body_text,</span>
<span id="cb23-194"><a href="#cb23-194"></a>                attachments<span class="op">=</span>attachments</span>
<span id="cb23-195"><a href="#cb23-195"></a>            )</span>
<span id="cb23-196"><a href="#cb23-196"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb23-197"><a href="#cb23-197"></a>            logging.error(<span class="ss">f"Failed to send email: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-198"><a href="#cb23-198"></a>            <span class="bu">print</span>(<span class="ss">f"[ERROR] Could not send email: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-199"><a href="#cb23-199"></a></span>
<span id="cb23-200"><a href="#cb23-200"></a>    end_time <span class="op">=</span> time.time()</span>
<span id="cb23-201"><a href="#cb23-201"></a>    elapsed_sec <span class="op">=</span> end_time <span class="op">-</span> start_time</span>
<span id="cb23-202"><a href="#cb23-202"></a>    logging.info(<span class="ss">f"Finished full_crime_report in </span><span class="sc">{</span>elapsed_sec<span class="sc">:.2f}</span><span class="ss"> seconds."</span>)</span>
<span id="cb23-203"><a href="#cb23-203"></a>    <span class="bu">print</span>(<span class="ss">f"Finished full_crime_report in </span><span class="sc">{</span>elapsed_sec<span class="sc">:.2f}</span><span class="ss"> seconds."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p><strong>Explanation</strong>:</p>
<ul>
<li><p><strong>Pipeline Steps</strong>:</p>
<ol type="1">
<li><p><strong>Environment Variables</strong>: Loads necessary configurations like API keys and GitHub repository paths.</p></li>
<li><p><strong>Data Loading</strong>: Retrieves the complete set of crime data from <code>summary_report.zip</code>.</p></li>
<li><p><strong>Data Filtering</strong>: Selects records from the past seven days to focus the weekly report.</p></li>
<li><p><strong>CSV Generation</strong>: Exports the filtered data to a CSV file for easy access and dissemination.</p></li>
<li><p><strong>Map Creation</strong>:</p>
<ul>
<li><p><strong>Weekly Map</strong>: Generates an interactive map highlighting crimes from the past week.</p></li>
<li><p><strong>Cumulative Map</strong>: Generates a comprehensive map showcasing all recorded crimes.</p></li>
</ul></li>
<li><p><strong>GitHub Upload</strong>: Pushes the newly generated HTML maps and CSV reports to designated GitHub repository subfolders.</p></li>
<li><p><strong>Email Preparation and Sending</strong>:</p>
<ul>
<li><p><strong>Gmail API Authentication</strong>: Ensures secure access to the Gmail API for sending emails.</p></li>
<li><p><strong>Recipient Loading</strong>: Retrieves the list of subscribers.</p></li>
<li><p><strong>Email Composition</strong>: Crafts an email containing links to the latest reports and attaches the CSV file.</p></li>
<li><p><strong>Email Dispatch</strong>: Sends the email to all subscribers.</p></li>
</ul></li>
<li><p><strong>Logging</strong>: Records the entire process’s execution details, including any errors and execution time.</p></li>
</ol></li>
<li><p><strong>Testing Mode</strong>:</p>
<ul>
<li><strong>Flag</strong>: The <code>test</code> variable allows toggling between testing and production modes. When <code>test = False</code>, the script proceeds with uploading and emailing. This is useful for development and debugging without affecting live data or subscribers.</li>
</ul></li>
<li><p><strong>Error Handling</strong>:</p>
<ul>
<li><strong>Try-Except Blocks</strong>: Enclose critical operations to catch and log exceptions, ensuring the script fails gracefully and provides informative error messages.</li>
</ul></li>
</ul>
</section>
<section id="g.-main-entry-point" class="level5">
<h5 class="anchored" data-anchor-id="g.-main-entry-point"><strong>g. Main Entry Point</strong></h5>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb24"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1"></a><span class="kw">def</span> main():</span>
<span id="cb24-2"><a href="#cb24-2"></a>    <span class="co">"""</span></span>
<span id="cb24-3"><a href="#cb24-3"></a><span class="co">    Simply runs the report generation from the command line; no Streamlit involved.</span></span>
<span id="cb24-4"><a href="#cb24-4"></a><span class="co">    """</span></span>
<span id="cb24-5"><a href="#cb24-5"></a>    main_report_generation()</span>
<span id="cb24-6"><a href="#cb24-6"></a></span>
<span id="cb24-7"><a href="#cb24-7"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb24-8"><a href="#cb24-8"></a>    main()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p><strong>Explanation</strong>:</p>
<ul>
<li><p><strong>Purpose</strong>: Defines the script’s entry point, initiating the entire report generation process when the script is executed.</p></li>
<li><p><strong>Function Call</strong>: Invokes <code>main_report_generation()</code> to start the pipeline.</p></li>
</ul>
</section>
</section>
</section>
<section id="detailed-code-breakdown-2" class="level3">
<h3 class="anchored" data-anchor-id="detailed-code-breakdown-2"><strong>Detailed Code Breakdown</strong></h3>
<p>Let’s delve deeper into specific functions and sections of <code>weekly_crime_report.py</code> to understand their roles and implementations.</p>
<section id="a.-mailchimp-subscribers-fetching" class="level4">
<h4 class="anchored" data-anchor-id="a.-mailchimp-subscribers-fetching"><strong>a. Mailchimp Subscribers Fetching</strong></h4>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb25"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1"></a><span class="kw">def</span> get_mailchimp_subscribers():</span>
<span id="cb25-2"><a href="#cb25-2"></a>    <span class="co">"""</span></span>
<span id="cb25-3"><a href="#cb25-3"></a><span class="co">    Fetches all subscribed members from the Mailchimp audience.</span></span>
<span id="cb25-4"><a href="#cb25-4"></a><span class="co">    Handles pagination to retrieve all subscribers.</span></span>
<span id="cb25-5"><a href="#cb25-5"></a><span class="co">    """</span></span>
<span id="cb25-6"><a href="#cb25-6"></a>    MAILCHIMP_API_KEY <span class="op">=</span> os.getenv(<span class="st">"MAILCHIMP_API_KEY"</span>)</span>
<span id="cb25-7"><a href="#cb25-7"></a>    MAILCHIMP_AUDIENCE_ID <span class="op">=</span> os.getenv(<span class="st">"MAILCHIMP_AUDIENCE_ID"</span>)</span>
<span id="cb25-8"><a href="#cb25-8"></a>    MAILCHIMP_DATA_CENTER <span class="op">=</span> os.getenv(<span class="st">"MAILCHIMP_DATA_CENTER"</span>)  <span class="co"># e.g., 'us1', 'us2'</span></span>
<span id="cb25-9"><a href="#cb25-9"></a></span>
<span id="cb25-10"><a href="#cb25-10"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="bu">all</span>([MAILCHIMP_API_KEY, MAILCHIMP_AUDIENCE_ID, MAILCHIMP_DATA_CENTER]):</span>
<span id="cb25-11"><a href="#cb25-11"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Missing Mailchimp API configuration in environment variables."</span>)</span>
<span id="cb25-12"><a href="#cb25-12"></a></span>
<span id="cb25-13"><a href="#cb25-13"></a>    MAILCHIMP_API_URL <span class="op">=</span> <span class="ss">f"https://</span><span class="sc">{</span>MAILCHIMP_DATA_CENTER<span class="sc">}</span><span class="ss">.api.mailchimp.com/3.0"</span></span>
<span id="cb25-14"><a href="#cb25-14"></a>    endpoint <span class="op">=</span> <span class="ss">f"/lists/</span><span class="sc">{</span>MAILCHIMP_AUDIENCE_ID<span class="sc">}</span><span class="ss">/members"</span></span>
<span id="cb25-15"><a href="#cb25-15"></a>    params <span class="op">=</span> {</span>
<span id="cb25-16"><a href="#cb25-16"></a>        <span class="st">"status"</span>: <span class="st">"subscribed"</span>,</span>
<span id="cb25-17"><a href="#cb25-17"></a>        <span class="st">"count"</span>: <span class="dv">1000</span>,  <span class="co"># Max allowed by Mailchimp</span></span>
<span id="cb25-18"><a href="#cb25-18"></a>        <span class="st">"offset"</span>: <span class="dv">0</span></span>
<span id="cb25-19"><a href="#cb25-19"></a>    }</span>
<span id="cb25-20"><a href="#cb25-20"></a>    subscribers <span class="op">=</span> []</span>
<span id="cb25-21"><a href="#cb25-21"></a></span>
<span id="cb25-22"><a href="#cb25-22"></a>    <span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb25-23"><a href="#cb25-23"></a>        response <span class="op">=</span> requests.get(</span>
<span id="cb25-24"><a href="#cb25-24"></a>            MAILCHIMP_API_URL <span class="op">+</span> endpoint,</span>
<span id="cb25-25"><a href="#cb25-25"></a>            auth<span class="op">=</span>(<span class="st">"anystring"</span>, MAILCHIMP_API_KEY),</span>
<span id="cb25-26"><a href="#cb25-26"></a>            params<span class="op">=</span>params</span>
<span id="cb25-27"><a href="#cb25-27"></a>        )</span>
<span id="cb25-28"><a href="#cb25-28"></a></span>
<span id="cb25-29"><a href="#cb25-29"></a>        <span class="cf">if</span> response.status_code <span class="op">!=</span> <span class="dv">200</span>:</span>
<span id="cb25-30"><a href="#cb25-30"></a>            logging.error(<span class="ss">f"Failed to fetch subscribers: </span><span class="sc">{</span>response<span class="sc">.</span>status_code<span class="sc">}</span><span class="ss"> - </span><span class="sc">{</span>response<span class="sc">.</span>text<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb25-31"><a href="#cb25-31"></a>            <span class="cf">raise</span> <span class="pp">Exception</span>(<span class="ss">f"Mailchimp API Error: </span><span class="sc">{</span>response<span class="sc">.</span>status_code<span class="sc">}</span><span class="ss"> - </span><span class="sc">{</span>response<span class="sc">.</span>text<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb25-32"><a href="#cb25-32"></a></span>
<span id="cb25-33"><a href="#cb25-33"></a>        data <span class="op">=</span> response.json()</span>
<span id="cb25-34"><a href="#cb25-34"></a>        members <span class="op">=</span> data.get(<span class="st">'members'</span>, [])</span>
<span id="cb25-35"><a href="#cb25-35"></a>        subscribers.extend([member[<span class="st">'email_address'</span>] <span class="cf">for</span> member <span class="kw">in</span> members])</span>
<span id="cb25-36"><a href="#cb25-36"></a></span>
<span id="cb25-37"><a href="#cb25-37"></a>        total_items <span class="op">=</span> data.get(<span class="st">'total_items'</span>, <span class="dv">0</span>)</span>
<span id="cb25-38"><a href="#cb25-38"></a>        <span class="cf">if</span> <span class="bu">len</span>(subscribers) <span class="op">&gt;=</span> total_items:</span>
<span id="cb25-39"><a href="#cb25-39"></a>            <span class="cf">break</span></span>
<span id="cb25-40"><a href="#cb25-40"></a>        params[<span class="st">'offset'</span>] <span class="op">+=</span> params[<span class="st">'count'</span>]</span>
<span id="cb25-41"><a href="#cb25-41"></a>        time.sleep(<span class="dv">1</span>)  <span class="co"># To respect API rate limits</span></span>
<span id="cb25-42"><a href="#cb25-42"></a></span>
<span id="cb25-43"><a href="#cb25-43"></a>    logging.info(<span class="ss">f"Fetched </span><span class="sc">{</span><span class="bu">len</span>(subscribers)<span class="sc">}</span><span class="ss"> subscribers from Mailchimp."</span>)</span>
<span id="cb25-44"><a href="#cb25-44"></a>    <span class="cf">return</span> subscribers</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p><strong>Explanation</strong>:</p>
<ul>
<li><p><strong>Purpose</strong>: Retrieves all email subscribers from the specified Mailchimp audience list.</p></li>
<li><p><strong>Process</strong>:</p>
<ol type="1">
<li><p><strong>API Configuration</strong>: Fetches Mailchimp API credentials from environment variables.</p></li>
<li><p><strong>Pagination Handling</strong>: Mailchimp’s API returns a maximum of 1,000 subscribers per request. This function loops through pages until all subscribers are retrieved.</p></li>
<li><p><strong>API Requests</strong>: Sends GET requests to the Mailchimp API, authenticating with the API key.</p></li>
<li><p><strong>Data Extraction</strong>: Extracts email addresses from the response and appends them to the <code>subscribers</code> list.</p></li>
<li><p><strong>Rate Limiting</strong>: Introduces a 1-second pause between requests to comply with Mailchimp’s rate limits.</p></li>
</ol></li>
<li><p><strong>Error Handling</strong>: Logs and raises exceptions for failed API requests.</p></li>
</ul>
<p><strong>Usage</strong>: This function ensures that the email dissemination process targets all current subscribers, keeping them updated with the latest crime reports.</p>
</section>
<section id="b.-date-range-determination" class="level4">
<h4 class="anchored" data-anchor-id="b.-date-range-determination"><strong>b. Date Range Determination</strong></h4>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb26"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1"></a><span class="kw">def</span> determine_date_range(df, execution_date):</span>
<span id="cb26-2"><a href="#cb26-2"></a>    <span class="co">"""</span></span>
<span id="cb26-3"><a href="#cb26-3"></a><span class="co">    Determines the date range for the report based on the execution_date (7 days).</span></span>
<span id="cb26-4"><a href="#cb26-4"></a><span class="co">    """</span></span>
<span id="cb26-5"><a href="#cb26-5"></a>    df[<span class="st">'Date'</span>] <span class="op">=</span> pd.to_datetime(df[<span class="st">'Date'</span>], errors<span class="op">=</span><span class="st">'coerce'</span>)</span>
<span id="cb26-6"><a href="#cb26-6"></a>    df_valid <span class="op">=</span> df[df[<span class="st">'Date'</span>].notna()].copy()</span>
<span id="cb26-7"><a href="#cb26-7"></a>    <span class="cf">if</span> df_valid.empty:</span>
<span id="cb26-8"><a href="#cb26-8"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"No valid dates found in the data."</span>)</span>
<span id="cb26-9"><a href="#cb26-9"></a></span>
<span id="cb26-10"><a href="#cb26-10"></a>    latest_date <span class="op">=</span> df_valid[df_valid[<span class="st">'Date'</span>].dt.date <span class="op">&lt;=</span> execution_date][<span class="st">'Date'</span>].<span class="bu">max</span>().date()</span>
<span id="cb26-11"><a href="#cb26-11"></a>    <span class="cf">if</span> pd.isna(latest_date):</span>
<span id="cb26-12"><a href="#cb26-12"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"No records found on or before today's date."</span>)</span>
<span id="cb26-13"><a href="#cb26-13"></a></span>
<span id="cb26-14"><a href="#cb26-14"></a>    <span class="co"># last 7 days</span></span>
<span id="cb26-15"><a href="#cb26-15"></a>    end_date <span class="op">=</span> latest_date</span>
<span id="cb26-16"><a href="#cb26-16"></a>    start_date <span class="op">=</span> end_date <span class="op">-</span> timedelta(days<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb26-17"><a href="#cb26-17"></a></span>
<span id="cb26-18"><a href="#cb26-18"></a>    <span class="cf">return</span> start_date, end_date</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p><strong>Explanation</strong>:</p>
<ul>
<li><p><strong>Purpose</strong>: Establishes the start and end dates for the weekly report based on the current execution date.</p></li>
<li><p><strong>Logic</strong>:</p>
<ol type="1">
<li><p><strong>Date Conversion</strong>: Ensures that the ‘Date’ column is in datetime format, removing invalid entries.</p></li>
<li><p><strong>Latest Date Identification</strong>: Finds the most recent date in the dataset that is on or before the execution date.</p></li>
<li><p><strong>Date Range Calculation</strong>: Sets the end date as the latest date and the start date as six days prior, encompassing a full week.</p></li>
</ol></li>
<li><p><strong>Error Handling</strong>: Raises exceptions if no valid dates are found or if no records exist up to the execution date.</p></li>
</ul>
<p><strong>Usage</strong>: This function ensures that the weekly report accurately reflects the most recent week’s data, maintaining the report’s relevance and timeliness.</p>
</section>
<section id="c.-crime-data-filtering" class="level4">
<h4 class="anchored" data-anchor-id="c.-crime-data-filtering"><strong>c.&nbsp;Crime Data Filtering</strong></h4>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb27"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1"></a><span class="kw">def</span> filter_crime_data(df, start_date, end_date):</span>
<span id="cb27-2"><a href="#cb27-2"></a>    <span class="co">"""</span></span>
<span id="cb27-3"><a href="#cb27-3"></a><span class="co">    Filters the DataFrame to entries between start_date and end_date, inclusive.</span></span>
<span id="cb27-4"><a href="#cb27-4"></a><span class="co">    """</span></span>
<span id="cb27-5"><a href="#cb27-5"></a>    start_dt <span class="op">=</span> pd.to_datetime(start_date)</span>
<span id="cb27-6"><a href="#cb27-6"></a>    end_dt   <span class="op">=</span> pd.to_datetime(end_date) <span class="op">+</span> timedelta(days<span class="op">=</span><span class="dv">1</span>) <span class="op">-</span> timedelta(seconds<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb27-7"><a href="#cb27-7"></a>    mask <span class="op">=</span> (df[<span class="st">'Date'</span>] <span class="op">&gt;=</span> start_dt) <span class="op">&amp;</span> (df[<span class="st">'Date'</span>] <span class="op">&lt;=</span> end_dt)</span>
<span id="cb27-8"><a href="#cb27-8"></a>    <span class="cf">return</span> df.loc[mask].copy()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p><strong>Explanation</strong>:</p>
<ul>
<li><p><strong>Purpose</strong>: Selects crime records that fall within the specified date range.</p></li>
<li><p><strong>Process</strong>:</p>
<ul>
<li><p><strong>Date Conversion</strong>: Converts <code>start_date</code> and <code>end_date</code> to datetime objects.</p></li>
<li><p><strong>Mask Creation</strong>: Creates a boolean mask to filter records where the ‘Date’ falls within the range.</p></li>
<li><p><strong>Data Selection</strong>: Applies the mask to the DataFrame and returns a copy of the filtered data.</p></li>
</ul></li>
</ul>
<p><strong>Usage</strong>: This function isolates the relevant crime data for the weekly report, ensuring that only pertinent records are included in the generated maps and CSV reports.</p>
</section>
<section id="d.-crime-data-loading" class="level4">
<h4 class="anchored" data-anchor-id="d.-crime-data-loading"><strong>d.&nbsp;Crime Data Loading</strong></h4>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb28"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1"></a><span class="kw">def</span> load_all_crimes(zip_file_path):</span>
<span id="cb28-2"><a href="#cb28-2"></a>    <span class="co">"""</span></span>
<span id="cb28-3"><a href="#cb28-3"></a><span class="co">    Reads summary_report.zip containing your full crime data (summary_report.csv).</span></span>
<span id="cb28-4"><a href="#cb28-4"></a><span class="co">    """</span></span>
<span id="cb28-5"><a href="#cb28-5"></a>    <span class="cf">if</span> <span class="kw">not</span> zip_file_path.exists():</span>
<span id="cb28-6"><a href="#cb28-6"></a>        <span class="cf">raise</span> <span class="pp">FileNotFoundError</span>(<span class="ss">f"Could not find zip file '</span><span class="sc">{</span>zip_file_path<span class="sc">}</span><span class="ss">'"</span>)</span>
<span id="cb28-7"><a href="#cb28-7"></a></span>
<span id="cb28-8"><a href="#cb28-8"></a>    <span class="cf">with</span> zipfile.ZipFile(zip_file_path, <span class="st">'r'</span>) <span class="im">as</span> z:</span>
<span id="cb28-9"><a href="#cb28-9"></a>        <span class="cf">with</span> z.<span class="bu">open</span>(<span class="st">'summary_report.csv'</span>) <span class="im">as</span> csvfile:</span>
<span id="cb28-10"><a href="#cb28-10"></a>            df <span class="op">=</span> pd.read_csv(csvfile, encoding<span class="op">=</span><span class="st">'cp1252'</span>, on_bad_lines<span class="op">=</span><span class="st">'skip'</span>)</span>
<span id="cb28-11"><a href="#cb28-11"></a></span>
<span id="cb28-12"><a href="#cb28-12"></a>    df[<span class="st">'Date'</span>] <span class="op">=</span> pd.to_datetime(df[<span class="st">'Date'</span>], errors<span class="op">=</span><span class="st">'coerce'</span>)</span>
<span id="cb28-13"><a href="#cb28-13"></a>    df <span class="op">=</span> df[df[<span class="st">'Date'</span>].notna()]</span>
<span id="cb28-14"><a href="#cb28-14"></a>    df.sort_values(by<span class="op">=</span><span class="st">'Date'</span>, ascending<span class="op">=</span><span class="va">False</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb28-15"><a href="#cb28-15"></a>    <span class="cf">return</span> df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p><strong>Explanation</strong>:</p>
<ul>
<li><p><strong>Purpose</strong>: Loads the complete set of crime data from a compressed ZIP file containing <code>summary_report.csv</code>.</p></li>
<li><p><strong>Process</strong>:</p>
<ol type="1">
<li><p><strong>ZIP Extraction</strong>: Opens the ZIP file and extracts the CSV file.</p></li>
<li><p><strong>CSV Reading</strong>: Reads the CSV data into a Pandas DataFrame, skipping bad lines to ensure data integrity.</p></li>
<li><p><strong>Date Validation</strong>: Converts the ‘Date’ column to datetime format and removes records with invalid dates.</p></li>
<li><p><strong>Data Sorting</strong>: Sorts the DataFrame in descending order based on the ‘Date’ to prioritize recent records.</p></li>
</ol></li>
<li><p><strong>Error Handling</strong>: Raises a <code>FileNotFoundError</code> if the ZIP file does not exist.</p></li>
</ul>
<p><strong>Usage</strong>: This function provides a reliable method to access the entire crime dataset, forming the basis for generating both weekly and cumulative reports.</p>
</section>
<section id="e.-safe-field-handling" class="level4">
<h4 class="anchored" data-anchor-id="e.-safe-field-handling"><strong>e. Safe Field Handling</strong></h4>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb29"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1"></a><span class="kw">def</span> safe_field(value):</span>
<span id="cb29-2"><a href="#cb29-2"></a>    <span class="co">"""</span></span>
<span id="cb29-3"><a href="#cb29-3"></a><span class="co">    Return the string version of a field or 'Not found' if it's missing/NaN/empty.</span></span>
<span id="cb29-4"><a href="#cb29-4"></a><span class="co">    """</span></span>
<span id="cb29-5"><a href="#cb29-5"></a>    <span class="cf">if</span> pd.isnull(value) <span class="kw">or</span> value <span class="op">==</span> <span class="st">""</span>:</span>
<span id="cb29-6"><a href="#cb29-6"></a>        <span class="cf">return</span> <span class="st">"Not found"</span></span>
<span id="cb29-7"><a href="#cb29-7"></a>    <span class="cf">return</span> <span class="bu">str</span>(value)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p><strong>Explanation</strong>:</p>
<ul>
<li><strong>Purpose</strong>: Ensures that all fields included in the reports are present and readable. If a field is missing (<code>NaN</code>) or empty, it returns “Not found” to maintain consistency in the reports.</li>
</ul>
</section>
<section id="f.-cumulative-map-creation" class="level4">
<h4 class="anchored" data-anchor-id="f.-cumulative-map-creation"><strong>f.&nbsp;Cumulative Map Creation</strong></h4>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb30"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1"></a><span class="kw">def</span> create_folium_map_cumulative(</span>
<span id="cb30-2"><a href="#cb30-2"></a>    df,</span>
<span id="cb30-3"><a href="#cb30-3"></a>    lat_col<span class="op">=</span><span class="st">'Lat'</span>,</span>
<span id="cb30-4"><a href="#cb30-4"></a>    lng_col<span class="op">=</span><span class="st">'Long'</span>,</span>
<span id="cb30-5"><a href="#cb30-5"></a>    offense_col<span class="op">=</span><span class="st">'Offense'</span>,</span>
<span id="cb30-6"><a href="#cb30-6"></a>    date_col<span class="op">=</span><span class="st">'Date'</span>,</span>
<span id="cb30-7"><a href="#cb30-7"></a>    output_html_path<span class="op">=</span><span class="st">'cumulative_map.html'</span></span>
<span id="cb30-8"><a href="#cb30-8"></a>):</span>
<span id="cb30-9"><a href="#cb30-9"></a>    <span class="co">"""</span></span>
<span id="cb30-10"><a href="#cb30-10"></a><span class="co">    Creates a Folium map plotting all records in df up to a certain date with disclaimers overlay (JS + HTML) </span></span>
<span id="cb30-11"><a href="#cb30-11"></a><span class="co">    and saves it to 'output_html_path'.</span></span>
<span id="cb30-12"><a href="#cb30-12"></a><span class="co">    """</span></span>
<span id="cb30-13"><a href="#cb30-13"></a>    oak_park_center <span class="op">=</span> [<span class="fl">41.885</span>, <span class="op">-</span><span class="fl">87.78</span>]</span>
<span id="cb30-14"><a href="#cb30-14"></a>    crime_map <span class="op">=</span> folium.Map(location<span class="op">=</span>oak_park_center, zoom_start<span class="op">=</span><span class="dv">11</span>)  <span class="co"># Zoomed out for cumulative view</span></span>
<span id="cb30-15"><a href="#cb30-15"></a></span>
<span id="cb30-16"><a href="#cb30-16"></a>    marker_cluster <span class="op">=</span> MarkerCluster().add_to(crime_map)</span>
<span id="cb30-17"><a href="#cb30-17"></a>    <span class="co"># Define the static part of the base URL</span></span>
<span id="cb30-18"><a href="#cb30-18"></a>    base_url_static <span class="op">=</span> <span class="st">'https://www.oak-park.us/sites/default/files/police/summaries/'</span></span>
<span id="cb30-19"><a href="#cb30-19"></a></span>
<span id="cb30-20"><a href="#cb30-20"></a>    <span class="cf">for</span> _, row <span class="kw">in</span> df.iterrows():</span>
<span id="cb30-21"><a href="#cb30-21"></a>        lat <span class="op">=</span> row[lat_col]</span>
<span id="cb30-22"><a href="#cb30-22"></a>        lng <span class="op">=</span> row[lng_col]</span>
<span id="cb30-23"><a href="#cb30-23"></a>        offense <span class="op">=</span> row.get(offense_col, <span class="st">"Unknown"</span>)</span>
<span id="cb30-24"><a href="#cb30-24"></a>        complaint <span class="op">=</span> safe_field(row.get(<span class="st">'Complaint #'</span>))</span>
<span id="cb30-25"><a href="#cb30-25"></a>        offense_val <span class="op">=</span> safe_field(offense)</span>
<span id="cb30-26"><a href="#cb30-26"></a>        date_str <span class="op">=</span> safe_field(row[<span class="st">'Date'</span>].strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>) <span class="cf">if</span> pd.notnull(row[<span class="st">'Date'</span>]) <span class="cf">else</span> np.nan)</span>
<span id="cb30-27"><a href="#cb30-27"></a>        time_val <span class="op">=</span> safe_field(row.get(<span class="st">'Time'</span>))</span>
<span id="cb30-28"><a href="#cb30-28"></a>        location <span class="op">=</span> safe_field(row.get(<span class="st">'Location'</span>))</span>
<span id="cb30-29"><a href="#cb30-29"></a>        victim <span class="op">=</span> safe_field(row.get(<span class="st">'Victim/Address'</span>))</span>
<span id="cb30-30"><a href="#cb30-30"></a>        narrative <span class="op">=</span> safe_field(row.get(<span class="st">'Narrative'</span>))</span>
<span id="cb30-31"><a href="#cb30-31"></a>        filename <span class="op">=</span> safe_field(row.get(<span class="st">'File Name'</span>))</span>
<span id="cb30-32"><a href="#cb30-32"></a></span>
<span id="cb30-33"><a href="#cb30-33"></a>        popup_html <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb30-34"><a href="#cb30-34"></a><span class="ss">            &lt;b&gt;Complaint #:&lt;/b&gt; </span><span class="sc">{</span>complaint<span class="sc">}</span><span class="ss">&lt;br/&gt;</span></span>
<span id="cb30-35"><a href="#cb30-35"></a><span class="ss">            &lt;b&gt;Offense:&lt;/b&gt; </span><span class="sc">{</span>offense_val<span class="sc">}</span><span class="ss">&lt;br/&gt;</span></span>
<span id="cb30-36"><a href="#cb30-36"></a><span class="ss">            &lt;b&gt;Date:&lt;/b&gt; </span><span class="sc">{</span>date_str<span class="sc">}</span><span class="ss">&lt;br/&gt;</span></span>
<span id="cb30-37"><a href="#cb30-37"></a><span class="ss">            &lt;details&gt;</span></span>
<span id="cb30-38"><a href="#cb30-38"></a><span class="ss">              &lt;summary&gt;&lt;b&gt;View Details&lt;/b&gt;&lt;/summary&gt;</span></span>
<span id="cb30-39"><a href="#cb30-39"></a><span class="ss">              &lt;b&gt;Time:&lt;/b&gt; </span><span class="sc">{</span>time_val<span class="sc">}</span><span class="ss">&lt;br/&gt;</span></span>
<span id="cb30-40"><a href="#cb30-40"></a><span class="ss">              &lt;b&gt;Location:&lt;/b&gt; </span><span class="sc">{</span>location<span class="sc">}</span><span class="ss">&lt;br/&gt;</span></span>
<span id="cb30-41"><a href="#cb30-41"></a><span class="ss">              &lt;b&gt;Victim:&lt;/b&gt; </span><span class="sc">{</span>victim<span class="sc">}</span><span class="ss">&lt;br/&gt;</span></span>
<span id="cb30-42"><a href="#cb30-42"></a><span class="ss">              &lt;b&gt;Narrative:&lt;/b&gt; </span><span class="sc">{</span>narrative<span class="sc">}</span><span class="ss">&lt;br/&gt;</span></span>
<span id="cb30-43"><a href="#cb30-43"></a><span class="ss">              &lt;b&gt;URL:&lt;/b&gt; &lt;a href="</span><span class="sc">{</span>filename<span class="sc">}</span><span class="ss">" target="_blank"&gt;PDF Link&lt;/a&gt;</span></span>
<span id="cb30-44"><a href="#cb30-44"></a><span class="ss">            &lt;/details&gt;</span></span>
<span id="cb30-45"><a href="#cb30-45"></a><span class="ss">        """</span></span>
<span id="cb30-46"><a href="#cb30-46"></a></span>
<span id="cb30-47"><a href="#cb30-47"></a>        folium.Marker(</span>
<span id="cb30-48"><a href="#cb30-48"></a>            location<span class="op">=</span>[lat, lng],</span>
<span id="cb30-49"><a href="#cb30-49"></a>            popup<span class="op">=</span>folium.Popup(popup_html, max_width<span class="op">=</span><span class="dv">300</span>),</span>
<span id="cb30-50"><a href="#cb30-50"></a>            icon<span class="op">=</span>folium.Icon(color<span class="op">=</span><span class="st">'blue'</span>, icon<span class="op">=</span><span class="st">'info-sign'</span>)  <span class="co"># Different color for distinction</span></span>
<span id="cb30-51"><a href="#cb30-51"></a>        ).add_to(marker_cluster)</span>
<span id="cb30-52"><a href="#cb30-52"></a></span>
<span id="cb30-53"><a href="#cb30-53"></a>    <span class="co"># Basic map title</span></span>
<span id="cb30-54"><a href="#cb30-54"></a>    title_html <span class="op">=</span> <span class="st">'''</span></span>
<span id="cb30-55"><a href="#cb30-55"></a><span class="st">    &lt;h3 align="center" style="font-size:20px"&gt;&lt;b&gt;Oak Park Cumulative Crime Map&lt;/b&gt;&lt;/h3&gt;</span></span>
<span id="cb30-56"><a href="#cb30-56"></a><span class="st">    &lt;br&gt;</span></span>
<span id="cb30-57"><a href="#cb30-57"></a><span class="st">    &lt;h3 align="center" style="font-size:10px"&gt;</span></span>
<span id="cb30-58"><a href="#cb30-58"></a><span class="st">    &lt;a href="https://jesse-anderson.net/"&gt;My Portfolio&lt;/a&gt; |</span></span>
<span id="cb30-59"><a href="#cb30-59"></a><span class="st">    &lt;a href="https://blog.jesse-anderson.net/"&gt;My Blog&lt;/a&gt; |</span></span>
<span id="cb30-60"><a href="#cb30-60"></a><span class="st">    &lt;a href="https://blog.jesse-anderson.net/"&gt;Documentation&lt;/a&gt; |</span></span>
<span id="cb30-61"><a href="#cb30-61"></a><span class="st">    &lt;a href="mailto:jesse@jesse-anderson.net"&gt;Contact&lt;/a&gt; |</span></span>
<span id="cb30-62"><a href="#cb30-62"></a><span class="st">    &lt;a href="https://forms.gle/GnyaVwo1Vzm8nBH6A"&gt;</span></span>
<span id="cb30-63"><a href="#cb30-63"></a><span class="st">        Add me to Weekly Updates</span></span>
<span id="cb30-64"><a href="#cb30-64"></a><span class="st">    &lt;/a&gt;</span></span>
<span id="cb30-65"><a href="#cb30-65"></a><span class="st">    &lt;/h3&gt;</span></span>
<span id="cb30-66"><a href="#cb30-66"></a><span class="st">'''</span></span>
<span id="cb30-67"><a href="#cb30-67"></a>    crime_map.get_root().html.add_child(folium.Element(title_html))</span>
<span id="cb30-68"><a href="#cb30-68"></a></span>
<span id="cb30-69"><a href="#cb30-69"></a>    <span class="co"># Overlays disclaimers in a "splash screen" with JavaScript (reuse existing disclaimer)</span></span>
<span id="cb30-70"><a href="#cb30-70"></a>    disclaimers_overlay <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb30-71"><a href="#cb30-71"></a><span class="st">    &lt;style&gt;</span></span>
<span id="cb30-72"><a href="#cb30-72"></a><span class="st">    /* Full-page overlay styling */</span></span>
<span id="cb30-73"><a href="#cb30-73"></a><span class="st">    #disclaimerOverlay {</span></span>
<span id="cb30-74"><a href="#cb30-74"></a><span class="st">      position: fixed;</span></span>
<span id="cb30-75"><a href="#cb30-75"></a><span class="st">      z-index: 9999; /* On top of everything */</span></span>
<span id="cb30-76"><a href="#cb30-76"></a><span class="st">      left: 0;</span></span>
<span id="cb30-77"><a href="#cb30-77"></a><span class="st">      top: 0;</span></span>
<span id="cb30-78"><a href="#cb30-78"></a><span class="st">      width: 100%;</span></span>
<span id="cb30-79"><a href="#cb30-79"></a><span class="st">      height: 100%;</span></span>
<span id="cb30-80"><a href="#cb30-80"></a><span class="st">      background-color: rgba(255, 255, 255, 0.95);</span></span>
<span id="cb30-81"><a href="#cb30-81"></a><span class="st">      color: #333;</span></span>
<span id="cb30-82"><a href="#cb30-82"></a><span class="st">      display: block; /* Visible by default */</span></span>
<span id="cb30-83"><a href="#cb30-83"></a><span class="st">      overflow: auto;</span></span>
<span id="cb30-84"><a href="#cb30-84"></a><span class="st">      text-align: center;</span></span>
<span id="cb30-85"><a href="#cb30-85"></a><span class="st">      padding-top: 100px;</span></span>
<span id="cb30-86"><a href="#cb30-86"></a><span class="st">      font-family: Arial, sans-serif;</span></span>
<span id="cb30-87"><a href="#cb30-87"></a><span class="st">    }</span></span>
<span id="cb30-88"><a href="#cb30-88"></a><span class="st">    #disclaimerContent {</span></span>
<span id="cb30-89"><a href="#cb30-89"></a><span class="st">      background: #f9f9f9;</span></span>
<span id="cb30-90"><a href="#cb30-90"></a><span class="st">      border: 1px solid #ccc;</span></span>
<span id="cb30-91"><a href="#cb30-91"></a><span class="st">      display: inline-block;</span></span>
<span id="cb30-92"><a href="#cb30-92"></a><span class="st">      padding: 20px;</span></span>
<span id="cb30-93"><a href="#cb30-93"></a><span class="st">      max-width: 800px;</span></span>
<span id="cb30-94"><a href="#cb30-94"></a><span class="st">      text-align: left;</span></span>
<span id="cb30-95"><a href="#cb30-95"></a><span class="st">    }</span></span>
<span id="cb30-96"><a href="#cb30-96"></a><span class="st">    #acceptButton {</span></span>
<span id="cb30-97"><a href="#cb30-97"></a><span class="st">      margin-top: 20px;</span></span>
<span id="cb30-98"><a href="#cb30-98"></a><span class="st">      padding: 10px 20px;</span></span>
<span id="cb30-99"><a href="#cb30-99"></a><span class="st">      font-size: 16px;</span></span>
<span id="cb30-100"><a href="#cb30-100"></a><span class="st">      cursor: pointer;</span></span>
<span id="cb30-101"><a href="#cb30-101"></a><span class="st">    }</span></span>
<span id="cb30-102"><a href="#cb30-102"></a><span class="st">    &lt;/style&gt;</span></span>
<span id="cb30-103"><a href="#cb30-103"></a></span>
<span id="cb30-104"><a href="#cb30-104"></a><span class="st">    &lt;div id="disclaimerOverlay"&gt;</span></span>
<span id="cb30-105"><a href="#cb30-105"></a><span class="st">      &lt;div id="disclaimerContent"&gt;</span></span>
<span id="cb30-106"><a href="#cb30-106"></a><span class="st">        &lt;h2&gt;Important Legal Disclaimer&lt;/h2&gt;</span></span>
<span id="cb30-107"><a href="#cb30-107"></a><span class="st">        &lt;p&gt;&lt;strong&gt;By using this demonstrative research tool, you acknowledge and agree:&lt;/strong&gt;&lt;/p&gt;</span></span>
<span id="cb30-108"><a href="#cb30-108"></a><span class="st">        &lt;ul&gt;</span></span>
<span id="cb30-109"><a href="#cb30-109"></a><span class="st">            &lt;li&gt;This tool is for &lt;strong&gt;demonstration purposes only&lt;/strong&gt;.&lt;/li&gt;</span></span>
<span id="cb30-110"><a href="#cb30-110"></a><span class="st">            &lt;li&gt;The data originated from publicly available Oak Park Police Department PDF files.</span></span>
<span id="cb30-111"><a href="#cb30-111"></a><span class="st">                View the official site here: </span></span>
<span id="cb30-112"><a href="#cb30-112"></a><span class="st">                &lt;a href="https://www.oak-park.us/village-services/police-department"</span></span>
<span id="cb30-113"><a href="#cb30-113"></a><span class="st">                   target="_blank"&gt;Oak Park Police Department&lt;/a&gt;.&lt;/li&gt;</span></span>
<span id="cb30-114"><a href="#cb30-114"></a><span class="st">            &lt;li&gt;During parsing, &lt;strong&gt;~10%&lt;/strong&gt; of complaints were &lt;strong&gt;omitted&lt;/strong&gt; </span></span>
<span id="cb30-115"><a href="#cb30-115"></a><span class="st">                due to parsing issues; thus the data is &lt;strong&gt;incomplete&lt;/strong&gt;.&lt;/li&gt;</span></span>
<span id="cb30-116"><a href="#cb30-116"></a><span class="st">            &lt;li&gt;The &lt;strong&gt;official&lt;/strong&gt; and &lt;strong&gt;complete&lt;/strong&gt; PDF files remain </span></span>
<span id="cb30-117"><a href="#cb30-117"></a><span class="st">                with the Oak Park Police Department.&lt;/li&gt;</span></span>
<span id="cb30-118"><a href="#cb30-118"></a><span class="st">            &lt;li&gt;You &lt;strong&gt;will not hold&lt;/strong&gt; the author &lt;strong&gt;liable&lt;/strong&gt; for &lt;strong&gt;any&lt;/strong&gt; </span></span>
<span id="cb30-119"><a href="#cb30-119"></a><span class="st">                decisions—formal or informal—based on this tool.&lt;/li&gt;</span></span>
<span id="cb30-120"><a href="#cb30-120"></a><span class="st">            &lt;li&gt;This tool &lt;strong&gt;should not&lt;/strong&gt; be used in &lt;strong&gt;any&lt;/strong&gt; official or unofficial </span></span>
<span id="cb30-121"><a href="#cb30-121"></a><span class="st">                &lt;strong&gt;decision-making&lt;/strong&gt;.&lt;/li&gt;</span></span>
<span id="cb30-122"><a href="#cb30-122"></a><span class="st">        &lt;/ul&gt;</span></span>
<span id="cb30-123"><a href="#cb30-123"></a><span class="st">        &lt;p&gt;&lt;strong&gt;By continuing, you indicate your acceptance of these terms </span></span>
<span id="cb30-124"><a href="#cb30-124"></a><span class="st">           and disclaim all liability.&lt;/strong&gt;&lt;/p&gt;</span></span>
<span id="cb30-125"><a href="#cb30-125"></a><span class="st">        &lt;hr/&gt;</span></span>
<span id="cb30-126"><a href="#cb30-126"></a><span class="st">        &lt;button id="acceptButton" onclick="hideOverlay()"&gt;I Accept&lt;/button&gt;</span></span>
<span id="cb30-127"><a href="#cb30-127"></a><span class="st">      &lt;/div&gt;</span></span>
<span id="cb30-128"><a href="#cb30-128"></a><span class="st">    &lt;/div&gt;</span></span>
<span id="cb30-129"><a href="#cb30-129"></a></span>
<span id="cb30-130"><a href="#cb30-130"></a><span class="st">    &lt;script&gt;</span></span>
<span id="cb30-131"><a href="#cb30-131"></a><span class="st">    function hideOverlay() {</span></span>
<span id="cb30-132"><a href="#cb30-132"></a><span class="st">      var overlay = document.getElementById('disclaimerOverlay');</span></span>
<span id="cb30-133"><a href="#cb30-133"></a><span class="st">      overlay.style.display = 'none'; </span></span>
<span id="cb30-134"><a href="#cb30-134"></a><span class="st">    }</span></span>
<span id="cb30-135"><a href="#cb30-135"></a><span class="st">    &lt;/script&gt;</span></span>
<span id="cb30-136"><a href="#cb30-136"></a><span class="st">    """</span></span>
<span id="cb30-137"><a href="#cb30-137"></a></span>
<span id="cb30-138"><a href="#cb30-138"></a>    disclaimers_element <span class="op">=</span> folium.Element(disclaimers_overlay)</span>
<span id="cb30-139"><a href="#cb30-139"></a>    crime_map.get_root().html.add_child(disclaimers_element)</span>
<span id="cb30-140"><a href="#cb30-140"></a></span>
<span id="cb30-141"><a href="#cb30-141"></a>    <span class="co"># Save final HTML</span></span>
<span id="cb30-142"><a href="#cb30-142"></a>    crime_map.save(<span class="bu">str</span>(output_html_path))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p><strong>Explanation</strong>:</p>
<ul>
<li><p><strong>Map Initialization</strong>:</p>
<ul>
<li><strong>Centering</strong>: Centers the Folium map on Oak Park’s geographical coordinates with a zoom level of 11 for a broader view in the cumulative map.</li>
</ul></li>
<li><p><strong>Marker Creation</strong>:</p>
<ul>
<li><p><strong>Customization</strong>: Each crime incident is represented by a blue marker with an info-sign icon for distinction from the weekly map’s red markers.</p></li>
<li><p><strong>Popups</strong>: Similar to the weekly map, but tailored for cumulative data.</p></li>
</ul></li>
<li><p><strong>Title Addition</strong>:</p>
<ul>
<li><strong>HTML Styling</strong>: Adds a title and navigation links directly onto the Folium map using HTML and inline CSS.</li>
</ul></li>
<li><p><strong>Disclaimer Overlay</strong>:</p>
<ul>
<li><strong>Reuse</strong>: Reuses the same disclaimer overlay mechanism as in the weekly map to ensure consistency.</li>
</ul></li>
<li><p><strong>Map Saving</strong>:</p>
<ul>
<li><strong>Output</strong>: Saves the generated cumulative map with overlays to the specified HTML file path.</li>
</ul></li>
</ul>
</section>
<section id="g.-gmail-api-service-setup" class="level4">
<h4 class="anchored" data-anchor-id="g.-gmail-api-service-setup"><strong>g. Gmail API Service Setup</strong></h4>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb31"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1"></a><span class="kw">def</span> get_gmail_service():</span>
<span id="cb31-2"><a href="#cb31-2"></a>    <span class="co">"""</span></span>
<span id="cb31-3"><a href="#cb31-3"></a><span class="co">    Authenticates the user and returns the Gmail API service.</span></span>
<span id="cb31-4"><a href="#cb31-4"></a><span class="co">    """</span></span>
<span id="cb31-5"><a href="#cb31-5"></a>    creds <span class="op">=</span> <span class="va">None</span></span>
<span id="cb31-6"><a href="#cb31-6"></a>    token_path <span class="op">=</span> Path(<span class="st">'token.json'</span>)</span>
<span id="cb31-7"><a href="#cb31-7"></a></span>
<span id="cb31-8"><a href="#cb31-8"></a>    <span class="cf">if</span> token_path.exists():</span>
<span id="cb31-9"><a href="#cb31-9"></a>        creds <span class="op">=</span> Credentials.from_authorized_user_file(<span class="bu">str</span>(token_path), SCOPES)</span>
<span id="cb31-10"><a href="#cb31-10"></a></span>
<span id="cb31-11"><a href="#cb31-11"></a>    <span class="cf">if</span> <span class="kw">not</span> creds <span class="kw">or</span> <span class="kw">not</span> creds.valid:</span>
<span id="cb31-12"><a href="#cb31-12"></a>        <span class="cf">if</span> creds <span class="kw">and</span> creds.expired <span class="kw">and</span> creds.refresh_token:</span>
<span id="cb31-13"><a href="#cb31-13"></a>            <span class="cf">try</span>:</span>
<span id="cb31-14"><a href="#cb31-14"></a>                creds.refresh(Request())</span>
<span id="cb31-15"><a href="#cb31-15"></a>                logging.info(<span class="st">"Credentials refreshed successfully."</span>)</span>
<span id="cb31-16"><a href="#cb31-16"></a>            <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb31-17"><a href="#cb31-17"></a>                logging.error(<span class="ss">f"Error refreshing credentials: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-18"><a href="#cb31-18"></a>                <span class="bu">print</span>(<span class="ss">f"[ERROR] Could not refresh credentials: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-19"><a href="#cb31-19"></a>                <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb31-20"><a href="#cb31-20"></a>        <span class="cf">else</span>:</span>
<span id="cb31-21"><a href="#cb31-21"></a>            <span class="cf">try</span>:</span>
<span id="cb31-22"><a href="#cb31-22"></a>                flow <span class="op">=</span> InstalledAppFlow.from_client_secrets_file(</span>
<span id="cb31-23"><a href="#cb31-23"></a>                    <span class="st">'credentials.json'</span>, SCOPES</span>
<span id="cb31-24"><a href="#cb31-24"></a>                )</span>
<span id="cb31-25"><a href="#cb31-25"></a>                creds <span class="op">=</span> flow.run_local_server(port<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb31-26"><a href="#cb31-26"></a>                logging.info(<span class="st">"Authentication flow completed successfully."</span>)</span>
<span id="cb31-27"><a href="#cb31-27"></a>            <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb31-28"><a href="#cb31-28"></a>                logging.error(<span class="ss">f"Error during OAuth flow: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-29"><a href="#cb31-29"></a>                <span class="bu">print</span>(<span class="ss">f"[ERROR] Could not complete OAuth flow: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-30"><a href="#cb31-30"></a>                <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb31-31"><a href="#cb31-31"></a></span>
<span id="cb31-32"><a href="#cb31-32"></a>        <span class="cf">try</span>:</span>
<span id="cb31-33"><a href="#cb31-33"></a>            <span class="cf">with</span> <span class="bu">open</span>(token_path, <span class="st">'w'</span>) <span class="im">as</span> token:</span>
<span id="cb31-34"><a href="#cb31-34"></a>                token.write(creds.to_json())</span>
<span id="cb31-35"><a href="#cb31-35"></a>                logging.info(<span class="st">"Credentials saved to token.json."</span>)</span>
<span id="cb31-36"><a href="#cb31-36"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb31-37"><a href="#cb31-37"></a>            logging.error(<span class="ss">f"Failed to save credentials: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-38"><a href="#cb31-38"></a>            <span class="bu">print</span>(<span class="ss">f"[ERROR] Could not save credentials: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-39"><a href="#cb31-39"></a></span>
<span id="cb31-40"><a href="#cb31-40"></a>    <span class="cf">try</span>:</span>
<span id="cb31-41"><a href="#cb31-41"></a>        service <span class="op">=</span> build(<span class="st">'gmail'</span>, <span class="st">'v1'</span>, credentials<span class="op">=</span>creds)</span>
<span id="cb31-42"><a href="#cb31-42"></a>        logging.info(<span class="st">"Gmail service created successfully."</span>)</span>
<span id="cb31-43"><a href="#cb31-43"></a>        <span class="cf">return</span> service</span>
<span id="cb31-44"><a href="#cb31-44"></a>    <span class="cf">except</span> HttpError <span class="im">as</span> error:</span>
<span id="cb31-45"><a href="#cb31-45"></a>        logging.error(<span class="ss">f"An error occurred while building Gmail service: </span><span class="sc">{</span>error<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-46"><a href="#cb31-46"></a>        <span class="bu">print</span>(<span class="ss">f"[ERROR] An error occurred while building Gmail service: </span><span class="sc">{</span>error<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-47"><a href="#cb31-47"></a>        <span class="cf">return</span> <span class="va">None</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p><strong>Explanation</strong>:</p>
<ul>
<li><p><strong>Purpose</strong>: Authenticates the user and establishes a connection with the Gmail API to send emails.</p></li>
<li><p><strong>Authentication Flow</strong>:</p>
<ol type="1">
<li><p><strong>Token Check</strong>: Looks for existing credentials in <code>token.json</code>.</p></li>
<li><p><strong>Token Refresh</strong>: If credentials are expired but have a refresh token, it attempts to refresh them.</p></li>
<li><p><strong>OAuth Flow</strong>: If no valid credentials exist, initiates the OAuth flow using <code>credentials.json</code>.</p></li>
<li><p><strong>Credential Saving</strong>: Saves the new or refreshed credentials back to <code>token.json</code> for future use.</p></li>
</ol></li>
<li><p><strong>Error Handling</strong>: Logs and prints errors encountered during authentication or service creation.</p></li>
</ul>
<p><strong>Usage</strong>: This function ensures secure and authenticated access to the Gmail API, enabling the script to send automated emails containing the latest crime reports.</p>
</section>
<section id="h.-email-sending-function" class="level4">
<h4 class="anchored" data-anchor-id="h.-email-sending-function"><strong>h. Email Sending Function</strong></h4>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb32"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1"></a><span class="kw">def</span> send_email_with_disclaimer_and_links(</span>
<span id="cb32-2"><a href="#cb32-2"></a>    service,</span>
<span id="cb32-3"><a href="#cb32-3"></a>    sender_email,</span>
<span id="cb32-4"><a href="#cb32-4"></a>    to_emails,</span>
<span id="cb32-5"><a href="#cb32-5"></a>    subject,</span>
<span id="cb32-6"><a href="#cb32-6"></a>    body_text,</span>
<span id="cb32-7"><a href="#cb32-7"></a>    attachments</span>
<span id="cb32-8"><a href="#cb32-8"></a>):</span>
<span id="cb32-9"><a href="#cb32-9"></a>    <span class="co">"""</span></span>
<span id="cb32-10"><a href="#cb32-10"></a><span class="co">    Sends an email with disclaimers and links using the Gmail API.</span></span>
<span id="cb32-11"><a href="#cb32-11"></a><span class="co">    """</span></span>
<span id="cb32-12"><a href="#cb32-12"></a>    <span class="cf">try</span>:</span>
<span id="cb32-13"><a href="#cb32-13"></a>        message <span class="op">=</span> MIMEMultipart()</span>
<span id="cb32-14"><a href="#cb32-14"></a>        message[<span class="st">'to'</span>] <span class="op">=</span> <span class="st">"Undisclosed Recipients &lt;jesse@jesse-anderson.net&gt;"</span></span>
<span id="cb32-15"><a href="#cb32-15"></a>        message[<span class="st">'subject'</span>] <span class="op">=</span> subject</span>
<span id="cb32-16"><a href="#cb32-16"></a>        message[<span class="st">'from'</span>] <span class="op">=</span> sender_email</span>
<span id="cb32-17"><a href="#cb32-17"></a></span>
<span id="cb32-18"><a href="#cb32-18"></a>        <span class="co"># Define the plain text content</span></span>
<span id="cb32-19"><a href="#cb32-19"></a>        plain_text <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb32-20"><a href="#cb32-20"></a><span class="ss">        Important Legal Disclaimer</span></span>
<span id="cb32-21"><a href="#cb32-21"></a><span class="ss">        </span></span>
<span id="cb32-22"><a href="#cb32-22"></a><span class="ss">        By using this demonstrative research tool, you acknowledge and agree:</span></span>
<span id="cb32-23"><a href="#cb32-23"></a></span>
<span id="cb32-24"><a href="#cb32-24"></a><span class="ss">        - This tool is for demonstration purposes only.</span></span>
<span id="cb32-25"><a href="#cb32-25"></a><span class="ss">        - The data originated from publicly available Oak Park Police Department PDF files.</span></span>
<span id="cb32-26"><a href="#cb32-26"></a><span class="ss">          View the official site here: https://www.oak-park.us/village-services/police-department.</span></span>
<span id="cb32-27"><a href="#cb32-27"></a><span class="ss">        - During parsing, ~10% of total complaints since 2018 were omitted due to parsing issues; </span></span>
<span id="cb32-28"><a href="#cb32-28"></a><span class="ss">          thus the data is incomplete.</span></span>
<span id="cb32-29"><a href="#cb32-29"></a><span class="ss">        - The official and complete PDF files remain with the Oak Park Police Department.</span></span>
<span id="cb32-30"><a href="#cb32-30"></a><span class="ss">        - You will not hold the author liable for any decisions—formal or informal—based on this tool.</span></span>
<span id="cb32-31"><a href="#cb32-31"></a><span class="ss">        - This tool should not be used in any official or unofficial decision-making.</span></span>
<span id="cb32-32"><a href="#cb32-32"></a></span>
<span id="cb32-33"><a href="#cb32-33"></a><span class="ss">        By continuing, you indicate your acceptance of these terms and disclaim all liability.</span></span>
<span id="cb32-34"><a href="#cb32-34"></a></span>
<span id="cb32-35"><a href="#cb32-35"></a><span class="ss">        ------------</span></span>
<span id="cb32-36"><a href="#cb32-36"></a></span>
<span id="cb32-37"><a href="#cb32-37"></a><span class="ss">        Hello,</span></span>
<span id="cb32-38"><a href="#cb32-38"></a><span class="ss">        The crime report from </span><span class="sc">{</span>body_text[<span class="st">'start_date'</span>]<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>body_text[<span class="st">'end_date'</span>]<span class="sc">}</span><span class="ss"> is attached as a .csv file.</span></span>
<span id="cb32-39"><a href="#cb32-39"></a></span>
<span id="cb32-40"><a href="#cb32-40"></a><span class="ss">        Interactive map:</span></span>
<span id="cb32-41"><a href="#cb32-41"></a><span class="ss">        </span><span class="sc">{</span>body_text[<span class="st">'weekly_map_url'</span>]<span class="sc">}</span></span>
<span id="cb32-42"><a href="#cb32-42"></a></span>
<span id="cb32-43"><a href="#cb32-43"></a><span class="ss">        Cumulative map:</span></span>
<span id="cb32-44"><a href="#cb32-44"></a><span class="ss">        </span><span class="sc">{</span>body_text[<span class="st">'cumulative_map_url'</span>]<span class="sc">}</span></span>
<span id="cb32-45"><a href="#cb32-45"></a><span class="ss">        </span></span>
<span id="cb32-46"><a href="#cb32-46"></a><span class="ss">        Last week's data:</span></span>
<span id="cb32-47"><a href="#cb32-47"></a><span class="ss">        </span><span class="sc">{</span>body_text[<span class="st">'csv_url'</span>]<span class="sc">}</span></span>
<span id="cb32-48"><a href="#cb32-48"></a><span class="ss">        """</span></span>
<span id="cb32-49"><a href="#cb32-49"></a></span>
<span id="cb32-50"><a href="#cb32-50"></a>        part1 <span class="op">=</span> MIMEText(plain_text, <span class="st">'plain'</span>)</span>
<span id="cb32-51"><a href="#cb32-51"></a>        message.attach(part1)</span>
<span id="cb32-52"><a href="#cb32-52"></a></span>
<span id="cb32-53"><a href="#cb32-53"></a>        bcc_emails <span class="op">=</span> <span class="st">", "</span>.join(to_emails)</span>
<span id="cb32-54"><a href="#cb32-54"></a>        message[<span class="st">'bcc'</span>] <span class="op">=</span> bcc_emails</span>
<span id="cb32-55"><a href="#cb32-55"></a></span>
<span id="cb32-56"><a href="#cb32-56"></a>        <span class="co"># Attach the CSV</span></span>
<span id="cb32-57"><a href="#cb32-57"></a>        <span class="cf">for</span> file_path <span class="kw">in</span> attachments:</span>
<span id="cb32-58"><a href="#cb32-58"></a>            file_path <span class="op">=</span> Path(file_path)</span>
<span id="cb32-59"><a href="#cb32-59"></a>            <span class="cf">if</span> <span class="kw">not</span> file_path.exists():</span>
<span id="cb32-60"><a href="#cb32-60"></a>                logging.warning(<span class="ss">f"Attachment '</span><span class="sc">{</span>file_path<span class="sc">}</span><span class="ss">' not found, skipping."</span>)</span>
<span id="cb32-61"><a href="#cb32-61"></a>                <span class="cf">continue</span></span>
<span id="cb32-62"><a href="#cb32-62"></a>            <span class="cf">with</span> <span class="bu">open</span>(file_path, <span class="st">'rb'</span>) <span class="im">as</span> f:</span>
<span id="cb32-63"><a href="#cb32-63"></a>                mime_application <span class="op">=</span> MIMEApplication(f.read(), Name<span class="op">=</span>file_path.name)</span>
<span id="cb32-64"><a href="#cb32-64"></a>            mime_application[<span class="st">'Content-Disposition'</span>] <span class="op">=</span> <span class="ss">f'attachment; filename="</span><span class="sc">{</span>file_path<span class="sc">.</span>name<span class="sc">}</span><span class="ss">"'</span></span>
<span id="cb32-65"><a href="#cb32-65"></a>            message.attach(mime_application)</span>
<span id="cb32-66"><a href="#cb32-66"></a></span>
<span id="cb32-67"><a href="#cb32-67"></a>        raw_message <span class="op">=</span> base64.urlsafe_b64encode(message.as_bytes()).decode()</span>
<span id="cb32-68"><a href="#cb32-68"></a>        body <span class="op">=</span> {<span class="st">'raw'</span>: raw_message}</span>
<span id="cb32-69"><a href="#cb32-69"></a></span>
<span id="cb32-70"><a href="#cb32-70"></a>        sent_message <span class="op">=</span> service.users().messages().send(userId<span class="op">=</span><span class="st">"me"</span>, body<span class="op">=</span>body).execute()</span>
<span id="cb32-71"><a href="#cb32-71"></a>        logging.info(<span class="ss">f"Email sent successfully. Message ID: </span><span class="sc">{</span>sent_message[<span class="st">'id'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb32-72"><a href="#cb32-72"></a>        <span class="bu">print</span>(<span class="st">"Crime report email sent successfully."</span>)</span>
<span id="cb32-73"><a href="#cb32-73"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb32-74"><a href="#cb32-74"></a>        logging.error(<span class="ss">f"Failed to send email: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb32-75"><a href="#cb32-75"></a>        <span class="bu">print</span>(<span class="ss">f"[ERROR] Failed to send email: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p><strong>Explanation</strong>:</p>
<ul>
<li><p><strong>Purpose</strong>: Composes and sends an email containing the latest crime reports and links to interactive maps.</p></li>
<li><p><strong>Structure</strong>:</p>
<ul>
<li><p><strong>Email Composition</strong>:</p>
<ul>
<li><p><strong>Plain Text</strong>: Provides a disclaimer and details about the latest crime reports.</p></li>
<li><p><strong>Attachments</strong>: Attaches the filtered CSV report.</p></li>
</ul></li>
<li><p><strong>BCC</strong>: Sends the email to undisclosed recipients to maintain privacy.</p></li>
</ul></li>
<li><p><strong>Encoding</strong>: Encodes the email content in base64 to comply with Gmail API requirements.</p></li>
<li><p><strong>Sending</strong>: Utilizes the authenticated Gmail service to send the email.</p></li>
<li><p><strong>Error Handling</strong>: Logs and prints errors encountered during the email sending process.</p></li>
</ul>
</section>
<section id="i.-main-report-generation-workflow" class="level4">
<h4 class="anchored" data-anchor-id="i.-main-report-generation-workflow"><strong>i. Main Report Generation Workflow</strong></h4>
<details>
<summary>
Code
</summary>
<div class="sourceCode" id="cb33"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1"></a><span class="kw">def</span> main_report_generation():</span>
<span id="cb33-2"><a href="#cb33-2"></a>    <span class="co">"""</span></span>
<span id="cb33-3"><a href="#cb33-3"></a><span class="co">    Executes the full pipeline:</span></span>
<span id="cb33-4"><a href="#cb33-4"></a><span class="co">    1. Load environment variables</span></span>
<span id="cb33-5"><a href="#cb33-5"></a><span class="co">    2. Load &amp; filter data for the last 7 days</span></span>
<span id="cb33-6"><a href="#cb33-6"></a><span class="co">    3. Create &amp; save Folium map with disclaimers overlay</span></span>
<span id="cb33-7"><a href="#cb33-7"></a><span class="co">    4. Upload HTML to GitHub</span></span>
<span id="cb33-8"><a href="#cb33-8"></a><span class="co">    5. Send email with CSV attached</span></span>
<span id="cb33-9"><a href="#cb33-9"></a><span class="co">    """</span></span>
<span id="cb33-10"><a href="#cb33-10"></a>    start_time <span class="op">=</span> time.time()</span>
<span id="cb33-11"><a href="#cb33-11"></a>    script_dir <span class="op">=</span> Path(<span class="va">__file__</span>).parent.resolve()</span>
<span id="cb33-12"><a href="#cb33-12"></a></span>
<span id="cb33-13"><a href="#cb33-13"></a>    env_file_path <span class="op">=</span> script_dir <span class="op">/</span> <span class="st">"env_vars.txt"</span></span>
<span id="cb33-14"><a href="#cb33-14"></a>    <span class="cf">try</span>:</span>
<span id="cb33-15"><a href="#cb33-15"></a>        load_env_vars(env_file_path)</span>
<span id="cb33-16"><a href="#cb33-16"></a>    <span class="cf">except</span> <span class="pp">FileNotFoundError</span> <span class="im">as</span> e:</span>
<span id="cb33-17"><a href="#cb33-17"></a>        <span class="bu">print</span>(<span class="ss">f"[ERROR] </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb33-18"><a href="#cb33-18"></a>        <span class="cf">return</span></span>
<span id="cb33-19"><a href="#cb33-19"></a></span>
<span id="cb33-20"><a href="#cb33-20"></a>    sender_email <span class="op">=</span> os.getenv(<span class="st">"SENDER_EMAIL"</span>)</span>
<span id="cb33-21"><a href="#cb33-21"></a>    <span class="cf">if</span> <span class="kw">not</span> sender_email:</span>
<span id="cb33-22"><a href="#cb33-22"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Missing SENDER_EMAIL in env_vars.txt"</span>)</span>
<span id="cb33-23"><a href="#cb33-23"></a></span>
<span id="cb33-24"><a href="#cb33-24"></a>    logging.basicConfig(</span>
<span id="cb33-25"><a href="#cb33-25"></a>        filename<span class="op">=</span>script_dir <span class="op">/</span> <span class="st">'full_crime_report.log'</span>,</span>
<span id="cb33-26"><a href="#cb33-26"></a>        level<span class="op">=</span>logging.DEBUG,</span>
<span id="cb33-27"><a href="#cb33-27"></a>        <span class="bu">format</span><span class="op">=</span><span class="st">'</span><span class="sc">%(asctime)s</span><span class="st"> - </span><span class="sc">%(levelname)s</span><span class="st"> - </span><span class="sc">%(message)s</span><span class="st">'</span></span>
<span id="cb33-28"><a href="#cb33-28"></a>    )</span>
<span id="cb33-29"><a href="#cb33-29"></a></span>
<span id="cb33-30"><a href="#cb33-30"></a>    data_dir <span class="op">=</span> script_dir <span class="op">/</span> <span class="st">'data'</span></span>
<span id="cb33-31"><a href="#cb33-31"></a>    map_dir <span class="op">=</span> script_dir <span class="op">/</span> <span class="st">'generated_maps'</span></span>
<span id="cb33-32"><a href="#cb33-32"></a>    <span class="co"># recipients_csv = script_dir / 'recipients.csv'</span></span>
<span id="cb33-33"><a href="#cb33-33"></a>    csv_dir <span class="op">=</span> script_dir <span class="op">/</span> <span class="st">'generated_csvs'</span>  <span class="co"># New directory for CSVs</span></span>
<span id="cb33-34"><a href="#cb33-34"></a>    map_dir.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb33-35"><a href="#cb33-35"></a>    csv_dir.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb33-36"><a href="#cb33-36"></a></span>
<span id="cb33-37"><a href="#cb33-37"></a>    zip_file_path <span class="op">=</span> data_dir <span class="op">/</span> <span class="st">'summary_report.zip'</span></span>
<span id="cb33-38"><a href="#cb33-38"></a></span>
<span id="cb33-39"><a href="#cb33-39"></a>    execution_date <span class="op">=</span> datetime.now().date()</span>
<span id="cb33-40"><a href="#cb33-40"></a>    date_str <span class="op">=</span> execution_date.strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>)</span>
<span id="cb33-41"><a href="#cb33-41"></a></span>
<span id="cb33-42"><a href="#cb33-42"></a>    <span class="co"># CSV &amp; HTML output</span></span>
<span id="cb33-43"><a href="#cb33-43"></a>    filtered_subset_filename <span class="op">=</span> <span class="ss">f'filtered_subset_</span><span class="sc">{</span>date_str<span class="sc">}</span><span class="ss">.csv'</span></span>
<span id="cb33-44"><a href="#cb33-44"></a>    filtered_subset_path <span class="op">=</span> csv_dir <span class="op">/</span> filtered_subset_filename</span>
<span id="cb33-45"><a href="#cb33-45"></a>    weekly_map_output_filename <span class="op">=</span> <span class="ss">f'crime_map_weekly_</span><span class="sc">{</span>date_str<span class="sc">}</span><span class="ss">.html'</span></span>
<span id="cb33-46"><a href="#cb33-46"></a>    weekly_map_output_path <span class="op">=</span> map_dir <span class="op">/</span> weekly_map_output_filename</span>
<span id="cb33-47"><a href="#cb33-47"></a>    cumulative_map_output_filename <span class="op">=</span> <span class="ss">f'crime_map_cumulative.html'</span></span>
<span id="cb33-48"><a href="#cb33-48"></a>    cumulative_map_output_path <span class="op">=</span> map_dir <span class="op">/</span> cumulative_map_output_filename</span>
<span id="cb33-49"><a href="#cb33-49"></a></span>
<span id="cb33-50"><a href="#cb33-50"></a>    <span class="co"># Local GitHub Pages folder</span></span>
<span id="cb33-51"><a href="#cb33-51"></a>    github_repo_path <span class="op">=</span> os.getenv(<span class="st">"GITHUB_REPO"</span>)</span>
<span id="cb33-52"><a href="#cb33-52"></a>    github_repo_path <span class="op">=</span> Path(github_repo_path)</span>
<span id="cb33-53"><a href="#cb33-53"></a></span>
<span id="cb33-54"><a href="#cb33-54"></a>    <span class="co"># (C) Load data</span></span>
<span id="cb33-55"><a href="#cb33-55"></a>    <span class="cf">try</span>:</span>
<span id="cb33-56"><a href="#cb33-56"></a>        df_full <span class="op">=</span> load_all_crimes(zip_file_path)</span>
<span id="cb33-57"><a href="#cb33-57"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb33-58"><a href="#cb33-58"></a>        logging.error(<span class="ss">f"Failed to load all crimes: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb33-59"><a href="#cb33-59"></a>        <span class="bu">print</span>(<span class="ss">f"[ERROR] Could not load all crimes: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb33-60"><a href="#cb33-60"></a>        <span class="cf">return</span></span>
<span id="cb33-61"><a href="#cb33-61"></a></span>
<span id="cb33-62"><a href="#cb33-62"></a>    <span class="cf">if</span> df_full.empty:</span>
<span id="cb33-63"><a href="#cb33-63"></a>        logging.info(<span class="st">"No crime data—no map or CSV generated."</span>)</span>
<span id="cb33-64"><a href="#cb33-64"></a>        <span class="bu">print</span>(<span class="st">"No crime data—no map or CSV generated."</span>)</span>
<span id="cb33-65"><a href="#cb33-65"></a>        <span class="cf">return</span></span>
<span id="cb33-66"><a href="#cb33-66"></a></span>
<span id="cb33-67"><a href="#cb33-67"></a>    <span class="co"># (D) Filter last 7 days</span></span>
<span id="cb33-68"><a href="#cb33-68"></a>    <span class="cf">try</span>:</span>
<span id="cb33-69"><a href="#cb33-69"></a>        start_date, end_date <span class="op">=</span> determine_date_range(df_full, execution_date)</span>
<span id="cb33-70"><a href="#cb33-70"></a>        df_filtered <span class="op">=</span> filter_crime_data(df_full, start_date, end_date)</span>
<span id="cb33-71"><a href="#cb33-71"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb33-72"><a href="#cb33-72"></a>        logging.error(<span class="ss">f"Error determining date range: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb33-73"><a href="#cb33-73"></a>        <span class="bu">print</span>(<span class="ss">f"[ERROR] Could not determine date range: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb33-74"><a href="#cb33-74"></a>        <span class="cf">return</span></span>
<span id="cb33-75"><a href="#cb33-75"></a></span>
<span id="cb33-76"><a href="#cb33-76"></a>    <span class="cf">if</span> df_filtered.empty:</span>
<span id="cb33-77"><a href="#cb33-77"></a>        logging.info(<span class="st">"No crimes found—no map or CSV generated."</span>)</span>
<span id="cb33-78"><a href="#cb33-78"></a>        <span class="bu">print</span>(<span class="st">"No crimes found in the determined date range—no map or CSV generated."</span>)</span>
<span id="cb33-79"><a href="#cb33-79"></a>        <span class="cf">return</span></span>
<span id="cb33-80"><a href="#cb33-80"></a></span>
<span id="cb33-81"><a href="#cb33-81"></a>    <span class="co"># (E) Write filtered CSV</span></span>
<span id="cb33-82"><a href="#cb33-82"></a>    <span class="cf">try</span>:</span>
<span id="cb33-83"><a href="#cb33-83"></a>        df_filtered.to_csv(filtered_subset_path, index<span class="op">=</span><span class="va">False</span>, encoding<span class="op">=</span><span class="st">"cp1252"</span>)</span>
<span id="cb33-84"><a href="#cb33-84"></a>        logging.info(<span class="ss">f"Filtered data written to </span><span class="sc">{</span>filtered_subset_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb33-85"><a href="#cb33-85"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb33-86"><a href="#cb33-86"></a>        logging.error(<span class="ss">f"Failed to write filtered data to CSV: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb33-87"><a href="#cb33-87"></a>        <span class="bu">print</span>(<span class="ss">f"[ERROR] Could not write filtered data to CSV: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb33-88"><a href="#cb33-88"></a>        <span class="cf">return</span></span>
<span id="cb33-89"><a href="#cb33-89"></a></span>
<span id="cb33-90"><a href="#cb33-90"></a>    <span class="co"># (F) Create Folium map with disclaimers overlay</span></span>
<span id="cb33-91"><a href="#cb33-91"></a>    <span class="cf">try</span>:</span>
<span id="cb33-92"><a href="#cb33-92"></a>        create_folium_map_filtered_data(</span>
<span id="cb33-93"><a href="#cb33-93"></a>            df<span class="op">=</span>df_filtered,</span>
<span id="cb33-94"><a href="#cb33-94"></a>            lat_col<span class="op">=</span><span class="st">'Lat'</span>,</span>
<span id="cb33-95"><a href="#cb33-95"></a>            lng_col<span class="op">=</span><span class="st">'Long'</span>,</span>
<span id="cb33-96"><a href="#cb33-96"></a>            offense_col<span class="op">=</span><span class="st">'Offense'</span>,</span>
<span id="cb33-97"><a href="#cb33-97"></a>            date_col<span class="op">=</span><span class="st">'Date'</span>,</span>
<span id="cb33-98"><a href="#cb33-98"></a>            output_html_path<span class="op">=</span>weekly_map_output_path</span>
<span id="cb33-99"><a href="#cb33-99"></a>        )</span>
<span id="cb33-100"><a href="#cb33-100"></a>        logging.info(<span class="ss">f"Folium map created at </span><span class="sc">{</span>weekly_map_output_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb33-101"><a href="#cb33-101"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb33-102"><a href="#cb33-102"></a>        logging.error(<span class="ss">f"Error creating Folium map: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb33-103"><a href="#cb33-103"></a>        <span class="bu">print</span>(<span class="ss">f"[ERROR] Could not create Folium map: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb33-104"><a href="#cb33-104"></a>        <span class="cf">return</span></span>
<span id="cb33-105"><a href="#cb33-105"></a></span>
<span id="cb33-106"><a href="#cb33-106"></a>    <span class="cf">try</span>:</span>
<span id="cb33-107"><a href="#cb33-107"></a>        create_folium_map_cumulative(</span>
<span id="cb33-108"><a href="#cb33-108"></a>            df<span class="op">=</span>df_full,  <span class="co"># Use the full dataset for cumulative map</span></span>
<span id="cb33-109"><a href="#cb33-109"></a>            lat_col<span class="op">=</span><span class="st">'Lat'</span>,</span>
<span id="cb33-110"><a href="#cb33-110"></a>            lng_col<span class="op">=</span><span class="st">'Long'</span>,</span>
<span id="cb33-111"><a href="#cb33-111"></a>            offense_col<span class="op">=</span><span class="st">'Offense'</span>,</span>
<span id="cb33-112"><a href="#cb33-112"></a>            date_col<span class="op">=</span><span class="st">'Date'</span>,</span>
<span id="cb33-113"><a href="#cb33-113"></a>            output_html_path<span class="op">=</span>cumulative_map_output_path</span>
<span id="cb33-114"><a href="#cb33-114"></a>        )</span>
<span id="cb33-115"><a href="#cb33-115"></a>        logging.info(<span class="ss">f"Cumulative Folium map created at </span><span class="sc">{</span>cumulative_map_output_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb33-116"><a href="#cb33-116"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb33-117"><a href="#cb33-117"></a>        logging.error(<span class="ss">f"Error creating cumulative Folium map: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb33-118"><a href="#cb33-118"></a>        <span class="bu">print</span>(<span class="ss">f"[ERROR] Could not create cumulative Folium map: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb33-119"><a href="#cb33-119"></a>        <span class="cf">return</span></span>
<span id="cb33-120"><a href="#cb33-120"></a>    </span>
<span id="cb33-121"><a href="#cb33-121"></a>    test <span class="op">=</span> <span class="va">False</span></span>
<span id="cb33-122"><a href="#cb33-122"></a>    <span class="cf">if</span> <span class="kw">not</span> test:</span>
<span id="cb33-123"><a href="#cb33-123"></a>        <span class="co"># (G) Upload Map and csv</span></span>
<span id="cb33-124"><a href="#cb33-124"></a>        <span class="cf">try</span>:</span>
<span id="cb33-125"><a href="#cb33-125"></a>            <span class="co"># Upload Maps</span></span>
<span id="cb33-126"><a href="#cb33-126"></a>            files_to_upload_maps <span class="op">=</span> [weekly_map_output_path, cumulative_map_output_path]</span>
<span id="cb33-127"><a href="#cb33-127"></a>            upload_files_to_github_batch(</span>
<span id="cb33-128"><a href="#cb33-128"></a>                file_paths<span class="op">=</span>files_to_upload_maps,</span>
<span id="cb33-129"><a href="#cb33-129"></a>                github_repo_path<span class="op">=</span>github_repo_path,</span>
<span id="cb33-130"><a href="#cb33-130"></a>                target_subfolder<span class="op">=</span><span class="st">'OP-Crime-Maps'</span></span>
<span id="cb33-131"><a href="#cb33-131"></a>            )</span>
<span id="cb33-132"><a href="#cb33-132"></a>            time.sleep(<span class="dv">5</span>) <span class="co">#paranoia</span></span>
<span id="cb33-133"><a href="#cb33-133"></a>            <span class="co"># Upload CSV</span></span>
<span id="cb33-134"><a href="#cb33-134"></a>            files_to_upload_csv <span class="op">=</span> filtered_subset_path</span>
<span id="cb33-135"><a href="#cb33-135"></a>            upload_file_to_github(</span>
<span id="cb33-136"><a href="#cb33-136"></a>                file_path<span class="op">=</span>files_to_upload_csv,</span>
<span id="cb33-137"><a href="#cb33-137"></a>                github_repo_path<span class="op">=</span>github_repo_path,</span>
<span id="cb33-138"><a href="#cb33-138"></a>                target_subfolder<span class="op">=</span><span class="st">'OP-Crime-Data'</span></span>
<span id="cb33-139"><a href="#cb33-139"></a>            )</span>
<span id="cb33-140"><a href="#cb33-140"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb33-141"><a href="#cb33-141"></a>            logging.error(<span class="ss">f"Failed to upload files to GitHub: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb33-142"><a href="#cb33-142"></a>            <span class="bu">print</span>(<span class="ss">f"[ERROR] Could not upload files to GitHub: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb33-143"><a href="#cb33-143"></a>            <span class="cf">return</span></span>
<span id="cb33-144"><a href="#cb33-144"></a>        <span class="co"># (I) Generate GitHub URLs for the uploaded files</span></span>
<span id="cb33-145"><a href="#cb33-145"></a>        <span class="co"># Assuming GitHub Pages are served from the root of the repository</span></span>
<span id="cb33-146"><a href="#cb33-146"></a>        github_base_url <span class="op">=</span> <span class="st">"https://jesse-anderson.github.io"</span></span>
<span id="cb33-147"><a href="#cb33-147"></a></span>
<span id="cb33-148"><a href="#cb33-148"></a>        weekly_map_url <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>github_base_url<span class="sc">}</span><span class="ss">/OP-Crime-Maps/</span><span class="sc">{</span>weekly_map_output_filename<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb33-149"><a href="#cb33-149"></a>        cumulative_map_url <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>github_base_url<span class="sc">}</span><span class="ss">/OP-Crime-Maps/</span><span class="sc">{</span>cumulative_map_output_filename<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb33-150"><a href="#cb33-150"></a>        csv_url <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>github_base_url<span class="sc">}</span><span class="ss">/OP-Crime-Data/</span><span class="sc">{</span>filtered_subset_filename<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb33-151"><a href="#cb33-151"></a></span>
<span id="cb33-152"><a href="#cb33-152"></a>        <span class="co"># (J) Gmail API &amp; Email</span></span>
<span id="cb33-153"><a href="#cb33-153"></a>        <span class="cf">try</span>:</span>
<span id="cb33-154"><a href="#cb33-154"></a>            service <span class="op">=</span> get_gmail_service()</span>
<span id="cb33-155"><a href="#cb33-155"></a>            <span class="cf">if</span> <span class="kw">not</span> service:</span>
<span id="cb33-156"><a href="#cb33-156"></a>                <span class="cf">raise</span> <span class="pp">Exception</span>(<span class="st">"Failed to create Gmail service."</span>)</span>
<span id="cb33-157"><a href="#cb33-157"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb33-158"><a href="#cb33-158"></a>            logging.error(<span class="ss">f"Authentication failed: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb33-159"><a href="#cb33-159"></a>            <span class="bu">print</span>(<span class="ss">f"[ERROR] Authentication failed: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb33-160"><a href="#cb33-160"></a>            <span class="cf">return</span></span>
<span id="cb33-161"><a href="#cb33-161"></a>        time.sleep(<span class="dv">60</span>) <span class="co">#time to build github pages....</span></span>
<span id="cb33-162"><a href="#cb33-162"></a>        <span class="co"># (K) Load Recipients</span></span>
<span id="cb33-163"><a href="#cb33-163"></a>        <span class="cf">try</span>:</span>
<span id="cb33-164"><a href="#cb33-164"></a>            <span class="co"># to_list = load_recipients_list(recipients_csv)</span></span>
<span id="cb33-165"><a href="#cb33-165"></a>            <span class="co"># to_list = get_mailchimp_subscribers()</span></span>
<span id="cb33-166"><a href="#cb33-166"></a>            to_list <span class="op">=</span> [<span class="st">"myemail@gmail.com"</span>]</span>
<span id="cb33-167"><a href="#cb33-167"></a>        <span class="cf">except</span> <span class="pp">FileNotFoundError</span> <span class="im">as</span> e:</span>
<span id="cb33-168"><a href="#cb33-168"></a>            logging.error(<span class="ss">f"Error loading recipients: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb33-169"><a href="#cb33-169"></a>            <span class="bu">print</span>(<span class="ss">f"[ERROR] </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb33-170"><a href="#cb33-170"></a>            <span class="cf">return</span></span>
<span id="cb33-171"><a href="#cb33-171"></a></span>
<span id="cb33-172"><a href="#cb33-172"></a>        <span class="cf">if</span> <span class="kw">not</span> to_list:</span>
<span id="cb33-173"><a href="#cb33-173"></a>            logging.warning(<span class="st">"No recipients found—cannot send email."</span>)</span>
<span id="cb33-174"><a href="#cb33-174"></a>            <span class="bu">print</span>(<span class="st">"No recipients found in recipients.csv—cannot send email."</span>)</span>
<span id="cb33-175"><a href="#cb33-175"></a>            <span class="cf">return</span></span>
<span id="cb33-176"><a href="#cb33-176"></a></span>
<span id="cb33-177"><a href="#cb33-177"></a>        subject <span class="op">=</span> <span class="ss">f"Crime Report from </span><span class="sc">{</span>start_date<span class="sc">.</span>strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>)<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>end_date<span class="sc">.</span>strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>)<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb33-178"><a href="#cb33-178"></a>        body_text <span class="op">=</span> {</span>
<span id="cb33-179"><a href="#cb33-179"></a>            <span class="st">'start_date'</span>: start_date.strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>),</span>
<span id="cb33-180"><a href="#cb33-180"></a>            <span class="st">'end_date'</span>: end_date.strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>),</span>
<span id="cb33-181"><a href="#cb33-181"></a>            <span class="st">'weekly_map_url'</span>: weekly_map_url,</span>
<span id="cb33-182"><a href="#cb33-182"></a>            <span class="st">'cumulative_map_url'</span>: cumulative_map_url,</span>
<span id="cb33-183"><a href="#cb33-183"></a>            <span class="st">'csv_url'</span>: csv_url</span>
<span id="cb33-184"><a href="#cb33-184"></a>        }</span>
<span id="cb33-185"><a href="#cb33-185"></a>        attachments <span class="op">=</span> []</span>
<span id="cb33-186"><a href="#cb33-186"></a></span>
<span id="cb33-187"><a href="#cb33-187"></a>        <span class="cf">try</span>:</span>
<span id="cb33-188"><a href="#cb33-188"></a>            send_email_with_disclaimer_and_links(</span>
<span id="cb33-189"><a href="#cb33-189"></a>                service<span class="op">=</span>service,</span>
<span id="cb33-190"><a href="#cb33-190"></a>                sender_email<span class="op">=</span>sender_email,</span>
<span id="cb33-191"><a href="#cb33-191"></a>                to_emails<span class="op">=</span>to_list,</span>
<span id="cb33-192"><a href="#cb33-192"></a>                subject<span class="op">=</span>subject,</span>
<span id="cb33-193"><a href="#cb33-193"></a>                body_text<span class="op">=</span>body_text,</span>
<span id="cb33-194"><a href="#cb33-194"></a>                attachments<span class="op">=</span>attachments</span>
<span id="cb33-195"><a href="#cb33-195"></a>            )</span>
<span id="cb33-196"><a href="#cb33-196"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb33-197"><a href="#cb33-197"></a>            logging.error(<span class="ss">f"Failed to send email: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb33-198"><a href="#cb33-198"></a>            <span class="bu">print</span>(<span class="ss">f"[ERROR] Could not send email: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb33-199"><a href="#cb33-199"></a></span>
<span id="cb33-200"><a href="#cb33-200"></a>    end_time <span class="op">=</span> time.time()</span>
<span id="cb33-201"><a href="#cb33-201"></a>    elapsed_sec <span class="op">=</span> end_time <span class="op">-</span> start_time</span>
<span id="cb33-202"><a href="#cb33-202"></a>    logging.info(<span class="ss">f"Finished full_crime_report in </span><span class="sc">{</span>elapsed_sec<span class="sc">:.2f}</span><span class="ss"> seconds."</span>)</span>
<span id="cb33-203"><a href="#cb33-203"></a>    <span class="bu">print</span>(<span class="ss">f"Finished full_crime_report in </span><span class="sc">{</span>elapsed_sec<span class="sc">:.2f}</span><span class="ss"> seconds."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p><strong>Explanation</strong>:</p>
<ul>
<li><p><strong>Pipeline Steps</strong>:</p>
<ol type="1">
<li><p><strong>Environment Variables</strong>: Loads necessary configurations like API keys and GitHub repository paths.</p></li>
<li><p><strong>Data Loading</strong>: Retrieves the complete set of crime data from <code>summary_report.zip</code>.</p></li>
<li><p><strong>Data Filtering</strong>: Selects records from the past seven days to focus the weekly report.</p></li>
<li><p><strong>CSV Generation</strong>: Exports the filtered data to a CSV file for easy access and dissemination.</p></li>
<li><p><strong>Map Creation</strong>:</p>
<ul>
<li><p><strong>Weekly Map</strong>: Generates an interactive map highlighting crimes from the past week.</p></li>
<li><p><strong>Cumulative Map</strong>: Generates a comprehensive map showcasing all recorded crimes.</p></li>
</ul></li>
<li><p><strong>GitHub Upload</strong>: Pushes the newly generated HTML maps and CSV reports to designated GitHub repository subfolders.</p></li>
<li><p><strong>Email Preparation and Sending</strong>:</p>
<ul>
<li><p><strong>Gmail API Authentication</strong>: Ensures secure access to the Gmail API for sending emails.</p></li>
<li><p><strong>Recipient Loading</strong>: Retrieves the list of subscribers.</p></li>
<li><p><strong>Email Composition</strong>: Crafts an email containing links to the latest reports and attaches the CSV file.</p></li>
<li><p><strong>Email Dispatch</strong>: Sends the email to all subscribers.</p></li>
</ul></li>
<li><p><strong>Logging</strong>: Records the entire process’s execution details, including any errors and execution time.</p></li>
</ol></li>
<li><p><strong>Testing Mode</strong>:</p>
<ul>
<li><strong>Flag</strong>: The <code>test</code> variable allows toggling between testing and production modes. When <code>test = False</code>, the script proceeds with uploading and emailing. This is useful for development and debugging without affecting live data or subscribers.</li>
</ul></li>
<li><p><strong>Error Handling</strong>:</p>
<ul>
<li><strong>Try-Except Blocks</strong>: Enclose critical operations to catch and log exceptions, ensuring the script fails gracefully and provides informative error messages.</li>
</ul></li>
</ul>
</section>
</section>
<section id="conclusion-of-static-html-generation-section" class="level3">
<h3 class="anchored" data-anchor-id="conclusion-of-static-html-generation-section"><strong>Conclusion of Static HTML Generation Section</strong></h3>
<p>The <strong>Static HTML Generation</strong> component plays a crucial role in ensuring that the Oak Park Crime Reporting project delivers timely and accessible information. By automating the creation of detailed reports and maps, integrating seamlessly with GitHub for hosting, and utilizing the Gmail API for dissemination, the script ensures that stakeholders and interested parties receive up-to-date crime data efficiently. Robust error handling and logging mechanisms further enhance the reliability and maintainability of the reporting pipeline.</p>
<hr>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion"><strong>Conclusion</strong></h2>
<p>The Oak Park Crime Reporting project is a comprehensive solution that automates the extraction, processing, visualization, and dissemination of crime data within Oak Park. By leveraging powerful Python libraries and integrations with platforms like GitHub and Gmail, the project ensures that crime data is both accessible and actionable. The meticulous documentation of each component—<strong>Data Parsing</strong>, <strong>Live Streamlit Dashboard</strong>, and <strong>Static HTML Generation</strong>—provides a clear roadmap for understanding, maintaining, and potentially expanding the project’s capabilities.</p>
<hr>
</section>
<section id="future-enhancements" class="level2">
<h2 class="anchored" data-anchor-id="future-enhancements"><strong>Future Enhancements</strong></h2>
<p>While the current implementation of the Oak Park Crime Reporting project is robust, there are several avenues for future enhancements:</p>
<ol type="1">
<li><p><strong>Enhanced Data Parsing</strong>:</p>
<ul>
<li><p><strong>Machine Learning Integration</strong>: Implement machine learning models to improve the accuracy of data extraction from PDFs, especially for complex narratives. Currently the narratives have random spaces which does not lend itself to easy reading, but manually processing 7,000+ records and/or spending more time coding does not seem logical.</p></li>
<li><p><strong>Automated Data Validation</strong>: Introduce automated checks to validate the integrity and consistency of the parsed data.</p></li>
</ul></li>
<li><p><strong>Dashboard Improvements</strong>:</p>
<ul>
<li><p><strong>Advanced Visualization</strong>: Incorporate additional visualization tools like heatmaps, trend graphs, and statistical summaries.</p></li>
<li><p><strong>User Authentication</strong>: Add authentication layers to restrict access to sensitive data and functionalities.</p></li>
<li><p><strong>Real-Time Updates</strong>: Enable real-time data streaming to keep the dashboard updated without manual interventions.</p></li>
</ul></li>
<li><p><strong>Static Report Enhancements</strong>:</p>
<ul>
<li><p><strong>Interactive Elements</strong>: Introduce interactive components within the static HTML reports for better user engagement such as advanced filtering.</p></li>
<li><p><strong>Responsive Design</strong>: Ensure that the static reports are mobile-friendly and adapt seamlessly to various screen sizes.</p></li>
</ul></li>
<li><p><strong>Email System Upgrades</strong>:</p>
<ul>
<li><p><strong>Personalization</strong>: Personalize emails based on user preferences and subscription tiers. such as daily, weekly, monthly, quarterly, and yearly.</p></li>
<li><p><strong>Email Scheduling</strong>: Implement scheduled email dispatches to send reports at predefined intervals automatically beyond simple Cronjobs.</p></li>
</ul></li>
<li><p><strong>Scalability and Performance</strong>:</p>
<ul>
<li><p><strong>Cloud Deployment</strong>: Migrate components to cloud platforms for better scalability, reliability, and performance. This is currently not implemented as that would cost money and the balance is such that this project is not bringing in any funds.</p></li>
<li><p><strong>Database Integration</strong>: Utilize databases like PostgreSQL or MongoDB for more efficient data storage and querying once the storage records begin to exceed 10,000.</p></li>
</ul></li>
<li><p><strong>Security Enhancements</strong>:</p>
<ul>
<li><p><strong>Data Encryption</strong>: Encrypt sensitive data both at rest and in transit to ensure data privacy. While this is already done, it can always be improved upon.</p></li>
<li><p><strong>Secure Authentication</strong>: Strengthen authentication mechanisms for API integrations and user access. Already done, but improvement is relentless.</p></li>
</ul></li>
<li><p><strong>User Feedback Mechanism</strong>:</p>
<ul>
<li><p><strong>Feedback Forms</strong>: Incorporate feedback forms within the dashboard and reports to gather user insights and suggestions.</p></li>
<li><p><strong>Analytics</strong>: Implement analytics to monitor user interactions and improve the platform based on usage patterns.</p></li>
</ul></li>
</ol>
<p>By pursuing these enhancements, the Oak Park Crime Reporting project can evolve into an even more powerful tool, providing deeper insights and greater value to its users.</p>
<hr>
<p>I hope you have enjoyed reading this documentation and sincerely hope you got something out of it.</p>
<p>Jesse</p>


</section>

</main> <!-- /main -->






    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Support Page</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>

        .centered-text {

            text-align: center; /* Centers text for elements with this class */

        }

        .centered-content {

            display: flex; /* Uses Flexbox for layout */

            justify-content: center; /* Horizontally centers the content within the container */

            align-items: center; /* Vertically centers the content within the container */

        }

        .email-share-button {

            background: #007BFF; /* Example: a distinct blue color for the email button */

            color: white; /* Ensure text and icon are white for visibility */

        }

        #share-buttons {

            display: flex;

            align-items: center;

            justify-content: center;

            gap: 5px;

        }

        .share-button {

            display: inline-flex;

            padding: 2px 4px;

            font-size: 14px;

            cursor: pointer;

            text-align: center;

            color: white;

            border-radius: 0px;

        }

    </style>





    <footer class="centered-text">

        <p>Copyright © <span id="copyright-year"></span> Jesse Anderson</p>

        <!-- Other footer details -->

    </footer>

    <div>

        <hr>

        <h3 class="centered-text">Support my work with a Coffee/Monster</h3>

        <div class="centered-content">

            <script type="text/javascript" src="https://cdnjs.buymeacoffee.com/1.0.0/button.prod.min.js" data-name="bmc-button" data-slug="jesseanderson" data-color="#06436e" data-emoji="☕" data-font="Lato" data-text="Support me" data-outline-color="#ffffff" data-font-color="#ffffff" data-coffee-color="#FFDD00" data-height="40px"></script>

        </div>

        <!-- Footer content -->

        <h3 class="centered-text">Share</h3>

        <!-- Share Buttons -->

        <div id="share-buttons" class="centered-content">

            <!-- Twitter Share Button, dynamically setting the URL -->

            <a href="#" class="share-button twitter-share-button" data-size="large" data-hashtags="computerscience" data-via="JesseA7C5" data-show-count="false">Tweet</a>

            <script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

            <!-- Facebook SDK with Dynamic Nonce -->

            <div id="fb-root"></div>

            <script id="facebook-jssdk" async="" defer="" crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js#xfbml=1&amp;version=v10.0"></script>

            <div class="fb-share-button share-button" data-href="" data-layout="button_count">

            </div>

            <!-- LinkedIn Share Button -->

            <script src="https://platform.linkedin.com/in.js" type="text/javascript">lang: en_US</script>

            <script type="IN/Share" data-url=""></script>

            <!-- Email Share Button -->

            <a href="#" class="share-button email-share-button"><i class="fas fa-envelope"></i></a>

        </div>

    </div>

    <script>

        // Function to generate a random nonce

        function generateNonce(length = 16) {

            const possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";

            let text = "";

            for (let i = 0; i < length; i++) {

                text += possible.charAt(Math.floor(Math.random() * possible.length));

            }

            return text;

        }

        // Set the nonce attribute for the Facebook SDK script and dynamically set URLs

        document.addEventListener('DOMContentLoaded', function() {

            const nonce = generateNonce();

            const facebookSDKScript = document.getElementById('facebook-jssdk');

            facebookSDKScript.setAttribute('nonce', nonce);

            var elems = document.querySelectorAll('script[type="IN/Share"]');

            for (var i = 0; i < elems.length; i++) {

                elems[i].setAttribute('data-url', window.location.href);

            }

            // Set dynamic URLs for social sharing

            const currentUrl = window.location.href;

            const currentTitle = document.title; // Use the current document title as the email subject

            // Facebook

            document.querySelector('.fb-share-button').setAttribute('data-href', currentUrl);

            // LinkedIn

            document.querySelectorAll('script[type="IN/Share"]')[0].setAttribute('data-url', currentUrl);

            // Twitter

            document.querySelector('.twitter-share-button').setAttribute('href', 'https://twitter.com/share?url=' + encodeURIComponent(currentUrl) + '&hashtags=rstats');

            // Email

            document.querySelector('.email-share-button').setAttribute('href', `mailto:?subject=${encodeURIComponent(currentTitle)}&body=Check out this link: ${encodeURIComponent(currentUrl)}`);

            // Dynamically set the current year in the copyright footer

            document.getElementById('copyright-year').textContent = new Date().getFullYear();

        });

        // This script below to put a latest posts list after the comment system was such a pain in the ass.

        document.addEventListener('DOMContentLoaded', function() {

            // console.log("Latest Posts Populating...");

            // Create the latest posts container

            const latestPostsContainer = document.createElement('div');

            latestPostsContainer.className = 'latest-posts';

            latestPostsContainer.innerHTML = `

                <h3>Latest Posts</h3>

                <ul id="latest-posts-list">

                    <!-- Latest posts will be inserted here -->

                </ul>

            `;

            // Find the footer element

            const footer = document.querySelector('footer.footer');

            // Insert the latest posts container before footer, easier than after utterances.

            footer.parentNode.insertBefore(latestPostsContainer, footer);

            // Fetch latest posts from the archive page

            fetch('https://jesse-anderson.github.io/Blog/_site/archive.html')

                .then(response => response.text())

                .then(data => {

                    const parser = new DOMParser();

                    const doc = parser.parseFromString(data, 'text/html');

                    const posts = doc.querySelectorAll('.quarto-listing-container-table tbody tr');

                    // console.log("Posts: ", posts);

                    const latestPostsList = document.getElementById('latest-posts-list');

                    let count = 0;

                    posts.forEach(post => {

                        if (count < 4) {

                            // console.log("Title populating...");

                            const titleElement = post.querySelector('.listing-title'); // Correctly select the <a> tag with the title class

                            // console.log(titleElement)

                              const imageElement = post.querySelector('.listing-image img');

                              // console.log(imageElement)

                            if (titleElement) {

                                const title = titleElement.textContent.trim();

                                // console.log('Title: ', title);

                                let url = titleElement.getAttribute('href');

                                // console.log('URL: ', url);

                                if (url && !url.startsWith('http')) {

                                    url = 'https://jesse-anderson.github.io/Blog/_site/' + url.replace(/^\.\//, '');

                                }

                                // console.log('Formatted URL: ', url);

                                const imageUrl = imageElement ? imageElement.getAttribute('src').replace(/^\.\//, 'https://jesse-anderson.github.io/Blog/_site/') : 'default-image.jpg'; // Fallback image

                                // console.log('Image URL: ', imageUrl);

                                const listItem = document.createElement('li');

                                listItem.innerHTML = `<a href="${url}"><img src="${imageUrl}" alt="Post Image" style="height: 20px;"> ${title}</a>`;

                                latestPostsList.appendChild(listItem);

                                // console.log('ListItem: ', listItem);

                                count++;

                            } else {

                                console.warn('Missing elements for post:', post);

                            }

                        }

                    });

                });

        });

    </script>





<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="jesse-anderson/blogComments" issue-term="title" theme="github-dark" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">

<div class="cookie-consent-footer"><a href="#" id="open_preferences_center">Cookie Preferences</a></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>